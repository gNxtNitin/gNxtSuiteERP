Option Strict Off
Option Explicit On
Imports System
Imports VB = Microsoft.VisualBasic
Imports System.Data.SqlClient '' System.Data.OleDb
Imports System.Data.OleDb
Imports ADODB
Imports Microsoft.VisualBasic.Compatibility

Imports System.Xml.Linq

Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq

Imports QRCoder
Imports Infragistics.Win.UltraWinExplorerBar
Imports Infragistics.Win.UltraWinTree
Imports Infragistics.Win.UltraWinGrid
Imports Infragistics.Win.Misc
Imports System.IO
Imports System.Text


Public Module MainModule

    Public Const CLASS_VERSION As String = "1.6"

    Public Structure SaleArray
        Dim mBillNo As String
        Dim mBillDate As String
        Dim mOriginalCost As Double
        Dim mSupplier As String
        Dim mSaleAmount As Double
    End Structure

    Public mSaleData() As SaleArray
    'Character constants.

    Public PubMIDFormLoad As Boolean = False

    Public Const LBRACE As String = "{"
    Public Const RBRACE As String = "}"
    Public Const LBRACKET As String = "["
    Public Const RBRACKET As String = "]"
    Public Const COLON As String = ":"
    Public Const COMMA As String = ","
    Public Const QUOTE As String = """"
    Public Const PLUS As String = "+"
    Public Const MINUS As String = "-"
    Public Const RADIXPOINT As String = "." 'Always a period since we're locale-blind.
    Public Const ZERO As String = "0"
    Public Const NINE As String = "9"
    Public Const REVSOLIDUS As String = "\"

    Public Const WHITE_SPACE As String = vbTab & vbLf & vbCr & " "

    Public Const S_OK As Integer = 0
    Public Const VARIANT_ALPHABOOL As Integer = &H2
    Public Const LOCALE_INVARIANT As Integer = 127 'Used to do VT conversions with the invariant locale.

    Public Declare Function HashData Lib "shlwapi" (ByVal pbData As Integer, ByVal cbData As Integer, ByVal pbHash As Integer, ByVal cbHash As Integer) As Integer

    Public Declare Function StrSpn Lib "shlwapi" Alias "StrSpnW" (ByVal psz As Integer, ByVal pszSet As Integer) As Integer

    'UPGRADE_WARNING: Structure VbVarType may require marshalling attributes to be passed as an argument in this Declare statement. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="C429C3A5-5D47-4CD9-8F51-74A1616405DC"'
    Public Declare Function VariantChangeTypeEx Lib "oleaut32" (ByRef vargDest As Object, ByRef varSrc As Object, ByVal lcid As Integer, ByVal wFlags As Short, ByVal vt As VariantType) As Integer

    Declare Function ShellEx Lib "SHELL32.DLL" Alias "ShellExecuteA" (ByVal hwnd As Long, ByVal lpszOp As String, ByVal lpszFile As String, ByVal lpszParams As String, ByVal LpszDir As String, ByVal FsShowCmd As Long) As Long

    Public TypeNameOfMe As String 'Used in raising exceptions.
    Public Names As Collection
    Public Values As Collection
    Public CursorIn As Integer 'Scan position within JSON input string.
    Public LengthIn As Integer 'Length of JSON input string.
    Public TextOut As String 'Buffer to build JSON output string in.
    Public CursorOut As Integer 'Append position within JSON output string.
    Public NumberType As VariantType

    Public vbUS As String 'Pseudo-const ChrW$(&H1F&).

    Public mIsArray As Boolean
    Public mDecimalMode As Boolean

    '=== Public Shared Properties =================================================================

    Public Whitespace As Boolean 'True to use indenting and newlines on JSON Get.


    ''---SAndeep
    Public CurrModuleName As String
    Public ConBudgetDailyDetail As Boolean
    Public ConDSDetail As Boolean
    Public ConSaleDSDetail As Boolean
    Public ConPaymentDetail As Boolean
    Public ConServiceTaxDetail As Boolean
    Public ConLCDiscPaymentDetail As Boolean
    Public ConRGPSlipDetail As Boolean
    Public ConPOIndentDetail As Boolean
    Public ConOutBOMDetail As Boolean
    Public ConBOMDetail As Boolean
    Public ConBillFormat As String

    Public MainClass As New MainClass
    Public JsonBag As New JsonBag
    Public RsCompany As Recordset 'ADODB.Recordset
    Public MasterNo As Object
    Public AcName As String
    Public AcName1 As String
    Public AcName2 As String
    Public AcName3 As String
    Public AcName4 As String
    Public AcName5 As String
    Public AcName6 As String
    Public AcName7 As String
    Public AcName8 As String
    Public AcName9 As String
    Public AcName10 As String
    Public AcName11 As String
    Public myMenu As String
    Public RunDate As Date
    Public PubPAYYEAR As String
    Public PubGSTApplicable As Boolean
    Public PubGSTApplicableDate As String = "01/07/2017"
    Public PubCurrDate As Date
    Public PubUserID As String
    Public PubColorTheme As Long
    Public PubUserName As String
    Public PubUserEMPCode As String
    Public PubAllowGrant As String
    Public PubAllowPermission As String
    Public PubAllowRunDateChange As String
    Public PubATHUSER As Boolean
    Public PubUserLevel As String
    Public PubSuperUser As String
    Public PubUserPWD As String

    'Public PubRun_IN As String
    Public mDOSPRINTING As Boolean
    Public PubAuditUser As String

    Public PubGridLockUser As String
    Public MainStatusBar As New StatusBar()
    Public StatusPanel As New StatusBarPanel()
    Public DatetimePanel As New StatusBarPanel()
    Public PubPayCorpUser As String
    Public PubInvLevelUser As String
    Public PubInvLevelAPPUser As String
    Public ComName As String
    Public GridCount As Short
    Public pheight As Short
    Public pPaper As Object
    Public PageNo As Integer
    Public CurrModuleID As Integer
    Public ConInventoryTable As String
    Public mBOMRMQty As Double
    Public mBOMRMAmount As Double


    Public Const mAccountModule As String = "ACCOUNT MODULE"
    Public Const mPurchaseModule As String = "PURCHASE MODULE"
    Public Const mPayrollModule As String = "PAYROLL MODULE"
    Public Const mSaleModule As String = "SALE MODULE"
    Public Const mInventoryModule As String = "INVENTORY MODULE"
    Public Const mAssetsModule As String = "ASSETS MODULE"
    Public Const mAdminModule As String = "ADMINISTRATOR MODULE"
    Public Const mProductionModule As String = "PRODUCTION MODULE"
    Public Const mEDIModule As String = "EDI MODULE"
    Public Const mTDSModule As String = "TDS MODULE"
    Public Const mQualityModule As String = "QUALITY MODULE"
    Public Const mExportModule As String = "EXPORT MODULE"
    Public Const mContPayrollModule As String = "CONTRACTOR PAYROLL MODULE"
    Public Const meReurnModule As String = "ERETURN MODULE"
    Public Const mMISModule As String = "MIS MODULE"
    Public Const mCostingModule As String = "COSTING MODULE"

    Public PubFormBackColor As Color
    Public PubButtonBackColor As Color
    Public PubSpdShodowColor As Color
    Public PubSpdMainColor As Color
    Public PubSpdAlterColor As Color

    'Public PubFormBackColor As Integer
    'Public PubButtonBackColor As Integer
    'Public PubSpdShodowColor As Integer
    'Public PubSpdMainColor As Integer
    'Public PubSpdAlterColor As Integer

    'MODULEIDMODULENAMESTATUSMODULE_CAPTIONIS_GROUP
    '1ADMINISTRATOR MODULEOAdministrationY
    '3PAYROLL MODULEOPayroll & Human ResourceY
    '7PRODUCTION MODULEOProduction & Planning ManagementY
    '10QUALITY MODULEOQuality & Maintenance ManagementY
    '14TDS MODULEOTax Deducted / Collection as SourceY
    '15MIS MODULEOMISY
    '17INVENTORY GST MODULEOPurchase & Inventory Management - GSTY
    '18SALE GST MODULEOSales & Indirect Tax - GSTY
    '19ACCOUNT GST MODULEOFinancial Accounting - GSTY
    'Public Const mAdminModuleID As Long = 1
    'Public Const mInventoryModuleID As Long = 2
    'Public Const mSaleModuleID As Long = 3
    'Public Const mAccountModuleID As Long = 4
    'Public Const mProductionModuleID As Long = 5
    'Public Const mPayrollModuleID As Long = 6
    'Public Const mQualityModuleID As Long = 7
    'Public Const mTDSModuleID As Long = 8
    'Public Const mMISModuleID As Long = 9
    Public mAdminModuleID As Long
    Public mInventoryModuleID As Long
    Public mSaleModuleID As Long
    Public mAccountModuleID As Long
    Public mProductionModuleID As Long
    Public mPayrollModuleID As Long
    Public mQualityModuleID As Long
    Public mTDSModuleID As Long
    Public mMISModuleID As Long
    Public mCostingModuleID As Long
    'Public Const mPurchaseModuleID As Long = 17
    'Public Const mAssetsModuleID As String = "ASSETS MODULE"
    'Public Const mContPayrollModuleID As String = "CONTRACTOR PAYROLL MODULE"
    'Public Const meReurnModuleID As String = "ERETURN MODULE"
    'Public Const mCostingModuleID As String = "COSTING MODULE"
    Public Const ConCashReceipt As String = "CR"
    Public Const ConCashPayment As String = "CP"
    Public Const ConBankReceipt As String = "BR"
    Public Const ConBankPayment As String = "BP"
    Public Const ConContra As String = "HA"
    Public Const ConPDCReceipt As String = "FR"
    Public Const ConPDCPayment As String = "FP"
    Public Const ConJournal As String = "JV"
    Public Const ConCashRefund As String = "CF"
    Public Const ConDebitNote As String = "ED"
    Public Const ConCreditNote As String = "RC"
    Public Const ConSaleReturn As String = "SD"
    Public Const ConSale As String = "SC"
    Public Const ConSaleCreditNote As String = "SD"
    Public Const ConCancellation As String = "SL"
    Public Const ConPurchase As String = "PD"
    Public Const ConPurchaseGen As String = "PG"
    Public Const ConGRNote As String = "GD"
    Public Const ConGoodsReturn As String = "GC"
    Public Const ConDC As String = "DC"
    Public Const ConOpening As String = "OO"
    Public Const ConProvision = "VV"
    Public Const ConPurchaseSupp = "US"
    Public Const ConPurchaseCredit = "KP"
    Public Const ConSaleDebit = "LS"


    Public Const ConDespatchPlan As String = "DP"
    Public Const ConStockTrfIN As String = "TI"
    Public Const ConStockTrfOUT As String = "TO"
    Public Const ConStockAdj As String = "AA"
    Public Const ConStockAdjIN As String = "AI"
    Public Const ConStockConsum As String = "AC"
    Public Const ConGRBookCode As Short = -1
    Public Const ConSalesBookCode As Short = -2
    Public Const ConJournalBookCode As Short = -3
    Public Const ConDebitNoteBookCode As Short = -4
    Public Const ConCreditNoteBookCode As Short = -5
    Public Const ConPurchaseBookCode As Short = -6
    Public Const ConExciseSalesBookCode As Short = -7
    Public Const ConContraBookCode As Short = -8
    Public Const ConPurchaseGenBookCode As Short = -9
    Public Const ConOpeningBookCode As Short = -10
    Public Const ConModvatBookCode As Short = -11
    Public Const ConSTClaimBookCode As Short = -12
    Public Const ConSaleSuppBookCode As Short = -13
    Public Const ConServiceClaimBookCode As Short = -14
    Public Const ConCSTClaimBookCode As Short = -15
    Public Const ConExportSalesBookCode As Short = -16
    Public Const ConSaleMiscBookCode As Short = -17
    Public Const ConProvisionBookCode As Short = -18
    Public Const ConPurchaseSuppBookCode As Short = -19
    Public Const ConPurchaseCreditBookCode As Short = -20
    Public Const ConSaleDebitBookCode As Short = -21
    Public Const ConAdvanceBookCode As Short = -22
    Public Const ConRCSalesBookCode As Short = -23
    Public Const ConLCBookCode As Short = -24
    Public Const ConLDBookCode As Short = -25
    Public Const ConSaleCreditBookCode As Short = -26

    ''View Book Ledger....
    Public Const ConSaleBook As String = "S"
    Public Const ConPurchaseBook As String = "P"
    Public Const ConPurchaseGenBook As String = "PGen"
    Public Const ConGRBook As String = "G"
    Public Const ConCashBook As String = "C"
    Public Const ConBankBook As String = "B"
    Public Const ConContraBook As String = "H"
    Public Const ConPDCBook As String = "F"
    Public Const ConJournalBook As String = "J"
    Public Const ConDebitNoteBook As String = "E"
    Public Const ConCreditNoteBook As String = "R"
    Public Const ConOpeningBook As String = "O"
    Public Const ConLedger As String = "LEDG"
    Public Const ConPurchaseSuppBook As String = "U"
    Public Const ConPurchaseCreditBook As String = "K"
    Public Const ConSaleDebitBook As String = "L"
    Public Const ConSaleCreditBook As String = "M"
    Public ConOnlineData As Boolean
    Public ConAttnDataFromMC As Boolean
    Public Const ConWH As String = "WH"
    Public Const ConPH As String = "PH"
    Public Const ConJW As String = "JW"
    Public Const ConSH As String = "SH"
    'Public Const ConOP = "OP" '******REQ IF WE TRACK EVERY OPR OF SINGLE SHOP *************
    Public Const mInchInOneMtrs As Double = 39.37
    Public Const mCmsInOneMtrs As Short = 100
    Public Const mMMInOneMtrs As Short = 1000
    'STOCK REF TYPE .......
    Public Const ConStockRefType_QC As String = "QC"
    Public Const ConStockRefType_MRR As String = "MRR"
    Public Const ConStockRefType_ISS As String = "ISS"
    Public Const ConStockRefType_DSP As String = "DSP"
    Public Const ConStockRefType_NRG As String = "NRG"
    Public Const ConStockRefType_RGP As String = "RGP"
    Public Const ConStockRefType_SRN As String = "SRN"
    Public Const ConStockRefType_ADJ As String = "ADJ"
    Public Const ConStockRefType_OPN As String = "OPN"
    Public Const ConStockRefType_MSL As String = "MSL"
    Public Const ConStockRefType_PSL As String = "PSL"
    Public Const ConStockRefType_CON As String = "CON" ''For CO2
    Public Const ConStockRefType_BDM As String = "BDM"
    Public Const ConStockRefType_REOFFER As String = "REO"
    Public Const ConStockRefType_PMEMO As String = "PMO"
    Public Const ConStockRefType_PMEMODEPT As String = "PMD"
    Public Const ConStockRefType_PISS As String = "PIS"
    Public Const ConStockRefType_SUBISS As String = "SIS"
    Public Const ConStockRefType_SCP As String = "SCP"
    Public Const ConStockRefType_RWK As String = "PRW"
    Public Const ConStockRefType_MOV As String = "MOV"
    Public Const ConStockRefType_MANU As String = "SMI"
    Public Const ConStockRefType_REWORK As String = "RWP"
    Public Const ConStockRefType_PBREAKUP As String = "PBU"
    Public Const ConStockRefType_PMS As String = "PMS"
    Public Const ConStockRefType_BDT = "BDT"
    Public Const ConStockRefType_DTN = "DTN"
    Public Const ConStockRefType_FGBREAKUP = "FBU"
    Public Const ConStockRefType_WRBREAKUP = "WBU"
    Public Const ConStockRefType_CRS = "CRS" ''CR Duty Paid Over Six Month
    Public Const ConStockRefType_BDI = "BDI" ''Break Down IT .
    Public Const ConStockRefType_PDM As String = "PDM"  ''Predective Main

    'Locking Code
    Public Const ConLockBankPayment As String = "1"
    Public Const ConLockBankReceipt As String = "2"
    Public Const ConLockCashPayment As String = "3"
    Public Const ConLockCashReceipt As String = "4"
    Public Const ConLockPDCPayment As String = "5"
    Public Const ConLockPDCReceipt As String = "6"
    Public Const ConLockJournal As String = "7"
    Public Const ConLockDebitNote As String = "8"
    Public Const ConLockCreditNote As String = "9"
    Public Const ConLockPurchase As String = "10"
    Public Const ConLockSale As String = "11"
    Public Const ConLockMRREntry As String = "12"
    Public Const ConLockMRRQC As String = "13"
    Public Const ConLockINDENT As String = "14"
    Public Const ConLockPO As String = "15"
    Public Const ConLockSO As String = "16"
    Public Const ConLockPO_DS As String = "17"
    Public Const ConLockSO_DS As String = "18"
    Public Const ConLockReoffer As String = "19"
    Public Const ConLockMiscMRR As String = "20"
    Public Const ConLockStoreReq As String = "21"
    Public Const ConLockIssueNote As String = "22"
    Public Const ConLockGatePassReq As String = "23"
    Public Const ConLockGatePass As String = "24"
    Public Const ConLockSTN As String = "25"
    Public Const ConLockDespatch As String = "26"
    Public Const ConLockModvat As String = "27"
    Public Const ConLockSalesTaxRefund As String = "28"
    Public Const ConLockServiceTaxRefund As String = "29"
    Public Const ConLockAssetEntry As String = "30"
    Public Const ConLockProvision = "31"
    Public Const ConLockPhysical = "32"
    Public Const ConLockEmpSalaryProcess = "33"
    Public Const ConLockEmpOTProcess = "34"
    Public Const ConLockContSalaryProcess = "35"
    Public Const ConLockPerksProcess = "36"
    Public Const ConLiabilities As Short = 1
    Public Const ConAssets As Short = 2
    Public Const ConTradingAcct As Short = 3
    Public Const ConPnLAcct As Short = 4
    Public Const ConStock As Short = 5
    Public Const ConIncome As Short = 6
    Public Const ConExpenses As Short = 7
    Public Const ConFinishedStock As Short = 8
    Public Const ConRawStock As Short = 9
    Public Const ConOtherStock As Short = 10
    Public Const ConTransitStock As Short = 11
    Public Const ConFinishedInventory As Short = 12
    Public Const ConRawInventory As Short = 13
    Public Const ConOtherInventory As Short = 14
    Public Const ConBlankDate As String = ""
    Public Const ConcmdmodifyCaption As String = "&Modify"
    Public Const ConCmdCancelCaption As String = "Ca&ncel"
    Public Const ConCmdClearCaption As String = "C&lear"
    Public Const ConCmdSaveCaption As String = "&Save"
    Public Const ConCmdSaveCaption1 As String = "Sav&e"
    Public Const ConCmdDeleteCaption As String = "&Delete"
    Public Const ConCmdAddCaption As String = "&Add"
    Public Const ConCmdGridViewCaption As String = "List &View"
    Public Const ConCmdViewCaption As String = "Clear &View"
    Public Const ConCmdSavePrintCaption As String = "&Save && Print"

    Public Const ConBasicSalary As Short = 1
    Public Const ConPF As Short = 2
    Public Const ConESI As Short = 3
    Public Const ConConveyance As Short = 4
    Public Const ConHRA As Short = 5
    Public Const ConAdvance As Short = 6
    Public Const ConIncomeTax As Short = 7
    Public Const ConLoan As Short = 8
    Public Const ConOthers As Short = 9
    Public Const ConImprest As Short = 10
    Public Const ConOT As Short = 11
    Public Const ConTDS As Short = 12
    Public Const ConChildrenAllw As Short = 13
    Public Const ConLIC As Short = 14
    Public Const ConDA As Short = 15
    Public Const ConVDA As Short = 16
    Public Const ConIncentiveAllw As Short = 17
    Public Const ConAttendanceAllw As Short = 18
    Public Const ConTourAllw As Short = 19
    Public Const ConMedicalAllw As Short = 20
    Public Const ConMilkAllw As Short = 21
    Public Const ConAwardAllw As Short = 22
    Public Const ConGiftAllw As Short = 23
    Public Const ConWelfare As Short = 24
    Public Const ConWashAllw As Short = 25
    Public Const ConVPFAllw As Short = 26
    Public Const ConCCAAllw As Short = 27
    Public Const ConSpecialAllw As Short = 28
    Public Const ConTransportAllw As Short = 29
    Public Const ConExGratiaAllw As Short = 30
    Public Const ConLTA As Short = 31
    Public Const ConCanteen As Short = 32
    Public Const ConINAAM As Short = 33
    Public Const ConBonus = 34
    Public Const ConOtherEarningVar = 35
    Public Const ConEmployerPF = 36
    Public Const ConSUNDAYInc = 37
    Public Const ConMedicalReimbursement = 38
    Public Const ConEmployerESI = 39
    Public Const ConProfessionalTax = 40

    Public Const ConOPENPO_CONTINOUS_YEAR As Short = 2007
    Public G_PrintLedg As Boolean
    Public G_PrintAppLtr As Boolean
    Public G_ShowVar As Boolean
    ''------
    Public Const GW_HWNDFIRST As Short = 0
    Public Const GW_HWNDLAST As Short = 1
    Public Const GW_HWNDNEXT As Short = 2
    Public Const GW_HWNDPREV As Short = 3
    Public Const GW_CHILD As Short = 5
    Public Const GW_MAX As Short = 5
    Public Const NORMAL_PRIORITY_CLASS As Integer = &H20
    Public Const INFINITE As Short = -1
    Public Const STILL_ACTIVE As Short = &H103S
    Public Const PROCESS_QUERY_INFORMATION As Short = &H400S
    Public Const GW_OWNER As Short = 4
    Public Const GWL_STYLE As Short = -16
    Public Const WS_DISABLED As Integer = &H8000000
    Public Const WS_CANCELMODE As Short = &H1FS
    Public Const WM_CLOSE As Short = &H10S
    Public Const ABSENT As Short = 0
    Public Const CASUAL As Short = 1
    Public Const EARN As Short = 2
    Public Const SICK As Short = 3
    Public Const MATERNITY As Short = 4
    Public Const CPLEARN As Short = 5
    Public Const WOPAY As Short = 6
    Public Const CPLAVAIL As Short = 7
    Public Const SUNDAY As Short = 8
    Public Const HOLIDAY As Short = 9
    Public Const PRESENT As Short = 10
    Public Const WFH As Short = 11
    Public Const ConEarning As Short = 1
    Public Const ConDeduct As Short = 2
    Public Const ConPerks As Short = 3
    Public Const ConCalcBSalary As Short = 1
    Public Const ConCalcFixed As Short = 2
    Public Const ConCalcVariable As Short = 3

    Public objRpt As CRAXDRT.Report

    Public Const BLOCK_SIZE = 10000

    Public glCurrentHwnd As Object
    Structure STARTUPINFO
        Dim cb As Integer
        Dim lpReserved As String
        Dim lpDesktop As String
        Dim lpTitle As String
        Dim dwX As Integer
        Dim dwY As Integer
        Dim dwXSize As Integer
        Dim dwYSize As Integer
        Dim dwXCountChars As Integer
        Dim dwYCountChars As Integer
        Dim dwFillAttribute As Integer
        Dim dwFlags As Integer
        Dim wShowWindow As Short
        Dim cbReserved2 As Short
        Dim lpReserved2 As Integer
        Dim hStdInput As Integer
        Dim hStdOutput As Integer
        Dim hStdError As Integer
    End Structure
    Structure PROCESS_INFORMATION
        Dim hProcess As Integer
        Dim hThread As Integer
        Dim dwProcessID As Integer
        Dim dwThreadID As Integer
    End Structure
    Declare Function OpenProcess Lib "kernel32" (ByVal dwDesiredAccess As Integer, ByVal bInheritHandle As Integer, ByVal dwProcessID As Integer) As Integer
    Declare Function GetExitCodeProcess Lib "kernel32" (ByVal hProcess As Integer, ByRef lpExitCode As Integer) As Integer
    Declare Function CloseHandle Lib "kernel32" (ByRef hObject As Integer) As Boolean
    Declare Function WaitForSingleObject Lib "kernel32" (ByVal hHandle As Integer, ByVal dwMilliseconds As Integer) As Integer
    Declare Function CreateProcessA Lib "kernel32" (ByVal lpApplicationName As Integer, ByVal lpCommandLine As String, ByVal lpProcessAttributes As Integer, ByVal lpThreadAttributes As Integer, ByVal bInheritHandles As Integer, ByVal dwCreationFlags As Integer, ByVal lpEnvironment As Integer, ByVal lpCurrentDirectory As Integer, ByRef lpStartupInfo As STARTUPINFO, ByRef lpProcessInformation As PROCESS_INFORMATION) As Integer
    Declare Function IsWindow Lib "user32" (ByVal hwnd As Short) As Short
    Declare Function GetWindow Lib "user32" (ByVal hwnd As Short, ByVal wCmd As Short) As Short
    Declare Function PostMessage Lib "user32" Alias "PostMessageA" (ByVal hwnd As Integer, ByVal wMsg As Integer, ByVal wParam As Integer, ByVal lParam As Integer) As Integer
    Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA" (ByVal hwnd As Integer, ByVal nIndex As Integer) As Integer
    Declare Function GetParent Lib "user32" (ByVal hwnd As Integer) As Integer
    Declare Function GetWindowTextLength Lib "user32" Alias "GetWindowTextLengthA" (ByVal hwnd As Integer) As Integer
    Declare Function GetWindowText Lib "user32" Alias "GetWindowTextA" (ByVal hwnd As Integer, ByVal lpString As String, ByVal cch As Integer) As Integer

    Declare Function GetWindowText Lib "user32" Alias _
    "GetWindowTextA" (ByVal hWnd As Long, ByVal lpString _
    As String, ByVal cch As Long) As Long

    Public hCap As Long
    Public mIsCamStart As Boolean

    Public Const REG_NONE As Long = 0
    Public Const REG_SZ As Long = 1
    Public Const REG_EXPAND_SZ As Long = 2
    Public Const REG_BINARY As Long = 3
    Public Const REG_DWORD As Long = 4
    Public Const ERROR_SUCCESS As Long = 0
    Public Const ERROR_ACCESS_DENIED As Long = 5
    Public Const ERROR_NO_MORE_ITEMS As Long = 259
    'Public Const HKEY_CLASSES_ROOT As Long = &H80000000

    Public Declare Function RegOpenKey Lib "advapi32.dll" Alias "RegOpenKeyA" (ByVal hKey As Long, ByVal lpSubKey As String, phkResult As Long) As Long
    Public Declare Function RegCloseKey Lib "advapi32.dll" (ByVal hKey As Long) As Long
    Public Declare Function RegQueryValueEx Lib "advapi32.dll" Alias "RegQueryValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal lpReserved As Long, lpType As Long, ByVal lpData As String, lpcbData As Long) As Long

    Public Function MsgInformation(ByRef Msg As String) As Object
        MsgInformation = MsgBox(Msg, MsgBoxStyle.Information + MsgBoxStyle.ApplicationModal, System.Diagnostics.FileVersionInfo.GetVersionInfo(System.Reflection.Assembly.GetExecutingAssembly.Location).CompanyName & " " & System.Reflection.Assembly.GetExecutingAssembly.GetName.Name)
    End Function
    Public Function MsgQuestion(ByRef Msg As String) As String
        MsgQuestion = CStr(MsgBox(Msg, MsgBoxStyle.Question + MsgBoxStyle.YesNo + MsgBoxStyle.DefaultButton2 + MsgBoxStyle.ApplicationModal, System.Diagnostics.FileVersionInfo.GetVersionInfo(System.Reflection.Assembly.GetExecutingAssembly.Location).CompanyName & " " & System.Reflection.Assembly.GetExecutingAssembly.GetName.Name))
    End Function
    Public Function MsgExclamation(ByRef Msg As String) As String
        MsgExclamation = CStr(MsgBox(Msg, MsgBoxStyle.Exclamation + MsgBoxStyle.ApplicationModal, System.Diagnostics.FileVersionInfo.GetVersionInfo(System.Reflection.Assembly.GetExecutingAssembly.Location).CompanyName & " " & System.Reflection.Assembly.GetExecutingAssembly.GetName.Name))
    End Function
    Public Function FYChk(ByRef mDate As String) As Boolean
        FYChk = False
        If Trim(mDate) = "" Then Exit Function
        If CDate(mDate) >= CDate(RsCompany.Fields("START_DATE").Value) And CDate(mDate) <= CDate(RsCompany.Fields("END_DATE").Value) Then
            FYChk = True
        Else
            MsgInformation("Date not in Current Financial Year")
        End If
    End Function
    Public Function GetCurrentFYNo(ByRef pDBCn As Connection, ByRef mDate As String) As Integer
        On Error GoTo ErrPart
        Dim mSqlStr As String = ""
        Dim RsFYNo As Recordset = Nothing
        GetCurrentFYNo = -1
        mSqlStr = "SELECT FYEAR FROM GEN_CMPYRDTL_TRN " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND START_DATE<=TO_DATE('" & VB6.Format(mDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')" & vbCrLf _
            & " AND END_DATE>=TO_DATE('" & VB6.Format(mDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')"

        MainClass.UOpenRecordSet(mSqlStr, pDBCn, CursorTypeEnum.adOpenStatic, RsFYNo, LockTypeEnum.adLockReadOnly)
        If Not RsFYNo.EOF Then
            GetCurrentFYNo = IIf(IsDBNull(RsFYNo.Fields("FYEAR").Value), -1, RsFYNo.Fields("FYEAR").Value)
        Else
            MsgInformation("Financial Year Not Opened.")
            GetCurrentFYNo = -1
            Exit Function
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description)
        GetCurrentFYNo = -1
    End Function

    Public Function GetFYStartEndDate(ByRef pDBCn As Connection, ByRef pFieldName As String, ByRef pFyear As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String = ""
        Dim RsFYNo As Recordset = Nothing
        GetFYStartEndDate = ""
        mSqlStr = "SELECT " & pFieldName & " DATE_VALUE FROM GEN_CMPYRDTL_TRN " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND FYEAR='" & pFyear & "'"

        MainClass.UOpenRecordSet(mSqlStr, pDBCn, CursorTypeEnum.adOpenStatic, RsFYNo, LockTypeEnum.adLockReadOnly)
        If Not RsFYNo.EOF Then
            GetFYStartEndDate = IIf(IsDBNull(RsFYNo.Fields("DATE_VALUE").Value), "", RsFYNo.Fields("DATE_VALUE").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description)
    End Function

    Public Function ErrorMsg(ByRef mErrDesc As String, Optional ByRef mErrNo As String = "", Optional ByRef MsgBoxStyle As MsgBoxStyle = 0) As String
        On Error GoTo ErrPart
        Dim mStartSearch As Integer
        If Trim(mErrDesc) = "" Then GoTo ExitPart
        mStartSearch = InStr(1, mErrDesc, ":", CompareMethod.Text) + 1
        If mStartSearch = 1 Then
            ErrorMsg = mErrDesc
            MsgBox(UCase(ErrorMsg), MsgBoxStyle, IIf(mErrNo = "", "", "Error No : " & mErrNo))
            Exit Function
        End If
        ErrorMsg = UCase(Mid(mErrDesc, mStartSearch))
        MsgBox(ErrorMsg, MsgBoxStyle, IIf(mErrNo = "", "", "Error No : " & mErrNo))
        Exit Function
ErrPart:
        MsgBox(Err.Description)
        'Resume
ExitPart:
    End Function
    Public Function MonthValue(ByRef mMonthName As String, Optional ByRef mAbbr As Boolean = False) As Short
        Dim cntMon As Integer
        For cntMon = 1 To 12
            If mAbbr = True Then
                If UCase(Left(MonthName(cntMon), 3)) = UCase(mMonthName) Then
                    MonthValue = cntMon
                    Exit Function
                End If
            Else
                If UCase(MonthName(cntMon)) = UCase(mMonthName) Then
                    MonthValue = cntMon
                    Exit Function
                End If
            End If
        Next
    End Function
    Public Function HoursInText(ByVal Hrs As Int32) As String
        Dim MiT As String, cMin As Int32
        cMin = Hrs
        If cMin = 1 Then
            MiT = "One"
        ElseIf cMin = 2 Then
            MiT = "Two"
        ElseIf cMin = 3 Then
            MiT = "Three"
        ElseIf cMin = 4 Then
            MiT = "Four"
        ElseIf cMin = 5 Then
            MiT = "Five"
        ElseIf cMin = 6 Then
            MiT = "Six"
        ElseIf cMin = 7 Then
            MiT = "Seven"
        ElseIf cMin = 8 Then
            MiT = "Eight"
        ElseIf cMin = 9 Then
            MiT = "Nine"
        ElseIf cMin = 10 Then
            MiT = "Ten"
        ElseIf cMin = 11 Then
            MiT = "Eleven"
        ElseIf cMin = 12 Then
            MiT = "Twelve"
        ElseIf cMin = 13 Then
            MiT = "Thirteen"
        ElseIf cMin = 14 Then
            MiT = "Fourteen"
        ElseIf cMin = 15 Then
            MiT = "Fifteen"
        ElseIf cMin = 16 Then
            MiT = "Sixteen"
        ElseIf cMin = 17 Then
            MiT = "Seventeen"
        ElseIf cMin = 18 Then
            MiT = "Eighteen"
        ElseIf cMin = 19 Then
            MiT = "Nineteen"
        ElseIf cMin = 20 Then
            MiT = "Twenty"
        ElseIf cMin = 21 Then
            MiT = "Twenty One"
        ElseIf cMin = 22 Then
            MiT = "Twenty Two"
        ElseIf cMin = 23 Then
            MiT = "Twenty Three"
        Else
            MiT = " "
        End If
        MiT = MiT & " Hrs"
        Return MiT
    End Function
    Public Function MinInText(ByVal Min As Int32) As String
        Dim MiT As String, cMin As Int32
        cMin = Min
        If cMin = 1 Then
            MiT = "One"
        ElseIf cMin = 2 Then
            MiT = "Two"
        ElseIf cMin = 3 Then
            MiT = "Three"
        ElseIf cMin = 4 Then
            MiT = "Four"
        ElseIf cMin = 5 Then
            MiT = "Five"
        ElseIf cMin = 6 Then
            MiT = "Six"
        ElseIf cMin = 7 Then
            MiT = "Seven"
        ElseIf cMin = 8 Then
            MiT = "Eight"
        ElseIf cMin = 9 Then
            MiT = "Nine"
        ElseIf cMin = 10 Then
            MiT = "Ten"
        ElseIf cMin = 11 Then
            MiT = "Eleven"
        ElseIf cMin = 12 Then
            MiT = "Twelve"
        ElseIf cMin = 13 Then
            MiT = "Thirteen"
        ElseIf cMin = 14 Then
            MiT = "Fourteen"
        ElseIf cMin = 15 Then
            MiT = "Fifteen"
        ElseIf cMin = 16 Then
            MiT = "Sixteen"
        ElseIf cMin = 17 Then
            MiT = "Seventeen"
        ElseIf cMin = 18 Then
            MiT = "Eighteen"
        ElseIf cMin = 19 Then
            MiT = "Nineteen"
        ElseIf cMin = 20 Then
            MiT = "Twenty"
        ElseIf cMin = 21 Then
            MiT = "Twenty One"
        ElseIf cMin = 22 Then
            MiT = "Twenty Two"
        ElseIf cMin = 23 Then
            MiT = "Twenty Three"
        ElseIf cMin = 24 Then
            MiT = "Twenty Four"
        ElseIf cMin = 25 Then
            MiT = "Twenty Five"
        ElseIf cMin = 26 Then
            MiT = "Twenty Six"
        ElseIf cMin = 27 Then
            MiT = "Twenty Seven"
        ElseIf cMin = 28 Then
            MiT = "Twenty Eight"
        ElseIf cMin = 29 Then
            MiT = "Twenty Nine"
        ElseIf cMin = 30 Then
            MiT = "Thirty"
        ElseIf cMin = 31 Then
            MiT = "Thirty One"
        ElseIf cMin = 32 Then
            MiT = "Thirty Two"
        ElseIf cMin = 33 Then
            MiT = "Thirty Three"
        ElseIf cMin = 34 Then
            MiT = "Thirty Four"
        ElseIf cMin = 35 Then
            MiT = "Thirty Five"
        ElseIf cMin = 36 Then
            MiT = "Thirty Six"
        ElseIf cMin = 37 Then
            MiT = "Thirty Seven"
        ElseIf cMin = 38 Then
            MiT = "Thirty Eight"
        ElseIf cMin = 39 Then
            MiT = "Thirty Nine"
        ElseIf cMin = 40 Then
            MiT = "Forty"
        ElseIf cMin = 41 Then
            MiT = "Forty One"
        ElseIf cMin = 42 Then
            MiT = "Forty Two"
        ElseIf cMin = 43 Then
            MiT = "Forty Three"
        ElseIf cMin = 44 Then
            MiT = "Forty Four"
        ElseIf cMin = 45 Then
            MiT = "Forty Five"
        ElseIf cMin = 46 Then
            MiT = "Forty Six"
        ElseIf cMin = 47 Then
            MiT = "Forty Seven"
        ElseIf cMin = 48 Then
            MiT = "Forty Eight"
        ElseIf cMin = 49 Then
            MiT = "Forty Nine"
        ElseIf cMin = 50 Then
            MiT = "Fifty"
        ElseIf cMin = 51 Then
            MiT = "Fifty One"
        ElseIf cMin = 52 Then
            MiT = "Fifty Two"
        ElseIf cMin = 53 Then
            MiT = "Fifty Three"
        ElseIf cMin = 54 Then
            MiT = "Fifty Four"
        ElseIf cMin = 55 Then
            MiT = "Fifty Five"
        ElseIf cMin = 56 Then
            MiT = "Fifty Six"
        ElseIf cMin = 57 Then
            MiT = "Fifty Seven"
        ElseIf cMin = 58 Then
            MiT = "Fifty Eight"
        ElseIf cMin = 59 Then
            MiT = "Fifty Nine"
        Else
            MiT = " Zero"
        End If
        MiT = MiT & " Mins"
        Return MiT
    End Function
    Public Function GetServerDate() As Date
        Dim RS As Recordset ''Recordset
        RS = New Recordset
        MainClass.UOpenRecordSet("SELECT CURRENT_TIMESTAMP FROM DUAL", PubDBCn, CursorTypeEnum.adOpenStatic, RS, LockTypeEnum.adLockReadOnly)
        ''Set Rs = PubDBCn.CreateDynaset("SELECT SYSDATE FROM DUAL", 0&)
        GetServerDate = VB6.Format(RS.Fields(0).Value, "dd/MM/yyyy")
        'GetServerDate = Convert.ToDateTime(RS.Fields(0).Value)
        'GetServerDate = Date.ParseExact(RS.Fields(0).Value, "dd/MM/yyyy", Nothing)
        ''DateTime.ParseExact(dumm, "d/M/yyyy", Nothing)
        RS.Close()
        RS = Nothing
    End Function
    Public Function GetServerTime() As String
        Dim RS As Recordset
        RS = Nothing
        MainClass.UOpenRecordSet("SELECT TO_CHAR(CURRENT_TIMESTAMP,'HH24:MI') FROM DUAL", PubDBCn, CursorTypeEnum.adOpenStatic, RS, LockTypeEnum.adLockReadOnly)
        GetServerTime = RS.Fields(0).Value '' VB6.Format(RS.Fields(0).Value, "HH:mm24")
        RS.Close()
        RS = Nothing
    End Function
    Public Sub SetStatusBar()
        StatusPanel.BorderStyle = StatusBarPanelBorderStyle.Sunken
        StatusPanel.Text = "Application started. No action yet."
        StatusPanel.ToolTipText = "Last Activity"
        StatusPanel.AutoSize = StatusBarPanelAutoSize.Spring
        MainStatusBar.Panels.Add(StatusPanel)
        DatetimePanel.BorderStyle = StatusBarPanelBorderStyle.Raised
        DatetimePanel.ToolTipText = "DateTime: " + System.DateTime.Today.ToString()
        DatetimePanel.Text = System.DateTime.Today.ToLongDateString()
        DatetimePanel.AutoSize = StatusBarPanelAutoSize.Contents
        MainStatusBar.Panels.Add(DatetimePanel)
        MainStatusBar.ShowPanels = True
        FormMain.Controls.Add(MainStatusBar)
        '' ''set rundate from server date each & every time when form load....
        ' ''If PubSuperUser = "S" OR PubSuperUser = "A" Or PubAllowGrant = "Y" Then
        '' ''24-05-2010 '' Not required rundate... already set at the time of login..............
        ' ''If PubAllowRunDateChange = "Y" Then
        ' ''
        ' ''Else
        ' ''RunDate = VB6.Format(GetServerDate(), "dd/MM/yyyy")
        ' ''End If
        ' ''MainClass.ValidateWithMasterTable RsCompany.Fields("CBranchCode").Value, "BranchCode", "BranchName", "Branch", PubDBCn, MasterNo
        'FormMain.lblCompanyName.Text = UCase(RsCompany.Fields("COMPANY_NAME").Value)
        'FormMain.Conn.Text = PubUserID & "/" & DBConUID & "@" & DBConSERVICENAME
        ''FormMain.Caps.Style = ComctlLib.PanelStyleConstants.sbrCaps
        ''FormMain.num.Style = ComctlLib.PanelStyleConstants.sbrNum
        ''FormMain.ins.Style = ComctlLib.PanelStyleConstants.sbrIns
        'FormMain.Rundate.Text = CStr(RunDate)
        ''FormMain.Time.Style = ComctlLib.PanelStyleConstants.sbrTime
        ''Master.StatusBar1.Panels(1).Width = 4500
        ''Master.StatusBar1.Panels(2).Width = 3500
    End Sub
    Public Sub SetMainFormCordinate(ByRef MyForm As System.Windows.Forms.Form)
        MyForm.StartPosition = FormStartPosition.Manual
        MyForm.Left = 0
        MyForm.Top = 0
        MyForm.Height = MyForm.Height ''VB6.TwipsToPixelsY(MyForm.Height)
        MyForm.Width = MyForm.Width '' TwipsToPixelsX(PixelsToTwipsX(MyForm.Width))
        'ResizeForm.FindAllControls(MyForm)
    End Sub
    Public Sub SetChildFormCordinate(ByRef MyForm As System.Windows.Forms.Form)
        MyForm.Left = 0 '' TwipsToPixelsX((PixelsToTwipsX(System.Windows.Forms.Screen.PrimaryScreen.Bounds.Width) - PixelsToTwipsX(MyForm.Width)) / 2)
        MyForm.Top = 0 ''VB6.TwipsToPixelsY((VB6.PixelsToTwipsY(System.Windows.Forms.Screen.PrimaryScreen.Bounds.Height) - VB6.PixelsToTwipsY(MyForm.Height)) / 2)
        MyForm.Height = MyForm.Height '' VB6.TwipsToPixelsY(VB6.PixelsToTwipsY(MyForm.Height))
        MyForm.Width = MyForm.Width ''VB6.TwipsToPixelsX(VB6.PixelsToTwipsX(MyForm.Width))
    End Sub
    Public Function GenPrefixVNo(ByVal pDate As String) As String
        On Error GoTo ERR1
        Dim mVNo1 As String = ""

        GenPrefixVNo = ""
        If RsCompany.Fields("CBJVoucherSeq").Value = "D" Then
            mVNo1 = VB6.Format(VB.Day(pDate), "00") & VB6.Format(VB.Month(pDate), "00")
        ElseIf RsCompany.Fields("CBJVoucherSeq").Value = "M" Then
            mVNo1 = VB6.Format(VB.Month(pDate), "00")
        ElseIf RsCompany.Fields("CBJVoucherSeq").Value = "Y" Then
            'mVNo1 = Right(Year(TxtVDate.Text), 2)
            'mVNo1 = VB.Right(RsCompany.Fields("FYEAR").Value, 2)
        End If
        ''txtVNo1.Text = Left(RsCompany.Fields("Alias").Value, 3) & mVNo1										
        GenPrefixVNo = mVNo1 ''mVNo1										
        Exit Function
ERR1:
        ErrorMsg(Err.Description, Err.Description, MsgBoxStyle.Critical)
        ''Resume										
    End Function
    Public Sub MakeRsCompany(ByRef pCompanyCode As Integer, ByRef pFYNo As Long)
        On Error GoTo MakeRsERR
        Dim SqlStr As String = ""
        SqlStr = "Select FIN_PRINT_MST.*, "

        SqlStr = SqlStr & vbCrLf _
            & "ELEC_RATE, COMMISIONER_RATE, PFEST, COMPANY_SHORTNAME, COMPANY_PIN, REGD_STATE, EXCISE_DIV, EXEMPTED_UNIT, " & vbCrLf _
            & "COMPANY_NAME, SERV_REGN_NO, ESIEST, IEC_NO, COMPANY_PHONE, REGD_PIN, EXCISE_RANGE, COMPANY_GST_RGN_NO, " & vbCrLf _
            & "COMPANY_ADDR, REGD_ADDR1, CST_NO, ISEOU, COMPANY_FAXNO, REGD_PHONE, CENT_EXC_RGN_NO, WEBSITE, " & vbCrLf _
            & "COMPANY_CITY, REGD_ADDR2, LST_NO, JURISDICTION, COMPANY_MAILID, REGD_FAXNO, ECC_NO, STATUS, " & vbCrLf _
            & "COMPANY_STATE, REGD_CITY, PAN_NO, CIN_NO, TDSNO, REGD_MAILID, LST_PER, PRINT_COMPANY_NAME, " & vbCrLf _
            & "CST_PER, REX_NO, "

        SqlStr = SqlStr & vbCrLf _
            & " GEN_CMPYRDTL_TRN.FYEAR, GEN_CMPYRDTL_TRN.START_DATE, GEN_CMPYRDTL_TRN.END_DATE,GEN_CMPYRDTL_TRN.CLOSING_FLAG, " & vbCrLf _
            & " COMPANY_BANK_NAME, COMPANY_BANK_BRANCH, COMPANY_BANK_ACCOUNT, COMPANY_BANK_IFSC"

        'SqlStr = SqlStr & vbCrLf _
        '& " PRINTTOPCOMPANYNAME, PRINTTOPCOMPANYADDRESS, PRINTTOPCOMPANYPHONE," & vbCrLf _
        '& " PRINTBOTCOMPANYNAME, PRINTBOTCOMPANYADDRESS, PRINTBOTCOMPANYPHONE," & vbCrLf _
        '& " PRINTCOMPANYFULL_SHORTNAME, PRINTUSER, PRINTRUNDATE," & vbCrLf _
        '& " PRINTPAGENO, REPORTMARGINTOP, REPORTMARGINBOT," & vbCrLf _
        '& " REPORTMARGINLEFT, REPORTMARGINRIGHT, CBJVOUCHERSEQ," & vbCrLf _
        '& " DCNOTESEQ, TDSCIRCLE, TDSACNO, TDSAUTHORIZED,TDSAUTHORIZED_FNAME," & vbCrLf _
        '& " TDSAUTHORIZED_DESIG, MODVATRAWACCOUNT, MODVATOTHACCOUNT,CESSACCOUNT,CESSRECDACCOUNT, MODVATRECDACCOUNT, STREFUNDACCOUNT, CSTREFUNDACCOUNT," & vbCrLf _
        '& " GEN_CMPYRDTL_TRN.FYEAR, GEN_CMPYRDTL_TRN.START_DATE, " & vbCrLf _
        '& " GEN_CMPYRDTL_TRN.END_DATE,GEN_CMPYRDTL_TRN.CLOSING_FLAG,TDSCREDITACCOUNT, " & vbCrLf _
        '& " ESICREDITACCOUNT, STDSCREDITACCOUNT,TINNO,SR_ED_ACCOUNT,SR_ST_ACCOUNT,SR_CST_ACCOUNT," & vbCrLf _
        '& " PDIR_AMOUNT,PDIR_ACCOUNT,PDIR_CreditAcct," & vbCrLf _
        '& " LockDateFrom,LockDateTo,GRExcessPer,StockBalCheck,TINNO,SERV_REGN_NO, TAN_NO, EWAYBILLAPP, BONUS_TYPE,BONUS_CEIL_AMT,"

        'SqlStr = SqlStr & vbCrLf _
        '& " PRINTOTINPAYSLIP, OTFACTOR, BONUSLIMIT, " & vbCrLf _
        '& " LEAVEPAIDDAYS , DEPOSITLEAVE,DEPOSITLEAVE_WK," & vbCrLf _
        '& " STAFF_EL_PER_DAYS, WORKER_EL_PER_DAYS,BED_PURCHASE_RTN, ECT_PURCHASE_RTN, SRVTAX_PURCHASE_RTN, " & vbCrLf _
        '& " SRVTAXACCOUNT, SRVTAX_CESSACCOUNT, SRCESSACCOUNT, " & vbCrLf _
        '& " SRSRVTAXACCOUNT, SRSRVTAX_CESSACCOUNT, SRVTAX_CESS_PURCHASE_RTN, " & vbCrLf _
        '& " SRVTAX_CESS_SALE, ADE_PUR_ACCOUNT, ADE_PUR_RECD_ACCOUNT,ADE_PUR_RTN_ACCOUNT," & vbCrLf _
        '& " PURCHASE_POSTINGTYPE, SALES_POSTINGTYPE, SRVTAX_KKCESSACCOUNT,"

        'SqlStr = SqlStr & vbCrLf _
        '& " BED_PURCHASE_RTN_INV, ECT_PURCHASE_RTN_INV, SRVTAX_PURCHASE_RTN_INV," & vbCrLf _
        '& " SRVTAX_CESS_PURCHASE_RTN_INV, ADE_PUR_RTN_ACCOUNT_INV, SHECT_PURCHASE_RTN_INV, SRVTAX_SHCESS_PURCHASE_RTN_INV,"

        'SqlStr = SqlStr & vbCrLf _
        '& " SHCESSACCOUNT, SHCESSRECDACCOUNT, SRVTAX_SHCESSACCOUNT, " & vbCrLf _
        '& " SRSHCESSACCOUNT, SRSRVTAX_SHCESSACCOUNT, SHECT_PURCHASE_RTN, " & vbCrLf _
        '& " SRVTAX_SHCESS_PURCHASE_RTN,SRVTAX_SHCESS_SALE,"

        'SqlStr = SqlStr & vbCrLf _
        '& " Shortage_DN, Shortage_DN_APP," & vbCrLf _
        '& " Rejection_DN, Rejection_DN_APP," & vbCrLf _
        '& " RATE_Diff_DN, RATE_Diff_DN_APP," & vbCrLf _
        '& " RATE_Diff_CN, RATE_Diff_CN_APP," & vbCrLf _
        '& " CREDITBANK, CREDITBANK_ADD, FURTHER_BANK, AD_CODE,"

        'SqlStr = SqlStr & vbCrLf _
        '& " NVL(PFADMINPER,0) As PFADMINPER, NVL(PFADMINPER_22,0) As PFADMINPER_22, PFEDLIPER, WELFARE_ES, " & vbCrLf _
        '& " WELFARE_RS, EMPLOYERESIPER, WELFARE_PS, " & vbCrLf _
        '& " WELFARE_WS, WELFAREPER, WELFARE_GS, WELFARE_D, " & vbCrLf _
        '& " CONT_OTFACTOR,AUTO_ISSUE,AUTO_ISSUE_DATE, LATE_ENTRY, " & vbCrLf _
        '& " SHORT_LEAVE, LATE_ENTRY_DAYS, SHORT_LEAVE_DAYS, AUTO_ISSUE_PROD,AUTO_ISSUE_PROD_DATE, "

        'SqlStr = SqlStr & vbCrLf & " SUR_VAT_SR_ACCOUNT, SUR_VAT_PUR_ACCOUNT, PUNCH_FROM, PUNCH_GATE_TABLE, PUNCH_DEPT_TABLE,"

        'SqlStr = SqlStr & vbCrLf & " CIRCLE_NAME, CIRCLE_ADDRESS, CIRCLE_CITY, CIRCLE_PINCODE,"

        'SqlStr = SqlStr & vbCrLf & " INV_TAB_CC, INV_TAB_FY, COMP_ONLINE, ATTN_MC, INVOICE_PREPRINT, RGP_PREPRINT,PO_PREPRINT," & vbCrLf _
        '& " INVOICE_A4, INVOICE_DIGIT,IS_STRECEIVABLE, STRECEIVABLEACCOUNT, " & vbCrLf _
        '& " SEPARATE_MRR_SERIES,SEPARATE_DSP_SERIES," & vbCrLf _
        '& " SEPARATE_RGP_SERIES,SEPARATE_INV_SERIES, SEPARATE_PUR_SERIES,MRR_AGT_GE,PO_IN_GE,WEEKLYOFF_TYPE,PUR_PLANNING,WEEKLY_SCHD,OVERTIME_ON,"

        'SqlStr = SqlStr & vbCrLf & " BOP_MAX_LEVEL, RM_MAX_LEVEL, CONS_MAX_LEVEL, " & vbCrLf _
        '& " MAINT_MAX_LEVEL,QC_ALLOW_DAYS,CHECK_MAX_INV_GE,GEN_RJ_DESPATCH," & vbCrLf _
        '& " CHECK_BOP_STOCK, CHECK_FG_STOCK, "

        'SqlStr = SqlStr & vbCrLf _
        '& " CGST_REFUNDCODE, SGST_REFUNDCODE, IGST_REFUNDCODE, " & vbCrLf _
        '& " CGST_SALECODE, SGST_SALECODE, IGST_SALECODE, " & vbCrLf _
        '& " CGST_CR_RETURNCODE, SGST_CR_RETURNCODE, IGST_CR_RETURNCODE, " & vbCrLf _
        '& " CGST_SALE_RETURNCODE, SGST_SALE_RETURNCODE, IGST_SALE_RETURNCODE, " & vbCrLf _
        '& " CGST_DR_RETURNCODE, SGST_DR_RETURNCODE, IGST_DR_RETURNCODE, COMPANY_ACCTCODE," & vbCrLf _
        '& " CGST_ADV_PAYMENTCODE, SGST_ADV_PAYMENTCODE, IGST_ADV_PAYMENTCODE, " & vbCrLf _
        '& " CGST_ADV_RECEIPTCODE, SGST_ADV_RECEIPTCODE, IGST_ADV_RECEIPTCODE, " & vbCrLf _
        '& " CGST_RC_REFUNDCODE, SGST_RC_REFUNDCODE, IGST_RC_REFUNDCODE, " & vbCrLf _
        '& " CGST_RC_SALECODE, SGST_RC_SALECODE, IGST_RC_SALECODE, "

        'SqlStr = SqlStr & vbCrLf & " INV_GENERATE_24_HOURS,INV_GENERATE_FROM_TM,INV_GENERATE_TO_TM," & vbCrLf _
        '& " LOADIND_APP, LOADING_APP_DATE,PROD_PALN_LOCK, PROD_PALN_LOCK_DAY, " & vbCrLf _
        '& " PO_LOCK,SO_LOCK,INVOICE_PREFIX, GST_SEPARATE,PO_PRINT_APP_REQ, " & vbCrLf _
        '& " E_CGSTLEDGER_ACCTCODE, E_SGSTLEDGER_ACCTCODE, E_IGSTLEDGER_ACCTCODE, GST_LATE_ACCTCODE, GST_INTEREST_ACCTCODE, " & vbCrLf _
        '& " E_RCCGSTLEDGER_ACCTCODE, E_RCSGSTLEDGER_ACCTCODE, E_RCIGSTLEDGER_ACCTCODE, " & vbCrLf _
        '& " CGST_REJDR_RETURNCODE, SGST_REJDR_RETURNCODE, IGST_REJDR_RETURNCODE, REJECTION_DOCTYPE, REJ_APPLICABLEDATE, ISSUE_TYPE," & vbCrLf _
        '& " ISSUE_APPLICABLEDATE, CONT_SAL_PROCESS_PFLOCK_DATE, E_INVOICE_APP,BILLAMOUNT_LIMIT,TCS_APPLICABLE, K_NO, MAX_PO_ITEMS,"

        'SqlStr = SqlStr & vbCrLf & "HEATNO_HIDE,BATCHNO_HIDE, COMP_AC_CODE,AC_PR_AUTO_JV,CHECK_PO_RATE, PACKETS_COL_SHOW , INNER_PACK_COL_SHOW , OUTER_PACK_COL_SHOW,DIV_AS_LOCATION,MANNUAL_BILL_ADJUST"


        SqlStr = SqlStr & vbCrLf _
        & " FROM GEN_COMPANY_MST,GEN_CMPYRDTL_TRN,FIN_PRINT_MST " & vbCrLf _
        & " WHERE GEN_COMPANY_MST.COMPANY_CODE=GEN_CMPYRDTL_TRN.COMPANY_CODE " & vbCrLf _
        & " And GEN_COMPANY_MST.COMPANY_CODE=FIN_PRINT_MST.COMPANY_CODE(+) " & vbCrLf _
        & " And GEN_COMPANY_MST.COMPANY_CODE =" & pCompanyCode & " " & vbCrLf _
        & " And GEN_CMPYRDTL_TRN.FYEAR =" & pFYNo & " "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenStatic, RsCompany, LockTypeEnum.adLockReadOnly)
        If RsCompany.EOF = True Then
            MsgInformation("No record found")
            End
        End If
        Exit Sub
MakeRsERR:
        MsgBox(Err.Description)
    End Sub
    'Public Sub ShellAndContinue(ByVal AppToRun As String, Optional ByRef LabelName As System.Windows.Forms.Label = Nothing, Optional ByRef PBar As System.Windows.Forms.ProgressBar = Nothing)
    'On Error GoTo ErrorRoutineErr
    'Dim hProcess As Integer
    'Dim retval As Integer
    ''The next line launches AppToRun,
    ''captures process ID
    'hProcess = OpenProcess(PROCESS_QUERY_INFORMATION, 1, Shell(AppToRun, AppWinStyle.NormalFocus))
    'System.Windows.Forms.Application.DoEvents()
    'Do
    ''Get the status of the process
    'GetExitCodeProcess(hProcess, retval)
    'System.Windows.Forms.Application.DoEvents()
    ''Loop while the process is active
    'Loop While retval = STILL_ACTIVE
    'ErrorRoutineResume:
    'Exit Sub
    'ErrorRoutineErr:
    'MsgBox("AppShell.Form1.ShellAndContinue" & Err.Number & ErrorToString())
    'End Sub
    Public Function DigitsInWords(ByVal prm2Digits As Short) As String
        Dim InWords As String = ""
        If prm2Digits = 10 Then
            DigitsInWords = "Ten"
            Exit Function
        End If
        If Len(Trim(CStr(prm2Digits))) = 2 Then
            Select Case Left(CStr(prm2Digits), 1)
                Case CStr(1)
                    Select Case Right(CStr(prm2Digits), 1)
                        Case CStr(1)
                            InWords = "Eleven"
                        Case CStr(2)
                            InWords = "Twelve"
                        Case CStr(3)
                            InWords = "Thirteen"
                        Case CStr(4)
                            InWords = "Fourteen"
                        Case CStr(5)
                            InWords = "Fifteen"
                        Case CStr(6)
                            InWords = "Sixteen"
                        Case CStr(7)
                            InWords = "Seventeen"
                        Case CStr(8)
                            InWords = "Eighteen"
                        Case CStr(9)
                            InWords = "Nineteen"
                    End Select
                    DigitsInWords = InWords
                    Exit Function
                Case CStr(2)
                    InWords = "Twenty"
                Case CStr(3)
                    InWords = "Thirty"
                Case CStr(4)
                    InWords = "Forty"
                Case CStr(5)
                    InWords = "Fifty"
                Case CStr(6)
                    InWords = "Sixty"
                Case CStr(7)
                    InWords = "Seventy"
                Case CStr(8)
                    InWords = "Eighty"
                Case CStr(9)
                    InWords = "Ninety"
            End Select
        End If
        Select Case Right(CStr(prm2Digits), 1)
            Case CStr(1)
                InWords = InWords & " One"
            Case CStr(2)
                InWords = InWords & " Two"
            Case CStr(3)
                InWords = InWords & " Three"
            Case CStr(4)
                InWords = InWords & " Four"
            Case CStr(5)
                InWords = InWords & " Five"
            Case CStr(6)
                InWords = InWords & " Six"
            Case CStr(7)
                InWords = InWords & " Seven"
            Case CStr(8)
                InWords = InWords & " Eight"
            Case CStr(9)
                InWords = InWords & " Nine"
        End Select
        DigitsInWords = InWords
    End Function
    Public Function GetMultiLine(ByRef PString As String, ByRef mLineCount As Integer, ByRef pWidth As Integer, ByRef pStartCol As Integer) As String
        On Error GoTo ErrPart
        Dim pCr As String
        Dim pCrlf As String
        Dim l As Integer
        Dim s As Integer
        Dim c As Integer
        Dim mTemp As String = ""
        Dim DoneOnce As Boolean
        Dim pNextLine As String = ""
        pWidth = pWidth - 1 ''+ 1
        PString = Trim(PString)
        pCr = Chr(13)
        pCrlf = Chr(13) & Chr(10)
        Do
            l = Len(pNextLine)
            s = InStr(PString, " ")
            c = InStr(PString, pCr)
            If c Then
                If l + c <= pWidth Then
                    mTemp = mTemp & pNextLine & VB.Left(PString, c)
                    pNextLine = ""
                    PString = Mid(PString, c + 1)
                    GoTo LoopHere
                End If
            End If
            If s Then
                If l + s <= pWidth Then
                    DoneOnce = True
                    pNextLine = pNextLine & VB.Left(PString, s)
                    PString = Mid(PString, s + 1)
                ElseIf s > pWidth Then
                    mTemp = mTemp & vbCrLf & New String(" ", pStartCol - 1) & VB.Left(PString, pWidth)
                    PString = Mid(PString, pWidth + 1)
                    mLineCount = mLineCount + 1
                Else
                    mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1)
                    pNextLine = ""
                    mLineCount = mLineCount + 1
                End If
            Else
                If l Then
                    If l + Len(PString) > pWidth Then
                        If Len(PString) > pWidth Then
                            mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1) & PString & vbCrLf
                        Else
                            mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1) & PString
                        End If
                        mLineCount = mLineCount + 1
                    Else
                        mTemp = mTemp & pNextLine & PString ''& vbCrLf & String(pStartCol - 1, " ")
                    End If
                Else
                    mTemp = mTemp & PString ''& vbCrLf & String(pStartCol - 1, " ")
                End If
                Exit Do
            End If
LoopHere:
        Loop
        GetMultiLine = mTemp
        Exit Function
ErrPart:
        MsgBox(Err.Description)
        GetMultiLine = ""
        '' Resume
    End Function
    Public Function GetMonthStartEndDate(ByRef mMonth As String, ByRef mFirstMonthDay As String, ByRef mLastMonthDay As String) As Boolean
        Dim cntMonth As Integer
        Dim GetMonth As Integer
        Dim mYear As Integer
        Dim mStartDate As Integer
        Dim mEndDate As Integer
        Dim mFYyear As Integer
        GetMonthStartEndDate = True
        For cntMonth = 1 To 12
            If UCase(MonthName(cntMonth, True)) = UCase(mMonth) Then
                GetMonth = cntMonth
                Exit For
            End If
            If cntMonth = 12 Then
                GetMonthStartEndDate = False
                Exit Function
            End If
        Next
        mStartDate = 1
        mFYyear = Year(RsCompany.Fields("Start_Date").Value)
        Select Case GetMonth
            Case 1, 3
                mYear = CInt(VB6.Format(mFYyear + 1, "0000"))
                mEndDate = 31
            Case 5, 7, 8, 10, 12
                mYear = CInt(VB6.Format(mFYyear, "0000"))
                mEndDate = 31
            Case 4, 6, 9, 11
                mYear = CInt(VB6.Format(mFYyear, "0000"))
                mEndDate = 30
            Case 2
                mYear = CInt(VB6.Format(mFYyear + 1, "0000"))
                mEndDate = IIf((mYear Mod 4) = 0, 29, 28)
        End Select
        mFirstMonthDay = mStartDate & "/" & GetMonth & "/" & mYear
        mLastMonthDay = mEndDate & "/" & GetMonth & "/" & mYear
    End Function
    Public Function GetStateCode_TDS(ByRef pStateName As String) As String
        On Error GoTo ErrPart
        pStateName = UCase(Trim(pStateName))
        GetStateCode_TDS = "99"
        Select Case pStateName
            Case "ANDAMAN And NICOBAR ISLANDS"
                GetStateCode_TDS = "1"
            Case "ANDHRA PRADESH"
                GetStateCode_TDS = "2"
            Case "ARUNACHAL PRADESH"
                GetStateCode_TDS = "3"
            Case "ASSAM"
                GetStateCode_TDS = "4"
            Case "BIHAR"
                GetStateCode_TDS = "5"
            Case "CHANDIGARH"
                GetStateCode_TDS = "6"
            Case "DADRA & NAGAR HAVELI", "DADRA"
                GetStateCode_TDS = "7"
            Case "DAMAN & DIU"
                GetStateCode_TDS = "8"
            Case "DELHI", "New DELHI"
                GetStateCode_TDS = "9"
            Case "GOA"
                GetStateCode_TDS = "10"
            Case "GUJARAT"
                GetStateCode_TDS = "11"
            Case "HARYANA"
                GetStateCode_TDS = "12"
            Case "HIMACHAL PRADESH"
                GetStateCode_TDS = "13"
            Case "JAMMU & KASHMIR"
                GetStateCode_TDS = "14"
            Case "KARNATAKA"
                GetStateCode_TDS = "15"
            Case "KERALA"
                GetStateCode_TDS = "16"
            Case "LAKHSWADEEP"
                GetStateCode_TDS = "17"
            Case "MADHYA PRADESH"
                GetStateCode_TDS = "18"
            Case "MAHARASHTRA"
                GetStateCode_TDS = "19"
            Case "MANIPUR"
                GetStateCode_TDS = "20"
            Case "MEGHALAYA"
                GetStateCode_TDS = "21"
            Case "MIZORAM"
                GetStateCode_TDS = "22"
            Case "NAGALAND"
                GetStateCode_TDS = "23"
            Case "ORISSA"
                GetStateCode_TDS = "24"
            Case "PONDICHERRY"
                GetStateCode_TDS = "25"
            Case "PUNJAB"
                GetStateCode_TDS = "26"
            Case "RAJASTHAN"
                GetStateCode_TDS = "27"
            Case "SIKKIM"
                GetStateCode_TDS = "28"
            Case "TAMILNADU"
                GetStateCode_TDS = "29"
            Case "TRIPURA"
                GetStateCode_TDS = "30"
            Case "UTTAR PRADESH"
                GetStateCode_TDS = "31"
            Case "WEST BENGAL"
                GetStateCode_TDS = "32"
            Case "CHHATISHGARH"
                GetStateCode_TDS = "33"
            Case "UTTARANCHAL"
                GetStateCode_TDS = "34"
            Case "JHARKHAND"
                GetStateCode_TDS = "35"
        End Select
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckMaxLevel(pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckMaxLevel = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "Select MAX_LEVEL_CHECK " & vbCrLf _
        & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
        & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        & " And IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
        & " And IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
        & " And CMST.GEN_TYPE='C'" & vbCrLf _
        & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("MAX_LEVEL_CHECK").Value), "Y", RsTemp.Fields("MAX_LEVEL_CHECK").Value)
            CheckMaxLevel = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
    End Function
    Public Function ValidateDeptRight(ByVal pPubUserID As String, ByVal pCheckDept As String, ByVal pDeptDesc As String, Optional MsgFlash As String = "") As Boolean
        On Error GoTo ErrPart
        Dim mDeptCode As String
        If PubSuperUser = "S" Or PubSuperUser = "A" Then
            ValidateDeptRight = True
            Exit Function
        End If
        If MainClass.ValidateWithMasterTable(pPubUserID, "USER_ID", "DEPT_CODE", "GEN_DEPTRIGHT_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND RIGHTS ='Y' AND DEPT_CODE='" & pCheckDept & "'") = True Then
            mDeptCode = MasterNo
            If UCase(pCheckDept) = UCase(Trim(mDeptCode)) Then
                ValidateDeptRight = True
            Else
                If MsgFlash <> "N" Then
                    MsgBox("You have Not rights in " & UCase(Trim(pDeptDesc)) & " Dept. Cann't be Save.", vbInformation)
                End If
                ValidateDeptRight = False
            End If
        Else
            If MsgFlash <> "N" Then
                MsgBox("You have Not rights in " & UCase(Trim(pDeptDesc)) & " Dept. Cann't be Save.", vbInformation)
            End If
            ValidateDeptRight = False
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        ValidateDeptRight = False
    End Function
    Public Function ValidateDivisionRight(ByVal pPubUserID As String, ByVal pCheckDivision As Double, ByVal pDivisionDesc As String, Optional MsgFlash As String = "") As Boolean
        On Error GoTo ErrPart
        Dim mDivCode As Double
        If PubSuperUser = "S" Or PubSuperUser = "A" Then
            ValidateDivisionRight = True
            Exit Function
        End If
        If MainClass.ValidateWithMasterTable(pPubUserID, "USER_ID", "DIV_CODE", "GEN_DIVISIONRIGHT_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND RIGHTS ='Y' AND DIV_CODE=" & pCheckDivision & "") = True Then
            mDivCode = MasterNo
            If UCase(pCheckDivision) = UCase(Trim(mDivCode)) Then
                ValidateDivisionRight = True
            Else
                If MsgFlash <> "N" Then
                    MsgBox("You have Not rights in " & UCase(Trim(pDivisionDesc)) & " Dept. Cann't be Save.", vbInformation)
                End If
                ValidateDivisionRight = False
            End If
        Else
            If MsgFlash <> "N" Then
                MsgBox("You have Not rights in " & UCase(Trim(pDivisionDesc)) & " Dept. Cann't be Save.", vbInformation)
            End If
            ValidateDivisionRight = False
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        ValidateDivisionRight = False
    End Function
    Public Function CheckPANValidation(ByRef pPANNo As String) As Boolean
        On Error GoTo ErrPart
        Dim mCharCnt As Integer
        Dim mKeyAscii As String
        CheckPANValidation = False
        If Len(pPANNo) <> 10 Then
            CheckPANValidation = False
            Exit Function
        End If
        For mCharCnt = 1 To Len(pPANNo)
            mKeyAscii = CStr(Asc(UCase(Mid(pPANNo, mCharCnt, mCharCnt))))
            Select Case mCharCnt
                Case 1, 2, 3, 4, 5, 10
                    If (CDbl(mKeyAscii) >= 65 And CDbl(mKeyAscii) <= 90) Then
                    Else
                        CheckPANValidation = False
                        Exit Function
                    End If
                Case 6, 7, 8, 9
                    If (CDbl(mKeyAscii) >= 48 And CDbl(mKeyAscii) <= 57) Then
                    Else
                        CheckPANValidation = False
                        Exit Function
                    End If
            End Select
        Next
        CheckPANValidation = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        CheckPANValidation = False
    End Function
    Public Function PaiseRound(ByRef Num As Double, ByRef Rnm As Double) As Double
        ' Num = 12.23 and Rnm = .05
        Dim nn As Double
        Dim mm As Double
        Dim a As Double
        Dim b As Double
        Dim c As Double
        Dim f As Double
        If Rnm = 0 Then
            PaiseRound = Num
        ElseIf Rnm = 1 Then
            PaiseRound = CDbl(VB6.Format(Str(Num), "#######0"))
        Else
            If Num <> 0 Then
                nn = (Num - Fix(Num)) * 100 ' nn = 23paise
                mm = nn / (Rnm * 100) ' mm = 23/5 = 4.60
                a = Fix(mm) * Rnm * 100 ' a = 20
                If nn = a Then
                    c = 0
                Else
                    b = nn - a ' b = 23- 20 = 3
                    c = (Rnm * 100) - b 'c = 2
                End If
                f = Num + c / 100
            End If
            PaiseRound = f
        End If
    End Function
    Public Sub ResizeFormToScreen(ByRef FrmName As Object)
        'Dim XRatio As Double
        'Dim YRatio As Double
        'Dim I As Integer
        ''The 'On Error Resume Next' is needed because there might be
        ''some controls on the form that may not support some of the
        ''properties that will be set
        'On Error Resume Next
        ''If the form's windows state is minimized or maximized then exit
        'If FrmName.WindowState <> 0 Then Exit Sub
        ''Calculate the X and Y resizing ratio
        'XRatio = PixelsToTwipsX(System.Windows.Forms.Screen.PrimaryScreen.Bounds.Width) / FrmName.Width ''
        'YRatio = PixelsToTwipsY(System.Windows.Forms.Screen.PrimaryScreen.Bounds.Height) / FrmName.Height
        ''Set the form's origin to 0,0
        'FrmName.Top = 0
        'FrmName.Left = 0
        ''Resize the form's height, width , and font size
        'FrmName.Height = FrmName.Height * YRatio
        'FrmName.Width = FrmName.Width * XRatio
        ''FrmName.Font.Size = FrmName.Font.Size * XRatio
        ''Loop through all the controls on the from and repostion every
        ''control relative to the form origin, then resize thier width,
        ''height, and Font.Size properties
        ''For I = 0 To FrmName.Controls.Count - 1
        '' FrmName.Controls(I).Left = FrmName.Controls(I).Left * XRatio
        '' FrmName.Controls(I).Top = FrmName.Controls(I).Top * YRatio
        '' FrmName.Controls(I).Height = FrmName.Controls(I).Height * YRatio
        '' FrmName.Controls(I).Width = FrmName.Controls(I).Width * XRatio
        ''
        '' 'Note: The control's font will resize only if it is a truetype font
        '' FrmName.Controls(I).Font.Size = FrmName.Controls(I).Font.Size * XRatio
        ''Next I
    End Sub
    Public Function XLSConnect(ByRef mFileConnStr As String, ByRef FileDBCn As ADODB.Connection) As Boolean
        On Error GoTo ErrPart
        FileDBCn = New Connection

        If FileDBCn.State = ObjectStateEnum.adStateOpen Then
            FileDBCn.Close()
        End If

        With FileDBCn
            FileDBCn.ConnectionString = mFileConnStr 'Connection string
            FileDBCn.CursorLocation = CursorLocationEnum.adUseClient 'Cursor location
            FileDBCn.ConnectionTimeout = 60 'Seconds to wait for a connection
            FileDBCn.CommandTimeout = 120 'Seconds to wait for a command
            FileDBCn.Errors.Clear() 'Clear the errors collection
            On Error Resume Next
            FileDBCn.Open()
            On Error GoTo ErrPart
            If FileDBCn.State <> ObjectStateEnum.adStateOpen Then
                GoTo ErrPart
            End If
        End With
        XLSConnect = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        XLSConnect = False
    End Function
    Public Function OpenExcelRecordSet(ByVal strSQL As String, ByRef rst As ADODB.Recordset, ByRef strError As String, ByRef mcnn As ADODB.Connection, Optional ByRef blnReadOnly As Boolean = True) As Integer
        '
        ' Given and SQL string, open a recordset
        ' to retrieve the data.
        On Error GoTo ErrorHandler
        Dim strADOErr As String
        On Error GoTo ErrorHandler
        strError = ""
        '
        ' Retrieve the data into a recordset.
        '
        rst = New Recordset
        With rst
            .CursorLocation = CursorLocationEnum.adUseClient
            If blnReadOnly Then
                .CursorType = CursorTypeEnum.adOpenStatic
            Else
                .CursorType = CursorTypeEnum.adOpenDynamic
            End If
            On Error Resume Next
            If blnReadOnly Then
                .Open(strSQL, mcnn,, LockTypeEnum.adLockReadOnly, CommandTypeEnum.adCmdText)
            Else
                .Open(strSQL, mcnn,, LockTypeEnum.adLockOptimistic, CommandTypeEnum.adCmdText)
            End If
            '
            'If .State <> adStateOpen Then
            'strError = "Unable to retrieve data"
            'GoTo ErrorHandler
            'End If
            If .EOF Then
                OpenExcelRecordSet = 2
                strError = "No records retrieved"
            Else
                .MoveFirst()
                OpenExcelRecordSet = 0
            End If
        End With
        GoTo NormalExit
ErrorHandler:
        On Error Resume Next
        OpenExcelRecordSet = -99
NormalExit:
    End Function
    Public Sub GetFormName(mMenuId As String, ByRef pFormName As String,
    ByRef pCondName1 As String, ByRef pCondValue1 As String, ByRef pCondName2 As String, ByRef pCondValue2 As String,
    ByRef pCondName3 As String, ByRef pCondValue3 As String, ByRef pCondName4 As String, ByRef pCondValue4 As String,
    ByRef pCondName5 As String, ByRef pCondValue5 As String, ByRef pFormCaption As String)
        Dim SqlStr As String = ""
        Dim RsMisc As Recordset = Nothing
        'pFormName = ""
        'pCondName1 = ""
        'pCondValue1 = ""
        'pCondName2 = ""
        'pCondValue2 = ""
        'pCondName3 = ""
        'pCondValue3 = ""
        'pCondName4 = ""
        'pCondValue4 = ""
        'pCondName5 = ""
        'pCondValue5 = ""
        If Trim(mMenuId) = "" Then Exit Sub
        Try
            SqlStr = "Select FORMNAME, COND_NAME1, COND_VALUE1, " & vbCrLf _
            & " COND_NAME2, COND_VALUE2, COND_NAME3, COND_VALUE3, " & vbCrLf _
            & " COND_NAME4, COND_VALUE4, COND_NAME5, COND_VALUE5, FORMCAPTION " & vbCrLf _
            & " FROM GEN_ERPMENU_MST " & vbCrLf _
            & " WHERE MENUHEADID='" & MainClass.AllowSingleQuote(mMenuId) & "' AND IS_ACTIVE='Y'" '' AND MODULEID=" & CurrModuleID & ""
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RsMisc, LockTypeEnum.adLockOptimistic)
            If Not RsMisc.EOF Then
                pFormName = Trim(IIf(IsDBNull(RsMisc.Fields("FORMNAME").Value), "", RsMisc.Fields("FORMNAME").Value))
                pCondName1 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_NAME1").Value), "", RsMisc.Fields("COND_NAME1").Value))
                pCondValue1 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_VALUE1").Value), "", RsMisc.Fields("COND_VALUE1").Value))
                pCondName2 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_NAME2").Value), "", RsMisc.Fields("COND_NAME2").Value))
                pCondValue2 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_VALUE2").Value), "", RsMisc.Fields("COND_VALUE2").Value))
                pCondName3 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_NAME3").Value), "", RsMisc.Fields("COND_NAME3").Value))
                pCondValue3 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_VALUE3").Value), "", RsMisc.Fields("COND_VALUE3").Value))
                pCondName4 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_NAME4").Value), "", RsMisc.Fields("COND_NAME4").Value))
                pCondValue4 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_VALUE4").Value), "", RsMisc.Fields("COND_VALUE4").Value))
                pCondName5 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_NAME5").Value), "", RsMisc.Fields("COND_NAME5").Value))
                pCondValue5 = Trim(IIf(IsDBNull(RsMisc.Fields("COND_VALUE5").Value), "", RsMisc.Fields("COND_VALUE5").Value))
                pFormCaption = Trim(IIf(IsDBNull(RsMisc.Fields("FORMCAPTION").Value), "", RsMisc.Fields("FORMCAPTION").Value))
            End If
        Catch ex As Exception
            MessageBox.Show(ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Public Function CheckGSTValidation(pGSTNo As String, pStateName As String) As Boolean
        On Error GoTo ErrPart
        Dim mCharCnt As Long
        Dim mKeyAscii As String
        Dim mStateCode As String
        Dim mCheckStateCode As String
        Dim pPANNo As String
        CheckGSTValidation = False
        If Len(pGSTNo) <> 15 Then
            CheckGSTValidation = False
            Exit Function
        End If
        mStateCode = Left(pGSTNo, 2)
        mCheckStateCode = GetStateCode(pStateName)
        If mCheckStateCode <> mStateCode Then
            CheckGSTValidation = False
            Exit Function
        End If
        pPANNo = Mid(pGSTNo, 3, 10)
        '06AAACH0118F2Z9' Mid("06AAACH0118F2Z9", 3, 10) 'AAACH0118F
        For mCharCnt = 1 To Len(pPANNo)
            mKeyAscii = Asc(UCase(Mid(pPANNo, mCharCnt, mCharCnt)))
            Select Case mCharCnt
                Case 1, 2, 3, 4, 5, 10
                    If (mKeyAscii >= 65 And mKeyAscii <= 90) Then
                    Else
                        CheckGSTValidation = False
                        Exit Function
                    End If
                Case 6, 7, 8, 9
                    If (mKeyAscii >= 48 And mKeyAscii <= 57) Then
                    Else
                        CheckGSTValidation = False
                        Exit Function
                    End If
            End Select
        Next
        CheckGSTValidation = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        CheckGSTValidation = False
    End Function
    Public Function GetStateCode(pStateName As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        pStateName = UCase(Trim(pStateName))
        GetStateCode = ""
        SqlStr = "Select STATE_CODE FROM GEN_STATE_MST " & vbCrLf _
        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
        & " And NAME ='" & MainClass.AllowSingleQuote(pStateName) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RsTemp, LockTypeEnum.adLockOptimistic)
        If RsTemp.EOF = False Then
            GetStateCode = IIf(IsDBNull(RsTemp.Fields("STATE_CODE").Value), "", RsTemp.Fields("STATE_CODE").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
    End Function
    Public Function GetItemReProcess(xWONo As Double, xItemCode As String, pSupplierCode As String, pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetItemReProcess = "N"
        SqlStr = " SELECT DISTINCT IS_REPROCESS " & vbCrLf _
                & " FROM PUR_PURCHASE_HDR POM, PUR_PURCHASE_DET POD " & vbCrLf _
                & " WHERE POM.MKEY = POD.MKEY " & vbCrLf _
                & " And POM.AUTO_KEY_PO=" & Val(xWONo) & " " & vbCrLf _
                & " And POM.SUPP_CUST_CODE='" & pSupplierCode & "' " & vbCrLf _
                & " And POM.Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
                & " And POD.ITEM_CODE='" & Trim(xItemCode) & "' "

        SqlStr = SqlStr & vbCrLf _
                & " AND POM.MKEY = ( " & vbCrLf _
                & " SELECT MAX(IH.MKEY) " & vbCrLf _
                & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID" & vbCrLf _
                & " WHERE IH.Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND IH.MKEY=ID.MKEY " & vbCrLf & " AND IH.AUTO_KEY_PO =" & Val(xWONo) & ""


        SqlStr = SqlStr & vbCrLf _
                & " And ID.ITEM_CODE='" & Trim(xItemCode) & "'" & vbCrLf _
                & " AND ID.PO_WEF_DATE<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        SqlStr = SqlStr & ")"


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetItemReProcess = Trim(IIf(IsDBNull(RsTemp.Fields("IS_REPROCESS").Value), "N", RsTemp.Fields("IS_REPROCESS").Value))
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, Err.Number, vbCritical)
    End Function

    Public Function InsertIntoDelAudit(pDBCn As ADODB.Connection, mTableName As String, mSearchKey As String, ByVal mRs As ADODB.Recordset, Optional ByVal mFieldDesc As String = "", Optional ByVal mActionType As String = "") As Boolean

        On Error GoTo DelAuditErr
        Dim SqlStr As String = ""
        Dim i As Integer
        Dim mFieldName As String
        Dim mFieldValue As String

        If Not mRs.EOF Then
            mRs.MoveFirst()
            Do While Not mRs.EOF

                For i = 0 To mRs.Fields.Count - 1
                    '    mFieldDesc = mFieldDesc & " < " & mRs.Fields(i).Value & " > "

                    mFieldName = mRs.Fields(i).Name
                    mFieldValue = IIf(IsDBNull(mRs.Fields(i).Value), "", mRs.Fields(i).Value)

                    mFieldValue = Mid(mFieldValue, 1, 254)
                    mSearchKey = Mid(mSearchKey, 1, 30)
                    SqlStr = "INSERT INTO GEN_DELAUDIT_TRN " & vbCrLf _
                            & " (Company_CODE,FYEAR,TableName,UserID, " & vbCrLf _
                            & " TrnDate,SearchKey,FieldDesc, FIELD_NAME, FIELD_VALUE, ACTION_TYPE) " & vbCrLf _
                            & " VALUES(" & RsCompany.Fields("Company_Code").Value & ", " & vbCrLf _
                            & " " & RsCompany.Fields("FYEAR").Value & ",'" & MainClass.AllowSingleQuote(mTableName) & "', " & vbCrLf _
                            & " '" & MainClass.AllowSingleQuote(PubUserID) & "',TO_DATE('" & PubCurrDate.ToString("dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
                            & " '" & MainClass.AllowSingleQuote(mSearchKey) & "','" & MainClass.AllowSingleQuote(mFieldDesc) & "','" & MainClass.AllowSingleQuote(mFieldName) & "','" & MainClass.AllowSingleQuote(mFieldValue) & "','" & mActionType & "')"

                    pDBCn.Execute(SqlStr)
                Next i
                mRs.MoveNext()
            Loop
            mRs.MoveFirst()
        End If
        InsertIntoDelAudit = True
        Exit Function
DelAuditErr:
        If Err.Number = -2147418113 Then Resume Next
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        InsertIntoDelAudit = False
        'Resume
    End Function
    Public Function InsertIntoDeleteTrn(pDBCn As ADODB.Connection, mTableName As String, mKeyFieldName As String, mMKey As String) As Boolean
        On Error GoTo DelAuditErr
        Dim SqlStr As String = ""
        Dim i As Long
        mTableName = UCase(mTableName)
        mKeyFieldName = UCase(mKeyFieldName)
        SqlStr = "INSERT INTO GEN_DELETE_TRN " & vbCrLf _
        & " (COMPANY_CODE, FYEAR, TABLENAME, DELUSER, DELDATE, " & vbCrLf _
        & " MKEYFIELD, MKEY, UPDATE_FROM) " & vbCrLf _
        & " VALUES(" & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & ", '" & MainClass.AllowSingleQuote(mTableName) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(PubUserID) & "', TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(mKeyFieldName) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(mMKey) & "', 'N')"
        pDBCn.Execute(SqlStr)
        InsertIntoDeleteTrn = True
        Exit Function
DelAuditErr:
        If Err.Number = -2147418113 Then Resume Next
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        InsertIntoDeleteTrn = False
        'Resume
    End Function
    Public Function GetUserPermission(mField As String, mDefaultValue As String, mUserId As String, mCompanyCode As Long) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetUserPermission = mDefaultValue
        SqlStr = "Select " & mField & " As RIGHT_FIELD FROM ATH_PASSWORD_MST " & vbCrLf _
        & " WHERE "
        If Val(mCompanyCode) < 0 Then
            SqlStr = SqlStr & vbCrLf _
            & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        Else
            SqlStr = SqlStr & vbCrLf _
            & " COMPANY_CODE=" & Val(mCompanyCode) & ""
        End If
        SqlStr = SqlStr & vbCrLf _
        & " And USER_ID= '" & MainClass.AllowSingleQuote(mUserId) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RS, LockTypeEnum.adLockOptimistic)
        If RS.EOF = False Then
            GetUserPermission = IIf(IsDBNull(RS.Fields("RIGHT_FIELD").Value), mDefaultValue, RS.Fields("RIGHT_FIELD").Value)
        End If
        Exit Function
ErrPart:
        GetUserPermission = mDefaultValue
    End Function
    Public Function GetCompanyName(mCompanyCode As Long, mType As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing

        If mType = "S" Then
            SqlStr = "Select COMPANY_SHORTNAME AS COMPANY_NAME FROM GEN_COMPANY_MST WHERE COMPANY_CODE=" & mCompanyCode & ""
        Else
            SqlStr = "Select COMPANY_NAME FROM GEN_COMPANY_MST WHERE COMPANY_CODE=" & mCompanyCode & ""
        End If

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RS, LockTypeEnum.adLockOptimistic)
        If RS.EOF = False Then
            GetCompanyName = IIf(IsDBNull(RS.Fields("COMPANY_NAME").Value), "", RS.Fields("COMPANY_NAME").Value)
        End If

        Exit Function
ErrPart:
    End Function
    Public Function GetStockFromInventory(mCompanyCode As Long) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing


        SqlStr = "Select INV_TAKEN_FROM_STOCK FROM FIN_PRINT_MST WHERE COMPANY_CODE=" & mCompanyCode & ""


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RS, LockTypeEnum.adLockOptimistic)
        If RS.EOF = False Then
            GetStockFromInventory = IIf(IsDBNull(RS.Fields("INV_TAKEN_FROM_STOCK").Value), "N", RS.Fields("INV_TAKEN_FROM_STOCK").Value)
        End If

        Exit Function
ErrPart:
    End Function
    Public Function GetTDSAccountCode(mSectionName As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        Dim mTDSAccountCode As String


        SqlStr = "Select TDS_ACCOUNTCODE FROM TDS_Section_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND NAME='" & MainClass.AllowSingleQuote(mSectionName) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, CursorTypeEnum.adOpenKeyset, RS, LockTypeEnum.adLockOptimistic)
        If RS.EOF = False Then
            mTDSAccountCode = IIf(IsDBNull(RS.Fields("TDS_ACCOUNTCODE").Value), "", RS.Fields("TDS_ACCOUNTCODE").Value)

            If MainClass.ValidateWithMasterTable(mTDSAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_CODE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                GetTDSAccountCode = mTDSAccountCode
            Else
                GetTDSAccountCode = ""
            End If
        End If

        Exit Function
ErrPart:
    End Function
#Region "Auto Complete Search"
    Public Sub AutoCompleteSearch(TableName As String, FLDName As String, AdditionalCondition As String, ByRef pTextBox As System.Windows.Forms.TextBox, Optional pOrderBy As String = "")
        'Public Shared Function SearchGridMaster(ByRef LikeSearchString As String, ByRef TableName As String, ByRef FLDName As String, Optional ByRef FLDName1 As String = "", Optional ByRef FLDName2 As String = "", Optional ByRef FLDName3 As String = "", Optional ByRef AdditionalCondition As String = "", Optional ByRef ReturnField As String = "", Optional ByRef ReturnValue As Object = Nothing, Optional ByRef FLDName4 As String = "") As Boolean
        Dim dt As New DataTable()
        Dim SqlStr As String = ""

        SqlStr = "Select DISTINCT " & FLDName & " " & vbCrLf _
        & " FROM " & TableName & " " & vbCrLf _
        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""

        If AdditionalCondition <> "" Then SqlStr = SqlStr & vbCrLf & " And " & AdditionalCondition

        If pOrderBy = "" Then
            SqlStr = SqlStr & vbCrLf & " Order By 1"
        ElseIf pOrderBy = "A" Then
            SqlStr = SqlStr & vbCrLf & " Order By 1 ASC"
        ElseIf pOrderBy = "D" Then
            SqlStr = SqlStr & vbCrLf & " Order By 1 DESC"
        End If

        Using da As New OleDbDataAdapter(SqlStr, PubDBCnDataGrid)
            da.Fill(dt)
        End Using
        Dim autoSource As String() = (From r As DataRow In dt.AsEnumerable() Select r.Field(Of String)(FLDName)).ToArray()
        Dim source As AutoCompleteStringCollection = New AutoCompleteStringCollection()
        source.AddRange(autoSource)
        With pTextBox
            .AutoCompleteCustomSource = source
            .AutoCompleteMode = AutoCompleteMode.SuggestAppend
            .AutoCompleteSource = AutoCompleteSource.CustomSource
        End With

    End Sub
    Public Sub AutoCompleteSearchSQL(SqlStr As String, FLDName As String, ByRef pTextBox As System.Windows.Forms.TextBox)
        'Public Shared Function SearchGridMaster(ByRef LikeSearchString As String, ByRef TableName As String, ByRef FLDName As String, Optional ByRef FLDName1 As String = "", Optional ByRef FLDName2 As String = "", Optional ByRef FLDName3 As String = "", Optional ByRef AdditionalCondition As String = "", Optional ByRef ReturnField As String = "", Optional ByRef ReturnValue As Object = Nothing, Optional ByRef FLDName4 As String = "") As Boolean
        Dim dt As New DataTable()

        Using da As New OleDbDataAdapter(SqlStr, PubDBCnDataGrid)
            da.Fill(dt)
        End Using
        Dim autoSource As String() = (From r As DataRow In dt.AsEnumerable() Select r.Field(Of String)(FLDName)).ToArray()
        Dim source As AutoCompleteStringCollection = New AutoCompleteStringCollection()
        source.AddRange(autoSource)
        With pTextBox
            .AutoCompleteCustomSource = source
            .AutoCompleteMode = AutoCompleteMode.SuggestAppend
            .AutoCompleteSource = AutoCompleteSource.CustomSource
        End With

    End Sub
    Public Sub AutoCompleteCompanySearch(ByRef pTextBox As System.Windows.Forms.TextBox)
        'Public Shared Function SearchGridMaster(ByRef LikeSearchString As String, ByRef TableName As String, ByRef FLDName As String, Optional ByRef FLDName1 As String = "", Optional ByRef FLDName2 As String = "", Optional ByRef FLDName3 As String = "", Optional ByRef AdditionalCondition As String = "", Optional ByRef ReturnField As String = "", Optional ByRef ReturnValue As Object = Nothing, Optional ByRef FLDName4 As String = "") As Boolean
        Dim dt As New DataTable()
        Dim SqlStr As String = ""
        SqlStr = "Select DISTINCT COMPANY_NAME " & vbCrLf _
        & " FROM GEN_COMPANY_MST " & vbCrLf _
        & " Order By 1"

        Using da As New OleDbDataAdapter(SqlStr, PubDBCnDataGrid)
            da.Fill(dt)
        End Using
        Dim autoSource As String() = (From r As DataRow In dt.AsEnumerable() Select r.Field(Of String)("COMPANY_NAME")).ToArray()
        Dim source As AutoCompleteStringCollection = New AutoCompleteStringCollection()
        source.AddRange(autoSource)
        With pTextBox
            .AutoCompleteCustomSource = source
            .AutoCompleteMode = AutoCompleteMode.SuggestAppend
            .AutoCompleteSource = AutoCompleteSource.CustomSource
        End With

    End Sub
#End Region
    Public Function SetCrpt(ByRef Report2 As AxCrystal.AxCrystalReport, ByRef mDestination As Crystal.DestinationConstants, ByRef mNoOfCopies As Short, ByRef mTitle As String, Optional ByRef mSubTitle As String = "", Optional ByRef mDocTitle As Boolean = False, Optional ByRef xMenuID As String = "", Optional ByRef xCINNo As String = "") As Boolean
        On Error GoTo ERR1
        Dim ICodeWidth As String = ""
        Dim CompanyName As String = ""
        Dim BranchName As String = ""
        Dim CompanyAdd, mCompanyAddress As String
        Dim CompanyPhone, UserID, RunDate, PageNo As String
        Dim xDocNo As String = ""
        Dim xOrigDate As String = ""
        Dim xRevNo As String = ""
        Dim xRevDate As String = ""
        Dim mRegdAddress As String = ""
        Dim mRegdAddress1 As String = ""
        Dim mRegdAddress2 As String = ""
        Dim mRegdAddress3 As String = ""
        Dim mRegdAddress4 As String = ""
        Dim pCompanyName As String

        pCompanyName = IIf(IsDBNull(RsCompany.Fields("PRINT_COMPANY_NAME").Value), "", RsCompany.Fields("PRINT_COMPANY_NAME").Value)
        pCompanyName = IIf(pCompanyName = "", RsCompany.Fields("Company_Name").Value, pCompanyName)


        If mDestination = Crystal.DestinationConstants.crptToPrinter Then
            If mNoOfCopies = 0 Then
                MsgInformation("No Of Copies should be more than 0")
                Exit Function
            End If
        End If
        If RsCompany.Fields("PrintTopCompanyName").Value = "Y" Then
            ''CompanyName = IIf(RsCompany.Fields("PrintCompanyFull_ShortName").Value = "F", RsCompany.Fields("Company_Name").Value, IIf(IsdbNull(RsCompany.Fields("CompanyShortName").Value), "", RsCompany.Fields("CompanyShortName").Value))
            CompanyName = pCompanyName  '' RsCompany.Fields("Company_Name").Value
        Else
            CompanyName = ""
        End If
        ''BranchName = RsCompany.Fields("BranchName").Value
        If RsCompany.Fields("PrintTopCompanyAddress").Value = "Y" Then
            CompanyAdd = "" & RsCompany.Fields("COMPANY_ADDR").Value & "," & RsCompany.Fields("COMPANY_CITY").Value & " , " & RsCompany.Fields("COMPANY_STATE").Value & " - " & RsCompany.Fields("COMPANY_PIN").Value & ""
        Else
            CompanyAdd = ""
        End If
        If RsCompany.Fields("PRintTopCompanyPhone").Value = "Y" Then
            CompanyPhone = "Phone  " & RsCompany.Fields("COMPANY_PHONE").Value & " Fax : " & RsCompany.Fields("COMPANY_FAXNO").Value & " e-Mail : " & RsCompany.Fields("COMPANY_MAILID").Value
        Else
            CompanyPhone = ""
        End If
        If RsCompany.Fields("PrintTopCompanyAddress").Value = "N" Then
            mCompanyAddress = ""
        End If
        Report2.Destination = mDestination
        Report2.DiscardSavedData = True
        MainClass.ReportWindow(Report2, mTitle)
        MainClass.AssignCRptFormulas(Report2, "CompanyName=""" & CompanyName & """")
        'MainClass.AssignCRptFormulas Report2, "BRANCHName=""" & BranchName & """"
        MainClass.AssignCRptFormulas(Report2, "CompanyAddress=""" & CompanyAdd & """")
        MainClass.AssignCRptFormulas(Report2, "Title=""" & UCase(mTitle) & """")
        MainClass.AssignCRptFormulas(Report2, "SubTitle=""" & mSubTitle & """")
        'ICodeWidth = IIf(IsdbNull(RsCompany.Fields("ITEMCODECHAR").Value), 1, RsCompany.Fields("ITEMCODECHAR").Value)
        'MainClass.AssignCRptFormulas Report2, "ItemCodeChar=""" & ICodeWidth & """"
        If RsCompany.Fields("PrintBotCompanyName").Value = "Y" Then
            CompanyName = pCompanyName  '' RsCompany.Fields("Company_Name").Value
        Else
            CompanyName = ""
        End If
        CompanyAdd = IIf(RsCompany.Fields("PrintBotCompanyAddress").Value = "Y", "" & RsCompany.Fields("COMPANY_ADDR").Value & " ," & RsCompany.Fields("COMPANY_CITY").Value & "," & RsCompany.Fields("COMPANY_STATE").Value & " - " & RsCompany.Fields("COMPANY_PIN").Value & "", "")
        CompanyPhone = IIf(RsCompany.Fields("PrintBotCompanyPhone").Value = "Y", "Phone  " & RsCompany.Fields("COMPANY_PHONE").Value & " Fax : " & RsCompany.Fields("COMPANY_FAXNO").Value & " e-mail : " & RsCompany.Fields("COMPANY_MAILID").Value, "")
        MainClass.AssignCRptFormulas(Report2, "CompanyBotLine1=""" & CompanyName & " " & CompanyAdd & """")
        MainClass.AssignCRptFormulas(Report2, "CompanyBotLine2=""" & IIf(IsDBNull(CompanyPhone), "", CompanyPhone) & """")
        If RsCompany.Fields("Printuser").Value = "Y" Then
            UserID = PubUserID
        Else
            UserID = ""
        End If
        If RsCompany.Fields("PrintrunDate").Value = "Y" Then
            RunDate = (PubCurrDate).ToString("dd/MM/yyyy") '' str(Of Date)()
        Else
            RunDate = " "
        End If
        If RsCompany.Fields("PrintPageNo").Value = "Y" Then
            PageNo = "Y"
        Else
            PageNo = "N"
        End If
        If mDocTitle = True Then
            If Trim(xMenuID) <> "" Then
                If MainClass.SetReportDocDetail(xMenuID, PubDBCn, xDocNo, xOrigDate, xRevNo, xRevDate) = True Then
                    MainClass.AssignCRptFormulas(Report2, "DocNo=""" & xDocNo & """")
                    MainClass.AssignCRptFormulas(Report2, "OrigDate=""" & xOrigDate & """")
                    MainClass.AssignCRptFormulas(Report2, "RevNo=""" & xRevNo & """")
                    MainClass.AssignCRptFormulas(Report2, "RevDate=""" & xRevDate & """")
                End If
            End If
        End If
        If xCINNo = "Y" Then
            MainClass.AssignCRptFormulas(Report2, "COMPANYCINNo=""" & IIf(IsDBNull(RsCompany.Fields("CIN_NO").Value), "", RsCompany.Fields("CIN_NO").Value) & """")
            mRegdAddress = "Regd Office  " & IIf(IsDBNull(RsCompany.Fields("REGD_ADDR1").Value), "", RsCompany.Fields("REGD_ADDR1").Value)

            mRegdAddress1 = IIf(IsDBNull(RsCompany.Fields("REGD_ADDR2").Value), "", RsCompany.Fields("REGD_ADDR2").Value)

            mRegdAddress2 = IIf(IsDBNull(RsCompany.Fields("REGD_CITY").Value), "", RsCompany.Fields("REGD_CITY").Value)

            mRegdAddress3 = IIf(IsDBNull(RsCompany.Fields("REGD_STATE").Value), "", " - " & RsCompany.Fields("REGD_STATE").Value)

            mRegdAddress4 = IIf(IsDBNull(RsCompany.Fields("REGD_PHONE").Value), "", " Phone  " & RsCompany.Fields("REGD_PHONE").Value)

            mRegdAddress = mRegdAddress & mRegdAddress1 & mRegdAddress2 & mRegdAddress3 & mRegdAddress4

            'mRegdAddress = mRegdAddress & IIf(IsDBNull(RsCompany.Fields("REGD_ADDR2").Value) Or RsCompany.Fields("REGD_ADDR2").Value = "", "", RsCompany.Fields("REGD_ADDR2").Value)
            'mRegdAddress = mRegdAddress & IIf(IsDBNull(RsCompany.Fields("REGD_CITY").Value) Or RsCompany.Fields("REGD_CITY").Value = "", "", RsCompany.Fields("REGD_CITY").Value)
            'mRegdAddress = mRegdAddress & IIf(IsDBNull(RsCompany.Fields("REGD_STATE").Value) Or RsCompany.Fields("REGD_STATE").Value = "", "", " - " & RsCompany.Fields("REGD_STATE").Value)
            'mRegdAddress = mRegdAddress & IIf(IsDBNull(RsCompany.Fields("REGD_PHONE").Value) Or RsCompany.Fields("REGD_PHONE").Value = "", "", " Phone  " & RsCompany.Fields("REGD_PHONE").Value)
            MainClass.AssignCRptFormulas(Report2, "CompanyRegdAdd=""" & mRegdAddress & """")
        End If
        MainClass.AssignCRptFormulas(Report2, "UserID=""" & UserID & """")
        MainClass.AssignCRptFormulas(Report2, "PrintDate=""" & RunDate & """")
        MainClass.AssignCRptFormulas(Report2, "PrintPageNo=""" & PageNo & """")
        SetReportMargin(Report2)
        Report2.Connect = STRRptConn
        SetCrpt = True
        Exit Function
ERR1:
        'Resume
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        ''Resume
    End Function
    Public Function SetCrptForLedger(ByRef pCompanyCode As Long, ByRef Report2 As AxCrystal.AxCrystalReport, ByRef mDestination As Crystal.DestinationConstants, ByRef mNoOfCopies As Short, ByRef mTitle As String, Optional ByRef mSubTitle As String = "", Optional ByRef mDocTitle As Boolean = False, Optional ByRef xMenuID As String = "", Optional ByRef xCINNo As String = "") As Boolean
        On Error GoTo ERR1
        Dim ICodeWidth As String = ""
        Dim CompanyName As String = ""
        Dim BranchName As String = ""
        Dim CompanyAdd, mCompanyAddress As String
        Dim pCompanyPhone As String

        Dim CompanyPhone, UserID, RunDate, PageNo As String
        Dim xDocNo As String = ""
        Dim xOrigDate As String = ""
        Dim xRevNo As String = ""
        Dim xRevDate As String = ""
        Dim mRegdAddress As String = ""
        Dim mRegdAddress1 As String = ""
        Dim mRegdAddress2 As String = ""
        Dim mRegdAddress3 As String = ""
        Dim mRegdAddress4 As String = ""
        Dim pCompanyName As String

        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xCompanyCode As String

        If mDestination = Crystal.DestinationConstants.crptToPrinter Then
            If mNoOfCopies = 0 Then
                MsgInformation("No Of Copies should be more than 0")
                Exit Function
            End If
        End If

        xCompanyCode = IIf(pCompanyCode = -1, RsCompany.Fields("COMPANY_CODE").Value, pCompanyCode)

        mSqlStr = "Select FIN_PRINT_MST.*, "

        mSqlStr = mSqlStr & vbCrLf _
            & "ELEC_RATE, COMMISIONER_RATE, PFEST, COMPANY_SHORTNAME, COMPANY_PIN, REGD_STATE, EXCISE_DIV, EXEMPTED_UNIT, " & vbCrLf _
            & "COMPANY_NAME, SERV_REGN_NO, ESIEST, IEC_NO, COMPANY_PHONE, REGD_PIN, EXCISE_RANGE, COMPANY_GST_RGN_NO, " & vbCrLf _
            & "COMPANY_ADDR, REGD_ADDR1, CST_NO, ISEOU, COMPANY_FAXNO, REGD_PHONE, CENT_EXC_RGN_NO, WEBSITE, " & vbCrLf _
            & "COMPANY_CITY, REGD_ADDR2, LST_NO, JURISDICTION, COMPANY_MAILID, REGD_FAXNO, ECC_NO, STATUS, " & vbCrLf _
            & "COMPANY_STATE, REGD_CITY, PAN_NO, CIN_NO, TDSNO, REGD_MAILID, LST_PER, PRINT_COMPANY_NAME "

        mSqlStr = mSqlStr & vbCrLf _
            & " FROM GEN_COMPANY_MST, FIN_PRINT_MST " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " GEN_COMPANY_MST.COMPANY_CODE=FIN_PRINT_MST.COMPANY_CODE(+) " & vbCrLf _
            & " And GEN_COMPANY_MST.COMPANY_CODE =" & xCompanyCode & " "

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)


        If RsTemp.EOF = True Then SetCrptForLedger = True : Exit Function

        pCompanyName = IIf(IsDBNull(RsTemp.Fields("PRINT_COMPANY_NAME").Value), "", RsTemp.Fields("PRINT_COMPANY_NAME").Value)
        pCompanyName = IIf(pCompanyName = "", RsCompany.Fields("Company_Name").Value, pCompanyName)

        If pCompanyCode = -1 Then
            mCompanyAddress = IIf(IsDBNull(RsTemp.Fields("REGD_ADDR1").Value), "", RsTemp.Fields("REGD_ADDR1").Value)
            mCompanyAddress = mCompanyAddress & " " & IIf(IsDBNull(RsTemp.Fields("REGD_ADDR2").Value), "", RsTemp.Fields("REGD_ADDR2").Value)
            mCompanyAddress = mCompanyAddress & ", " & IIf(IsDBNull(RsTemp.Fields("REGD_CITY").Value), "", RsTemp.Fields("REGD_CITY").Value)
            mCompanyAddress = mCompanyAddress & ", " & IIf(IsDBNull(RsTemp.Fields("REGD_STATE").Value), "", " - " & RsTemp.Fields("REGD_STATE").Value)
        Else
            mCompanyAddress = "" & RsTemp.Fields("COMPANY_ADDR").Value & "," & RsTemp.Fields("COMPANY_CITY").Value & " , " & RsTemp.Fields("COMPANY_STATE").Value & " - " & RsTemp.Fields("COMPANY_PIN").Value & ""
        End If

        If pCompanyCode = -1 Then
            pCompanyPhone = "Phone  " & IIf(IsDBNull(RsTemp.Fields("REGD_PHONE").Value), "", RsTemp.Fields("REGD_PHONE").Value)
            pCompanyPhone = pCompanyPhone & " e-Mail : " & IIf(IsDBNull(RsTemp.Fields("REGD_MAILID").Value), "", RsTemp.Fields("REGD_MAILID").Value)
        Else
            pCompanyPhone = "Phone  " & RsTemp.Fields("COMPANY_PHONE").Value & " Fax : " & RsTemp.Fields("COMPANY_FAXNO").Value & " e-Mail : " & RsTemp.Fields("COMPANY_MAILID").Value
        End If

        If RsTemp.Fields("PrintTopCompanyName").Value = "Y" Then
            CompanyName = pCompanyName
        Else
            CompanyName = ""
        End If
        If RsTemp.Fields("PrintTopCompanyAddress").Value = "Y" Then
            CompanyAdd = mCompanyAddress
        Else
            CompanyAdd = ""
        End If

        If RsTemp.Fields("PRintTopCompanyPhone").Value = "Y" Then
            CompanyPhone = pCompanyPhone
        Else
            CompanyPhone = ""
        End If


        Report2.Destination = mDestination
        Report2.DiscardSavedData = True
        MainClass.ReportWindow(Report2, mTitle)
        MainClass.AssignCRptFormulas(Report2, "CompanyName=""" & CompanyName & """")
        MainClass.AssignCRptFormulas(Report2, "CompanyAddress=""" & CompanyAdd & """")
        MainClass.AssignCRptFormulas(Report2, "Title=""" & UCase(mTitle) & """")
        MainClass.AssignCRptFormulas(Report2, "SubTitle=""" & mSubTitle & """")
        If RsTemp.Fields("PrintBotCompanyName").Value = "Y" Then
            CompanyName = pCompanyName
        Else
            CompanyName = ""
        End If

        CompanyAdd = mCompanyAddress
        CompanyPhone = pCompanyPhone

        MainClass.AssignCRptFormulas(Report2, "CompanyBotLine1=""" & CompanyName & " " & CompanyAdd & """")
        MainClass.AssignCRptFormulas(Report2, "CompanyBotLine2=""" & IIf(IsDBNull(CompanyPhone), "", CompanyPhone) & """")
        If RsTemp.Fields("Printuser").Value = "Y" Then
            UserID = PubUserID
        Else
            UserID = ""
        End If
        If RsTemp.Fields("PrintrunDate").Value = "Y" Then
            RunDate = (PubCurrDate).ToString("dd/MM/yyyy") '' str(Of Date)()
        Else
            RunDate = " "
        End If
        If RsTemp.Fields("PrintPageNo").Value = "Y" Then
            PageNo = "Y"
        Else
            PageNo = "N"
        End If
        If mDocTitle = True Then
            If Trim(xMenuID) <> "" Then
                If MainClass.SetReportDocDetail(xMenuID, PubDBCn, xDocNo, xOrigDate, xRevNo, xRevDate) = True Then
                    MainClass.AssignCRptFormulas(Report2, "DocNo=""" & xDocNo & """")
                    MainClass.AssignCRptFormulas(Report2, "OrigDate=""" & xOrigDate & """")
                    MainClass.AssignCRptFormulas(Report2, "RevNo=""" & xRevNo & """")
                    MainClass.AssignCRptFormulas(Report2, "RevDate=""" & xRevDate & """")
                End If
            End If
        End If
        If xCINNo = "Y" Then
            MainClass.AssignCRptFormulas(Report2, "COMPANYCINNo=""" & IIf(IsDBNull(RsTemp.Fields("CIN_NO").Value), "", RsTemp.Fields("CIN_NO").Value) & """")
            mRegdAddress = "Regd Office  " & IIf(IsDBNull(RsTemp.Fields("REGD_ADDR1").Value), "", RsTemp.Fields("REGD_ADDR1").Value)

            mRegdAddress1 = IIf(IsDBNull(RsTemp.Fields("REGD_ADDR2").Value), "", RsTemp.Fields("REGD_ADDR2").Value)

            mRegdAddress2 = IIf(IsDBNull(RsTemp.Fields("REGD_CITY").Value), "", RsTemp.Fields("REGD_CITY").Value)

            mRegdAddress3 = IIf(IsDBNull(RsTemp.Fields("REGD_STATE").Value), "", " - " & RsTemp.Fields("REGD_STATE").Value)

            mRegdAddress4 = IIf(IsDBNull(RsTemp.Fields("REGD_PHONE").Value), "", " Phone  " & RsTemp.Fields("REGD_PHONE").Value)

            mRegdAddress = mRegdAddress & mRegdAddress1 & mRegdAddress2 & mRegdAddress3 & mRegdAddress4
            MainClass.AssignCRptFormulas(Report2, "CompanyRegdAdd=""" & mRegdAddress & """")
        End If
        MainClass.AssignCRptFormulas(Report2, "UserID=""" & UserID & """")
        MainClass.AssignCRptFormulas(Report2, "PrintDate=""" & RunDate & """")
        MainClass.AssignCRptFormulas(Report2, "PrintPageNo=""" & PageNo & """")
        SetReportMargin(Report2)

        Report2.Connect = STRRptConn
        SetCrptForLedger = True
        Exit Function
ERR1:
        'Resume
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        ''Resume
    End Function
    Public Sub SetReportMargin(ByRef Report3 As AxCrystal.AxCrystalReport)
        Report3.MarginTop = IIf(IsDBNull(RsCompany.Fields("REPORTMARGINTOP").Value), 0, RsCompany.Fields("REPORTMARGINTOP").Value) * 1440
        Report3.MarginBottom = IIf(IsDBNull(RsCompany.Fields("REPORTMARGINBOT").Value), 0, RsCompany.Fields("REPORTMARGINBOT").Value) * 1440
        Report3.MarginLeft = IIf(IsDBNull(RsCompany.Fields("REPORTMARGINLEFT").Value), 0, RsCompany.Fields("REPORTMARGINLEFT").Value) * 1440
        Report3.MarginRight = IIf(IsDBNull(RsCompany.Fields("REPORTMARGINRIGHT").Value), 0, RsCompany.Fields("REPORTMARGINRIGHT").Value) * 1440
    End Sub
    Public Function CalcTDSRate(ByRef pSectionCode As Integer, ByRef mCTYPE As String, ByRef pPvtDBCn As ADODB.Connection, Optional ByRef mWEF As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim Sql As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mTdsRate As Double
        Dim mTdsSurRate As Double
        Sql = " FROM TDS_Rate_MST TDSRate WHERE " & vbCrLf _
        & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
        & " AND CODE =" & pSectionCode & ""
        SqlStr = "Select BASICRATEPER, SURCHARGEPER,NCBASICRATEPER, NCSURCHARGEPER " & vbCrLf _
        & Sql
        If Trim(mWEF) <> "" Then
            SqlStr = SqlStr & vbCrLf _
            & " AND WEF=( SELECT MAX(WEF) " & Sql _
            & " AND WEF<=TO_DATE('" & VB6.Format(mWEF, "dd-MMM-yyyy") & "','DD-MON-YYYY')" & " )"
        Else
            SqlStr = SqlStr & vbCrLf & " AND WEF=( SELECT MAX(WEF) " & Sql & " )"
        End If
        MainClass.UOpenRecordSet(SqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        CalcTDSRate = 0
        If RsTemp.EOF = False Then
            If mCTYPE = "C" Then
                mTdsRate = IIf(IsDBNull(RsTemp.Fields("BASICRATEPER").Value), 0, RsTemp.Fields("BASICRATEPER").Value)
                mTdsSurRate = IIf(IsDBNull(RsTemp.Fields("SURCHARGEPER").Value), 0, RsTemp.Fields("SURCHARGEPER").Value) * mTdsRate / 100
            Else
                mTdsRate = IIf(IsDBNull(RsTemp.Fields("NCBASICRATEPER").Value), 0, RsTemp.Fields("NCBASICRATEPER").Value)
                mTdsSurRate = IIf(IsDBNull(RsTemp.Fields("NCSURCHARGEPER").Value), 0, RsTemp.Fields("NCSURCHARGEPER").Value) * mTdsRate / 100
            End If
        End If
        CalcTDSRate = mTdsRate + mTdsSurRate
        Exit Function
ErrPart:
        MsgBox(Err.Description)
        CalcTDSRate = 0
    End Function
    Public Function GetProductionType(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        'cboType.AddItem "General Consumable"
        'cboType.AddItem "Production"
        'cboType.AddItem "Jobwork Third Party"
        'cboType.AddItem "Consumable (Production)"
        'cboType.AddItem "Tool"
        'cboType.AddItem "Assets"
        'cboType.AddItem "Raw Material"
        'cboType.AddItem "BOP"
        'cboType.AddItem "InHouse"
        'cboType.AddItem "Development - BOP/RM"
        'cboType.AddItem "Maintances Item"
        'cboType.AddItem "Service"
        'CboType.AddItem "1. Trolly & Bins"
        'CboType.AddItem "2. Third Party Materials"
        'cboType.AddItem "3. Raw Material (Tubes)"
        'cboType.AddItem "4. Diesel"
        'cboType.AddItem "5. CO2"
        'cboType.AddItem "6. Iron Scrap"
        'cboType.AddItem "7. MIG Wire"
        GetProductionType = "G"
        If pItemCode = "" Then
            Exit Function
        End If

        mSqlStr = "SELECT PRD_TYPE " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetProductionType = IIf(IsDBNull(RsTemp.Fields("PRD_TYPE").Value), "G", RsTemp.Fields("PRD_TYPE").Value)
        End If

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 101 Then

        Else
            If RsCompany.Fields("IS_WAREHOUSE").Value = "Y" And (GetProductionType = "P" Or GetProductionType = "I") Then
                GetProductionType = "G"
            End If
        End If


        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function GetMRPRate(ByRef mWEF As String, ByRef mFieldName As String, ByRef mItemCode As String, ByRef pCheckType As String) As Double
        On Error GoTo ERR1
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        GetMRPRate = 0
        If Trim(mWEF) = "" Then mWEF = VB6.Format(PubCurrDate, "dd/MM/yyyy")
        SqlStr = ""
        If pCheckType = "P" Then
            SqlStr = " Select " & mFieldName & " As RATE FROM INV_ITEM_MRP_DET " & vbCrLf _
                & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " And ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'" & vbCrLf _
                & " AND WEF_DATE=" & vbCrLf & " (SELECT MAX(WEF_DATE) " & vbCrLf _
                & " FROM INV_ITEM_MRP_DET " & vbCrLf _
                & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'" & vbCrLf _
                & " AND WEF_DATE<TO_DATE('" & VB6.Format(mWEF, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        ElseIf pCheckType = "L" Then
            SqlStr = " SELECT " & mFieldName & " AS RATE FROM INV_ITEM_MRP_DET " & vbCrLf _
                & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'" & vbCrLf _
                & " AND WEF_DATE=" & vbCrLf _
                & " (SELECT MAX(WEF_DATE) " & vbCrLf _
                & " FROM INV_ITEM_MRP_DET " & vbCrLf _
                & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'" & vbCrLf _
                & " AND WEF_DATE<=TO_DATE('" & VB6.Format(mWEF, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        Else
            SqlStr = " SELECT " & mFieldName & " AS RATE FROM INV_ITEM_MRP_DET " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'" & vbCrLf _
                & " AND WEF_DATE=TO_DATE('" & VB6.Format(mWEF, "dd-MMM-yyyy") & "','DD-MON-YYYY')"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetMRPRate = Val(IIf(IsDBNull(RsTemp.Fields("RATE").Value), 0, RsTemp.Fields("RATE").Value))
        Else
            If pCheckType = "C" And mFieldName = "RATE" Then
                If MainClass.ValidateWithMasterTable(mItemCode, "ITEM_CODE", "ITEM_STD_COST", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    GetMRPRate = Val(MasterNo)
                End If
            End If
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ' Resume
    End Function
    Public Function ToHexDump(ByRef sText As String) As String
        Dim lIdx As Integer
        ToHexDump = ""
        For lIdx = 1 To Len(sText)
            ToHexDump = ToHexDump & Right("0" & Hex(Asc(Mid(sText, lIdx, 1))), 2)
        Next
    End Function
    Public Function FromHexDump(ByRef sText As String) As String
        Dim lIdx As Integer
        FromHexDump = ""
        For lIdx = 1 To Len(sText) Step 2
            FromHexDump = FromHexDump & Chr(CInt("&H" & Mid(sText, lIdx, 2)))
        Next
    End Function
    Public Function CryptRC4(ByRef sText As String, ByRef sKey As String) As String
        Dim baS(255) As Byte
        Dim baK(255) As Byte
        Dim bytSwap As Byte
        Dim lI As Integer
        Dim lJ As Integer
        Dim lIdx As Integer
        CryptRC4 = ""
        For lIdx = 0 To 255
            baS(lIdx) = lIdx
            baK(lIdx) = Asc(Mid(sKey, 1 + (lIdx Mod Len(sKey)), 1))
        Next
        For lI = 0 To 255
            lJ = (lJ + baS(lI) + baK(lI)) Mod 256
            bytSwap = baS(lI)
            baS(lI) = baS(lJ)
            baS(lJ) = bytSwap
        Next
        lI = 0
        lJ = 0
        For lIdx = 1 To Len(sText)
            lI = (lI + 1) Mod 256
            lJ = (lJ + baS(lI)) Mod 256
            bytSwap = baS(lI)
            baS(lI) = baS(lJ)
            baS(lJ) = bytSwap
            CryptRC4 = CryptRC4 & Chr(pvCryptXor(baS((CInt(baS(lI)) + baS(lJ)) Mod 256), Asc(Mid(sText, lIdx, 1))))
        Next
    End Function
    Private Function pvCryptXor(ByVal lI As Integer, ByVal lJ As Integer) As Integer
        If lI = lJ Then
            pvCryptXor = lJ
        Else
            pvCryptXor = lI Xor lJ
        End If
    End Function
    Public Function DeleteStockTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefType As String, ByRef pRefNo As String, Optional ByRef pStockID As String = "") As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim mTableName As String
        mTableName = ConInventoryTable

        SqlStr = "DELETE FROM " & mTableName & " " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " And REF_TYPE='" & pRefType & "'" & vbCrLf & " AND REF_NO=" & Val(pRefNo) & "" & vbCrLf
        If pStockID <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND STOCK_ID='" & pStockID & "'"
        End If
        pDBCn.Execute(SqlStr)
        DeleteStockTRN = True
        Exit Function
UpdateStockTRNErr:
        DeleteStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function DeleteCRTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefType As String, ByRef pRefNo As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM DSP_CR_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " And REF_TYPE='" & pRefType & "'" & vbCrLf & " AND AUTO_KEY_REF=" & Val(pRefNo) & "" & vbCrLf
        pDBCn.Execute(SqlStr)
        DeleteCRTRN = True
        Exit Function
UpdateStockTRNErr:
        DeleteCRTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetBalanceStockQty(ByVal pItemCode As String, ByVal pDateTo As String, ByVal pPackUnit As String,
                                       ByVal pDeptCode As String, ByVal pStockType As String, ByVal pLotNo As String, ByVal pStock_ID As String, ByVal pDivision As Double,
                                       Optional ByVal pRefType As String = "", Optional ByRef pRefNo As Double = -1, Optional ByRef pFGBatchNoReq As String = "",
                                       Optional ByRef pStatus As String = "", Optional ByRef pHeatNo As String = "",
                                       Optional ByRef pFinalStock As String = "", Optional ByRef pAssets As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim mChildBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String = ""
        Dim mChildItemCode As String = ""
        Dim mHeatNoReq As String

        pStatus = IIf(pStatus = "", "O", pStatus)
        pDeptCode = Trim(pDeptCode)

        If MainClass.ValidateWithMasterTable(pItemCode, "ITEM_CODE", "HEAT_NO_REQ", "Inv_Item_Mst", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND HEAT_NO_REQ='Y'") = True Then
            mHeatNoReq = "Y"
        Else
            mHeatNoReq = "N"
        End If

        pAssets = IIf(pAssets = "", "N", pAssets)

        'SqlStr = " Select ITEM_CODE FROM INV_ITEM_MST" & vbCrLf _
        '& " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " And IS_CHILD='Y'" & vbCrLf _
        '& " AND PARENT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        'MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        'mChildBalQty = 0
        'If RsTemp.EOF = False Then
        '    Do While RsTemp.EOF = False
        '        mChildItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value))
        '        mChildBalQty = mChildBalQty + GetBalanceStockQty(mChildItemCode, pDateTo, pPackUnit, pDeptCode, pStockType, pLotNo, pStock_ID, pDivision, pRefType, pRefNo)
        '        RsTemp.MoveNext()
        '    Loop
        'Else
        '    mChildBalQty = 0
        'End If

        SqlStr = ""
        SqlStr = "SELECT "
        SqlStr = SqlStr & vbCrLf & " --+ ORDERED INDEX (INV_STOCK_REC_TRN, IND_STK_REC_TRN_17)"
        SqlStr = SqlStr & vbCrLf & "SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""

        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        If pStock_ID <> "" Then
            SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        End If

        If pDivision <> -1 Then
            SqlStr = SqlStr & vbCrLf & "AND DIV_CODE=" & pDivision & ""
        End If

        SqlStr = SqlStr & vbCrLf & " AND STATUS='" & pStatus & "'"

        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            ''02-08-2006
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If

        If pFinalStock = "F" Then

        Else
            If Trim(pLotNo) <> "X" Then
                If pStockType <> "SC" Then
                    If pFGBatchNoReq = "Y" Then
                        If pLotNo <= "0" Then
                            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO<='0'"
                        Else
                            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & Trim(pLotNo) & "'"
                        End If
                    Else
                        If Trim(pLotNo) = "" Then
                        Else
                            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & Trim(pLotNo) & "'"
                        End If
                    End If
                End If
            End If

            If mHeatNoReq = "Y" Then
                If Trim(pHeatNo) = "X" Then
                ElseIf Trim(pHeatNo) = "" Then
                    SqlStr = SqlStr & vbCrLf & " AND (HEAT_NO='' OR HEAT_NO IS NULL) "
                Else
                    SqlStr = SqlStr & vbCrLf & " AND HEAT_NO='" & Trim(pHeatNo) & "'"
                End If
            End If
        End If

        If pRefType = "ISS" Or pRefType = "RGP" Or pRefType = "NRG" Then
            If pAssets <> "A" Then
                SqlStr = SqlStr & vbCrLf & " AND IS_CAPITAL='" & Trim(pAssets) & "'"
            End If
        End If

        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & CDate(pDateTo).ToString("dd/MMM/yyyy") & "','DD-MON-YYYY'))"
        Else
            If pStockType = "" Then
                SqlStr = SqlStr & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-MMM-yyyy") & "','DD-MON-YYYY')"
            Else
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "' AND E_DATE<=TO_DATE('" & CDate(pDateTo).ToString("dd/MMM/yyyy") & "','DD-MON-YYYY')"
            End If
        End If
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & CDate(pDateTo).ToString("dd/MMM/yyyy") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetBalanceStockQty = mBalQty + mChildBalQty
        Exit Function
ErrPart:
        GetBalanceStockQty = 0
    End Function
    Public Function GetLatestItemCostFromMRR(ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pTotClosing As Double,
                                             ByRef pAsOnDate As String, ByRef pCostType As String, Optional ByRef pStockType As String = "",
                                             Optional ByRef pDeptCode As String = "", Optional ByRef mCheckInHouse As String = "",
                                             Optional ByRef pBalanceType As String = "", Optional ByRef pStockID As String = "", Optional ByRef pPartyCode As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mRunningBal As Double
        Dim mApprovedQty As Double
        Dim mQtyValue As Double
        Dim mCalcQty As Double
        Dim pRefDate As String
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim xSaleCost As Double
        Dim mCategory As String
        Dim mStockType As String = ""
        Dim mItemPurchaseCost As Double
        Dim mItemSalesCost As Double
        Dim mMKey As String
        Dim pINHouseRate As Double
        Dim mMainItemCode As String
        Dim mFYOPQty As Double
        Dim mCLQty As Double
        Dim mFYOPAmount As Double
        Dim mCLAmount As Double
        Dim mPurchaseQty As Double
        Dim mPurchaseValue As Double
        Dim mConsumption As Double
        Dim mItemRate As Double
        Dim mNetQty As Double
        Dim mNETVALUE As Double
        GetLatestItemCostFromMRR = 0
        If Trim(pItemCode) = "" Then '
            Exit Function
        End If
        If pTotClosing <= 0 Then
            GetLatestItemCostFromMRR = 0
            Exit Function
        End If
        mMainItemCode = GetMainItemCode(pItemCode)
        mFactor = 1

        SqlStr = "SELECT A.ISSUE_UOM, A.PURCHASE_UOM, A.UOM_FACTOR,A.PURCHASE_COST,A.ITEM_STD_COST, A.CATEGORY_CODE, B.RATE " & vbCrLf _
            & " FROM INV_ITEM_MST A, INV_ITEM_RATE_MST B " & vbCrLf _
            & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
            & " AND A.ITEM_CODE=B.ITEM_CODE" & vbCrLf _
            & " AND A.ITEM_CODE='" & Trim(mMainItemCode) & "'"

        ''SqlStr = " Select ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST,ITEM_STD_COST,CATEGORY_CODE FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " And ITEM_CODE='" & MainClass.AllowSingleQuote(mMainItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_UOM").Value), "", RsTemp1.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
            mCategory = IIf(IsDBNull(RsTemp1.Fields("CATEGORY_CODE").Value), "", RsTemp1.Fields("CATEGORY_CODE").Value)
            mItemPurchaseCost = IIf(IsDBNull(RsTemp1.Fields("RATE").Value), 0, RsTemp1.Fields("RATE").Value)
            mItemSalesCost = IIf(IsDBNull(RsTemp1.Fields("RATE").Value), 0, RsTemp1.Fields("RATE").Value)
            If mPurchaseUOM <> mIssueUOM Then
                If mFactor <> 0 Then
                    mItemPurchaseCost = mItemPurchaseCost / mFactor
                    mItemSalesCost = mItemSalesCost / mFactor
                End If
            End If
        End If
        mStockType = GetStockType(PubDBCn, mMainItemCode, 1)
        If mStockType = "CS" Then
            GetLatestItemCostFromMRR = CDbl(VB6.Format(pTotClosing * mItemSalesCost, "0.0000"))
        ElseIf CheckItemBom(mMainItemCode) = True Or pCostType = "S" Then ''IsProductionItem(mMainItemCode) = True Then'If CheckItemBom(mRMCode) = True Then
            'If mStockType = "FG" And pCostType = "S" Then
            If pStockType = "FG" Or pCostType = "S" Then
                SqlStr = "SELECT ITEM_PRICE " & vbCrLf & " FROM DSP_SALEORDER_HDR IH, DSP_SALEORDER_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.ITEM_CODE='" & mMainItemCode & "' AND SO_APPROVED='Y'" & vbCrLf & " AND ID.AMEND_WEF= ( " & vbCrLf & " SELECT MAX(SD.AMEND_WEF) " & vbCrLf & " FROM DSP_SALEORDER_HDR SH, DSP_SALEORDER_DET SD" & vbCrLf & " WHERE SH.MKEY=SD.MKEY" & vbCrLf & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SD.ITEM_CODE='" & mMainItemCode & "' AND SO_APPROVED='Y'" & vbCrLf & " AND SD.AMEND_WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
                SqlStr = SqlStr & vbCrLf & " ORDER BY SO_STATUS DESC"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    xSaleCost = IIf(IsDBNull(RsTemp.Fields("ITEM_PRICE").Value), "", RsTemp.Fields("ITEM_PRICE").Value)
                Else
                    xSaleCost = mItemSalesCost
                End If
            Else
                If pDeptCode = "" And pStockID <> "WH" Then
                    xSaleCost = GetSummarisedMaterialCost(mMainItemCode, pStockType, pAsOnDate, pCostType, pTotClosing, pItemUOM, -1)
                Else
                    xSaleCost = GetMaterialCost(mMainItemCode, pStockType, pDeptCode, pAsOnDate, pCostType, pTotClosing)
                End If
            End If
            If xSaleCost = 0 Then GoTo NextRow
            GetLatestItemCostFromMRR = CDbl(VB6.Format(pTotClosing * xSaleCost, "0.0000"))
        Else
NextRow:
            If pCostType = "C" Then ''Get Data fom PO Only
                If GetLatestItemCostFromPO(mMainItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
                If xPurchaseCost = 0 Then
                    mQtyValue = (pTotClosing * mItemPurchaseCost)
                Else
                    mQtyValue = (pTotClosing * xPurchaseCost)
                End If
                GetLatestItemCostFromMRR = mQtyValue
            Else
                'mPurchaseQty = 0
                'If pBalanceType = "CL" Then
                'mCLQty = GetBalanceStockQty(mMainItemCode, pAsOnDate, pItemUOM, "STR", "ST", "", ConWH, -1)
                'If mCLQty <= 0 Then
                'mCLAmount = 0
                'Else
                'mCLAmount = GetLandedCost(mMainItemCode, pItemUOM, mCLQty, pAsOnDate, mFactor, pCostType, mPurchaseQty, "CL")
                'End If
                'If mCLQty <= 0 Then
                'mItemRate = 0
                'If GetLatestItemCostFromPO(mMainItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
                'If pCostType = "P" Then
                'mItemRate = IIf(xPurchaseCost = 0, mItemPurchaseCost, xPurchaseCost)
                'ElseIf pCostType = "L" Then
                'mItemRate = IIf(xPurchaseCost = 0, mItemPurchaseCost, xLandedCost)
                'End If
                'Else
                'mItemRate = mCLAmount / mCLQty
                'End If
                'Else
                'mFYOPQty = GetBalanceStockQty(mMainItemCode, VB6.Format(RsCompany!Start_Date, "dd/MM/yyyy"), pItemUOM, "STR", "ST", "", ConWH, -1)
                'If mFYOPQty <= 0 Then
                'mFYOPAmount = 0
                'Else
                'mFYOPAmount = GetLandedCost(mMainItemCode, pItemUOM, mFYOPQty, VB6.Format(RsCompany!Start_Date, "dd/MM/yyyy"), mFactor, pCostType, mPurchaseQty, "OP")
                'End If
                '
                'mCLQty = GetBalanceStockQty(mMainItemCode, pAsOnDate, pItemUOM, "STR", "ST", "", ConWH, -1)
                'If mCLQty <= 0 Then
                'mCLAmount = 0
                'Else
                'mCLAmount = GetLandedCost(mMainItemCode, pItemUOM, mCLQty, pAsOnDate, mFactor, pCostType, mPurchaseQty, "CL")
                'End If
                '
                'mPurchaseValue = GetLandedCost(mMainItemCode, pItemUOM, mCLQty, pAsOnDate, mFactor, pCostType, mPurchaseQty, "PUR")
                '
                'mNetQty = mFYOPQty + mPurchaseQty - mCLQty
                'mNETVALUE = mFYOPAmount + mPurchaseValue - mCLAmount
                '
                'If mNetQty <= 0 Then
                'If mFYOPQty > 0 Then
                'mItemRate = mFYOPAmount / mFYOPQty
                'ElseIf mPurchaseQty > 0 Then
                'mItemRate = mPurchaseValue / mPurchaseQty
                'Else
                'mItemRate = 0
                'End If
                'Else
                'mItemRate = mNETVALUE / mNetQty
                'End If
                'End If
                'GetLatestItemCostFromMRR = (pTotClosing * mItemRate)

                SqlStr = "SELECT MKEY, AUTO_KEY_MRR, VNO, MRR_DATE, ISMODVAT, ISSTREFUND, " & vbCrLf _
                    & " ITEM_UOM, APPROVED_QTY, EDAMOUNT, " & vbCrLf & " STAMOUNT, OTHERS, PORATE " & vbCrLf _
                    & " FROM ( "

                SqlStr = SqlStr & vbCrLf _
                    & " SELECT IH.MKEY, GH.AUTO_KEY_MRR, IH.VNO, GH.MRR_DATE, IH.ISMODVAT, IH.ISSTREFUND, " & vbCrLf _
                    & " ID.ITEM_UOM, (ID.ITEM_QTY - ID.SHORTAGE_QTY - ID.REJECTED_QTY) AS APPROVED_QTY, " & vbCrLf _
                    & " CASE WHEN IH.ITEMVALUE=0 OR ISMODVAT='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS EDAMOUNT, " & vbCrLf _
                    & " CASE WHEN IH.ITEMVALUE=0 OR ISSTREFUND='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTSTAMT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS STAMOUNT, " & vbCrLf _
                    & " CASE WHEN IH.ITEMVALUE=0 OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEXPAMT - (IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT+IH.TOTSTAMT+IH.SUR_VATCLAIMAMOUNT))*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS OTHERS, " & vbCrLf _
                    & " (SELECT (((NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE)" & vbCrLf & " FROM PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD " & vbCrLf & " WHERE PH.COMPANY_CODE = PD.COMPANY_CODE AND PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE" & vbCrLf _
                    & " AND PD.MKEY =(SELECT MAX(SPH.MKEY) " & vbCrLf _
                    & " FROM PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD" & vbCrLf _
                    & " WHERE SPH.MKEY = SPD.MKEY " & vbCrLf _
                    & " AND SPH.AUTO_KEY_PO = ID.CUST_REF_NO" & vbCrLf _
                    & " AND SPD.ITEM_CODE= ID.ITEM_CODE" & vbCrLf _
                    & " AND SPD.PO_WEF_DATE <= GH.MRR_DATE " & vbCrLf _
                    & " AND PO_STATUS='Y')) AS PORATE" & vbCrLf _
                    & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf _
                    & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=GH.COMPANY_CODE" & vbCrLf & " AND IH.AUTO_KEY_MRR=GH.AUTO_KEY_MRR" & vbCrLf & " AND GH.REF_TYPE IN ('P') AND IH.PURCHASESEQTYPE<>3" & vbCrLf & " AND ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND GH.MRR_DATE<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')"
                SqlStr = SqlStr & " UNION " & vbCrLf & " SELECT IH.MKEY, GH.AUTO_KEY_MRR, IH.VNO, GH.MRR_DATE, IH.ISMODVAT, IH.ISSTREFUND, " & vbCrLf & " ID.ITEM_UOM, (ID.ITEM_QTY - ID.SHORTAGE_QTY - ID.REJECTED_QTY) AS APPROVED_QTY, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISMODVAT='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS EDAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISSTREFUND='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTSTAMT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS STAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEXPAMT - (IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT+IH.TOTSTAMT+IH.SUR_VATCLAIMAMOUNT))*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS OTHERS, " & vbCrLf & " (SELECT (((NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE)" & vbCrLf & " FROM PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD " & vbCrLf & " WHERE PH.COMPANY_CODE = PD.COMPANY_CODE AND PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE" & vbCrLf & " AND PD.MKEY =(SELECT MAX(SPH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD" & vbCrLf & " WHERE SPH.MKEY = SPD.MKEY " & vbCrLf & " AND SPH.AUTO_KEY_PO = ID.CUST_REF_NO" & vbCrLf & " AND SPD.ITEM_CODE= ID.ITEM_CODE" & vbCrLf & " AND SPD.PO_WEF_DATE <= GH.MRR_DATE " & vbCrLf & " AND PO_STATUS='Y')) AS PORATE" & vbCrLf & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=GH.COMPANY_CODE" & vbCrLf & " AND ID.MRRNO=GH.AUTO_KEY_MRR" & vbCrLf & " AND GH.REF_TYPE IN ('P') AND IH.PURCHASESEQTYPE=3" & vbCrLf & " AND ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND GH.MRR_DATE<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')"
                SqlStr = SqlStr & vbCrLf & " )" & vbCrLf & " ORDER BY MRR_DATE DESC, TO_NUMBER(SUBSTR(AUTO_KEY_MRR,LENGTH(AUTO_KEY_MRR)-5,4)) DESC,TO_NUMBER(SUBSTR(AUTO_KEY_MRR,1,LENGTH(AUTO_KEY_MRR)-6)) DESC"

                'SqlStr = SqlStr & vbCrLf & " ORDER BY GH.MRR_DATE DESC, TO_NUMBER(SUBSTR(GH.AUTO_KEY_MRR,LENGTH(GH.AUTO_KEY_MRR)-5,4)) DESC,TO_NUMBER(SUBSTR(GH.AUTO_KEY_MRR,1,LENGTH(GH.AUTO_KEY_MRR)-6)) DESC"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mRunningBal = pTotClosing
                    Do While Not RsTemp.EOF
                        mApprovedQty = IIf(IsDBNull(RsTemp.Fields("APPROVED_QTY").Value), 0, RsTemp.Fields("APPROVED_QTY").Value)
                        'mMkey = IIf(IsNull(RsTemp!mKey), "-1", RsTemp!mKey)
                        If mApprovedQty <= 0 Then GoTo NextRec
                        pRefDate = IIf(IsDBNull(RsTemp.Fields("MRR_DATE").Value), "", RsTemp.Fields("MRR_DATE").Value)
                        xPurchaseCost = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value), "0.0000")) ''GetPurchasePORate(mMkey, pRefDate, mMainItemCode)''GetPurchasePORate(mMkey, pAsOnDate, mMainItemCode)
                        If xPurchaseCost = 0 Then GoTo NextRec ''xPurchaseCost = IIf(IsNull(RsTemp!ITEM_RATE), 0, RsTemp!ITEM_RATE)
                        If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                            mApprovedQty = mApprovedQty * mFactor
                            xPurchaseCost = xPurchaseCost / mFactor
                        End If
                        If mRunningBal <= mApprovedQty Then
                            mCalcQty = mRunningBal
                            mRunningBal = 0
                        ElseIf mRunningBal > mApprovedQty Then
                            mCalcQty = mApprovedQty
                            mRunningBal = mRunningBal - mApprovedQty
                        End If
                        If pCostType = "P" Then
                            mQtyValue = (mCalcQty * xPurchaseCost)
                        ElseIf pCostType = "L" Then
                            xLandedCost = xPurchaseCost
                            'xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("EDAMOUNT").Value), 0, RsTemp.Fields("EDAMOUNT").Value / mFactor), "0.0000"))
                            'xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("STAMOUNT").Value), 0, RsTemp.Fields("STAMOUNT").Value / mFactor), "0.0000"))
                            'xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("OTHERS").Value), 0, RsTemp.Fields("OTHERS").Value / mFactor), "0.0000"))
                            mQtyValue = (mCalcQty * CDbl(VB6.Format(xLandedCost, "0.0000")))
                        End If
                        GetLatestItemCostFromMRR = GetLatestItemCostFromMRR + mQtyValue
                        If mRunningBal = 0 Then
                            Exit Do
                        End If
NextRec:
                        RsTemp.MoveNext()
                        If RsTemp.EOF = True Then
                            If mRunningBal > 0 Then
                                If pCostType = "P" Then
                                    mQtyValue = (mRunningBal * xPurchaseCost)
                                Else
                                    mQtyValue = (mRunningBal * xLandedCost)
                                End If
                                GetLatestItemCostFromMRR = GetLatestItemCostFromMRR + mQtyValue
                            End If
                        End If
                    Loop
                Else
                    If GetLatestItemCostFromPO(mMainItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
                    If pCostType = "P" Then
                        If xPurchaseCost = 0 Then
                            mQtyValue = (pTotClosing * mItemPurchaseCost)
                        Else
                            mQtyValue = (pTotClosing * xPurchaseCost)
                        End If
                    ElseIf pCostType = "L" Then
                        If xLandedCost = 0 Then
                            mQtyValue = (pTotClosing * mItemPurchaseCost)
                        Else
                            mQtyValue = (pTotClosing * CDbl(VB6.Format(xLandedCost, "0.0000")))
                        End If
                    End If
                    GetLatestItemCostFromMRR = mQtyValue
                End If
            End If
        End If
        GetLatestItemCostFromMRR = IIf(GetLatestItemCostFromMRR = 0, mItemPurchaseCost * pTotClosing, GetLatestItemCostFromMRR)
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckItemBom(ByRef pItemCode As String, Optional ByRef pCheckon As String = "") As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckItemBom = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT PRODUCT_CODE " & vbCrLf _
            & " FROM PRD_NEWBOM_HDR" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND STATUS='O' AND IS_BOP='N' AND IS_APPROVED='Y'"

        If pCheckon <> "B" Then
            mSqlStr = mSqlStr & vbCrLf & "UNION"
            mSqlStr = mSqlStr & vbCrLf & " SELECT PRODUCT_CODE " & vbCrLf _
                & " FROM PRD_OUTBOM_HDR" & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
                & " AND STATUS='O' AND IS_BOP='N'"

            'mSqlStr = mSqlStr & vbCrLf & "UNION"
            '
            'mSqlStr = mSqlStr & vbCrLf _
            ''& " SELECT ITEM_CODE " & vbCrLf _
            ''& " FROM INV_ITEM_RELATIONSHIP_DET" & vbCrLf _
            ''& " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            ''& " AND REF_ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        End If
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckItemBom = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetMainItemCode(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = " Select ITEM_CODE FROM INV_ITEM_RELATIONSHIP_DET " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " And REF_ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetMainItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), pItemCode, RsTemp.Fields("ITEM_CODE").Value))
        Else
            GetMainItemCode = Trim(pItemCode)
        End If
        Exit Function
ErrPart:
        GetMainItemCode = Trim(pItemCode)
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetStockType(ByRef pPvtDBCn As ADODB.Connection, ByRef pItemCode As String, ByRef pDivCode As Long) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetStockType = ""
        SqlStr = " Select STOCKTYPE " & vbCrLf _
            & " FROM INV_ITEM_MST INVMST, INV_GENERAL_MST GMST" & vbCrLf _
            & " WHERE INVMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " And ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND INVMST.COMPANY_CODE=GMST.COMPANY_CODE " & vbCrLf _
            & " AND INVMST.CATEGORY_CODE=GMST.GEN_CODE " & vbCrLf _
            & " AND GMST.GEN_TYPE='C'"

        MainClass.UOpenRecordSet(SqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                GetStockType = IIf(IsDBNull(RsTemp.Fields("STOCKTYPE").Value), "", RsTemp.Fields("STOCKTYPE").Value)
                If RsCompany.Fields("IS_WAREHOUSE").Value = "Y" Then
                    If GetStockType = "FG" Then
                        GetStockType = "ST"
                    End If
                Else
                    If GetStockType = "FG" And pDivCode = 3 Then
                        GetStockType = "ST"
                    End If
                End If

            End If
        End With
        Exit Function
ErrPart:
        GetStockType = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetSummarisedMaterialCost(ByRef pItemCode As String, ByRef pStockType As String, ByRef pAsOnDate As String, ByRef pCostType As String, ByRef xClosingBal As Double, ByRef pItemUOM As String, ByRef mDivisionCode As Double) As Double
        On Error GoTo ErrPart
        Dim pSqlStr As String = ""
        Dim RsTempSeq As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim RsBOM As ADODB.Recordset = Nothing
        Dim mBOMDeptCode As String = ""
        Dim mRMCode As String = ""
        Dim xItemUOM As String = ""
        Dim mDeptSeq As Integer
        Dim mStdQty As Double
        Dim mProdDeptSeq As Integer
        Dim mProdCost As Double
        Dim mOPRCode As String = ""
        Dim mOprSeq As Integer
        Dim mOutJob As String = ""
        Dim mRMType As String
        Dim pCLBal As Double
        Dim pStockDeptCode As String
        Dim xItemClosingBal As Double
        Dim xPendingClosingBal As Double
        GetSummarisedMaterialCost = 0
        xPendingClosingBal = xClosingBal
        pSqlStr = "Select SERIAL_NO, DEPT_CODE " & vbCrLf & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND " & vbCrLf & " WEF <=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))" & vbCrLf & " ORDER BY SERIAL_NO"
        MainClass.UOpenRecordSet(pSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempSeq, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTempSeq.EOF = False Then
            Do While RsTempSeq.EOF = False
                mProdDeptSeq = IIf(IsDBNull(RsTempSeq.Fields("SERIAL_NO").Value), 0, RsTempSeq.Fields("SERIAL_NO").Value)
                pStockDeptCode = IIf(IsDBNull(RsTempSeq.Fields("DEPT_CODE").Value), "", RsTempSeq.Fields("DEPT_CODE").Value)
                xItemClosingBal = GetBalanceStockQty(pItemCode, pAsOnDate, pItemUOM, pStockDeptCode, pStockType, "", ConPH, mDivisionCode)
                If xItemClosingBal < 0 Then xItemClosingBal = 0
                If xItemClosingBal > xPendingClosingBal Then
                    xItemClosingBal = xPendingClosingBal
                End If
PendingClBal:
                xPendingClosingBal = xPendingClosingBal - xItemClosingBal
                If xItemClosingBal <> 0 Then
                    'mProdDeptSeq = GetProductSeqNo(pItemCode, pStockDeptCode, pAsOnDate)
                    If pStockType = "WP" Then
                        mProdDeptSeq = mProdDeptSeq - 1
                        pStockType = "ST"
                    End If
                    SqlStr = "SELECT ID.RM_CODE, ID.DEPT_CODE, OPR_CODE,(STD_QTY + GROSS_WT_SCRAP)/OUTPUT_QTY STD_QTY , 'B' BOM_TYPE" & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
                    ''SqlStr = SqlStr & vbCrLf & " AND ID.RM_CODE NOT LIKE 'P%'"
                    SqlStr = SqlStr & vbCrLf & " AND ID.RM_CODE IN (" & vbCrLf & " SELECT ITEM_CODE FROM INV_ITEM_MST A, INV_GENERAL_MST B" & vbCrLf & " WHERE A.COMPANY_CODE='" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf & " AND A.CATEGORY_CODE=B.GEN_CODE" & vbCrLf & " AND B.PRD_TYPE IN ('R','B','I','D','P','2','3')" & vbCrLf & " AND A.COMPANY_CODE=ID.COMPANY_CODE " & vbCrLf & " AND A.ITEM_CODE=ID.RM_CODE )"
                    MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBOM, ADODB.LockTypeEnum.adLockReadOnly)
                    If RsBOM.EOF = True Then
                        SqlStr = "SELECT ID.ITEM_CODE AS RM_CODE, 'STR' AS DEPT_CODE, -1 AS OPR_CODE,(ITEM_QTY + SCRAP_QTY) STD_QTY, 'J' BOM_TYPE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_OUTBOM_HDR" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
                        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBOM, ADODB.LockTypeEnum.adLockReadOnly)
                    End If
                    If RsBOM.EOF = False Then
                        Do While RsBOM.EOF = False
                            mBOMDeptCode = IIf(IsDBNull(RsBOM.Fields("DEPT_CODE").Value), "", RsBOM.Fields("DEPT_CODE").Value)
                            mStdQty = IIf(IsDBNull(RsBOM.Fields("STD_QTY").Value), 0, RsBOM.Fields("STD_QTY").Value)
                            mDeptSeq = GetProductSeqNo(pItemCode, mBOMDeptCode, pAsOnDate)
                            mRMCode = Trim(IIf(IsDBNull(RsBOM.Fields("RM_CODE").Value), "", RsBOM.Fields("RM_CODE").Value))
                            mRMType = GetProductionType(mRMCode)
                            If mRMType = "R" Or mRMType = "I" Or mRMType = "B" Or mRMType = "P" Or mRMType = "3" Or mRMType = "D" Then
                                mOPRCode = Trim(IIf(IsDBNull(RsBOM.Fields("OPR_CODE").Value), "", RsBOM.Fields("OPR_CODE").Value))
                            Else
                                GoTo NextRec ''For Paint..
                            End If
                            mOprSeq = GetOperationSeq(pItemCode, mBOMDeptCode, mOPRCode, pAsOnDate)
                            If MainClass.ValidateWithMasterTable(mRMCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                                xItemUOM = MasterNo
                            End If
                            mOutJob = Trim(IIf(IsDBNull(RsBOM.Fields("BOM_TYPE").Value), "B", RsBOM.Fields("BOM_TYPE").Value))
                            If mOutJob = "B" Then
                                If xItemUOM = "KGS" Then
                                    mStdQty = mStdQty / 1000
                                ElseIf xItemUOM = "TON" Then
                                    mStdQty = mStdQty / 1000
                                    mStdQty = mStdQty / 1000
                                ElseIf xItemUOM = "MT" Then
                                    mStdQty = mStdQty / 1000
                                    mStdQty = mStdQty / 1000
                                End If
                            End If
                            pCLBal = xItemClosingBal * mStdQty
                            pCLBal = IIf(pCLBal <= 0, 1, pCLBal)
                            mProdCost = 0
                            If mDeptSeq = mProdDeptSeq Then
                                If pStockType <> "WP" Then
                                    If Val(pStockType) > 0 Then
                                        If Val(CStr(mOprSeq)) <= Val(pStockType) Then
                                            mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", mBOMDeptCode) ''mBOMDeptCode
                                            'mProdCost = mProdCost / pCLBal
                                        End If
                                    Else
                                        mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", mBOMDeptCode) ''mBOMDeptCode
                                        'mProdCost = mProdCost / pCLBal
                                    End If
                                End If
                            ElseIf mDeptSeq < mProdDeptSeq Then
                                mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", mBOMDeptCode) ''mBOMDeptCode
                                'mProdCost = mProdCost / pCLBal
                            ElseIf mProdDeptSeq = 0 Then
                                mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", mBOMDeptCode) ''mBOMDeptCode
                                'mProdCost = mProdCost / pCLBal
                            End If
                            GetSummarisedMaterialCost = GetSummarisedMaterialCost + mProdCost
                            'mProdCost = mProdCost / pCLBal
                            'GetSummarisedMaterialCost = GetSummarisedMaterialCost + (mProdCost * mStdQty)
NextRec:
                            RsBOM.MoveNext()
                        Loop
                    End If
                End If
                If xPendingClosingBal = 0 Then
                    Exit Do
                End If
                RsTempSeq.MoveNext()
            Loop
        End If
        If xPendingClosingBal > 0 Then
            xItemClosingBal = xPendingClosingBal
            mProdDeptSeq = 0
            pStockDeptCode = "STR"
            GoTo PendingClBal
        End If
        If xClosingBal = 0 Then
            'GetSummarisedMaterialCost = GetSummarisedMaterialCost / xClosingBal
        Else
            GetSummarisedMaterialCost = GetSummarisedMaterialCost / xClosingBal
        End If
        Exit Function
ErrPart:
        'Resume
        GetSummarisedMaterialCost = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetMaterialCost(ByRef pItemCode As String, ByRef pStockType As String, ByRef pStockDeptCode As String, ByRef pAsOnDate As String, ByRef pCostType As String, ByRef xClosingBal As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBOM As ADODB.Recordset = Nothing
        Dim mBOMDeptCode As String
        Dim mRMCode As String
        Dim xItemUOM As String = ""
        Dim mDeptSeq As Integer
        Dim mStdQty As Double
        Dim mProdDeptSeq As Integer
        Dim mProdCost As Double
        Dim mOPRCode As String
        Dim mOprSeq As Integer
        Dim mOutJob As String
        Dim mRMType As String
        Dim pCLBal As Double
        GetMaterialCost = 0
        mProdDeptSeq = GetProductSeqNo(pItemCode, pStockDeptCode, pAsOnDate)
        If pStockType = "WP" Then
            mProdDeptSeq = mProdDeptSeq - 1
            pStockType = "ST"
        End If
        SqlStr = "Select ID.RM_CODE, ID.DEPT_CODE, OPR_CODE,(STD_QTY + GROSS_WT_SCRAP)/OUTPUT_QTY STD_QTY , 'B' BOM_TYPE" & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        ''SqlStr = SqlStr & vbCrLf & " AND ID.RM_CODE NOT LIKE 'P%'"
        SqlStr = SqlStr & vbCrLf & " AND ID.RM_CODE IN (" & vbCrLf & " SELECT ITEM_CODE FROM INV_ITEM_MST A, INV_GENERAL_MST B" & vbCrLf & " WHERE A.COMPANY_CODE='" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf & " AND A.CATEGORY_CODE=B.GEN_CODE" & vbCrLf & " AND B.PRD_TYPE IN ('R','B','I','D','P','2','3')" & vbCrLf & " AND A.COMPANY_CODE=ID.COMPANY_CODE " & vbCrLf & " AND A.ITEM_CODE=ID.RM_CODE )"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBOM, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBOM.EOF = True Then
            SqlStr = "SELECT ID.ITEM_CODE AS RM_CODE, 'STR' AS DEPT_CODE, -1 AS OPR_CODE,(ITEM_QTY + SCRAP_QTY) STD_QTY, 'J' BOM_TYPE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_OUTBOM_HDR" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBOM, ADODB.LockTypeEnum.adLockReadOnly)
        End If
        If RsBOM.EOF = False Then
            Do While RsBOM.EOF = False
                mBOMDeptCode = IIf(IsDBNull(RsBOM.Fields("DEPT_CODE").Value), "", RsBOM.Fields("DEPT_CODE").Value)
                mStdQty = IIf(IsDBNull(RsBOM.Fields("STD_QTY").Value), 0, RsBOM.Fields("STD_QTY").Value)
                mDeptSeq = GetProductSeqNo(pItemCode, mBOMDeptCode, pAsOnDate)
                mRMCode = Trim(IIf(IsDBNull(RsBOM.Fields("RM_CODE").Value), "", RsBOM.Fields("RM_CODE").Value))
                mRMType = GetProductionType(mRMCode)
                If mRMType = "R" Or mRMType = "I" Or mRMType = "B" Or mRMType = "P" Or mRMType = "3" Or mRMType = "D" Then
                    mOPRCode = Trim(IIf(IsDBNull(RsBOM.Fields("OPR_CODE").Value), "", RsBOM.Fields("OPR_CODE").Value))
                Else
                    GoTo NextRec ''For Paint..
                End If
                mOprSeq = GetOperationSeq(pItemCode, mBOMDeptCode, mOPRCode, pAsOnDate)
                If MainClass.ValidateWithMasterTable(mRMCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    xItemUOM = MasterNo
                End If
                mOutJob = Trim(IIf(IsDBNull(RsBOM.Fields("BOM_TYPE").Value), "B", RsBOM.Fields("BOM_TYPE").Value))
                If mOutJob = "B" Then
                    If xItemUOM = "KGS" Then
                        mStdQty = mStdQty / 1000
                    ElseIf xItemUOM = "TON" Then
                        mStdQty = mStdQty / 1000
                        mStdQty = mStdQty / 1000
                    ElseIf xItemUOM = "MT" Then
                        mStdQty = mStdQty / 1000
                        mStdQty = mStdQty / 1000
                    End If
                End If
                pCLBal = xClosingBal * mStdQty
                pCLBal = IIf(pCLBal <= 0, 1, pCLBal)
                mProdCost = 0
                If mDeptSeq = mProdDeptSeq Then
                    If pStockType <> "WP" Then
                        If Val(pStockType) > 0 Then
                            If Val(CStr(mOprSeq)) <= Val(pStockType) Then
                                mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", pStockDeptCode) ''mBOMDeptCode
                            End If
                        Else
                            mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", pStockDeptCode) ''mBOMDeptCode
                        End If
                    End If
                ElseIf mDeptSeq < mProdDeptSeq Then
                    mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", pStockDeptCode) ''mBOMDeptCode
                ElseIf mProdDeptSeq = 0 Then
                    mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, pCLBal, pAsOnDate, pCostType, "", pStockDeptCode) ''mBOMDeptCode
                End If
                mProdCost = mProdCost / pCLBal
                GetMaterialCost = GetMaterialCost + (mProdCost * mStdQty)
NextRec:
                RsBOM.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        'Resume
        GetMaterialCost = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetLatestItemCostFromPO(ByRef pItemCode As String, ByRef pPurchaseCost As Double, ByRef pLandedCost As Double, ByRef xRefDate As String, ByRef mStockType As String, ByRef mPartyCode As String, ByRef xItemUOM As String, ByRef pFactor As Double, Optional ByRef mOnlyJWRate As Boolean = False, Optional ByRef mPONo As Double = 0) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RSTempExp As ADODB.Recordset = Nothing
        Dim mKey As String = ""
        Dim mNetAccessAmt As Double
        Dim mPurchaseUOM As String = ""
        Dim mExpAddDeduct As String = ""
        Dim mExpCode As Double
        Dim xStr As String = ""
        Dim mExpPercent As Double
        Dim mISExciseable As String = ""
        Dim mIsTaxable As String = ""
        Dim mDOB As Double
        Dim mTotDiscount As Double
        Dim mRoType As String = ""
        Dim mExciseableAmount As Double
        Dim mTaxableAmount As Double
        Dim mExp As Double
        Dim xEDAmount As Double
        Dim mTotEDAmount As Double
        Dim mSTAmount As Double
        Dim mTotSTAmount As Double
        Dim mSURAmount As Double
        Dim mTotSURAmount As Double
        Dim mTableName As String = ""
        Dim mItemIssueUOM As String = ""
        Dim mItemFactor As Double
        Dim mRMCost As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim mISMODVAT As String = ""
        Dim mISSTREFUND As String = ""
        Dim mIsCapital As String = ""



        If CDate(xRefDate) >= CDate(PubGSTApplicableDate) Then
            If GetLatestItemCostFromPOGST(pItemCode, pPurchaseCost, pLandedCost, VB6.Format(xRefDate, "dd/MM/yyyy"), mStockType, mPartyCode, xItemUOM, pFactor, mOnlyJWRate, mPONo) = False Then GoTo ErrPart
            GetLatestItemCostFromPO = True
            Exit Function
        End If



        SqlStr = " Select IH.MKEY, (NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,2)) PURCHASE_COST, EXCHANGERATE," & vbCrLf & " 0 LANDED_COST,ITEM_UOM,IH.PUR_TYPE,ISMODVATABLE,ISSTREFUNDABLE,ISCAPITAL" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID " & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And IH.MKEY=ID.MKEY And IH.PO_STATUS='Y' AND IH.PUR_TYPE IN ('P','J')"
        If mPartyCode <> "" And mPartyCode <> "-1" Then
            SqlStr = SqlStr & vbCrLf & " AND IH.SUPP_CUST_CODE='" & mPartyCode & "'"
        End If
        If mPONo > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND IH.AUTO_KEY_PO=" & Val(CStr(mPONo)) & ""
        End If
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND ID.MKEY = ( " & vbCrLf & " SELECT MAX(SIH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR SIH, PUR_PURCHASE_DET SID" & vbCrLf & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SIH.MKEY=SID.MKEY AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE IN ('P')"
        If mPartyCode <> "" And mPartyCode <> "-1" Then
            SqlStr = SqlStr & vbCrLf & " AND SIH.SUPP_CUST_CODE='" & mPartyCode & "'"
        End If
        If mPONo > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND SIH.AUTO_KEY_PO=" & Val(CStr(mPONo)) & ""
        Else
            SqlStr = SqlStr & vbCrLf & " AND SIH.AUTO_KEY_PO= ( " & vbCrLf & " SELECT MAX(GD.REF_AUTO_KEY_NO) " & vbCrLf & " FROM INV_GATE_HDR GH, INV_GATE_DET GD" & vbCrLf & " WHERE GH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND GH.AUTO_KEY_MRR=GD.AUTO_KEY_MRR" & vbCrLf & " AND GD.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND GH.REF_TYPE='P'"
            If mPartyCode <> "" And mPartyCode <> "-1" Then
                SqlStr = SqlStr & vbCrLf & " AND GH.SUPP_CUST_CODE='" & mPartyCode & "'"
            End If
            SqlStr = SqlStr & vbCrLf & " AND GH.MRR_DATE = (" & vbCrLf & " SELECT MAX(A.MRR_DATE) " & vbCrLf & " FROM INV_GATE_HDR A, INV_GATE_DET B" & vbCrLf & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND A.AUTO_KEY_MRR=B.AUTO_KEY_MRR" & vbCrLf & " AND B.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND A.REF_TYPE='P'"
            If mPartyCode <> "" And mPartyCode <> "-1" Then
                SqlStr = SqlStr & vbCrLf & " AND A.SUPP_CUST_CODE='" & mPartyCode & "'"
            End If
            SqlStr = SqlStr & vbCrLf & " AND A.MRR_DATE<=TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))" & vbCrLf & " )"
        End If
        SqlStr = SqlStr & vbCrLf & " AND SID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SID.PO_WEF_DATE <= TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY IH.PO_CLOSED, ID.PO_WEF_DATE DESC"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "-1", RsTemp.Fields("mKey").Value)
            xPurchaseCost = IIf(IsDBNull(RsTemp.Fields("PURCHASE_COST").Value), 0, RsTemp.Fields("PURCHASE_COST").Value) * IIf(IsDBNull(RsTemp.Fields("EXCHANGERATE").Value), 1, RsTemp.Fields("EXCHANGERATE").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), 0, RsTemp.Fields("ITEM_UOM").Value)
            mISMODVAT = IIf(IsDBNull(RsTemp.Fields("ISMODVATABLE").Value), "N", RsTemp.Fields("ISMODVATABLE").Value)
            mISSTREFUND = IIf(IsDBNull(RsTemp.Fields("ISSTREFUNDABLE").Value), "N", RsTemp.Fields("ISSTREFUNDABLE").Value)
            mIsCapital = IIf(IsDBNull(RsTemp.Fields("IsCapital").Value), "N", RsTemp.Fields("IsCapital").Value)
            If RsTemp.Fields("PUR_TYPE").Value = "J" Then
                If mOnlyJWRate = False Then
                    mRMCost = GetTotalJWRMCost(pItemCode, xRefDate, mPurchaseUOM, pFactor)
                End If
                xPurchaseCost = xPurchaseCost + mRMCost
                xLandedCost = xPurchaseCost
            Else
                If mKey = "-1" Then
                    xLandedCost = xPurchaseCost
                Else
                    mNetAccessAmt = xPurchaseCost
                    SqlStr = " SELECT ADD_DED,EXPCODE,Identification,EXPPERCENT,EXCISEABLE,TAXABLE,ROUNDOFF " & vbCrLf _
                        & " FROM PUR_PURCHASE_EXP IH, FIN_INTERFACE_MST ID " & vbCrLf _
                        & " WHERE " & vbCrLf _
                        & " IH.EXPCODE=ID.CODE " & vbCrLf _
                        & " AND ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                        & " AND IH.MKEY='" & mKey & "' "

                    If PubGSTApplicable = True Then
                        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
                    Else
                        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
                    End If

                    SqlStr = SqlStr & vbCrLf & " ORDER BY PRINTSEQUENCE "
                    MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RSTempExp, ADODB.LockTypeEnum.adLockReadOnly)
                    If RSTempExp.EOF = False Then
                        Do While RSTempExp.EOF = False
                            mExpAddDeduct = IIf(IsDBNull(RSTempExp.Fields("ADD_DED").Value), "A", RSTempExp.Fields("ADD_DED").Value)
                            mExpCode = IIf(IsDBNull(RSTempExp.Fields("EXPCODE").Value), "", RSTempExp.Fields("EXPCODE").Value)
                            xStr = IIf(IsDBNull(RSTempExp.Fields("Identification").Value), "", RSTempExp.Fields("Identification").Value)
                            mExpPercent = IIf(IsDBNull(RSTempExp.Fields("EXPPERCENT").Value), 0, RSTempExp.Fields("EXPPERCENT").Value)
                            mISExciseable = IIf(IsDBNull(RSTempExp.Fields("EXCISEABLE").Value), "N", RSTempExp.Fields("EXCISEABLE").Value)
                            mIsTaxable = IIf(IsDBNull(RSTempExp.Fields("TAXABLE").Value), "N", RSTempExp.Fields("TAXABLE").Value)
                            mRoType = IIf(IsDBNull(RSTempExp.Fields("ROUNDOFF").Value), "N", RSTempExp.Fields("ROUNDOFF").Value)
                            Select Case xStr
                                Case "ED", "EDU", "SHC", "ADE"
                                    If mISMODVAT = "N" Then
                                        If mExpPercent <> 0 Then
                                            xEDAmount = CDbl(VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00"))
                                            If mRoType = "Y" Then
                                                xEDAmount = System.Math.Round(xEDAmount, 0)
                                            End If
                                        End If
                                        If mIsTaxable = "Y" Then
                                            mTaxableAmount = Val(CStr(mTaxableAmount)) + xEDAmount
                                        End If
                                        mTotEDAmount = mTotEDAmount + xEDAmount
                                        mExp = mExp + xEDAmount
                                    End If
                                Case "ST", "SUR"
                                    If mISSTREFUND = "N" Then
                                        If mExpPercent <> 0 Then
                                            mSTAmount = CDbl(VB6.Format(mTaxableAmount * mExpPercent / 100, "0.00"))
                                            If mRoType = "Y" Then
                                                mSTAmount = System.Math.Round(mSTAmount, 0)
                                            End If
                                        End If
                                        mTotSTAmount = Val(CStr(mTotSTAmount)) + Val(CStr(mSTAmount))
                                        mExp = mExp + mSTAmount
                                    End If
                                    'Case "SUR"
                                    ' If mExpPercent <> 0 Then
                                    'mSURAmount = VB6.Format(mSTAmount * mExpPercent / 100, "0.00")
                                    'If mRoType = "Y" Then
                                    'mSURAmount = Round(Val(mSURAmount), 0)
                                    'End If
                                    'End If
                                    'mTotSURAmount = mTotSURAmount + Val(mSURAmount)
                                    'mExp = mExp + mSURAmount
                            End Select
                            RSTempExp.MoveNext()
                        Loop
                    End If
                    xLandedCost = xPurchaseCost + mExp
                End If
            End If
            If xItemUOM <> mPurchaseUOM Then
                xPurchaseCost = xPurchaseCost / pFactor
                xLandedCost = xLandedCost / pFactor
            End If
        Else
            mRMCost = GetTotalSFCost(pItemCode, xRefDate, mPurchaseUOM, pFactor)
            If mRMCost <> 0 Then
                xPurchaseCost = xPurchaseCost + mRMCost
                xLandedCost = xPurchaseCost
            Else

                SqlStr = "SELECT A.PURCHASE_COST, A.PURCHASE_UOM, A.ISSUE_UOM, A.UOM_FACTOR, B.RATE " & vbCrLf _
                    & " FROM INV_ITEM_MST A, INV_ITEM_RATE_MST B " & vbCrLf _
                    & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                    & " AND A.ITEM_CODE=B.ITEM_CODE" & vbCrLf _
                    & " AND A.ITEM_CODE='" & Trim(pItemCode) & "'"


                ''SqlStr = "SELECT PURCHASE_COST, PURCHASE_UOM, ISSUE_UOM,UOM_FACTOR " & vbCrLf & " FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & Trim(pItemCode) & "'"

                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    xPurchaseCost = IIf(IsDBNull(RsTemp.Fields("RATE").Value), 0, RsTemp.Fields("RATE").Value)
                    mItemIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), 0, RsTemp.Fields("ISSUE_UOM").Value)
                    mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                    xLandedCost = IIf(IsDBNull(RsTemp.Fields("RATE").Value), 0, RsTemp.Fields("RATE").Value)
                    mItemFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value), 0, RsTemp.Fields("UOM_FACTOR").Value)
                    If mItemIssueUOM <> mPurchaseUOM Then
                        xPurchaseCost = xPurchaseCost / mItemFactor
                        xLandedCost = xLandedCost / mItemFactor
                    End If
                End If
            End If
        End If
        pPurchaseCost = xPurchaseCost
        pLandedCost = xLandedCost
        GetLatestItemCostFromPO = True
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetLatestItemCostFromPO = False
    End Function
    Public Function GetLatestItemCostFromPOGST(ByRef pItemCode As String, ByRef pPurchaseCost As Double, ByRef pLandedCost As Double, ByRef xRefDate As String, ByRef mStockType As String, ByRef mPartyCode As String, ByRef xItemUOM As String, ByRef pFactor As Double, Optional ByRef mOnlyJWRate As Boolean = False, Optional ByRef mPONo As Double = 0) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RSTempExp As ADODB.Recordset
        Dim mKey As String = ""
        Dim mNetAccessAmt As Double
        Dim mPurchaseUOM As String = ""
        Dim mExpAddDeduct As String = ""
        Dim mExpCode As Double
        Dim xStr As String = ""
        Dim mExpPercent As Double
        Dim mRoType As String = ""
        Dim mExp As Double
        Dim mTableName As String = ""
        Dim mItemIssueUOM As String = ""
        Dim mItemFactor As Double
        Dim mRMCost As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim mIsGSTRefund As String = ""
        Dim mFreightCost As Double

        SqlStr = " Select IH.MKEY, (NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,2)) PURCHASE_COST, EXCHANGERATE," & vbCrLf & " ISGSTAPPLICABLE,ITEM_UOM,FREIGHT_COST,IH.PUR_TYPE, CGST_PER, SGST_PER, IGST_PER " & vbCrLf _
            & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID " & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And IH.MKEY=ID.MKEY And IH.PO_STATUS='Y' AND IH.PUR_TYPE IN ('P')"
        If mPartyCode <> "" And mPartyCode <> "-1" Then
            SqlStr = SqlStr & vbCrLf & " AND IH.SUPP_CUST_CODE='" & mPartyCode & "'"
        End If
        If mPONo > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND IH.AUTO_KEY_PO=" & Val(CStr(mPONo)) & ""
        End If
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND ID.MKEY = ( " & vbCrLf & " SELECT MAX(SIH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR SIH, PUR_PURCHASE_DET SID" & vbCrLf & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SIH.MKEY=SID.MKEY AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE IN ('P')"
        If mPartyCode <> "" And mPartyCode <> "-1" Then
            SqlStr = SqlStr & vbCrLf & " AND SIH.SUPP_CUST_CODE='" & mPartyCode & "'"
        End If
        If mPONo > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND SIH.AUTO_KEY_PO=" & Val(CStr(mPONo)) & ""
        Else
            SqlStr = SqlStr & vbCrLf & " AND SIH.AUTO_KEY_PO= ( " & vbCrLf & " SELECT MAX(GD.REF_AUTO_KEY_NO) " & vbCrLf & " FROM INV_GATE_HDR GH, INV_GATE_DET GD" & vbCrLf & " WHERE GH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND GH.AUTO_KEY_MRR=GD.AUTO_KEY_MRR" & vbCrLf & " AND GD.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND GH.REF_TYPE='P'"
            If mPartyCode <> "" And mPartyCode <> "-1" Then
                SqlStr = SqlStr & vbCrLf & " AND GH.SUPP_CUST_CODE='" & mPartyCode & "'"
            End If
            SqlStr = SqlStr & vbCrLf & " AND GH.MRR_DATE = (" & vbCrLf & " SELECT MAX(A.MRR_DATE) " & vbCrLf & " FROM INV_GATE_HDR A, INV_GATE_DET B" & vbCrLf & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND A.AUTO_KEY_MRR=B.AUTO_KEY_MRR" & vbCrLf & " AND B.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND A.REF_TYPE='P'"
            If mPartyCode <> "" And mPartyCode <> "-1" Then
                SqlStr = SqlStr & vbCrLf & " AND A.SUPP_CUST_CODE='" & mPartyCode & "'"
            End If
            SqlStr = SqlStr & vbCrLf & " AND A.MRR_DATE<=TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))" & vbCrLf & " )"
        End If
        SqlStr = SqlStr & vbCrLf & " AND SID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SID.PO_WEF_DATE <= TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY IH.PO_CLOSED, ID.PO_WEF_DATE DESC"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "-1", RsTemp.Fields("mKey").Value)
            xPurchaseCost = IIf(IsDBNull(RsTemp.Fields("PURCHASE_COST").Value), 0, RsTemp.Fields("PURCHASE_COST").Value) * IIf(IsDBNull(RsTemp.Fields("EXCHANGERATE").Value), 1, RsTemp.Fields("EXCHANGERATE").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), 0, RsTemp.Fields("ITEM_UOM").Value)
            mIsGSTRefund = IIf(IsDBNull(RsTemp.Fields("ISGSTAPPLICABLE").Value), "N", RsTemp.Fields("ISGSTAPPLICABLE").Value)
            mExpPercent = IIf(IsDBNull(RsTemp.Fields("CGST_PER").Value), 0, RsTemp.Fields("CGST_PER").Value) + IIf(IsDBNull(RsTemp.Fields("SGST_PER").Value), 0, RsTemp.Fields("SGST_PER").Value) + IIf(IsDBNull(RsTemp.Fields("IGST_PER").Value), 0, RsTemp.Fields("IGST_PER").Value)
            mFreightCost = IIf(IsDBNull(RsTemp.Fields("FREIGHT_COST").Value), 0, RsTemp.Fields("FREIGHT_COST").Value)
            xLandedCost = xPurchaseCost
            mExp = 0
            If mIsGSTRefund = "N" Then
                mExp = xLandedCost * mExpPercent * 0.01
            End If
            mExp = mExp + mFreightCost
            xLandedCost = xLandedCost + mExp
            If xItemUOM <> mPurchaseUOM Then
                If MainClass.ValidateWithMasterTable(pItemCode, "ITEM_CODE", "UOM_FACTOR", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    pFactor = MasterNo
                Else
                    pFactor = 1
                End If
                xPurchaseCost = xPurchaseCost / pFactor
                xLandedCost = xLandedCost / pFactor
            End If
        Else
            mRMCost = GetTotalSFCost(pItemCode, xRefDate, mPurchaseUOM, pFactor)
            If mRMCost <> 0 Then
                xPurchaseCost = xPurchaseCost + mRMCost
                xLandedCost = xPurchaseCost
            Else

                SqlStr = "SELECT A.PURCHASE_COST, A.PURCHASE_UOM, A.ISSUE_UOM, A.UOM_FACTOR, B.RATE " & vbCrLf _
                        & " FROM INV_ITEM_MST A, INV_ITEM_RATE_MST B " & vbCrLf _
                        & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                        & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                        & " AND A.ITEM_CODE=B.ITEM_CODE" & vbCrLf _
                        & " AND A.ITEM_CODE='" & Trim(pItemCode) & "'"

                'SqlStr = "SELECT PURCHASE_COST, PURCHASE_UOM, ISSUE_UOM,UOM_FACTOR " & vbCrLf & " FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & Trim(pItemCode) & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    xPurchaseCost = IIf(IsDBNull(RsTemp.Fields("RATE").Value), 0, RsTemp.Fields("RATE").Value)
                    mItemIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), 0, RsTemp.Fields("ISSUE_UOM").Value)
                    mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                    xLandedCost = IIf(IsDBNull(RsTemp.Fields("RATE").Value), 0, RsTemp.Fields("RATE").Value)
                    mItemFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value), 0, RsTemp.Fields("UOM_FACTOR").Value)
                    If mItemIssueUOM <> mPurchaseUOM Then
                        xPurchaseCost = xPurchaseCost / mItemFactor
                        xLandedCost = xLandedCost / mItemFactor
                    End If
                End If
            End If
        End If
        pPurchaseCost = xPurchaseCost
        pLandedCost = xLandedCost
        GetLatestItemCostFromPOGST = True
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetLatestItemCostFromPOGST = False
    End Function
    Public Function ValidateBranchLocking(ByVal LockDate As String) As Boolean
        On Error GoTo ErrPart
        Dim mLockDateFrom As String
        Dim mLockDateTo As String
        mLockDateFrom = IIf(IsDBNull(RsCompany.Fields("Lockdatefrom").Value), "", RsCompany.Fields("Lockdatefrom").Value)
        mLockDateTo = IIf(IsDBNull(RsCompany.Fields("Lockdateto").Value), "", RsCompany.Fields("Lockdateto").Value)
        If LockDate = "" Then ValidateBranchLocking = False : Exit Function
        If mLockDateFrom = "" Or mLockDateTo = "" Then ValidateBranchLocking = False : Exit Function
        If CDate(LockDate) >= CDate(mLockDateFrom) And CDate(LockDate) <= CDate(mLockDateTo) Then
            MsgInformation("Working Company Been Locked For The Period " & vbCrLf & "From : " & mLockDateFrom & " To : " & mLockDateTo & vbCrLf & "So Unable to Save or Delete. Contact your system administrator.")
            ValidateBranchLocking = True
        Else
            ValidateBranchLocking = False
        End If
        Exit Function
ErrPart:
        ValidateBranchLocking = True
    End Function
    Public Function ValidateBookLocking(ByRef pPvtDBCn As ADODB.Connection, ByRef pBookCode As Integer, ByRef LockDate As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String = ""
        Dim RsLock As ADODB.Recordset = Nothing
        Dim mLockDateFrom As String
        Dim mLockDateTo As String
        ValidateBookLocking = False
        If PubUserID = "G0416" Then Exit Function
        mSqlStr = " SELECT * FROM GEN_LOCKING_MST " & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BOOKCODE=" & pBookCode & ""
        MainClass.UOpenRecordSet(mSqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsLock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsLock.EOF = False Then
            mLockDateFrom = IIf(IsDBNull(RsLock.Fields("LOCK_FROM").Value), "", RsLock.Fields("LOCK_FROM").Value)
            mLockDateTo = IIf(IsDBNull(RsLock.Fields("LOCK_TO").Value), "", RsLock.Fields("LOCK_TO").Value)
            If LockDate = "" Then ValidateBookLocking = False : Exit Function
            If mLockDateFrom = "" Or mLockDateTo = "" Then ValidateBookLocking = False : Exit Function
            'If PubUserEMPCode = "000416" Then: ValidateBookLocking = False: Exit Function
            If CDate(LockDate) >= CDate(mLockDateFrom) And CDate(LockDate) <= CDate(mLockDateTo) Then
                MsgInformation("Working Book Has Been Locked For The Period " & vbCrLf & "From : " & mLockDateFrom & " To : " & mLockDateTo & vbCrLf & "So Unable to Save or Delete. Contact your system administrator.")
                ValidateBookLocking = True
            Else
                ValidateBookLocking = False
            End If
        End If
        Exit Function
ErrPart:
        ValidateBookLocking = True
    End Function
    Public Function UpdateStockTRN(ByVal pDBCn As ADODB.Connection, ByVal pRefType As String, ByVal pRefNo As String,
                                ByVal pSerailNo As Integer, ByVal pRefDate As String, ByVal pQCDate As String,
                                ByVal pStockType As String, ByRef pItemCode As String, ByVal pItemUOM As String,
                                ByVal pBatchNo As String, ByVal pItemQty As Double, ByVal pRejQty As Double,
                                ByVal pIO As String, ByVal pPurchaseCost As Double, ByVal pLandedCost As Double,
                                ByVal pOperationCode As String, ByVal pNextOperationCode As String, ByVal pDeptCodeTo As String,
                                ByVal pDeptCodeFrom As String, ByVal pCCCode As String, ByVal pCancelled As String,
                                ByVal pDescription As String, ByRef pPartyCode As String, ByVal pStockID As String,
                                ByVal pDivisionCode As Double, ByVal pRefFlag As String, ByVal pRefItemCode As String,
                                Optional ByVal pStatus As String = "", Optional ByVal pHeatNo As String = "",
                                Optional ByVal pRate As Double = 0, Optional ByVal pPONo As Double = 0, Optional ByVal pMaterialType As String = "N") As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim mItemCost As Double
        Dim xStockType As String = ""
        Dim mTableName As String = ""
        Dim xStatus As String = ""
        Dim mClosingBal As Double
        Dim pLastBalance As Double = 0
        Dim pYearEndDate As String
        Dim mAssets As String = "N"
        Dim mItemType As String = "N"
        Dim mProductType As String = "G"
        Dim pNewRate As Double
        Dim mPurpose As String
        xStockType = pStockType
        If Trim(pStatus) = "" Then
            xStatus = "O"
        Else
            xStatus = pStatus
        End If
        If pCancelled = "Y" Then
            UpdateStockTRN = True
            Exit Function
        End If

        If pRefType = "MRR" And pRefFlag = "R" Then
            mProductType = GetProductionType(pItemCode) 'GetProductionType(mItemCode)
            If mProductType = "G" Or mProductType = "C" Or mProductType = "T" Or mProductType = "A" Or mProductType = "M" Then
                mItemType = "O"
            End If
        ElseIf pRefType = "ISS" Then
            mProductType = GetProductionType(pItemCode) 'GetProductionType(mItemCode)
            If mProductType = "G" Or mProductType = "C" Or mProductType = "T" Or mProductType = "A" Or mProductType = "M" Then
                mItemType = pMaterialType
            End If
        End If

        If pRefType = "MRR" Or pRefType = "ISS" Then
            If MainClass.ValidateWithMasterTable(pItemCode, "ITEM_CODE", "STOCKITEM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND STOCKITEM='N'") = True Then
                UpdateStockTRN = True
                Exit Function
            End If
        End If

        If pRefType = "MRR" And pRefFlag = "P" Then
            SqlStr = "SELECT ISCAPITAL FROM PUR_PURCHASE_HDR " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
                & " And AUTO_KEY_PO=" & pPONo & " AND PO_STATUS='Y' AND PUR_TYPE = 'P'"


            SqlStr = SqlStr & vbCrLf _
                & " AND MKEY = ( " & vbCrLf _
                & " SELECT MAX(MKEY) " & vbCrLf _
                & " FROM PUR_PURCHASE_HDR SIH" & vbCrLf _
                & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND AUTO_KEY_PO=" & pPONo & " AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE = 'P' "

            SqlStr = SqlStr & vbCrLf _
                & " AND AMEND_WEF_DATE <= TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"

            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mAssets = IIf(IsDBNull(RsTemp.Fields("ISCAPITAL").Value), "N", RsTemp.Fields("ISCAPITAL").Value)
            End If
            'If MainClass.ValidateWithMasterTable(pPONo, "AUTO_KEY_PO", "ISCAPITAL", "PUR_PURCHASE_HDR", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            '    mAssets = MasterNo
            'End If
        ElseIf pRefType = "ISS" And pRefFlag = "C" Then
            mAssets = "Y"
        ElseIf pRefType = "DSP" And pRefFlag = "F" Then
            mAssets = "Y"
        ElseIf pRefType = "RGP" Or pRefType = "NRG" Then
            mAssets = "N"
            SqlStr = "SELECT ISCAPITAL FROM PUR_PURCHASE_HDR " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
                & " And AUTO_KEY_PO=" & pPONo & " AND PO_STATUS='Y' AND PUR_TYPE <> 'P'"


            SqlStr = SqlStr & vbCrLf _
                & " AND MKEY = ( " & vbCrLf _
                & " SELECT MAX(MKEY) " & vbCrLf _
                & " FROM PUR_PURCHASE_HDR SIH" & vbCrLf _
                & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND AUTO_KEY_PO=" & pPONo & " AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE <> 'P' "

            SqlStr = SqlStr & vbCrLf _
                & " AND AMEND_WEF_DATE <= TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"

            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mAssets = IIf(IsDBNull(RsTemp.Fields("ISCAPITAL").Value), "N", RsTemp.Fields("ISCAPITAL").Value)
            End If
        End If

        mFactor = 1
        mTableName = ConInventoryTable

        ' Temp LOck Sandeep
        If pRefType = "OPN" Or pRefType = "ADJ" Or pRefType = "PMD" Or pRefType = "MRR" Then
        Else            ''If pRefType = "ISS" Then
            If pIO = "O" And pItemQty > 0 Then
                If RsCompany.Fields("STOCKBALCHECK").Value = "Y" Then
                    pYearEndDate = RsCompany.Fields("END_DATE").Value

                    pLastBalance = GetBalanceStockQty(pItemCode, pYearEndDate, pItemUOM, pDeptCodeTo, xStockType, IIf(pBatchNo = "-1", "", pBatchNo), pStockID,
                                                  pDivisionCode, pRefType, Val(pRefNo),,,, "F", mAssets)

                    If pItemQty > pLastBalance Then
                        MsgInformation("Out Qty of Item Code :" & pItemCode & " is greater than as as on Balance Qty (" & pLastBalance & " " & pItemUOM & "), So Cann't be Save.")
                        UpdateStockTRN = False
                        Exit Function
                    End If
                End If
            End If
        End If

        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
            mItemCost = IIf(IsDBNull(RsTemp.Fields("PURCHASE_COST").Value), 0, RsTemp.Fields("PURCHASE_COST").Value)
        End If

        If pRefType = "MRR" Or pRefType = "REO" Then

            If pPurchaseCost = 0 Or pLandedCost = 0 Then
                pLandedCost = GetLatestItemCostFromMRR(pItemCode, pItemUOM, 1, pRefDate, "L", xStockType, "")
                pPurchaseCost = pLandedCost
                xStockType = pStockType
            End If
        End If

        pNewRate = 0

        ''New Change om 20/04/2024
        'If pRefType = "MRR" Then
        '    If pRefFlag = "P" Then
        '        SqlStr = "SELECT GetITEMPRICE_NEW(1,1,TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & pRefNo & ", '" & pItemCode & "') AS PORATE" & vbCrLf _
        '                & " FROM DUAL"
        '        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        '        If RsTemp.EOF = False Then
        '            pNewRate = IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value)
        '        End If
        '    ElseIf pRefFlag = "R" Then
        '        If MainClass.ValidateWithMasterTable(pRefNo, "AUTO_KEY_PASSNO", "PURPOSE", "INV_GATEPASS_HDR", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
        '            mPurpose = IIf(IsDBNull(MasterNo), "", MasterNo)
        '        End If
        '        If mPurpose = "B" Then
        '            ''ITEM_CODE, AUTO_KEY_WO, INWARD_ITEM_CODE

        '            SqlStr = "SELECT NVL(SELECT MAX(((NVL(ITEM_PRICE, 0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE) AS PORATE" & vbCrLf _
        '                    & " FROM PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD" & vbCrLf _
        '                    & " WHERE PH.COMPANY_CODE = PD.COMPANY_CODE And PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE" & vbCrLf _
        '                    & " AND PD.MKEY =(SELECT MAX(SPH.MKEY)" & vbCrLf _
        '                    & " From PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD" & vbCrLf _
        '                    & " Where SPH.MKEY = SPD.MKEY" & vbCrLf _
        '                    & " And SPH.AUTO_KEY_PO = GTD.AUTO_KEY_WO" & vbCrLf _
        '                    & " And SPD.ITEM_CODE= ID.ITEM_CODE" & vbCrLf _
        '                    & " And SPD.PO_WEF_DATE <= IH.MRR_DATE" & vbCrLf _
        '                    & " And PO_STATUS='Y' AND PUR_TYPE = 'J')),0) AS PORATE" & vbCrLf _
        '                    & " From INV_GATEPASS_HDR GTH, INV_GATEPASS_DET GTD" & vbCrLf _
        '                    & " Where GTH.AUTO_KEY_PASSNO=GTD.AUTO_KEY_PASSNO AND GTH.COMPANY_CODE = mCompanyCode" & vbCrLf _
        '                    & " " & vbCrLf _
        '                    & " " & vbCrLf _



        '            '                Select Case IH.AUTO_KEY_MRR MKEY, IH.AUTO_KEY_MRR, IH.AUTO_KEY_MRR VNO, IH.MRR_DATE,
        '            '                ID.ITEM_UOM, ID.APPROVED_QTY As APPROVED_QTY,
        '            '                0 OTHERS,
        '            '                NVL((SELECT MAX(((NVL(ITEM_PRICE, 0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE)
        '            '                From PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD
        '            '                Where PH.COMPANY_CODE = PD.COMPANY_CODE And PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE
        '            '                And PD.MKEY =(SELECT MAX(SPH.MKEY)
        '            '                From PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD
        '            '                Where SPH.MKEY = SPD.MKEY
        '            '                And SPH.AUTO_KEY_PO = GTD.AUTO_KEY_WO
        '            '                And SPD.ITEM_CODE= ID.ITEM_CODE
        '            '                And SPD.PO_WEF_DATE <= IH.MRR_DATE
        '            '                And PO_STATUS='Y' AND PUR_TYPE = 'J')),0) AS PORATE
        '            '                From INV_GATE_HDR IH, INV_GATE_DET ID, INV_GATEPASS_HDR GTH, INV_GATEPASS_DET GTD
        '            '                Where IH.COMPANY_CODE = mCompanyCode
        '            '                And IH.AUTO_KEY_MRR=ID.AUTO_KEY_MRR
        '            'And IH.COMPANY_CODE=GTH.COMPANY_CODE
        '            '                And ID.REF_PO_NO=GTH.AUTO_KEY_PASSNO
        '            'And GTH.AUTO_KEY_PASSNO=GTD.AUTO_KEY_PASSNO
        '            '    And ID.RGP_ITEM_CODE=GTD.ITEM_CODE
        '            'And ID.ITEM_CODE=GTD.INWARD_ITEM_CODE
        '            '                And ID.ITEM_CODE=nItem_code
        '            '                And IH.REF_TYPE ='R' AND GTH.PURPOSE='B'
        '            '                And IH.MRR_DATE<=nREF_DATE

        '            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        '            If RsTemp.EOF = False Then
        '                pNewRate = IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value)
        '            End If
        '        ElseIf mPurpose = "C" Then
        '            pNewRate = pPurchaseCost
        '        ElseIf mPurpose = "S" Then
        '            'GetSORATE (mCompanyCode NUMBER,mINVDate Date,mSONO NUMBER,mItemCode CHAR)
        '        Else
        '            pNewRate = 0
        '        End If
        '    End If

        'End If

        If Trim(pItemUOM) = Trim(mPurchaseUOM) Then
            pItemUOM = mIssueUOM
            pItemQty = pItemQty * mFactor
            pRejQty = pRejQty * mFactor
            pPurchaseCost = pPurchaseCost / mFactor
            pLandedCost = pLandedCost / mFactor
            mItemCost = mItemCost / mFactor
        End If
        'If pRefType = "MRR" Then
        '    pRate = GetLatestItemCostFromMRR(pItemCode, pItemUOM, IIf(pItemQty <= 0, 1, pItemQty), pRefDate, "L", "", "", "", "", "", pPartyCode)
        '    If pItemQty > 0 Then
        '        pRate = Format(pRate / pItemQty, "0.00")
        '    End If
        'Else
        '    pRate = GetLatestItemCostFromMRR(pItemCode, pItemUOM, IIf(pLastBalance <= 0, 1, pLastBalance), pRefDate, "L", "", "", "", "", "", pPartyCode)
        '    If pLastBalance > 0 Then
        '        pRate = Format(pRate / pLastBalance, "0.00")
        '    End If
        'End If
        ''

        If pItemQty > 0 Then
            SqlStr = "INSERT INTO " & mTableName & " (COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf _
                    & " REF_DATE, E_DATE, STOCK_TYPE, ITEM_CODE,ITEM_UOM, HEAT_NO, BATCH_NO, ITEM_QTY,ITEM_IO, " & vbCrLf _
                    & " PURCHASE_COST,LANDED_COST, OPR_CODE, NEXT_OPR_CODE, DEPT_CODE_TO, DEPT_CODE_FROM,CC_CODE," & vbCrLf _
                    & " REMARKS, PARTYCODE,STATUS, ISUPDATE, DIV_CODE, REF_FLAG, REF_ITEM_CODE, NEW_RATE,IS_CAPITAL,ITEM_TYPE)" & vbCrLf _
                    & " VALUES ( " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
                    & " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pQCDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(xStockType) & "','" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', '" & Trim(pHeatNo) & "', '" & Trim(pBatchNo) & "', " & vbCrLf _
                    & " " & Val(CStr(pItemQty)) & ",'" & pIO & "'," & Val(CStr(pPurchaseCost)) & "," & Val(CStr(pLandedCost)) & "," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pOperationCode) & "', '" & MainClass.AllowSingleQuote(pNextOperationCode) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pDeptCodeTo) & "', '" & MainClass.AllowSingleQuote(pDeptCodeFrom) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pCCCode) & "','" & MainClass.AllowSingleQuote(pDescription) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pPartyCode) & "','" & xStatus & "','N'," & pDivisionCode & "," & vbCrLf _
                    & " '" & pRefFlag & "', '" & MainClass.AllowSingleQuote(pRefItemCode) & "'," & Val(CStr(pRate)) & ",'" & mAssets & "','" & mItemType & "')"
            pDBCn.Execute(SqlStr)
        End If
        If pRejQty > 0 Then
            xStockType = "RJ"
            SqlStr = " INSERT INTO " & mTableName & " ( COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf _
                    & " REF_DATE, E_DATE, STOCK_TYPE, ITEM_CODE,ITEM_UOM, HEAT_NO, BATCH_NO, ITEM_QTY,ITEM_IO, " & vbCrLf _
                    & " PURCHASE_COST, LANDED_COST,OPR_CODE, NEXT_OPR_CODE, DEPT_CODE_TO,DEPT_CODE_FROM, CC_CODE," & vbCrLf _
                    & " REMARKS, PARTYCODE,STATUS,ISUPDATE,DIV_CODE, REF_FLAG, REF_ITEM_CODE, NEW_RATE,IS_CAPITAL,ITEM_TYPE ) " & vbCrLf _
                    & " VALUES (" & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
                    & " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pQCDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(xStockType) & "'," & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', '" & Trim(pHeatNo) & "','" & Trim(pBatchNo) & "'," & vbCrLf _
                    & " " & Val(CStr(pRejQty)) & ",'" & pIO & "'," & Val(CStr(pPurchaseCost)) & "," & Val(CStr(pLandedCost)) & "," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pOperationCode) & "', '" & MainClass.AllowSingleQuote(pNextOperationCode) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pDeptCodeTo) & "', '" & MainClass.AllowSingleQuote(pDeptCodeFrom) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pCCCode) & "','" & MainClass.AllowSingleQuote(pDescription) & "'," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pPartyCode) & "','" & xStatus & "','N'," & pDivisionCode & "," & vbCrLf _
                    & " '" & pRefFlag & "', '" & MainClass.AllowSingleQuote(pRefItemCode) & "'," & Val(CStr(pRate)) & ",'" & mAssets & "','" & mItemType & "')"
            pDBCn.Execute(SqlStr)
        End If
        UpdateStockTRN = True
        Exit Function
UpdateStockTRNErr:
        'Resume Next
        UpdateStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetTotalSFCost(ByRef pItemCode As String, ByRef xRefDate As String, ByRef xItemUOM As String, ByRef pFactor As Double) As Double
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mRMRate As Double
        SqlStr = "Select FINAL_COST " & vbCrLf _
            & " FROM PRD_FG_COST_HDR IH " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " And IH.PRODUCT_CODE='" & pItemCode & "'"

        SqlStr = SqlStr & vbCrLf _
            & " AND IH.WEF = (" & vbCrLf _
            & " SELECT MAX(WEF) " & vbCrLf _
            & " FROM PRD_FG_COST_HDR " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & pItemCode & "'" & vbCrLf _
            & " AND WEF<=TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mRMRate = IIf(IsDBNull(RsTemp.Fields("FINAL_COST").Value), 0, RsTemp.Fields("FINAL_COST").Value)
        End If
        GetTotalSFCost = mRMRate
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetTotalSFCost = 0
    End Function
    Public Function GetTotalJWRMCost(ByRef pItemCode As String, ByRef xRefDate As String, ByRef xItemUOM As String, ByRef pFactor As Double) As Double
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mConInQty As Double
        Dim mConOutQty As Double
        Dim mFactorQty As Double
        Dim mOutItemCode As String
        Dim mRMRate As Double
        'Dim PvtDBCn As ADODB.Connection
        '
        'Set PvtDBCn = New ADODB.Connection
        'PvtDBCn.Open StrConn
        SqlStr = "Select IH.MKEY, IH.PRODUCT_CODE, ID.ITEM_CODE,ITEM_QTY " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf & " And IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And IH.PRODUCT_CODE='" & pItemCode & "'"
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_OUTBOM_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " AND IH.STATUS='O'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mConInQty = 1
                mConOutQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                mFactorQty = CDbl(VB6.Format(mConOutQty / mConInQty, "0.0000"))
                mOutItemCode = IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), 0, RsTemp.Fields("ITEM_CODE").Value)
                mRMRate = mRMRate + (GetRMCost(mOutItemCode, xRefDate, xItemUOM, pFactor) * mFactorQty)
                RsTemp.MoveNext()
            Loop
        End If
        GetTotalJWRMCost = mRMRate
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetTotalJWRMCost = 0
    End Function
    Public Function GetRMCost(ByRef pOutItemCode As String, ByRef xRefDate As String, ByRef xItemUOM As String, ByRef pFactor As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mPurchaseUOM As String = ""
        SqlStr = " Select IH.MKEY, (NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,2)) PURCHASE_COST, " & vbCrLf & " 0 LANDED_COST,ITEM_UOM,IH.PUR_TYPE" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID " & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " And IH.MKEY=ID.MKEY And IH.PO_STATUS='Y' AND IH.PUR_TYPE IN ('P','J')"
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pOutItemCode) & "'" & vbCrLf & " AND ID.PO_WEF_DATE = ( " & vbCrLf & " SELECT MAX(PO_WEF_DATE) " & vbCrLf & " FROM PUR_PURCHASE_HDR SIH, PUR_PURCHASE_DET SID" & vbCrLf & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SIH.MKEY=SID.MKEY AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE IN ('P','J')"
        SqlStr = SqlStr & vbCrLf & " AND SID.ITEM_CODE='" & MainClass.AllowSingleQuote(pOutItemCode) & "'" & vbCrLf & " AND SID.PO_WEF_DATE <= TO_DATE('" & VB6.Format(xRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY IH.PO_CLOSED, ID.PO_WEF_DATE DESC"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetRMCost = IIf(IsDBNull(RsTemp.Fields("PURCHASE_COST").Value), 0, RsTemp.Fields("PURCHASE_COST").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), 0, RsTemp.Fields("ITEM_UOM").Value)
        End If
        'If xItemUOM <> mPurchaseUOM Then
        'GetRMCost = GetRMCost / pFactor
        'End If
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetRMCost = 0
    End Function
    Public Function GetProductSeqNo(ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pDate As String, Optional ByRef pCompanyCode As Long = 0) As Integer
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSeq As Integer
        Dim mCompanyCode As Long

        mSeq = 0
        If pCompanyCode > 0 Then
            mCompanyCode = pCompanyCode
        Else
            mCompanyCode = RsCompany.Fields("COMPANY_CODE").Value
        End If

        SqlStr = ""
        ''AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'
        SqlStr = "Select SERIAL_NO " & vbCrLf & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf _
            & " WHERE COMPANY_CODE=" & mCompanyCode & "" & vbCrLf _
            & " And PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf _
            & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf _
            & " WHERE COMPANY_CODE=" & mCompanyCode & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND " & vbCrLf & " WEF <=TO_DATE('" & VB6.Format(pDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSeq = IIf(IsDBNull(RsTemp.Fields("SERIAL_NO").Value), 0, RsTemp.Fields("SERIAL_NO").Value)
        Else
            mSeq = 0
        End If
        GetProductSeqNo = mSeq
        Exit Function
ErrPart:
        GetProductSeqNo = 0
    End Function
    Public Function GetOperationSeq(ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pOPRCode As String, ByRef pDate As String, Optional ByRef pCompanyCode As Long = 0) As Integer
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSeq As Integer

        Dim mCompanyCode As Long


        If pCompanyCode > 0 Then
            mCompanyCode = pCompanyCode
        Else
            mCompanyCode = RsCompany.Fields("COMPANY_CODE").Value
        End If

        If pOPRCode = "" Then
            GetOperationSeq = 1
            Exit Function
        End If
        mSeq = 0
        SqlStr = ""
        SqlStr = OperationQuery(Trim(pItemCode), Trim(pDeptCode), Trim(pOPRCode), "", Trim(pDate), "OPR_SNO",,,,, mCompanyCode)

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSeq = IIf(IsDBNull(RsTemp.Fields("OPR_SNO").Value), 0, RsTemp.Fields("OPR_SNO").Value)
        Else
            mSeq = 1
        End If
        GetOperationSeq = mSeq
        Exit Function
ErrPart:
        GetOperationSeq = 1
    End Function
    Public Function UpdateTRN(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pTRNDtlSubRowNo As Integer, ByRef pSubRowNo As Integer,
                              ByRef pBookCode As String, ByRef pVType As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String,
                              ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pAmount As Double, ByRef pDC As String,
                              ByRef pTRNType As String, ByRef pChequeNo As String, ByRef pChqDate As String, ByRef pCostCCode As String, ByRef pDeptCode As String,
                              ByRef pEmpCode As String, ByRef pExpCode As String, ByRef pDueDate As String, ByRef pIBRNo As String, ByRef pBillType As String,
                              ByRef pClearDate As String, ByRef pLocked As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpDate As String,
                              ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pBillToLocation As String,
                              Optional ByRef pPLFlag As String = "", Optional ByRef pReverseCharge As String = "", Optional ByRef pSAC As String = "",
                              Optional ByRef pCGSTPer As Double = 0, Optional ByRef pCGSTAmount As Double = 0, Optional ByRef pSGSTPer As Double = 0,
                              Optional ByRef pSGSTAmount As Double = 0, Optional ByRef pIGSTPer As Double = 0, Optional ByRef pIGSTAmount As Double = 0, Optional ByRef mBillCompanyCode As Long = -1) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim pDueDays As Double
        Dim pModUser As String
        Dim pModDate As String
        Dim xExpDate As String
        Dim mCompanyCode As Long

        ''pDueDate = DateAdd("D", pDueDays, pBillDate)
        If IsDate(pDueDate) Then
            pDueDays = DateDiff(Microsoft.VisualBasic.DateInterval.Day, CDate(pBillDate), CDate(pDueDate))
        Else
            pDueDays = 0
        End If
        If CDbl(pBookCode) = ConDebitNoteBookCode Or CDbl(pBookCode) = ConCreditNoteBookCode Then
            xExpDate = pVDate
        Else
            xExpDate = pExpDate
        End If
        pNarration = Left(pNarration, 250)
        pRemarks = Left(pRemarks, 250)
        pPLFlag = IIf(pPLFlag = "", "N", pPLFlag)
        If pAddMode = True Then
            pAddUser = PubUserID
            pAddDate = CStr(PubCurrDate)
            pModUser = ""
            pModDate = ""
        Else
            pModUser = PubUserID
            pModDate = CStr(PubCurrDate)
        End If

        mCompanyCode = IIf(Val(mBillCompanyCode) <= 0, RsCompany.Fields("COMPANY_CODE").Value, mBillCompanyCode)

        SqlStr = "Insert Into FIN_POSTED_TRN ( " & vbCrLf _
        & " MKey, TRNDtlSubRowNo, SubRowNo, " & vbCrLf _
        & " Company_Code, FYEAR, BookCode, VType, " & vbCrLf _
        & " BookType, BookSubType, AccountCode, " & vbCrLf _
        & " Vno, VDate, BillNo, BillDate, " & vbCrLf _
        & " Amount, DC, " & vbCrLf _
        & " TrnType, ChequeNo, ChqDate, CostCCode, " & vbCrLf _
        & " DeptCode, EmpCode, EXP_CODE, DueDays, DueDate, " & vbCrLf _
        & " IBRNo, ClearDate, Locked, BILLTYPE, Narration, Remarks, " & vbCrLf _
        & " AddUser , AddDate, ModUser, ModDate,EXPDATE,DIV_CODE, PL_FLAG, " & vbCrLf _
        & " REVERSE_CHARGE_APP, SAC, " & vbCrLf _
        & " CGST_PER, CGST_AMOUNT, " & vbCrLf _
        & " SGST_PER, SGST_AMOUNT, " & vbCrLf _
        & " IGST_PER, IGST_AMOUNT,LOCATION_ID "
        SqlStr = SqlStr & " ) VALUES ( "
        SqlStr = SqlStr & vbCrLf _
        & " '" & PKey & "' , " & pTRNDtlSubRowNo & ", " & pSubRowNo & ", " & vbCrLf _
        & " " & mCompanyCode & ", " & RsCompany.Fields("FYEAR").Value & ", '" & pBookCode & "', '" & pVType & "', " & vbCrLf _
        & " '" & pBookType & "','" & pBookSubType & "', '" & pAccountCode & "', " & vbCrLf _
        & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " '" & pBillNo & "',TO_DATE('" & VB6.Format(pBillDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " " & pAmount & ", '" & pDC & "', '" & pTRNType & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pChequeNo) & "', TO_DATE('" & VB6.Format(pChqDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pCostCCode) & "', '" & MainClass.AllowSingleQuote(pDeptCode) & "', '" & MainClass.AllowSingleQuote(pEmpCode) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pExpCode) & "', " & pDueDays & ", " & vbCrLf _
        & " TO_DATE('" & VB6.Format(pDueDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pIBRNo) & "', " & vbCrLf _
        & " TO_DATE('" & VB6.Format(pClearDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pLocked) & "', " & vbCrLf _
        & " '" & pBillType & "', '" & MainClass.AllowSingleQuote(pNarration) & "','" & MainClass.AllowSingleQuote(pRemarks) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pAddUser) & "',TO_DATE('" & VB6.Format(pAddDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pModUser) & "',TO_DATE('" & VB6.Format(pModDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
        & " TO_DATE('" & VB6.Format(xExpDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & mDivisionCode & ", '" & pPLFlag & "'," & vbCrLf _
        & " '" & pReverseCharge & "', '" & pSAC & "', " & pCGSTPer & ", " & pCGSTAmount & ", " & vbCrLf & " " & pSGSTPer & ", " & pSGSTAmount & "," & vbCrLf _
        & " " & pIGSTPer & ", " & pIGSTAmount & ",'" & MainClass.AllowSingleQuote(pBillToLocation) & "'" & vbCrLf _
        & " )"
        pDBCn.Execute(SqlStr)

        SqlStr = "Insert Into FIN_POSTED_HIS_TRN ( " & vbCrLf _
        & " MKey, TRNDtlSubRowNo, SubRowNo, " & vbCrLf _
        & " Company_Code, FYEAR, BookCode, VType, " & vbCrLf _
        & " BookType, BookSubType, AccountCode, " & vbCrLf _
        & " Vno, VDate, BillNo, BillDate, " & vbCrLf _
        & " Amount, DC, " & vbCrLf _
        & " TrnType, ChequeNo, ChqDate, CostCCode, " & vbCrLf _
        & " DeptCode, EmpCode, EXP_CODE, DueDays, DueDate, " & vbCrLf _
        & " IBRNo, ClearDate, Locked, BILLTYPE, Narration, Remarks, " & vbCrLf _
        & " AddUser , AddDate, ModUser, ModDate,EXPDATE,DIV_CODE, PL_FLAG, " & vbCrLf _
        & " REVERSE_CHARGE_APP, SAC, " & vbCrLf _
        & " CGST_PER, CGST_AMOUNT, " & vbCrLf _
        & " SGST_PER, SGST_AMOUNT, " & vbCrLf _
        & " IGST_PER, IGST_AMOUNT,LOCATION_ID "
        SqlStr = SqlStr & " ) VALUES ( "
        SqlStr = SqlStr & vbCrLf _
        & " '" & PKey & "' , " & pTRNDtlSubRowNo & ", " & pSubRowNo & ", " & vbCrLf _
        & " " & mCompanyCode & ", " & RsCompany.Fields("FYEAR").Value & ", '" & pBookCode & "', '" & pVType & "', " & vbCrLf _
        & " '" & pBookType & "','" & pBookSubType & "', '" & pAccountCode & "', " & vbCrLf _
        & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " '" & pBillNo & "',TO_DATE('" & VB6.Format(pBillDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " " & pAmount & ", '" & pDC & "', '" & pTRNType & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pChequeNo) & "', TO_DATE('" & VB6.Format(pChqDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pCostCCode) & "', '" & MainClass.AllowSingleQuote(pDeptCode) & "', '" & MainClass.AllowSingleQuote(pEmpCode) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pExpCode) & "', " & pDueDays & ", " & vbCrLf _
        & " TO_DATE('" & VB6.Format(pDueDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pIBRNo) & "', " & vbCrLf _
        & " TO_DATE('" & VB6.Format(pClearDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pLocked) & "', " & vbCrLf _
        & " '" & pBillType & "', '" & MainClass.AllowSingleQuote(pNarration) & "','" & MainClass.AllowSingleQuote(pRemarks) & "', " & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pAddUser) & "',TO_DATE('" & VB6.Format(pAddDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
        & " '" & MainClass.AllowSingleQuote(pModUser) & "',TO_DATE('" & VB6.Format(pModDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf _
        & " TO_DATE('" & VB6.Format(xExpDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & mDivisionCode & ", '" & pPLFlag & "'," & vbCrLf _
        & " '" & pReverseCharge & "', '" & pSAC & "', " & pCGSTPer & ", " & pCGSTAmount & ", " & vbCrLf _
        & " " & pSGSTPer & ", " & pSGSTAmount & "," & vbCrLf _
        & " " & pIGSTPer & ", " & pIGSTAmount & ",'" & MainClass.AllowSingleQuote(pBillToLocation) & "'" & vbCrLf _
        & " )"

        pDBCn.Execute(SqlStr)

        'If pBillType = "P" Then

        '    SqlStr = "UPDATE FIN_POSTED_TRN SET ADJUST_AMOUNT = " & pAmount & " " & vbCrLf _
        '            & " WHERE COMPANY_CODE=" & mCompanyCode & "" & vbCrLf _
        '            & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
        '            & " AND ACCOUNTCODE='" & pAccountCode & "'" & vbCrLf _
        '            & " AND BILLNO='" & pBillNo & "' " & vbCrLf _
        '            & " AND BILLDATE=TO_DATE('" & VB6.Format(pBillDate, "dd-MMM-yyyy") & "','DD-MON-YYYY') "

        '    pDBCn.Execute(SqlStr)
        'End If
        UpdateTRN = True


        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateTRN = False
        ''Resume
    End Function
    Public Function DeleteOpeningStockTRN(pDBCn As ADODB.Connection, pRefType As String, pItemCode As String,
    pStockID As String, mStatus As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim mTableName As String
        mTableName = ConInventoryTable

        SqlStr = "DELETE FROM " & mTableName & " " & vbCrLf _
        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        & " And FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
        & " And REF_TYPE='" & pRefType & "'" & vbCrLf _
        & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf
        If pStockID <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND STOCK_ID='" & pStockID & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND STATUS='" & mStatus & "'"
        pDBCn.Execute(SqlStr)
        DeleteOpeningStockTRN = True
        Exit Function
UpdateStockTRNErr:
        DeleteOpeningStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function DeletePaintStockTRN(pDBCn As ADODB.Connection, pRefType As String,
    pRefNo As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM INV_PAINT_STOCK_TRN " & vbCrLf _
        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        & " And FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
        & " And REF_TYPE='" & pRefType & "'" & vbCrLf _
        & " AND REF_NO=" & Val(pRefNo) & "" & vbCrLf
        pDBCn.Execute(SqlStr)
        DeletePaintStockTRN = True
        Exit Function
UpdateStockTRNErr:
        DeletePaintStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function UpdatePaintStockTRN(pDBCn As ADODB.Connection, pRefType As String,
    pRefNo As String, pSerailNo As Long, pRefDate As String,
    pStockType As String, pItemCode As String, pItemUOM As String,
    pBatchNo As String, pLotNo As String, pItemQty As Double, pRejQty As Double, pIO As String,
    pCancelled As String, pDescription As String) As Boolean
        On Error GoTo UpdatePaintStockTRNErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        If pCancelled = "Y" Then
            UpdatePaintStockTRN = True
            Exit Function
        End If
        mFactor = 1
        SqlStr = " Select ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf _
        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " And ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        'MainClass.UOpenRecordSet(Sqlstr, pDBCn, adOpenStatic, RsTemp, adLockReadOnly)
        MainClass.UOpenRecordSet(SqlStr, pDBCn, CursorTypeEnum.adOpenStatic, RsTemp, LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
        End If
        If pItemUOM = mPurchaseUOM Then
            pItemUOM = mIssueUOM
            pItemQty = pItemQty * mFactor
            pRejQty = pRejQty * mFactor
        End If
        If pItemQty > 0 Then
            SqlStr = "INSERT INTO INV_PAINT_STOCK_TRN ( " & vbCrLf _
            & " COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, REF_NO, " & vbCrLf _
            & " REF_DATE, STOCK_TYPE, ITEM_CODE, " & vbCrLf _
            & " ITEM_UOM, BATCH_NO, LOT_NO, ITEM_QTY, " & vbCrLf _
            & " ITEM_IO, REMARKS ) VALUES ( " & vbCrLf _
            & " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
            & " " & pSerailNo & ",'" & pRefType & "', " & Val(pRefNo) & ", " & vbCrLf _
            & " TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pStockType) & "'," & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', '" & MainClass.AllowSingleQuote(pBatchNo) & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pLotNo) & "', " & Val(pItemQty) & ",'" & pIO & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pDescription) & "')"
            pDBCn.Execute(SqlStr)
        End If
        If pRejQty > 0 Then
            pStockType = "RJ"
            SqlStr = "INSERT INTO INV_PAINT_STOCK_TRN ( " & vbCrLf _
            & " COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, REF_NO, " & vbCrLf _
            & " REF_DATE, STOCK_TYPE, ITEM_CODE, " & vbCrLf _
            & " ITEM_UOM, BATCH_NO, LOT_NO, ITEM_QTY, " & vbCrLf _
            & " ITEM_IO, REMARKS ) VALUES ( " & vbCrLf _
            & " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
            & " " & pSerailNo & ",'" & pRefType & "', " & Val(pRefNo) & ", " & vbCrLf _
            & " TO_DATE('" & VB6.Format(pRefDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pStockType) & "'," & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', '" & MainClass.AllowSingleQuote(pBatchNo) & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pLotNo) & "', " & Val(pRejQty) & ",'" & pIO & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pDescription) & "')"
            pDBCn.Execute(SqlStr)
        End If
        UpdatePaintStockTRN = True
        Exit Function
UpdatePaintStockTRNErr:
        UpdatePaintStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function CheckBOMItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckBOMItem = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_BOM_ITEM " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & pItemCode & "'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_BOM_ITEM").Value), "Y", RsTemp.Fields("IS_BOM_ITEM").Value)
            CheckBOMItem = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckIndentItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckIndentItem = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_INDENT_ITEM " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_INDENT_ITEM").Value), "Y", RsTemp.Fields("IS_INDENT_ITEM").Value)
            CheckIndentItem = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function CheckQuotationRequiredItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckQuotationRequiredItem = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_QUOTATION_REQ " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & pItemCode & "'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_QUOTATION_REQ").Value), "Y", RsTemp.Fields("IS_QUOTATION_REQ").Value)
            CheckQuotationRequiredItem = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function CheckItemConsumptionExists(ByRef pItemCode As String, ByRef pInHouseCheck As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckItemConsumptionExists = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IH.PRODUCT_CODE AS PRODUCT_CODE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.STATUS='O'"
        If pInHouseCheck = "N" Then
            mSqlStr = mSqlStr & vbCrLf & " AND IS_INHOUSE='N'"
        End If
        'mSqlStr = mSqlStr & vbCrLf & "UNION"
        '
        'mSqlStr = mSqlStr & vbCrLf _
        ''& " SELECT ID.ALTER_RM_CODE AS ITEM_CODE " & vbCrLf _
        ''& " FROM PRD_NEWBOM_HDR IH, PRD_BOM_ALTER_DET ID" & vbCrLf _
        ''& " WHERE IH.COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND IH.MKEY=ID.MKEY" & vbCrLf _
        ''& " AND ID.ALTER_RM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
        ''& " AND IH.STATUS='O'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckItemConsumptionExists = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckItemExistsInBOM(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckItemExistsInBOM = False
        If pItemCode = "" Then
            Exit Function
        End If

        mSqlStr = "SELECT ID.RM_CODE AS ITEM_CODE " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.RM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.STATUS='O'"
        mSqlStr = mSqlStr & vbCrLf & "UNION"
        mSqlStr = mSqlStr & vbCrLf & " SELECT ID.ALTER_RM_CODE AS ITEM_CODE " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_BOM_ALTER_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.ALTER_RM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.STATUS='O'"
        mSqlStr = mSqlStr & vbCrLf & "UNION"
        mSqlStr = mSqlStr & vbCrLf & "SELECT ID.ITEM_CODE AS ITEM_CODE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.STATUS='O'"
        mSqlStr = mSqlStr & vbCrLf & "UNION"
        mSqlStr = mSqlStr & vbCrLf & " SELECT ID.ALTER_ITEM_CODE AS ITEM_CODE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_ALTER_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.ALTER_ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.STATUS='O'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckItemExistsInBOM = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckTCRequired(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckTCRequired = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_TC_REQ " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_TC_REQ").Value), "Y", RsTemp.Fields("IS_TC_REQ").Value)
            CheckTCRequired = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckTPInspRequired(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckTPInspRequired = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_TPI_REQ " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_TPI_REQ").Value), "Y", RsTemp.Fields("IS_TPI_REQ").Value)
            CheckTPInspRequired = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function ExtractFileName(ByRef strFullPath As String) As String
        ExtractFileName = ""
        If Trim(strFullPath) <> "" Then
            ExtractFileName = Right(strFullPath, Len(strFullPath) - InStrRev(strFullPath, "\"))
            ''sFilename = Mid(sFilenamewithpath, InStrRev(sFilenamewithpath, "\") + 1, Len(sFilenamewithpath))
        End If
    End Function
    Public Function GetExtensionName(ByRef strFullPath As String) As String
        Dim I As Integer
        Dim c As String
        Dim pos As Integer
        GetExtensionName = ""
        If Trim(strFullPath) <> "" Then
            For I = Len(strFullPath) To 2 Step -1
                c = Mid(strFullPath, I, 1)
                If c = "." Then
                    pos = I + 1
                    Exit For
                End If
            Next
            GetExtensionName = Mid(strFullPath, pos, Len(strFullPath) + 1 - pos)
            'ExtractFileExtName = Right(strFullPath, Len(strFullPath) - InStrRev(strFullPath, "\"))
            ''sFilename = Mid(sFilenamewithpath, InStrRev(sFilenamewithpath, "\") + 1, Len(sFilenamewithpath))
        End If
    End Function
    Public Function ValidateAccountLocking(ByRef pPvtDBCn As ADODB.Connection, ByRef pLockDate As String, ByRef pACName As String, Optional ByRef pACCode As String = "") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsAcLock As ADODB.Recordset = Nothing
        Dim mLockDateFrom As String = ""
        Dim mLockDateTo As String = ""
        If pLockDate = "" Or pACName = "" Then ValidateAccountLocking = False : Exit Function
        If pACCode = "-1" Or pACCode = "0" Or pACCode = "" Then
            MainClass.ValidateWithMasterTable(pACName, "SUPP_CUST_Name", "SUPP_CUST_Code", "FIN_SUPP_CUST_MST", pPvtDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
            pACCode = MasterNo
        End If
        SqlStr = "SELECT LockDateFrom,LockDateTo FROM FIN_SUPP_CUST_MST WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND SUPP_CUST_Code='" & pACCode & "' "
        MainClass.UOpenRecordSet(SqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsAcLock, ADODB.LockTypeEnum.adLockReadOnly)
        With RsAcLock
            If .EOF = False Then
                mLockDateFrom = IIf(IsDBNull(.Fields("Lockdatefrom").Value), "", .Fields("Lockdatefrom").Value)
                mLockDateTo = IIf(IsDBNull(.Fields("Lockdateto").Value), "", .Fields("Lockdateto").Value)
            End If
        End With
        If mLockDateFrom = "" Or mLockDateTo = "" Then ValidateAccountLocking = False : Exit Function
        If CDate(pLockDate) >= CDate(mLockDateFrom) And CDate(pLockDate) <= CDate(mLockDateTo) Then
            MsgInformation("Account Of : " & pACName & " Been Locked For The Period " & vbCrLf & "From : " & mLockDateFrom & " To : " & mLockDateTo & vbCrLf & "So Unable to Save or Delete. Contact your System Administrator.")
            ValidateAccountLocking = True
        Else
            ValidateAccountLocking = False
        End If
        Exit Function
ErrPart:
        ValidateAccountLocking = True
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetSubCategoryName(ByRef mItemCode As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetSubCategoryName = ""
        If mItemCode = "" Then Exit Function
        mSqlStr = " SELECT SUBCATMST.SUBCATEGORY_DESC " & vbCrLf & " FROM INV_ITEM_MST INVMST, INV_SUBCATEGORY_MST SUBCATMST" & vbCrLf & " WHERE " & vbCrLf & " INVMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND INVMST.COMPANY_CODE=SUBCATMST.COMPANY_CODE" & vbCrLf & " AND INVMST.CATEGORY_CODE=SUBCATMST.CATEGORY_CODE" & vbCrLf & " AND INVMST.SUBCATEGORY_CODE=SUBCATMST.SUBCATEGORY_CODE" & vbCrLf & " AND INVMST.ITEM_CODE='" & mItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetSubCategoryName = IIf(IsDBNull(RsTemp.Fields("SUBCATEGORY_DESC").Value), "", RsTemp.Fields("SUBCATEGORY_DESC").Value)
        End If
        Exit Function
ErrPart:
        GetSubCategoryName = ""
    End Function
    Public Function GetServerTimeWithSecond() As String
        Dim RS As ADODB.Recordset = Nothing
        MainClass.UOpenRecordSet("SELECT TO_CHAR(SYSDATE,'HH24:MI:SS') FROM DUAL", PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        GetServerTimeWithSecond = VB6.Format(RS.Fields(0).Value, "HH:mm:SS")
        RS.Close()
        RS = Nothing
    End Function
    Public Function GetHSNDetails(ByRef mHSNCode As String, ByRef pCGSTPer As Double, ByRef pSGSTPer As Double, ByRef pIGSTPer As Double,
                                  ByRef mLocal As String, ByRef mGSTStatus As String, ByRef mPartyGSTNo As String, Optional ByRef pRCApplicable As String = "", Optional ByRef pCreditApplicable As String = "",
                                  Optional ByRef pExempted As String = "", Optional ByRef pMerchantExporter As String = "N") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCompanyGSTNo As String
        Dim mGSTPer As Double
        Dim mGSTRegd As String
        pCGSTPer = 0
        pSGSTPer = 0
        pIGSTPer = 0
        If Trim(mHSNCode) = "" Then GetHSNDetails = True : Exit Function
        If (mGSTStatus = "E" Or mGSTStatus = "N" Or mGSTStatus = "D" Or mGSTStatus = "W") Then GetHSNDetails = True : Exit Function 'Or mGSTStatus = "C"
        mCompanyGSTNo = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
        mGSTRegd = IIf(mPartyGSTNo = "", "N", "Y")

        If pMerchantExporter = "Y" Then
            mGSTPer = 0.1
            If mLocal = "Y" Then
                pCGSTPer = Format(mGSTPer / 2, "0.00")
                pSGSTPer = Format(mGSTPer / 2, "0.00")
            Else
                pIGSTPer = Format(mGSTPer, "0.00")
            End If
            GetHSNDetails = True
            Exit Function
        End If


        'If mPartyGSTNo = mCompanyGSTNo Then GetHSNDetails = True: Exit Function
        SqlStr = "SELECT CGST_PER, SGST_PER, IGST_PER, CGST_PER_UNREG, SGST_PER_UNREG, IGST_PER_UNREG, REVERSE_CHARGE_APP, GST_APP, GST_EXEMPTED,GST_COMPOSIT_PER " & vbCrLf & " FROM GEN_HSN_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND CODETYPE='G'" & vbCrLf & " AND HSN_CODE='" & mHSNCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            pRCApplicable = IIf(IsDBNull(RsTemp.Fields("REVERSE_CHARGE_APP").Value), "N", RsTemp.Fields("REVERSE_CHARGE_APP").Value)
            pCreditApplicable = IIf(IsDBNull(RsTemp.Fields("GST_APP").Value), "N", RsTemp.Fields("GST_APP").Value)
            pExempted = IIf(IsDBNull(RsTemp.Fields("GST_EXEMPTED").Value), "N", RsTemp.Fields("GST_EXEMPTED").Value)
            If mGSTStatus = "C" Then
                If mLocal = "Y" Then
                    mGSTPer = IIf(IsDBNull(RsTemp.Fields("GST_COMPOSIT_PER").Value), 0, RsTemp.Fields("GST_COMPOSIT_PER").Value)
                    pCGSTPer = CDbl(VB6.Format(mGSTPer / 2, "0.00"))
                    pSGSTPer = CDbl(VB6.Format(mGSTPer / 2, "0.00"))
                Else
                    pIGSTPer = CDbl(VB6.Format(mGSTPer, "0.00"))
                End If
            Else
                If mGSTRegd = "Y" Then
                    If mLocal = "Y" Then
                        pCGSTPer = IIf(IsDBNull(RsTemp.Fields("CGST_PER").Value), 0, RsTemp.Fields("CGST_PER").Value)
                        pSGSTPer = IIf(IsDBNull(RsTemp.Fields("SGST_PER").Value), 0, RsTemp.Fields("SGST_PER").Value)
                    Else
                        pIGSTPer = IIf(IsDBNull(RsTemp.Fields("IGST_PER").Value), 0, RsTemp.Fields("IGST_PER").Value)
                    End If
                Else
                    If mLocal = "Y" Then
                        pCGSTPer = IIf(IsDBNull(RsTemp.Fields("CGST_PER_UNREG").Value), 0, RsTemp.Fields("CGST_PER_UNREG").Value)
                        pSGSTPer = IIf(IsDBNull(RsTemp.Fields("SGST_PER_UNREG").Value), 0, RsTemp.Fields("SGST_PER_UNREG").Value)
                    Else
                        pIGSTPer = IIf(IsDBNull(RsTemp.Fields("IGST_PER_UNREG").Value), 0, RsTemp.Fields("IGST_PER_UNREG").Value)
                    End If
                End If
            End If
        End If
        GetHSNDetails = True
        Exit Function
ErrPart:
        GetHSNDetails = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function

    Public Function CheckHSNExempted(ByRef mHSNCode As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mExempted As String

        If Trim(mHSNCode) = "" Then CheckHSNExempted = False : Exit Function

        SqlStr = "SELECT CGST_PER, SGST_PER, IGST_PER, CGST_PER_UNREG, SGST_PER_UNREG, IGST_PER_UNREG, REVERSE_CHARGE_APP, GST_APP, GST_EXEMPTED,GST_COMPOSIT_PER " & vbCrLf _
            & " FROM GEN_HSN_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND HSN_CODE='" & mHSNCode & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            mExempted = IIf(IsDBNull(RsTemp.Fields("GST_EXEMPTED").Value), "N", RsTemp.Fields("GST_EXEMPTED").Value)
        End If

        CheckHSNExempted = IIf(mExempted = "Y", True, False)

        Exit Function
ErrPart:
        CheckHSNExempted = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetSACDetails(ByRef mServCode As String, ByRef pCGSTPer As Double, ByRef pSGSTPer As Double, ByRef pIGSTPer As Double, ByRef mLocal As String, ByRef mPartyGSTNo As String, ByRef mGSTStatus As String, Optional ByRef pRCApplicable As String = "", Optional ByRef pCreditApplicable As String = "", Optional ByRef pExempted As String = "") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCompanyGSTNo As String
        pCGSTPer = 0
        pSGSTPer = 0
        pIGSTPer = 0
        If Trim(mServCode) = "" Then GetSACDetails = True : Exit Function

        If (mGSTStatus = "E" Or mGSTStatus = "N" Or mGSTStatus = "D" Or mGSTStatus = "W") Then GetSACDetails = True : Exit Function 'Or mGSTStatus = "C"

        mCompanyGSTNo = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
        'If mPartyGSTNo = mCompanyGSTNo Then GetSACDetails = True: Exit Function
        SqlStr = "SELECT CGST_PER, SGST_PER, IGST_PER, REVERSE_CHARGE_APP, GST_APP, GST_EXEMPTED " & vbCrLf & " FROM GEN_HSN_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND HSN_CODE='" & mServCode & "'AND CODETYPE='S'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            pRCApplicable = IIf(IsDBNull(RsTemp.Fields("REVERSE_CHARGE_APP").Value), "N", RsTemp.Fields("REVERSE_CHARGE_APP").Value)
            pCreditApplicable = IIf(IsDBNull(RsTemp.Fields("GST_APP").Value), "N", RsTemp.Fields("GST_APP").Value)
            pExempted = IIf(IsDBNull(RsTemp.Fields("GST_EXEMPTED").Value), "N", RsTemp.Fields("GST_EXEMPTED").Value)
            If mLocal = "Y" Then
                pCGSTPer = IIf(IsDBNull(RsTemp.Fields("CGST_PER").Value), 0, RsTemp.Fields("CGST_PER").Value)
                pSGSTPer = IIf(IsDBNull(RsTemp.Fields("SGST_PER").Value), 0, RsTemp.Fields("SGST_PER").Value)
            Else
                pIGSTPer = IIf(IsDBNull(RsTemp.Fields("IGST_PER").Value), 0, RsTemp.Fields("IGST_PER").Value)
            End If
        End If
        GetSACDetails = True
        Exit Function
ErrPart:
        GetSACDetails = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetHSNCode(ByRef mItemCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetHSNCode = ""
        If Trim(mItemCode) = "" Then Exit Function

        SqlStr = "SELECT HSN_CODE " & vbCrLf _
            & " FROM INV_ITEM_MST IMST " & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            GetHSNCode = IIf(IsDBNull(RsTemp.Fields("HSN_CODE").Value), "", RsTemp.Fields("HSN_CODE").Value)
        End If
        Exit Function
ErrPart:
        GetHSNCode = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function

    Public Function GetPortData(ByRef mPortCode As String, ByRef pFieldName As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetPortData = ""

        If Trim(mPortCode) = "" Then Exit Function

        SqlStr = "SELECT " & pFieldName & " AS FIELD_NAME " & vbCrLf _
            & " FROM GEN_PORT_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PORT_CODE='" & MainClass.AllowSingleQuote(mPortCode) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)

        If RsTemp.EOF = False Then
            GetPortData = IIf(IsDBNull(RsTemp.Fields("FIELD_NAME").Value), "", RsTemp.Fields("FIELD_NAME").Value)
        End If
        Exit Function
ErrPart:
        GetPortData = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function

    Public Function GetSACCode(ByRef mServiceName As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetSACCode = ""
        If Trim(mServiceName) = "" Then Exit Function
        SqlStr = "SELECT HSN_CODE " & vbCrLf & " FROM GEN_HSN_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND HSN_DESC='" & MainClass.AllowSingleQuote(mServiceName) & "' AND CODETYPE='S'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            GetSACCode = IIf(IsDBNull(RsTemp.Fields("HSN_CODE").Value), "", RsTemp.Fields("HSN_CODE").Value)
        End If
        Exit Function
ErrPart:
        GetSACCode = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GeteWaySetupContents(ByRef url As String, ByRef pCompanyId As String, ByRef pBranchId As String, ByRef pTokenId As String, ByRef pUserId As String, ByRef pAPIType As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GeteWaySetupContents = False
        url = ""
        SqlStr = "SELECT * " & vbCrLf & " FROM GEN_EWAYSETUP_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            If pAPIType = "C" Then
                url = IIf(IsDBNull(RsTemp.Fields("CREATE_URL").Value), "", RsTemp.Fields("CREATE_URL").Value)
            ElseIf pAPIType = "U" Then
                url = IIf(IsDBNull(RsTemp.Fields("UPDATE_URL").Value), "", RsTemp.Fields("UPDATE_URL").Value)
            ElseIf pAPIType = "G" Then
                url = IIf(IsDBNull(RsTemp.Fields("GENERATE_URL").Value), "", RsTemp.Fields("GENERATE_URL").Value)
            ElseIf pAPIType = "X" Then
                url = IIf(IsDBNull(RsTemp.Fields("CANCEL_URL").Value), "", RsTemp.Fields("CANCEL_URL").Value)
            ElseIf pAPIType = "F" Then
                url = IIf(IsDBNull(RsTemp.Fields("FATCH_URL").Value), "", RsTemp.Fields("FATCH_URL").Value)
            ElseIf pAPIType = "I" Then
                url = IIf(IsDBNull(RsTemp.Fields("GETBYID_URL").Value), "", RsTemp.Fields("GETBYID_URL").Value)
            End If
            pCompanyId = IIf(IsDBNull(RsTemp.Fields("COMPANY_ID").Value), "", RsTemp.Fields("COMPANY_ID").Value)
            pBranchId = IIf(IsDBNull(RsTemp.Fields("BRANCH_ID").Value), "", RsTemp.Fields("BRANCH_ID").Value)
            pTokenId = IIf(IsDBNull(RsTemp.Fields("TOKEN_ID").Value), "", RsTemp.Fields("TOKEN_ID").Value)
            pUserId = IIf(IsDBNull(RsTemp.Fields("USER_ID").Value), "", RsTemp.Fields("USER_ID").Value)
        End If
        GeteWaySetupContents = True
        Exit Function
ErrPart:
        GeteWaySetupContents = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetDigitalSignName(ByRef pUserId As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDigitalSignName = ""


        SqlStr = "SELECT DS_USERID FROM ATH_PASSWORD_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND USER_ID='" & pUserId & "' AND DIGITAL_SIGN ='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            GetDigitalSignName = IIf(IsDBNull(RsTemp.Fields("DS_USERID").Value), "", RsTemp.Fields("DS_USERID").Value)
        End If
        Exit Function
ErrPart:
        GetDigitalSignName = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetDigitalSignSetupContents(ByRef url As String, ByRef pUserName As String, ByRef pPassword As String, ByRef mAuthorizedSignatory As String,
                                                ByRef pTopLeft As Double, ByRef pBottomLeft As Double, ByRef pTopRight As Double, ByRef pBottomRight As Double,
                                                ByRef mSignerName As String, ByRef pIsTesting As String, ByRef mDSCertidficateNo As String,
                                                ByRef mDSCertificateType As String, ByRef mFontSize As Long, ByRef mFindAuthority As String, ByRef mFindLocation As Long) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDigitalSignSetupContents = False



        url = ""

        SqlStr = "SELECT * " & vbCrLf & " FROM GEN_EWAYSETUP_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            url = IIf(IsDBNull(RsTemp.Fields("DS_URL").Value), "", RsTemp.Fields("DS_URL").Value)
            pUserName = IIf(IsDBNull(RsTemp.Fields("DS_USERID").Value), "", RsTemp.Fields("DS_USERID").Value)
            pPassword = IIf(IsDBNull(RsTemp.Fields("DS_PASSWORD").Value), "", RsTemp.Fields("DS_PASSWORD").Value)
            pTopLeft = IIf(IsDBNull(RsTemp.Fields("DS_TOPLEFT").Value), 0, RsTemp.Fields("DS_TOPLEFT").Value)
            pBottomLeft = IIf(IsDBNull(RsTemp.Fields("DS_BOTTOMLEFT").Value), 0, RsTemp.Fields("DS_BOTTOMLEFT").Value)
            pTopRight = IIf(IsDBNull(RsTemp.Fields("DS_TOPRIGHT").Value), 0, RsTemp.Fields("DS_TOPRIGHT").Value)
            pBottomRight = IIf(IsDBNull(RsTemp.Fields("DS_BOTTOMRIGHT").Value), 0, RsTemp.Fields("DS_BOTTOMRIGHT").Value)
            mAuthorizedSignatory = IIf(IsDBNull(RsTemp.Fields("DS_AUTH_SIGN").Value), "", RsTemp.Fields("DS_AUTH_SIGN").Value)
            pIsTesting = IIf(IsDBNull(RsTemp.Fields("IS_TESTING").Value), "", RsTemp.Fields("IS_TESTING").Value)
            mSignerName = IIf(IsDBNull(RsTemp.Fields("SIGN_NAME").Value), "", RsTemp.Fields("SIGN_NAME").Value)
            mDSCertidficateNo = IIf(IsDBNull(RsTemp.Fields("DS_CERTIFICATE_SNO").Value), "", RsTemp.Fields("DS_CERTIFICATE_SNO").Value)
            mDSCertificateType = IIf(IsDBNull(RsTemp.Fields("DS_CERTIFICATE_TYPE").Value), "", RsTemp.Fields("DS_CERTIFICATE_TYPE").Value)  '', 
            mFontSize = IIf(IsDBNull(RsTemp.Fields("DS_FONT_SIZE").Value), 0, RsTemp.Fields("DS_FONT_SIZE").Value)

            mFindAuthority = IIf(IsDBNull(RsTemp.Fields("DS_FIND_AUTH").Value), "Authorised Signatory", RsTemp.Fields("DS_FIND_AUTH").Value)
            mFindLocation = IIf(IsDBNull(RsTemp.Fields("DS_FIND_AUTH_LOC").Value), 0, RsTemp.Fields("DS_FIND_AUTH_LOC").Value)

        End If
        GetDigitalSignSetupContents = True
        Exit Function
ErrPart:
        GetDigitalSignSetupContents = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function

    Public Function GetDigitalSignTokenDetails(ByVal pUserName As String, ByVal pPassword As String, ByVal mDSCertidficateNo As String,
                                               ByVal mDLLPathName As String, ByVal mDLLFileName As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDigitalSignTokenDetails = False


        SqlStr = "SELECT * " & vbCrLf _
            & " FROM ATH_PASSWORD_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            pUserName = IIf(IsDBNull(RsTemp.Fields("DS_USERID").Value), "", RsTemp.Fields("DS_USERID").Value)
            pPassword = IIf(IsDBNull(RsTemp.Fields("DS_PASSWORD").Value), "", RsTemp.Fields("DS_PASSWORD").Value)
            mDSCertidficateNo = IIf(IsDBNull(RsTemp.Fields("DS_CERTIFICATE_SNO").Value), "", RsTemp.Fields("DS_CERTIFICATE_SNO").Value)
            mDLLPathName = IIf(IsDBNull(RsTemp.Fields("DS_DLL_PATH").Value), "", RsTemp.Fields("DS_DLL_PATH").Value)
            mDLLFileName = IIf(IsDBNull(RsTemp.Fields("DS_DLL_FILENAME").Value), "", RsTemp.Fields("DS_DLL_FILENAME").Value)  '', 
        End If
        GetDigitalSignTokenDetails = True
        Exit Function
ErrPart:
        GetDigitalSignTokenDetails = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function

    Public Function GetWebTeleWaySetupContents(ByRef url As String, ByRef pAPIType As String, ByRef pCDKey As String,
                                               ByRef pEFUserName As String, ByRef pEFPassword As String, ByRef pEWBUserName As String, ByRef pEWBPassword As String, ByRef pIsTesting As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetWebTeleWaySetupContents = False
        url = ""
        SqlStr = "SELECT * " & vbCrLf & " FROM GEN_EWAYSETUP_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            If pAPIType = "C" Then
                url = IIf(IsDBNull(RsTemp.Fields("CREATE_URL_WEBTEL").Value), "", RsTemp.Fields("CREATE_URL_WEBTEL").Value)
            ElseIf pAPIType = "U" Then
                url = IIf(IsDBNull(RsTemp.Fields("UPDATE_URL").Value), "", RsTemp.Fields("UPDATE_URL").Value)
            ElseIf pAPIType = "G" Then
                url = IIf(IsDBNull(RsTemp.Fields("GENERATE_URL").Value), "", RsTemp.Fields("GENERATE_URL").Value)
            ElseIf pAPIType = "X" Then
                url = IIf(IsDBNull(RsTemp.Fields("CANCEL_URL").Value), "", RsTemp.Fields("CANCEL_URL").Value)
            ElseIf pAPIType = "F" Then
                url = IIf(IsDBNull(RsTemp.Fields("FATCH_URL").Value), "", RsTemp.Fields("FATCH_URL").Value)
            ElseIf pAPIType = "I" Then
                url = IIf(IsDBNull(RsTemp.Fields("GETBYID_URL").Value), "", RsTemp.Fields("GETBYID_URL").Value)
            ElseIf pAPIType = "D" Then
                url = IIf(IsDBNull(RsTemp.Fields("DISTANCE_URL").Value), "", RsTemp.Fields("DISTANCE_URL").Value)
            ElseIf pAPIType = "P" Then
                url = IIf(IsDBNull(RsTemp.Fields("PRINT_URL").Value), "", RsTemp.Fields("PRINT_URL").Value)
            ElseIf pAPIType = "IRN" Then
                url = IIf(IsDBNull(RsTemp.Fields("CREATE_IRN_URL_WEBTEL").Value), "", RsTemp.Fields("CREATE_IRN_URL_WEBTEL").Value)
            ElseIf pAPIType = "CON" Then
                url = IIf(IsDBNull(RsTemp.Fields("CONSOL_URL_WEBTEL").Value), "", RsTemp.Fields("CONSOL_URL_WEBTEL").Value)
            ElseIf pAPIType = "CONP" Then
                url = "http://ewayasp.webtel.in/EWayBill/v1.3/GetConsolidatedEWB"
            ElseIf pAPIType = "RECONP" Then
                url = "http://ewayasp.webtel.in/EWayBill/v1.3/ReGetConsolidatedEWB"
            ElseIf pAPIType = "VU" Then
                url = "http://ewayasp.webtel.in/EWayBill/v1.3/UpdateVehicle"
            End If


            pCDKey = IIf(IsDBNull(RsTemp.Fields("CD_KEY").Value), "", RsTemp.Fields("CD_KEY").Value)
            pEFUserName = IIf(IsDBNull(RsTemp.Fields("EF_USERNAME").Value), "", RsTemp.Fields("EF_USERNAME").Value)
            pEFPassword = IIf(IsDBNull(RsTemp.Fields("EF_PASSWORD").Value), "", RsTemp.Fields("EF_PASSWORD").Value)
            pEWBUserName = IIf(IsDBNull(RsTemp.Fields("EWB_USERNAME").Value), "", RsTemp.Fields("EWB_USERNAME").Value)
            pEWBPassword = IIf(IsDBNull(RsTemp.Fields("EWB_PASSWORD").Value), "", RsTemp.Fields("EWB_PASSWORD").Value)
            pIsTesting = IIf(IsDBNull(RsTemp.Fields("IS_TESTING").Value), "", RsTemp.Fields("IS_TESTING").Value)
        End If
        GetWebTeleWaySetupContents = True
        Exit Function
ErrPart:
        GetWebTeleWaySetupContents = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GeteInvoiceSetupContents(ByRef url As String, ByRef pAPIType As String, ByRef pCDKey As String, ByRef pEFUserName As String,
                                             ByRef pEFPassword As String, ByRef pEINVUserName As String, ByRef pEINVPassword As String, ByRef pIsTesting As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GeteInvoiceSetupContents = False
        url = ""
        SqlStr = "SELECT * " & vbCrLf & " FROM GEN_EINVSETUP_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            If pAPIType = "G" Then
                url = IIf(IsDBNull(RsTemp.Fields("GENERATE_URL").Value), "", RsTemp.Fields("GENERATE_URL").Value)
            ElseIf pAPIType = "C" Then
                url = IIf(IsDBNull(RsTemp.Fields("CANCEL_URL").Value), "", RsTemp.Fields("CANCEL_URL").Value)
            ElseIf pAPIType = "I" Then
                url = IIf(IsDBNull(RsTemp.Fields("GETBYIRN_URL").Value), "", RsTemp.Fields("GETBYIRN_URL").Value)
            ElseIf pAPIType = "P" Then
                url = IIf(IsDBNull(RsTemp.Fields("PRINT_INV_URL").Value), "", RsTemp.Fields("PRINT_INV_URL").Value)
            ElseIf pAPIType = "E" Then
                url = IIf(IsDBNull(RsTemp.Fields("GENERATE_EWAY_URL").Value), "", RsTemp.Fields("GENERATE_EWAY_URL").Value)
            End If
            pCDKey = IIf(IsDBNull(RsTemp.Fields("CD_KEY").Value), "", RsTemp.Fields("CD_KEY").Value)
            pEFUserName = IIf(IsDBNull(RsTemp.Fields("EF_USERNAME").Value), "", RsTemp.Fields("EF_USERNAME").Value)
            pEFPassword = IIf(IsDBNull(RsTemp.Fields("EF_PASSWORD").Value), "", RsTemp.Fields("EF_PASSWORD").Value)
            pEINVUserName = IIf(IsDBNull(RsTemp.Fields("E_INV_USERNAME").Value), "", RsTemp.Fields("E_INV_USERNAME").Value)
            pEINVPassword = IIf(IsDBNull(RsTemp.Fields("E_INV_PASSWORD").Value), "", RsTemp.Fields("E_INV_PASSWORD").Value)
            pIsTesting = IIf(IsDBNull(RsTemp.Fields("IS_TESTING").Value), "", RsTemp.Fields("IS_TESTING").Value)
        End If
        GeteInvoiceSetupContents = True
        Exit Function
ErrPart:
        GeteInvoiceSetupContents = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    'Public Function WebRequestFetch(ByRef peWayBillNo As String) As Boolean
    'On Error GoTo ErrPart
    'Dim url As String
    'Dim pUserGSTin As String
    'Dim mSqlStr As String
    'Dim RsTemp As ADODB.Recordset = Nothing=Nothing= Nothing=Nothing=NOthing
    'Dim pStaus As String
    'Dim meWayResponseID As String
    'Dim mBody As String
    'Dim meWayBillNoStr As String
    'Dim url1 As String
    'Dim pCompanyId As String
    'Dim pBranchId As String
    'Dim pTokenId As String
    'Dim pUserId As String
    'Dim pResponseIdText As String
    'Dim pError As String
    'Dim FilePath As String
    'WebRequestFetch = True
    'Exit Function
    'Dim http As MSXML2.XMLHTTP60 '' MSXML.xmlhttp
    'http = CreateObject("MSXML2.ServerXMLHTTP")
    ''peWayBillNo = "391010965783"
    'meWayBillNoStr = "{""ewbNo"":""" & peWayBillNo & """}"
    'If GeteWaySetupContents(url, pCompanyId, pBranchId, pTokenId, pUserId, "F") = False Then GoTo ErrPart
    'http.Open("POST", url, False)
    'http.setRequestHeader("Content-Type", "application/json")
    'http.setRequestHeader("idCompany", pCompanyId) ''84
    'http.setRequestHeader("idBranch", pBranchId) ''102
    'http.setRequestHeader("token", pTokenId) '' "b9979d7e-28be-4ba1-b07e-ac5557ef3499"
    'http.setRequestHeader("idUser", pUserId) ''9230
    'http.Send(meWayBillNoStr)
    'pResponseIdText = http.responseText
    'Dim JsonTest As Object
    'JsonTest = JSON.parse(pResponseIdText)
    'pStaus = JsonTest.Item("status")
    'If UCase(pStaus) = "FALSE" Then
    ''pError = JsonTest.Item("errors").Item(1).Item("description") & "," & JsonTest.Item("errors").Item(1).Item("message")''Item("items").Item(1).Item("url")
    'MsgInformation(pError)
    'WebRequestFetch = False
    'http = Nothing
    'Exit Function
    'End If
    ''meWayResponseID = JsonTest.Item("elements").Item(mResponseId).Item("ewayBillNo") '' JsonTest.Item("message")
    ''meWayBillDate = JsonTest.Item("elements").Item(mResponseId).Item("ewayBillDate")
    ''meWayBillUpto = JsonTest.Item("elements").Item(mResponseId).Item("validUpto")
    ''meWayFilePath = JsonTest.Item("elements").Item(mResponseId).Item("filePath")
    'WebRequestFetch = True
    'http = Nothing
    'Exit Function
    'ErrPart:
    ''Resume
    'WebRequestFetch = False
    'MsgBox(Err.Description)
    'End Function
    Public Function GetItemPurchaseInvoiceType(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetItemPurchaseInvoiceType = ""
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT CMST.PURCHASEINVTYPECODE " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetItemPurchaseInvoiceType = IIf(IsDBNull(RsTemp.Fields("PURCHASEINVTYPECODE").Value), "", RsTemp.Fields("PURCHASEINVTYPECODE").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCostingRequired(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        GetCostingRequired = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_COSTING_REQ " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & pItemCode & "'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_COSTING_REQ").Value), "Y", RsTemp.Fields("IS_COSTING_REQ").Value)
            GetCostingRequired = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPartyAddress(ByRef pPartyCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = " SELECT SUPP_CUST_ADDR, SUPP_CUST_CITY, SUPP_CUST_STATE, SUPP_CUST_PIN, SUPP_CUST_PHONE " & vbCrLf & " FROM FIN_SUPP_CUST_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pPartyCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetPartyAddress = IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_ADDR").Value), "", RsTemp.Fields("SUPP_CUST_ADDR").Value)
            GetPartyAddress = GetPartyAddress & ", " & IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_CITY").Value), "", RsTemp.Fields("SUPP_CUST_CITY").Value)
            GetPartyAddress = GetPartyAddress & " -" & IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_STATE").Value), "", RsTemp.Fields("SUPP_CUST_STATE").Value)
            GetPartyAddress = GetPartyAddress & " -" & IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_PIN").Value), "", RsTemp.Fields("SUPP_CUST_PIN").Value)
        Else
            GetPartyAddress = ""
        End If
        Exit Function
ErrPart:
        GetPartyAddress = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckExcessDSApprovalQty(ByRef pItemCode As String, ByRef pDate As String, ByRef pSuppCode As String, ByRef mDSQty As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mAppQty As Double
        CheckExcessDSApprovalQty = 0
        SqlStr = " SELECT SUM(ID.APP_QTY) AS APP_QTY " & vbCrLf & " FROM INV_EXCESS_DS_APP_HDR IH , INV_EXCESS_DS_APP_DET ID" & vbCrLf & " Where IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND ID.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "'" & vbCrLf & " AND TO_CHAR(IH.SCHD_DATE,'YYYYMM')='" & VB6.Format(pDate, "YYYYMM") & "' AND IH.IS_APPROVED='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckExcessDSApprovalQty = IIf(IsDBNull(RsTemp.Fields("APP_QTY").Value), 0, RsTemp.Fields("APP_QTY").Value)
        End If
        Exit Function
ErrPart:
        CheckExcessDSApprovalQty = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckInterChangeDSApprovalQty(ByRef pItemCode As String, ByRef pDate As String, ByRef pSuppCode As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mAppQty As Double
        CheckInterChangeDSApprovalQty = 0
        SqlStr = " SELECT SUM(IC_QTY) AS IC_QTY " & vbCrLf & " FROM PUR_DS_INTERCHANGE_HDR IH, PUR_DS_INTERCHANGE_DET ID" & vbCrLf & " Where IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.REF_NO=ID.REF_NO " & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND ID.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "'" & vbCrLf & " AND TO_CHAR(SCHD_DATE,'YYYYMM')='" & VB6.Format(pDate, "YYYYMM") & "' " & vbCrLf & " AND ISAPPROVAL='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckInterChangeDSApprovalQty = IIf(IsDBNull(RsTemp.Fields("IC_QTY").Value), 0, RsTemp.Fields("IC_QTY").Value)
        End If
        Exit Function
ErrPart:
        CheckInterChangeDSApprovalQty = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckItemLock(ByRef mItemCode As String, ByRef pFieldType As String, ByRef mSupplierCode As String) As Boolean
        On Error GoTo ShowErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFieldName As String = ""
        Dim mIsItemLock As String
        CheckItemLock = False

        If pFieldType = "M" Then
            mFieldName = "MRR_LOCK"
        ElseIf pFieldType = "O" Then
            mFieldName = "MRR_LOCK_OVERMAX"
        ElseIf pFieldType = "S" Then
            mFieldName = "SCHEDULE_LOCK"
        End If

        SqlStr = " SELECT " & mFieldName & " AS ITEM_LOCK " & vbCrLf _
            & " FROM INV_ITEM_MST" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mIsItemLock = IIf(IsDBNull(RsTemp.Fields("ITEM_LOCK").Value), "N", RsTemp.Fields("ITEM_LOCK").Value)
            CheckItemLock = IIf(mIsItemLock = "N", False, True)
        End If

        If CheckItemLock = True Then Exit Function

        If pFieldType = "M" Then
            SqlStr = " SELECT ITEM_LOCK " & vbCrLf _
                & " FROM FIN_SUPP_CUST_DET" & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "'" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'"
            '
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

            If RsTemp.EOF = False Then
                mIsItemLock = IIf(IsDBNull(RsTemp.Fields("ITEM_LOCK").Value), "N", RsTemp.Fields("ITEM_LOCK").Value)
                CheckItemLock = IIf(mIsItemLock = "N", False, True)
            End If
        End If

        Exit Function
ShowErrPart:
        MsgBox(Err.Description)
        'Resume
    End Function
    Public Function GetInventoryLevelQty(ByRef pItemCode As String, ByRef pFieldName As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetInventoryLevelQty = 0
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT " & pFieldName & " AS FIELD_NAME " & vbCrLf & " FROM INV_ITEM_MST IMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetInventoryLevelQty = IIf(IsDBNull(RsTemp.Fields("FIELD_NAME").Value), 0, RsTemp.Fields("FIELD_NAME").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckAutoIssue(ByRef xDate As String, ByRef pRMCode As String) As Boolean
        On Error GoTo ErrPart
        Dim xAutoIssue As Boolean
        Dim mProductType As String

        If RsCompany.Fields("AUTO_ISSUE").Value = "N" Then
            CheckAutoIssue = False
        Else
            If CDate(VB6.Format(xDate, "DD/MM/YYYY")) < CDate(VB6.Format(RsCompany.Fields("AUTO_ISSUE_DATE").Value, "DD/MM/YYYY")) Then
                CheckAutoIssue = False
            Else
                CheckAutoIssue = True
            End If
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckBalDemandedQty(ByRef pSprd As AxFPSpreadADO.AxfpSpread, ByRef pColDemand As Integer, ByRef pColIssue As Integer) As Boolean
        On Error GoTo ErrPart
        Dim cntRow As Integer
        Dim mDemandedQty As Double
        Dim mIssueQty As Double
        CheckBalDemandedQty = True
        With pSprd
            For cntRow = 1 To .MaxRows - 1
                .Row = cntRow
                .Col = pColDemand
                mDemandedQty = Val(.Text)
                .Col = pColIssue
                mIssueQty = Val(.Text)
                If mDemandedQty <> mIssueQty Then
                    CheckBalDemandedQty = False
                    Exit Function
                End If
            Next
        End With
        Exit Function
ErrPart:
        CheckBalDemandedQty = False
    End Function
    '    Public Function CheckIsER1CategoryCode(ByRef pItemCode As String) As Boolean
    '        On Error GoTo ErrPart
    '        Dim SqlStr As String=""
    '        Dim RsTemp As ADODB.Recordset = Nothing
    '        SqlStr = " SELECT GEN_CODE FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE" & vbCrLf & " AND IMST.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND CMST.GEN_TYPE='C' AND CMST.ER_ITEM='Y'"
    '        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
    '        If RsTemp.EOF = False Then
    '            CheckIsER1CategoryCode = True
    '        Else
    '            CheckIsER1CategoryCode = False
    '        End If
    '        Exit Function
    'ErrPart:
    '        CheckIsER1CategoryCode = False
    '    End Function
    Public Function UpdateLotInPaintStock(ByRef pSNo As Integer, ByRef pReqNo As String, ByRef pReqDate As String, ByRef pItemCode As String, ByRef pUOM As String, ByRef pIssueQty As Double, ByRef pDeptName As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mRunningBal As Double
        Dim mINQty As Double
        Dim mLotNo As String = ""
        If pIssueQty = 0 Then
            UpdateLotInPaintStock = True
            Exit Function
        End If
        mRunningBal = pIssueQty
        ''New.....
        SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY*CASE WHEN REF_TYPE='" & ConStockRefType_ISS & "' AND REF_NO=" & pReqNo & " THEN 0 ELSE 1 END) AS ITEM_QTY, " & vbCrLf & " LOT_NO FROM INV_PAINT_STOCK_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & pItemCode & "'" & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY*CASE WHEN REF_TYPE='" & ConStockRefType_ISS & "' AND REF_NO=" & pReqNo & " THEN 0 ELSE 1 END)>0 " & vbCrLf & " GROUP BY LOT_NO " & vbCrLf & " ORDER BY LOT_NO"
        ''& " AND REF_TYPE='" & ConStockRefType_MRR & "'" & vbCrLf _
        '
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        Do While RsTemp.EOF = False
            If mRunningBal > 0 Then
                If RsTemp.EOF = False Then
                    mINQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                    mLotNo = Trim(IIf(IsDBNull(RsTemp.Fields("LOT_NO").Value), "", RsTemp.Fields("LOT_NO").Value))
                End If
                If mRunningBal >= mINQty Then
                    mRunningBal = mRunningBal - mINQty
                    pIssueQty = mINQty
                ElseIf mRunningBal < mINQty Then
                    pIssueQty = mRunningBal
                    mRunningBal = 0
                End If
                If mLotNo <> "" Then
                    If UpdatePaintStockTRN(PubDBCn, ConStockRefType_ISS, pReqNo, pSNo, pReqDate, "ST", pItemCode, pUOM, "-1", mLotNo, pIssueQty, 0, "O", "N", "To : " & pDeptName) = False Then GoTo ErrPart
                End If
            End If
            RsTemp.MoveNext()
        Loop
        UpdateLotInPaintStock = True
        Exit Function
ErrPart:
        UpdateLotInPaintStock = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckRGPApproval(ByRef pItemCode As String, ByRef pDate As String, ByRef pSuppCode As String, ByRef pBookType As String, ByRef pReqQty As Double, ByRef pRefNo As Double) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mTodaySendQty As Double
        Dim pQtyApproved As Double
        CheckRGPApproval = False
        pQtyApproved = 0
        mTodaySendQty = 0
        SqlStr = " SELECT SUM(ITEM_QTY) AS ITEM_QTY " & vbCrLf & " FROM INV_RGP_SLIP_HDR IH, INV_RGP_SLIP_DET ID" & vbCrLf & " WHERE IH.AUTO_KEY_RGPSLIP=ID.AUTO_KEY_RGPSLIP" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.FROM_ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "'" & vbCrLf & " AND IH.RGP_SLIP_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') "
        If pRefNo > 0 Then
            SqlStr = SqlStr & " AND IH.AUTO_KEY_RGPSLIP<>" & Val(CStr(pRefNo)) & ""
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mTodaySendQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
        End If
        mTodaySendQty = mTodaySendQty + pReqQty
        SqlStr = " SELECT SUM(APPROVED_QTY) AS APPROVED_QTY " & vbCrLf & " FROM INV_RGP_APP_DET" & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "'" & vbCrLf & " AND RGP_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') "
        If pBookType = "P" Then
            SqlStr = SqlStr & " AND BOOKTYPE='" & pBookType & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            pQtyApproved = IIf(IsDBNull(RsTemp.Fields("APPROVED_QTY").Value), 0, RsTemp.Fields("APPROVED_QTY").Value)
        End If
        If pQtyApproved >= mTodaySendQty Then
            CheckRGPApproval = True
        End If
        Exit Function
ErrPart:
        CheckRGPApproval = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function IsProductionItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mProductionType As String
        Dim mAutoIssue As String = "N"
        mProductionType = "G"
        IsProductionItem = False

        mSqlStr = "SELECT PRD_TYPE,AUTO_MOVEMENT " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & Trim(pItemCode) & "'"
        mSqlStr = mSqlStr & vbCrLf & " AND CMST.STOCKTYPE<>'FG'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mProductionType = IIf(IsDBNull(RsTemp.Fields("PRD_TYPE").Value), "G", RsTemp.Fields("PRD_TYPE").Value)
            mAutoIssue = IIf(IsDBNull(RsTemp.Fields("AUTO_MOVEMENT").Value), "N", RsTemp.Fields("AUTO_MOVEMENT").Value)
        End If
        ''23-04-2011
        'If mProductionType = "P" Or mProductionType = "J" Then
        If mAutoIssue = "Y" Then
            IsProductionItem = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function IsInHouseItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        IsInHouseItem = False
        mSqlStr = "SELECT PRD_TYPE " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C' AND CMST.PRD_TYPE='I'" & vbCrLf & " AND IMST.ITEM_CODE='" & Trim(pItemCode) & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            IsInHouseItem = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function IsFGItem(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        IsFGItem = False

        If RsCompany.Fields("IS_WAREHOUSE").Value = "Y" Then
            Exit Function
        End If

        mSqlStr = "SELECT PRD_TYPE " & vbCrLf _
            & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf _
            & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf _
            & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf _
            & " AND CMST.GEN_TYPE='C'" & vbCrLf _
            & " AND IMST.ITEM_CODE='" & pItemCode & "'"

        mSqlStr = mSqlStr & vbCrLf & " AND (CMST.STOCKTYPE='FG' )" ''OR CMST.PRD_TYPE='I'

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            IsFGItem = True
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function IsFGInvoice(ByRef pInvoiceNo As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIsSaleComp As String

        If RsCompany.Fields("StockBalCheck").Value = "N" Or pInvoiceNo < 0 Then
            IsFGInvoice = True
            Exit Function
        End If
        IsFGInvoice = False
        mSqlStr = "SELECT ISSALECOMP " & vbCrLf & " FROM FIN_INVOICE_HDR IH, FIN_INVTYPE_MST ITYPE" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.COMPANY_CODE=ITYPE.COMPANY_CODE " & vbCrLf & " AND IH.TRNTYPE=ITYPE.CODE " & vbCrLf & " AND IH.AUTO_KEY_INVOICE=" & pInvoiceNo & "" & vbCrLf & " AND ITYPE.ISSALECOMP='Y' AND CANCELLED='N'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mIsSaleComp = IIf(IsDBNull(RsTemp.Fields("ISSALECOMP").Value), "N", RsTemp.Fields("ISSALECOMP").Value)
            IsFGInvoice = IIf(mIsSaleComp = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPhysicalBalance(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pStock_ID As String, ByRef pStockType As String, ByRef pDeptCode As String, ByRef pDivCode As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = "SELECT SUM(ID.PHY_QTY*DECODE(ID.ITEM_IO,'I',1,-1)) AS BALQTY"
        SqlStr = SqlStr & vbCrLf & " FROM INV_PHY_HDR IH, INV_PHY_DET ID "
        SqlStr = SqlStr & vbCrLf & " WHERE IH.AUTO_KEY_PHY=ID.AUTO_KEY_PHY AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        If pStock_ID <> "" Then
            SqlStr = SqlStr & vbCrLf & "AND IH.BOOKTYPE='" & pStock_ID & "'"
        End If
        If pDivCode > 0 Then
            SqlStr = SqlStr & vbCrLf & "AND IH.DIV_CODE=" & pDivCode & ""
        End If
        If pStockType <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ID.STOCK_TYPE ='" & pStockType & "'"
        End If
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND IH.DEPT_CODE='" & pDeptCode & "'"
            'Else''If pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            '02-08-2006
            ''SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If
        SqlStr = SqlStr & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND IH.PHY_DATE=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetPhysicalBalance = mBalQty
        Exit Function
ErrPart:
        GetPhysicalBalance = 0
    End Function
    Public Function GetPOQty(ByRef pItemCode As String, ByRef pPONO As Double, ByRef pUOM As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFinishedJobCode As String
        GetPOQty = 0
        If pItemCode = "" Then
            Exit Function
        End If
        ' * INVMST.UOM_FACTOR
        SqlStr = " SELECT SUM(ITEM_QTY * DECODE(PURCHASE_UOM,'" & pUOM & "',1,INVMST.UOM_FACTOR)) AS ITEM_QTY" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID, INV_ITEM_MST INVMST" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=INVMST.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=INVMST.ITEM_CODE" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PO_STATUS='Y' AND IH.PO_CLOSED='N'" & vbCrLf & " AND ID.ITEM_CODE = '" & MainClass.AllowSingleQuote(pItemCode) & "' " & vbCrLf & " AND IH.AUTO_KEY_PO=" & pPONO & "" & vbCrLf & " AND IH.MKEY = (SELECT MAX(IHH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR IHH, PUR_PURCHASE_DET IDD" & vbCrLf & " WHERE IHH.MKEY=IDD.MKEY" & vbCrLf & " AND IHH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IHH.PO_STATUS='Y' AND IHH.PO_CLOSED='N'" & vbCrLf & " AND IDD.ITEM_CODE= '" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IHH.AUTO_KEY_PO=" & pPONO & ")"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                GetPOQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
            End If
        End With
        Exit Function
ErrPart:
        GetPOQty = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function ValidatePurchaseOrder(ByRef pItemCode As String, ByRef pPONO As Double, ByRef pRefType As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        ValidatePurchaseOrder = False

        SqlStr = " SELECT IH.MKEY" & vbCrLf _
            & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID" & vbCrLf _
            & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.PO_STATUS='Y' AND IH.PO_CLOSED='N'"

        If Trim(pItemCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ID.ITEM_CODE ='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        End If

        SqlStr = SqlStr & vbCrLf & " AND IH.AUTO_KEY_PO=" & pPONO & ""
        SqlStr = SqlStr & vbCrLf & " AND IH.PUR_TYPE='" & pRefType & "'"

        SqlStr = SqlStr & vbCrLf & " AND IH.MKEY = (SELECT MAX(IHH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR IHH, PUR_PURCHASE_DET IDD" & vbCrLf & " WHERE IHH.MKEY=IDD.MKEY" & vbCrLf & " AND IHH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IHH.PO_STATUS='Y' AND IHH.PO_CLOSED='N'"

        If Trim(pItemCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND IDD.ITEM_CODE ='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        End If

        SqlStr = SqlStr & vbCrLf & " AND IHH.AUTO_KEY_PO=" & pPONO & ")"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                ValidatePurchaseOrder = True
                Exit Function
            End If
        End With
        Exit Function
ErrPart:
        ValidatePurchaseOrder = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetRGPQty(ByRef pItemCode As String, ByRef pPONO As Double, ByRef mIO As String, ByRef pInItemCode As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetRGPQty = 0
        ' * INVMST.UOM_FACTOR
        If mIO = "O" Then
            SqlStr = " SELECT SUM(ITEM_QTY) AS ITEM_QTY" & vbCrLf & " FROM INV_GATEPASS_HDR IH, INV_GATEPASS_DET ID, INV_ITEM_MST INVMST" & vbCrLf & " WHERE IH.AUTO_KEY_PASSNO=ID.AUTO_KEY_PASSNO" & vbCrLf & " AND IH.COMPANY_CODE=INVMST.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=INVMST.ITEM_CODE" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PURPOSE IN ('B','C')" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "' " & vbCrLf & " AND ID.AUTO_KEY_WO=" & pPONO & ""
        Else
            SqlStr = " SELECT SUM(IN_QTY) AS ITEM_QTY" & vbCrLf & " FROM INV_RGP_OUT_DET WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IN_ITEM_CODE='" & MainClass.AllowSingleQuote(pInItemCode) & "' " & vbCrLf & " AND AUTO_KEY_RGPSLIP IN (" & vbCrLf & " SELECT IH.REQ_NO AS ITEM_QTY" & vbCrLf & " FROM INV_GATEPASS_HDR IH, INV_GATEPASS_DET ID, INV_ITEM_MST INVMST" & vbCrLf & " WHERE IH.AUTO_KEY_PASSNO=ID.AUTO_KEY_PASSNO" & vbCrLf & " AND IH.COMPANY_CODE=INVMST.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=INVMST.ITEM_CODE" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PURPOSE IN ('B','C')" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "' " & vbCrLf & " AND ID.AUTO_KEY_WO=" & pPONO & ")"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                GetRGPQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
            End If
        End With
        Exit Function
ErrPart:
        GetRGPQty = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetWIPLockQty(ByRef mProductCode As String, ByRef mDeptCode As String, ByRef mLockDate As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetWIPLockQty = 0
        mSqlStr = "SELECT SUM(WIP_QTY) AS WIP_QTY " & vbCrLf & " FROM GEN_WIP_STOCK_LOCK" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mProductCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(mDeptCode) & "'" & vbCrLf & " AND TILL_DATE >=TO_DATE('" & VB6.Format(mLockDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetWIPLockQty = IIf(IsDBNull(RsTemp.Fields("WIP_QTY").Value), 0, RsTemp.Fields("WIP_QTY").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetStockQty_Period(ByRef pItemCode As String, ByRef pDateFrom As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String, ByRef pIO As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        ''COMPANY_CODE, FYEAR, STOCK_ID, STOCK_TYPE, ITEM_CODE,REF_DATE
        SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        Else
            If pStockType = "" Then
                SqlStr = SqlStr & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "')"
            Else
                SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
            End If
        End If
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            ''02-08-2006
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If
        If pLotNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & MainClass.AllowSingleQuote(UCase(pLotNo)) & "'"
        End If
        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        If pIO <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ITEM_IO='" & pIO & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND E_DATE>=TO_DATE('" & VB6.Format(pDateFrom, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetStockQty_Period = mBalQty
        Exit Function
ErrPart:
        GetStockQty_Period = 0
    End Function
    Public Function GetStockItemQry(ByRef pCheckString As String, ByRef pIsOrderByCode As String, ByRef pReqDate As String, ByRef pStockID As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mTRNTableName As String
        mTRNTableName = ConInventoryTable

        If pIsOrderByCode = "Y" Then
            SqlStr = " SELECT STOCK.ITEM_CODE,TRIM(ITEM.ITEM_SHORT_DESC),"
        Else
            SqlStr = " SELECT TRIM(ITEM.ITEM_SHORT_DESC), STOCK.ITEM_CODE, "
        End If
        SqlStr = SqlStr & vbCrLf & " STOCK.STOCK_TYPE, SUM(ITEM_QTY * DECODE(ITEM_IO,'I',1,-1)) AS BALANCE"
        SqlStr = SqlStr & vbCrLf & " FROM " & mTRNTableName & " STOCK, " & vbCrLf & " INV_ITEM_MST ITEM "
        SqlStr = SqlStr & vbCrLf & " Where " & vbCrLf & " STOCK.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND STOCK.FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND STOCK.COMPANY_CODE=ITEM.COMPANY_CODE " & vbCrLf & " AND STOCK.ITEM_CODE=ITEM.ITEM_CODE "
        If Trim(pCheckString) <> "" Then
            If pIsOrderByCode = "Y" Then
                SqlStr = SqlStr & vbCrLf & " AND STOCK.ITEM_CODE LIKE '" & MainClass.AllowSingleQuote(UCase(pCheckString)) & "%'"
            Else
                SqlStr = SqlStr & vbCrLf & " AND ITEM.ITEM_SHORT_DESC LIKE '" & MainClass.AllowSingleQuote(UCase(pCheckString)) & "%'"
            End If
        End If
        SqlStr = SqlStr & vbCrLf & " AND STOCK.STOCK_ID='" & pStockID & "'" ''ConWH
        SqlStr = SqlStr & vbCrLf & " AND STOCK.STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pReqDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & "GROUP BY STOCK.ITEM_CODE,TRIM(ITEM.ITEM_SHORT_DESC), STOCK.STOCK_TYPE"
        SqlStr = SqlStr & vbCrLf & "HAVING SUM(ITEM_QTY * DECODE(ITEM_IO,'I',1,-1))<>0"
        If pIsOrderByCode = "Y" Then
            SqlStr = SqlStr & vbCrLf & "ORDER BY STOCK.ITEM_CODE"
        Else
            SqlStr = SqlStr & vbCrLf & "ORDER BY TRIM(ITEM.ITEM_SHORT_DESC)"
        End If
        GetStockItemQry = SqlStr
        Exit Function
ErrPart:
        GetStockItemQry = ""
    End Function
    Public Function GetSameItemCode(ByRef pItemCode As String, Optional ByRef pSPDItemCount As String = "") As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mItemCode As String
        GetSameItemCode = ""
        SqlStr = " SELECT REF_ITEM_CODE FROM INV_ITEM_RELATIONSHIP_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        Do While RsTemp.EOF = False
            If pSPDItemCount = "N" Then
                mItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("REF_ITEM_CODE").Value), "", RsTemp.Fields("REF_ITEM_CODE").Value))
                If MainClass.ValidateWithMasterTable(mItemCode, "ITEM_CODE", "ITEM_CODE", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CLASSIFICATION='S'") = True Then
                    GoTo NextRecd
                End If
            End If
            If GetSameItemCode = "" Then
                GetSameItemCode = "'" & Trim(IIf(IsDBNull(RsTemp.Fields("REF_ITEM_CODE").Value), "", RsTemp.Fields("REF_ITEM_CODE").Value)) & "'"
            Else
                GetSameItemCode = GetSameItemCode & ",'" & Trim(IIf(IsDBNull(RsTemp.Fields("REF_ITEM_CODE").Value), "", RsTemp.Fields("REF_ITEM_CODE").Value)) & "'"
            End If
NextRecd:
            RsTemp.MoveNext()
        Loop
        Exit Function
ErrPart:
        GetSameItemCode = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPurchasePORate(ByRef pPURMKEY As String, ByRef pAsOnDate As String, ByRef pItemCode As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetPurchasePORate = 0
        SqlStr = "SELECT GetITEMPRICE_NEW(1,1,TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),CUST_REF_NO, ITEM_CODE) AS PORATE" & vbCrLf _
            & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.MKEY=ID.MKEY " & vbCrLf _
            & " AND IH.MKEY='" & pPURMKEY & "' AND IH.COMPANY_CODE=GH.COMPANY_CODE AND IH.AUTO_KEY_MRR=GH.AUTO_KEY_MRR AND GH.REF_TYPE IN ('P')" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        SqlStr = SqlStr & vbCrLf & " UNION ALL"

        SqlStr = SqlStr & vbCrLf _
            & "SELECT ITEM_RATE AS PORATE" & vbCrLf _
            & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.MKEY=ID.MKEY " & vbCrLf _
            & " AND IH.MKEY='" & pPURMKEY & "' AND IH.COMPANY_CODE=GH.COMPANY_CODE AND IH.AUTO_KEY_MRR=GH.AUTO_KEY_MRR AND GH.REF_TYPE IN ('I')" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            'Do While Not RsTemp.EOF
            ' GetPurchasePORate = GetPurchasePORate + IIf(IsNull(RsTemp!PORATE), 0, RsTemp!PORATE)
            GetPurchasePORate = IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value)
            ' RsTemp.MoveNext
            'Loop
        End If

        Exit Function
ErrPart:
        Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetDeptType(ByRef pDeptCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = ""
        SqlStr = "SELECT DEPT_TYPE " & vbCrLf _
            & " FROM PAY_DEPT_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetDeptType = IIf(IsDBNull(RsTemp.Fields("DEPT_TYPE").Value), "", RsTemp.Fields("DEPT_TYPE").Value)
        Else
            GetDeptType = "N"
        End If
        Exit Function
ErrPart:
        GetDeptType = "N"
    End Function
    Public Function GetProductFinalDept(ByRef pItemCode As String, ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = ""
        SqlStr = "SELECT DEPT_CODE " & vbCrLf _
            & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        SqlStr = SqlStr & vbCrLf _
            & " AND SERIAL_NO = (SELECT MAX(SERIAL_NO)" & vbCrLf _
            & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"

        SqlStr = SqlStr & vbCrLf _
            & " AND WEF = (" & vbCrLf _
            & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND WEF <=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')))"

        SqlStr = SqlStr & vbCrLf & " AND WEF = (" & vbCrLf _
            & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND WEF <=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetProductFinalDept = IIf(IsDBNull(RsTemp.Fields("DEPT_CODE").Value), "", RsTemp.Fields("DEPT_CODE").Value)
        Else
            GetProductFinalDept = ""
        End If
        Exit Function
ErrPart:
        GetProductFinalDept = ""
    End Function
    Public Function GetMaxProductSeqNo(ByRef pItemCode As String, ByRef pDate As String) As Integer
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mMaxSeq As Integer
        mMaxSeq = 0
        SqlStr = ""
        SqlStr = "SELECT MAX(SERIAL_NO) As SERIAL_NO" & vbCrLf & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF <=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mMaxSeq = IIf(IsDBNull(RsTemp.Fields("SERIAL_NO").Value), 0, RsTemp.Fields("SERIAL_NO").Value)
        Else
            mMaxSeq = 0
        End If
        GetMaxProductSeqNo = mMaxSeq
        Exit Function
ErrPart:
        GetMaxProductSeqNo = 0
    End Function
    Public Function GetProductDept(ByRef pItemCode As String, ByRef pSeqNo As Integer, ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSeq As Integer
        SqlStr = ""
        GetProductDept = ""
        SqlStr = "SELECT DEPT_CODE " & vbCrLf & " FROM PRD_PRODSEQUENCE_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SERIAL_NO=" & Val(CStr(pSeqNo)) & "" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF <=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetProductDept = IIf(IsDBNull(RsTemp.Fields("DEPT_CODE").Value), "", RsTemp.Fields("DEPT_CODE").Value)
        End If
        Exit Function
ErrPart:
        GetProductDept = ""
    End Function
    Public Function GetPendingRGPQty(ByRef pItemCode As String, ByRef pDate As String, ByRef pSuppCode As String, ByRef pAgePeriod As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mRGPDate As String
        Dim mFromDate As String
        GetPendingRGPQty = 0
        pAgePeriod = 0
        mFromDate = "1/01/2020"
        SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',-1,1)*TRN.RGP_QTY) AS BALQTY, RGP_DATE" & vbCrLf & " FROM INV_RGP_REG_TRN TRN" & vbCrLf & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TRN.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "' " & vbCrLf & " AND TRN.OUTWARD_ITEM_CODE='" & pItemCode & "' " & vbCrLf & " AND TRN.RGP_DATE>=TO_DATE('" & VB6.Format(mFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND TRN.RGP_DATE<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND TRN.REF_DATE<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') HAVING SUM(DECODE(ITEM_IO,'I',-1,1)*TRN.RGP_QTY)>0" & vbCrLf & " GROUP BY RGP_DATE ORDER BY RGP_DATE DESC"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                Do While .EOF = False
                    mRGPDate = IIf(IsDBNull(RsTemp.Fields("RGP_DATE").Value), "", RsTemp.Fields("RGP_DATE").Value)
                    If DateDiff(Microsoft.VisualBasic.DateInterval.Day, CDate(mRGPDate), CDate(pDate)) > 15 Then
                        GetPendingRGPQty = GetPendingRGPQty + IIf(IsDBNull(RsTemp.Fields("BAlQTY").Value), 0, RsTemp.Fields("BAlQTY").Value)
                        pAgePeriod = DateDiff(Microsoft.VisualBasic.DateInterval.Day, CDate(mRGPDate), CDate(pDate))
                    End If
                    .MoveNext()
                Loop
            End If
        End With
        Exit Function
ErrPart:
        GetPendingRGPQty = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetLatestWIPCost(ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pTotClosing As Double, ByRef pAsOnDate As String, ByRef pCostType As String, Optional ByRef pStockType As String = "", Optional ByRef pDeptCode As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mRunningBal As Double
        Dim mApprovedQty As Double
        Dim mQtyValue As Double
        Dim mCalcQty As Double
        Dim pRefDate As String
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim xSaleCost As Double
        Dim mCategory As String
        Dim mStockType As String = ""
        Dim mItemPurchaseCost As Double
        Dim mItemSalesCost As Double
        GetLatestWIPCost = 0
        If pTotClosing <= 0 Then
            GetLatestWIPCost = 0
            Exit Function
        End If
        If Trim(pItemCode) = "" Then '
            Exit Function
        End If
        mFactor = 1
        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST,ITEM_STD_COST,CATEGORY_CODE FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_UOM").Value), "", RsTemp1.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
            mCategory = IIf(IsDBNull(RsTemp1.Fields("CATEGORY_CODE").Value), "", RsTemp1.Fields("CATEGORY_CODE").Value)
            mItemPurchaseCost = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_COST").Value), 0, RsTemp1.Fields("PURCHASE_COST").Value)
            mItemSalesCost = IIf(IsDBNull(RsTemp1.Fields("ITEM_STD_COST").Value), 0, RsTemp1.Fields("ITEM_STD_COST").Value)
            If mPurchaseUOM <> mIssueUOM Then
                If mFactor <> 0 Then
                    mItemPurchaseCost = mItemPurchaseCost / mFactor
                    mItemSalesCost = mItemSalesCost / mFactor
                End If
            End If
        End If
        'xSaleCost = GetMaterialCost(pItemCode, pStockType, pDeptCode, pAsOnDate, pCostType)
        mBOMRMQty = 0
        mBOMRMAmount = 0
        Call CalcRawMaterialCost(pItemCode, pDeptCode, pStockType, pAsOnDate, pCostType, True)
        xSaleCost = mBOMRMAmount
        If xSaleCost = 0 Then
            GetLatestWIPCost = CDbl(VB6.Format(pTotClosing * mItemSalesCost, "0.0000"))
        Else
            GetLatestWIPCost = CDbl(VB6.Format(pTotClosing * xSaleCost, "0.0000"))
        End If
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetItemLotWiseQry(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        SqlStr = "SELECT ITEM_CODE, CASE WHEN BATCH_NO<='0' OR BATCH_NO=NULL OR BATCH_NO='' THEN '' ELSE BATCH_NO END BATCH_NO, SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            ''02-08-2006
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If
        'SqlStr = SqlStr & vbCrLf & " AND (BATCH_NO>=0 OR BATCH_NO=" & Val(pLotNo) & ")"
        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        Else
            If pStockType = "" Then
                SqlStr = SqlStr & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
            Else
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
                'If PubUserID <> "G0416" Then
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "' AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
                'End If
            End If
        End If
        'If PubUserID <> "G0416" Then
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        'End If
        SqlStr = SqlStr & vbCrLf & " HAVING SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1))<>0"
        SqlStr = SqlStr & vbCrLf & " GROUP BY ITEM_CODE,CASE WHEN BATCH_NO<='0' OR BATCH_NO=NULL OR BATCH_NO='' THEN '' ELSE BATCH_NO END"
        GetItemLotWiseQry = SqlStr
        Exit Function
ErrPart:
        GetItemLotWiseQry = ""
    End Function
    Public Function GetInJobworkItem(ByRef pItemCode As String, ByRef pWEF As String, ByRef pStdQty As Double, ByRef pManyItemIn As Boolean) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pMainItemCode As String
        Dim xSubItemCode As String
        Dim xAlterItemCode As String
        Dim xBeforeJobworkItemCode As String
        Dim mUOM As String = ""
        Dim mRMCode As String

        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.RM_CODE,STD_QTY/OUTPUT_QTY AS STD_QTY" & vbCrLf _
            & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.PRODUCT_CODE='" & pItemCode & "'" ''& vbCrLf |& " AND ID.STOCK_TYPE='CS'"

        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        pManyItemIn = False
        xSubItemCode = ""
        pStdQty = 1
        If RsTemp.EOF = False Then
            'pMainItemCode = Trim(IIf(IsNull(RSTemp!PRODUCT_CODE), "", RSTemp!PRODUCT_CODE))
            Do While Not RsTemp.EOF
                pStdQty = CDbl(Trim(IIf(IsDBNull(RsTemp.Fields("STD_QTY").Value), "", RsTemp.Fields("STD_QTY").Value)))
                mRMCode = Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value))
                If MainClass.ValidateWithMasterTable(mRMCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    mUOM = MasterNo
                End If
                If Trim(UCase(mUOM)) = "KGS" Then
                    pStdQty = pStdQty / 1000
                End If
                If Trim(UCase(mUOM)) = "TON" Then
                    pStdQty = pStdQty / 1000 * 1000
                End If
                If xSubItemCode = "" Then
                    xSubItemCode = "'" & Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value)) & "'"
                Else
                    xSubItemCode = xSubItemCode & "," & "'" & Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value)) & "'"
                End If
                xBeforeJobworkItemCode = GetBeforeJobworkItemCode(Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value)))
                If xBeforeJobworkItemCode <> "" Then
                    xSubItemCode = xSubItemCode & "," & "'" & xBeforeJobworkItemCode & "'"
                End If
                'xAlterItemCode = GetChildRecord(Trim(IIf(IsNull(RsTemp!RM_CODE), "", RsTemp!RM_CODE)), 0)
                'If xAlterItemCode <> "" Then
                ' xSubItemCode = xSubItemCode & "," & xAlterItemCode
                'End If
                'xAlterItemCode = ""
                xAlterItemCode = GetAlterItemCode(Trim(IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value)), Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value)), 0)
                If xAlterItemCode <> "" Then
                    'xSubItemCode = xSubItemCode & "," & "'" & xAlterItemCode & "'"
                    xSubItemCode = xSubItemCode & "," & xAlterItemCode
                End If
                RsTemp.MoveNext()
                If RsTemp.EOF = False Then
                    pManyItemIn = True
                    Exit Do
                End If
            Loop
            pMainItemCode = xSubItemCode
        Else
            pMainItemCode = ""
            xBeforeJobworkItemCode = GetBeforeJobworkItemCode(pItemCode)
            pStdQty = 1
            pManyItemIn = False
            If xBeforeJobworkItemCode <> "" Then
                pMainItemCode = "'" & xBeforeJobworkItemCode & "'"
            End If
        End If
        GetInJobworkItem = pMainItemCode
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetInJobworkItem = ""
    End Function
    Public Function GetRGPItemCode(ByRef pItemCode As String, ByRef pWEF As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing


        GetRGPItemCode = ""
        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.RM_CODE,STD_QTY/OUTPUT_QTY AS STD_QTY" & vbCrLf _
            & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.PRODUCT_CODE='" & pItemCode & "'" ''& vbCrLf |& " AND ID.STOCK_TYPE='CS'"

        SqlStr = SqlStr & vbCrLf _
            & " AND IH.WEF = (" & vbCrLf _
            & " SELECT MAX(WEF) " & vbCrLf _
            & " FROM PRD_NEWBOM_HDR " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND PRODUCT_CODE='" & pItemCode & "'" & vbCrLf _
            & " AND WEF<=TO_DATE('" & VB6.Format(pWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetRGPItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value))
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetRGPItemCode = ""
    End Function
    Public Function GetBalanceStockQtyRefDate(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        If pStock_ID = "" Then
            SqlStr = SqlStr & vbCrLf & "AND STOCK_ID IN ('WH','PH')"
        Else
            SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE IN (" & pStockType & ")"
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
        End If
        If pLotNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & MainClass.AllowSingleQuote(UCase(pLotNo)) & "'"
        End If
        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetBalanceStockQtyRefDate = mBalQty
        Exit Function
ErrPart:
        GetBalanceStockQtyRefDate = 0
    End Function
    Public Function GetAlterMainItemCode(ByRef mAlterItemCode As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RsMisc As ADODB.Recordset = Nothing
        GetAlterMainItemCode = ""
        If Trim(mAlterItemCode) = "" Then Exit Function
        SqlStr = "SELECT ITEM_CODE, ALTER_ITEM_CODE " & vbCrLf & " FROM INV_ITEM_ALTER_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE =(SELECT ITEM_CODE FROM INV_ITEM_ALTER_DET WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ALTER_ITEM_CODE='" & MainClass.AllowSingleQuote(mAlterItemCode) & "')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsMisc, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RsMisc.EOF Then
            GetAlterMainItemCode = "'" & Trim(IIf(IsDBNull(RsMisc.Fields("ITEM_CODE").Value), "", RsMisc.Fields("ITEM_CODE").Value)) & "'"
            Do While RsMisc.EOF = False
                GetAlterMainItemCode = GetAlterMainItemCode & ",'" & Trim(IIf(IsDBNull(RsMisc.Fields("ALTER_ITEM_CODE").Value), "", RsMisc.Fields("ALTER_ITEM_CODE").Value)) & "'"
                RsMisc.MoveNext()
            Loop
        Else
            GetAlterMainItemCode = "'" & Trim(mAlterItemCode) & "'"
        End If
        GetAlterMainItemCode = "(" & GetAlterMainItemCode & ")"
        Exit Function
ERR1:
        MsgBox(Err.Description)
    End Function
    Public Function GetCommonDivCode() As Double
        On Error GoTo err_Renamed
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetCommonDivCode = -1
        SqlStr = " SELECT DIV_CODE FROM INV_DIVISION_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND IS_COMMON_DIV='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCommonDivCode = IIf(IsDBNull(RsTemp.Fields("DIV_CODE").Value), -1, RsTemp.Fields("DIV_CODE").Value)
        End If
        Exit Function
err_Renamed:
        MsgBox(Err.Description)
    End Function
    Public Function CheckBillPayment(ByRef pSupplierCode As String, ByRef pBillNo As String, ByRef pBillType As String, ByRef pBillDate As String) As Boolean
        On Error GoTo ERR2
        Dim SqlStr As String = ""
        Dim RsBillPay As ADODB.Recordset = Nothing
        Dim mTrans As String = ""
        SqlStr = ""
        SqlStr = "SELECT VNO,BillNo from FIN_POSTED_TRN " & vbCrLf & " WHERE Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf & " AND AccountCode='" & pSupplierCode & "'"
        If pBillType = "B" Then
            SqlStr = SqlStr & vbCrLf & "AND BILLTYPE<>'B'"
        Else
            SqlStr = SqlStr & vbCrLf & "AND BILLTYPE ='P'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND UPPER(BillNo)='" & MainClass.AllowSingleQuote(UCase(pBillNo)) & "'"
        If IsDate(pBillDate) Then
            SqlStr = SqlStr & vbCrLf & " AND BILLDATE=TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBillPay, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBillPay.EOF = False Then
            CheckBillPayment = True
            Do While RsBillPay.EOF = False
                mTrans = IIf(mTrans = "", "", mTrans & ", ") & RsBillPay.Fields("VNO").Value
                RsBillPay.MoveNext()
            Loop
            MsgBox("Transaction Made [ " & mTrans & " ] Against This BillNo [ " & pBillNo & " ]" & vbCrLf & "So Can't Delete.", MsgBoxStyle.Information)
        End If
        Exit Function
ERR2:
        CheckBillPayment = True
        MsgBox(Err.Description)
    End Function
    Public Function GetOutJobworkManyItem(ByRef pInItemCode As String, ByRef pWEF As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mOutItemCode As String
        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.ITEM_CODE, ITEM_QTY " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & pInItemCode & "'"
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_OUTBOM_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & pInItemCode & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " AND IH.STATUS='O'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        GetOutJobworkManyItem = False
        If RsTemp.EOF = False Then
            Do While Not RsTemp.EOF
                mOutItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value))
                RsTemp.MoveNext()
                If RsTemp.EOF = False Then
                    GetOutJobworkManyItem = True
                    Exit Function
                End If
            Loop
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetOutJobworkManyItem = False
    End Function
    Public Function GetPhysicalWIPQty(ByRef pProductCode As String, ByRef mStockID As String, ByRef mDeptCode As String, ByRef pPhyDate As String) As Double
        On Error GoTo LedgError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsDeptSeq As ADODB.Recordset = Nothing
        Dim mDeptSeq As Integer
        Dim xCheckDept As String
        GetPhysicalWIPQty = 0
        SqlStr = "SELECT SERIAL_NO FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(mDeptCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(mDeptCode) & "'" & vbCrLf & " AND WEF <=TO_DATE('" & VB6.Format(pPhyDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY SERIAL_NO"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsDeptSeq, ADODB.LockTypeEnum.adLockReadOnly)
        If RsDeptSeq.EOF = False Then
            mDeptSeq = IIf(IsDBNull(RsDeptSeq.Fields("SERIAL_NO").Value), 0, RsDeptSeq.Fields("SERIAL_NO").Value)
        Else
            GetPhysicalWIPQty = 0
            Exit Function
        End If
        SqlStr = "SELECT * FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND SERIAL_NO >=" & mDeptSeq & " "
        SqlStr = SqlStr & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) AS WEF FROM PRD_PRODSEQUENCE_DET" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND WEF <=TO_DATE('" & VB6.Format(pPhyDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY SERIAL_NO"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsDeptSeq, ADODB.LockTypeEnum.adLockReadOnly)
        If RsDeptSeq.EOF = False Then
            Do While RsDeptSeq.EOF = False
                xCheckDept = IIf(IsDBNull(RsDeptSeq.Fields("DEPT_CODE").Value), "", RsDeptSeq.Fields("DEPT_CODE").Value)
                SqlStr = " SELECT SUM(ID.PHY_QTY * DECODE(ID.ITEM_IO,'I',1,-1)) AS ITEM_QTY " & vbCrLf & " FROM INV_PHY_HDR IH, INV_PHY_DET ID" & vbCrLf & " WHERE IH.AUTO_KEY_PHY=ID.AUTO_KEY_PHY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND IH.BOOKTYPE = '" & ConPH & "'" & vbCrLf & " AND ID.ITEM_CODE = '" & MainClass.AllowSingleQuote(pProductCode) & "'"
                SqlStr = SqlStr & vbCrLf & "AND IH.DEPT_CODE='" & xCheckDept & "'"
                If Trim(xCheckDept) = Trim(mDeptCode) Then
                    SqlStr = SqlStr & vbCrLf & " AND ID.STOCK_TYPE <> 'WP'"
                Else
                    SqlStr = SqlStr & vbCrLf & " AND ID.STOCK_TYPE <> 'WR'"
                End If
                SqlStr = SqlStr & vbCrLf & " AND IH.PHY_DATE = TO_DATE('" & VB6.Format(pPhyDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    GetPhysicalWIPQty = GetPhysicalWIPQty + IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                End If
                RsDeptSeq.MoveNext()
            Loop
        End If
        Exit Function
LedgError:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetWIPProcessCost() As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetWIPProcessCost = 0
        SqlStr = " SELECT WIP_PROCESS_COST FROM INV_WIPPROCESSCOST_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetWIPProcessCost = IIf(IsDBNull(RsTemp.Fields("WIP_PROCESS_COST").Value), 0, RsTemp.Fields("WIP_PROCESS_COST").Value)
        End If
        Exit Function
ErrPart:
        GetWIPProcessCost = 0
    End Function
    Public Function ValidateMRRApprovalAfter48Hours(ByRef pPvtDBCn As ADODB.Connection, ByRef pGateEntryNo As Double) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsLock As ADODB.Recordset = Nothing
        Dim mLockDateFrom As String
        Dim mLockDateTo As String
        ValidateMRRApprovalAfter48Hours = False
        mSqlStr = " SELECT * FROM INV_GATEENTRY_UNLOCK_TRN " & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND AUTO_KEY_GATE=" & Val(CStr(pGateEntryNo)) & ""
        MainClass.UOpenRecordSet(mSqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsLock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsLock.EOF = False Then
            ValidateMRRApprovalAfter48Hours = True
        End If
        Exit Function
ErrPart:
        ValidateMRRApprovalAfter48Hours = False
    End Function
    Public Function ValidateMRRApproval(ByRef pPvtDBCn As ADODB.Connection, ByRef pMRRNo As Double) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsLock As ADODB.Recordset = Nothing
        Dim mLockDateFrom As String
        Dim mLockDateTo As String

        If RsCompany.Fields("StockBalCheck").Value = "N" Then
            ValidateMRRApproval = True
            Exit Function
        End If
        ValidateMRRApproval = False
        mSqlStr = " SELECT * FROM INV_MRR_UNLOCK_TRN " & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND AUTO_KEY_MRR=" & Val(CStr(pMRRNo)) & ""
        MainClass.UOpenRecordSet(mSqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsLock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsLock.EOF = False Then
            ValidateMRRApproval = True
        End If
        Exit Function
ErrPart:
        ValidateMRRApproval = False
    End Function
    Public Function ValidateBillNo(ByRef pBillNo As String, ByRef pErrorMsg As String) As Boolean
        On Error GoTo ErrPart
        Dim mCnt As Integer
        Dim mKeyAscii As Short
        Dim mChar As String
        pErrorMsg = ""
        ValidateBillNo = False
        If Len(pBillNo) = 0 Then
            ValidateBillNo = True
            Exit Function
        End If
        If Len(pBillNo) > 16 Then
            pErrorMsg = "Bill No's length cann't be greater than 16 digit"
            ValidateBillNo = False
            Exit Function
        End If
        For mCnt = 1 To Len(pBillNo)
            mChar = Mid(pBillNo, mCnt, 1)
            mKeyAscii = Asc(mChar) ''Asc(UCase(Chr(mChar)))
            If mKeyAscii = 32 Then
                pErrorMsg = "Space is not Allow in Bill No."
                ValidateBillNo = False
                Exit Function
            End If
            If (mKeyAscii >= 48 And mKeyAscii <= 57) Or (mKeyAscii >= 97 And mKeyAscii <= 122) Or (mKeyAscii >= 65 And mKeyAscii <= 90) Or mKeyAscii = 8 Or mKeyAscii = 45 Then
            Else
                If mKeyAscii = 47 Or mKeyAscii = 45 Then
                Else
                    pErrorMsg = "Special Character (" & mChar & ") is not Allow."
                    ValidateBillNo = False
                    Exit Function
                End If
            End If
        Next
        ValidateBillNo = True
        Exit Function
ErrPart:
        ValidateBillNo = False
    End Function
    Public Function UpdateRGP_TRN(ByRef pDBCn As ADODB.Connection, ByRef pRGP_No As Double, ByRef pRGP_Date As String, ByRef pREF_No As Double,
                                  ByRef pREF_Date As String, ByRef pSuppCustCode As String, ByRef pF4No As Double, ByRef pF4Date As String,
                                  ByRef pBillNo As String, ByRef pBillDate As String, ByRef pOutItemCode As String, ByRef pInItemCode As String,
                                  ByRef pRGP_Qty As Double, ByRef pMRR_Qty As Double, ByRef pIO As String, ByRef pSubRowNo As Integer,
                                  ByRef pBookType As String, ByRef pExpDate As String, ByVal pLocationId As String) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsF4Temp As ADODB.Recordset = Nothing
        Dim pSubItemCode As String
        Dim mItemConsQty As Double
        Dim mItemF4ConsQty As Double
        Dim mItemBalConsQty As Double
        Dim mItemInF4Qty As Double
        Dim pConsUnit As Double
        Dim xF4No As String
        Dim mRecordCount As Integer
        Dim mMultiItemCode As Boolean
        Dim mMKey As String
        Dim mCheckOutItem As String = ""
        Dim xRGP_No As Double
        Dim xRGP_Date As String
        Dim xExpDate As String
        If pF4No = 0 Then
            xF4No = ""
        Else
            xF4No = CStr(pF4No)
        End If
        Dim mChallanNo As String = ""
        Dim mOutItemFound As Boolean = False

        If MainClass.ValidateWithMasterTable(pRGP_No, "AUTO_KEY_PASSNO", "NVL(CHALLAN_PREFIX,'') || GATEPASS_NO", "INV_GATEPASS_HDR", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mChallanNo = MasterNo
        End If

        If xExpDate <> "" Then
            xExpDate = pExpDate
        Else
            If MainClass.ValidateWithMasterTable(pRGP_No, "AUTO_KEY_PASSNO", "EXP_RTN_DATE", "INV_GATEPASS_HDR", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                xExpDate = MasterNo
            End If
        End If


        If pIO = "O" Then
            SqlStr = "INSERT INTO INV_RGP_REG_TRN ( " & vbCrLf _
                    & " COMPANY_CODE, FYEAR, " & vbCrLf _
                    & " SUPP_CUST_CODE, " & vbCrLf & " RGP_NO, RGP_DATE, " & vbCrLf _
                    & " REF_NO, REF_DATE, " & vbCrLf & " F4NO, F4DATE, " & vbCrLf _
                    & " BILL_NO, BILL_DATE, " & vbCrLf & " OUTWARD_ITEM_CODE," & vbCrLf _
                    & " INWARD_ITEM_CODE," & vbCrLf & " RGP_QTY, MRR_QTY, " & vbCrLf _
                    & " ITEM_IO, SUBROWNO, BOOKTYPE, EXP_RTN_DATE, BILL_TO_LOC_ID,CHALLAN_NO " & vbCrLf _
                    & " ) VALUES ( " & vbCrLf & " " & RsCompany.Fields("COMPANY_CODE").Value _
                    & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pSuppCustCode & "', " & vbCrLf _
                    & " " & pRGP_No & ", TO_DATE('" & VB6.Format(pRGP_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " " & pREF_No & ", TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & xF4No & "', TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pBillNo) & "', TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pOutItemCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf _
                    & " " & pRGP_Qty & ", " & pMRR_Qty & ", " & vbCrLf & " '" & pIO & "', " & pSubRowNo & ", '" & pBookType & "'," & vbCrLf _
                    & " TO_DATE('" & VB6.Format(xExpDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & MainClass.AllowSingleQuote(pLocationId) & "','" & mChallanNo & "')"
            pDBCn.Execute(SqlStr)
        Else
            If pOutItemCode = pInItemCode Then GoTo NextRow

            If GetOutJobworkManyItem(pInItemCode, Trim(pREF_Date)) = True Then

                SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.ITEM_CODE,ITEM_QTY " & vbCrLf _
                    & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID " & vbCrLf _
                    & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf _
                    & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND IH.PRODUCT_CODE='" & pInItemCode & "'"

                SqlStr = SqlStr & vbCrLf _
                    & " AND IH.WEF = (" & vbCrLf _
                    & " SELECT MAX(WEF) " & vbCrLf _
                    & " FROM PRD_OUTBOM_HDR " & vbCrLf _
                    & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND PRODUCT_CODE='" & pInItemCode & "'" & vbCrLf _
                    & " AND WEF<=TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

                'SqlStr = SqlStr & vbCrLf & " AND IH.STATUS='O'"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

                If RsTemp.EOF = False Then
                    Do While RsTemp.EOF = False
                        mMKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value)
                        mCheckOutItem = IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value)
                        mItemBalConsQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value) * pMRR_Qty

                        mSqlStr = " SELECT RGP_NO, RGP_DATE," & vbCrLf & " SUM(RGP_QTY * DECODE(ITEM_IO,'O',1,-1)) AS F4_BAL_QTY " & vbCrLf & " FROM INV_RGP_REG_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCustCode) & "'" & vbCrLf & " AND OUTWARD_ITEM_CODE='" & MainClass.AllowSingleQuote(mCheckOutItem) & "'" & vbCrLf & " AND RGP_DATE<=TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
                        mSqlStr = mSqlStr & vbCrLf & " HAVING SUM(RGP_QTY * DECODE(ITEM_IO,'O',1,-1))>0"
                        mSqlStr = mSqlStr & vbCrLf & " GROUP BY RGP_NO, RGP_DATE"
                        mSqlStr = mSqlStr & vbCrLf & " ORDER BY RGP_DATE, RGP_NO"

                        'mSqlStr = mSqlStr & vbCrLf & " GROUP BY DECODE(F4NO,'0','',F4NO), F4DATE, RGP_NO, RGP_DATE, EXP_RTN_DATE"
                        'mSqlStr = mSqlStr & vbCrLf & " ORDER BY F4DATE, DECODE(F4NO,'0','',F4NO)"
                        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsF4Temp, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsF4Temp.EOF = False Then
                            Do While RsF4Temp.EOF = False
                                If mItemBalConsQty > 0 Then
                                    mItemConsQty = IIf(IsDBNull(RsF4Temp.Fields("F4_BAL_QTY").Value), 0, RsF4Temp.Fields("F4_BAL_QTY").Value)
                                    xRGP_No = IIf(IsDBNull(RsF4Temp.Fields("RGP_NO").Value), "", RsF4Temp.Fields("RGP_NO").Value)
                                    xRGP_Date = IIf(IsDBNull(RsF4Temp.Fields("RGP_DATE").Value), "", RsF4Temp.Fields("RGP_DATE").Value)
                                    Call GetPartyF4detailFromRGP(xRGP_No, xF4No, pF4Date, xExpDate)
                                    'xF4No = Val(IIf(IsNull(RsF4Temp!F4NO), 0, RsF4Temp!F4NO))
                                    'pF4Date = IIf(IsNull(RsF4Temp!F4DATE), "", RsF4Temp!F4DATE)
                                    'pExpDate = IIf(IsNull(RsF4Temp!EXP_RTN_DATE), "", RsF4Temp!EXP_RTN_DATE)
                                    pSubRowNo = pSubRowNo + 1
                                    If mItemBalConsQty <= mItemConsQty Then
                                        mItemInF4Qty = mItemBalConsQty
                                        mItemBalConsQty = 0
                                    ElseIf mItemBalConsQty > mItemConsQty Then
                                        mItemInF4Qty = mItemConsQty
                                        mItemBalConsQty = mItemBalConsQty - mItemConsQty
                                    End If
                                    SqlStr = "INSERT INTO INV_RGP_REG_TRN ( " & vbCrLf _
                                        & " COMPANY_CODE, FYEAR, " & vbCrLf _
                                        & " SUPP_CUST_CODE, " & vbCrLf _
                                        & " RGP_NO, RGP_DATE, " & vbCrLf _
                                        & " REF_NO, REF_DATE, " & vbCrLf _
                                        & " F4NO, F4DATE, " & vbCrLf _
                                        & " BILL_NO, BILL_DATE, " & vbCrLf _
                                        & " OUTWARD_ITEM_CODE," & vbCrLf _
                                        & " INWARD_ITEM_CODE," & vbCrLf _
                                        & " RGP_QTY, MRR_QTY, " & vbCrLf _
                                        & " ITEM_IO, SUBROWNO, BOOKTYPE, EXP_RTN_DATE,BILL_TO_LOC_ID, CHALLAN_NO" & vbCrLf _
                                        & " ) VALUES ( " & vbCrLf _
                                        & " " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf _
                                        & " '" & pSuppCustCode & "', " & vbCrLf _
                                        & " " & xRGP_No & ", TO_DATE('" & VB6.Format(xRGP_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                                        & " " & pREF_No & ", TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                                        & " '" & xF4No & "', TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                                        & " '" & MainClass.AllowSingleQuote(pBillNo) & "', TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                                        & " '" & MainClass.AllowSingleQuote(mCheckOutItem) & "', " & vbCrLf _
                                        & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf _
                                        & " " & mItemInF4Qty & ", " & pMRR_Qty & ", " & vbCrLf _
                                        & " '" & pIO & "', " & pSubRowNo & ",'" & pBookType & "'," & vbCrLf _
                                        & " TO_DATE('" & VB6.Format(xExpDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & MainClass.AllowSingleQuote(pLocationId) & "','" & mChallanNo & "')"
                                    pDBCn.Execute(SqlStr)
                                End If
                                RsF4Temp.MoveNext()
                                If RsF4Temp.EOF = True Then
                                    If mItemBalConsQty > 0 Then
                                        MsgBox("You have not Enough RGP Balance(" & mCheckOutItem & ") For Item Code : " & pInItemCode)
                                        UpdateRGP_TRN = False
                                        Exit Function
                                    End If
                                End If
                            Loop
                        End If
                        RsTemp.MoveNext()
                    Loop
                End If
            Else
NextRow:
                If pInItemCode = pOutItemCode Then
                    pRGP_Qty = pMRR_Qty
                Else
                    'SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.ITEM_CODE,ITEM_QTY " & vbCrLf _
                    '    & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID " & vbCrLf _
                    '    & " WHERE " & vbCrLf _
                    '    & " IH.MKEY=ID.MKEY" & vbCrLf _
                    '    & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    '    & " AND IH.PRODUCT_CODE='" & pInItemCode & "' AND ID.ITEM_CODE='" & pOutItemCode & "'"

                    'SqlStr = SqlStr & vbCrLf _
                    '    & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf _
                    '    & " FROM PRD_OUTBOM_HDR " & vbCrLf _
                    '    & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    '    & " AND PRODUCT_CODE='" & pInItemCode & "'" & vbCrLf _
                    '    & " AND WEF<=TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
                    Dim mWONo As Double
                    Dim mIsReProcess As String

                    If MainClass.ValidateWithMasterTable(pRGP_No, "AUTO_KEY_PASSNO", "AUTO_KEY_WO", "INV_GATEPASS_DET", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & pOutItemCode & "' AND INWARD_ITEM_CODE='" & pInItemCode & "'") = True Then
                        mWONo = MasterNo
                    End If

                    mIsReProcess = GetItemReProcess(mWONo, pInItemCode, pSuppCustCode, pBillDate)

                    SqlStr = " SELECT PRODUCT_CODE, RM_CODE AS ITEM_CODE," & vbCrLf _
                        & " (STD_QTY ) AS ITEM_QTY, GROSS_WT_SCRAP " & vbCrLf _
                        & " FROM VW_PRD_BOM_TRN TRN" & vbCrLf _
                        & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""  '' AND RM_CODE='" & MainClass.AllowSingleQuote(pOutItemCode) & "'"

                    If mIsReProcess = "N" Then
                        SqlStr = SqlStr & vbCrLf _
                            & " START WITH TRIM(PRODUCT_CODE) || '-' || TRN.COMPANY_CODE ='" & MainClass.AllowSingleQuote(pInItemCode) & "-" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf _
                            & " CONNECT BY PRIOR (TRIM(RM_CODE) || COMPANY_CODE || ' ')= (TRIM(PRODUCT_CODE) || COMPANY_CODE || ' ')" & vbCrLf _
                            & " ORDER SIBLINGS BY PRODUCT_CODE"
                    Else
                        SqlStr = SqlStr & vbCrLf _
                            & " START WITH TRIM(RM_CODE) || '-' || TRN.COMPANY_CODE ='" & MainClass.AllowSingleQuote(pInItemCode) & "-" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf _
                            & " CONNECT BY PRIOR (TRIM(PRODUCT_CODE) || COMPANY_CODE || ' ')= (TRIM(RM_CODE) || COMPANY_CODE || ' ')" & vbCrLf _
                            & " ORDER SIBLINGS BY RM_CODE"
                    End If

                    '                   Select Case PRODUCT_CODE, RM_CODE As ITEM_CODE,
                    '(STD_QTY + GROSS_WT_SCRAP) AS ITEM_QTY 
                    'From VW_PRD_BOM_TRN TRN
                    'Where TRN.COMPANY_CODE = 1 - -And Trim(RM_CODE) ='SRM027'
                    'start With TRIM(PRODUCT_CODE) || '-' || TRN.COMPANY_CODE ='SF0713-1'
                    'CONNECT BY PRIOR (TRIM(RM_CODE) || COMPANY_CODE || ' ')= (TRIM(PRODUCT_CODE) || COMPANY_CODE || ' ')
                    'ORDER SIBLINGS BY PRODUCT_CODE

                    'SqlStr = " Select PRODUCT_CODE,RM_CODE," & vbCrLf _
                    '    & " (STD_QTY + GROSS_WT_SCRAP) As STD_QTY " & vbCrLf _
                    '    & " FROM VW_PRD_BOM_TRN TRN" & vbCrLf _
                    '    & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " And RM_CODE='" & MainClass.AllowSingleQuote(xCheckRM) & "'"
                    'SqlStr = SqlStr & vbCrLf _
                    '    & " START WITH PRODUCT_CODE || '-' || TRN.COMPANY_CODE ='" & MainClass.AllowSingleQuote(xItemCode) & "-" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf _
                    '    & " CONNECT BY PRIOR (TRIM(RM_CODE) || COMPANY_CODE || ' ')=TRIM(PRODUCT_CODE) || COMPANY_CODE || ' '"


                    ''22-09-2009 ''Select From W.E.F.
                    'SqlStr = SqlStr & vbCrLf & " AND IH.STATUS='O'"

                    MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                    mMultiItemCode = False
                    mOutItemFound = False
                    If RsTemp.EOF = False Then
                        pRGP_Qty = pMRR_Qty
                        Do While RsTemp.EOF = False
                            'mMKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value)
                            mCheckOutItem = IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), 0, RsTemp.Fields("ITEM_CODE").Value)
                            pRGP_Qty = pRGP_Qty * IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                            RsTemp.MoveNext()
                            If Trim(pOutItemCode) = Trim(mCheckOutItem) Then
                                mOutItemFound = True
                                Exit Do
                            End If
                            'If RsTemp.EOF = False Then
                            '    mMultiItemCode = True
                            '    Exit Do
                            'End If
                        Loop
                        If mOutItemFound = False Then
                            MsgInformation("Out Item Code Not found in BOM.")
                            UpdateRGP_TRN = False
                            Exit Function
                        End If
                        RsTemp.MoveFirst()
                    Else
                        SqlStr = "SELECT IH.MKEY,ALTER_ITEM_CODE, ALTER_ITEM_QTY " & vbCrLf _
                            & " FROM PRD_OUTBOM_ALTER_DET IH, PRD_OUTBOM_HDR ID" & vbCrLf _
                            & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
                            & " AND IH.PRODUCT_CODE=ID.PRODUCT_CODE" & vbCrLf _
                            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                            & " AND IH.PRODUCT_CODE='" & pInItemCode & "'" & vbCrLf _
                            & " AND IH.ALTER_ITEM_CODE='" & pOutItemCode & "'"

                        SqlStr = SqlStr & vbCrLf _
                            & " AND ID.WEF = (" & vbCrLf _
                            & " SELECT MAX(WEF) " & vbCrLf _
                            & " FROM PRD_OUTBOM_HDR " & vbCrLf _
                            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                            & " AND PRODUCT_CODE='" & pInItemCode & "'" & vbCrLf _
                            & " AND WEF<=TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

                        'SqlStr = SqlStr & vbCrLf & " AND ID.STATUS='O'"
                        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTemp.EOF = False Then
                            Do While RsTemp.EOF = False
                                mMKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value)
                                mCheckOutItem = IIf(IsDBNull(RsTemp.Fields("ALTER_ITEM_CODE").Value), 0, RsTemp.Fields("ALTER_ITEM_CODE").Value)
                                pRGP_Qty = IIf(IsDBNull(RsTemp.Fields("ALTER_ITEM_QTY").Value), 0, RsTemp.Fields("ALTER_ITEM_QTY").Value) * pMRR_Qty
                                RsTemp.MoveNext()
                                If RsTemp.EOF = False Then
                                    mMultiItemCode = True
                                    Exit Do
                                End If
                            Loop
                            RsTemp.MoveFirst()
                        Else
                            pRGP_Qty = pMRR_Qty
                        End If
                    End If
                End If
                pConsUnit = 1
                If mCheckOutItem <> "" Then
                    If mCheckOutItem = pOutItemCode Then
                        pRGP_Qty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value) * pMRR_Qty / pConsUnit
                    End If
                End If
                SqlStr = "INSERT INTO INV_RGP_REG_TRN ( " & vbCrLf _
                    & " COMPANY_CODE, FYEAR, " & vbCrLf & " SUPP_CUST_CODE, " & vbCrLf _
                    & " RGP_NO, RGP_DATE, " & vbCrLf & " REF_NO, REF_DATE, " & vbCrLf _
                    & " F4NO, F4DATE, " & vbCrLf & " BILL_NO, BILL_DATE, " & vbCrLf _
                    & " OUTWARD_ITEM_CODE," & vbCrLf & " INWARD_ITEM_CODE," & vbCrLf _
                    & " RGP_QTY, MRR_QTY, " & vbCrLf _
                    & " ITEM_IO, SUBROWNO, BOOKTYPE, EXP_RTN_DATE,BILL_TO_LOC_ID,CHALLAN_NO" & vbCrLf _
                    & " ) VALUES ( " & vbCrLf _
                    & " " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf _
                    & " '" & pSuppCustCode & "', " & vbCrLf _
                    & " " & pRGP_No & ", TO_DATE('" & VB6.Format(pRGP_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " " & pREF_No & ", TO_DATE('" & VB6.Format(pREF_Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & xF4No & "', TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pBillNo) & "', TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pOutItemCode) & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf _
                    & " " & VB6.Format(pRGP_Qty, "0.0000") & ", " & VB6.Format(pMRR_Qty, "0.0000") & ", " & vbCrLf _
                    & " '" & pIO & "', " & pSubRowNo & ",'" & pBookType & "'," & vbCrLf _
                    & " TO_DATE('" & VB6.Format(xExpDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & MainClass.AllowSingleQuote(pLocationId) & "','" & mChallanNo & "')"

                pDBCn.Execute(SqlStr)
            End If
        End If
        UpdateRGP_TRN = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        'UpdateRGP_TRN = True
        UpdateRGP_TRN = False
        ''Resume
    End Function
    Public Function UpdatePCTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pPCNO As Double, ByRef pPCDate As String, ByRef pRefNo As String, ByRef pRefDate As String, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pItemQty As Double, ByRef pItemValue As Double) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim mCTStockCheck As Boolean
        Dim mSqlStr As String
        Dim RsTempUOM As ADODB.Recordset = Nothing
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Integer
        Dim mBalCTQty As Double
        If pBookType = "S" And pBookSubType = "O" Then
            mCTStockCheck = True
        ElseIf pBookType = "P" And pBookSubType = "I" Then
            mCTStockCheck = True
        Else
            mCTStockCheck = False
        End If
        If mCTStockCheck = True Then
            If pPCDate = "" Then
                pPCDate = GetPCDate(pDBCn, pPCNO, pItemCode, pBookType, pAccountCode)
            End If
            SqlStr = " SELECT ABS(SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)) AS ITEM_QTY " & vbCrLf & " FROM FIN_PC_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf & " AND PC_NO=" & Val(CStr(pPCNO)) & "" & vbCrLf & " AND PC_DATE=TO_DATE('" & VB6.Format(pPCDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND ITEM_CODE ='" & pItemCode & "'"
            If pBookType = "S" Then
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)>0"
            Else
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',-1,1)*ITEM_QTY)>0"
            End If
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mBalCTQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                If pItemQty > mBalCTQty Then
                    MsgBox("No Enough P.C. Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                    UpdatePCTRN = False
                    Exit Function
                End If
            Else
                MsgBox("No Enough P.C. Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                UpdatePCTRN = False
                Exit Function
            End If
        End If
        If (pBookType = "S" And pBookSubType = "I") Or (pBookType = "P" And pBookSubType = "O") Then
            mSqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempUOM, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTempUOM.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTempUOM.Fields("ISSUE_UOM").Value), "", RsTempUOM.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTempUOM.Fields("PURCHASE_UOM").Value), "", RsTempUOM.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTempUOM.Fields("UOM_FACTOR").Value) Or RsTempUOM.Fields("UOM_FACTOR").Value = 0, 1, RsTempUOM.Fields("UOM_FACTOR").Value)
            End If
            If mIssueUOM <> mPurchaseUOM Then
                pItemQty = pItemQty * mFactor
            End If
        End If
        If pPCNO <> 0 And pItemQty > 0 Then
            SqlStr = "INSERT INTO FIN_PC_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " REF_NO, REF_DATE, " & vbCrLf & " PC_NO, PC_DATE, " & vbCrLf & " SUPP_CUST_CODE, " & vbCrLf & " ITEM_CODE, ITEM_UOM, " & vbCrLf & " ITEM_QTY, ITEM_VALUE " & vbCrLf & " ) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', " & vbCrLf & " '" & pRefNo & "', TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " " & Val(CStr(pPCNO)) & ", TO_DATE('" & VB6.Format(pPCDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & pAccountCode & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "', '" & MainClass.AllowSingleQuote(pItemUOM) & "'," & vbCrLf & " " & pItemQty & ", " & pItemValue & ")"
            pDBCn.Execute(SqlStr)
        End If
        UpdatePCTRN = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdatePCTRN = False
        ''Resume
    End Function
    Public Function UpdatePaintDetail(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pF4No As String, ByRef pF4Date As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pItemCode As String, ByRef xItemQty As Double, ByRef pIO As String, ByRef pSubRowNo As Integer, ByRef pTRNType As String, ByRef pVDate As String, Optional ByRef IsPaintF4 As String = "", Optional ByRef pIsScrap As String = "", Optional ByRef pIsScrapMaterial As String = "", Optional ByRef pIsRejection As String = "") As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim mSqlStr As String
        Dim RsTempUOM As ADODB.Recordset = Nothing
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pSubItemCode As String = ""
        Dim mItemConsQty As Double
        Dim mItemF4ConsQty As Double
        Dim RsTemp57F4 As ADODB.Recordset = Nothing
        Dim xBookType As String = ""
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Integer
        Dim mINCodeConQty As Double
        Dim pItemQty As Double
        Dim mIsManyIn As Boolean
        mIsManyIn = False
        pItemQty = xItemQty
        If pIsScrap = "" Then pIsScrap = "N"
        If pIsScrapMaterial = "" Then pIsScrapMaterial = "N"
        If pIsRejection = "" Then pIsRejection = "N"

        If pIO = "O" Then
            If pBookType = "D" Or pBookType = "N" Or IsPaintF4 = "Y" Then
                xBookType = IIf(IsPaintF4 = "Y", "P", "G")
                pSubItemCode = ""
                If xBookType = "P" Then

                    SqlStr = "SELECT CONSUMPTION_UNIT,IH.ITEM_CODE,CONSUMPTION_QTY " & vbCrLf _
                        & " FROM DSP_CONSUMPTION_HDR IH,DSP_CONSUMPTION_DET ID " & vbCrLf _
                        & " WHERE " & vbCrLf & " IH.COMPANY_CODE=ID.COMPANY_CODE " & vbCrLf _
                        & " AND IH.BOOKTYPE='" & xBookType _
                        & "' AND IH.ITEM_CODE=ID.ITEM_CODE " & vbCrLf _
                        & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                        & " AND ID.CON_ITEM_CODE='" & pItemCode & "' AND BOOKTYPE='G'"
                    MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

                    mINCodeConQty = 1
                    If RsTemp.EOF = False Then
                        Do While Not RsTemp.EOF
                            mINCodeConQty = Val(IIf(IsDBNull(RsTemp.Fields("CONSUMPTION_UNIT").Value), 0, RsTemp.Fields("CONSUMPTION_UNIT").Value))
                            If pSubItemCode = "" Then
                                pSubItemCode = "'" & Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value)) & "'"
                            Else
                                pSubItemCode = pSubItemCode & "," & "'" & Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value)) & "'"
                            End If
                            RsTemp.MoveNext()
                        Loop
                        pSubItemCode = "(" & pSubItemCode & ",'" & pItemCode & "')"
                        'pSubItemCode = Trim(IIf(IsNull(RsTemp!ITEM_CODE), "", RsTemp!ITEM_CODE))
                    Else
                        pSubItemCode = "('" & pItemCode & "')"
                    End If
                    If xBookType = "P" Then
                        pSubItemCode = "('" & pItemCode & "')"
                        mINCodeConQty = 1
                    End If
                Else
                    pSubItemCode = GetInJobworkItem(pItemCode, Trim(pBillDate), mINCodeConQty, mIsManyIn)
                    If pSubItemCode = "" Then
                        pSubItemCode = "('" & pItemCode & "')"
                    Else
                        pSubItemCode = "(" & Trim(pSubItemCode) & ",'" & pItemCode & "')"
                    End If
                    mIsManyIn = IIf(pTRNType = "N" Or pIsRejection = "Y", False, mIsManyIn)
                End If
                If mIsManyIn = True Then
                    If UpdateManyF4TRN(pItemCode, pVDate, pMKey, pBookType, pBookSubType, pAccountCode, pBillNo, pBillDate, xItemQty, pIO, pSubRowNo, pTRNType, pVDate, pIsScrap, pIsScrapMaterial) = False Then GoTo ErrDetail
                    UpdatePaintDetail = True
                    Exit Function
                Else
                    SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY) AS ITEM_QTY,ITEM_CODE,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TRIM(PARTY_F4NO)='" & MainClass.AllowSingleQuote(pF4No) & "' " & vbCrLf & " AND ITEM_CODE IN " & pSubItemCode & "" & vbCrLf & " AND ISSCRAP ='" & pIsScrap & "' AND SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf & " GROUP BY " & vbCrLf & " PARTY_F4NO,PARTY_F4DATE,ITEM_CODE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY)>0"
                    MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                    ''AND BILL_NO<>'" & pBillNo & "'
                    If RsTemp.EOF = False Then
                        pSubItemCode = IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value)
                        pF4No = IIf(IsDBNull(RsTemp.Fields("PARTY_F4NO").Value), "", RsTemp.Fields("PARTY_F4NO").Value)
                        pF4Date = IIf(IsDBNull(RsTemp.Fields("PARTY_F4DATE").Value), "", RsTemp.Fields("PARTY_F4DATE").Value)
                        mItemF4ConsQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value) / mINCodeConQty
                        If pItemQty > mItemF4ConsQty Then
                            MsgBox("No Enough 57F4 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                            UpdatePaintDetail = False
                            Exit Function
                        End If
                        pItemQty = pItemQty * mINCodeConQty
                    Else
                        MsgBox("No Enough 57F4 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                        UpdatePaintDetail = False
                        Exit Function
                    End If
                    If pF4No <> "" And pItemQty > 0 Then
                        SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUB_ITEM_CODE, " & vbCrLf & " SUBROWNO,BILL_QTY,TRNTYPE, VDATE, ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pSubItemCode) & "', " & vbCrLf & " " & pItemQty & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " " & pSubRowNo & "," & pItemQty & ",'" & pTRNType & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "' )"
                        pDBCn.Execute(SqlStr)
                    End If
                End If
            Else
                SqlStr = "SELECT CONSUMPTION_UNIT,CON_ITEM_CODE,CONSUMPTION_QTY " & vbCrLf & " FROM DSP_CONSUMPTION_HDR IH,DSP_CONSUMPTION_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.COMPANY_CODE=ID.COMPANY_CODE " & vbCrLf & " AND IH.BOOKTYPE='P' AND IH.ITEM_CODE=ID.ITEM_CODE " & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.ITEM_CODE='" & pItemCode & "'"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    Do While Not RsTemp.EOF
                        pSubItemCode = IIf(IsDBNull(RsTemp.Fields("CON_ITEM_CODE").Value), "", RsTemp.Fields("CON_ITEM_CODE").Value)
                        mItemConsQty = pItemQty * IIf(IsDBNull(RsTemp.Fields("CONSUMPTION_QTY").Value), 0, RsTemp.Fields("CONSUMPTION_QTY").Value) / IIf(IsDBNull(RsTemp.Fields("CONSUMPTION_UNIT").Value), 0, RsTemp.Fields("CONSUMPTION_UNIT").Value)
                        SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY*CASE WHEN ITEM_IO='O' AND MKEY='" & pMKey & "' THEN 0 ELSE 1 END) AS ITEMQTY,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pSubItemCode) & "'" & vbCrLf & " AND SUPP_CUST_CODE= '" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf & " AND ISSCRAP='" & pIsScrap & "'" & vbCrLf & " AND PARTY_F4NO NOT LIKE 'DIFF%' " & vbCrLf & " GROUP BY PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY*CASE WHEN ITEM_IO='O' AND MKEY='" & pMKey & "' THEN 0 ELSE 1 END)>0"
                        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp57F4, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTemp57F4.EOF = False Then
                            Do While Not RsTemp57F4.EOF
                                'Do While mItemConsQty <> 0
                                If mItemConsQty <= 0 Then GoTo GotoNext
                                pF4No = IIf(IsDBNull(RsTemp57F4.Fields("PARTY_F4NO").Value), "", RsTemp57F4.Fields("PARTY_F4NO").Value)
                                pF4Date = IIf(IsDBNull(RsTemp57F4.Fields("PARTY_F4DATE").Value), "", RsTemp57F4.Fields("PARTY_F4DATE").Value)
                                mItemF4ConsQty = CDbl(VB6.Format(IIf(IsDBNull(RsTemp57F4.Fields("ITEMQTY").Value), 0, RsTemp57F4.Fields("ITEMQTY").Value), "0.000"))
                                'Call Get57F4Detail(pDBCn, pSubItemCode, pAccountCode, pF4No, pF4Date, mItemF4ConsQty)
                                If mItemF4ConsQty = 0 Then
                                    'UpdatePaintDetail = True
                                    GoTo GotoNext57F4
                                End If
                                If mItemConsQty <= mItemF4ConsQty Then
                                    mItemF4ConsQty = mItemConsQty
                                End If
                                If pF4No <> "" And mItemF4ConsQty > 0 Then
                                    SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, " & vbCrLf & " SUB_ITEM_CODE,SUBROWNO,BILL_QTY,TRNTYPE,VDATE,ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pSubItemCode) & "', " & vbCrLf & " " & VB6.Format(mItemF4ConsQty, "0.000") & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " " & pSubRowNo & "," & pItemQty & ",'" & pTRNType & "', TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "' )"
                                    pDBCn.Execute(SqlStr)
                                End If
                                mItemConsQty = mItemConsQty - mItemF4ConsQty
                                pF4No = ""
                                pF4Date = ""
                                mItemF4ConsQty = 0
                                'Loop
GotoNext57F4:
                                If mItemConsQty = 0 Then Exit Do
                                RsTemp57F4.MoveNext()
                            Loop
                        End If
GotoNext:
                        RsTemp.MoveNext()
                    Loop
                End If
            End If
        Else
            If pF4No <> "" And pItemQty <> 0 Then
                mSqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
                MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempUOM, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTempUOM.EOF = False Then
                    mIssueUOM = IIf(IsDBNull(RsTempUOM.Fields("ISSUE_UOM").Value), "", RsTempUOM.Fields("ISSUE_UOM").Value)
                    mPurchaseUOM = IIf(IsDBNull(RsTempUOM.Fields("PURCHASE_UOM").Value), "", RsTempUOM.Fields("PURCHASE_UOM").Value)
                    mFactor = IIf(IsDBNull(RsTempUOM.Fields("UOM_FACTOR").Value) Or RsTempUOM.Fields("UOM_FACTOR").Value = 0, 1, RsTempUOM.Fields("UOM_FACTOR").Value)
                End If
                If mIssueUOM <> mPurchaseUOM Then
                    pItemQty = pItemQty * mFactor
                End If
                SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, " & vbCrLf & " SUB_ITEM_CODE,SUBROWNO,TRNTYPE, VDATE,ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pItemCode) & "', " & vbCrLf & " " & pItemQty & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pSubItemCode) & "'," & vbCrLf & " " & pSubRowNo & ",'" & pTRNType & "',TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "')"
                pDBCn.Execute(SqlStr)
            End If
        End If
        UpdatePaintDetail = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdatePaintDetail = False
        'Resume
    End Function
    Public Function UpdateMRRHistory(ByVal pDBCn As ADODB.Connection, ByVal pMRRNo As Double, ByVal I As Integer,
                                     ByVal mItemCode As String, ByVal mUnit As String, ByVal mStockType As String, ByVal mBillQty As Double,
                                     ByVal mRecdQty As Double, ByVal mShortQty As Double, ByVal mApprovedQty As Double, ByVal mRejQty As Double,
                                     ByVal mAcceptQty As Double, ByVal mDevQty As Double, ByVal mSeg As Double, ByVal mRework As Double, ByVal mQCEmp As String,
                                     ByVal mRemarks As String, ByVal mItemRate As Double, ByVal mConvQty As Double, ByVal pRejStatus As String, ByVal pMRRDate As String,
                                     ByVal mCompanyCode As Integer, ByVal pSupplierCode As String, ByVal pRefType As String, ByVal mPONo As Double,
                                     ByVal mSchdRtnFlag As String, ByVal mMRRQCDate As String, ByVal mPDIRFlag As String, ByVal mItemCost As Double, ByVal mBatchNo As String,
                                     ByVal mRGPItemCode As String, ByVal mPODate As String, ByVal mCT3No As Double, ByVal mPCNo As Double,
                                     ByVal pBillNo As String, ByVal mBillDate As String) As Boolean

        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = "INSERT INTO INV_GATE_DET_HIS ( " & vbCrLf _
            & " AUTO_KEY_MRR, SERIAL_NO, ITEM_CODE, ITEM_UOM," & vbCrLf _
            & " STOCK_TYPE, BILL_QTY, RECEIVED_QTY, SHORTAGE_QTY," & vbCrLf _
            & " APPROVED_QTY, REJECTED_QTY, LOT_ACCEPT, LOT_ACCEPT_DEV," & vbCrLf _
            & " LOT_ACC_SEG, LOT_ACC_RWK, QC_EMP_CODE, REMARKS," & vbCrLf _
            & " ITEM_RATE, CONV_QTY, REJ_RTN_STATUS, MRR_DATE," & vbCrLf _
            & " COMPANY_CODE, SUPP_CUST_CODE, REF_TYPE, REF_AUTO_KEY_NO," & vbCrLf _
            & " SCHLD_RTN_FLAG, MRR_QCDATE, PDIR_FLAG, ITEM_COST," & vbCrLf _
            & " BATCH_NO, REF_PO_NO,  RGP_ITEM_CODE," & vbCrLf _
            & " REF_DATE, CT3_NO, PC_NO, BILL_NO," & vbCrLf _
            & " BILL_DATE, MODUSER, MODDATE, COMPUTER_IP) VALUES ( "

        SqlStr = SqlStr & vbCrLf _
            & " " & pMRRNo & ", " & I & ",'" & mItemCode & "', '" & mUnit & "', " & vbCrLf _
            & " '" & mStockType & "'," & mBillQty & ", " & mRecdQty & ", " & mShortQty & ", " & vbCrLf _
            & " " & mApprovedQty & ", " & mRejQty & ", " & mAcceptQty & ", " & mDevQty & ", " & vbCrLf _
            & " " & mSeg & ", " & mRework & ", '" & mQCEmp & "','" & MainClass.AllowSingleQuote(mRemarks) & "'," & vbCrLf _
            & " " & mItemRate & ", " & mConvQty & ", '" & pRejStatus & "',TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
            & " " & mCompanyCode & ", '" & pSupplierCode & "','" & pRefType & "'," & Val(CStr(mPONo)) & "," & vbCrLf _
            & " '" & mSchdRtnFlag & "', TO_DATE('" & VB6.Format(mMRRQCDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & mPDIRFlag & "'," & mItemCost & "," & vbCrLf _
            & " '" & mBatchNo & "', " & Val(CStr(mPONo)) & ",  '" & mRGPItemCode & "'," & vbCrLf _
            & " TO_DATE('" & VB6.Format(mPODate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & mCT3No & "," & mPCNo & ", '" & pBillNo & "', " & vbCrLf _
            & " TO_DATE('" & VB6.Format(mBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & PubUserID & "',TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'), '" & PubTerminalIPAddress & "' )"

        pDBCn.Execute(SqlStr)
        UpdateMRRHistory = True
        Exit Function
UpdateStockTRNErr:
        'Resume Next
        UpdateMRRHistory = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function UpdateCT3TRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pCTNO As Double, ByRef pCTDate As String, ByRef pRefNo As String, ByRef pRefDate As String, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pItemQty As Double, ByRef pItemValue As Double) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim mCTStockCheck As Boolean
        Dim mSqlStr As String
        Dim RsTempUOM As ADODB.Recordset = Nothing
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Integer
        Dim mBalCTQty As Double
        If pBookType = "S" And pBookSubType = "O" Then
            mCTStockCheck = True
        ElseIf pBookType = "P" And pBookSubType = "I" Then
            mCTStockCheck = True
        Else
            mCTStockCheck = False
        End If
        If mCTStockCheck = True Then
            If pCTDate = "" Then
                pCTDate = GetCT3Date(pDBCn, pCTNO, pItemCode, pBookType, pAccountCode)
            End If
            SqlStr = " SELECT ABS(SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)) AS ITEM_QTY " & vbCrLf & " FROM FIN_CT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf & " AND CT_NO=" & Val(CStr(pCTNO)) & "" & vbCrLf & " AND CT_DATE=TO_DATE('" & VB6.Format(pCTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND ITEM_CODE ='" & pItemCode & "'"
            If pBookType = "S" Then
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)>0"
            Else
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',-1,1)*ITEM_QTY)>0"
            End If
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mBalCTQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                If pItemQty > mBalCTQty Then
                    MsgBox("No Enough C.T. 3 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                    UpdateCT3TRN = False
                    Exit Function
                End If
            Else
                MsgBox("No Enough C.T. 3 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                UpdateCT3TRN = False
                Exit Function
            End If
        End If
        If (pBookType = "S" And pBookSubType = "I") Or (pBookType = "P" And pBookSubType = "O") Then
            mSqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempUOM, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTempUOM.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTempUOM.Fields("ISSUE_UOM").Value), "", RsTempUOM.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTempUOM.Fields("PURCHASE_UOM").Value), "", RsTempUOM.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTempUOM.Fields("UOM_FACTOR").Value) Or RsTempUOM.Fields("UOM_FACTOR").Value = 0, 1, RsTempUOM.Fields("UOM_FACTOR").Value)
            End If
            If mIssueUOM <> mPurchaseUOM Then
                pItemQty = pItemQty * mFactor
            End If
        End If
        If pCTNO <> 0 And pItemQty > 0 Then
            SqlStr = "INSERT INTO FIN_CT_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " REF_NO, REF_DATE, " & vbCrLf & " CT_NO, CT_DATE, " & vbCrLf & " SUPP_CUST_CODE, " & vbCrLf & " ITEM_CODE, ITEM_UOM, " & vbCrLf & " ITEM_QTY, ITEM_VALUE " & vbCrLf & " ) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', " & vbCrLf & " '" & pRefNo & "', TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " " & Val(CStr(pCTNO)) & ", TO_DATE('" & VB6.Format(pCTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & pAccountCode & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "', '" & MainClass.AllowSingleQuote(pItemUOM) & "'," & vbCrLf & " " & pItemQty & ", " & pItemValue & ")"
            pDBCn.Execute(SqlStr)
        End If
        UpdateCT3TRN = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateCT3TRN = False
        ''Resume
    End Function
    Public Sub ShowTrnFromF4(ByRef xMkey As String, ByRef xVDate As String,
                             ByRef xVType As String, ByRef xVNo As String, ByRef xBookType As String, ByRef xBookSubType As String, ByRef pForm As System.Windows.Forms.Form)
        On Error GoTo ErrPart
        Call ShowTrn(xMkey, xVDate, xVType, xVNo, xBookType, xBookSubType, pForm)
        Exit Sub
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Sub
    Public Function GetValidRGPPurpose(ByRef pRGPNo As Double, ByRef mPurpose As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetValidRGPPurpose = True
        mSqlStr = "SELECT PURPOSE " & vbCrLf & " FROM INV_GATEPASS_HDR IH" & vbCrLf & " WHERE IH.Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.AUTO_KEY_PASSNO=" & pRGPNo & ""
        mSqlStr = mSqlStr & vbCrLf & " AND GATEPASS_DATE>'15-SEP-2012'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mPurpose = IIf(IsDBNull(RsTemp.Fields("PURPOSE").Value), "", RsTemp.Fields("PURPOSE").Value)
            If mPurpose = "D" Or mPurpose = "F" Or mPurpose = "G" Or mPurpose = "H" Then
                GetValidRGPPurpose = False
                Exit Function
            End If
        End If
        Exit Function
ErrPart:
        GetValidRGPPurpose = True
    End Function
    Public Function GetPendingGateEntryQty(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDivision As Double, Optional ByRef pRefNo As Double = 0) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        SqlStr = ""
        SqlStr = " SELECT SUM(BILL_QTY) AS BALQTY" & vbCrLf _
            & " FROM INV_GATEENTRY_HDR IH, INV_GATEENTRY_DET ID" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND SUBSTR(IH.AUTO_KEY_GATE,LENGTH(IH.AUTO_KEY_GATE)-5,4)=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
            & " AND IH.AUTO_KEY_GATE=ID.AUTO_KEY_GATE" & vbCrLf _
            & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND (IH.MRR_NO IS NULL OR IH.MRR_NO<1)"

        'If pDivision <> -1 Then
        '    SqlStr = SqlStr & vbCrLf & "AND IH.DIV_CODE=" & pDivision & ""
        'End If

        If Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND IH.AUTO_KEY_GATE<> " & Val(CStr(pRefNo)) & ""
        End If

        SqlStr = SqlStr & vbCrLf & " AND IH.GATE_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty * mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetPendingGateEntryQty = mBalQty
        Exit Function
ErrPart:
        GetPendingGateEntryQty = 0
    End Function
    Public Function GetItemQCEmp(ByRef mItemCode As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetItemQCEmp = ""
        mSqlStr = "SELECT QC_EMP_CODE " & vbCrLf & " FROM INV_ITEM_QC_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetItemQCEmp = IIf(IsDBNull(RsTemp.Fields("QC_EMP_CODE").Value), "", RsTemp.Fields("QC_EMP_CODE").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetItemArea(ByRef mItemCode As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim mHeight As Double
        Dim mWidth As Double

        Dim RsTemp As ADODB.Recordset = Nothing
        GetItemArea = 0

        mSqlStr = "SELECT MAT_LEN, MAT_WIDTH " & vbCrLf _
            & " FROM INV_ITEM_MST" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mHeight = IIf(IsDBNull(RsTemp.Fields("MAT_LEN").Value), 0, RsTemp.Fields("MAT_LEN").Value) / 1000
            mWidth = IIf(IsDBNull(RsTemp.Fields("MAT_WIDTH").Value), 0, RsTemp.Fields("MAT_WIDTH").Value) / 1000
            GetItemArea = VB6.Format(mHeight * mWidth, "0.00")
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function CheckMaxLevelApproval(ByRef pItemCode As String, ByRef pDate As String, ByRef pSuppCode As String, ByRef mApprovedQty As Double) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mAppQty As Double
        CheckMaxLevelApproval = False

        SqlStr = " SELECT SUM(APP_QTY) AS APP_QTY " & vbCrLf & " FROM INV_MAX_LEVEL_APP_DET" & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCode) & "'" & vbCrLf & " AND REF_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') "
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mAppQty = IIf(IsDBNull(RsTemp.Fields("APP_QTY").Value), 0, RsTemp.Fields("APP_QTY").Value)
            If mAppQty <= 0 Then Exit Function
            If mAppQty >= mApprovedQty Then
                CheckMaxLevelApproval = True
            End If
        End If
        Exit Function
ErrPart:
        CheckMaxLevelApproval = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckAutoIssueProd(ByRef xDate As String, ByRef pRMCode As String) As Boolean
        On Error GoTo ErrPart
        Dim xAutoIssue As Boolean
        Dim mProductType As String

        mProductType = GetProductionType(pRMCode)
        If mProductType = "J" Then
            CheckAutoIssueProd = True
            Exit Function
        End If

        If RsCompany.Fields("AUTO_ISSUE_PROD").Value = "N" Then
            CheckAutoIssueProd = False
        Else
            CheckAutoIssueProd = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Sub BillExpensesCalcTots(ByRef pSprdGrid As AxFPSpreadADO.AxfpSpread, ByRef pBillDate As String, ByRef pCST_ON_MRTL As Boolean, ByRef mNetAccessAmt As Double, ByRef mExciseableAmount As Double, ByRef mTaxableAmount As Double, ByRef mCEDCessAble As Double, ByRef mADDCessAble As Double, ByRef mCESSableAmount As Double, ByRef mTotItemAmount As Double, ByRef pTotExciseDuty As Double, ByRef pTotEduCess As Double, ByRef pTotSHECess As Double, ByRef pTotADE As Double, ByRef pTotExportExp As Double, ByRef pTotOthers As Double, ByRef pTotSalesTax As Double, ByRef pTotSurcharge As Double, ByRef pTotCustomDuty As Double, ByRef pTotAddCess As Double, ByRef pTotCustomDutyExport As Double, ByRef pTotCustomDutyCess As Double, ByRef pTotMSC As Double, ByRef pTotDiscount As Double, ByRef pTotServiceTax As Double, ByRef pTotRO As Double, ByRef pTotTCS As Double, ByRef mTotExp As Double, ByRef pEDPer As Double, ByRef pSTPer As Double, ByRef pServPer As Double, ByRef pCessPer As Double, ByRef pSHECPer As Double, ByRef pTCSPer As Double, ByRef pBookType As String, ByRef pTotServiceableAmount As Double, ByRef pTotKKCAmount As Double)
        On Error GoTo ERR1
        Dim mTaxValue As Double
        'Dim mEDAmount As Double
        Dim j As Integer
        Dim I As Integer
        Dim xStr As String
        Dim mExpPercent As Double
        Dim mSTAmount As Double
        Dim mExp As Double
        Dim mRoType As String
        Dim mExpAddDeduct As String
        Dim mExpCode As Integer
        Dim mDutyForgone As String
        Dim ColRO As Integer
        Dim ColExpName As Integer
        Dim ColExpPercent As Integer
        Dim ColExpAmt As Integer
        Dim ColExpSTCode As Integer
        Dim ColExpAddDeduct As Integer
        Dim ColExpIdent As Integer
        Dim ColTaxable As Integer
        Dim ColExciseable As Integer
        Dim ColExpCalcOn As Integer
        Dim ColDutyForgone As Integer
        Dim pRound As Double
        Dim pTotSBCAmount As Double
        'Dim pTotKKCAmount As Double
        ColRO = 1
        ColExpName = 2
        ColExpPercent = 3
        ColExpAmt = 4
        ColExpSTCode = 5
        ColExpAddDeduct = 6
        ColExpIdent = 7
        ColTaxable = 8
        ColExciseable = 9
        ColExpCalcOn = 10
        ColDutyForgone = IIf(pBookType = "P", 12, 11)
        With pSprdGrid
            j = .MaxRows
            For I = 1 To j
                .Row = I
                .Col = 0
                If .Text = "Del" Then GoTo DontCalc1
                If pBookType = "P" Or pBookType = "S" Then

                    .Col = ColDutyForgone
                    mDutyForgone = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N")
                    'Else
                    'mDutyForgone = "N"
                    'End If
                Else
                    mDutyForgone = "N"
                End If

                .Col = ColRO
                mRoType = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N")
                .Col = ColExpIdent
                xStr = .Text
                .Col = ColExpPercent
                mExpPercent = Val(.Text)
                .Col = ColExpAddDeduct
                mExpAddDeduct = Trim(.Text)
                .Col = ColExpSTCode
                mExpCode = Val(.Text)
                .Col = ColExpAmt
                Select Case xStr
                    Case "DOB"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(mTotItemAmount) * mExpPercent / 100, "0.00") ''
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotDiscount = pTotDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "VOD"
                        If mExpPercent <> 0 Then
                            If CDate(pBillDate) < CDate("26/05/2016") Then
                                .Text = VB6.Format(Val(mTotItemAmount) * mExpPercent / 100, "0.00") ''
                            Else
                                .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00") ''
                            End If
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotDiscount = pTotDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "EE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotExportExp = pTotExportExp + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "BCE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00") ''* 25 / 100
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDutyExport = pTotCustomDutyExport + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "BCD"
                        If mExpPercent <> 0 Then
                            If RsCompany.Fields("FYEAR").Value >= 2009 Then
                                .Text = VB6.Format((Val(CStr(mNetAccessAmt)) * mExpPercent / 100) * 50 / 100, "0.00")
                            Else
                                .Text = VB6.Format((Val(CStr(mNetAccessAmt)) * mExpPercent / 100) * 25 / 100, "0.00")
                            End If
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDuty = pTotCustomDuty + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "CED"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mCEDCessAble * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDutyCess = pTotCustomDutyCess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "HCC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mCEDCessAble * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDutyCess = pTotCustomDutyCess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "AEC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mADDCessAble * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotAddCess = pTotAddCess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "AHC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mADDCessAble * mExpPercent / 100, "0.0r0")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotAddCess = pTotAddCess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "ED"
                        If mExpPercent <> 0 Then
                            '.Text = VB6.Format(Val(mNetAccessAmt + mBCDAmount + mBCDAmountExp) * mExpPercent / 100, "0.00")
                            .Text = VB6.Format(Val(CStr(mExciseableAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pEDPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        'mEDAmount = mEDAmount + Val(.Text)
                        pTotExciseDuty = pTotExciseDuty + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "SER"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(pTotServiceableAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotServiceTax = pTotServiceTax + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "SBC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(pTotServiceableAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotSBCAmount = pTotSBCAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "KKC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(pTotServiceableAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotKKCAmount = pTotKKCAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "EDU"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mCESSableAmount * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pCessPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        pTotEduCess = pTotEduCess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "SHC"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mCESSableAmount * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pSHECPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        pTotSHECess = pTotSHECess + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "ADE"
                        If mExpPercent <> 0 Then
                            If RsCompany.Fields("ISEOU").Value = "Y" Then
                                .Text = VB6.Format((mTotItemAmount + mADDCessAble) * mExpPercent / 100, "0.00")
                            Else
                                .Text = VB6.Format(pTotExciseDuty * mExpPercent / 100, "0.00")
                            End If
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotADE = pTotADE + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "ST"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mTaxableAmount * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pSTPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        mSTAmount = Val(.Text)
                        pTotSalesTax = pTotSalesTax + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "SUR"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(pTotSalesTax * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotSurcharge = pTotSurcharge + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "MSC"
                        mTaxValue = Val(.Text)
                        pTotMSC = pTotMSC + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "EMS"
                        mTaxValue = Val(.Text)
                        'pTotEMS = pTotEMS + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "OTR", "FRO", "TOL"
                        mTaxValue = Val(.Text)
                        pTotOthers = pTotOthers + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "RO"
                        mTaxValue = Val(.Text)
                        pTotRO = pTotRO + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                    Case "TCS"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format((mTotExp + mTotItemAmount) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pTCSPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        pTotTCS = pTotTCS + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                        Call GetTaxableamount(mExpCode, mTaxValue, mExpAddDeduct, mExciseableAmount, mNetAccessAmt, mTaxableAmount, mCEDCessAble, mADDCessAble, mCESSableAmount, mTotExp, mDutyForgone, pCST_ON_MRTL)
                End Select
                '.Col = ColExpAddDeduct
                'If xStr = "RO" Then
                'mTotExp = mTotExp + mExp
                'Else
                'mTotExp = mTotExp + IIf(.Text = "D", -mExp, mExp)
                'End If
                'mExp = 0
DontCalc1:
            Next I
        End With
        Exit Sub
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        'Resume
    End Sub
    Public Sub BillExpensesCalcTots_GST(ByRef pSprdGrid As AxFPSpreadADO.AxfpSpread, ByRef pBillDate As String, ByRef mNetAccessAmt As Double, ByRef mTotItemAmount As Double, ByRef mTaxableAmount As Double, ByRef mIGSTPer As Double, ByRef mSGSTPer As Double, ByRef mCGSTPer As Double, ByRef mIGSTAmount As Double, ByRef mSGSTAmount As Double, ByRef mCGSTAmount As Double, ByRef pTotExportExp As Double, ByRef mFreightper As Double, ByRef mFreightAmount As Double, ByRef pTotOthers As Double, ByRef pTotCustomDutyExport As Double, ByRef pTotCustomDuty As Double, ByRef pTotMSC As Double, ByRef pTotDiscount As Double, ByRef pTotVODDiscount As Double, ByRef pTotRO As Double, ByRef pTotTCS As Double, ByRef mTotExp As Double, ByRef pTCSPer As Double, ByRef pBookType As String)
        On Error GoTo ERR1
        Dim mTaxValue As Double
        'Dim mEDAmount As Double
        Dim j As Integer
        Dim I As Integer
        Dim xStr As String
        Dim mExpPercent As Double
        Dim mExp As Double
        Dim mRoType As String
        Dim mExpAddDeduct As String
        Dim mExpCode As Integer
        Dim mDutyForgone As String
        Dim ColRO As Integer
        Dim ColExpName As Integer
        Dim ColExpPercent As Integer
        Dim ColExpAmt As Integer
        Dim ColExpSTCode As Integer
        Dim ColExpAddDeduct As Integer
        Dim ColExpIdent As Integer
        Dim ColTaxable As Integer
        Dim ColExciseable As Integer
        Dim ColExpCalcOn As Integer
        Dim ColDutyForgone As Integer
        Dim pRound As Double
        ColRO = 1
        ColExpName = 2
        ColExpPercent = 3
        ColExpAmt = 4
        ColExpSTCode = 5
        ColExpAddDeduct = 6
        ColExpIdent = 7
        ColTaxable = 8
        ColExciseable = 9
        ColExpCalcOn = 10
        ColDutyForgone = IIf(pBookType = "P", 12, 11)
        With pSprdGrid
            j = .MaxRows
            For I = 1 To j
                mTaxValue = 0
                .Row = I
                .Col = 0
                If .Text = "Del" Then GoTo DontCalc1
                If pBookType = "P" Or pBookType = "S" Then
                    .Col = ColDutyForgone
                    If .Value = "" Then
                        mDutyForgone = "N"
                    Else
                        mDutyForgone = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N")
                    End If
                Else
                    mDutyForgone = "N"
                End If
                .Col = ColRO
                mRoType = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N") ''"Y" ''
                .Col = ColExpIdent
                xStr = .Text
                .Col = ColExpPercent
                mExpPercent = Val(.Text)
                .Col = ColExpAddDeduct
                mExpAddDeduct = Trim(.Text)
                .Col = ColExpSTCode
                mExpCode = Val(.Text)
                .Col = ColExpAmt
                Select Case xStr
                    Case "DOB"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mTotItemAmount * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotDiscount = pTotDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "VOD"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00") ''
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotVODDiscount = pTotVODDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "EE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotExportExp = pTotExportExp + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "BCE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDutyExport = pTotCustomDutyExport + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "BCD"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00") ''* 50 / 100
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDuty = pTotCustomDuty + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "IGS"
                        .Text = VB6.Format(mIGSTAmount, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mIGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mIGSTAmount = mIGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "SGS"
                        .Text = VB6.Format(mSGSTAmount, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mSGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mSGSTAmount = mSGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "CGS"
                        .Text = VB6.Format(mCGSTAmount, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mCGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mCGSTAmount = mCGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "FRO"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00")  ''mTaxableAmount Sandeep
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            mFreightper = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        mFreightAmount = mFreightAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "MSC"
                        mTaxValue = Val(.Text)
                        pTotMSC = pTotMSC + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "OTR", "TOL", "MSR"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If

                        End If
                        mTaxValue = Val(.Text)
                        pTotOthers = pTotOthers + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "RO"
                        mTaxValue = Val(.Text)
                        pTotRO = pTotRO + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "TCS"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format((mTotExp + mTotItemAmount + (mIGSTAmount + mSGSTAmount + mCGSTAmount)) * mExpPercent / 100, "0.00")
                            'If mRoType = "Y" Then
                            'If CDate(PubCurrDate) >= CDate("22/12/2024") Then
                            .Text = CStr(System.Math.Ceiling(Val(.Text)))
                            'Else
                            '    .Text = CStr(System.Math.Round(Val(.Text), 0))
                            'End If
                            '
                            'End If
                            pTCSPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        pTotTCS = pTotTCS + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                End Select
                mTotExp = Val(CStr(mTotExp)) + (IIf(mDutyForgone = "Y", 0, mTaxValue) * IIf(mExpAddDeduct = "D", -1, 1))
                'Call GetTaxableamount_GST(mExpCode, mTaxValue, mExpAddDeduct, mNetAccessAmt, mTaxableAmount, mTotExp, mDutyForgone)
DontCalc1:
            Next I
        End With
        Exit Sub
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        'Resume
    End Sub
    Public Sub BillExpensesOnlyGSTCalc(ByRef pSprdGrid As AxFPSpreadADO.AxfpSpread, ByRef pBillDate As String, ByRef mNetAccessAmt As Double, ByRef mTotItemAmount As Double, ByRef mTaxableAmount As Double, ByRef mIGSTPer As Double, ByRef mSGSTPer As Double, ByRef mCGSTPer As Double, ByRef mIGSTAmount As Double, ByRef mSGSTAmount As Double, ByRef mCGSTAmount As Double, ByRef pTotExportExp As Double, ByRef mFreightper As Double, ByRef mFreightAmount As Double, ByRef pTotOthers As Double, ByRef pTotCustomDutyExport As Double, ByRef pTotCustomDuty As Double, ByRef pTotMSC As Double, ByRef pTotDiscount As Double, ByRef pTotVODDiscount As Double, ByRef pTotRO As Double, ByRef pTotTCS As Double, ByRef mTotExp As Double, ByRef pTCSPer As Double, ByRef pBookType As String)
        On Error GoTo ERR1
        Dim mTaxValue As Double
        'Dim mEDAmount As Double
        Dim j As Integer
        Dim I As Integer
        Dim xStr As String
        Dim mExpPercent As Double
        Dim mExp As Double
        Dim mRoType As String
        Dim mExpAddDeduct As String
        Dim mExpCode As Integer
        Dim mDutyForgone As String
        Dim ColRO As Integer
        Dim ColExpName As Integer
        Dim ColExpPercent As Integer
        Dim ColExpAmt As Integer
        Dim ColExpSTCode As Integer
        Dim ColExpAddDeduct As Integer
        Dim ColExpIdent As Integer
        Dim ColTaxable As Integer
        Dim ColExciseable As Integer
        Dim ColExpCalcOn As Integer
        Dim ColDutyForgone As Integer
        Dim pRound As Double
        ColRO = 1
        ColExpName = 2
        ColExpPercent = 3
        ColExpAmt = 4
        ColExpSTCode = 5
        ColExpAddDeduct = 6
        ColExpIdent = 7
        ColTaxable = 8
        ColExciseable = 9
        ColExpCalcOn = 10
        ColDutyForgone = IIf(pBookType = "P", 12, 11)
        With pSprdGrid
            j = .MaxRows
            For I = 1 To j
                mTaxValue = 0
                .Row = I
                .Col = 0
                If .Text = "Del" Then GoTo DontCalc1
                If pBookType = "P" Or pBookType = "S" Then
                    .Col = ColDutyForgone
                    If .Value = "" Then
                        mDutyForgone = "N"
                    Else
                        mDutyForgone = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N")
                    End If
                Else
                    mDutyForgone = "N"
                End If
                .Col = ColRO
                mRoType = IIf(.Value = CStr(System.Windows.Forms.CheckState.Checked), "Y", "N") ''"Y" ''
                .Col = ColExpIdent
                xStr = .Text
                .Col = ColExpPercent
                mExpPercent = Val(.Text)
                .Col = ColExpAddDeduct
                mExpAddDeduct = Trim(.Text)
                .Col = ColExpSTCode
                mExpCode = Val(.Text)
                .Col = ColExpAmt
                Select Case xStr
                    Case "DOB"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(mTotItemAmount * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotDiscount = pTotDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "VOD"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00") ''
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotVODDiscount = pTotVODDiscount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "EE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTotItemAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotExportExp = pTotExportExp + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "BCE"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDutyExport = pTotCustomDutyExport + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "BCD"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mNetAccessAmt)) * mExpPercent / 100, "0.00") ''* 50 / 100
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                        End If
                        mTaxValue = Val(.Text)
                        pTotCustomDuty = pTotCustomDuty + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "IGS"
                        mIGSTAmount = VB6.Format(.Text, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mIGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mIGSTAmount = mIGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "SGS"
                        mSGSTAmount = VB6.Format(.Text, "0.00")        ''.Text = VB6.Format(, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mSGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mSGSTAmount = mSGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "CGS"
                        mCGSTAmount = VB6.Format(.Text, "0.00")        ''.Text = VB6.Format(mCGSTAmount, "0.00")
                        'If mExpPercent <> 0 Then
                        '.Text = VB6.Format(Val(mTaxableAmount) * mExpPercent / 100, "0.00")
                        'If mRoType = "Y" Then
                        '.Text = Round(Val(.Text), 0)
                        'End If
                        'mCGSTPer = mExpPercent
                        'End If
                        '
                        'mTaxValue = Val(.Text)
                        'mCGSTAmount = mCGSTAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "FRO"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format(Val(CStr(mTaxableAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            mFreightper = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        mFreightAmount = mFreightAmount + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "MSC"
                        mTaxValue = Val(.Text)
                        pTotMSC = pTotMSC + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "OTR", "TOL", "MSR"
                        mTaxValue = Val(.Text)
                        pTotOthers = pTotOthers + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "RO"
                        mTaxValue = Val(.Text)
                        pTotRO = pTotRO + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                    Case "TCS"
                        If mExpPercent <> 0 Then
                            .Text = VB6.Format((mTotExp + mTotItemAmount + (mIGSTAmount + mSGSTAmount + mCGSTAmount)) * mExpPercent / 100, "0.00")
                            If mRoType = "Y" Then
                                .Text = CStr(System.Math.Round(Val(.Text), 0))
                            End If
                            pTCSPer = mExpPercent
                        End If
                        mTaxValue = Val(.Text)
                        pTotTCS = pTotTCS + (mTaxValue * IIf(mExpAddDeduct = "D", -1, 1))
                End Select
                mTotExp = Val(CStr(mTotExp)) + (IIf(mDutyForgone = "Y", 0, mTaxValue) * IIf(mExpAddDeduct = "D", -1, 1))
                'Call GetTaxableamount_GST(mExpCode, mTaxValue, mExpAddDeduct, mNetAccessAmt, mTaxableAmount, mTotExp, mDutyForgone)
DontCalc1:
            Next I
        End With
        Exit Sub
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        'Resume
    End Sub
    Public Function UpdateCRTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefNo As Double, ByRef pRefDate As String, ByRef pRefType As String, ByRef pPartyCode As String, ByRef pMRRNo As String, ByRef pMRRDate As String, ByRef pOBillNo As String, ByRef pOBillDate As String, ByRef pItemCode As String, ByRef pItemQty As Double, ByRef pItemUOM As String, ByRef pItemRate As Double, ByRef pStockType As String, ByRef pIO As String, ByRef pCompletionDate As String, ByRef pDivCode As Integer, ByRef pDeptCode As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If pItemQty > 0 Then
            SqlStr = "INSERT INTO DSP_CR_TRN ( " & vbCrLf & " COMPANY_CODE, FYEAR, AUTO_KEY_REF, REF_DATE, " & vbCrLf & " REF_TYPE, SUPP_CUST_CODE," & vbCrLf & " AUTO_KEY_MRR, MRR_DATE, " & vbCrLf & " O_BILL_NO, O_BILL_DATE, " & vbCrLf & " ITEM_CODE, ITEM_QTY, ITEM_UOM, " & vbCrLf & " ITEM_RATE , STOCK_TYPE, ITEM_IO, COMPLETION_DATE,DIV_CODE,DEPT_CODE " & vbCrLf & " ) VALUES ( " & vbCrLf & " " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & Val(CStr(pRefNo)) & ", TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pRefType & "', '" & MainClass.AllowSingleQuote(pPartyCode) & "'," & vbCrLf & " " & Val(pMRRNo) & ", TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " " & Val(pOBillNo) & ", TO_DATE('" & VB6.Format(pOBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "', " & Val(CStr(pItemQty)) & ", '" & MainClass.AllowSingleQuote(pItemUOM) & "'," & vbCrLf & " " & Val(CStr(pItemRate)) & ", '" & MainClass.AllowSingleQuote(pStockType) & "', '" & pIO & "'," & vbCrLf & " TO_DATE('" & VB6.Format(pCompletionDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & pDivCode & ",'" & pDeptCode & "'" & vbCrLf & " )"
            pDBCn.Execute(SqlStr)
        End If
        UpdateCRTRN = True
        Exit Function
UpdateStockTRNErr:
        'Resume Next
        UpdateCRTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function CheckStockQty(ByRef pSprd As AxFPSpreadADO.AxfpSpread, ByRef StockCol1 As Integer, ByRef CheckCol As Integer, ByRef ItemCodeCol As Integer, ByRef StockTypeCol As Integer, Optional ByRef CheckStock As Boolean = False, Optional ByRef JobWorkStockType As Boolean = False, Optional ByRef pDemandCol As String = "") As Boolean
        On Error GoTo ErrPart
        Dim cntRow As Integer
        Dim mStockQty As Double
        Dim mCheck1Qty As Double
        Dim mStockType As String = ""
        Dim mItemCode As String
        Dim mProdType As String
        Dim mMinimumQty As Double
        Dim mAllowQty As Double

        CheckStockQty = True
        'If CheckStock = False Then
        If RsCompany.Fields("StockBalCheck").Value = "N" Then
            CheckStockQty = True
            Exit Function
        End If
        'End If
        With pSprd
            For cntRow = 1 To .MaxRows - 1
                .Row = cntRow
                .Col = ItemCodeCol
                mItemCode = Trim(.Text)
                If StockTypeCol <> -1 Then
                    .Col = StockTypeCol
                    mStockType = Trim(.Text)
                End If
                If pDemandCol = "Y" Then
                    mProdType = GetProductionType(mItemCode)
                    If mProdType = "P" Or mProdType = "B" Or mProdType = "I" Or mProdType = "R" Or mProdType = "3" Then
                        GoTo NextRow
                    End If
                End If
                .Col = CheckCol
                mCheck1Qty = Val(.Text)

                If mCheck1Qty = 0 Then GoTo NextRow
                If mCheck1Qty <> 0 And JobWorkStockType = False Then
                    'If ValidateStockType(PubDBCn, mItemCode, mStockType) = False Then
                    '    MainClass.SetFocusToCell(pSprd, cntRow, StockTypeCol)
                    '    CheckStockQty = False
                    '    Exit Function
                    'End If
                End If
                .Row = cntRow
                .Col = StockCol1
                mStockQty = Val(.Text)
                .Col = CheckCol
                mCheck1Qty = Val(.Text)
                If MainClass.ValidateWithMasterTable(mItemCode, "ITEM_CODE", "STOCKITEM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND STOCKITEM='N'") = False Then
                    If mStockQty < mCheck1Qty And mCheck1Qty <> 0 Then
                        MsgInformation("You Have Not Enough Stock. For Item Code : " & mItemCode)
                        MainClass.SetFocusToCell(pSprd, cntRow, CheckCol)
                        CheckStockQty = False
                        Exit Function
                    End If
                End If
NextRow:
            Next
        End With
        Exit Function
ErrPart:
        CheckStockQty = False
    End Function

    Public Function CheckDespatchAllowQty(ByRef mSuppCustCode As String, ByRef mItemCode As String, ByRef mDate As String) As Double

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing

        CheckDespatchAllowQty = 0


        mSqlStr = " SELECT SUM(QTY) AS QTY " & vbCrLf _
            & " FROM DSP_DESPATCH_UNLOCK_TRN IH" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.SUPP_CUST_CODE='" & mSuppCustCode & "' AND IH.ITEM_CODE='" & mItemCode & "' " & vbCrLf _
            & " AND IH.ALLOW_DATE=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = True Then
            CheckDespatchAllowQty = IIf(IsDBNull(RsTemp.Fields("QTY").Value), 0, RsTemp.Fields("QTY").Value)
        End If

        Exit Function
ErrPart:
        '' ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function


    Public Function PurRejPostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVType As String,
                                     ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pPartyCode As String,
                                     ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pDueDate As String,
                                     ByRef pNarration As String, ByRef pReason As String, ByRef pExpAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String,
                                     ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef xIsGST As String, ByRef xCGSTAMT As Double, ByRef xSGSTAMT As Double,
                                     ByRef xIGSTAMT As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mGSTAmount As Double
        Dim mDrCr As String
        Dim mErrField As String
        Dim mTRNType As String
        Dim xExpAmount As String
        Dim pDNBillNo As String
        Dim pDNBillDate As String
        Dim xNarration As String
        Dim mBillWiseExpAmt As Double
        Dim mBalBillWiseExpAmt As Double
        Dim mItemValue As Double
        If RsCompany.Fields("FYEAR").Value < 2018 Then
            PurRejPostTRNGST = True
            Exit Function
        End If
        SqlStr = ""
        mSubRowNo = 1
        pNarration = IIf(pNarration = "", "", " ( D/N of :") & pBillNo & " Date : " & pBillDate & IIf(pNarration = "", "", " )")
        mTRNType = "D"
        If Trim(pBillNo) = "" Then
            pBillNo = pVNo
            pBillDate = pVDate
        End If
        If pCancel = True Then
            pNarration = "D/N No : " & pVNo & " (Cancelled)"
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookSubType='" & UCase(pBookSubType) & "'")
        If pCancel = True Then
            PurRejPostTRNGST = True
            Exit Function
        End If
        If xIsGST = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "CGST Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_REJDR_RETURNCODE").Value)
            mAmount = xCGSTAMT
            mDrCr = "D"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            'mAccountCode = IIf(IsNull(RsCompany.Fields("CGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_DR_RETURNCODE").Value)
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
            mAmount = xCGSTAMT
            mDrCr = "C"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            mErrField = "SGST Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_REJDR_RETURNCODE").Value)
            mAmount = xSGSTAMT
            mDrCr = "D"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            'mAccountCode = IIf(IsNull(RsCompany.Fields("SGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_DR_RETURNCODE").Value)
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
            mAmount = xSGSTAMT
            mDrCr = "C"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            mErrField = "IGST Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_REJDR_RETURNCODE").Value)
            mAmount = xIGSTAMT
            mDrCr = "D"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            'mAccountCode = IIf(IsNull(RsCompany.Fields("IGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_DR_RETURNCODE").Value)
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
            mAmount = xIGSTAMT
            mDrCr = "C"
            If pCancel = True Then
                mAmount = 0
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
        End If
        '**********************************************************************'
        PurRejPostTRNGST = True
        Exit Function
SalePostTrnErr:
        PurRejPostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetCRStockQty(ByRef pMRRNo As Double, ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pDivCode As Integer, ByRef pStockType As String, Optional ByRef pRefNo As String = "") As Double
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetCRStockQty = 0
        If Val(CStr(pMRRNo)) = 0 Then Exit Function
        If Trim(pItemCode) = "" Then Exit Function
        If Val(CStr(pDivCode)) = 0 Then Exit Function
        If pStockType <> "CR" Then
            If Trim(pDeptCode) = "" Then Exit Function
        End If
        GetCRStockQty = 0
        SqlStr = "SELECT SUM(DECODE(ITEM_IO,'I',1,-1) * ITEM_QTY) As ITEM_QTY" & vbCrLf _
            & " FROM DSP_CR_TRN" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
            & " AND STOCK_TYPE='" & pStockType & "'" & vbCrLf & " AND DIV_CODE=" & pDivCode & ""

        If Val(CStr(pMRRNo)) <> -1 Then
            SqlStr = SqlStr & vbCrLf & " AND AUTO_KEY_MRR=" & pMRRNo & ""
        End If
        If Trim(pDeptCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND DEPT_CODE='" & pDeptCode & "'"
        End If
        If Trim(pRefNo) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE||AUTO_KEY_REF<>'" & Trim(pRefNo) & "'"
        End If
        If Val(CStr(pMRRNo)) <> -1 Then
            SqlStr = SqlStr & vbCrLf & " GROUP BY AUTO_KEY_MRR, MRR_DATE, ITEM_CODE,ITEM_UOM " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1) * ITEM_QTY)>0"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCRStockQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCRData(ByRef pMRRNo As Double, ByRef pProductCode As String, ByRef mSupplierCode As String, ByRef mOrgBillNO As Double, ByRef mOrdBillDate As String, ByRef mItemRate As Double, Optional ByRef mMRRDate As String = "") As Boolean
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetCRData = False
        mSupplierCode = ""
        mOrgBillNO = -1
        mOrdBillDate = ""
        mItemRate = 0
        mMRRDate = ""
        SqlStr = "SELECT SUPP_CUST_CODE, O_BILL_NO, O_BILL_DATE, ITEM_RATE,MRR_DATE" & vbCrLf & " FROM DSP_CR_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTO_KEY_MRR=" & pMRRNo & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND REF_TYPE IN ('MRR','OP')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSupplierCode = IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_CODE").Value), "-1", RsTemp.Fields("SUPP_CUST_CODE").Value)
            mOrgBillNO = IIf(IsDBNull(RsTemp.Fields("O_BILL_NO").Value), 0, RsTemp.Fields("O_BILL_NO").Value)
            mOrdBillDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("O_BILL_DATE").Value), "", RsTemp.Fields("O_BILL_DATE").Value), "DD/MM/YYYY")
            mItemRate = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value), "0.00"))
            mMRRDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("MRR_DATE").Value), "", RsTemp.Fields("MRR_DATE").Value), "DD/MM/YYYY")
        End If
        GetCRData = True
        Exit Function
ERR1:
        GetCRData = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function UpdateManyF4TRN(ByRef pItemCode As String, ByRef pWEFDate As String, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pItemQty As Double, ByRef pIO As String, ByRef pSubRowNo As Integer, ByRef pTRNType As String, ByRef pVDate As String, ByRef pIsScrap As String, ByRef pIsScrapMaterial As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTrn As ADODB.Recordset = Nothing
        Dim mSubItemCode As String
        Dim mMKey As String
        Dim pF4No As String
        Dim pF4Date As String
        Dim xAlterItemCode As String
        Dim mStdQty As Double
        Dim mReqdQty As Double
        Dim mUsedQty As Double
        Dim mItemF4ConsQty As Double
        Dim xItemUOM As String = ""
        UpdateManyF4TRN = False

        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.RM_CODE,STD_QTY/OUTPUT_QTY ASSTD_QTY" & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND ID.STOCK_TYPE='CS'"
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(SH.WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR SH, PRD_NEWBOM_DET SD" & vbCrLf & " WHERE SH.MKEY=SD.MKEY" & vbCrLf & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SH.PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND SD.STOCK_TYPE='CS'" & vbCrLf & " AND SH.WEF<=TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mSubItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value))
                If MainClass.ValidateWithMasterTable(mSubItemCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    xItemUOM = MasterNo
                End If
                mStdQty = IIf(IsDBNull(RsTemp.Fields("STD_QTY").Value), 0, RsTemp.Fields("STD_QTY").Value)
                If xItemUOM = "KGS" Then
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "TON" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "MT" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                End If
                mReqdQty = mStdQty * pItemQty
                mMKey = Trim(IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value))
                mUsedQty = 0
                SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY) AS ITEM_QTY,ITEM_CODE,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE = '" & mSubItemCode & "'" & vbCrLf & " AND ISSCRAP ='N'" & vbCrLf & " GROUP BY " & vbCrLf & " PARTY_F4NO,PARTY_F4DATE,ITEM_CODE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY)>0"
                SqlStr = SqlStr & vbCrLf & " ORDER BY PARTY_F4DATE, PARTY_F4NO"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTrn.EOF = False Then
                    Do While RsTrn.EOF = False
                        If RsTrn.EOF = False Then
                            mSubItemCode = IIf(IsDBNull(RsTrn.Fields("ITEM_CODE").Value), "", RsTrn.Fields("ITEM_CODE").Value)
                            pF4No = IIf(IsDBNull(RsTrn.Fields("PARTY_F4NO").Value), "", RsTrn.Fields("PARTY_F4NO").Value)
                            pF4Date = IIf(IsDBNull(RsTrn.Fields("PARTY_F4DATE").Value), "", RsTrn.Fields("PARTY_F4DATE").Value)
                            mItemF4ConsQty = IIf(IsDBNull(RsTrn.Fields("ITEM_QTY").Value), 0, RsTrn.Fields("ITEM_QTY").Value)
                            mUsedQty = mUsedQty + mItemF4ConsQty / mStdQty
                            If mReqdQty <= mItemF4ConsQty Then
                                mItemF4ConsQty = mReqdQty
                                mReqdQty = 0
                            End If
                            If pF4No <> "" And pItemQty > 0 Then
                                SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUB_ITEM_CODE, " & vbCrLf & " SUBROWNO,BILL_QTY,TRNTYPE, VDATE, ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(mSubItemCode) & "', " & vbCrLf & " " & mItemF4ConsQty & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " " & pSubRowNo & "," & pItemQty & ",'" & pTRNType & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "' )"
                                PubDBCn.Execute(SqlStr)
                            End If
                            If mReqdQty <= 0 Then
                                Exit Do
                            Else
                                mReqdQty = mReqdQty - mItemF4ConsQty
                            End If
                            RsTrn.MoveNext()
                        End If
                    Loop
                End If
                If mReqdQty > 0 Then
                    mStdQty = 0
                    xAlterItemCode = GetAlterItemCode(mMKey, mSubItemCode, mStdQty)
                    If xAlterItemCode <> "" Then
                        'mStdQty = IIf(IsNull(RsTemp!STD_QTY), 0, RsTemp!STD_QTY)
                        mReqdQty = mStdQty * (pItemQty - mUsedQty) ''pItemQty - mReqdQty / 1
                        SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY) AS ITEM_QTY,ITEM_CODE,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE IN (" & xAlterItemCode & ")" & vbCrLf & " AND ISSCRAP ='N'" & vbCrLf & " GROUP BY " & vbCrLf & " PARTY_F4NO,PARTY_F4DATE,ITEM_CODE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY)>0"
                        SqlStr = SqlStr & vbCrLf & " ORDER BY PARTY_F4DATE, PARTY_F4NO"
                        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTrn.EOF = False Then
                            Do While RsTrn.EOF = False
                                If RsTrn.EOF = False Then
                                    mSubItemCode = IIf(IsDBNull(RsTrn.Fields("ITEM_CODE").Value), "", RsTrn.Fields("ITEM_CODE").Value)
                                    pF4No = IIf(IsDBNull(RsTrn.Fields("PARTY_F4NO").Value), "", RsTrn.Fields("PARTY_F4NO").Value)
                                    pF4Date = IIf(IsDBNull(RsTrn.Fields("PARTY_F4DATE").Value), "", RsTrn.Fields("PARTY_F4DATE").Value)
                                    mItemF4ConsQty = IIf(IsDBNull(RsTrn.Fields("ITEM_QTY").Value), 0, RsTrn.Fields("ITEM_QTY").Value)
                                    If mReqdQty <= mItemF4ConsQty Then
                                        mItemF4ConsQty = mReqdQty
                                        mReqdQty = 0
                                    End If
                                    If pF4No <> "" And pItemQty > 0 Then
                                        SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUB_ITEM_CODE, " & vbCrLf & " SUBROWNO,BILL_QTY,TRNTYPE, VDATE, ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(mSubItemCode) & "', " & vbCrLf & " " & mItemF4ConsQty & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " " & pSubRowNo & "," & pItemQty & ",'" & pTRNType & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "' )"
                                        PubDBCn.Execute(SqlStr)
                                    End If
                                    If mReqdQty <= 0 Then
                                        Exit Do
                                    Else
                                        mReqdQty = mReqdQty - mItemF4ConsQty
                                    End If
                                    RsTrn.MoveNext()
                                End If
                            Loop
                        End If
                    End If

                    If mReqdQty > 0 Then
                        MsgInformation("You have not Enough Stock of (" & pItemCode & "/" & mSubItemCode & ") , cann't be save.")
                        UpdateManyF4TRN = False
                        Exit Function
                    End If

                End If
                RsTemp.MoveNext()
            Loop
        End If
        UpdateManyF4TRN = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateManyF4TRN = False
    End Function
    Public Function ValidateStockType(ByRef pPvtDBCn As ADODB.Connection, ByRef pItemCode As String, ByRef pStockType As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCheckStockType As String = ""
        ValidateStockType = False
        If pItemCode = "" Or pStockType = "" Then ValidateStockType = True : Exit Function
        If pStockType = "WR" Or pStockType = "QC" Or pStockType = "RJ" Or pStockType = "CR" Or pStockType = "WP" Or pStockType = "SC" Then ValidateStockType = True : Exit Function
        SqlStr = " SELECT STOCKTYPE " & vbCrLf & " FROM INV_ITEM_MST INVMST, INV_GENERAL_MST GMST" & vbCrLf & " WHERE INVMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND INVMST.COMPANY_CODE=GMST.COMPANY_CODE " & vbCrLf & " AND INVMST.CATEGORY_CODE=GMST.GEN_CODE AND GMST.GEN_TYPE='C'" & vbCrLf & " AND ITEM_CODE='" & pItemCode & "' "
        MainClass.UOpenRecordSet(SqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        With RsTemp
            If .EOF = False Then
                mCheckStockType = IIf(IsDBNull(RsTemp.Fields("STOCKTYPE").Value), "", RsTemp.Fields("STOCKTYPE").Value)
            End If
        End With
        If mCheckStockType = "FG" Then ValidateStockType = True : Exit Function
        If pStockType = mCheckStockType Then
            ValidateStockType = True
        Else
            MsgInformation("Stock Type Not Valid for this Item. Please Check Category For this Item.")
            ValidateStockType = False
        End If
        Exit Function
ErrPart:
        ValidateStockType = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetTaxableamount(ByRef mExpCode As Integer, ByRef mTaxValue As Double, ByRef mExpAddDeduct As String, ByRef mExciseableAmount As Double, ByRef mNetAccessAmt As Double, ByRef mTaxableAmount As Double, ByRef mCEDCessAble As Double, ByRef mADDCessAble As Double, ByRef mCESSableAmount As Double, ByRef mTotExp As Double, ByRef mDutyForgone As String, ByRef pCST_ON_MRTL As Boolean) As Double
        On Error GoTo ERR1
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mISExciseable As String
        Dim mIsTaxable As String
        Dim mIsCESSableAmount As String
        Dim mIsCEDCessAble As String
        Dim mIsADDCessAble As String
        GetTaxableamount = 0
        mTotExp = Val(CStr(mTotExp)) + (IIf(mDutyForgone = "Y", 0, mTaxValue) * IIf(mExpAddDeduct = "D", -1, 1))
        SqlStr = "SELECT * FROM FIN_INTERFACE_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND CODE=" & Val(CStr(mExpCode)) & ""
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        mISExciseable = "N"
        mIsTaxable = "N"
        mIsCESSableAmount = "N"
        mIsCEDCessAble = "N"
        mIsADDCessAble = "N"
        If RsTemp.EOF = False Then
            mISExciseable = IIf(IsDBNull(RsTemp.Fields("EXCISEABLE").Value), "N", RsTemp.Fields("EXCISEABLE").Value)
            mIsTaxable = IIf(IsDBNull(RsTemp.Fields("TAXABLE").Value), "N", RsTemp.Fields("TAXABLE").Value)
            mIsCESSableAmount = IIf(IsDBNull(RsTemp.Fields("CESSABLE").Value), "N", RsTemp.Fields("CESSABLE").Value)
            mIsCEDCessAble = IIf(IsDBNull(RsTemp.Fields("CEDCESSABLE").Value), "N", RsTemp.Fields("CEDCESSABLE").Value)
            mIsADDCessAble = IIf(IsDBNull(RsTemp.Fields("ADDCESSABLE").Value), "N", RsTemp.Fields("ADDCESSABLE").Value)
        End If
        If mISExciseable = "Y" Then
            mExciseableAmount = Val(CStr(mExciseableAmount)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
            mNetAccessAmt = Val(CStr(mNetAccessAmt)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
        End If
        If pCST_ON_MRTL = False Then
            If mIsTaxable = "Y" Then
                mTaxableAmount = Val(CStr(mTaxableAmount)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
            End If
        End If
        If mIsCESSableAmount = "Y" Then
            mCESSableAmount = Val(CStr(mCESSableAmount)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
        End If
        If mIsCEDCessAble = "Y" Then
            mCEDCessAble = Val(CStr(mCEDCessAble)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
        End If
        If mIsADDCessAble = "Y" Then
            mADDCessAble = Val(CStr(mADDCessAble)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetTaxableamount_GST(ByRef mExpCode As Integer, ByRef mTaxValue As Double, ByRef mExpAddDeduct As String, ByRef mNetAccessAmt As Double, ByRef mTaxableAmount As Double, ByRef mTotExp As Double, ByRef mDutyForgone As String) As Double
        On Error GoTo ERR1
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mIsTaxable As String
        GetTaxableamount_GST = 0
        mTotExp = Val(CStr(mTotExp)) + (IIf(mDutyForgone = "Y", 0, mTaxValue) * IIf(mExpAddDeduct = "D", -1, 1))
        SqlStr = "SELECT * FROM FIN_INTERFACE_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND CODE=" & Val(CStr(mExpCode)) & ""
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        mIsTaxable = "N"
        If RsTemp.EOF = False Then
            mIsTaxable = IIf(IsDBNull(RsTemp.Fields("TAXABLE").Value), "N", RsTemp.Fields("TAXABLE").Value)
        End If
        If mIsTaxable = "Y" Then
            mTaxableAmount = Val(CStr(mTaxableAmount)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
            mNetAccessAmt = Val(CStr(mNetAccessAmt)) + (Val(CStr(mTaxValue)) * IIf(mExpAddDeduct = "D", -1, 1))
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function CheckPurchaseOrder(ByRef pAsOnDate As String, ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckPurchaseOrder = False
        SqlStr = "SELECT ITEM_PRICE" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY " & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.PO_CLOSED='N' AND IH.PO_STATUS='Y' AND IH.PUR_TYPE='P'" ''& vbCrLf |& " AND AMEND_WEF_DATE<='" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckPurchaseOrder = True
        End If
        Exit Function
ErrPart:
        CheckPurchaseOrder = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPCDate(ByRef xDBCn As ADODB.Connection, ByRef xPCNo As Double, ByRef xItemCode As String, ByRef xBookType As String, ByRef xAccountCode As String) As String
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xBookSubType As String
        GetPCDate = ""
        If xBookType = "S" Then
            xBookSubType = "I"
        Else
            xBookSubType = "O"
        End If
        SqlStr = " SELECT MAX(PC_DATE) AS PC_DATE " & vbCrLf & " FROM FIN_PC_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & xBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & xBookSubType & "'"
        SqlStr = SqlStr & vbCrLf & " AND SUPP_CUST_CODE='" & xAccountCode & "'" & vbCrLf & " AND PC_NO=" & Val(CStr(xPCNo)) & ""
        If xItemCode <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE ='" & xItemCode & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, xDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetPCDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("PC_DATE").Value), "", RsTemp.Fields("PC_DATE").Value), "DD/MM/YYYY")
        End If
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Sub GetPartyF4detailFromRGP(ByRef mRGPNo As Double, ByRef mOutwardF4No As String, ByRef mOutwardF4Date As String, ByRef mExpDate As String)
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        'mCheckF4 = False
        mOutwardF4No = "0"
        mOutwardF4Date = ""
        mExpDate = ""
        mSqlStr = " SELECT OUTWARD_57F4NO,GATEPASS_DATE,EXP_RTN_DATE " & vbCrLf & " FROM INV_GATEPASS_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTO_KEY_PASSNO=" & mRGPNo & ""
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mOutwardF4No = IIf(IsDBNull(RsTemp.Fields("OUTWARD_57F4NO").Value), "0", RsTemp.Fields("OUTWARD_57F4NO").Value)
            mOutwardF4Date = VB6.Format(IIf(IsDBNull(RsTemp.Fields("GATEPASS_DATE").Value), "", RsTemp.Fields("GATEPASS_DATE").Value), "DD/MM/YYYY")
            mExpDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("EXP_RTN_DATE").Value), "", RsTemp.Fields("EXP_RTN_DATE").Value), "DD/MM/YYYY")
            'If Val(mOutwardF4No) = 0 Then
            'mCheckF4 = False
            'Else
            'mCheckF4 = True
            'End If
        End If
        Exit Sub
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Sub
    Public Function GetQtyPurchase(ByRef pPartyCode As String, ByRef pItemCode As String, ByRef xRefDate As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        'Dim PvtDBCn As ADODB.Connection
        '
        'Set PvtDBCn = New ADODB.Connection
        'PvtDBCn.Open StrConn
        ''INV_GATE_HDR IH, AND IH.AUTO_KEY_MRR=ID.AUTO_KEY_MRR
        SqlStr = " SELECT SUM(NVL(RECEIVED_QTY,0)) RECEIVED_QTY " & vbCrLf & " FROM INV_GATE_DET ID " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND TO_CHAR(ID.MRR_DATE,'YYYYMM') = '" & VB6.Format(xRefDate, "YYYYMM") & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetQtyPurchase = IIf(IsDBNull(RsTemp.Fields("RECEIVED_QTY").Value), 0, RsTemp.Fields("RECEIVED_QTY").Value)
        End If
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCurrentItemRate(ByRef pItemCode As String, ByRef xRefDate As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim RsTempMain As ADODB.Recordset = Nothing
        Dim mItemRate As Double
        Dim mPurchaseUOM As String = ""
        Dim xItemUOM As String = ""
        Dim pFactor As Double
        Dim mRMCost As Double
        Dim xPurchaseCost As Double
        Dim mPartyCode As String
        Dim mTotalQtyPurchase As Double
        Dim mTotQty As Double
        Dim mTotValuePurchase As Double
        'Dim PvtDBCn As ADODB.Connection
        '
        'Set PvtDBCn = New ADODB.Connection
        'PvtDBCn.Open StrConn
        pFactor = 1
        ''TOP ATTACHMENT (04010008)
        'PubDBCn.Close
        'If PubDBCn.State = adStateClosed Then
        'PubDBCn.Open StrConn
        'SqlStr = "SELECT * FROm GEN_COMPANY_MST"
        'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsCompany, adLockReadOnly
        'End If
        ''
        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            xItemUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            pFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
            xPurchaseCost = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_COST").Value), 0, RsTemp1.Fields("PURCHASE_COST").Value) / pFactor
        End If
        SqlStr = " SELECT DISTINCT SUPP_CUST_CODE" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID " & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY AND IH.PO_STATUS='Y' AND IH.PUR_TYPE IN ('P','J')"
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempMain, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTempMain.EOF = False Then
            Do While RsTempMain.EOF = False
                mPartyCode = IIf(IsDBNull(RsTempMain.Fields("SUPP_CUST_CODE").Value), "-1", RsTempMain.Fields("SUPP_CUST_CODE").Value)
                SqlStr = " SELECT (NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4)) PURCHASE_COST, " & vbCrLf & " ITEM_UOM,IH.PUR_TYPE" & vbCrLf & " FROM PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID " & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY AND IH.PO_STATUS='Y' AND IH.PUR_TYPE IN ('P','J')"
                SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mPartyCode) & "'" & vbCrLf & " AND ID.PO_WEF_DATE = ( " & vbCrLf & " SELECT MAX(PO_WEF_DATE) " & vbCrLf & " FROM PUR_PURCHASE_HDR SIH, PUR_PURCHASE_DET SID" & vbCrLf & " WHERE SIH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SIH.MKEY=SID.MKEY AND SIH.PO_STATUS='Y' AND SIH.PUR_TYPE IN ('P','J')"
                SqlStr = SqlStr & vbCrLf & " AND SID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SIH.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mPartyCode) & "'" & vbCrLf & " AND SID.PO_WEF_DATE <= TO_DATE('" & VB6.Format(xRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
                SqlStr = SqlStr & vbCrLf & " ORDER BY IH.PO_CLOSED, ID.PO_WEF_DATE DESC"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mItemRate = IIf(IsDBNull(RsTemp.Fields("PURCHASE_COST").Value), 0, RsTemp.Fields("PURCHASE_COST").Value)
                    mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), 0, RsTemp.Fields("ITEM_UOM").Value)
                    If RsTemp.Fields("PUR_TYPE").Value = "J" Then
                        mRMCost = GetTotalJWRMCost(pItemCode, xRefDate, mPurchaseUOM, pFactor)
                        mItemRate = mItemRate + mRMCost
                    End If
                    mTotQty = GetQtyPurchase(mPartyCode, pItemCode, xRefDate)
                    mTotValuePurchase = mTotValuePurchase + (mItemRate * mTotQty)
                    mTotalQtyPurchase = mTotalQtyPurchase + mTotQty
                Else
                    mItemRate = GetTotalJWRMCost(pItemCode, xRefDate, mPurchaseUOM, pFactor)
                    ' mTotQty = 1
                    ' mTotValuePurchase = mTotValuePurchase + (mItemRate * mTotQty)
                    mTotalQtyPurchase = 0 ''mTotalQtyPurchase + mTotQty
                End If
                RsTempMain.MoveNext()
            Loop
            If mTotalQtyPurchase > 0 Then
                mItemRate = CDbl(VB6.Format(mTotValuePurchase / mTotalQtyPurchase, "0.00"))
            End If
        End If
        If mItemRate = 0 Then
            mItemRate = xPurchaseCost
        Else
            If xItemUOM <> mPurchaseUOM Then
                mItemRate = mItemRate / pFactor
            End If
        End If
        GetCurrentItemRate = mItemRate
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetCurrentItemRate = 0
    End Function
    Public Function GetCT3Date(ByRef xDBCn As ADODB.Connection, ByRef xCTNo As Double, ByRef xItemCode As String, ByRef xBookType As String, ByRef xAccountCode As String) As String
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xBookSubType As String
        GetCT3Date = ""
        If xBookType = "S" Then
            xBookSubType = "I"
        Else
            xBookSubType = "O"
        End If
        SqlStr = " SELECT MAX(CT_DATE) AS CT_DATE " & vbCrLf & " FROM FIN_CT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & xBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & xBookSubType & "'"
        SqlStr = SqlStr & vbCrLf & " AND SUPP_CUST_CODE='" & xAccountCode & "'" & vbCrLf & " AND CT_NO=" & Val(CStr(xCTNo)) & ""
        If xItemCode <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE ='" & xItemCode & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, xDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCT3Date = VB6.Format(IIf(IsDBNull(RsTemp.Fields("CT_DATE").Value), "", RsTemp.Fields("CT_DATE").Value), "DD/MM/YYYY")
        End If
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetBeforeJobworkItemCode(ByRef pRMCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetBeforeJobworkItemCode = ""
        SqlStr = "SELECT ITEM_CODE " & vbCrLf & " FROM PRD_OUTBOM_HDR IH, PRD_OUTBOM_DET ID " & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & pRMCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetBeforeJobworkItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value))
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetBeforeJobworkItemCode = ""
    End Function
    Public Function GetAlterItemCode(ByRef pMKey As String, ByRef pRMCode As String, ByRef pStdQty As Double) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xProductCode As String
        Dim xChildCode As String
        Dim xChildStdQty As Double
        Dim xItemUOM As String = ""
        pStdQty = 0
        SqlStr = "SELECT MKEY, ALTER_RM_CODE,ALTER_STD_QTY " & vbCrLf & " FROM PRD_BOM_ALTER_DET " & vbCrLf & " WHERE " & vbCrLf & " MKEY='" & pMKey & "'" & vbCrLf & " AND COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND MAINITEM_CODE='" & pRMCode & "'" & vbCrLf & " AND ALTER_STOCK_TYPE='CS'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        GetAlterItemCode = ""
        xChildStdQty = 0
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                xProductCode = Trim(IIf(IsDBNull(RsTemp.Fields("ALTER_RM_CODE").Value), "", RsTemp.Fields("ALTER_RM_CODE").Value))
                pStdQty = CDbl(Trim(IIf(IsDBNull(RsTemp.Fields("ALTER_STD_QTY").Value), 0, RsTemp.Fields("ALTER_STD_QTY").Value)))
                If MainClass.ValidateWithMasterTable(xProductCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    xItemUOM = MasterNo
                End If
                If xItemUOM = "KGS" Then
                    pStdQty = pStdQty / 1000
                ElseIf xItemUOM = "TON" Then
                    pStdQty = pStdQty / 1000
                    pStdQty = pStdQty / 1000
                ElseIf xItemUOM = "MT" Then
                    pStdQty = pStdQty / 1000
                    pStdQty = pStdQty / 1000
                End If
                xChildCode = GetChildRecord(xProductCode, xChildStdQty)
                pStdQty = pStdQty * xChildStdQty
                If GetAlterItemCode = "" Then
                    GetAlterItemCode = "'" & Trim(IIf(IsDBNull(RsTemp.Fields("ALTER_RM_CODE").Value), "", RsTemp.Fields("ALTER_RM_CODE").Value)) & "'"
                Else
                    GetAlterItemCode = GetAlterItemCode & ", '" & Trim(IIf(IsDBNull(RsTemp.Fields("ALTER_RM_CODE").Value), "", RsTemp.Fields("ALTER_RM_CODE").Value)) & "'"
                End If
                If xChildCode <> "" Then
                    GetAlterItemCode = GetAlterItemCode & "," & "'" & Trim(xChildCode) & "'"
                End If
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetAlterItemCode = ""
    End Function
    Private Function GetChildRecord(ByRef pProductCode As String, ByRef pStdQty As Double) As String
        On Error GoTo FillERR
        Dim SqlStr As String = ""
        Dim RsShow As ADODB.Recordset = Nothing
        Dim mKey As String
        Dim mChildAlter As String
        Dim mProdCode As String
        Dim xItemUOM As String = ""
        GetChildRecord = ""
        'SqlStr = " SELECT " & vbCrLf _
        ''& " IH.PRODUCT_CODE, ID.RM_CODE,IH.MKEY " & vbCrLf _
        ''& " FROM PRD_NEWBOM_HDR IH,PRD_NEWBOM_DET ID" & vbCrLf _
        ''& " WHERE IH.MKEY=ID.MKEY " & vbCrLf _
        ''& " AND IH.COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "' " & vbCrLf _
        ''& " AND IH.WEF=(SELECT MAX(WEF) FROM PRD_NEWBOM_HDR " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " " & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "') " '& vbCrLf _
        ''& " AND WEF<= '" & VB6.Format(pWEF, "DD-MMM-YYYY") & "')" & vbCrLf _
        '
        'SqlStr = SqlStr & vbCrLf & " ORDER BY ID.SUBROWNO"
        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.RM_CODE,STD_QTY " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & pProductCode & "'" & vbCrLf & " AND ID.STOCK_TYPE='CS'"
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(SH.WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR SH, PRD_NEWBOM_DET SD" & vbCrLf & " WHERE SH.MKEY=SD.MKEY" & vbCrLf & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SH.PRODUCT_CODE='" & pProductCode & "'" & vbCrLf & " AND SD.STOCK_TYPE='CS')" ''& vbCrLf |& " AND SH.WEF<='" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsShow, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RsShow.EOF Then
            GetChildRecord = Trim(IIf(IsDBNull(RsShow.Fields("RM_CODE").Value), "", RsShow.Fields("RM_CODE").Value))
            pStdQty = Val(IIf(IsDBNull(RsShow.Fields("STD_QTY").Value), 0, RsShow.Fields("STD_QTY").Value))
            If MainClass.ValidateWithMasterTable(GetChildRecord, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                xItemUOM = MasterNo
            End If
            If xItemUOM = "KGS" Then
                pStdQty = pStdQty / 1000
            ElseIf xItemUOM = "TON" Then
                pStdQty = pStdQty / 1000
                pStdQty = pStdQty / 1000
            ElseIf xItemUOM = "MT" Then
                pStdQty = pStdQty / 1000
                pStdQty = pStdQty / 1000
            End If
            'GetChildRecord = "'" & Trim(IIf(IsNull(RsShow!RM_CODE), "", RsShow!RM_CODE)) & "'"
            '
            'mKey = Trim(IIf(IsNull(RsShow!mKey), "", RsShow!mKey))
            'mChildAlter = GetAlterItemCode(mKey, mProdCode, 0)
            '
            'If mChildAlter <> "" Then
            'GetChildRecord = GetChildRecord & "," & mChildAlter
            'End If
        End If
        RsShow = Nothing
        Exit Function
FillERR:
        GetChildRecord = ""
        MsgBox(Err.Description)
        'Resume
    End Function
    ''21/10/2021''SAndeep New Add
    Public Function Get57F4Detail(ByRef pDBCn As ADODB.Connection, ByRef pItemCode As String, ByRef pAccountCode As String, ByRef pF4No As String, ByRef pF4Date As String, ByRef mItemF4ConsQty As Double) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp57F4 As ADODB.Recordset = Nothing
        Get57F4Detail = False
        ''AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'
        SqlStr = " SELECT MIN(PARTY_F4DATE), SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY) AS ITEMQTY,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND PARTY_F4NO NOT LIKE 'DIFF%' " & vbCrLf & " GROUP BY PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY)>0"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp57F4, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp57F4.EOF = False Then
            pF4No = IIf(IsDBNull(RsTemp57F4.Fields("PARTY_F4NO").Value), "", RsTemp57F4.Fields("PARTY_F4NO").Value)
            pF4Date = IIf(IsDBNull(RsTemp57F4.Fields("PARTY_F4DATE").Value), "", RsTemp57F4.Fields("PARTY_F4DATE").Value)
            mItemF4ConsQty = CDbl(VB6.Format(IIf(IsDBNull(RsTemp57F4.Fields("ITEMQTY").Value), 0, RsTemp57F4.Fields("ITEMQTY").Value), "0.000"))
        Else
            MsgBox("No Enough Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
        End If
        Get57F4Detail = True
        Exit Function
ErrPart:
        Get57F4Detail = False
    End Function
    Public Function GetPrefixNo() As String
        GetPrefixNo = CStr(CDbl(VB6.Format(RsCompany.Fields("FYNO").Value, "00")) + IIf(IsDBNull(RsCompany.Fields("DocNoPrefix").Value), "", RsCompany.Fields("DocNoPrefix").Value))
    End Function
    Public Function GetEmpCurrentDesg(ByRef pCode As String, ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        GetEmpCurrentDesg = ""
        SqlStr = " SELECT EMP_DESG_CODE " & vbCrLf & " FROM PAY_SALARYDEF_MST" & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE = '" & pCode & "'" & vbCrLf & " AND SALARY_APP_DATE=(SELECT MAX(SALARY_APP_DATE) " & vbCrLf & " FROM PAY_SALARYDEF_MST" & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE = '" & pCode & "'" & vbCrLf & " AND SALARY_APP_DATE<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockOptimistic)
        If RsTemp.EOF = False Then
            GetEmpCurrentDesg = IIf(IsDBNull(RsTemp.Fields("EMP_DESG_CODE").Value), "", RsTemp.Fields("EMP_DESG_CODE").Value)
        End If
        Exit Function
ErrPart:
        GetEmpCurrentDesg = ""
    End Function
    Public Function GetInaamScale(ByRef mInaamAmount As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mAvgPoint As Integer
        Dim xMaxInaamAmount As Double
        GetInaamScale = 0
        If mInaamAmount = 0 Then GetInaamScale = 0 : Exit Function
        xMaxInaamAmount = IIf(mInaamAmount > 20000, 20000, mInaamAmount)
        GetInaamScale = xMaxInaamAmount / 200
        'If mInaamAmount >= 18501 Then
        'mAvgPoint = Round((20000 - 18501) / 5, 0)
        'GetInaamScale = 95 + Round((mInaamAmount - 18501) / mAvgPoint, 0)
        'If GetInaamScale > 100 Then GetInaamScale = 100
        'ElseIf mInaamAmount >= 17501 And mInaamAmount < 18501 Then
        'mAvgPoint = Round((18501 - 17501) / 5, 0)
        'GetInaamScale = 90 + Round((mInaamAmount - 17501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 16501 And mInaamAmount < 17501 Then
        'mAvgPoint = Round((17501 - 16501) / 5, 0)
        'GetInaamScale = 85 + Round((mInaamAmount - 16501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 15501 And mInaamAmount < 16501 Then
        'mAvgPoint = Round((16501 - 15501) / 5, 0)
        'GetInaamScale = 80 + Round((mInaamAmount - 15501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 14501 And mInaamAmount < 15501 Then
        'mAvgPoint = Round((15501 - 14501) / 5, 0)
        'GetInaamScale = 75 + Round((mInaamAmount - 14501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 13501 And mInaamAmount < 14501 Then
        'mAvgPoint = Round((145010 - 13501) / 5, 0)
        'GetInaamScale = 70 + Round((mInaamAmount - 13501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 12501 And mInaamAmount < 13501 Then
        'mAvgPoint = Round((13501 - 12501) / 5, 0)
        'GetInaamScale = 65 + Round((mInaamAmount - 12501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 11501 And mInaamAmount < 12501 Then
        'mAvgPoint = Round((12501 - 11501) / 5, 0)
        'GetInaamScale = 60 + Round((mInaamAmount - 11501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 10501 And mInaamAmount < 11501 Then
        'mAvgPoint = Round((11501 - 10501) / 5, 0)
        'GetInaamScale = 55 + Round((mInaamAmount - 10501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 9501 And mInaamAmount < 10501 Then
        'mAvgPoint = Round((10501 - 9501) / 5, 0)
        'GetInaamScale = 50 + Round((mInaamAmount - 9501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 8501 And mInaamAmount < 9501 Then
        'mAvgPoint = Round((9501 - 8501) / 5, 0)
        'GetInaamScale = 45 + Round((mInaamAmount - 8501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 7501 And mInaamAmount < 8501 Then
        'mAvgPoint = Round((8501 - 7501) / 5, 0)
        'GetInaamScale = 40 + Round((mInaamAmount - 7501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 6501 And mInaamAmount < 7501 Then
        'mAvgPoint = Round((7501 - 6501) / 5, 0)
        'GetInaamScale = 35 + Round((mInaamAmount - 6501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 5501 And mInaamAmount < 6501 Then
        'mAvgPoint = Round((6501 - 5501) / 5, 0)
        'GetInaamScale = 30 + Round((mInaamAmount - 5501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 4501 And mInaamAmount < 5501 Then
        'mAvgPoint = Round((5501 - 4501) / 5, 0)
        'GetInaamScale = 25 + Round((mInaamAmount - 4501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 3501 And mInaamAmount < 4501 Then
        'mAvgPoint = Round((4501 - 3501) / 5, 0)
        'GetInaamScale = 20 + Round((mInaamAmount - 3501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 2501 And mInaamAmount < 3501 Then
        'mAvgPoint = Round((3501 - 2501) / 5, 0)
        'GetInaamScale = 15 + Round((mInaamAmount - 2501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 1501 And mInaamAmount < 2501 Then
        'mAvgPoint = Round((2501 - 1501) / 5, 0)
        'GetInaamScale = 10 + Round((mInaamAmount - 1501) / mAvgPoint, 0)
        'ElseIf mInaamAmount >= 501 And mInaamAmount < 1501 Then
        'mAvgPoint = Round((1501 - 501) / 5, 0)
        'GetInaamScale = 5 + Round((mInaamAmount - 501) / mAvgPoint, 0)
        'Else
        'mAvgPoint = Round(501 / 5, 0)
        'GetInaamScale = 0 + Round((mInaamAmount) / mAvgPoint, 0)
        'End If
        Exit Function
ErrPart:
        GetInaamScale = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetIsHolidays(ByRef pDate As String, ByRef mHType As String, ByRef mEmpCode As String, ByRef pCheckHolidays As String, ByRef pCheckWeeklyOffFromShift As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCategory As String
        GetIsHolidays = False
        If pCheckHolidays = "N" Then
            GetIsHolidays = False
            Exit Function
        End If
        If CurrModuleName = mContPayrollModule Then
            mCategory = "C"
        Else
            If MainClass.ValidateWithMasterTable(mEmpCode, "EMP_CODE", "EMP_CAT_TYPE", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                mCategory = MasterNo
            Else
                mCategory = "1"
            End If
            mCategory = IIf(mCategory = "1", "S", "W")
        End If
        If CurrModuleName = mContPayrollModule Then
            pCheckWeeklyOffFromShift = "N" ''07/09/2020
        Else
            pCheckWeeklyOffFromShift = "Y"
        End If
        SqlStr = " SELECT LEAVE_TYPE FROM PAY_HOLIDAY_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND HOLIDAY_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        If CurrModuleName = mContPayrollModule Then
            SqlStr = SqlStr & vbCrLf & " AND APP_CONTRACTOR='Y'"
        Else
            If mCategory = "S" Then
                SqlStr = SqlStr & vbCrLf & " AND APP_STAFF='Y'"
            Else
                SqlStr = SqlStr & vbCrLf & " AND APP_RW='Y'"
            End If
        End If
        If pCheckWeeklyOffFromShift = "Y" Then
            If RsCompany.Fields("WEEKLYOFF_TYPE").Value = "S" Then
                If mEmpCode <> "" Then
                    SqlStr = SqlStr & vbCrLf & " AND LEAVE_TYPE<>'SD'"
                    SqlStr = SqlStr & vbCrLf & " UNION "
                    If CurrModuleName = mContPayrollModule Then
                        SqlStr = SqlStr & vbCrLf & " SELECT 'SD' AS LEAVE_TYPE FROM PAY_CONT_SHIFT_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mEmpCode) & "'" & vbCrLf & " AND SHIFT_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND WEEKLY_OFF='Y'"
                    Else
                        SqlStr = SqlStr & vbCrLf & " SELECT 'SD' AS LEAVE_TYPE FROM PAY_SHIFT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mEmpCode) & "'" & vbCrLf & " AND SHIFT_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND WEEKLY_OFF='Y'"
                    End If
                End If
                ''End If
            End If
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mHType = IIf(IsDBNull(RsTemp.Fields("LEAVE_TYPE").Value), "SD", RsTemp.Fields("LEAVE_TYPE").Value)
            mHType = IIf(mHType = "SD", "SU", "HH")
            GetIsHolidays = True
        End If
        Exit Function
ErrPart:
        GetIsHolidays = False
    End Function
    Public Function GetEmpTransferSQL(ByRef pEmpCode As String, ByRef pCompanyCode As Integer, Optional ByRef mNextCompany As String = "") As String
        On Error GoTo ShowErrPart
        Dim mCompanyField As String
        Dim mEmpCodeField As String
        If mNextCompany = "Y" Then
            mCompanyField = "FROM_COMPANY_CODE"
            mEmpCodeField = "FROM_EMP_CODE"
        Else
            mCompanyField = "TO_COMPANY_CODE"
            mEmpCodeField = "TO_EMP_CODE"
        End If
        GetEmpTransferSQL = " SELECT * " & vbCrLf & " FROM PAY_EMP_TRF_MST" & vbCrLf & " WHERE " & vbCrLf & " " & mCompanyField & " = " & pCompanyCode & "" & vbCrLf & " AND " & mEmpCodeField & " = '" & pEmpCode & "'"
        Exit Function
ShowErrPart:
        GetEmpTransferSQL = ""
        MsgBox(Err.Description)
        'Resume
    End Function
    Public Function GetShiftTime(ByRef mCode As String, ByRef mDate As String, ByRef mMarginsMinute As Double, ByRef mIO As String, ByRef pEmpType As String) As String
        On Error GoTo refreshErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFieldName As String
        Dim SqlStr As String = ""
        Dim mTableName As String
        If mIO = "I" Then
            mFieldName = "IN_TIME"
        ElseIf mIO = "B" Then
            mFieldName = "B_END_TIME"
        Else
            mFieldName = "OUT_TIME"
        End If
        If pEmpType = "E" Then
            mTableName = "PAY_SHIFT_TRN"
        Else
            mTableName = "PAY_CONT_SHIFT_MST"
        End If
        SqlStr = " SELECT " & mFieldName & " AS SHIFT_TIME " & vbCrLf & " FROM " & mTableName & " TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mCode) & "'" & vbCrLf & " AND SHIFT_DATE=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf
        'SqlStr = SqlStr & vbCrLf & " AND WEEKLY_OFF ='N'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockOptimistic)
        If RsTemp.EOF = False Then
            GetShiftTime = VB6.Format(IIf(IsDBNull(RsTemp.Fields("SHIFT_TIME").Value), "", RsTemp.Fields("SHIFT_TIME").Value), "HH:mm")
            If mIO = "I" Then
                If mIO = "B" Then
                    GetShiftTime = VB6.Format(TimeSerial(Hour(CDate(GetShiftTime)), Minute(CDate(GetShiftTime)), 0), "HH:mm")
                Else
                    GetShiftTime = VB6.Format(TimeSerial(Hour(CDate(GetShiftTime)), Minute(CDate(GetShiftTime)) + mMarginsMinute, 0), "HH:mm")
                End If
            Else
                If mIO = "B" Then
                    GetShiftTime = VB6.Format(TimeSerial(Hour(CDate(GetShiftTime)), Minute(CDate(GetShiftTime)) + mMarginsMinute, 0), "HH:mm")
                Else
                    GetShiftTime = VB6.Format(TimeSerial(Hour(CDate(GetShiftTime)), Minute(CDate(GetShiftTime)) - mMarginsMinute, 0), "HH:mm")
                End If
            End If
        Else
            GetShiftTime = "00:00"
        End If
        Exit Function
refreshErrPart:
        MsgBox(Err.Description)
        'Resume
    End Function
    Public Function GetAccountBalancingMethod(ByRef mAccountName As String, Optional ByRef SearchByCode As Boolean = False, Optional ByRef mCompanyCode As Long = 0) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing

        SqlStr = "SELECT BALANCINGMETHOD FROM FIN_SUPP_CUST_MST "

        If mCompanyCode = 0 Then
            SqlStr = SqlStr & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        Else
            SqlStr = SqlStr & vbCrLf & " Where COMPANY_CODE=" & mCompanyCode & ""
        End If

        If SearchByCode = True Then
            SqlStr = SqlStr & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mAccountName) & "'"
        Else
            SqlStr = SqlStr & " AND SUPP_CUST_NAME='" & MainClass.AllowSingleQuote(mAccountName) & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RS.EOF Then
            GetAccountBalancingMethod = IIf(IsDBNull(RS.Fields(0).Value), "S", RS.Fields(0).Value)
        Else
            GetAccountBalancingMethod = "S"
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetAddDescription(ByVal mItemCode As String, ByVal pSONo As Double, ByVal pDate As String) As String

        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetAddDescription = ""

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 104 Then
            SqlStr = "SELECT ITEM_TECH_DESC AS ADD_ITEM_DESCRIPTION " & vbCrLf _
                    & " FROM INV_ITEM_MST" & vbCrLf _
                    & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND ITEM_CODE='" & mItemCode & "'"
        Else
            SqlStr = "SELECT ADD_ITEM_DESCRIPTION " & vbCrLf _
                    & " FROM DSP_SALEORDER_HDR IH, DSP_SALEORDER_DET ID" & vbCrLf _
                    & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
                    & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND ID.ITEM_CODE='" & mItemCode & "' AND AUTO_KEY_SO=" & pSONo & " AND SO_APPROVED='Y' " & vbCrLf _
                    & " AND IH.AMEND_WEF_FROM= ( " & vbCrLf _
                    & " SELECT MAX(SH.AMEND_WEF_FROM) " & vbCrLf _
                    & " FROM DSP_SALEORDER_HDR SH, DSP_SALEORDER_DET SD" & vbCrLf _
                    & " WHERE SH.MKEY=SD.MKEY" & vbCrLf _
                    & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND SD.ITEM_CODE='" & mItemCode & "' AND AUTO_KEY_SO=" & pSONo & " AND SO_APPROVED='Y'" & vbCrLf _
                    & " AND SH.AMEND_WEF_FROM<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        End If

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RS.EOF Then
            GetAddDescription = IIf(IsDBNull(RS.Fields(0).Value), "", RS.Fields(0).Value)
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPartyBusinessDetail(ByVal mSupplierCode As String, ByVal Location_Id As String, pFieldName As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        Dim mStateName As String
        Dim mCompanyStateName As String

        GetPartyBusinessDetail = ""

        If pFieldName = "WITHIN_STATE" Then
            mStateName = ""
            SqlStr = "SELECT SUPP_CUST_STATE FROM FIN_SUPP_CUST_BUSINESS_MST " & vbCrLf _
                        & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                        & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "' AND LOCATION_ID='" & MainClass.AllowSingleQuote(Location_Id) & "'"

            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)

            If Not RS.EOF Then
                mStateName = IIf(IsDBNull(RS.Fields(0).Value), "", RS.Fields(0).Value)
            End If
            mCompanyStateName = IIf(IsDBNull(RsCompany.Fields("COMPANY_STATE").Value), "", RsCompany.Fields("COMPANY_STATE").Value)
            If Trim(UCase(mStateName)) = Trim(UCase(mCompanyStateName)) Then
                GetPartyBusinessDetail = "Y"
            Else
                GetPartyBusinessDetail = "N"
            End If
            Exit Function
        End If

        SqlStr = "SELECT " & pFieldName & " FROM FIN_SUPP_CUST_BUSINESS_MST " & vbCrLf _
            & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "' AND LOCATION_ID='" & MainClass.AllowSingleQuote(Location_Id) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)

        If Not RS.EOF Then
            GetPartyBusinessDetail = IIf(IsDBNull(RS.Fields(0).Value), "", RS.Fields(0).Value)
        End If

        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetDefaultLocation(ByVal mSupplierCode As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetDefaultLocation = ""
        Dim mCntCount As Double = 0
        Dim mSuppType As String

        GetDefaultLocation = ""

        If MainClass.ValidateWithMasterTable(mSupplierCode, "SUPP_CUST_CODE", "SUPP_CUST_TYPE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mSuppType = MasterNo
        Else
            mSuppType = "O"
        End If

        If mSuppType = "S" Or mSuppType = "C" Then
            SqlStr = "SELECT COUNT(1) AS CNT_COUNT FROM FIN_SUPP_CUST_BUSINESS_MST " & vbCrLf _
                & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "'"

            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
            If Not RS.EOF Then
                mCntCount = IIf(IsDBNull(RS.Fields("CNT_COUNT").Value), 0, RS.Fields("CNT_COUNT").Value)
            End If

            If mCntCount = 0 Then
                SqlStr = "SELECT SUPP_CUST_CITY FROM FIN_SUPP_CUST_MST " & vbCrLf _
                    & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " And SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "'"

                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
                If Not RS.EOF Then
                    GetDefaultLocation = IIf(IsDBNull(RS.Fields(0).Value), "", RS.Fields(0).Value)
                End If
            ElseIf mCntCount = 1 Then
                SqlStr = "SELECT LOCATION_ID FROM FIN_SUPP_CUST_BUSINESS_MST " & vbCrLf _
                    & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " And SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(mSupplierCode) & "'"

                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
                If Not RS.EOF Then
                    GetDefaultLocation = IIf(IsDBNull(RS.Fields(0).Value), "", RS.Fields(0).Value)
                End If
            End If
        Else
            GetDefaultLocation = "-"
        End If

        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCategoryAcctCode(ByRef pBookSubType As String, ByRef mSALType As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetCategoryAcctCode = ""
        SqlStr = "SELECT * FROM PAY_CATEGORY_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND CATEGORY_CODE='" & MainClass.AllowSingleQuote(UCase(pBookSubType)) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RS.EOF Then
            Select Case mSALType
                Case "SD"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTSAL_DEBITCODE").Value), "", RS.Fields("POSTSAL_DEBITCODE").Value)
                Case "ID"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTINC_DEBITCODE").Value), "", RS.Fields("POSTINC_DEBITCODE").Value)
                Case "BD"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTBONUS_DEBITCODE").Value), "", RS.Fields("POSTBONUS_DEBITCODE").Value)
                Case "LD"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTLTC_DEBITCODE").Value), "", RS.Fields("POSTLTC_DEBITCODE").Value)
                Case "ED"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTEL_ACCTCODE").Value), "", RS.Fields("POSTEL_ACCTCODE").Value)
                Case "GD"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTGR_ACCTCODE").Value), "", RS.Fields("POSTGR_ACCTCODE").Value)
                Case "SC"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTSAL_CREDITCODE").Value), "", RS.Fields("POSTSAL_CREDITCODE").Value)
                Case "IC"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTINC_CREDITCODE").Value), "", RS.Fields("POSTINC_CREDITCODE").Value)
                Case "BC"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTBONUS_CREDITCODE").Value), "", RS.Fields("POSTBONUS_CREDITCODE").Value)
                Case "LC"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTLTC_CREDITCODE").Value), "", RS.Fields("POSTLTC_CREDITCODE").Value)
                    'Case "EC"
                    'GetCategoryAcctCode = IIf(IsNull(RS!POSTEL_CREDITCODE), "", RS!POSTEL_CREDITCODE)
                    'Case "GC"
                    'GetCategoryAcctCode = IIf(IsNull(RS!POSTGR_CREDITCODE), "", RS!POSTGR_CREDITCODE)
                Case "P"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTPF_ACCTCODE").Value), "", RS.Fields("POSTPF_ACCTCODE").Value)
                Case "E"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTESI_ACCTCODE").Value), "", RS.Fields("POSTESI_ACCTCODE").Value)
                Case "W"
                    GetCategoryAcctCode = IIf(IsDBNull(RS.Fields("POSTWELFARE_ACCTCODE").Value), "", RS.Fields("POSTWELFARE_ACCTCODE").Value)
            End Select
        End If
        GetCategoryAcctCode = IIf(GetCategoryAcctCode = "", "-1", GetCategoryAcctCode)
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckVoucherUnLockApproval(ByRef pPvtDBCn As ADODB.Connection, ByRef pVNo As String, ByRef pVDate As String, ByRef pVType As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsLock As ADODB.Recordset = Nothing
        Dim mLockDateFrom As String
        Dim mLockDateTo As String
        CheckVoucherUnLockApproval = False
        mSqlStr = " SELECT * FROM FIN_VOUCHER_UNLOCK_TRN " & vbCrLf & " Where COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND VNO='" & Trim(pVNo) & "'" & vbCrLf & " AND VDATE=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        If pVType <> "" Then
            mSqlStr = mSqlStr & vbCrLf & " AND VTYPE='" & Trim(pVType) & "'"
        End If
        MainClass.UOpenRecordSet(mSqlStr, pPvtDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsLock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsLock.EOF = False Then
            CheckVoucherUnLockApproval = True
        End If
        Exit Function
ErrPart:
        CheckVoucherUnLockApproval = False
    End Function
    Public Function AutoGenSeqGSTNo() As String
        On Error GoTo AutoGenSeqBillNoErr
        Dim RsPurchMainGen As ADODB.Recordset = Nothing
        Dim mNewSeqBillNo As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pStartingNo As Integer
        SqlStr = ""
        pStartingNo = 1
        SqlStr = ""
        SqlStr = " SELECT Max(GST_CLAIM_NO) AS GST_CLAIM_NO FROM FIN_GST_SEQ_MST " & vbCrLf _
            & " WHERE Company_Code=" & RsCompany.Fields("Company_Code").Value & " " & vbCrLf _
            & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " "
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPurchMainGen, ADODB.LockTypeEnum.adLockReadOnly)
        With RsPurchMainGen
            If .EOF = False Then
                If IsDBNull(.Fields(0).Value) Then
                    mNewSeqBillNo = pStartingNo
                ElseIf Not IsDBNull(.Fields(0).Value) Then
                    mNewSeqBillNo = .Fields(0).Value + 1
                Else
                    mNewSeqBillNo = pStartingNo
                End If
            Else
                mNewSeqBillNo = pStartingNo
            End If
        End With
        AutoGenSeqGSTNo = CStr(mNewSeqBillNo)
        Exit Function
AutoGenSeqBillNoErr:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function AutoGenSeqGSTAppNo(ByRef pClaimType As String, ByRef pInputReverse As String) As String
        On Error GoTo AutoGenSeqBillNoErr
        Dim RsPurchMainGen As ADODB.Recordset = Nothing
        Dim mNewSeqBillNo As Double
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pStartingNo As Double
        Dim mMAxNo As Double

        SqlStr = ""
        If pInputReverse = "I" Then
            If pClaimType = "Y" Then
                pStartingNo = 1
            ElseIf pClaimType = "A" Then
                pStartingNo = 100001
            End If
        Else
            If pClaimType = "Y" Then
                pStartingNo = 200001
            ElseIf pClaimType = "A" Then
                pStartingNo = 300001
            End If
        End If
        SqlStr = ""
        SqlStr = " SELECT Max(GST_CLAIM_NO) AS GST_CLAIM_NO FROM FIN_GST_NEWSEQ_MST " & vbCrLf & " WHERE Company_Code=" & RsCompany.Fields("Company_Code").Value & " " & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " AND CLAIM_TYPE='" & pClaimType & "'"
        If RsCompany.Fields("FYEAR").Value >= 2018 Then
            SqlStr = SqlStr & vbCrLf & " AND INPUT_REVERSE='" & pInputReverse & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPurchMainGen, ADODB.LockTypeEnum.adLockReadOnly)
        With RsPurchMainGen
            If .EOF = False Then
                mMAxNo = IIf(IsDBNull(.Fields(0).Value), -1, .Fields(0).Value)
                If mMAxNo = -1 Then
                    mNewSeqBillNo = pStartingNo
                ElseIf Not IsDBNull(.Fields(0).Value) Then
                    mNewSeqBillNo = .Fields(0).Value + 1
                Else
                    mNewSeqBillNo = pStartingNo
                End If
            Else
                mNewSeqBillNo = pStartingNo
            End If
        End With
        AutoGenSeqGSTAppNo = CStr(mNewSeqBillNo)
        Exit Function
AutoGenSeqBillNoErr:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetDummyAccountCode(ByRef pAccountCode As String, ByRef pMKey As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDummyAccountCode = pAccountCode
        If PubUserID <> "A00001" Then Exit Function
        SqlStr = "SELECT NEW_ACCOUNTCODE FROM " & vbCrLf & " FIN_AUDIT_CHANGE_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf & " AND MKEY='" & MainClass.AllowSingleQuote(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            GetDummyAccountCode = IIf(IsDBNull(RsTemp.Fields("NEW_ACCOUNTCODE").Value), "", RsTemp.Fields("NEW_ACCOUNTCODE").Value)
        End If
        Exit Function
ErrPart:
        GetDummyAccountCode = pAccountCode
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetEmployeeCategoryName(ByRef pBookSubType As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetEmployeeCategoryName = ""
        SqlStr = "SELECT CATEGORY_DESC FROM PAY_CATEGORY_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND CATEGORY_CODE='" & MainClass.AllowSingleQuote(UCase(pBookSubType)) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RS.EOF Then
            GetEmployeeCategoryName = IIf(IsDBNull(RS.Fields("CATEGORY_DESC").Value), "", RS.Fields("CATEGORY_DESC").Value)
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetER1CategoryCode() As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mCATEGORY_CODE As String
        Dim mCATEGORY_CODESTR As String
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = " SELECT GEN_CODE FROM INV_GENERAL_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND GEN_TYPE='C' AND ER_ITEM='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        mCATEGORY_CODESTR = ""
        If RsTemp.EOF = False Then
            Do While Not RsTemp.EOF
                mCATEGORY_CODE = IIf(IsDBNull(RsTemp.Fields("GEN_CODE").Value), "", RsTemp.Fields("GEN_CODE").Value)
                mCATEGORY_CODESTR = IIf(mCATEGORY_CODESTR = "", "'" & mCATEGORY_CODE & "'", mCATEGORY_CODESTR & ",'" & mCATEGORY_CODE & "'")
                RsTemp.MoveNext()
            Loop
        End If
        If mCATEGORY_CODESTR = "" Then
            GetER1CategoryCode = "('')"
        Else
            GetER1CategoryCode = "(" & mCATEGORY_CODESTR & ")"
        End If
        Exit Function
ErrPart:
        GetER1CategoryCode = "('')"
    End Function
    Public Function CheckIsER1CategoryCode(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = " SELECT GEN_CODE FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE" & vbCrLf & " AND IMST.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND CMST.GEN_TYPE='C' AND CMST.ER_ITEM='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckIsER1CategoryCode = True
        Else
            CheckIsER1CategoryCode = False
        End If
        Exit Function
ErrPart:
        CheckIsER1CategoryCode = False
    End Function
    Public Function GetHeadType(ByRef mAccountName As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        SqlStr = "SELECT HeadType FROM FIN_SUPP_CUST_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_NAME='" & MainClass.AllowSingleQuote(UCase(mAccountName)) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RS.EOF Then
            GetHeadType = IIf(IsDBNull(RS.Fields(0).Value), "-1", RS.Fields(0).Value)
            GetHeadType = IIf(GetHeadType = "1", "T", GetHeadType)
        Else
            GetHeadType = "-1"
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetLastPaymentNDate(ByRef pAccountCode As String, ByRef pVDate As String, ByRef pVNo As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsOP As ADODB.Recordset = Nothing
        Dim pVAmount As Double
        Dim xVDate As String
        GetLastPaymentNDate = ""
        ''/* index(TRN,INDEX_FIN_POSTED_TRN12) */
        SqlStr = " SELECT " & vbCrLf & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT)AS PAYMENT, VDATE"
        SqlStr = SqlStr & vbCrLf & " FROM FIN_POSTED_TRN TRN " & vbCrLf & " WHERE TRN.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & ""
        SqlStr = SqlStr & vbCrLf & " AND TRN.BOOKTYPE || TRN.BOOKSUBTYPE IN ('BP','FP')"
        SqlStr = SqlStr & vbCrLf & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf & " AND TRN.VNO<>'" & Trim(pVNo) & "'"
        SqlStr = SqlStr & vbCrLf & " AND VDATE = (SELECT MAX(VDATE) FROM FIN_POSTED_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE || BOOKSUBTYPE IN ('BP','FP')" & vbCrLf & " AND ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf & " AND VDATE<=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND VNO<>'" & Trim(pVNo) & "')"
        SqlStr = SqlStr & vbCrLf & " GROUP BY VDATE"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOP, ADODB.LockTypeEnum.adLockReadOnly)
        If RsOP.EOF = False Then
            pVAmount = CDbl(VB6.Format(IIf(IsDBNull(RsOP.Fields("PAYMENT").Value), 0, RsOP.Fields("PAYMENT").Value), "0.00"))
            xVDate = VB6.Format(IIf(IsDBNull(RsOP.Fields("VDATE").Value), "", RsOP.Fields("VDATE").Value), "DD/MM/YYYY")
            GetLastPaymentNDate = "Last Payment Amount & Date : Rs. " & VB6.Format(System.Math.Abs(pVAmount), "0.00") & " & " & VB6.Format(xVDate, "DD/MM/YYYY")
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetOpeningBalClearDate(ByRef pAccountCode As String,
                                           ByRef pVDate As String, Optional ByRef pCompanyName As String = "",
                                           Optional ByRef mDiv As Integer = 0,
                                           Optional pAllCompany As String = "", Optional mCompanyCodeStr As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsOP As ADODB.Recordset = Nothing
        Dim RsOP1 As ADODB.Recordset = Nothing
        Dim pCompanyCode As Integer
        Dim mConditionTrue As Boolean
        GetOpeningBalClearDate = 0
        mConditionTrue = False

        ''/* index(TRN,INDEX_FIN_POSTED_TRN12) */

        GetOpeningBalClearDate = 0

        SqlStr = " SELECT " & vbCrLf _
            & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT)AS OPENING "

        SqlStr = SqlStr & vbCrLf _
            & " FROM FIN_POSTED_TRN TRN " & vbCrLf _
            & " WHERE TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & " "

        If pAllCompany = "Y" Then
            If mCompanyCodeStr <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.COMPANY_CODE IN " & mCompanyCodeStr & ""
            End If
        Else
            If pCompanyName = "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
                mConditionTrue = True
            Else
                If MainClass.ValidateWithMasterTable(pCompanyName, "COMPANY_NAME", "COMPANY_CODE", "GEN_COMPANY_MST", PubDBCn, MasterNo, , "") = True Then
                    pCompanyCode = MasterNo
                Else
                    pCompanyCode = CInt("-1")
                End If
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & pCompanyCode & ""
                mConditionTrue = True
            End If
        End If

        If mDiv > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.DIV_CODE = " & mDiv & ""
        End If

        SqlStr = SqlStr & vbCrLf _
            & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "' " & vbCrLf _
            & " AND CASE WHEN BOOKCODE=-10 THEN VDATE ELSE TRN.CLEARDATE END <=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOP, ADODB.LockTypeEnum.adLockReadOnly)
        If RsOP.EOF = False Then
            GetOpeningBalClearDate = Val(IIf(IsDBNull(RsOP.Fields("OPENING").Value), 0, RsOP.Fields("OPENING").Value))
        End If

        ''---
        SqlStr = " SELECT " & vbCrLf _
            & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT)AS OPENING "

        SqlStr = SqlStr & vbCrLf _
            & " FROM FIN_POSTED_TRN TRN " & vbCrLf _
            & " WHERE TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value - 1 & " "

        If pAllCompany = "Y" Then
            If mCompanyCodeStr <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.COMPANY_CODE IN " & mCompanyCodeStr & ""
            End If
        Else
            If pCompanyName = "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
                mConditionTrue = True
            Else
                If MainClass.ValidateWithMasterTable(pCompanyName, "COMPANY_NAME", "COMPANY_CODE", "GEN_COMPANY_MST", PubDBCn, MasterNo, , "") = True Then
                    pCompanyCode = MasterNo
                Else
                    pCompanyCode = CInt("-1")
                End If
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & pCompanyCode & ""
                mConditionTrue = True
            End If
        End If

        If mDiv > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.DIV_CODE = " & mDiv & ""
        End If

        SqlStr = SqlStr & vbCrLf _
            & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "' AND BOOKCODE<>-10" & vbCrLf _
            & " AND ( TRN.CLEARDATE IS NULL OR TRN.CLEARDATE >TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))" & vbCrLf

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOP1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsOP1.EOF = False Then
            GetOpeningBalClearDate = GetOpeningBalClearDate - Val(IIf(IsDBNull(RsOP1.Fields("OPENING").Value), 0, RsOP1.Fields("OPENING").Value))
        End If

        ''--
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    'GetCreditLimit((txtCustomer.Text), txtBillDate.Text)
    Public Function GetCreditLimit(ByRef pAccountCode As String, ByRef pVDate As String) As Double


        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetCreditLimit = 0

        SqlStr = " SELECT CREDIT_LIMIT FROM GEN_INVOICE_UNLOCK_TRN" & vbCrLf _
            & " WHERE SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf _
            & " AND APP_DATE=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCreditLimit = Val(IIf(IsDBNull(RsTemp.Fields("CREDIT_LIMIT").Value), 0, RsTemp.Fields("CREDIT_LIMIT").Value))
        End If
        Exit Function
ErrPart:

        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckCreditDaysLocking(ByRef pAccountCode As String, ByRef pVDate As String, ByRef pBillAmount As Double, ByRef pBillNo As String) As Boolean


        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mLedgerBalance As Double = 0
        Dim mPartyPaymentTerms As String
        Dim mCreditDays As Double
        Dim mSaleFrom As String
        Dim mCreditAmount As Double=0
        Dim mCustomerType As String = ""
        CheckCreditDaysLocking = True
        mCreditDays = 0

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 104 Then
            mLedgerBalance = GetOpeningBal(pAccountCode, pVDate,,, "", "Y", "")
        Else
            mLedgerBalance = GetOpeningBal(pAccountCode, pVDate,,, "", "N", "")
        End If




        SqlStr = " SELECT TO_DAYS, TYPE_OF_SUPPLIER FROM FIN_SUPP_CUST_MST A, FIN_PAYTERM_MST B" & vbCrLf _
            & " WHERE A.Company_Code = " & RsCompany.Fields("Company_Code").Value & "" & vbCrLf _
            & " AND A.SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf _
            & " AND A.Company_Code=B.Company_Code" & vbCrLf _
            & " AND A.PAYMENT_CODE=B.PAY_TERM_CODE" & vbCrLf

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mCreditDays = Val(IIf(IsDBNull(RsTemp.Fields("TO_DAYS").Value), 0, RsTemp.Fields("TO_DAYS").Value))
            mCustomerType = IIf(IsDBNull(RsTemp.Fields("TYPE_OF_SUPPLIER").Value), "", RsTemp.Fields("TYPE_OF_SUPPLIER").Value)
        End If

        If mCustomerType = "OEM" Then
            CheckCreditDaysLocking = False
            Exit Function
        End If

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 106 Then
            mCreditDays = mCreditDays + IIf(mCreditDays > 1, 15, 0)
        End If

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 104 And RsCompany.Fields("COMPANY_CODE").Value = 7 Then
            mCreditDays = IIf(mCreditDays > 1, IIf(mCreditDays < 100, 100, mCreditDays), 0)
        End If

        If mCreditDays > 1 Then
            If mLedgerBalance <= 0 Then
                CheckCreditDaysLocking = False
                Exit Function
            End If
        Else
            'If mLedgerBalance >= pBillAmount Then
            '    CheckCreditDaysLocking = False
            '    Exit Function
            'End If
        End If

        'SqlStr = " SELECT CREDIT_LIMIT FROM GEN_INVOICE_UNLOCK_TRN" & vbCrLf _
        '    & " WHERE SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf _
        '    & " AND APP_DATE=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND CREDIT_LIMIT>1"

        'MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        'If RsTemp.EOF = False Then
        '    mCreditDays = mCreditDays + 15
        '    Exit Function
        'End If

        mSaleFrom = DateAdd(Microsoft.VisualBasic.DateInterval.Day, mCreditDays * -1, CDate(pVDate))

        SqlStr = " SELECT " & vbCrLf _
                & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT) AS CREDIT_AMOUNT " & vbCrLf _
                & " FROM FIN_POSTED_TRN TRN " & vbCrLf _
                & " WHERE TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & "" & vbCrLf _
                & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'"

        '& vbCrLf _
        '        & " AND TRN.BOOKTYPE IN ('S')" ''('B','C','F')"


        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 106 And RsCompany.Fields("COMPANY_CODE").Value > 1 And RsCompany.Fields("FYEAR").Value = 2024 Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.BOOKTYPE IN ('S','O')"
        Else
            SqlStr = SqlStr & vbCrLf & " AND TRN.BOOKTYPE IN ('S')"
        End If

        ''TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & "


        If mCreditDays <= 1 And pBillNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BILLNO<>'" & pBillNo & "'"
        End If

        SqlStr = SqlStr & vbCrLf _
            & " AND TRN.Vdate>TO_DATE('" & VB6.Format(mSaleFrom, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf _
            & " AND TRN.Vdate<=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mCreditAmount = Val(IIf(IsDBNull(RsTemp.Fields("CREDIT_AMOUNT").Value), 0, RsTemp.Fields("CREDIT_AMOUNT").Value))
        End If

        If mCreditDays <= 1 Then
            mCreditAmount = mCreditAmount + pBillAmount
            If mCreditAmount <= 0 Then
                If mLedgerBalance < 0 Then
                    CheckCreditDaysLocking = False
                    Exit Function
                End If
                'If mLedgerBalance * -1 <= mCreditAmount Then
                '    CheckCreditDaysLocking = False
                '    Exit Function
                'End If
            Else
                If mLedgerBalance < mCreditAmount Then
                    CheckCreditDaysLocking = False
                    Exit Function
                End If
            End If

        Else
            If mLedgerBalance <= mCreditAmount Then
                CheckCreditDaysLocking = False
                Exit Function
            End If
        End If

CheckCreditLimit:

        SqlStr = " SELECT CREDIT_LIMIT FROM GEN_INVOICE_UNLOCK_TRN" & vbCrLf _
            & " WHERE SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf _
            & " AND APP_DATE=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND CREDIT_LIMIT>0"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckCreditDaysLocking = False
            Exit Function
        End If

        Dim mCreditLimit As Double = 0

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 106 Then
            If MainClass.ValidateWithMasterTable((pAccountCode), "SUPP_CUST_CODE", "CREDIT_LIMIT", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                mCreditLimit = Val(MasterNo)
            End If

            If Val(mLedgerBalance) < mCreditLimit Then
                CheckCreditDaysLocking = False
                Exit Function
            End If
        End If
        CheckCreditDaysLocking = True

        Exit Function
ErrPart:

        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function GetOpeningBal(ByRef pAccountCode As String, ByRef pVDate As String,
                                  Optional ByRef pCompanyName As String = "", Optional ByRef mDiv As Integer = 0,
                                  Optional pReportType As String = "",
                                  Optional pAllCompany As String = "", Optional mCompanyCodeStr As String = "") As Double


        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsOP As ADODB.Recordset = Nothing
        Dim pCompanyCode As Integer
        Dim mConditionTrue As Boolean
        Dim mIsGroupLimit As String = "N"
        Dim mGroupCode As Long

        GetOpeningBal = 0
        mConditionTrue = False
        ''/* index(TRN,INDEX_FIN_POSTED_TRN12) */


        If MainClass.ValidateWithMasterTable(pAccountCode, "SUPP_CUST_CODE", "GROUP_LIMIT", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "") = True Then
            mIsGroupLimit = MasterNo
        End If

        If mIsGroupLimit = "Y" Then
            If MainClass.ValidateWithMasterTable(pAccountCode, "SUPP_CUST_CODE", "GROUPCODE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "") = True Then
                mGroupCode = Val(MasterNo)
            End If
        End If

        SqlStr = " SELECT " & vbCrLf _
            & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT)AS OPENING "

        SqlStr = SqlStr & vbCrLf _
            & " FROM FIN_POSTED_TRN TRN " & vbCrLf _
            & " WHERE TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & ""

        If pAllCompany = "Y" Then
            If mCompanyCodeStr <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.COMPANY_CODE IN " & mCompanyCodeStr & ""
            End If
        Else
            If pCompanyName = "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
                mConditionTrue = True
            Else
                If MainClass.ValidateWithMasterTable(pCompanyName, "COMPANY_NAME", "COMPANY_CODE", "GEN_COMPANY_MST", PubDBCn, MasterNo, , "") = True Then
                    pCompanyCode = MasterNo
                Else
                    pCompanyCode = CInt("-1")
                End If
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & pCompanyCode & ""
                mConditionTrue = True
            End If
        End If

        If mDiv > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.DIV_CODE = " & mDiv & ""
        End If

        If mIsGroupLimit = "N" Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'"
        Else
            SqlStr = SqlStr & vbCrLf & " AND TRN.ACCOUNTCODE IN (SELECT SUPP_CUST_CODE FROM FIN_SUPP_CUST_MST WHERE GROUPCODE=" & mGroupCode & ")"
        End If


        If pVDate <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.Vdate<=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If

        If pReportType = "R" Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.BOOKTYPE<>'" & ConPDCBook & "'"
        End If



        'SqlStr = SqlStr & vbCrLf _
        ''& " FROM FIN_POSTED_TRN TRN " & vbCrLf _
        ''& " WHERE " & vbCrLf _
        ''& " TRN.Vdate<='" & vb6.Format(pVDate, "DD-MMM-YYYY") & "'" & vbCrLf _
        ''& " AND ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf _
        ''& " AND TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf _
        ''& " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOP, ADODB.LockTypeEnum.adLockReadOnly)
        If RsOP.EOF = False Then
            GetOpeningBal = Val(IIf(IsDBNull(RsOP.Fields("OPENING").Value), 0, RsOP.Fields("OPENING").Value))
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetSaleValue(ByRef pAccountCode As String, ByRef pFromVDate As String, ByRef pToVDate As String,
                                  Optional ByRef pCompanyName As String = "", Optional ByRef mDiv As Integer = 0,
                                  Optional pAllCompany As String = "", Optional mCompanyCodeStr As String = "") As Double


        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsOP As ADODB.Recordset = Nothing
        Dim pCompanyCode As Integer
        Dim mConditionTrue As Boolean
        Dim mIsGroupLimit As String = "N"
        Dim mGroupCode As Long

        GetSaleValue = 0
        mConditionTrue = False
        ''/* index(TRN,INDEX_FIN_POSTED_TRN12) */


        If MainClass.ValidateWithMasterTable(pAccountCode, "SUPP_CUST_CODE", "GROUP_LIMIT", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "") = True Then
            mIsGroupLimit = MasterNo
        End If

        If mIsGroupLimit = "Y" Then
            If MainClass.ValidateWithMasterTable(pAccountCode, "SUPP_CUST_CODE", "GROUPCODE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "") = True Then
                mGroupCode = Val(MasterNo)
            End If
        End If

        SqlStr = " SELECT " & vbCrLf _
            & " SUM(DECODE(TRN.DC,'D',1,-1) * TRN.AMOUNT)AS OPENING "

        SqlStr = SqlStr & vbCrLf _
            & " FROM FIN_POSTED_TRN TRN " & vbCrLf _
            & " WHERE TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & ""

        If pAllCompany = "Y" Then
            If mCompanyCodeStr <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.COMPANY_CODE IN " & mCompanyCodeStr & ""
            End If
        Else
            If pCompanyName = "" Then
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
                mConditionTrue = True
            Else
                If MainClass.ValidateWithMasterTable(pCompanyName, "COMPANY_NAME", "COMPANY_CODE", "GEN_COMPANY_MST", PubDBCn, MasterNo, , "") = True Then
                    pCompanyCode = MasterNo
                Else
                    pCompanyCode = CInt("-1")
                End If
                SqlStr = SqlStr & vbCrLf & " AND TRN.Company_Code = " & pCompanyCode & ""
                mConditionTrue = True
            End If
        End If

        If mDiv > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.DIV_CODE = " & mDiv & ""
        End If

        If mIsGroupLimit = "N" Then
            SqlStr = SqlStr & vbCrLf & " AND TRN.ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'"
        Else
            SqlStr = SqlStr & vbCrLf & " AND TRN.ACCOUNTCODE IN (SELECT SUPP_CUST_CODE FROM FIN_SUPP_CUST_MST WHERE GROUPCODE=" & mGroupCode & ")"
        End If



        SqlStr = SqlStr & vbCrLf & " AND TRN.Vdate>=TO_DATE('" & VB6.Format(pFromVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & " AND TRN.Vdate<=TO_DATE('" & VB6.Format(pToVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"


        SqlStr = SqlStr & vbCrLf & " AND TRN.BOOKTYPE IN ('S','L','M')"



        'SqlStr = SqlStr & vbCrLf _
        ''& " FROM FIN_POSTED_TRN TRN " & vbCrLf _
        ''& " WHERE " & vbCrLf _
        ''& " TRN.Vdate<='" & vb6.Format(pVDate, "DD-MMM-YYYY") & "'" & vbCrLf _
        ''& " AND ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'" & vbCrLf _
        ''& " AND TRN.FYEAR=" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf _
        ''& " AND TRN.Company_Code = " & RsCompany.Fields("Company_Code").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOP, ADODB.LockTypeEnum.adLockReadOnly)
        If RsOP.EOF = False Then
            GetSaleValue = Val(IIf(IsDBNull(RsOP.Fields("OPENING").Value), 0, RsOP.Fields("OPENING").Value))
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetHolidayAgtWorking(ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetHolidayAgtWorking = "N"
        SqlStr = " SELECT AGT_WORKING FROM PAY_HOLIDAY_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND HOLIDAY_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetHolidayAgtWorking = IIf(IsDBNull(RsTemp.Fields("AGT_WORKING").Value), "N", RsTemp.Fields("AGT_WORKING").Value)
        End If
        Exit Function
ErrPart:
        GetHolidayAgtWorking = "N"
    End Function
    Public Function GetWorkingDays(ByRef pDate As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mHolidays As Double

        GetWorkingDays = 0
        If pDate = "" Then Exit Function

        SqlStr = " SELECT COUNT(1) AS TOT_HOLIDAYS FROM PAY_HOLIDAY_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND TO_CHAR(HOLIDAY_DATE,'MMYYYY')='" & VB6.Format(pDate, "MMYYYY") & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If Not RsTemp.EOF Then
            mHolidays = IIf(IsDBNull(RsTemp.Fields("TOT_HOLIDAYS").Value), 0, RsTemp.Fields("TOT_HOLIDAYS").Value)
        End If
        GetWorkingDays = MainClass.LastDay(Month(CDate(pDate)), Year(CDate(pDate))) - mHolidays

        Exit Function
ErrPart:
        GetWorkingDays = 0
    End Function
    Public Sub GetPhoto(ByRef FileName As String, ByRef rstMain As ADODB.Recordset, ByRef FieldName As String, ByRef SizeField As String)
        On Error GoTo Handler
        Dim file_num As String
        Dim file_length As Integer
        Dim bytes() As Byte
        Dim num_blocks As Integer
        Dim left_over As Integer
        Dim block_num As Integer
        file_num = CStr(FreeFile())
        FileOpen(CInt(file_num), FileName, OpenMode.Binary, OpenAccess.Read)
        file_length = LOF(CInt(file_num))
        If file_length > 0 Then
            num_blocks = file_length / BLOCK_SIZE
            left_over = file_length Mod BLOCK_SIZE
            rstMain.Fields(SizeField).Value = file_length
            ReDim bytes(BLOCK_SIZE)
            For block_num = 1 To num_blocks
                FileGet(CShort(file_num), bytes)
                rstMain.Fields(FieldName).AppendChunk(bytes)
            Next block_num
            If left_over > 0 Then
                ReDim bytes(left_over)
                FileGet(CShort(file_num), bytes)
                rstMain.Fields(FieldName).AppendChunk(bytes)
            End If
            'rstEmployee.Update
            FileClose(CInt(file_num))
        End If
        Exit Sub
Handler:
        MsgBox(Err.Description)
        'Resume
    End Sub
    Public Function GetRoundClock(ByRef mCode As String, ByRef mDate As String, ByRef pEmpType As String) As Boolean
        On Error GoTo refreshErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFieldName As String
        Dim SqlStr As String = ""
        Dim mTableName As String
        GetRoundClock = False
        If pEmpType = "E" Then
            mTableName = "PAY_SHIFT_TRN"
        Else
            mTableName = "PAY_CONT_SHIFT_MST"
        End If
        SqlStr = " SELECT ROUND_CLOCK" & vbCrLf & " FROM " & mTableName & " TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mCode) & "'" & vbCrLf & " AND SHIFT_DATE=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf
        'SqlStr = SqlStr & vbCrLf & " AND WEEKLY_OFF ='N'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockOptimistic)
        If RsTemp.EOF = False Then
            GetRoundClock = IIf(RsTemp.Fields("ROUND_CLOCK").Value = "Y", True, False)
        Else
            GetRoundClock = False
        End If
        Exit Function
refreshErrPart:
        MsgBox(Err.Description)
        'Resume
    End Function
    Public Function GetTotalOperation(ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pOPRCode As String, ByRef pDate As String, Optional ByRef pOptionaOperation As String = "") As Integer
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSeq As Integer
        If pOPRCode = "" Then
            GetTotalOperation = 1
            Exit Function
        End If
        mSeq = 0
        SqlStr = ""
        SqlStr = "SELECT MAX(OPR_SNO) AS OPR_SNO " & vbCrLf & " FROM PRD_OPR_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) FROM PRD_OPR_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        If pDate <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If
        SqlStr = SqlStr & vbCrLf & ")"
        If pOptionaOperation <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ISOPTIONAL='" & pOptionaOperation & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSeq = IIf(IsDBNull(RsTemp.Fields("OPR_SNO").Value), 0, RsTemp.Fields("OPR_SNO").Value)
        Else
            mSeq = 1
        End If
        GetTotalOperation = mSeq
        Exit Function
ErrPart:
        GetTotalOperation = 1
    End Function
    Public Function UpdatePRDetail(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pRowNo As Integer, ByRef pTRNDtlSubRow As Integer, ByRef pAccountCode As String, ByRef pBookCode As String, ByRef pVType As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pTrnDC As String, ByRef pTrnAmount As Double, ByRef pChequeNo As String, ByRef pChqDate As String, ByRef pCostCCode As String, ByRef pDeptCode As String, ByRef pEmpCode As String, ByRef pExpCode As String, ByRef pIBRNo As String, ByRef pClearDate As String, ByRef pLocked As String, ByRef pNarration As String, ByRef xRemarks As String, ByRef pCancelled As String, ByRef pOldBookType As String, ByRef pOldBookSubType As String, ByRef pExpDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pTempProcessKey As Double, Optional ByRef pPLFlag As String = "", Optional ByRef pReverseCharge As String = "", Optional ByRef pSAC As String = "", Optional ByRef pCGSTPer As Double = 0, Optional ByRef pCGSTAmount As Double = 0, Optional ByRef pSGSTPer As Double = 0, Optional ByRef pSGSTAmount As Double = 0, Optional ByRef pIGSTPer As Double = 0, Optional ByRef pIGSTAmount As Double = 0) As Boolean
        ''
        On Error GoTo ErrDetail
        Dim RsTempPRDetail As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim pTRNType As String
        Dim pBillNo As String
        Dim pBillDate As String
        Dim pBillAmount As Double
        Dim pBillDC As String
        Dim pAmount As Double
        Dim pDC As String
        Dim pBillType As String
        Dim pSubRowNo As Integer
        Dim pRemarks As String
        Dim pDueDate As String
        Dim pSTTYPE As String
        Dim pSTFORMNAME As String
        Dim pSTFORMNO As String
        Dim pSTFORMDATE As String
        Dim pSTFORMAMT As Double
        Dim pSTDUEFORMNAME As String
        Dim pSTDUEFORMNO As String
        Dim pSTDUEFORMDATE As String
        Dim pSTDUEFORMAMT As Double
        Dim pISREGDNO As String
        Dim pSTFORMCODE As Integer
        Dim pSTDUEFORMCODE As Integer
        Dim pTaxableAmount As Double
        Dim pPONO As String
        Dim xDivCode As Double
        Dim mRefNo As String
        Dim mLocCode As String
        Dim mBillCompanyCode As Long
        Dim pCompanyBillAmount As Double
        Dim pTransferAccountCode As String
        Dim mPartyName As String = ""

        Dim mTDSAmount As Double
        Dim mInterestAmount As Double

        pSubRowNo = 1000 * pRowNo
        If pCancelled = "Y" Then
            pTrnAmount = 0
            GoTo SummariedPart
        End If
        If GetAccountBalancingMethod(pAccountCode, True) = "S" Then
            GoTo SummariedPart
        End If

        If MainClass.ValidateWithMasterTable(pAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mPartyName = MasterNo
        End If

        SqlStr = " Select * From FIN_TEMPBILL_TRN" & vbCrLf _
            & " WHERE UserID='" & PubUserID & "' AND TEMPMKEY=" & pTempProcessKey & "" & vbCrLf _
            & " AND TRNDtlSubRowNo=" & pTRNDtlSubRow & "" & vbCrLf _
            & " AND AccountCode='" & pAccountCode & "'" & vbCrLf _
            & " AND BookType='" & pOldBookType & pOldBookSubType & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempPRDetail, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTempPRDetail.EOF = False Then
            'pSubRowNo = 0
            Do While RsTempPRDetail.EOF = False
                pSubRowNo = pSubRowNo + 1
                pTRNType = RsTempPRDetail.Fields("TrnType").Value
                pBillNo = RsTempPRDetail.Fields("BillNo").Value
                pBillDate = IIf(IsDBNull(RsTempPRDetail.Fields("BillDate").Value), pVDate, RsTempPRDetail.Fields("BillDate").Value)
                pBillAmount = RsTempPRDetail.Fields("BillAmount").Value
                pBillDC = RsTempPRDetail.Fields("BillDC").Value
                pAmount = RsTempPRDetail.Fields("Amount").Value
                pDC = RsTempPRDetail.Fields("DC").Value
                pRemarks = IIf(IsDBNull(RsTempPRDetail.Fields("REMARKS").Value), "", RsTempPRDetail.Fields("REMARKS").Value)
                pDueDate = IIf(IsDBNull(RsTempPRDetail.Fields("DueDate").Value), "", RsTempPRDetail.Fields("DueDate").Value)
                pSTFORMNAME = IIf(IsDBNull(RsTempPRDetail.Fields("STFORMNAME").Value), "", RsTempPRDetail.Fields("STFORMNAME").Value)
                pSTFORMNO = IIf(IsDBNull(RsTempPRDetail.Fields("STFORMNO").Value), "", RsTempPRDetail.Fields("STFORMNO").Value)
                pSTFORMDATE = IIf(IsDBNull(RsTempPRDetail.Fields("STFORMDATE").Value), "", RsTempPRDetail.Fields("STFORMDATE").Value)
                pSTFORMAMT = IIf(IsDBNull(RsTempPRDetail.Fields("STFORMAMT").Value), 0, RsTempPRDetail.Fields("STFORMAMT").Value)
                pSTDUEFORMNAME = IIf(IsDBNull(RsTempPRDetail.Fields("STDUEFORMNAME").Value), "", RsTempPRDetail.Fields("STDUEFORMNAME").Value)
                pSTDUEFORMNO = IIf(IsDBNull(RsTempPRDetail.Fields("STDUEFORMNO").Value), "", RsTempPRDetail.Fields("STDUEFORMNO").Value)
                pSTDUEFORMDATE = IIf(IsDBNull(RsTempPRDetail.Fields("STDUEFORMDATE").Value), "", RsTempPRDetail.Fields("STDUEFORMDATE").Value)
                pSTDUEFORMAMT = IIf(IsDBNull(RsTempPRDetail.Fields("STDUEFORMAMT").Value), 0, RsTempPRDetail.Fields("STDUEFORMAMT").Value)
                pSTFORMCODE = IIf(IsDBNull(RsTempPRDetail.Fields("STFORMCODE").Value), -1, RsTempPRDetail.Fields("STFORMCODE").Value)
                pSTDUEFORMCODE = IIf(IsDBNull(RsTempPRDetail.Fields("STDUEFORMCODE").Value), -1, RsTempPRDetail.Fields("STDUEFORMCODE").Value)
                pSTTYPE = IIf(IsDBNull(RsTempPRDetail.Fields("STTYPE").Value), "", RsTempPRDetail.Fields("STTYPE").Value)
                pISREGDNO = IIf(IsDBNull(RsTempPRDetail.Fields("ISREGDNO").Value), "", RsTempPRDetail.Fields("ISREGDNO").Value)
                pTaxableAmount = IIf(IsDBNull(RsTempPRDetail.Fields("TAXABLE_AMOUNT").Value), 0, RsTempPRDetail.Fields("TAXABLE_AMOUNT").Value)
                pPONO = IIf(IsDBNull(RsTempPRDetail.Fields("PONO").Value), "", RsTempPRDetail.Fields("PONO").Value)
                xDivCode = IIf(IsDBNull(RsTempPRDetail.Fields("DIV_CODE").Value), "", RsTempPRDetail.Fields("DIV_CODE").Value)
                mRefNo = IIf(IsDBNull(RsTempPRDetail.Fields("REF_NO").Value), "", RsTempPRDetail.Fields("REF_NO").Value)
                mLocCode = IIf(IsDBNull(RsTempPRDetail.Fields("BILL_TO_LOC_ID").Value), "", RsTempPRDetail.Fields("BILL_TO_LOC_ID").Value)
                mBillCompanyCode = IIf(IsDBNull(RsTempPRDetail.Fields("BILL_COMPANY_CODE").Value), 0, RsTempPRDetail.Fields("BILL_COMPANY_CODE").Value)
                mBillCompanyCode = IIf(mBillCompanyCode <= 0, RsCompany.Fields("COMPANY_CODE").Value, mBillCompanyCode)

                mTDSAmount = IIf(IsDBNull(RsTempPRDetail.Fields("TDS_AMOUNT").Value), 0, RsTempPRDetail.Fields("TDS_AMOUNT").Value)
                mInterestAmount = IIf(IsDBNull(RsTempPRDetail.Fields("INTEREST_AMOUNT").Value), 0, RsTempPRDetail.Fields("INTEREST_AMOUNT").Value)



                SqlStr = "INSERT INTO FIN_BILLDETAILS_TRN ( " & vbCrLf _
                    & " MKey, TRNDtlSubRowNo ,SubRowNo," & vbCrLf _
                    & " AccountCode, TrnType, BillNo, BillDate," & vbCrLf _
                    & " BillAmount,BillDc, Amount,Dc,REMARKS,DUEDATE, " & vbCrLf _
                    & " STFORMNAME, STFORMNO, " & vbCrLf _
                    & " STFORMDATE, STFORMAMT, " & vbCrLf _
                    & " STDUEFORMNAME, STDUEFORMNO, " & vbCrLf _
                    & " STDUEFORMDATE, STDUEFORMAMT, " & vbCrLf _
                    & " STFORMCODE, STDUEFORMCODE, " & vbCrLf _
                    & " STTYPE, ISREGDNO, TAXABLE_AMOUNT,PONO,DIV_CODE,REF_NO,COMPANY_CODE,BILL_TO_LOC_ID," & vbCrLf _
                    & " BOOKTYPE,BILL_COMPANY_CODE,TDS_AMOUNT, INTEREST_AMOUNT  " & vbCrLf _
                    & " ) VALUES ( "


                SqlStr = SqlStr & vbCrLf _
                    & " '" & pMKey & "', " & pTRNDtlSubRow & "," & pSubRowNo & ", " & vbCrLf _
                    & " '" & pAccountCode & "'," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(UCase(pTRNType)) & "'," & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pBillNo) & "'," & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
                    & " " & pBillAmount & ", '" & pBillDC & "', " & pAmount & ", '" & pDC & "', " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pRemarks) & "',TO_DATE('" & VB6.Format(pDueDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pSTFORMNAME) & "', '" & MainClass.AllowSingleQuote(pSTFORMNO) & "', " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pSTFORMDATE, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & Val(CStr(pSTFORMAMT)) & ", " & vbCrLf _
                    & " '" & MainClass.AllowSingleQuote(pSTDUEFORMNAME) & "', '" & MainClass.AllowSingleQuote(pSTDUEFORMNO) & "', " & vbCrLf _
                    & " TO_DATE('" & VB6.Format(pSTDUEFORMDATE, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & Val(CStr(pSTDUEFORMAMT)) & ", " & vbCrLf _
                    & " " & Val(CStr(pSTFORMCODE)) & ", " & Val(CStr(pSTDUEFORMCODE)) & ", " & vbCrLf _
                    & " '" & pSTTYPE & "', '" & pISREGDNO & "', " & Val(CStr(pTaxableAmount)) & ", '" & pPONO & "', " & Val(CStr(xDivCode)) & ",'" & MainClass.AllowSingleQuote(mRefNo) & "'," & vbCrLf _
                    & " " & RsCompany.Fields("COMPANY_CODE").Value & ",'" & mLocCode & "', '" & VB.Left(pBookType, 1) & "'," & mBillCompanyCode & ", " & vbCrLf _
                    & " " & Val(mTDSAmount) & "," & Val(mInterestAmount) & ") "

                pDBCn.Execute(SqlStr)
                If pTRNType = "N" Then
                    pBillType = "B"
                ElseIf pTRNType = "B" Or pTRNType = "O" Or pTRNType = "A" Then
                    pBillType = "P"
                Else
                    pBillType = pTRNType
                End If
                If (pTRNType = "O" Or pTRNType = "A") And mRefNo <> "" Then
                    pBillNo = IIf(pBillNo = "On ACCOUNT", "On AC", pBillNo) & "-" & mRefNo
                End If
                pRemarks = IIf(Trim(pRemarks) = "", xRemarks, pRemarks & vbNewLine & xRemarks)
                If UpdateTRN(pDBCn, pMKey, pTRNDtlSubRow, pSubRowNo, pBookCode, pVType, pBookType, pBookSubType, pAccountCode, pVNo, pVDate, pBillNo,
                             pBillDate, pAmount, pDC, pTRNType, pChequeNo, pChqDate, pCostCCode, pDeptCode, pEmpCode, pExpCode, pDueDate, pIBRNo, pBillType,
                             pClearDate, pLocked, pNarration, pRemarks, pExpDate, pAddMode, pAddUser, pAddDate, xDivCode, mLocCode, pPLFlag,,,,,,,,, mBillCompanyCode) = False Then GoTo ErrDetail
                RsTempPRDetail.MoveNext()
            Loop
        Else
SummariedPart:
            pTRNType = "O"
            pBillNo = pVNo
            pBillDate = pVDate
            pBillAmount = pTrnAmount
            pBillDC = pTrnDC
            pAmount = pTrnAmount
            pDC = pTrnDC
            pRemarks = xRemarks
            pBillType = "P"
            pDueDate = pBillDate
            mLocCode = GetDefaultLocation(pBookCode)
            mBillCompanyCode = RsCompany.Fields("COMPANY_CODE").Value


            If UpdateTRN(pDBCn, pMKey, pTRNDtlSubRow, pSubRowNo, pBookCode, pVType, pBookType, pBookSubType, pAccountCode, pVNo, pVDate, pBillNo, pBillDate,
                         pAmount, pDC, pTRNType, pChequeNo, pChqDate, pCostCCode, pDeptCode, pEmpCode, pExpCode, pDueDate, pIBRNo, pBillType, pClearDate,
                         pLocked, pNarration, "", pExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, mLocCode, pPLFlag, pReverseCharge, pSAC, pCGSTPer,
                         pCGSTAmount, pSGSTPer, pSGSTAmount, pIGSTPer, pIGSTAmount, mBillCompanyCode) = False Then GoTo ErrDetail
        End If


        SqlStr = " Select SUM(Amount * DECODE(DC,'D',1,-1)) AS Amount, BILL_COMPANY_CODE From FIN_TEMPBILL_TRN" & vbCrLf _
            & " WHERE UserID='" & PubUserID & "' AND TEMPMKEY=" & pTempProcessKey & "" & vbCrLf _
            & " AND TRNDtlSubRowNo=" & pTRNDtlSubRow & "" & vbCrLf _
            & " AND AccountCode='" & pAccountCode & "'" & vbCrLf _
            & " AND BookType='" & pOldBookType & pOldBookSubType & "'" & vbCrLf _
            & " AND BILL_COMPANY_CODE<>" & RsCompany.Fields("COMPANY_CODE").Value & " GROUP BY BILL_COMPANY_CODE"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempPRDetail, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTempPRDetail.EOF = False Then
            'pSubRowNo = 0
            Do While RsTempPRDetail.EOF = False

                ''POst in Corresponding Unit
                pCompanyBillAmount = RsTempPRDetail.Fields("Amount").Value

                pTRNType = "O"
                pBillNo = pVNo
                pBillDate = pVDate
                pBillAmount = Math.Abs(pCompanyBillAmount)
                pBillDC = IIf(pCompanyBillAmount >= 0, "C", "D")
                pAmount = Math.Abs(pCompanyBillAmount)
                pDC = IIf(pCompanyBillAmount >= 0, "C", "D")
                pRemarks = "FROM : " & RsCompany.Fields("COMPANY_NAME").Value & " TO : " & mPartyName
                pBillType = "P"
                pDueDate = pBillDate
                mLocCode = GetDefaultLocation(pBookCode)
                mBillCompanyCode = RsTempPRDetail.Fields("BILL_COMPANY_CODE").Value        '' RsCompany.Fields("COMPANY_CODE").Value

                If MainClass.ValidateWithMasterTable(RsCompany.Fields("COMPANY_CODE").Value, "COMPANY_CODE", "COMP_AC_CODE", "FIN_PRINT_MST", PubDBCn, MasterNo) = True Then
                    pTransferAccountCode = MasterNo
                Else
                    UpdatePRDetail = False
                    Exit Function
                End If

                If UpdateTRN(pDBCn, pMKey, pTRNDtlSubRow, pSubRowNo, pBookCode, pVType, pBookType, pBookSubType, pTransferAccountCode, pVNo, pVDate, pBillNo, pBillDate,
                             pAmount, pDC, pTRNType, pChequeNo, pChqDate, pCostCCode, pDeptCode, pEmpCode, pExpCode, pDueDate, pIBRNo, pBillType, pClearDate,
                             pLocked, pRemarks, "", pExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, mLocCode, pPLFlag, pReverseCharge, pSAC, pCGSTPer,
                             pCGSTAmount, pSGSTPer, pSGSTAmount, pIGSTPer, pIGSTAmount, mBillCompanyCode) = False Then GoTo ErrDetail


                'Post in PAyment Unit
                pCompanyBillAmount = RsTempPRDetail.Fields("Amount").Value

                pTRNType = "O"
                pBillNo = pVNo
                pBillDate = pVDate
                pBillAmount = Math.Abs(pCompanyBillAmount)
                pBillDC = IIf(pCompanyBillAmount >= 0, "D", "C")
                pAmount = Math.Abs(pCompanyBillAmount)
                pDC = IIf(pCompanyBillAmount >= 0, "D", "C")
                pRemarks = "FROM : " & RsCompany.Fields("COMPANY_NAME").Value & " TO : " & mPartyName
                pBillType = "P"
                pDueDate = pBillDate
                mLocCode = GetDefaultLocation(pBookCode)
                mBillCompanyCode = RsCompany.Fields("COMPANY_CODE").Value

                If MainClass.ValidateWithMasterTable(RsTempPRDetail.Fields("BILL_COMPANY_CODE").Value, "COMPANY_CODE", "COMP_AC_CODE", "FIN_PRINT_MST", PubDBCn, MasterNo) = True Then
                    pTransferAccountCode = MasterNo
                Else
                    UpdatePRDetail = False
                    Exit Function
                End If

                If UpdateTRN(pDBCn, pMKey, pTRNDtlSubRow, pSubRowNo, pBookCode, pVType, pBookType, pBookSubType, pTransferAccountCode, pVNo, pVDate, pBillNo, pBillDate,
                             pAmount, pDC, pTRNType, pChequeNo, pChqDate, pCostCCode, pDeptCode, pEmpCode, pExpCode, pDueDate, pIBRNo, pBillType, pClearDate,
                             pLocked, pRemarks, "", pExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, mLocCode, pPLFlag, pReverseCharge, pSAC, pCGSTPer,
                             pCGSTAmount, pSGSTPer, pSGSTAmount, pIGSTPer, pIGSTAmount, mBillCompanyCode) = False Then GoTo ErrDetail

                RsTempPRDetail.MoveNext()
            Loop
        End If

        UpdatePRDetail = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdatePRDetail = False
        'Resume
    End Function
    Public Function UpdateLoanDetail(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pEmpCode As String, ByRef pCancelled As String) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        If pCancelled = "Y" Then
            UpdateLoanDetail = True
            Exit Function
        End If
        SqlStr = "INSERT INTO PAY_LOAN_MST( " & vbCrLf & " MKEY, Company_Code, FYEAR, " & vbCrLf & " Emp_Code, SUBROWNO, LoanType, " & vbCrLf & " LoanAmount, LoanDate, InstalmentAmt, " & vbCrLf & " InterestCalc, InterestRate, Deduct_Date, " & vbCrLf & " StartingMonth, StartingYear, OPPrincipalAmt, " & vbCrLf & " InterestAmt, PrincipalAmt, Deduct_Amount, " & vbCrLf & " Balance_Amount, Paid_Amount)"
        SqlStr = SqlStr & vbCrLf & " Select '" & pMKey & "' ," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " EMP_CODE, SUBROWNO, LOANTYPE, " & vbCrLf & " LoanAmount, LoanDate, InstalmentAmt, " & vbCrLf & " InterestCalc, InterestRate, Deduct_Date, " & vbCrLf & " StartingMonth, StartingYear, OPPrincipalAmt, " & vbCrLf & " InterestAmt, PrincipalAmt, Deduct_Amount, " & vbCrLf & " Balance_Amount, Paid_Amount" & vbCrLf & " FROM TEMP_PAY_LOAN_MST" & vbCrLf & " WHERE UserID='" & PubUserID & "'" & vbCrLf & " AND Emp_Code='" & pEmpCode & "'"
        pDBCn.Execute(SqlStr)
        UpdateLoanDetail = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateLoanDetail = False
        ''Resume
    End Function
    Public Function UpdateServiceTaxDetail(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCancelled As String) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        If pCancelled = "Y" Then
            UpdateServiceTaxDetail = True
            Exit Function
        End If
        SqlStr = "INSERT INTO FIN_SERVTAXDETAILS_TRN( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " SUBROWNO, ACCOUNTCODE, " & vbCrLf & " RO, BILLNO, BILLDATE, BILLAMOUNT, " & vbCrLf & " TAX_ON, SERVICETAX_AMT, CESS_AMT, " & vbCrLf & " SERV_PROV, ISSERVICECLAIM, SERVNO, " & vbCrLf & " SERVDATE, SERVICE_PER, CESS_PER,SHE_CESS_PER, SHE_CESS_AMT," & vbCrLf & " SWACHH_CESS_PER,SWACHH_CESS_AMOUNT ," & vbCrLf & " KK_CESS_PER, KK_CESS_AMOUNT)"
        SqlStr = SqlStr & vbCrLf & " SELECT '" & pMKey & "' , " & vbCrLf & " " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " SUBROWNO, ACCOUNTCODE, " & vbCrLf & " RO, BILLNO, BILLDATE, BILLAMOUNT, " & vbCrLf & " TAX_ON, SERVICETAX_AMT, CESS_AMT, " & vbCrLf & " SERV_PROV, ISSERVICECLAIM, SERVNO, " & vbCrLf & " SERVDATE, SERVICE_PER, CESS_PER ,SHE_CESS_PER, SHE_CESS_AMT, " & vbCrLf & " SWACHH_CESS_PER,SWACHH_CESS_AMOUNT," & vbCrLf & " KK_CESS_PER, KK_CESS_AMOUNT " & vbCrLf & " FROM FIN_TEMP_SERVICE_TRN" & vbCrLf & " WHERE UserID='" & PubUserID & "'"
        pDBCn.Execute(SqlStr)
        UpdateServiceTaxDetail = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateServiceTaxDetail = False
        ''Resume
    End Function
    '    Public Function GetClientVars(ByRef SearchString As String) As Object
    '        On Error GoTo ShowErr
    '        Dim MyString As String
    '        Dim mString As String
    '        Dim mSearchString As String
    '        If Dir(My.Application.Info.DirectoryPath & "\REVIVE.CFG") = "" Then 'FILE DOES NOT EXIST
    '            MsgInformation("ERP Configuration file not found at " & My.Application.Info.DirectoryPath & " Or Can Not Rread This file")
    '            Exit Function
    '        End If
    '        FileOpen(1, My.Application.Info.DirectoryPath & "\REVIVE.CFG", OpenMode.Input)
    '        MyString = ""
    '        mSearchString = "[" & UCase(SearchString) & "]"
    '        Do While Not EOF(1)
    '            Input(1, MyString)
    '            If UCase(Left(MyString, Len(mSearchString))) = mSearchString Then
    '                GetClientVars = UCase(Trim(Mid(MyString, Len(mSearchString) + 1)))
    '                'ElseIf UCase(Left(MySTRING, 10)) = "[FONTSIZE]" Then
    '                'OCBillPrintingFontSize = Trim(Mid$(MySTRING, 12))
    '                'ElseIf UCase(Left(MySTRING, 10)) = "[FONTBOLD]" Then
    '                'OCBillPrintingFontBold = Trim(Mid$(MySTRING, 11))
    '                'ElseIf UCase(Left(MySTRING, 12)) = "[BILLFORMAT]" Then
    '                'OCBillFormat = Trim(Mid$(MySTRING, 14))
    '                'ElseIf UCase(Left(MySTRING, 12)) = "[QTYDECIMAL]" Then
    '                'OCQtyDecimal = Val(Trim(Mid$(MySTRING, 14)))
    '                'ElseIf UCase(Left(MySTRING, 20)) = "[CHECKNEGATIVESTOCK]" Then
    '                'OCNegetiveStock = IIf(Trim(Mid(MySTRING, 22)) = "YES", True, False)
    '                'ElseIf UCase(Left(MySTRING, 20)) = "[MEDICALITEMBILLING]" Then
    '                'OCMedicalBilling = IIf(Trim(Mid(MySTRING, 22)) = "YES", True, False)
    '                'ElseIf UCase(Left(MySTRING, 11)) = "[BILLWIDTH]" Then
    '                'OCBillWidth = Val(Trim(Mid(MySTRING, 13)))
    '                'ElseIf UCase(Left(MySTRING, 14)) = "[BILLSCRWIDTH]" Then
    '                'OCBillScrWidth = Val(Trim(Mid(MySTRING, 16)))
    '                'ElseIf UCase(Left(MySTRING, 15)) = "[BILLSCRHEIGHT]" Then
    '                'OCBillScrHeight = Val(Trim(Mid(MySTRING, 17)))
    '                'ElseIf UCase(Left(MySTRING, 14)) = "[STOPCURSORAT]" Then
    '                'mString = UCase(Trim(Mid(MySTRING, 16)))
    '                'If mString = "QTY" Then OCCursorStop = 8
    '                'If mString = "RATE" Then OCCursorStop = 7
    '                'If mString = "" Then OCCursorStop = 0
    '                'ElseIf UCase(Left(MySTRING, 9)) = "[COUNTER]" Then
    '                'OCCounterNo = UCase(Trim(Mid(MySTRING, 10)))
    '                'If MainClass.ValidateWithMasterTable(OCCounterNo, "CounterNo", "CounterNo", "Counter", PubDBCn, MasterNo) = False Then
    '                'MsgInformation "Counter No " + OCCounterNo + " found in Configuration file is invalid"
    '                'OCCounterNo = "X"
    '                'End If
    '                'ElseIf UCase(Left(MySTRING, 9)) = "[TOOLBAR]" Then
    '                'Master.Toolbar1.Visible = IIf(Trim(Mid(MySTRING, 11)) = "YES", True, False)
    '                'If Master.Toolbar1.Visible = True Then
    '                'Master.mnuToolbar.Checked = True
    '                'Else
    '                'Master.mnuToolbar.Checked = False
    '                'End If
    '            End If
    '        Loop
    '        'If OCCounterNo = "" Then
    '        'MsgInformation "No Counter Defined for this terminal, billing not permitted"
    '        'End If
    '        'If OCCounterNo = "X" Then OCCounterNo = ""
    '        'If OCCounterNo = "" Then
    '        'Master.mnuBilling.Enabled = False
    '        'End If
    '        FileClose(1)
    '        Exit Function
    'ShowErr:
    '        FileClose(1)
    '        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    '    End Function
    Public Function GetPunchTime(ByRef mEmpCode As String, ByRef mDate As String, ByRef mTable As String) As String
        On Error GoTo refreshErrPart
        Dim RsAttn As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mTableName As String
        GetPunchTime = ""
        If CurrModuleName = mContPayrollModule Then
            If RsCompany.Fields("PUNCH_FROM").Value = "G" Then
                mTableName = IIf(IsDBNull(RsCompany.Fields("PUNCH_GATE_TABLE").Value), "TEMPDATA", RsCompany.Fields("PUNCH_GATE_TABLE").Value) '"TEMPDATA_CORP"
            Else
                mTableName = IIf(IsDBNull(RsCompany.Fields("PUNCH_DEPT_TABLE").Value), "FACEPUNCHTEMPDATA", RsCompany.Fields("PUNCH_DEPT_TABLE").Value)
            End If
        Else
            mTableName = "TEMPDATA"
        End If

        SqlStr = " SELECT DISTINCT EMP.EMP_NAME, EMP.EMP_CODE, " & vbCrLf & " EMP.EMP_DEPT_CODE, TO_CHAR(OFFICEPUNCH,'DD-MON-YYYY HH24:MI') AS OFFICEPUNCH " & vbCrLf & " FROM " & mTable & " EMP, " & mTableName & " SMST " & vbCrLf & " WHERE EMP.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""

        SqlStr = SqlStr & vbCrLf & " AND TRIM(EMP.EMP_CODE) = TRIM(SMST.CARDNO) " & vbCrLf & " AND TO_CHAR(SMST.OFFICEPUNCH,'YYYYMMDD')= '" & VB6.Format(mDate, "YYYYMMDD") & "'"

        SqlStr = SqlStr & vbCrLf & " AND EMP.EMP_CODE='" & MainClass.AllowSingleQuote(mEmpCode) & "'"
        SqlStr = SqlStr & vbCrLf & "Order by OFFICEPUNCH"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsAttn, ADODB.LockTypeEnum.adLockOptimistic)
        If RsAttn.EOF = False Then
            Do While Not RsAttn.EOF
                If GetPunchTime = "" Then
                    GetPunchTime = VB6.Format(IIf(IsDBNull(RsAttn.Fields("OFFICEPUNCH").Value), "", RsAttn.Fields("OFFICEPUNCH").Value), "HH:mm")
                Else
                    GetPunchTime = GetPunchTime & " " & VB6.Format(IIf(IsDBNull(RsAttn.Fields("OFFICEPUNCH").Value), "", RsAttn.Fields("OFFICEPUNCH").Value), "HH:mm")
                End If
                RsAttn.MoveNext()
            Loop
        End If
        Exit Function
refreshErrPart:
        MsgBox(Err.Description)
        'Resume
    End Function
    Public Function GetLotNo(ByRef pDBCn As ADODB.Connection, ByRef mRefNo As String, ByRef mItemCode As String, ByRef pInsertBarCode As Boolean) As Integer
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RSLot As ADODB.Recordset = Nothing
        Dim RSPoLot As ADODB.Recordset = Nothing
        Dim mLotNo As Integer
        SqlStr = " SELECT LotNoSeq as LotNoSeq FROM BARCODE " & vbCrLf & " WHERE CompanyCode=" & RsCompany.Fields("CompanyCode").Value & " AND " & vbCrLf & " RefNo='" & MainClass.AllowSingleQuote(UCase(mRefNo)) & "' AND " & vbCrLf & " ITEMCODE='" & MainClass.AllowSingleQuote(UCase(mItemCode)) & "'"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RSPoLot, ADODB.LockTypeEnum.adLockReadOnly)
        If Not RSPoLot.EOF Then
            mLotNo = Val(RSPoLot.Fields("LotNoSeq").Value)
            pInsertBarCode = False
        Else
            'After GRN...
            SqlStr = " SELECT MAX(LotNoSeq) as LotNoSeq FROM BARCODE " & vbCrLf & " WHERE CompanyCode=" & RsCompany.Fields("CompanyCode").Value & " AND " & vbCrLf & " ITEMCODE='" & MainClass.AllowSingleQuote(LTrim(RTrim(UCase(mItemCode)))) & "'"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RSLot, ADODB.LockTypeEnum.adLockReadOnly)
            If Not RSLot.EOF Then
                If IsDBNull(RSLot.Fields("LotNoSeq").Value) Then
                    mLotNo = 1
                Else
                    mLotNo = Val(RSLot.Fields("LotNoSeq").Value) + 1
                End If
            Else
                mLotNo = 1
            End If
            pInsertBarCode = True
        End If
        GetLotNo = mLotNo
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    'Public Function FromToDate(Report2 As CrystalReport, mDateFrom As String, mDateTo As String)
    'MainClass.AssignCRptFormulas Report2, "FromDateYear = '" & Year(mDateFrom) & "'"
    'MainClass.AssignCRptFormulas Report2, "FromDateMonth= '" & Month(mDateFrom) & "'"
    'MainClass.AssignCRptFormulas Report2, "FromDateDay= '" & Day(mDateFrom) & "'"
    'MainClass.AssignCRptFormulas Report2, "ToDateYear = '" & Year(mDateTo) & "'"
    'MainClass.AssignCRptFormulas Report2, "ToDateMonth= '" & Month(mDateTo) & "'"
    'MainClass.AssignCRptFormulas Report2, "ToDateDay= '" & Day(mDateTo) & "'"
    'End Function
    Public Function MainDateCheck(ByRef txtDate As Object, ByRef DateFieldName As String) As Boolean
        If txtDate = "" Then
            MsgInformation(DateFieldName & " Date is Empty")
            Exit Function
        End If
        If MainClass.ChkIsdateF(txtDate) = False Then Exit Function
        If FYChk(CStr(CDate(txtDate))) = False Then Exit Function
        MainDateCheck = True
    End Function
    Public Function GetTariffHeading(ByRef mItemCode As String, ByRef pTariff As String, ByRef pTariffDesc As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If Trim(mItemCode) = "" Then Exit Function
        SqlStr = "SELECT TARRIF_CODE, TARRIF_DESC FROM " & vbCrLf & " INV_ITEM_MST, FIN_TARRIF_MST " & vbCrLf & " WHERE INV_ITEM_MST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND INV_ITEM_MST.COMPANY_CODE=FIN_TARRIF_MST.COMPANY_CODE " & vbCrLf & " AND INV_ITEM_MST.TARIFF_CODE=FIN_TARRIF_MST.TARRIF_CODE" & vbCrLf & " AND ITEM_CODE='" & mItemCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            pTariff = IIf(IsDBNull(RsTemp.Fields("TARRIF_CODE").Value), "", RsTemp.Fields("TARRIF_CODE").Value)
            pTariffDesc = IIf(IsDBNull(RsTemp.Fields("TARRIF_DESC").Value), "", RsTemp.Fields("TARRIF_DESC").Value)
        End If
        GetTariffHeading = True
        Exit Function
ErrPart:
        GetTariffHeading = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function WebRequestFetch(ByRef peWayBillNo As String) As Boolean
        '        On Error GoTo ErrPart
        '        Dim url As String
        '        Dim pUserGSTin As String
        '        Dim mSqlStr As String
        '        Dim RsTemp As ADODB.Recordset = Nothing
        '        Dim pStaus As String
        '        Dim meWayResponseID As String
        '        Dim mBody As String
        '        Dim meWayBillNoStr As String
        '        Dim url1 As String
        '        Dim pCompanyId As String
        '        Dim pBranchId As String
        '        Dim pTokenId As String
        '        Dim pUserId As String
        '        Dim pResponseIdText As String
        '        Dim pError As String
        '        Dim FilePath As String
        '        WebRequestFetch = True
        '        Exit Function
        '        Dim http As MSXML2.XMLHTTP60 '' MSXML.xmlhttp
        '        http = CreateObject("MSXML2.ServerXMLHTTP")
        '        'peWayBillNo = "391010965783"
        '        meWayBillNoStr = "{""ewbNo"":""" & peWayBillNo & """}"
        '        If GeteWaySetupContents(url, pCompanyId, pBranchId, pTokenId, pUserId, "F") = False Then GoTo ErrPart
        '        http.Open("POST", url, False)
        '        http.setRequestHeader("Content-Type", "application/json")
        '        http.setRequestHeader("idCompany", pCompanyId) ''84
        '        http.setRequestHeader("idBranch", pBranchId) ''102
        '        http.setRequestHeader("token", pTokenId) '' "b9979d7e-28be-4ba1-b07e-ac5557ef3499"
        '        http.setRequestHeader("idUser", pUserId) ''9230
        '        http.Send(meWayBillNoStr)
        '        pResponseIdText = http.responseText
        '        Dim JsonTest As Object
        '        JsonTest = JSON.parse(pResponseIdText)
        '        pStaus = JsonTest.Item("status")
        '        If UCase(pStaus) = "FALSE" Then
        '            'pError = JsonTest.Item("errors").Item(1).Item("description") & "," & JsonTest.Item("errors").Item(1).Item("message")''Item("items").Item(1).Item("url")
        '            MsgInformation(pError)
        '            WebRequestFetch = False
        '            http = Nothing
        '            Exit Function
        '        End If
        '        'meWayResponseID = JsonTest.Item("elements").Item(mResponseId).Item("ewayBillNo") '' JsonTest.Item("message")
        '        'meWayBillDate = JsonTest.Item("elements").Item(mResponseId).Item("ewayBillDate")
        '        'meWayBillUpto = JsonTest.Item("elements").Item(mResponseId).Item("validUpto")
        '        'meWayFilePath = JsonTest.Item("elements").Item(mResponseId).Item("filePath")
        '        WebRequestFetch = True
        '        http = Nothing
        '        Exit Function
        'ErrPart:
        '        'Resume
        '        WebRequestFetch = False
        '        MsgBox(Err.Description)
    End Function
    Public Function CheckDebitNoteExsits(ByRef mMRRNo As Double) As Boolean
        On Error GoTo ERR2
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mVNO As String = ""
        CheckDebitNoteExsits = False

        If mMRRNo <= 0 Then
            Exit Function
        End If

        SqlStr = "" 'AND DNCNFROM IN ('P','M')
        SqlStr = "SELECT VNO, VDATE FROM FIN_DNCN_HDR" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND MKEY IN (" & vbCrLf _
            & " SELECT MKEY FROM FIN_DNCN_DET" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND MRR_REF_NO=" & Val(CStr(mMRRNo)) & ") AND CANCELLED='N'" '' AND APPROVED='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mVNO = mVNO & IIf(mVNO = "", "", ",") & IIf(IsDBNull(RsTemp.Fields("VNO").Value), "", RsTemp.Fields("VNO").Value)
                RsTemp.MoveNext()
            Loop
            MsgBox("Debit Note Made [ " & mVNO & " ] Against This MRR. So Can't Delete.", MsgBoxStyle.Information)
            CheckDebitNoteExsits = True
        End If
        Exit Function
ERR2:
        CheckDebitNoteExsits = False
        MsgBox(Err.Description)
    End Function
    Public Function CheckDebitNoteServiceExists(ByRef mSupplierCode As String, ByRef mBillNo As String, ByRef mBillDate As String) As Boolean
        On Error GoTo ERR2
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mVNO As String = ""
        CheckDebitNoteServiceExists = False
        SqlStr = ""
        SqlStr = "SELECT VNO, VDATE FROM FIN_DNCN_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND (DEBITACCOUNTCODE='" & mSupplierCode & "' OR CREDITACCOUNTCODE='" & mSupplierCode & "')" & vbCrLf & " AND BILLNO='" & mBillNo & "'" & vbCrLf & " AND INVOICE_DATE=TO_DATE('" & VB6.Format(mBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND CANCELLED='N'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mVNO = mVNO & IIf(mVNO = "", "", ",") & IIf(IsDBNull(RsTemp.Fields("VNO").Value), "", RsTemp.Fields("VNO").Value)
                RsTemp.MoveNext()
            Loop
            MsgBox("Debit/Credit Note Made [ " & mVNO & " ] Against This Bill. So Can't Delete.", MsgBoxStyle.Information)
            CheckDebitNoteServiceExists = True
        End If
        Exit Function
ERR2:
        CheckDebitNoteServiceExists = False
        MsgBox(Err.Description)
    End Function
    Public Function GetDueDays(ByRef pAccountCode As Integer, ByRef pPvtDBCn As ADODB.Connection) As Double
        On Error GoTo ErrPart
        Dim mDueDays As Double
        If MainClass.ValidateWithMasterTable(pAccountCode, "Code", "BILLDUEDAYS", "ACM", pPvtDBCn, MasterNo) = True Then
            mDueDays = IIf(IsDBNull(MasterNo), 0, Val(MasterNo))
        Else
            mDueDays = 0
        End If
        GetDueDays = mDueDays
        Exit Function
ErrPart:
        GetDueDays = 0
        MsgBox(Err.Description)
    End Function
    'Public Function SetMainFormCordinate(ByRef MyForm As System.Windows.Forms.Form) As Object
    '    MyForm.Left = 0
    '    MyForm.Top = 0
    '    MyForm.Height = VB6.TwipsToPixelsY(VB6.PixelsToTwipsY(MyForm.Height))
    '    MyForm.Width = VB6.TwipsToPixelsX(VB6.PixelsToTwipsX(MyForm.Width))
    'End Function
    Public Function GetCT1Date(ByRef xDBCn As ADODB.Connection, ByRef xCTNo As Double, ByRef xItemCode As String, ByRef xBookType As String, ByRef xAccountCode As String) As String
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xBookSubType As String
        GetCT1Date = ""
        If xBookType = "S" Then
            xBookSubType = "I"
        Else
            xBookSubType = "O"
        End If
        SqlStr = " SELECT MAX(CT_DATE) AS CT_DATE " & vbCrLf & " FROM FIN_CT1_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & xBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & xBookSubType & "'"
        SqlStr = SqlStr & vbCrLf & " AND SUPP_CUST_CODE='" & xAccountCode & "'" & vbCrLf & " AND CT_NO=" & Val(CStr(xCTNo)) & ""
        If xItemCode <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE ='" & xItemCode & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, xDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCT1Date = VB6.Format(IIf(IsDBNull(RsTemp.Fields("CT_DATE").Value), "", RsTemp.Fields("CT_DATE").Value), "DD/MM/YYYY")
        End If
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function GetSaleValue_IncludingED(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCancel As Boolean, ByRef pServiceTaxAmount As Double) As Double
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing
        GetSaleValue_IncludingED = 0
        If pCancel = True Or RsCompany.Fields("FYEAR").Value < 2008 Then
            GetSaleValue_IncludingED = 0
            Exit Function
        End If
        'Identification = "ED"
        'Identification = "EDU"
        'Identification = "SHC"
        'Identification = "ADE"
        'Identification = "BCD"
        'Identification = "CED"
        'Identification = "HCC"
        'Identification = "AEC"
        'Identification = "AHC"
        'Identification = "BCE"
        SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N' AND ISINCLUDING_SALES='Y'" ''& vbCrLf |& " AND IDENTIFICATION IN ('ED','EDU','SHC','ADE','BCD','CED','HCC','AEC','AHC','BCE')"
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            'Do While Not RsTrn.EOF
            If pServiceTaxAmount = 0 Then
                GetSaleValue_IncludingED = GetSaleValue_IncludingED + IIf(IsDBNull(RsTrn.Fields("Amount").Value), 0, RsTrn.Fields("Amount").Value)
            End If
            'RsTrn.MoveNext
            'Loop
        End If
        Exit Function
SalePostTrnErr:
        GetSaleValue_IncludingED = 0
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetSaleValue_IncludingGST(ByRef pDBCn As ADODB.Connection, ByRef pBookCode As String, ByRef pMKey As String, ByRef pCancel As Boolean, ByRef pServiceTaxAmount As Double) As Double
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing

        GetSaleValue_IncludingGST = 0
        If pCancel = True Then
            GetSaleValue_IncludingGST = 0
            Exit Function
        End If
        If CDbl(pBookCode) = ConSalesBookCode Or CDbl(pBookCode) = ConSaleSuppBookCode Or CDbl(pBookCode) = ConSaleMiscBookCode Then
            SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N' AND ISINCLUDING_SALES='Y'"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        ElseIf CDbl(pBookCode) = ConSaleDebitBookCode Or CDbl(pBookCode) = ConSaleCreditBookCode Then
            SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_SUPP_SALE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND ISINCLUDING_SALES='Y'"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        Else
            GetSaleValue_IncludingGST = 0
            Exit Function
        End If
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            If pServiceTaxAmount = 0 Then
                GetSaleValue_IncludingGST = GetSaleValue_IncludingGST + IIf(IsDBNull(RsTrn.Fields("Amount").Value), 0, RsTrn.Fields("Amount").Value)
            End If
        End If
        Exit Function
SalePostTrnErr:
        GetSaleValue_IncludingGST = 0
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetGSTRecoveable_Export(ByRef pDBCn As ADODB.Connection, ByRef pBookCode As String, ByRef pMKey As String, ByRef pCancel As Boolean) As Double
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing

        GetGSTRecoveable_Export = 0
        If pCancel = True Then
            GetGSTRecoveable_Export = 0
            Exit Function
        End If
        If CDbl(pBookCode) = ConSalesBookCode Or CDbl(pBookCode) = ConSaleSuppBookCode Or CDbl(pBookCode) = ConSaleMiscBookCode Then
            SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N' AND IS_GSTRECOVERABLE='Y'"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        ElseIf CDbl(pBookCode) = ConSaleDebitBookCode Or CDbl(pBookCode) = ConSaleCreditBookCode Then
            SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_SUPP_SALE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND IS_GSTRECOVERABLE='Y'"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        Else
            GetGSTRecoveable_Export = 0
            Exit Function
        End If
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            GetGSTRecoveable_Export = GetGSTRecoveable_Export + IIf(IsDBNull(RsTrn.Fields("Amount").Value), 0, RsTrn.Fields("Amount").Value)
        End If
        Exit Function
SalePostTrnErr:
        GetGSTRecoveable_Export = 0
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetSaleRTNValue_IncludingED(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCancel As Boolean, ByRef pServiceTaxAmount As Double) As Double
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing
        GetSaleRTNValue_IncludingED = 0
        If pCancel = True Or RsCompany.Fields("FYEAR").Value < 2008 Then
            GetSaleRTNValue_IncludingED = 0
            Exit Function
        End If
        'Identification = "ED"
        'Identification = "EDU"
        'Identification = "SHC"
        'Identification = "ADE"
        'Identification = "BCD"
        'Identification = "CED"
        'Identification = "HCC"
        'Identification = "AEC"
        'Identification = "AHC"
        'Identification = "BCE"
        SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM FIN_PURCHASE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N'" & vbCrLf & " AND IDENTIFICATION IN ('ED','EDU','SHC','ADE','BCD','CED','HCC','AEC','AHC','BCE')"
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            'Do While Not RsTrn.EOF
            If pServiceTaxAmount = 0 Then
                GetSaleRTNValue_IncludingED = GetSaleRTNValue_IncludingED + IIf(IsDBNull(RsTrn.Fields("Amount").Value), 0, RsTrn.Fields("Amount").Value)
            End If
            'RsTrn.MoveNext
            'Loop
        End If
        Exit Function
SalePostTrnErr:
        GetSaleRTNValue_IncludingED = 0
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetSaleInvoiceDate(ByRef mSerialNo As Integer, ByRef mMRRNo As Double, ByRef mInvoiceNo As String, ByRef mItemCode As String, ByRef pDBCn As ADODB.Connection) As String
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing
        GetSaleInvoiceDate = ""
        If mMRRNo = 0 And mItemCode = "" Then
            SqlStr = " SELECT INVOICE_DATE FROM FIN_INVOICE_HDR WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & " AND AUTO_KEY_INVOICE =" & mInvoiceNo & " "
        Else
            SqlStr = " SELECT INVOICE_DATE FROM FIN_INVOICE_HDR " & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND AUTO_KEY_INVOICE = ( " & vbCrLf & " SELECT ID.REF_AUTO_KEY_NO " & vbCrLf & " FROM INV_GATE_HDR IH, INV_GATE_DET ID " & vbCrLf & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND IH.AUTO_KEY_MRR = ID.AUTO_KEY_MRR" & vbCrLf & " AND IH.AUTO_KEY_MRR = " & mMRRNo & "" & vbCrLf & " AND ID.SERIAL_NO = " & mSerialNo & "" & vbCrLf & " AND ID.ITEM_CODE = '" & MainClass.AllowSingleQuote(mItemCode) & "')"
        End If
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            GetSaleInvoiceDate = IIf(IsDBNull(RsTrn.Fields("INVOICE_DATE").Value), "", RsTrn.Fields("INVOICE_DATE").Value)
        End If
        Exit Function
SalePostTrnErr:
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetExpenseHeadAmount(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pTableName As String, ByRef pExpIdenty As String) As Double
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTrn As ADODB.Recordset = Nothing
        SqlStr = " SELECT SUM(A.AMOUNT) AS AMOUNT " & vbCrLf & " FROM " & pTableName & " A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND IDENTIFICATION ='" & pExpIdenty & "'"
        If PubGSTApplicable = True Then
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        Else
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        End If
        '' AND DUTYFORGONE='N'
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTrn.EOF = False Then
            GetExpenseHeadAmount = IIf(IsDBNull(RsTrn.Fields("Amount").Value), 0, RsTrn.Fields("Amount").Value)
        End If
        Exit Function
SalePostTrnErr:
        GetExpenseHeadAmount = 0
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function DeleteReworkTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefType As String, ByRef pRefNo As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM PRD_REWORK_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND REF_TYPE='" & pRefType & "'" & vbCrLf & " AND AUTO_KEY_REF=" & Val(pRefNo) & "" & vbCrLf
        pDBCn.Execute(SqlStr)
        DeleteReworkTRN = True
        Exit Function
UpdateStockTRNErr:
        DeleteReworkTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetDebitNameOfInvType(ByRef pInvType As String, ByRef pName As String) As String
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        GetDebitNameOfInvType = ""
        If Trim(pInvType) = "" Then Exit Function
        SqlStr = "SELECT FIN_SUPP_CUST_MST.SUPP_CUST_NAME, FIN_SUPP_CUST_MST.SUPP_CUST_CODE " & vbCrLf _
            & " FROM FIN_SUPP_CUST_MST,FIN_INVTYPE_MST " & vbCrLf _
            & " WHERE FIN_SUPP_CUST_MST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND FIN_SUPP_CUST_MST.COMPANY_CODE=FIN_INVTYPE_MST.COMPANY_CODE " & vbCrLf _
            & " AND FIN_SUPP_CUST_MST.SUPP_CUST_CODE=FIN_INVTYPE_MST.ACCOUNTPOSTCODE " & vbCrLf _
            & " AND FIN_INVTYPE_MST.NAME='" & MainClass.AllowSingleQuote(pInvType) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            If pName = "Y" Then
                GetDebitNameOfInvType = IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_NAME").Value), "", RsTemp.Fields("SUPP_CUST_NAME").Value)
            Else
                GetDebitNameOfInvType = IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_CODE").Value), "", RsTemp.Fields("SUPP_CUST_CODE").Value)
            End If
        End If
        Exit Function
ErrPart:
        GetDebitNameOfInvType = ""
    End Function
    Public Function GetMrrRefNo(ByRef mMRRNo As Double) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetMrrRefNo = "F"
        If Val(CStr(mMRRNo)) = 0 Then Exit Function
        mSqlStr = " SELECT REF_TYPE " & vbCrLf & " FROM INV_GATE_HDR " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTO_KEY_MRR=" & mMRRNo & ""
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetMrrRefNo = IIf(IsDBNull(RsTemp.Fields("REF_TYPE").Value), "F", RsTemp.Fields("REF_TYPE").Value)
        End If
        Exit Function
ErrPart:
        GetMrrRefNo = "F"
    End Function
    Public Function GetBankSalary(ByRef mCode As String, ByRef mSalDate As String, pType As String, pIsCheckPurpose As String, pDeductType As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mTable As String
        Dim mOTTable As String
        GetBankSalary = 0

        If pIsCheckPurpose = "Y" Then
            mTable = "PAY_DUMMYACTUAL_SAL_TRN"            ''ACTUAL
            mOTTable = "PAY_MONTHLY_DUMMY_OT_TRN"
        Else
            mTable = "PAY_ACTUAL_SAL_TRN"          ''
            mOTTable = "PAY_MONTHLY_OT_TRN"
        End If


        'If lblShowType.Text = "D" Then
        '    mTable = IIf(cboShowSalary.SelectedIndex = 0, "PAY_DUMMYSAL_TRN", "PAY_DUMMYACTUAL_SAL_TRN")
        'Else
        '    mTable = IIf(cboShowSalary.SelectedIndex = 0, "PAY_SAL_TRN", "PAY_ACTUAL_SAL_TRN")
        'End If

        If pType = "S" Then
            mSqlStr = " SELECT PAYABLESALARY, PAYABLEAMOUNT AS AMOUNT,B.ADDDEDUCT " & vbCrLf _
                & " FROM " & mTable & " A, PAY_SALARYHEAD_MST B " & vbCrLf _
                & " WHERE " & vbCrLf & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(SAL_DATE,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
                & " AND A.COMPANY_CODE=B.COMPANY_CODE " & vbCrLf _
                & " And A.SALHEADCODE=B.CODE AND B.ADDDEDUCT IN (" & ConEarning & ") AND ISARREAR='N'"     ''," & ConDeduct & "

            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                GetBankSalary = IIf(IsDBNull(RsTemp.Fields("PAYABLESALARY").Value), 0, RsTemp.Fields("PAYABLESALARY").Value)
                Do While RsTemp.EOF = False
                    If RsTemp.Fields("ADDDEDUCT").Value = ConEarning Then
                        GetBankSalary = GetBankSalary + IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
                    Else
                        GetBankSalary = GetBankSalary - IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
                    End If

                    RsTemp.MoveNext()
                Loop
            End If
        End If

        'If pType = "O" Then
        If pDeductType = "ESI" Then
            mSqlStr = " SELECT SUM(ESIC_AMOUNT) AS AMOUNT " & vbCrLf _
                & " FROM " & mOTTable & " A " & vbCrLf _
                & " WHERE " & vbCrLf _
                & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(OT_DATE,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
                & " AND IS_ARREAR='N'"
        Else
            mSqlStr = " SELECT SUM(OT_AMOUNT) AS AMOUNT " & vbCrLf _
                & " FROM " & mOTTable & " A " & vbCrLf _
                & " WHERE " & vbCrLf _
                & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(OT_DATE,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
                & " AND IS_ARREAR='N'"
        End If
        'End If

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetBankSalary = GetBankSalary + IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
        End If

        Exit Function
ErrPart:
        GetBankSalary = 0
    End Function
    Public Function GetAttnAwardAmount(ByRef pSalHeadType As Long, ByRef mCode As String, ByRef mSalDate As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetAttnAwardAmount = 0

        mSqlStr = " SELECT SUM(AMOUNT) AS AMOUNT " & vbCrLf _
            & " FROM PAY_MONTHLY_TRN A, PAY_SALARYHEAD_MST B " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
            & " AND TO_CHAR(SAL_MONTH,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
            & " AND A.COMPANY_CODE=B.COMPANY_CODE " & vbCrLf _
            & " And A.ADD_DEDUCTCODE=B.CODE AND B.TYPE=" & pSalHeadType & " AND SAL_FLAG='S'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetAttnAwardAmount = IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
        End If
        Exit Function
ErrPart:
        GetAttnAwardAmount = 0
    End Function
    Public Function GetIncentive_Adj(ByRef mCode As String, ByRef mSalDate As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing


        GetIncentive_Adj = 0

        mSqlStr = " SELECT SUM(OT_AMOUNT) AS AMOUNT " & vbCrLf _
                & " FROM PAY_OVERTIME_ADJ_MST A" & vbCrLf _
                & " WHERE " & vbCrLf _
                & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(OT_DATE,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') "


        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetIncentive_Adj = IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
        End If
        Exit Function
ErrPart:
        GetIncentive_Adj = 0
    End Function
    Public Function GetAttnAwardAmount_Adj(ByRef pAddDecutCode As Integer, ByRef mCode As String, ByRef mSalDate As String, pType As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xTypeCode As Integer

        GetAttnAwardAmount_Adj = 0

        xTypeCode = pAddDecutCode

        If pType = "S" Then
            If pAddDecutCode = -1 Then
                mSqlStr = " SELECT CODE,TYPE FROM PAY_SALARYHEAD_MST" & vbCrLf _
                & " WHERE  COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND TYPE = " & Val(ConAttendanceAllw) & ""

                MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

                If RsTemp.EOF = False Then
                    xTypeCode = RsTemp.Fields("Code").Value
                End If
            Else
            End If

            mSqlStr = " SELECT SUM(AMOUNT) AS AMOUNT " & vbCrLf _
                & " FROM PAY_MONTHLY_AA_TRN A, PAY_SALARYHEAD_MST B " & vbCrLf _
                & " WHERE " & vbCrLf _
                & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(SAL_MONTH,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
                & " AND A.COMPANY_CODE=B.COMPANY_CODE " & vbCrLf _
                & " And A.ADD_DEDUCTCODE=B.CODE AND B.CODE=" & xTypeCode & " AND SAL_FLAG='" & pType & "'"


        Else
            xTypeCode = -1

            mSqlStr = " SELECT SUM(AMOUNT) AS AMOUNT " & vbCrLf _
                & " FROM PAY_MONTHLY_AA_TRN A " & vbCrLf _
                & " WHERE " & vbCrLf _
                & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
                & " AND TO_CHAR(SAL_MONTH,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
                & " AND A.ADD_DEDUCTCODE=" & xTypeCode & " AND SAL_FLAG='" & pType & "'"


        End If


        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetAttnAwardAmount_Adj = IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
        End If
        Exit Function
ErrPart:
        GetAttnAwardAmount_Adj = 0
    End Function
    Public Function GetForm1Amount(ByRef pSalHeadType As Long, ByRef mCode As String, ByRef mSalDate As String) As Double
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetForm1Amount = 0


        mSqlStr = " SELECT SUM(PAYABLEAMOUNT) AS AMOUNT " & vbCrLf _
            & " FROM PAY_SAL_TRN A, PAY_SALARYHEAD_MST B " & vbCrLf _
            & " WHERE " & vbCrLf & " A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND A.EMP_CODE='" & mCode & "'" & vbCrLf _
            & " AND TO_CHAR(SAL_DATE,'MMYYYY')=TO_CHAR('" & VB6.Format(mSalDate, "MMYYYY") & "') " & vbCrLf _
            & " AND A.COMPANY_CODE=B.COMPANY_CODE " & vbCrLf _
            & " And A.SALHEADCODE=B.CODE AND B.TYPE=" & pSalHeadType & " AND ISARREAR='N'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetForm1Amount = IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), 0, RsTemp.Fields("AMOUNT").Value)
        End If
        Exit Function
ErrPart:
        GetForm1Amount = 0
    End Function
    Public Function BillPayAmount(ByRef mAccountCode As String, ByRef mBillNo As String, ByRef mVDate As String) As Double
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing '' Recordset
        Dim DAmount As Double
        Dim CAmount As Double
        SqlStr = " Select SUM(AMOUNT),DC " & vbCrLf & " FROM TRN " & vbCrLf & " WHERE " & vbCrLf & " And CompanyCode=" & RsCompany.Fields("CompanyCode").Value & " " & vbCrLf & " And FYNo=" & RsCompany.Fields("FYNO").Value & "" & vbCrLf & " And CBranchCode=" & RsCompany.Fields("CBranchCode").Value & "" & vbCrLf & " And AccountCode=" & mAccountCode & " " & vbCrLf & " And BillNo='" & mBillNo & "'" & vbCrLf & " AND BillDate=TO_DATE('" & VB6.Format(mVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') "
        SqlStr = SqlStr & vbCrLf & " GROUP BY DC"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If RS.EOF = False Then
            If RS.Fields("DC").Value = "D" Then
                DAmount = IIf(IsDBNull(RS.Fields(0).Value), 0, RS.Fields(0).Value)
            Else
                CAmount = IIf(IsDBNull(RS.Fields(0).Value), 0, RS.Fields(0).Value)
            End If
            BillPayAmount = DAmount - CAmount
        Else
            BillPayAmount = 0
        End If
        Exit Function
ERR1:
        MsgInformation(Err.Description)
        BillPayAmount = 0
    End Function
    Public Function GetMultiLineforBarcode(ByRef pString As String, ByRef mLineCount As Integer, ByRef pWidth As Integer, ByRef pStartCol As Integer) As String
        On Error GoTo ErrPart
        Dim pCr As String
        Dim pCrlf As String
        Dim l As Integer
        Dim s As Integer
        Dim c As Integer
        Dim mTemp As String = ""
        Dim DoneOnce As Boolean
        Dim pNextLine As String = ""
        pWidth = pWidth - 1 ''+ 1
        pString = Trim(pString)
        pCr = Chr(13)
        pCrlf = Chr(13) & Chr(10)
        Do
            l = Len(pNextLine)
            s = InStr(pString, " ")
            c = InStr(pString, pCr)
            If c Then
                If l + c <= pWidth Then
                    mTemp = mTemp & pNextLine & VB.Left(pString, c)
                    pNextLine = ""
                    pString = Mid(pString, c + 1)
                    GoTo LoopHere
                End If
            End If
            If s Then
                If l + s <= pWidth Then
                    DoneOnce = True
                    pNextLine = pNextLine & VB.Left(pString, s)
                    pString = Mid(pString, s + 1)
                ElseIf s > pWidth Then
                    mTemp = mTemp & vbCrLf & New String(" ", pStartCol - 1) & VB.Left(pString, pWidth)
                    pString = Mid(pString, pWidth + 1)
                    mLineCount = mLineCount + 1
                Else
                    mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1)
                    pNextLine = ""
                    mLineCount = mLineCount + 1
                End If
            Else
                If l Then
                    If l + Len(pString) > pWidth Then
                        If Len(pString) > pWidth Then
                            mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1) & pString & vbCrLf
                        Else
                            mTemp = mTemp & pNextLine & vbCrLf & New String(" ", pStartCol - 1) & pString
                        End If
                        mLineCount = mLineCount + 1
                    Else
                        mTemp = mTemp & pNextLine & pString ''& vbCrLf & String(pStartCol - 1, " ")
                    End If
                Else
                    mTemp = mTemp & pString ''& vbCrLf & String(pStartCol - 1, " ")
                End If
                Exit Do
            End If
LoopHere:
        Loop
        GetMultiLineforBarcode = mTemp
        Exit Function
ErrPart:
        MsgBox(Err.Description)
        GetMultiLineforBarcode = ""
        '' Resume
    End Function
    Public Function GetMRRQty(ByRef pItemCode As String, ByRef pDateFrom As String, ByRef pDateTo As String, ByRef pPackUnit As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim mChildBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim mTableName As String
        Dim mChildItemCode As String
        Dim pStockType As String
        Dim pStock_ID As String
        pStockType = "ST"
        '"STR"
        pStock_ID = "WH"
        SqlStr = " SELECT ITEM_CODE FROM INV_ITEM_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND IS_CHILD='Y'" & vbCrLf & " AND PARENT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        'If RsTemp.EOF = False Then
        'Do While RsTemp.EOF = False
        'If mChildItemCode = "" Then
        'mChildItemCode = "'" & Trim(IIf(IsNull(RsTemp!ITEM_CODE), "", RsTemp!ITEM_CODE)) & "'"
        'Else
        'mChildItemCode = mChildItemCode & ",'" & Trim(IIf(IsNull(RsTemp!ITEM_CODE), "", RsTemp!ITEM_CODE)) & "'"
        'End If
        'RsTemp.MoveNext
        'Loop
        'mChildItemCode = "('" & pItemCode & "'," & mChildItemCode & ")"
        'Else
        'mChildItemCode = ""
        'End If
        mChildBalQty = 0
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mChildItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value))
                mChildBalQty = mChildBalQty + GetBalanceStockQty(mChildItemCode, pDateTo, pPackUnit, "STR", pStockType, "", pStock_ID, -1)
                RsTemp.MoveNext()
            Loop
        Else
            mChildBalQty = 0
        End If
        SqlStr = ""
        SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable
        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND REF_TYPE = 'MRR'"
        'If mChildItemCode = "" Then
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE IN " & mChildItemCode & ""
        'End If
        SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='ST' AND E_DATE>=TO_DATE('" & VB6.Format(pDateFrom, "dd-mmm-yyyy") & "','DD-MON-YYYY') AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetMRRQty = mBalQty + mChildBalQty
        Exit Function
ErrPart:
        GetMRRQty = 0
    End Function
    Public Function CheckValidStockType(ByRef pRow As Integer, ByRef pStockTypeCol As Integer, ByRef pItemCodeCol As Integer, ByRef pSprd As AxFPSpreadADO.AxfpSpread) As Boolean
        On Error GoTo ChkERR
        Dim mStockType As String
        Dim mItemCode As String
        Dim mCategoryCode As String
        Dim mCheckStockType As String
        CheckValidStockType = False
        With pSprd
            .Row = pRow
            .Col = pItemCodeCol
            mItemCode = Trim(.Text)
            If mItemCode = "" Then
                CheckValidStockType = True
                Exit Function
            End If
            .Col = pStockTypeCol
            mCheckStockType = Trim(.Text)
            If mCheckStockType = "" Then
                CheckValidStockType = True
                Exit Function
            End If
            If mCheckStockType = "SC" Or mCheckStockType = "FC" Or mCheckStockType = "QC" Then
                CheckValidStockType = True
                Exit Function
            End If
            If MainClass.ValidateWithMasterTable(mItemCode, "ITEM_CODE", "CATEGORY_CODE", "INV_ITEM_MST", PubDBCn, MasterNo, , "Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                mCategoryCode = MasterNo
            Else
                CheckValidStockType = False
                Exit Function
            End If
            If MainClass.ValidateWithMasterTable(mCategoryCode, "GEN_CODE", "STOCKTYPE", "INV_GENERAL_MST", PubDBCn, MasterNo, , "Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " AND GEN_TYPE='C'") = True Then
                mStockType = MasterNo
                If mStockType = mCheckStockType Then
                    CheckValidStockType = True
                    Exit Function
                Else
                    If Trim(mStockType) = "FG" Then
                        If mCheckStockType = "CR" Or mCheckStockType = "WP" Then
                            CheckValidStockType = True
                            Exit Function
                        Else
                            CheckValidStockType = False
                            Exit Function
                        End If
                    ElseIf Trim(mStockType) = "ST" Then
                        If mCheckStockType = "RJ" Then
                            CheckValidStockType = True
                            Exit Function
                        Else
                            CheckValidStockType = False
                            Exit Function
                        End If
                    End If
                End If
            Else
                CheckValidStockType = False
                Exit Function
            End If
        End With
        Exit Function
ChkERR:
        MsgBox(Err.Description)
    End Function
    Public Function FinalOperation(ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pOPRCode As String, ByRef pDate As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSeq As Integer
        Dim mMaxSeq As Integer
        If pOPRCode = "" Then
            FinalOperation = True
            Exit Function
        End If
        mSeq = 0
        mMaxSeq = 0
        SqlStr = ""
        SqlStr = OperationQuery(Trim(pItemCode), Trim(pDeptCode), Trim(pOPRCode), "", Trim(pDate), "OPR_SNO")
        'SqlStr = "SELECT OPR_SNO " & vbCrLf _
        ''& " FROM PRD_OPR_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
        ''& " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf _
        ''& " AND OPR_CODE='" & MainClass.AllowSingleQuote(pOPRCode) & "'" & vbCrLf _
        ''& " AND WEF = (" & vbCrLf _
        ''& " SELECT MAX(WEF) FROM PRD_OPR_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
        ''& " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        '
        'If pDate <> "" Then
        'SqlStr = SqlStr & vbCrLf & " AND WEF<='" & vb6.Format(pDate, "DD-MMM-YYYY") & "'"
        'End If
        '
        'SqlStr = SqlStr & vbCrLf & ")"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSeq = IIf(IsDBNull(RsTemp.Fields("OPR_SNO").Value), 0, RsTemp.Fields("OPR_SNO").Value)
        Else
            mSeq = 0
        End If
        SqlStr = ""
        SqlStr = "SELECT MAX(OPR_SNO) AS OPR_SNO " & vbCrLf & " FROM PRD_OPR_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) FROM PRD_OPR_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        If pDate <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If
        SqlStr = SqlStr & vbCrLf & ")"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mMaxSeq = IIf(IsDBNull(RsTemp.Fields("OPR_SNO").Value), 0, RsTemp.Fields("OPR_SNO").Value)
        Else
            mMaxSeq = 0
        End If
        If mSeq = mMaxSeq Then
            FinalOperation = True
        Else
            FinalOperation = False
        End If
        Exit Function
ErrPart:
        FinalOperation = False
    End Function
    Public Function GetIsOptionalOPR(ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pOPRSNO As String, ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If Val(pOPRSNO) = 0 Then
            GetIsOptionalOPR = "N"
            Exit Function
        End If
        SqlStr = ""
        SqlStr = OperationQuery(Trim(pItemCode), Trim(pDeptCode), "", "", Trim(pDate), "ISOPTIONAL")
        SqlStr = SqlStr & vbCrLf & " AND OPR_SNO=" & Val(pOPRSNO) & ""
        'SqlStr = "SELECT ISOPTIONAL " & vbCrLf _
        ''& " FROM PRD_OPR_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
        ''& " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf _
        ''& " AND OPR_SNO=" & Val(pOPRSNO) & "" & vbCrLf _
        ''& " AND WEF = (" & vbCrLf _
        ''& " SELECT MAX(WEF) FROM PRD_OPR_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
        ''& " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        '
        'If pDate <> "" Then
        'SqlStr = SqlStr & vbCrLf & " AND WEF<='" & vb6.Format(pDate, "DD-MMM-YYYY") & "'"
        'End If
        '
        'SqlStr = SqlStr & vbCrLf & ")"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetIsOptionalOPR = IIf(IsDBNull(RsTemp.Fields("ISOPTIONAL").Value), "N", RsTemp.Fields("ISOPTIONAL").Value)
        Else
            GetIsOptionalOPR = "N"
        End If
        Exit Function
ErrPart:
        GetIsOptionalOPR = "N"
    End Function
    'Public Function DeleteOPRStockTRN(pDBCn As ADODB.Connection, pRefType As String, _
    ''pRefNo As String) As Boolean
    'On Error GoTo UpdateOPRStockTRNErr
    'Dim SqlStr As String=""
    '
    'SqlStr = "DELETE FROM PRD_OPR_STOCK_TRN " & vbCrLf _
    ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
    ''& " AND FYEAR=" & RsCompany.fields("FYEAR").value & "" & vbCrLf _
    ''& " AND REF_TYPE='" & pRefType & "'" & vbCrLf _
    ''& " AND REF_NO=" & Val(pRefNo) & ""
    'pDBCn.Execute SqlStr
    'DeleteOPRStockTRN = True
    'Exit Function
    'UpdateOPRStockTRNErr:
    'DeleteOPRStockTRN = False
    'If err.Description <> "" Then
    'MsgInformation err.Description
    'End If
    'End Function
    'Public Function DeleteOPRStockTRN(pDBCn As ADODB.Connection, pRefType As String, _
    ''pRefNo As String) As Boolean
    'On Error GoTo UpdateOPRStockTRNErr
    'Dim SqlStr As String=""
    '
    'SqlStr = "DELETE FROM PRD_OPR_STOCK_TRN " & vbCrLf _
    ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
    ''& " AND FYEAR=" & RsCompany.fields("FYEAR").value & "" & vbCrLf _
    ''& " AND REF_TYPE='" & pRefType & "'" & vbCrLf _
    ''& " AND REF_NO=" & Val(pRefNo) & ""
    'pDBCn.Execute SqlStr
    'DeleteOPRStockTRN = True
    'Exit Function
    'UpdateOPRStockTRNErr:
    'DeleteOPRStockTRN = False
    'If err.Description <> "" Then
    'MsgInformation err.Description
    'End If
    'End Function
    Public Function DeleteProdStockTRN(ByRef pDBCn As ADODB.Connection, ByRef pMType As String, ByRef pFromDeptCode As String, ByRef pToDeptCode As String, ByRef pFromSerialDate As String, ByRef pToSerialDate As String) As Boolean
        On Error GoTo DeleteProdStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = " DELETE PRD_STOCK_TRN " & vbCrLf & " WHERE COMPANY_CODE =" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND M_TYPE='" & pMType & "' "
        If Trim(pFromDeptCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND DEPT_CODE_FROM ='" & MainClass.AllowSingleQuote(pFromDeptCode) & "' "
        End If
        If Trim(pToDeptCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND DEPT_CODE_TO ='" & MainClass.AllowSingleQuote(pToDeptCode) & "' "
        End If
        If Trim(pToSerialDate) = "" Then
            SqlStr = SqlStr & vbCrLf & " AND EDATE =TO_DATE('" & VB6.Format(pFromSerialDate, "DD/MMM/YYYY") & "','DD-MON-YYYY') "
        Else
            SqlStr = SqlStr & vbCrLf & " AND EDATE >=TO_DATE('" & VB6.Format(pFromSerialDate, "DD/MMM/YYYY") & "','DD-MON-YYYY') " & vbCrLf & " AND EDATE <=TO_DATE('" & VB6.Format(pToSerialDate, "DD/MMM/YYYY") & "','DD-MON-YYYY') "
        End If
        pDBCn.Execute(SqlStr)
        DeleteProdStockTRN = True
        Exit Function
DeleteProdStockTRNErr:
        DeleteProdStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    '******REQ IF WE TRACK EVERY OPR OF SINGLE SHOP *************
    'Public Function UpdateOPRStockTRN(pDBCn As ADODB.Connection, pRefType As String, _
    ''pRefNo As String, pSerailNo As Long, pRefDate As String, _
    ''pStockType As String, pItemCode As String, pItemUOM As String, _
    ''pBatchNo As Double, pItemQty As Double, pRejQty As Double, pIO As String, _
    ''pPurchaseCost As Double, pLandedCost As Double, _
    ''pOperationCode As String, pNextOperationCode As String, _
    ''pDeptCodeTo As String, pDeptCodeFrom As String, pCCCode As String, _
    ''pCancelled As String, pDescription As String, pPartyCode As String, pStockID As String) As Boolean
    '
    'On Error GoTo UpdateOPRStockTRNErr
    'Dim SqlStr As String=""
    'Dim RsTemp As ADODB.Recordset = Nothing
    'Dim mIssueUOM As String
    'Dim mPurchaseUOM As String
    'Dim mFactor As Double
    'Dim xPurchaseCost As Double
    'Dim xLandedCost As Double
    'Dim mItemCost As Double
    '
    'If pCancelled = "Y" Then
    ' UpdateOPRStockTRN = True
    ' Exit Function
    'End If
    'mFactor = 1
    '
    'SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf _
    ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
    'MainClass.UOpenRecordSet SqlStr, pDBCn, adOpenStatic, RsTemp, adLockReadOnly
    '
    'If RsTemp.EOF = False Then
    'mIssueUOM = IIf(IsNull(RsTemp!ISSUE_UOM), "", RsTemp!ISSUE_UOM)
    'mPurchaseUOM = IIf(IsNull(RsTemp!PURCHASE_UOM), "", RsTemp!PURCHASE_UOM)
    'mFactor = IIf(IsNull(RsTemp!UOM_FACTOR) Or RsTemp!UOM_FACTOR = 0, 1, RsTemp!UOM_FACTOR)
    'mItemCost = IIf(IsNull(RsTemp!PURCHASE_COST), 0, RsTemp!PURCHASE_COST)
    'End If
    '
    'If pPurchaseCost = 0 Or pLandedCost = 0 Then
    'If GetLatestItemCost(pItemCode, xPurchaseCost, xLandedCost, pRefDate, pStockType, pPartyCode, pItemUOM, mFactor) = False Then GoTo UpdateOPRStockTRNErr
    'pPurchaseCost = IIf(xPurchaseCost = 0, mItemCost, xPurchaseCost)
    'pLandedCost = IIf(xLandedCost = 0, mItemCost, xLandedCost)
    'End If
    '
    'If pItemUOM = mPurchaseUOM Then
    'pItemUOM = mIssueUOM
    'pItemQty = pItemQty * mFactor
    'pRejQty = pRejQty * mFactor
    'pPurchaseCost = pPurchaseCost / mFactor
    'pLandedCost = pLandedCost / mFactor
    'mItemCost = mItemCost / mFactor
    'End If
    '
    '
    'If pItemQty > 0 Then
    'SqlStr = "INSERT INTO PRD_OPR_STOCK_TRN ( " & vbCrLf _
    ''& " COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf _
    ''& " REF_DATE, STOCK_TYPE, ITEM_CODE, " & vbCrLf _
    ''& " ITEM_UOM, BATCH_NO, ITEM_QTY, " & vbCrLf _
    ''& " ITEM_IO, PURCHASE_COST, LANDED_COST, " & vbCrLf _
    ''& " OPR_CODE, NEXT_OPR_CODE, DEPT_CODE_TO, " & vbCrLf _
    ''& " DEPT_CODE_FROM, CC_CODE,REMARKS, PARTYCODE ) VALUES ( " & vbCrLf _
    ''& " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
    ''& " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf _
    ''& " TO_DATE('" & vb6.Format(pRefDate, "DD-MMM-YYYY") & "'), " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pStockType) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pItemUOM) & "', " & Val(pBatchNo) & ", " & vbCrLf _
    ''& " " & Val(pItemQty) & ",'" & pIO & "', " & vbCrLf _
    ''& " " & Val(pPurchaseCost) & "," & Val(pLandedCost) & "," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pOperationCode) & "', '" & MainClass.AllowSingleQuote(pNextOperationCode) & "', " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pDeptCodeTo) & "', '" & MainClass.AllowSingleQuote(pDeptCodeFrom) & "', " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pCCCode) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pDescription) & "', " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pPartyCode) & "')"
    '
    'pDBCn.Execute SqlStr
    'End If
    '
    'If pRejQty > 0 Then
    'pStockType = "RJ"
    '
    'SqlStr = "INSERT INTO PRD_OPR_STOCK_TRN ( " & vbCrLf _
    ''& " COMPANY_CODE, FYEAR, SERIAL_NO, REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf _
    ''& " REF_DATE, STOCK_TYPE, ITEM_CODE, " & vbCrLf _
    ''& " ITEM_UOM, BATCH_NO, ITEM_QTY, " & vbCrLf _
    ''& " ITEM_IO, PURCHASE_COST, LANDED_COST, " & vbCrLf _
    ''& " OPR_CODE, NEXT_OPR_CODE, DEPT_CODE_TO, " & vbCrLf _
    ''& " DEPT_CODE_FROM, CC_CODE,REMARKS, PARTYCODE) VALUES ( " & vbCrLf _
    ''& " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf _
    ''& " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf _
    ''& " TO_DATE('" & vb6.Format(pRefDate, "DD-MMM-YYYY") & "'), " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pStockType) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pItemUOM) & "', " & Val(pBatchNo) & ", " & vbCrLf _
    ''& " " & Val(pRejQty) & ",'" & pIO & "', " & vbCrLf _
    ''& " " & Val(pPurchaseCost) & "," & Val(pLandedCost) & "," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pOperationCode) & "', '" & MainClass.AllowSingleQuote(pNextOperationCode) & "', " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pDeptCodeTo) & "', '" & MainClass.AllowSingleQuote(pDeptCodeFrom) & "', " & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pCCCode) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pDescription) & "'," & vbCrLf _
    ''& " '" & MainClass.AllowSingleQuote(pPartyCode) & "')"
    '
    'pDBCn.Execute SqlStr
    'End If
    '
    'UpdateOPRStockTRN = True
    'Exit Function
    'UpdateOPRStockTRNErr:
    'UpdateOPRStockTRN = False
    'If err.Description <> "" Then
    'MsgInformation err.Description
    'End If
    'End Function
    Public Function GetBillRate(ByRef pVNo As String, ByRef pVDate As String, ByRef pItemCode As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If pVNo = "" Then Exit Function
        SqlStr = ""
        SqlStr = " SELECT NVL(ITEM_RATE,0) AS ITEM_RATE " & vbCrLf & " FROM FIN_PURCHASE_HDR PH, FIN_PURCHASE_DET PD " & vbCrLf & " Where PH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PH.FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND PH.mKEY=PD.mKEY" & vbCrLf & " AND PH.VNO='" & pVNo & "'" & vbCrLf & " AND PD.ITEM_CODE='" & Trim(pItemCode) & "'"
        ''& " AND PH.VDate=TO_DATE('" & vb6.Format(pVDate, "DD-MMM-YYYY") & "')" & vbCrLf _
        '
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetBillRate = Val(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value))
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetBillRate = 0
    End Function
    Public Function GetPANWiseTurnOver(ByRef pPubDBCn As ADODB.Connection, ByRef pSupplierName As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mPANNo As String

        GetPANWiseTurnOver = 0
        SqlStr = ""
        '        Select Case SUM(ITEMVALUE),'A' from FIN_PURCHASE_HDR
        'UNION ALL
        'Select Case SUM(ITEMVALUE),'B' FROM FIN_SUPP_PURCHASE_HDR
        'UNION ALL
        'Select Case SUM(ITEMVALUE),'C' FROM FIN_DNCN_HDR

        If MainClass.ValidateWithMasterTable(pSupplierName, "SUPP_CUST_NAME", "PAN_NO", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND INTER_UNIT='N'") = True Then
            mPANNo = MasterNo
        Else
            mPANNo = ""
            Exit Function
        End If

        'If MainClass.ValidateWithMasterTable(pSupplierName, "SUPP_CUST_NAME", "INTER_UNIT", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND INTER_UNIT='N'") = True Then
        '    Exit Function
        'End If

        If Trim(mPANNo) = "" Or Len(mPANNo) <> 10 Then
            Exit Function
        End If

        SqlStr = " SELECT NVL(SUM(ITEMVALUE),0) AS ITEM_RATE , 'A' " & vbCrLf _
                & " FROM FIN_PURCHASE_HDR A, FIN_SUPP_CUST_MST B" & vbCrLf _
                & " Where A.FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
                & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                & " AND A.SUPP_CUST_CODE=B.SUPP_CUST_CODE" & vbCrLf _
                & " AND B.PAN_NO='" & mPANNo & "' AND CANCELLED='N'"

        SqlStr = SqlStr & vbCrLf & " UNION ALL"

        SqlStr = SqlStr & vbCrLf & " SELECT NVL(SUM(ITEMVALUE),0) AS ITEM_RATE , 'B' " & vbCrLf _
                & " FROM FIN_SUPP_PURCHASE_HDR A, FIN_SUPP_CUST_MST B" & vbCrLf _
                & " Where A.FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
                & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                & " AND A.SUPP_CUST_CODE=B.SUPP_CUST_CODE" & vbCrLf _
                & " AND B.PAN_NO='" & mPANNo & "'  AND CANCELLED='N'"

        SqlStr = SqlStr & vbCrLf & " UNION ALL"

        SqlStr = SqlStr & vbCrLf & " SELECT NVL(SUM(ITEMVALUE * DECODE(BOOKCODE, -4, -1,1)),0) AS ITEM_RATE , 'C' " & vbCrLf _
                & " FROM FIN_DNCN_HDR A, FIN_SUPP_CUST_MST B" & vbCrLf _
                & " Where A.FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
                & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                & " AND DECODE(BOOKCODE, -4, A.DEBITACCOUNTCODE, A.CREDITACCOUNTCODE)=B.SUPP_CUST_CODE" & vbCrLf _
                & " AND B.PAN_NO='" & mPANNo & "'  AND CANCELLED='N' AND APPROVED='Y'"

        ''& " AND PH.VDate=TO_DATE('" & vb6.Format(pVDate, "DD-MMM-YYYY") & "')" & vbCrLf _
        '
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        GetPANWiseTurnOver = 0
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                GetPANWiseTurnOver = GetPANWiseTurnOver + Val(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value))
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetPANWiseTurnOver = 0
    End Function



    Public Function GetLandedCost(ByRef mMainItemCode As String, ByRef pItemUOM As String, ByRef pQty As Double, ByRef pToDate As String, ByRef mFactor As Double, ByRef pCostType As String, ByRef mPurchaseQty As Double, ByRef mShowType As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xFromDate As String = ""
        Dim xToDate As String = ""
        Dim mRunningBal As Double
        Dim mApprovedQty As Double
        Dim mQtyValue As Double
        Dim mCalcQty As Double
        Dim pRefDate As String
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        'Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim xSaleCost As Double
        'Dim mCategory As String
        'Dim mStockType As String
        'Dim mItemPurchaseCost As Double
        'Dim mItemSalesCost As Double
        'Dim mMkey As String
        'Dim pINHouseRate As Double
        'Dim mMainItemCode As String

        GetLandedCost = 0
        If mShowType = "OP" Then
            xToDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, CDate(pToDate)))
        ElseIf mShowType = "CL" Then
            xToDate = pToDate
        Else
            xFromDate = RsCompany.Fields("Start_Date").Value
            xToDate = pToDate
        End If
        If mShowType = "OP" Or mShowType = "CL" Then
            SqlStr = "SELECT IH.MKEY, GH.AUTO_KEY_MRR, IH.VNO, GH.MRR_DATE, IH.ISMODVAT, IH.ISSTREFUND, " & vbCrLf & " ID.ITEM_UOM, (ID.ITEM_QTY - ID.SHORTAGE_QTY - ID.REJECTED_QTY) AS APPROVED_QTY, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISMODVAT='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS EDAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISSTREFUND='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTSTAMT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS STAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEXPAMT - (IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT+IH.TOTSTAMT+IH.SUR_VATCLAIMAMOUNT))*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS OTHERS, " & vbCrLf & " (SELECT (((NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE)" & vbCrLf & " FROM PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD " & vbCrLf & " WHERE PH.COMPANY_CODE = PD.COMPANY_CODE AND PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE" & vbCrLf & " AND PD.MKEY =(SELECT MAX(SPH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD" & vbCrLf & " WHERE SPH.MKEY = SPD.MKEY " & vbCrLf & " AND SPH.AUTO_KEY_PO = ID.CUST_REF_NO" & vbCrLf & " AND SPD.ITEM_CODE= ID.ITEM_CODE" & vbCrLf & " AND SPD.PO_WEF_DATE <= GH.MRR_DATE " & vbCrLf & " AND PO_STATUS='Y')) AS PORATE" & vbCrLf & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=GH.COMPANY_CODE" & vbCrLf & " AND IH.AUTO_KEY_MRR=GH.AUTO_KEY_MRR" & vbCrLf & " AND GH.REF_TYPE IN ('P')" & vbCrLf & " AND ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND GH.MRR_DATE<=TO_DATE('" & VB6.Format(xToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & " ORDER BY GH.MRR_DATE DESC, TO_NUMBER(SUBSTR(GH.AUTO_KEY_MRR,LENGTH(GH.AUTO_KEY_MRR)-5,4)) DESC,TO_NUMBER(SUBSTR(GH.AUTO_KEY_MRR,1,LENGTH(GH.AUTO_KEY_MRR)-6)) DESC"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mRunningBal = pQty
                Do While Not RsTemp.EOF
                    mApprovedQty = IIf(IsDBNull(RsTemp.Fields("APPROVED_QTY").Value), 0, RsTemp.Fields("APPROVED_QTY").Value)
                    'mMkey = IIf(IsNull(RsTemp!mKey), "-1", RsTemp!mKey)
                    If mApprovedQty <= 0 Then GoTo NextRec
                    pRefDate = IIf(IsDBNull(RsTemp.Fields("MRR_DATE").Value), "", RsTemp.Fields("MRR_DATE").Value)
                    xPurchaseCost = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value), "0.0000")) ''GetPurchasePORate(mMkey, pRefDate, mMainItemCode)''GetPurchasePORate(mMkey, pAsOnDate, mMainItemCode)
                    If xPurchaseCost = 0 Then GoTo NextRec ''xPurchaseCost = IIf(IsNull(RsTemp!ITEM_RATE), 0, RsTemp!ITEM_RATE)
                    If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                        mApprovedQty = mApprovedQty * mFactor
                        xPurchaseCost = xPurchaseCost / mFactor
                    End If
                    If mRunningBal <= mApprovedQty Then
                        mCalcQty = mRunningBal
                        mRunningBal = 0
                    ElseIf mRunningBal > mApprovedQty Then
                        mCalcQty = mApprovedQty
                        mRunningBal = mRunningBal - mApprovedQty
                    End If
                    If pCostType = "P" Then
                        mQtyValue = (mCalcQty * xPurchaseCost)
                    ElseIf pCostType = "L" Then
                        xLandedCost = xPurchaseCost
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("EDAMOUNT").Value), 0, RsTemp.Fields("EDAMOUNT").Value), "0.0000"))
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("STAMOUNT").Value), 0, RsTemp.Fields("STAMOUNT").Value), "0.0000"))
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("OTHERS").Value), 0, RsTemp.Fields("OTHERS").Value), "0.0000"))
                        mQtyValue = (mCalcQty * CDbl(VB6.Format(xLandedCost, "0.0000")))
                    End If
                    GetLandedCost = GetLandedCost + mQtyValue
                    If mRunningBal = 0 Then
                        Exit Do
                    End If
NextRec:
                    RsTemp.MoveNext()
                    If RsTemp.EOF = True Then
                        If mRunningBal > 0 Then
                            If pCostType = "P" Then
                                mQtyValue = (mRunningBal * xPurchaseCost)
                            Else
                                mQtyValue = (mRunningBal * xLandedCost)
                            End If
                            GetLandedCost = GetLandedCost + mQtyValue
                        End If
                    End If
                Loop
            End If
            mPurchaseQty = 0
        Else
            SqlStr = "SELECT " & vbCrLf & " ID.ITEM_UOM, (ID.ITEM_QTY - ID.SHORTAGE_QTY - ID.REJECTED_QTY) AS APPROVED_QTY, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISMODVAT='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS EDAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ISSTREFUND='Y' OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTSTAMT)*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS STAMOUNT, " & vbCrLf & " CASE WHEN IH.ITEMVALUE=0 OR ID.ITEM_QTY=0 THEN 0 ELSE ((IH.TOTEXPAMT - (IH.TOTEDAMOUNT+IH.ADEAMOUNT+IH.TOTEDUAMOUNT+IH.SHECAMOUNT+IH.TOTSTAMT+IH.SUR_VATCLAIMAMOUNT))*ID.ITEM_AMT/IH.ITEMVALUE)/ID.ITEM_QTY END AS OTHERS, " & vbCrLf & " (SELECT (((NVL(ITEM_PRICE,0) - ROUND((NVL(ITEM_PRICE,0) * ITEM_DIS_PER)/100,4))) * EXCHANGERATE)" & vbCrLf & " FROM PUR_PURCHASE_HDR PH, PUR_PURCHASE_DET PD " & vbCrLf & " WHERE PH.COMPANY_CODE = PD.COMPANY_CODE AND PH.MKEY = PD.MKEY And PD.ITEM_CODE = ID.ITEM_CODE" & vbCrLf & " AND PD.MKEY =(SELECT MAX(SPH.MKEY) " & vbCrLf & " FROM PUR_PURCHASE_HDR SPH, PUR_PURCHASE_DET SPD" & vbCrLf & " WHERE SPH.MKEY = SPD.MKEY " & vbCrLf & " AND SPH.AUTO_KEY_PO = ID.CUST_REF_NO" & vbCrLf & " AND SPD.ITEM_CODE= ID.ITEM_CODE" & vbCrLf & " AND SPD.PO_WEF_DATE <= GH.MRR_DATE " & vbCrLf & " AND PO_STATUS='Y')) AS PORATE" & vbCrLf & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, INV_GATE_HDR GH" & vbCrLf & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=GH.COMPANY_CODE" & vbCrLf & " AND IH.AUTO_KEY_MRR=GH.AUTO_KEY_MRR" & vbCrLf & " AND GH.REF_TYPE IN ('P')" & vbCrLf & " AND ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND GH.MRR_DATE>=TO_DATE('" & VB6.Format(xFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND GH.MRR_DATE<=TO_DATE('" & VB6.Format(xToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                Do While Not RsTemp.EOF
                    mApprovedQty = IIf(IsDBNull(RsTemp.Fields("APPROVED_QTY").Value), 0, RsTemp.Fields("APPROVED_QTY").Value)
                    xPurchaseCost = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("PORATE").Value), 0, RsTemp.Fields("PORATE").Value), "0.0000")) ''GetPurchasePORate(mMkey, pRefDate, mMainItemCode)''GetPurchasePORate(mMkey, pAsOnDate, mMainItemCode)
                    If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                        mApprovedQty = mApprovedQty * mFactor
                        xPurchaseCost = xPurchaseCost / mFactor
                    End If
                    mPurchaseQty = mPurchaseQty + mApprovedQty
                    If pCostType = "P" Then
                        mQtyValue = (mApprovedQty * xPurchaseCost)
                    ElseIf pCostType = "L" Then
                        xLandedCost = xPurchaseCost
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("EDAMOUNT").Value), 0, RsTemp.Fields("EDAMOUNT").Value), "0.0000"))
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("STAMOUNT").Value), 0, RsTemp.Fields("STAMOUNT").Value), "0.0000"))
                        xLandedCost = xLandedCost + CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("OTHERS").Value), 0, RsTemp.Fields("OTHERS").Value), "0.0000"))
                        mQtyValue = (mApprovedQty * CDbl(VB6.Format(xLandedCost, "0.0000")))
                    End If
                    GetLandedCost = GetLandedCost + mQtyValue
                    RsTemp.MoveNext()
                Loop
            End If
            SqlStr = "SELECT ITEM_QTY, ITEM_RATE, ITEM_UOM" & vbCrLf & " FROM FIN_INVOICE_HDR IH, FIN_INVOICE_DET ID" & vbCrLf & " WHERE IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.MKEY=ID.MKEY" & vbCrLf & " AND ID.ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND IH.INVOICE_DATE>=TO_DATE('" & VB6.Format(xFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND IH.INVOICE_DATE<=TO_DATE('" & VB6.Format(xToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND CANCELLED='N'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                Do While Not RsTemp.EOF
                    mApprovedQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                    xPurchaseCost = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value), "0.0000")) ''GetPurchasePORate(mMkey, pRefDate, mMainItemCode)''GetPurchasePORate(mMkey, pAsOnDate, mMainItemCode)
                    If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                        mApprovedQty = mApprovedQty * mFactor
                        xPurchaseCost = xPurchaseCost / mFactor
                    End If
                    mQtyValue = (mApprovedQty * xPurchaseCost)
                    mPurchaseQty = mPurchaseQty - mApprovedQty
                    GetLandedCost = GetLandedCost - mQtyValue
                    RsTemp.MoveNext()
                Loop
            End If
        End If
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCustomerCostingItemRate(ByRef xCustomerCode As String, ByRef xProductCode As String, ByRef xItemCode As String, ByRef xUOM As String, ByRef xDateAsOn As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mSqlStrRM As String
        Dim mSqlStrBOP As String
        Dim mSqlStrPNT As String
        Dim SqlCond As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim mMainItemCode As String
        GetCustomerCostingItemRate = 0
        If Trim(xCustomerCode) = "" Or Trim(xProductCode) = "" Or Trim(xItemCode) = "" Then
            Exit Function
        End If
        mMainItemCode = GetMainItemCode(xProductCode)
        mFactor = 1
        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST,ITEM_STD_COST,CATEGORY_CODE FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(xItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_UOM").Value), "", RsTemp1.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
        End If

        mSqlStrRM = " SELECT ID.TOT_AMOUNT ITEM_RATE FROM PRD_CUST_FG_COST_HDR IH, PRD_CUST_FG_COST_RM_DET ID"
        mSqlStrBOP = " SELECT ID.ITEM_RATE FROM PRD_CUST_FG_COST_HDR IH, PRD_CUST_FG_COST_BOP_DET ID "
        mSqlStrPNT = " SELECT ID.ITEM_RATE FROM PRD_CUST_FG_COST_HDR IH, PRD_CUST_FG_COST_PNT_DET ID"

        ''WHERE CLAUSE...
        SqlCond = " WHERE IH.COMPANY_CODE =" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(xCustomerCode) & "'" & vbCrLf _
            & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(xProductCode) & "'" & vbCrLf _
            & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(xItemCode) & "'"

        SqlCond = SqlCond & vbCrLf _
            & " AND IH.MKEY = (SELECT MAX(MKEY) FROM PRD_CUST_FG_COST_HDR A" & vbCrLf _
            & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND A.SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(xCustomerCode) & "'" & vbCrLf _
            & " AND A.PRODUCT_CODE='" & MainClass.AllowSingleQuote(xProductCode) & "'" & vbCrLf _
            & " AND A.WEF <= TO_DATE('" & VB6.Format(xDateAsOn, "DD/MMM/YYYY") & "','DD-MON-YYYY')) "

        'SqlStr = mSqlStrRM & vbCrLf _
        '    & SqlCond & vbCrLf _
        '    & " UNION " & 

        SqlStr = mSqlStrBOP & vbCrLf _
            & SqlCond & vbCrLf _
            & " UNION " & mSqlStrPNT & vbCrLf _
            & SqlCond

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetCustomerCostingItemRate = IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value)
        End If
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckInHouseBOP(ByRef pItemCode As String, ByRef pAsOnDate As String, ByRef pTotClosing As Double, ByRef pINHouseRate As Double) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mRMCode As String
        Dim mStdQty As Double
        Dim mRMClosing As Double
        Dim mDept As String
        Dim mRate As Double
        Dim xItemUOM As String
        Dim xTotRMClosing As Double
        SqlStr = "SELECT ID.RM_CODE, (ID.STD_QTY - ID.GROSS_WT_SCRAP) STD_QTY, INVMST.ISSUE_UOM " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID, INV_ITEM_MST INVMST" & vbCrLf & " WHERE IH.MKEY=ID.MKEY AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.COMPANY_CODE=INVMST.COMPANY_CODE AND ID.RM_CODE=INVMST.ITEM_CODE" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND IH.WEF= ( " & vbCrLf & " SELECT MAX(SH.WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR SH" & vbCrLf & " WHERE " & vbCrLf & " SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND SH.WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        SqlStr = SqlStr & vbCrLf & " ORDER BY ID.SUBROWNO"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mDept = GetProductFinalDept(pItemCode, pAsOnDate)
            SqlStr = "SELECT SUM(PROD_QTY) PROD_QTY" & vbCrLf & " FROM PRD_PMEMODEPT_HDR IH, PRD_PMEMODEPT_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND ID.DEPT_CODE='" & MainClass.AllowSingleQuote(mDept) & "'" & vbCrLf & " AND TO_CHAR(IH.REF_DATE,'YYYYMM')= '" & VB6.Format(pAsOnDate, "YYYYMM") & "')"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp1.EOF = False Then
                mRMClosing = IIf(RsTemp1.Fields("PROD_QTY").Value, 0, RsTemp1.Fields("PROD_QTY").Value)
                If mRMClosing <= pTotClosing Then
                    pTotClosing = pTotClosing - mRMClosing
                Else
                    pTotClosing = 0
                End If
            Else
                CheckInHouseBOP = True
                Exit Function
            End If
            Do While RsTemp.EOF = False
                xItemUOM = IIf(RsTemp.Fields("ISSUE_UOM").Value, "", RsTemp.Fields("ISSUE_UOM").Value)
                mStdQty = mRMClosing * IIf(RsTemp.Fields("STD_QTY").Value, 0, RsTemp.Fields("STD_QTY").Value)
                If xItemUOM = "KGS" Then
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "TON" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "MT" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                End If
                mRMCode = IIf(RsTemp.Fields("RM_CODE").Value, "", RsTemp.Fields("RM_CODE").Value)
                mRate = GetLatestItemCostFromMRR(mRMCode, xItemUOM, mStdQty, pAsOnDate, "L")
                pINHouseRate = pINHouseRate + mRate
                RsTemp.MoveNext()
            Loop
        End If
        CheckInHouseBOP = True
        Exit Function
ErrPart:
        'Resume
        CheckInHouseBOP = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetMaterialCostFromBOM(ByRef pItemCode As String, ByRef pStockType As String, ByRef pStockDeptCode As String, ByRef pAsOnDate As String, ByRef pCostType As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBOM As ADODB.Recordset = Nothing
        Dim mBOMDeptCode As String
        Dim mRMCode As String
        Dim xItemUOM As String
        Dim mDeptSeq As Integer
        Dim mStdQty As Double
        Dim mProdDeptSeq As Integer
        Dim mProdCost As Double
        Dim mOPRCode As String
        Dim mOprSeq As Integer
        GetMaterialCostFromBOM = 0
        xItemUOM = ""
        mProdDeptSeq = GetProductSeqNo(pItemCode, pStockDeptCode, pAsOnDate)
        If pStockType = "WP" Then
            mProdDeptSeq = mProdDeptSeq - 1
            pStockType = "ST"
        End If
        SqlStr = "SELECT ID.RM_CODE, ID.DEPT_CODE, OPR_CODE,(STD_QTY + GROSS_WT_SCRAP) STD_QTY " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBOM, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBOM.EOF = False Then
            Do While RsBOM.EOF = False
                mBOMDeptCode = IIf(IsDBNull(RsBOM.Fields("DEPT_CODE").Value), "", RsBOM.Fields("DEPT_CODE").Value)
                mStdQty = IIf(IsDBNull(RsBOM.Fields("STD_QTY").Value), 0, RsBOM.Fields("STD_QTY").Value)
                mDeptSeq = GetProductSeqNo(pItemCode, mBOMDeptCode, pAsOnDate)
                mRMCode = Trim(IIf(IsDBNull(RsBOM.Fields("RM_CODE").Value), "", RsBOM.Fields("RM_CODE").Value))
                mOPRCode = Trim(IIf(IsDBNull(RsBOM.Fields("OPR_CODE").Value), "", RsBOM.Fields("OPR_CODE").Value))
                mOprSeq = GetOperationSeq(pItemCode, mBOMDeptCode, mOPRCode, pAsOnDate)
                If MainClass.ValidateWithMasterTable(mRMCode, "ITEM_CODE", "ISSUE_UOM", "INV_ITEM_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                    xItemUOM = MasterNo
                End If
                If xItemUOM = "KGS" Then
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "TON" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                ElseIf xItemUOM = "MT" Then
                    mStdQty = mStdQty / 1000
                    mStdQty = mStdQty / 1000
                End If
                mProdCost = 0
                If mDeptSeq = mProdDeptSeq Then
                    If Val(pStockType) > 0 Then
                        If Val(CStr(mOprSeq)) <= Val(pStockType) Then
                            mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, 1, pAsOnDate, pCostType)
                        End If
                    Else
                        mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, 1, pAsOnDate, pCostType)
                    End If
                ElseIf mDeptSeq < mProdDeptSeq Then
                    mProdCost = GetLatestItemCostFromMRR(mRMCode, xItemUOM, 1, pAsOnDate, pCostType)
                End If
                GetMaterialCostFromBOM = GetMaterialCostFromBOM + (mProdCost * mStdQty)
                RsBOM.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        'Resume
        GetMaterialCostFromBOM = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetLatestItemCostForOW(ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pAsOnDate As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim xSaleCost As Double
        GetLatestItemCostForOW = 0
        mFactor = 1
        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_UOM").Value), "", RsTemp1.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
        End If
        SqlStr = "SELECT ID.ITEM_UOM, " & vbCrLf & " ID.ITEM_RATE AS ITEM_RATE" & vbCrLf & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, FIN_INVTYPE_MST INVMST" & vbCrLf & " WHERE IH.MKEY=ID.MKEY " & vbCrLf & " AND IH.COMPANY_CODE=INVMST.COMPANY_CODE" & vbCrLf & " AND IH.TRNTYPE=INVMST.CODE" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND IH.ISFOC='N' " & vbCrLf & " AND IH.CANCELLED='N' " & vbCrLf & " AND VNO<>'-1' " & vbCrLf & " AND IH.ISFINALPOST='Y' " & vbCrLf & " AND INVMST.CATEGORY='P' " & vbCrLf & " AND INVMST.ISSALEJW<>'Y' " & vbCrLf & " AND IH.MRRDATE=("
        SqlStr = SqlStr & vbCrLf & "SELECT MAX(IH.MRRDATE)" & vbCrLf & " FROM FIN_PURCHASE_HDR IH, FIN_PURCHASE_DET ID, FIN_INVTYPE_MST INVMST" & vbCrLf & " WHERE IH.MKEY=ID.MKEY " & vbCrLf & " AND IH.COMPANY_CODE=INVMST.COMPANY_CODE" & vbCrLf & " AND IH.TRNTYPE=INVMST.CODE" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.ITEM_CODE='" & pItemCode & "'" & vbCrLf & " AND IH.ISFOC='N' " & vbCrLf & " AND IH.CANCELLED='N' " & vbCrLf & " AND VNO<>'-1' " & vbCrLf & " AND IH.ISFINALPOST='Y' " & vbCrLf & " AND INVMST.CATEGORY='P' " & vbCrLf & " AND INVMST.ISSALEJW<>'Y' " & vbCrLf & " AND IH.MRRDATE<=TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        ''ORDER BY
        'SqlStr = SqlStr & vbCrLf & " ORDER BY IH.MRRDATE DESC"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            xPurchaseCost = IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value)
            If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                xPurchaseCost = xPurchaseCost / mFactor
            End If
        Else
            If GetLatestItemCostFromPO(pItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
        End If
        GetLatestItemCostForOW = xPurchaseCost
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetProductRelationCode(ByRef pItemCode As String, ByRef pSqlStr As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        pSqlStr = ""
        pSqlStr = " SELECT ITEM_CODE,ISSUE_UOM FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        pSqlStr = pSqlStr & vbCrLf & " UNION "
        pSqlStr = pSqlStr & vbCrLf & " SELECT REF_ITEM_CODE AS ITEM_CODE, ITEM_UOM AS ISSUE_UOM FROM INV_ITEM_RELATIONSHIP_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        GetProductRelationCode = True
        Exit Function
ErrPart:
        pSqlStr = ""
        GetProductRelationCode = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckQFRRequired(ByRef pItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mValue As String
        CheckQFRRequired = False
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT IS_QFR_REQ " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mValue = IIf(IsDBNull(RsTemp.Fields("IS_QFR_REQ").Value), "Y", RsTemp.Fields("IS_QFR_REQ").Value)
            CheckQFRRequired = IIf(mValue = "Y", True, False)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetItemCategory(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetItemCategory = ""
        If pItemCode = "" Then
            Exit Function
        End If
        mSqlStr = "SELECT CMST.GEN_DESC " & vbCrLf & " FROM INV_ITEM_MST IMST, INV_GENERAL_MST CMST" & vbCrLf & " WHERE IMST.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IMST.COMPANY_CODE=CMST.COMPANY_CODE " & vbCrLf & " AND IMST.CATEGORY_CODE=CMST.GEN_CODE " & vbCrLf & " AND CMST.GEN_TYPE='C'" & vbCrLf & " AND IMST.ITEM_CODE='" & pItemCode & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetItemCategory = IIf(IsDBNull(RsTemp.Fields("GEN_DESC").Value), "", RsTemp.Fields("GEN_DESC").Value)
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetDeclarationCode() As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDeclarationCode = ""
        mSqlStr = " SELECT CODE FROM FIN_STFORM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AGT_DECL='Y'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                If GetDeclarationCode = "" Then
                    GetDeclarationCode = IIf(IsDBNull(RsTemp.Fields("Code").Value), -1, RsTemp.Fields("Code").Value)
                Else
                    GetDeclarationCode = GetDeclarationCode & "," & IIf(IsDBNull(RsTemp.Fields("Code").Value), -1, RsTemp.Fields("Code").Value)
                End If
                RsTemp.MoveNext()
            Loop
            GetDeclarationCode = "(" & GetDeclarationCode & ")"
        End If
        Exit Function
ErrPart:
        GetDeclarationCode = ""
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetItemAccountCode(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = "SELECT" & vbCrLf & " TRN.ACCOUNT_CODE " & vbCrLf & " FROM FIN_PUR_POSTING_MST TRN, INV_ITEM_MST ITEM " & vbCrLf & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TRN.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND TRN.CATEGORY_CODE=ITEM.CATEGORY_CODE" & vbCrLf & " AND ITEM.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetItemAccountCode = IIf(IsDBNull(RsTemp.Fields("ACCOUNT_CODE").Value), "-1", RsTemp.Fields("ACCOUNT_CODE").Value)
        Else
            GetItemAccountCode = "-1"
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetValidCustomerStoreLoc(ByRef pItemCode As String, ByRef pLocCode As String) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim xSuppCode As String
        Dim RsTemp As ADODB.Recordset = Nothing

        mSqlStr = " SELECT C.LOC_CODE, C.LOC_DESCRIPTION FROM INV_MODELWISE_PROD_DET A, GEN_MODEL_MST B, DSP_CUST_STORE_LOC_MST C" & vbCrLf _
                & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND A.COMPANY_CODE = B.COMPANY_CODE " & vbCrLf _
                & " AND A.MODEL_CODE = B.MODEL_CODE  " & vbCrLf _
                & " AND B.COMPANY_CODE = C.COMPANY_CODE " & vbCrLf _
                & " AND C.LOC_CODE = B.LOC_CODE  " & vbCrLf _
                & " AND A.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
                & " AND C.LOC_CODE='" & MainClass.AllowSingleQuote(pLocCode) & "'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetValidCustomerStoreLoc = True
        Else
            If MsgQuestion(pLocCode & " is not Valid Location for Item Code " & pItemCode & " Are youn want to continue...") = vbYes Then
                GetValidCustomerStoreLoc = True
                Exit Function
            Else
                GetValidCustomerStoreLoc = False
                Exit Function
            End If
        End If




        Exit Function
ErrPart:
        GetValidCustomerStoreLoc = False
    End Function
    Public Function GetItemType(ByRef pItemCode As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = "SELECT" & vbCrLf & " TRN.IS_RM " & vbCrLf & " FROM FIN_PUR_POSTING_MST TRN, INV_ITEM_MST ITEM " & vbCrLf & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TRN.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND TRN.CATEGORY_CODE=ITEM.CATEGORY_CODE" & vbCrLf & " AND ITEM.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetItemType = IIf(IsDBNull(RsTemp.Fields("IS_RM").Value), "N", RsTemp.Fields("IS_RM").Value)
        Else
            GetItemType = "N"
        End If
        GetItemType = IIf(GetItemType = "Y", "R", "O")
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetIsBreakApp(ByRef pInDateTime As Date, ByRef pOutDateTime As Date) As Boolean
        On Error GoTo ERR1
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mShiftInTime As String
        Dim mShiftOutTime As String
        Dim mBSTime As String
        Dim mBETime As String
        Dim mIsBreakApp As String

        GetIsBreakApp = True
        If pInDateTime = CDate("00:00:00") Then
            GetIsBreakApp = False
            Exit Function
        End If

        'GetIsBreakApp = True
        'Exit Function

        mSqlStr = " SELECT SHIFT_CODE, FROM_TIME, TO_TIME, " & vbCrLf _
            & " BS_TIME, BE_TIME, ROUND_CLOCK, BREAK_APP " & vbCrLf _
            & " FROM PAY_SHIFT_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " ORDER BY TO_CHAR(FROM_TIME,'HH24:MI') "

        'mSqlStr = mSqlStr & vbCrLf & " AND FROM_TIME>=TO_CHAR('" & vb6.Format(mInDateTime, "HH:mm") & "','HH24:MI')"
        'mSqlStr = mSqlStr & vbCrLf & " AND TO_TIME<=TO_CHAR('" & vb6.Format(mOutDateTime, "HH:mm") & "','HH24:MI')"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)

        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mShiftInTime = VB6.Format(IIf(IsDBNull(RsTemp.Fields("FROM_TIME").Value), "", RsTemp.Fields("FROM_TIME").Value), "HH:mm")
                mShiftOutTime = VB6.Format(IIf(IsDBNull(RsTemp.Fields("TO_TIME").Value), "", RsTemp.Fields("TO_TIME").Value), "HH:mm")
                mBSTime = VB6.Format(IIf(IsDBNull(RsTemp.Fields("BS_TIME").Value), "00:00", RsTemp.Fields("BS_TIME").Value), "HH:mm")
                If VB6.Format(pInDateTime, "HH:mm") = VB6.Format(mShiftInTime, "HH:mm") Or VB6.Format(pOutDateTime, "HH:mm") = VB6.Format(mShiftOutTime, "HH:mm") Then
                    mIsBreakApp = IIf(IsDBNull(RsTemp.Fields("BREAK_APP").Value), "N", RsTemp.Fields("BREAK_APP").Value)
                    GetIsBreakApp = IIf(mIsBreakApp = "Y", True, False)
                    'If mBSTime = "00:00" Then
                    '    GetIsBreakApp = False
                    'Else
                    '    GetIsBreakApp = True
                    'End If
                    Exit Function
                End If
                RsTemp.MoveNext()
            Loop
        End If
ExitPart:
        Exit Function
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetIsBreakApp = False
    End Function
    Public Function GetSamplePlan(ByRef pWEF As Date, ByRef pReceiptQty As Double) As Double
        On Error GoTo ERR1
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetSamplePlan = 0
        mSqlStr = " SELECT MINLIMIT, MAXLIMIT, DIM_CHECK " & vbCrLf & " FROM QAL_SAMPLE_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEFDATE = (" & vbCrLf & " SELECT MAX(WEFDATE) FROM QAL_SAMPLE_MST" & vbCrLf & " WHERE WEFDATE<=TO_DATE('" & VB6.Format(pWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        mSqlStr = mSqlStr & vbCrLf & " AND MINLIMIT<=" & pReceiptQty & ""
        mSqlStr = mSqlStr & vbCrLf & " AND MAXLIMIT>=" & pReceiptQty & ""
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            GetSamplePlan = IIf(IsDBNull(RsTemp.Fields("DIM_CHECK").Value), 0, RsTemp.Fields("DIM_CHECK").Value)
        End If
ExitPart:
        Exit Function
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetSamplePlan = 0
    End Function
    Public Function GetSundayCount(ByRef mDate As String, ByRef pEmpCode As String, ByRef pCheckWeeklyOffFromShift As String, ByRef pIsContractorEmp As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFromDate As String
        Dim mToDate As String
        Dim mLastDay As Integer
        GetSundayCount = False
        If pIsContractorEmp = "Y" Then
            If CheckIsWorked(pEmpCode, mDate, "P") = True Then
                GetSundayCount = True
            ElseIf CheckIsWorked(pEmpCode, mDate, "C") = True Then
                GetSundayCount = True
            End If
        Else
            GetSundayCount = True
        End If
        'mLastDay = MainClass.LastDay(Month(CVDate(mDate)), Year(CVDate(mDate)))
        '
        'GetSundayCount = False
        'mFromDate = DateAdd("d", -1, mDate)
        'mToDate = DateAdd("d", 1, mDate)
        '
        '
        'PreviousCheck:
        'If GetIsHolidays(Format(mFromDate, "DD/MM/YYYY"), "", pEmpCode, "", pCheckWeeklyOffFromShift) = True Then
        'mFromDate = DateAdd("d", -1, mFromDate)
        'GoTo PreviousCheck
        'End If
        '
        'nextCheck:
        'If GetIsHolidays(Format(mToDate, "DD/MM/YYYY"), "", pEmpCode, "", pCheckWeeklyOffFromShift) = True Then
        'mToDate = DateAdd("d", 1, mToDate)
        'GoTo nextCheck
        'End If
        '
        'If pIsContractorEmp = "Y" Then
        'SqlStr = " SELECT * FROM PAY_CONT_DALIY_ATTN_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND ATTN_DATE>='" & vb6.Format(mDate, "DD-MMM-YYYY") & "'" & vbCrLf _
        ''& " AND EMP_CODE='" & pEmpCode & "' AND TOT_HOURS > 0"
        '
        'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsTemp, adLockReadOnly
        '
        'If RsTemp.EOF = False Then
        'SqlStr = " SELECT * FROM PAY_CONT_DALIY_ATTN_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND ATTN_DATE>='" & vb6.Format(mFromDate, "DD-MMM-YYYY") & "'" & vbCrLf _
        ''& " AND ATTN_DATE<='" & vb6.Format(mToDate, "DD-MMM-YYYY") & "'" & vbCrLf _
        ''& " AND EMP_CODE='" & pEmpCode & "' AND TOT_HOURS > 0"
        '
        '
        'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsTemp, adLockReadOnly
        '
        'If RsTemp.EOF = False Then
        'GetSundayCount = True
        'End If
        'Else
        'If mLastDay = Day((CVDate(mDate))) Then
        ' GetSundayCount = True
        'End If
        'End If
        'End If
        Exit Function
ErrPart:
        GetSundayCount = False
    End Function
    Public Function CheckIsWorked(ByRef mCode As String, ByRef mSalDate As String, ByRef pPreviou_Curr As String) As Boolean
        On Error GoTo UpdateAttnTrnErr
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mDate As String
        Dim SqlStr As String = ""
        Dim mHolidayType As String = ""
        Dim mISHoliday As Boolean
        Dim mTotatWorks As Double
        CheckIsWorked = False
        mDate = mSalDate
        If pPreviou_Curr = "P" Then
            mDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, CDate(mSalDate)))
        Else
            mDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, 1, CDate(mSalDate)))
        End If
        mISHoliday = GetIsHolidays(VB6.Format(mDate, "DD/MM/YYYY"), mHolidayType, mCode, "", "N")
        Do While mISHoliday = True
            If pPreviou_Curr = "P" Then
                mDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, CDate(mDate)))
            Else
                mDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, 1, CDate(mDate)))
            End If
            mISHoliday = GetIsHolidays(VB6.Format(mDate, "DD/MM/YYYY"), mHolidayType, mCode, "", "N")
        Loop
        SqlStr = " SELECT TOT_HOURS FROM PAY_CONT_DALIY_ATTN_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ATTN_DATE=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND EMP_CODE='" & mCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mTotatWorks = Val(IIf(IsDBNull(RsTemp.Fields("TOT_HOURS").Value), 0, RsTemp.Fields("TOT_HOURS").Value))
        End If
        If mTotatWorks > 0 Then
            CheckIsWorked = True
        End If
        Exit Function
UpdateAttnTrnErr:
        'Resume
        MsgBox(Err.Description)
        CheckIsWorked = False
    End Function
    Public Function CheckEMailValidation(ByRef peMailId As String) As Boolean
        On Error GoTo ErrPart
        Dim mCharCnt As Integer
        Dim mKeyAscii As String
        Dim pAtTheRatePos As Integer
        Dim pDotPos As Integer
        If peMailId = "" Then CheckEMailValidation = True : Exit Function
        CheckEMailValidation = False
        If Len(peMailId) < 5 Then
            CheckEMailValidation = False
            Exit Function
        End If
        If InStr(1, peMailId, "@") = 0 Then
            CheckEMailValidation = False
            Exit Function
        End If
        If InStr(1, peMailId, ".") = 0 Then
            CheckEMailValidation = False
            Exit Function
        End If
        pAtTheRatePos = InStr(1, peMailId, "@")
        pDotPos = InStr(1, Mid(peMailId, pAtTheRatePos), ".")
        If pDotPos < 3 Then
            CheckEMailValidation = False
            Exit Function
        End If
        For mCharCnt = 1 To Len(peMailId)
            mKeyAscii = UCase(Mid(peMailId, mCharCnt, 1))
            Select Case mKeyAscii
                Case "^", " "
                    CheckEMailValidation = False
                    Exit Function
            End Select
        Next
        CheckEMailValidation = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        CheckEMailValidation = False
    End Function
    Public Function GetPackingRate(ByRef mDeptCode As String, ByRef mItemCode As String, ByRef pDate As String) As Double
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetPackingRate = 0
        SqlStr = " SELECT PACK_RATE FROM PRD_OPR_RATE_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "' "
        SqlStr = SqlStr & vbCrLf & " AND WEF=( " & vbCrLf & " SELECT MAX(WEF) FROM PRD_OPR_RATE_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mItemCode) & "' " & vbCrLf & " AND WEF<= TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetPackingRate = System.Math.Round(Val(IIf(IsDBNull(RsTemp.Fields("PACK_RATE").Value), "", RsTemp.Fields("PACK_RATE").Value)) / 100, 4)
        Else
            GetPackingRate = 0
        End If
        Exit Function
ERR1:
        GetPackingRate = 0
        MsgInformation(Err.Description)
    End Function
    Public Function GetTCSRate(ByRef mPANAvilable As String, ByRef pDate As String) As Double
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetTCSRate = 0
        SqlStr = " SELECT TCS_PAN_PER,TCS_WOPAN_PER FROM GEN_TCS_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " "

        SqlStr = SqlStr & vbCrLf & " AND WEF=( " & vbCrLf _
            & " SELECT MAX(WEF) FROM GEN_TCS_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND WEF<= TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            If mPANAvilable = "Y" Then
                GetTCSRate = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("TCS_PAN_PER").Value), 0, RsTemp.Fields("TCS_PAN_PER").Value), "0.0000"))
            Else
                GetTCSRate = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("TCS_WOPAN_PER").Value), 0, RsTemp.Fields("TCS_WOPAN_PER").Value), "0.0000"))
            End If
        Else
            GetTCSRate = 0
        End If
        Exit Function
ERR1:
        GetTCSRate = 0
        MsgInformation(Err.Description)
    End Function
    Public Function GetDefaultShift() As String
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDefaultShift = ""
        SqlStr = " SELECT SHIFT_CODE FROM PAY_SHIFT_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND DEFAULT_SHIFT ='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetDefaultShift = IIf(IsDBNull(RsTemp.Fields("SHIFT_CODE").Value), "", RsTemp.Fields("SHIFT_CODE").Value)
        End If
        Exit Function
ERR1:
        MsgInformation(Err.Description)
    End Function
    Public Function GetDefaultDivision() As String
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetDefaultDivision = ""
        SqlStr = " SELECT DIV_DESC FROM INV_DIVISION_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND IS_DEFAULT='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetDefaultDivision = IIf(IsDBNull(RsTemp.Fields("DIV_DESC").Value), "", RsTemp.Fields("DIV_DESC").Value)
        End If
        Exit Function
ERR1:
        MsgInformation(Err.Description)
    End Function
    Public Function CheckWareHouseDivision(pDivCode As Double) As String
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckWareHouseDivision = "N"
        SqlStr = " SELECT IS_WAREHOUSE_DIV FROM INV_DIVISION_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND DIV_CODE=" & pDivCode & " AND IS_WAREHOUSE_DIV='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckWareHouseDivision = "Y"
        End If
        Exit Function
ERR1:
        MsgInformation(Err.Description)
    End Function
    Public Function GetDocumentInvoiceDigit() As String
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetDocumentInvoiceDigit = "1"
        SqlStr = " SELECT INVOICE_DIGIT FROM GEN_DOCUMENTNO_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetDocumentInvoiceDigit = CStr(IIf(IsDBNull(RsTemp.Fields("INVOICE_DIGIT").Value), "1", RsTemp.Fields("INVOICE_DIGIT").Value))
        Else
            GetDocumentInvoiceDigit = "1"
        End If

        Exit Function
ERR1:
        MsgInformation(Err.Description)
    End Function
    Public Function GetDocumentPrefix(ByRef mBookType As String, ByRef mBookSubType As String, Optional ByRef pDivName As String = "", Optional ByRef pIsSuffix As String = "N") As String
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetDocumentPrefix = ""

        SqlStr = " SELECT COMPANY_CODE, BOOKTYPE,"

        If pIsSuffix = "N" Then
            SqlStr = SqlStr & vbCrLf & "PREFIX_NO"
        Else
            SqlStr = SqlStr & vbCrLf & "SUFFIX_NO PREFIX_NO"
        End If

        SqlStr = SqlStr & vbCrLf _
            & " FROM GEN_DOCUMENTNO_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf _
            & " AND BOOKTYPE='" & mBookType & "' AND BOOKSUBTYPE='" & mBookSubType & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetDocumentPrefix = IIf(IsDBNull(RsTemp.Fields("PREFIX_NO").Value), "", RsTemp.Fields("PREFIX_NO").Value)
        Else
            GetDocumentPrefix = ""
        End If

        If RsCompany.Fields("FYEAR").Value <= 2022 Then
            If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 101 Then
                If RsCompany.Fields("COMPANY_CODE").Value = 5 And pDivName = "WAREHOUSE STORE" And mBookSubType <> "9" Then
                    GetDocumentPrefix = "LDH/"
                End If
            End If
        End If

        Exit Function
ERR1:
        GetDocumentPrefix = ""
        MsgInformation(Err.Description)
    End Function
    Public Function GetCurrentTurnOver(ByRef mCustomerCode As String, ByRef pBillNo As String, ByRef pDate As String, ByRef pCompanyPANNo As String, ByRef pCustomerPANNo As String) As Double
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetCurrentTurnOver = 0

        ''pCompanyPANNo As String, ByRef pCustomerPANNo 

        SqlStr = " SELECT SUM(IH.NETVALUE) AS NETVALUE " & vbCrLf _
            & " FROM FIN_INVOICE_HDR IH, FIN_SUPP_CUST_MST CMST, GEN_COMPANY_MST CC" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=CC.COMPANY_CODE" & vbCrLf _
            & " AND IH.FYEAR=" & RsCompany.Fields("FYEAR").Value & " "

        SqlStr = SqlStr & vbCrLf _
            & " AND IH.COMPANY_CODE=CMST.COMPANY_CODE" & vbCrLf _
            & " AND IH.SUPP_CUST_CODE=CMST.SUPP_CUST_CODE"

        SqlStr = SqlStr & vbCrLf & " AND CC.PAN_NO = '" & pCompanyPANNo & "'"

        SqlStr = SqlStr & vbCrLf & " AND CMST.PAN_NO = '" & pCustomerPANNo & "'"

        If Trim(pBillNo) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND IH.BILLNO <> '" & pBillNo & "'"
        End If

        SqlStr = SqlStr & vbCrLf & " AND IH.INVOICE_DATE <= TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetCurrentTurnOver = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("NETVALUE").Value), 0, RsTemp.Fields("NETVALUE").Value), "0.00"))
        Else
            GetCurrentTurnOver = 0
        End If
        Exit Function
ERR1:
        GetCurrentTurnOver = 0
        MsgInformation(Err.Description)
    End Function
    Public Function GetIsCashPayment(ByRef pDate As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetIsCashPayment = False
        SqlStr = " SELECT LEAVE_TYPE FROM PAY_SUNDAY_PAYMENT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND HOLIDAY_DATE=TO_DATE('" & UCase(VB6.Format(pDate, "DD-MMM-YYYY")) & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetIsCashPayment = True
        End If
        Exit Function
ErrPart:
        GetIsCashPayment = False
    End Function
    Public Function CheckTransactionMade(ByRef pCode As String, ByRef pType As String) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCount As Double
        Dim mTableName As String = ConInventoryTable
        CheckTransactionMade = False
        ''COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "

        If pType = "A" Then
            SqlStr = "SELECT COUNT(1) AS CNT FROM PUR_PURCHASE_HDR " & vbCrLf _
                & " WHERE SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mCount = IIf(IsDBNull(RsTemp.Fields("CNT").Value), 0, RsTemp.Fields("CNT").Value)
                If mCount > 0 Then
                    CheckTransactionMade = True
                End If
            End If

            SqlStr = "SELECT COUNT(1) AS CNT FROM FIN_POSTED_TRN " & vbCrLf _
                & " WHERE ACCOUNTCODE='" & MainClass.AllowSingleQuote(pCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mCount = IIf(IsDBNull(RsTemp.Fields("CNT").Value), 0, RsTemp.Fields("CNT").Value)
                If mCount > 0 Then
                    CheckTransactionMade = True
                End If
            End If

        ElseIf pType = "I" Then
            SqlStr = "SELECT COUNT(1) AS CNT FROM PUR_INDENT_DET " & vbCrLf _
                & " WHERE ITEM_CODE='" & MainClass.AllowSingleQuote(pCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mCount = IIf(IsDBNull(RsTemp.Fields("CNT").Value), 0, RsTemp.Fields("CNT").Value)
                If mCount > 0 Then
                    CheckTransactionMade = True
                End If
            End If

            SqlStr = "SELECT COUNT(1) AS CNT FROM PUR_PURCHASE_DET " & vbCrLf _
                & " WHERE ITEM_CODE='" & MainClass.AllowSingleQuote(pCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mCount = IIf(IsDBNull(RsTemp.Fields("CNT").Value), 0, RsTemp.Fields("CNT").Value)
                If mCount > 0 Then
                    CheckTransactionMade = True
                End If
            End If


            SqlStr = "SELECT COUNT(1) AS CNT FROM " & mTableName & " " & vbCrLf _
                & " WHERE ITEM_CODE='" & MainClass.AllowSingleQuote(pCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mCount = IIf(IsDBNull(RsTemp.Fields("CNT").Value), 0, RsTemp.Fields("CNT").Value)
                If mCount > 0 Then
                    CheckTransactionMade = True
                End If
            End If

        End If
        Exit Function
UpdateError:
        CheckTransactionMade = False
    End Function

    Public Function CheckAttnData(ByRef pEmpCode As String, ByRef pDate As String) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckAttnData = False
        SqlStr = "SELECT * FROM PAY_ATTN_MST " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckAttnData = True
        End If
        Exit Function
UpdateError:
        CheckAttnData = False
    End Function

    Public Function CheckPresentAttnData(ByRef pEmpCode As String, ByRef pDate As String) As Double
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mLeaveType As Long

        CheckPresentAttnData = 0

        SqlStr = "SELECT * FROM PAY_ATTN_MST " & vbCrLf _
            & " WHERE " & vbCrLf _
            & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf _
            & " AND TO_CHAR(ATTN_DATE,'MMYYYY')='" & VB6.Format(pDate, "MMYYYY") & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mLeaveType = IIf(IsDBNull(RsTemp.Fields("FIRSTHALF").Value), "-1", RsTemp.Fields("FIRSTHALF").Value)
                If mLeaveType = PRESENT Or mLeaveType = CPLEARN Then
                    CheckPresentAttnData = CheckPresentAttnData + 0.5
                End If
                mLeaveType = IIf(IsDBNull(RsTemp.Fields("SECONDHALF").Value), "-1", RsTemp.Fields("SECONDHALF").Value)
                If mLeaveType = PRESENT Or mLeaveType = CPLEARN Then
                    CheckPresentAttnData = CheckPresentAttnData + 0.5
                End If
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
UpdateError:
        CheckPresentAttnData = 0
    End Function

    Public Function CheckVacantPost(ByRef pDeptCode As String, ByRef pCorporate As String, ByRef pDate As String) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mSanctionNo As Double
        Dim mOnRollNo As Double
        CheckVacantPost = False

        SqlStr = "SELECT SANCTION_NOS FROM PAY_BUDGET_DET " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf & " AND IS_CORPORATE='" & pCorporate & "'" & vbCrLf & " AND WEF= (" & vbCrLf & " SELECT MAX(WEF) FROM PAY_BUDGET_DET " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf & " AND IS_CORPORATE='" & pCorporate & "'" & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mSanctionNo = IIf(IsDBNull(RsTemp.Fields("SANCTION_NOS").Value), 0, RsTemp.Fields("SANCTION_NOS").Value)
        End If
        SqlStr = "SELECT COUNT(EMP_CODE) AS CNTEMPCODE FROM PAY_EMPLOYEE_MST " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'" & vbCrLf & " AND IS_CORPORATE='" & pCorporate & "' AND EMP_CAT_TYPE='1'" & vbCrLf & " AND (EMP_LEAVE_DATE='' OR EMP_LEAVE_DATE IS NULL)"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mOnRollNo = IIf(IsDBNull(RsTemp.Fields("CNTEMPCODE").Value), 0, RsTemp.Fields("CNTEMPCODE").Value)
        End If
        If mSanctionNo > mOnRollNo Then
            CheckVacantPost = True
        End If
        Exit Function
UpdateError:
        CheckVacantPost = False
    End Function
    Public Function CheckLeaveAgtShortLeave(ByRef pEmpCode As String, ByRef pDate As String) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckLeaveAgtShortLeave = False
        SqlStr = "SELECT * FROM PAY_MOVEMENT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf & " AND REF_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND AGT_LEAVE='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckLeaveAgtShortLeave = True
        End If
        Exit Function
UpdateError:
        CheckLeaveAgtShortLeave = False
    End Function
    Public Function GetWeeklyHoliday(ByRef pDate As String, ByRef mEmpCode As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFromDate As String
        Dim mToDate As String
        Dim mCategory As String
        GetWeeklyHoliday = 0
        If CurrModuleName = mContPayrollModule Then
            mCategory = "C"
        Else
            If MainClass.ValidateWithMasterTable(mEmpCode, "EMP_CODE", "EMP_CAT_TYPE", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                mCategory = MasterNo
            Else
                mCategory = "1"
            End If
            mCategory = IIf(mCategory = "1", "S", "W")
        End If
        mFromDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, -6, CDate(pDate)))
        mToDate = pDate
        SqlStr = " SELECT COUNT(LEAVE_TYPE) AS COUNT_HOLIDAYFROM PAY_HOLIDAY_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND HOLIDAY_DATE>=TO_DATE('" & UCase(VB6.Format(mFromDate, "DD-MMM-YYYY")) & "','DD-MON-YYYY')" & vbCrLf & " AND HOLIDAY_DATE<=TO_DATE('" & VB6.Format(mToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        If CurrModuleName = mContPayrollModule Then
            SqlStr = SqlStr & vbCrLf & " AND APP_CONTRACTOR='Y'"
        Else
            If mCategory = "S" Then
                SqlStr = SqlStr & vbCrLf & " AND APP_STAFF='Y'"
            Else
                SqlStr = SqlStr & vbCrLf & " AND APP_RW='Y'"
            End If
        End If
        If RsCompany.Fields("WEEKLYOFF_TYPE").Value = "S" Then
            SqlStr = SqlStr & vbCrLf & " AND LEAVE_TYPE<>'SD'"
            SqlStr = SqlStr & vbCrLf & " UNION "
            SqlStr = SqlStr & vbCrLf & " SELECT COUNT(LEAVE_TYPE) AS COUNT_HOLIDAYFROM PAY_SHIFT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mEmpCode) & "'" & vbCrLf & " AND SHIFT_DATE>=TO_DATE('" & VB6.Format(mFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND " & vbCrLf & " AND SHIFT_DATE<=TO_DATE('" & VB6.Format(mToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND WEEKLY_OFF='Y'"
            ''End If
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                GetWeeklyHoliday = GetWeeklyHoliday + IIf(IsDBNull(RsTemp.Fields("COUNT_HOLIDAY").Value), 0, RsTemp.Fields("COUNT_HOLIDAY").Value)
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        GetWeeklyHoliday = 0
    End Function
    Public Function CheckWeeklyOff(ByRef pDate As String, ByRef mEmpCode As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckWeeklyOff = False
        SqlStr = " SELECT SHIFT_DATE FROM PAY_SHIFT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mEmpCode) & "'" & vbCrLf & " AND SHIFT_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND WEEKLY_OFF='Y'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckWeeklyOff = True
        End If
        Exit Function
ErrPart:
        CheckWeeklyOff = False
    End Function
    Public Function GetIsHolidaysEmpWise(ByRef pDate As String, ByRef pEmpCode As String, ByRef pFieldName As String, ByRef mHType As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mLeaveType As Integer
        GetIsHolidaysEmpWise = False
        SqlStr = " SELECT " & pFieldName & " AS FLDNAME FROM PAY_ATTN_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND (" & pFieldName & "=" & SUNDAY & " OR " & pFieldName & "=" & HOLIDAY & ") "
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mLeaveType = IIf(IsDBNull(RsTemp.Fields("FLDName").Value), -1, RsTemp.Fields("FLDName").Value)
            mHType = IIf(mLeaveType = SUNDAY, "S U", "H H") 'IIf(mHType = "SD", "SU", "HH")
            GetIsHolidaysEmpWise = True
        End If
        Exit Function
ErrPart:
        GetIsHolidaysEmpWise = False
    End Function
    Public Function UpdateEmpPresent(ByRef pCode As String, ByRef pDate As String, ByRef pFHalf As String, ByRef pSHalf As String, ByRef pPubDBCn As ADODB.Connection) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim pFHalfPresent As Integer
        Dim pSHalfPresent As Integer
        If CDate(pDate) < CDate("01/04/2014") Then
            UpdateEmpPresent = True
            Exit Function
        End If
        If pFHalf = "P" Or pSHalf = "P" Then
            pFHalfPresent = IIf(pFHalf = "P", PRESENT, -1)
            pSHalfPresent = IIf(pSHalf = "P", PRESENT, -1)
            If CheckAttnData(Trim(pCode), pDate) = False Then
                SqlStr = "INSERT INTO PAY_ATTN_MST (" & vbCrLf & " COMPANY_CODE, PAYYEAR, EMP_CODE," & vbCrLf & " ATTN_DATE, FIRSTHALF, SECONDHALF, AGT_LATE," & vbCrLf & " ADDUSER, ADDDATE,CPL_AGT_DATE_FH,CPL_AGT_DATE_SH,CPL_EARN) VALUES (" & vbCrLf & " " & RsCompany.Fields("COMPANY_CODE").Value & ", " & Year(CDate(pDate)) & ", " & vbCrLf & " '" & pCode & "', TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & "" & pFHalfPresent & ", " & pSHalfPresent & ", 'N'," & vbCrLf & " '" & MainClass.AllowSingleQuote(PubUserID) & "',TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf & " '','',0)"
                PubDBCn.Execute(SqlStr)
            Else
                If pFHalf = "P" Then
                    SqlStr = "UPDATE PAY_ATTN_MST SET FIRSTHALF=" & pFHalfPresent & " " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & pCode & "'" & vbCrLf & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND FIRSTHALF =-1"
                    PubDBCn.Execute(SqlStr)
                End If
                If pSHalf = "P" Then
                    SqlStr = "UPDATE PAY_ATTN_MST SET SECONDHALF=" & pSHalfPresent & " " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & pCode & "'" & vbCrLf & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND SECONDHALF=-1"
                    PubDBCn.Execute(SqlStr)
                End If
            End If
        End If
        UpdateEmpPresent = True
        Exit Function
UpdateError:
        UpdateEmpPresent = False
    End Function
    Public Function UpdateEmpAttendance(ByRef pCode As String, ByRef pDate As String, ByRef pFHalf As Short, ByRef pSHalf As Short, ByRef pPubDBCn As ADODB.Connection) As Boolean
        On Error GoTo UpdateError
        Dim SqlStr As String = ""
        Dim pFHalfPresent As Integer
        Dim pSHalfPresent As Integer

        'If pFHalf = "P" Or pSHalf = "P" Then
        '    pFHalfPresent = IIf(pFHalf = "P", PRESENT, -1)
        '    pSHalfPresent = IIf(pSHalf = "P", PRESENT, -1)

        If CheckAttnData(Trim(pCode), pDate) = False Then
            SqlStr = "INSERT INTO PAY_ATTN_MST (" & vbCrLf _
                & " COMPANY_CODE, PAYYEAR, EMP_CODE," & vbCrLf _
                & " ATTN_DATE, FIRSTHALF, SECONDHALF, AGT_LATE," & vbCrLf _
                & " ADDUSER, ADDDATE,CPL_AGT_DATE_FH,CPL_AGT_DATE_SH,CPL_EARN) VALUES (" & vbCrLf _
                & " " & RsCompany.Fields("COMPANY_CODE").Value & ", " & Year(CDate(pDate)) & ", " & vbCrLf _
                & " '" & pCode & "', TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
                & "" & pFHalf & ", " & pSHalf & ", 'N'," & vbCrLf _
                & " '" & MainClass.AllowSingleQuote(PubUserID) & "',TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')," & vbCrLf & " '','',0)"

            pPubDBCn.Execute(SqlStr)
        Else

            SqlStr = "UPDATE PAY_ATTN_MST SET FIRSTHALF=" & pFHalf & " " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND EMP_CODE='" & pCode & "'" & vbCrLf _
                & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND FIRSTHALF =-1"

            pPubDBCn.Execute(SqlStr)


            SqlStr = "UPDATE PAY_ATTN_MST SET SECONDHALF=" & pSHalf & " " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND EMP_CODE='" & pCode & "'" & vbCrLf _
                & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND SECONDHALF=-1"

            pPubDBCn.Execute(SqlStr)

        End If
        'End If
        UpdateEmpAttendance = True
        Exit Function
UpdateError:
        UpdateEmpAttendance = False
    End Function
    Public Function GetEmployeeExists(ByRef mCode As String, ByRef xDate As String, ByRef mEmpTable As String) As Boolean
        On Error GoTo ErrPart
        Dim RsEmployee As ADODB.Recordset = Nothing

        OpenLocalConnection()
        Dim SqlStr As String = ""
        GetEmployeeExists = False
        SqlStr = " SELECT EMP_CODE FROM " & vbCrLf & " " & mEmpTable & " " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE='" & MainClass.AllowSingleQuote(mCode) & "'" & vbCrLf & " AND EMP_DOJ <=TO_DATE('" & VB6.Format(xDate, "dd-mmm-yyyy") & "','DD-MON-YYYY') " & vbCrLf & " AND (EMP_LEAVE_DATE >TO_DATE('" & VB6.Format(xDate, "dd-mmm-yyyy") & "','DD-MON-YYYY') OR EMP_LEAVE_DATE IS NULL) "
        MainClass.UOpenRecordSet(SqlStr, LocalPubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsEmployee, ADODB.LockTypeEnum.adLockOptimistic)
        If RsEmployee.EOF = False Then
            GetEmployeeExists = True
        End If
        CloseLocalConnection()
        Exit Function
ErrPart:
        'Resume
        GetEmployeeExists = False
    End Function
    Public Function GetEmpAttnDetail(ByRef pEmpCode As String, ByRef pDate As String, ByRef mFHalf As Integer, ByRef mSHalf As Integer) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mLeaveType As Double
        GetEmpAttnDetail = 0
        SqlStr = " SELECT FirstHalf,SecondHalf FROM PAY_ATTN_MST" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf _
            & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mLeaveType = IIf(IsDBNull(RsTemp.Fields("FIRSTHALF").Value), "-1", RsTemp.Fields("FIRSTHALF").Value)
            If mLeaveType = EARN Or mLeaveType = CASUAL Or mLeaveType = SICK Then
                GetEmpAttnDetail = GetEmpAttnDetail + 0.5
                mFHalf = mLeaveType
            End If
            mLeaveType = IIf(IsDBNull(RsTemp.Fields("SECONDHALF").Value), "-1", RsTemp.Fields("SECONDHALF").Value)
            If mLeaveType = EARN Or mLeaveType = CASUAL Or mLeaveType = SICK Then
                GetEmpAttnDetail = GetEmpAttnDetail + 0.5
                mSHalf = mLeaveType
            End If
        End If

        'Public Const ABSENT As Short = 0
        'Public Const CASUAL As Short = 1
        'Public Const EARN As Short = 2
        'Public Const SICK As Short = 3
        'Public Const MATERNITY As Short = 4
        'Public Const CPLEARN As Short = 5
        'Public Const WOPAY As Short = 6
        'Public Const CPLAVAIL As Short = 7
        'Public Const SUNDAY As Short = 8
        'Public Const HOLIDAY As Short = 9
        'Public Const PRESENT As Short = 10

        Exit Function
ErrPart:
        GetEmpAttnDetail = 0
    End Function
    Public Function GetContEmpLeave(ByRef pEmpCode As String, ByRef pDate As String, ByRef mFHalf As Integer, ByRef mSHalf As Integer) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mLeaveType As Double
        GetContEmpLeave = 0
        SqlStr = " SELECT FirstHalf,SecondHalf FROM PAY_CONT_LEAVE_TRN " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'" & vbCrLf _
            & " AND ATTN_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mLeaveType = IIf(IsDBNull(RsTemp.Fields("FIRSTHALF").Value), "-1", RsTemp.Fields("FIRSTHALF").Value)
            If mLeaveType = EARN Or mLeaveType = CASUAL Or mLeaveType = SICK Then
                GetContEmpLeave = GetContEmpLeave + 0.5
                mFHalf = mLeaveType
            End If
            mLeaveType = IIf(IsDBNull(RsTemp.Fields("SECONDHALF").Value), "-1", RsTemp.Fields("SECONDHALF").Value)
            If mLeaveType = EARN Or mLeaveType = CASUAL Or mLeaveType = SICK Then
                GetContEmpLeave = GetContEmpLeave + 0.5
                mSHalf = mLeaveType
            End If
        End If
        Exit Function
ErrPart:
        GetContEmpLeave = 0
    End Function
    Public Function GetRMStqQtyInProduct(ByRef xProductCode As String, ByRef xItemCode As String, ByRef xCheckRM As String, ByRef pDate As String) As Double
        On Error GoTo ERR1
        'Dim cntCol As Long
        Dim SqlStr As String = ""
        Dim RsBOM As ADODB.Recordset
        Dim RsTemp As ADODB.Recordset = Nothing
        'Dim mTable As String
        Dim mStdQty As Double
        'Dim mProductCode As String
        'Dim mDeptCode As String
        'Dim mProdQty As Double
        'Dim mBOMQty As Double
        Dim mRMCode As String
        Dim mLevel As String
        '
        'SqlStr = " SELECT IH.PRODUCT_CODE, (STD_QTY + GROSS_WT_SCRAP) AS STD_QTY" & vbCrLf _
        ''& " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID" & vbCrLf _
        ''& " WHERE IH.COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " AND IH.MKEY=ID.MKEY" & vbCrLf _
        ''& " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(mProductCode) & "'" & vbCrLf _
        ''& " AND ID.RM_CODE='" & MainClass.AllowSingleQuote(mRMCode) & "'" & vbCrLf _
        ''& " AND IH.WEF = (SELECT MAX(WEF) FROM PRD_NEWBOM_HDR" & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(mProductCode) & "'" & vbCrLf _
        ''& " AND WEF<='" & vb6.Format(txtDateTo.Text, "DD-MMM-YYYY") & "')"
        'Exit Function
        mStdQty = 1
        'If xItemCode = Trim(xCheckRM) Then
        'mRMCode = xProductCode
        'Else
        'mRMCode = xItemCode
        'End If
        SqlStr = " SELECT PRODUCT_CODE,RM_CODE," & vbCrLf & " (STD_QTY + GROSS_WT_SCRAP) AS STD_QTY " & vbCrLf & " FROM VW_PRD_BOM_TRN TRN" & vbCrLf & " WHERE TRN.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND RM_CODE='" & MainClass.AllowSingleQuote(xCheckRM) & "'"
        SqlStr = SqlStr & vbCrLf & " START WITH PRODUCT_CODE || '-' || TRN.COMPANY_CODE ='" & MainClass.AllowSingleQuote(xItemCode) & "-" & RsCompany.Fields("COMPANY_CODE").Value & "'" & vbCrLf & " CONNECT BY PRIOR (TRIM(RM_CODE) || COMPANY_CODE || ' ')=TRIM(PRODUCT_CODE) || COMPANY_CODE || ' '"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            'mLevel = IIf(IsNull(RsTemp!Level), 0, RsTemp!Level)
            'If xItemCode = Trim(xCheckRM) Then
            mStdQty = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("STD_QTY").Value), 0, RsTemp.Fields("STD_QTY").Value), "0.0000"))
            'End If
            'mRMCode = Trim(IIf(IsNull(RsTemp!PRODUCT_CODE), "", RsTemp!PRODUCT_CODE))
            '
            ''If mRMCode = xItemCode Then
            'SqlStr = " SELECT " & vbCrLf _
            ''& " TRN.PRODUCT_CODE, TRN.RM_CODE AS ITEM_CODE, (STD_QTY + GROSS_WT_SCRAP) AS STD_QTY, DEPT_CODE " & vbCrLf _
            ''& " FROM VW_PRD_BOM_TRN TRN" & vbCrLf _
            ''& " WHERE TRN.COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " AND TRN.PRODUCT_CODE='" & MainClass.AllowSingleQuote(mRMCode) & "'"
            '
            'SqlStr = SqlStr & vbCrLf _
            ''& " START WITHTRN.COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " AND RM_CODE='" & MainClass.AllowSingleQuote(xCheckRM) & "'" & vbCrLf _
            ''& " CONNECT BY PRIOR PRODUCT_CODE=RM_CODE"
            '
            'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsBOM, adLockReadOnly
            'If RsBOM.EOF = False Then
            'mStdQty = mStdQty * Format(IIf(IsNull(RsTemp!STD_QTY), 0, RsTemp!STD_QTY), "0.0000")
            'End If
            ''If mRMCode = Trim(xCheckRM) Then GoTo NextPart
            'RsTemp.MoveNext
        End If
NextPart:
        GetRMStqQtyInProduct = mStdQty
        Exit Function
ERR1:
        GetRMStqQtyInProduct = 0
        MsgInformation(Err.Description)
    End Function
    Public Function GetReportFieldName(ByRef pBookType As String, ByRef pBookSubType As String, Optional ByRef mSelection As String = "") As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mFieldName As String
        Dim mPOS As Integer
        Dim xFieldName As String

        GetReportFieldName = ""
        mSqlStr = "SELECT FIELDNAME FROM GEN_PRINTSETUP_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & pBookSubType & "' ORDER BY SERIAL_NO"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                If mSelection = "G" Then
                    mFieldName = IIf(IsDBNull(RsTemp.Fields("FieldName").Value), "", RsTemp.Fields("FieldName").Value)
                    If GetReportFieldIsSUM(mFieldName) = True Then
                        mFieldName = ""
                    End If
                Else
                    If mSelection <> "" Then
                        mFieldName = IIf(IsDBNull(RsTemp.Fields("FieldName").Value), "", RsTemp.Fields("FieldName").Value)
                        mPOS = InStr(1, mFieldName, ".")
                        xFieldName = Trim(Mid(mFieldName, mPOS + 1))
                        If GetReportFieldIsSUM(mFieldName) = True Then
                            mFieldName = "SUM(" & mFieldName & ") AS " & xFieldName
                        End If
                    Else
                        mFieldName = IIf(IsDBNull(RsTemp.Fields("FieldName").Value), "", RsTemp.Fields("FieldName").Value)
                    End If
                End If
                If GetReportFieldName = "" Then
                    GetReportFieldName = mFieldName
                Else
                    If mFieldName <> "" Then
                        GetReportFieldName = GetReportFieldName & "," & vbCrLf & mFieldName
                    End If
                End If
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        MsgInformation(Err.Description)
        GetReportFieldName = ""
    End Function
    Public Function GetReportFieldIsSUM(ByRef mFieldName As String) As Boolean
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetReportFieldIsSUM = False
        mSqlStr = "SELECT 'X' FROM GEN_PRINTSETUP_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'" & vbCrLf & " AND BOOKTYPE='S' AND BOOKSUBTYPE='G'" & vbCrLf & " AND FIELDNAME='" & mFieldName & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetReportFieldIsSUM = True
        End If
        Exit Function
ErrPart:
        MsgInformation(Err.Description)
        GetReportFieldIsSUM = False
    End Function
    Public Function GetReportFieldCount(ByRef pBookType As String, ByRef pBookSubType As String) As Integer
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        GetReportFieldCount = 0
        mSqlStr = "SELECT FIELDNAME FROM GEN_PRINTSETUP_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & pBookSubType & "'"
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                GetReportFieldCount = GetReportFieldCount + 1
                RsTemp.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        MsgInformation(Err.Description)
        GetReportFieldCount = 0
    End Function
    Public Function GetReportFieldType(ByRef pBookType As String, ByRef pBookSubType As String, ByRef pSerialNo As Integer) As String
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mTableName As String
        Dim mFieldName As String
        Dim pos As Integer
        Dim mString As String
        GetReportFieldType = "S"
        mSqlStr = "SELECT FIELDNAME FROM GEN_PRINTSETUP_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & pBookSubType & "' AND SERIAL_NO=" & pSerialNo & ""
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mString = IIf(IsDBNull(RsTemp.Fields("FieldName").Value), "", RsTemp.Fields("FieldName").Value)
            pos = InStr(1, mString, ".")
            mTableName = Trim(Mid(mString, 1, pos - 1))
            mFieldName = Trim(Mid(mString, pos + 1))
            mSqlStr = "SELECT " & mFieldName & " FROM " & mTableName & " WHERE 1=2"
            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.Fields(0).Type = ADODB.DataTypeEnum.adNumeric Then
                GetReportFieldType = "N"
            Else
                GetReportFieldType = "S"
            End If
        End If
        Exit Function
ErrPart:
        MsgInformation(Err.Description)
        GetReportFieldType = "S"
    End Function
    Public Function GetReportFieldLength(ByRef pBookType As String, ByRef pBookSubType As String, ByRef pSerialNo As Integer) As Integer
        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mTableName As String
        Dim mFieldName As String
        Dim pos As Integer
        Dim mString As String
        GetReportFieldLength = 10
        mSqlStr = "SELECT FIELDNAME FROM GEN_PRINTSETUP_MST" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND USER_ID='" & MainClass.AllowSingleQuote(PubUserID) & "'" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & pBookSubType & "' AND SERIAL_NO=" & pSerialNo & ""
        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mString = IIf(IsDBNull(RsTemp.Fields("FieldName").Value), "", RsTemp.Fields("FieldName").Value)
            pos = InStr(1, mString, ".")
            mTableName = Trim(Mid(mString, 1, pos - 1))
            mFieldName = Trim(Mid(mString, pos + 1))
            mSqlStr = "SELECT " & mFieldName & " FROM " & mTableName & " WHERE 1=2"
            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.Fields(0).Type = ADODB.DataTypeEnum.adNumeric Then
                GetReportFieldLength = 10 ''RsTemp.Fields(0).Precision
            ElseIf RsTemp.Fields(0).Type = ADODB.DataTypeEnum.adDBTimeStamp Then
                GetReportFieldLength = 10
            Else
                GetReportFieldLength = RsTemp.Fields(0).DefinedSize
                GetReportFieldLength = IIf(GetReportFieldLength > 25, 25, GetReportFieldLength)
            End If
        End If
        Exit Function
ErrPart:
        MsgInformation(Err.Description)
        GetReportFieldLength = 10
    End Function
    Public Function GetLastChallanDate(ByRef pEmpCode As String) As String
        On Error GoTo PrintDummyErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetLastChallanDate = ""
        SqlStr = " SELECT MAX(CHALLANDATE) AS CHALLANDATE " & vbCrLf & " FROM PAY_ITCHALLAN_HDR IH, PAY_ITCHALLAN_DET ID" & vbCrLf & " WHERE IH.AUTO_KEY_REFNO=ID.AUTO_KEY_REFNO" & vbCrLf & " AND IH.COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.FYEAR = " & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND ID.EMP_CODE = '" & pEmpCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetLastChallanDate = IIf(IsDBNull(RsTemp.Fields("CHALLANDATE").Value), "", RsTemp.Fields("CHALLANDATE").Value)
        End If
        Exit Function
PrintDummyErr:
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default
    End Function
    Public Function GetEmpLastIncrement(ByVal pCompanyCode As Integer, ByVal pEmpCode As String, ByVal xWEF_APPDateField As String, Optional ByVal xWEF As String = "") As String
        On Error GoTo PrintDummyErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetEmpLastIncrement = ""
        SqlStr = "SELECT MAX(" & xWEF_APPDateField & ") AS SALARY_EFF_DATE" & vbCrLf _
            & " FROM PAY_SALARYDEF_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & pCompanyCode & "" & vbCrLf _
            & " AND EMP_CODE='" & pEmpCode & "'"

        If xWEF <> "" Then
            SqlStr = SqlStr & vbCrLf _
                & " AND SALARY_EFF_DATE<>TO_DATE('" & VB6.Format(xWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetEmpLastIncrement = IIf(IsDBNull(RsTemp.Fields("SALARY_EFF_DATE").Value), "", RsTemp.Fields("SALARY_EFF_DATE").Value)
            If GetEmpLastIncrement = "" Then
                Exit Function
            End If
            'GetEmpLastIncrement = "01/" & VB6.Format(GetEmpLastIncrement, "MM/YYYY")
        End If
        GetEmpLastIncrement = VB6.Format(GetEmpLastIncrement, "DD/MM/YYYY")
        Exit Function
PrintDummyErr:
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default
    End Function
    Public Function GetLastIncrement(ByVal pEmpCode As String, Optional ByVal xWEF As String = "") As String
        On Error GoTo PrintDummyErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetLastIncrement = ""
        SqlStr = "SELECT MAX(SALARY_EFF_DATE) AS SALARY_EFF_DATE" & vbCrLf _
            & " FROM PAY_CONT_SALARYDEF_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND EMP_CODE='" & pEmpCode & "'"
        If xWEF <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND SALARY_EFF_DATE<TO_DATE('" & VB6.Format(xWEF, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetLastIncrement = IIf(IsDBNull(RsTemp.Fields("SALARY_EFF_DATE").Value), "", RsTemp.Fields("SALARY_EFF_DATE").Value)
        End If
        GetLastIncrement = VB6.Format(GetLastIncrement, "DD/MM/YYYY")
        Exit Function
PrintDummyErr:
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default
    End Function
    Public Function FinancePVNOMST(ByVal pMKey As String, ByVal pVNo As String, ByVal pVDate As String, ByVal pFinalPost As String, ByVal pMRRNo As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM FIN_PURCHASE_VNO_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND MKEY='" & pMKey & "'"
        PubDBCn.Execute(SqlStr)
        If pFinalPost = "N" Or pMRRNo < 1 Then
            FinancePVNOMST = True
            Exit Function
        End If
        SqlStr = "INSERT INTO FIN_PURCHASE_VNO_MST (" & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, VNO, VDATE" & vbCrLf & " ) VALUES (" & vbCrLf & " '" & pMKey & "', " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " '" & pVNo & "', TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        PubDBCn.Execute(SqlStr)
        FinancePVNOMST = True
        Exit Function
SalePostTrnErr:
        FinancePVNOMST = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function AutoGenAssetNo() As String
        On Error GoTo AutoGenSeqNoErr
        Dim RsGen As ADODB.Recordset = Nothing
        Dim mNewSeqNo As Integer
        Dim SqlStr As String = ""
        Dim mStartingChk As Double
        mStartingChk = 50000
        SqlStr = ""
        SqlStr = "SELECT Max(AUTO_KEY_ASSET)" & vbCrLf & " FROM AST_ASSET_TRN " & vbCrLf & " WHERE Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsGen, ADODB.LockTypeEnum.adLockReadOnly)
        With RsGen
            If .EOF = False Then
                If Not IsDBNull(.Fields(0).Value) Then
                    mNewSeqNo = .Fields(0).Value
                    mNewSeqNo = mNewSeqNo + 1
                Else
                    mNewSeqNo = 1
                End If
            End If
        End With
        AutoGenAssetNo = CStr(mNewSeqNo) ''& vb6.Format(RsCompany.fields("FYEAR").value, "0000") & vb6.Format(RsCompany.fields("COMPANY_CODE").value, "00")
        Exit Function
AutoGenSeqNoErr:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetEmployeeESIApp(ByVal pEmpCode As String, ByVal pDate As String) As Double
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        GetEmployeeESIApp = False

        SqlStr = " SELECT * FROM PAY_SalaryDef_MST A, PAY_SALARYHEAD_MST B " & vbCrLf _
            & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND A.EMP_CODE='" & pEmpCode & "'" & vbCrLf _
            & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
            & " AND A.ADD_DEDUCTCODE=B.CODE AND TYPE=" & ConESI & " AND AMOUNT>0" & vbCrLf _
            & " AND A.SALARY_EFF_DATE=(SELECT MAX(SALARY_EFF_DATE) FROM PAY_SalaryDef_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND EMP_CODE='" & pEmpCode & "'" & vbCrLf _
            & " AND SALARY_EFF_DATE<= TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')) "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockOptimistic)

        If RsTemp.EOF = False Then
            GetEmployeeESIApp = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)

    End Function
    Public Function GetLeaveEntitle(ByVal pLeaveCode As Integer, ByVal pEmpCode As String, ByVal pDate As String) As Double
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mCategory As String
        Dim mEmpESIFlag As Boolean
        GetLeaveEntitle = 0

        ''

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 105 Then
            mEmpESIFlag = GetEmployeeESIApp(pEmpCode, pDate)

            If mEmpESIFlag = True And pLeaveCode = SICK Then
                Exit Function
            End If
        End If

        SqlStr = " SELECT TOTENTITLE,TOTENTITLE_WRKS from PAY_LEAVEDTL_MST " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND LEAVECODE=" & pLeaveCode & "" & vbCrLf & " AND PAYYEAR=" & Year(CDate(pDate)) & ""

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockOptimistic)

        If RsTemp.EOF = False Then
            If MainClass.ValidateWithMasterTable(pEmpCode, "EMP_CODE", "EMP_CAT_TYPE", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
                mCategory = MasterNo
            Else
                mCategory = "-1"
            End If
            If mCategory = "2" Then
                If IsDBNull(RsTemp.Fields("TOTENTITLE_WRKS").Value) Or RsTemp.Fields("TOTENTITLE_WRKS").Value = 0 Then
                    GetLeaveEntitle = IIf(IsDBNull(RsTemp.Fields("TOTENTITLE").Value), 0, RsTemp.Fields("TOTENTITLE").Value)
                Else
                    GetLeaveEntitle = IIf(IsDBNull(RsTemp.Fields("TOTENTITLE_WRKS").Value), 0, RsTemp.Fields("TOTENTITLE_WRKS").Value)
                End If
            Else
                GetLeaveEntitle = IIf(IsDBNull(RsTemp.Fields("TOTENTITLE").Value), 0, RsTemp.Fields("TOTENTITLE").Value)
            End If
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetLeaveEntitle = 0
    End Function
    Public Function GETCPL(ByVal pDBCn As ADODB.Connection, ByVal pEmpCode As String, ByVal pRunDate As String) As Double
        On Error GoTo ErrPart
        Dim RsBalEL As ADODB.Recordset = Nothing
        Dim RsEmp As ADODB.Recordset = Nothing
        Dim mFHalf As Double
        Dim mSHalf As Double
        Dim xRunDate As String
        Dim SqlStr As String = ""
        Dim mCPLCountFrom As String
        Dim mEmpType As String = ""
        If MainClass.ValidateWithMasterTable(pEmpCode, "EMP_CODE", "EMP_CAT_TYPE", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mEmpType = IIf(MasterNo = "1", "S", "W")
        End If
        GETCPL = 0

        mCPLCountFrom = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Day, -120, CDate(pRunDate)))

        'If pLeaveCode <> EARN Then Exit Function

        xRunDate = VB6.Format(pRunDate, "DD/MM/YYYY")

        SqlStr = " SELECT SUM(CPL_EARN) AS CPL_EARN " & vbCrLf & " FROM PAY_ATTN_MST WHERE " & vbCrLf & " COMPANY_CODE =" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND EMP_CODE ='" & pEmpCode & "' " & vbCrLf & " AND CPL_EARN > 0" & vbCrLf & " AND ATTN_DATE<=TO_DATE('" & VB6.Format(xRunDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & " AND ATTN_DATE>=TO_DATE('" & VB6.Format(mCPLCountFrom, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalEL, ADODB.LockTypeEnum.adLockOptimistic)
        If RsBalEL.EOF = False Then
            GETCPL = IIf(IsDBNull(RsBalEL.Fields("CPL_EARN").Value), 0, RsBalEL.Fields("CPL_EARN").Value) * 0.5
        End If
        'SqlStr = " SELECT COUNT(SECONDHALF) AS SECONDHALF " & vbCrLf _
        ''& " FROM PAY_ATTN_MST WHERE " & vbCrLf _
        ''& " COMPANY_CODE =" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND EMP_CODE ='" & pEmpCode & "' " & vbCrLf _
        ''& " AND SECONDHALF = " & CPLEARN & "" & vbCrLf _
        ''& " AND ATTN_DATE<='" & vb6.Format(xRunDate, "DD-MMM-YYYY") & "'"
        '

        'MainClass.UOpenRecordSet SqlStr, pDBCn, adOpenStatic, RsBalEL, adLockOptimistic
        'If RsBalEL.EOF = False Then
        'mSHalf = RsBalEL!SECONDHALF * 0.5
        'End If
        'If RsBalEL.EOF = False Then
        'Do While Not RsBalEL.EOF
        'If RsBalEL!FIRSTHALF = CPLEARN Then
        ' mFHalf = mFHalf + 0.5
        'End If
        '
        'If RsBalEL!SECONDHALF = CPLEARN Then
        ' mSHalf = mSHalf + 0.5
        'End If
        'RsBalEL.MoveNext
        'Loop
        'End If
        'GETCPL = mFHalf + mSHalf
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GenerateBatchNo(ByVal pDate As String, ByVal pShift As String, ByVal pLineNo As String) As String
        Dim PDAY As String
        Dim pMonth As Integer
        Dim pMonthStr As String = ""
        Dim pYear As String
        PDAY = VB6.Format(pDate, "DD")
        pMonth = Month(CDate(pDate))
        pYear = VB6.Format(pDate, "YY")
        Select Case pMonth
            Case 1
                pMonthStr = "A"
            Case 2
                pMonthStr = "B"
            Case 3
                pMonthStr = "C"
            Case 4
                pMonthStr = "D"
            Case 5
                pMonthStr = "F"
            Case 6
                pMonthStr = "G"
            Case 7
                pMonthStr = "H"
            Case 8
                pMonthStr = "J"
            Case 9
                pMonthStr = "K"
            Case 10
                pMonthStr = "L"
            Case 11
                pMonthStr = "M"
            Case 12
                pMonthStr = "N"
        End Select
        GenerateBatchNo = PDAY & pMonthStr & pYear & pShift & pLineNo
    End Function
    Public Function GetBEDRate(ByRef pDate As String) As Double
        On Error GoTo ErrorPart
        Dim mBEDRate As Double
        If CDate(pDate) < CDate("01/03/2008") Then
            mBEDRate = 16
        ElseIf CDate(pDate) < CDate("01/01/2009") Then
            mBEDRate = 14
        ElseIf CDate(pDate) < CDate("25/02/2009") Then
            mBEDRate = 10
        ElseIf CDate(pDate) < CDate("01/03/2010") Then
            mBEDRate = 8
        ElseIf CDate(pDate) < CDate("16/03/2012") Then
            mBEDRate = 10
        ElseIf CDate(pDate) < CDate("01/03/2015") Then
            mBEDRate = 12
        Else
            mBEDRate = 12.5
        End If
        GetBEDRate = mBEDRate
        Exit Function
ErrorPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetBEDRate = 0
    End Function
    Public Function fOpenFile(ByRef strPath As String, ByVal strFilter As String, ByVal strTitle As String, ByRef xCommonDialog As OpenFileDialog) As Boolean
        '
        ' Let the user point to a file.
        '
        On Error GoTo ErrorHandler
        fOpenFile = True
        strPath = ""
        '
        ' Display the file open dialog.
        '
        With xCommonDialog
            .FileName = ""
            '.CancelError = True     ''.CancelError = True
            .Title = "Select the " & strTitle & " file"       ''.DialogTitle = "Select the " & strTitle & " file"
            .DefaultExt = ""
            '.flags = MSComDlg.FileOpenConstants.cdlOFNFileMustExist Or MSComDlg.FileOpenConstants.cdlOFNNoLongNames Or MSComDlg.FileOpenConstants.cdlOFNPathMustExist Or MSComDlg.FileOpenConstants.cdlOFNHideReadOnly
            .Filter = strFilter & " |" & strFilter
            .FilterIndex = 1
            .ShowDialog()      '.ShowOpen()
            strPath = UCase(Trim(.FileName))
        End With
        Exit Function
ErrorHandler:
        fOpenFile = False
    End Function
    Public Function CheckPartyWiseBillExp(ByRef pInvTypeDesc As String, ByRef pCustomerName As String, ByRef pCategory As String) As Boolean
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pInvType As Double
        Dim pCustomerCode As String
        If MainClass.ValidateWithMasterTable(pCustomerName, "SUPP_CUST_NAME", "SUPP_CUST_CODE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            pCustomerCode = MasterNo
        Else
            MsgInformation("Invalid Account Code.")
            CheckPartyWiseBillExp = False
            Exit Function
        End If
        If MainClass.ValidateWithMasterTable(pInvTypeDesc, "NAME", "CODE", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND CATEGORY='" & pCategory & "'") = True Then
            pInvType = Val(MasterNo)
        Else
            MsgInformation("Invalid INVOICE TYPE.")
            CheckPartyWiseBillExp = False
            Exit Function
        End If
        SqlStr = "SELECT * FROM FIN_PARTY_INTERFACE_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pCustomerCode) & "'" & vbCrLf & " AND TRNTYPE=" & Val(CStr(pInvType)) & "" & vbCrLf & " AND CATEGORY='" & pCategory & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckPartyWiseBillExp = True
        Else
            CheckPartyWiseBillExp = False
        End If
        Exit Function
ErrPart:
        CheckPartyWiseBillExp = False
    End Function
    Public Function GetExchangeRate(ByRef pPONO As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        SqlStr = " SELECT EXCHANGERATE FROM PUR_PURCHASE_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTO_KEY_PO=" & Val(CStr(pPONO)) & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetExchangeRate = IIf(IsDBNull(RsTemp.Fields("EXCHANGERATE").Value), 1, RsTemp.Fields("EXCHANGERATE").Value)
        Else
            GetExchangeRate = 1
        End If
        Exit Function
ErrPart:
        GetExchangeRate = 1
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetWelfareAmount(ByRef mDate As String, ByRef mPayableWelfareSalary As Double) As Double
        Dim RsCeiling As ADODB.Recordset = Nothing
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim mSqlStr As String
        Dim mCeilingAmount As Double
        Dim mPer As Double
        Dim mWelfareAmount As Double
        GetWelfareAmount = 0
        mSqlStr = ""
        mSqlStr = " SELECT MAX(WEF) FROM PAY_WELFARE_MST" & vbCrLf _
            & " WHERE " & vbCrLf _
            & " COMPANY_CODE= " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND WEF<=TO_DATE('" & VB6.Format(mDate, "dd-mmm-yyyy") & "','DD-MON-YYYY') "

        SqlStr = " SELECT WELFARE_AMOUNT,CEILING_AMOUNT,CEILING_PER FROM PAY_WELFARE_MST " & vbCrLf _
            & " WHERE COMPANY_CODE= " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND WEF=(" & mSqlStr & ") "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsCeiling, ADODB.LockTypeEnum.adLockOptimistic)
        If RsCeiling.EOF = False Then
            mWelfareAmount = IIf(IsDBNull(RsCeiling.Fields("WELFARE_AMOUNT").Value), 0, RsCeiling.Fields("WELFARE_AMOUNT").Value)
            mCeilingAmount = IIf(IsDBNull(RsCeiling.Fields("CEILING_AMOUNT").Value), 0, RsCeiling.Fields("CEILING_AMOUNT").Value)
            mPer = IIf(IsDBNull(RsCeiling.Fields("CEILING_PER").Value), 0, RsCeiling.Fields("CEILING_PER").Value)
            If mCeilingAmount > 0 Then
                mCeilingAmount = IIf(mPayableWelfareSalary > mCeilingAmount, mCeilingAmount, mPayableWelfareSalary) * mPer * 0.01
                GetWelfareAmount = System.Math.Round(mCeilingAmount, 0)
            Else
                GetWelfareAmount = mWelfareAmount ''IIf(IsNull(RsCeiling!WELFARE_AMOUNT), 0, RsCeiling!WELFARE_AMOUNT)
            End If
        End If
        Exit Function
ERR1:
        MsgBox(Err.Description)
    End Function
    Public Function CheckCommonDivision(ByRef pDivCode As Double) As Boolean
        On Error GoTo err_Renamed
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        CheckCommonDivision = False
        SqlStr = " SELECT IS_COMMON_DIV FROM INV_DIVISION_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND DIV_CODE = " & Val(CStr(pDivCode)) & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            CheckCommonDivision = IIf(RsTemp.Fields("IS_COMMON_DIV").Value = "Y", True, False)
        End If
        Exit Function
err_Renamed:
        MsgBox(Err.Description)
    End Function
    Public Function GetSeparateGSTRefund() As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RS As ADODB.Recordset = Nothing
        GetSeparateGSTRefund = "N"
        SqlStr = "SELECT GST_SEPARATE FROM FIN_PRINT_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)
        If RS.EOF = False Then
            GetSeparateGSTRefund = IIf(IsDBNull(RS.Fields("GST_SEPARATE").Value), "N", RS.Fields("GST_SEPARATE").Value)
        End If
        Exit Function
ErrPart:
    End Function
    Public Function GetUserAuthorizedRight(ByRef xXRIGHT As String) As Boolean
        On Error GoTo ErrPart
        GetUserAuthorizedRight = False
        If InStr(xXRIGHT, "S") > 0 Then
            GetUserAuthorizedRight = True
        End If
        Exit Function
ErrPart:
        GetUserAuthorizedRight = False
    End Function
    Public Function GetAttnChangeApproval(ByRef pUserId As String, ByRef pType As String, ByRef pFromDate As String, ByRef pToDate As String) As Boolean
        On Error GoTo ErrPart
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""
        Dim mDate As Integer
        Dim CntDate As Integer
        GetAttnChangeApproval = False
        For CntDate = CInt(pFromDate) To CInt(pToDate)
            mDate = CStr(CntDate)
            SqlStr = " SELECT * FROM PAY_ATTN_CHANGE_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTH_GIVEN_TO='" & MainClass.AllowSingleQuote(pUserId) & "'"
            SqlStr = SqlStr & vbCrLf & " AND FROM_DATE<=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND TO_DATE>=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            If pType = "S" Then
                SqlStr = SqlStr & vbCrLf & " AND CHANGE_SHIFT='Y'"
            ElseIf pType = "A" Then
                SqlStr = SqlStr & vbCrLf & " AND CHANGE_ATTN='Y'"
            ElseIf pType = "M" Then
                SqlStr = SqlStr & vbCrLf & " AND CHANGE_MANNUAL='Y'"
            End If
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                GetAttnChangeApproval = True
                Exit Function
            End If
        Next
        Exit Function
ErrPart:
        GetAttnChangeApproval = False
    End Function
    Public Function AgeYears(ByRef pBirthDate As Date, ByRef pCheckDate As Date) As Short
        ' Comments: Returns the age in years
        ' Params: datBirthDateDate to check
        ' Returns : Number of years
        ' Source: Total Visual SourceBook
        On Error GoTo PROC_ERR
        Dim intYears As Short
        intYears = Year(pCheckDate) - Year(pBirthDate)
        If DateSerial(Year(pCheckDate), Month(pBirthDate), VB.Day(pBirthDate)) > pCheckDate Then
            ' Subtract a year if birthday hasn't arrived this year
            intYears = intYears - 1
        End If
        AgeYears = intYears
PROC_EXIT:
        Exit Function
PROC_ERR:
        MsgBox("Error: " & Err.Number & ". " & Err.Description, , "modDateTime.AgeYears")
        Resume PROC_EXIT
    End Function
    Public Function PeriodinMonth_Days(ByRef pFromDate As String, ByRef pToDate As String) As String
        On Error GoTo PROC_ERR
        Dim pMonth As Integer
        Dim pDays As Integer
        Dim xNewFromDate As String
        Dim xNewToDate As String
        Dim xDate As String
        Dim mLastDay As String
        If VB.Day(CDate(pFromDate)) = 1 Then
            xNewFromDate = pFromDate
        Else
            xNewFromDate = "01/" & VB6.Format(pFromDate, "MM/YYYY")
            xNewFromDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Month, 1, CDate(xNewFromDate)))
            mLastDay = CStr(MainClass.LastDay(Month(CDate(pFromDate)), Year(CDate(pFromDate))))
            pDays = CDbl(mLastDay) - VB.Day(CDate(pFromDate)) + 1
        End If
        mLastDay = CStr(MainClass.LastDay(Month(CDate(pToDate)), Year(CDate(pToDate))))
        If VB.Day(CDate(pToDate)) = CDbl(mLastDay) Then
            xNewToDate = pToDate
        Else
            xNewToDate = mLastDay & "/" & VB6.Format(pToDate, "MM/YYYY")
            xNewToDate = CStr(DateAdd(Microsoft.VisualBasic.DateInterval.Month, -1, CDate(xNewToDate)))
            pDays = pDays + VB.Day(CDate(pToDate))
        End If
        If IsDate(xNewFromDate) And IsDate(xNewToDate) Then
            pMonth = DateDiff(Microsoft.VisualBasic.DateInterval.Month, CDate(xNewFromDate), CDate(xNewToDate)) + 1 + IIf(pDays >= CDbl(mLastDay), 1, 0)
            pDays = pDays - IIf(pDays >= CDbl(mLastDay), mLastDay, 0)
        Else
            PeriodinMonth_Days = ""
            Exit Function
        End If
        'If Month(CDate(xNewFromDate)) > Month(xNewToDate) Then
        'pMonth = pMonth - 1
        'ElseIf Month(CDate(xNewFromDate)) = Month(xNewToDate) And Day(CDate(xNewFromDate)) > (Day(xNewToDate) + 1) Then
        'pMonth = pMonth - 1
        'End If
        ''If Day(CDate(pFromDate)) < (Day(pToDate) + 1) Then
        ''pDays = DateDiff("d", CDate(xDate), pToDate) + 1
        ''End If
        '
        '
        PeriodinMonth_Days = pMonth & "." & VB6.Format(pDays, "00")
        System.Windows.Forms.Application.DoEvents()
        'Dim intMonths As Integer
        '
        'intYears = Year(pCheckDate) - Year(pBirthDate)
        '
        'If DateSerial(Year(pCheckDate), Month(pBirthDate), Day(pBirthDate)) > pCheckDate Then
        '' Subtract a year if birthday hasn't arrived this year
        'intYears = intYears - 1
        'End If
        '
        'AgeYears = intYears
PROC_EXIT:
        Exit Function
PROC_ERR:
        MsgBox("Error: " & Err.Number & ". " & Err.Description, , "modDateTime.AgeYears")
        Resume PROC_EXIT
    End Function
    Public Function GetLUT(ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsLUT As ADODB.Recordset = Nothing
        GetLUT = ""
        SqlStr = " SELECT NAME FROM FIN_LUT_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF = (" & vbCrLf & " SELECT MAX(WEF) FROM FIN_LUT_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF <=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsLUT, ADODB.LockTypeEnum.adLockReadOnly)
        If RsLUT.EOF = False Then
            GetLUT = IIf(IsDBNull(RsLUT.Fields("NAME").Value), "", RsLUT.Fields("NAME").Value)
        End If
        Exit Function
ErrPart:
        GetLUT = ""
    End Function
    Public Function GetChapterVISlab(ByRef pChapterType As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RSVIA As ADODB.Recordset = Nothing
        Dim mFieldName As String
        GetChapterVISlab = 0
        If pChapterType = "80D" Then
            mFieldName = "SLAB_80D"
        ElseIf pChapterType = "80G" Then
            mFieldName = "SLAB_80G"
        ElseIf pChapterType = "80CCF" Then
            mFieldName = "SLAB_80CCF"
        Else
            mFieldName = "SLAB_80C"
        End If
        SqlStr = " SELECT " & mFieldName & " AS FIELD_VALUE " & vbCrLf & " FROM PAY_VIA_SLAB_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF_DATE = (" & vbCrLf & " SELECT MAX(WEF_DATE) FROM PAY_VIA_SLAB_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF_DATE <=TO_DATE('" & VB6.Format(RsCompany.Fields("Start_Date").Value, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RSVIA, ADODB.LockTypeEnum.adLockReadOnly)
        If RSVIA.EOF = False Then
            GetChapterVISlab = CDbl(VB6.Format(IIf(IsDBNull(RSVIA.Fields("FIELD_VALUE").Value), "0.00", RSVIA.Fields("FIELD_VALUE").Value)))
        End If
        Exit Function
ErrPart:
        GetChapterVISlab = 0
    End Function
    Public Function GetFileExtension(ByRef pFileName As String) As String
        Dim I As Short
        GetFileExtension = ""
        I = Len(pFileName)
        While Mid(pFileName, I, 1) <> "."
            I = I - 1
            If I = 0 Then
                MsgBox("No extension specified...", MsgBoxStyle.Critical, "Error")
                Exit Function
            End If
        End While
        GetFileExtension = Right(pFileName, Len(pFileName) - I)
    End Function
    'Public Function regQuery_A_Key(ByVal hKey As Integer, ByVal sRegKeyPath As String, ByVal sRegSubKey As String) As Object
    '    Dim iPos As Short
    '    Dim lKeyHandle As Integer
    '    Dim lRet As Integer
    '    Dim lDataType As Integer
    '    Dim lBufferSize As Integer
    '    Dim lBuffer As Integer
    '    Dim sBuffer As String
    '    Dim arBuffer() As Byte
    '    lKeyHandle = 0
    '    lBufferSize = 0
    '    lRet = RegOpenKey(hKey, sRegKeyPath, lKeyHandle)
    '    If lKeyHandle = 0 Then
    '        regQuery_A_Key = ""
    '        lRet = RegCloseKey(lKeyHandle)
    '        Exit Function
    '    End If
    '    lRet = RegQueryValueEx(lKeyHandle, sRegSubKey, 0, lDataType, CStr(0), lBufferSize)
    '    If lKeyHandle = 0 Then
    '        regQuery_A_Key = ""
    '        lRet = RegCloseKey(lKeyHandle)
    '        Exit Function
    '    End If
    '    Select Case lDataType
    '        Case REG_SZ ' String data (most common)
    '            ' Preload the receiving buffer area
    '            sBuffer = Space(lBufferSize)
    '            lRet = RegQueryValueEx(lKeyHandle, sRegSubKey, 0, 0, sBuffer, lBufferSize)
    '            ' If NOT a successful call then leave
    '            If lRet <> ERROR_SUCCESS Then
    '                regQuery_A_Key = ""
    '            Else
    '                ' Strip out the string data
    '                iPos = InStr(1, sBuffer, Chr(0))
    '                ' look for the first null char
    '                If iPos > 0 Then
    '                    ' if we found one, then save everything
    '                    'up to that point
    '                    regQuery_A_Key = Left(sBuffer, iPos - 1)
    '                Else
    '                    ' did not find one.Save everything.
    '                    regQuery_A_Key = sBuffer
    '                End If
    '            End If
    '        Case REG_DWORD ' Numeric data (Integer)
    '            lRet = RegQueryValueEx(lKeyHandle, sRegSubKey, 0, lDataType, CStr(lBuffer), 4)
    '            ' 4& = 4-byte word (long integer)
    '            ' If NOT a successful call then leave
    '            If lRet <> ERROR_SUCCESS Then
    '                regQuery_A_Key = ""
    '            Else
    '                ' Save the captured data
    '                regQuery_A_Key = lBuffer
    '            End If
    '        Case Else ' unknown
    '            regQuery_A_Key = ""
    '    End Select
    '    lRet = RegCloseKey(lKeyHandle)
    'End Function
    Public Function StringReplace(ByRef pString1 As String, ByRef pString2 As String, ByRef pString3 As String) As Boolean
        Dim I As Short
        Dim lString As String
        StringReplace = False
        lString = pString1
        I = InStr(1, lString, pString2)
        While I <> 0
            StringReplace = True
            If I + Len(pString2) <= Len(lString) Then
                lString = Left(lString, I - 1) & pString3 & Right(lString, Len(lString) - I - Len(pString2) + 1)
            Else
                lString = Left(lString, I - 1) & pString3
            End If
            I = InStr(1, lString, pString2)
        End While
        pString1 = lString
    End Function
    Public Function GetNearestShiftTime(ByRef pINTime As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mDate1 As String = ""
        Dim mDateDiff1 As Double
        Dim mDate2 As String
        Dim mDateDiff2 As Double
        Dim xDate As String
        GetNearestShiftTime = ""
        'pInTime = "08:45"
        SqlStr = " SELECT TO_CHAR(FROM_TIME,'HH24:MI') FROM_TIME" & vbCrLf & " FROM PAY_SHIFT_MST " & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TO_CHAR(FROM_TIME,'HH24:MI') = (" & vbCrLf & " SELECT MIN(TO_CHAR(FROM_TIME,'HH24:MI')) " & vbCrLf & " FROM PAY_SHIFT_MST " & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TO_CHAR(FROM_TIME,'HH24:MI')>='" & VB6.Format(pINTime, "HH:mm") & "')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mDate1 = IIf(IsDBNull(RsTemp.Fields("FROM_TIME").Value), "", RsTemp.Fields("FROM_TIME").Value)
            xDate = VB6.Format(pINTime, "DD/MM/YYYY") & " " & VB6.Format(mDate1, "HH:mm")
            mDateDiff1 = DateDiff(Microsoft.VisualBasic.DateInterval.Minute, CDate(pINTime), CDate(xDate)) ''mDate1 - pInTime
            GetNearestShiftTime = mDate1
        End If
        SqlStr = " SELECT TO_CHAR(FROM_TIME,'HH24:MI') FROM_TIME" & vbCrLf & " FROM PAY_SHIFT_MST " & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TO_CHAR(FROM_TIME,'HH24:MI') = (" & vbCrLf & " SELECT MAX(TO_CHAR(FROM_TIME,'HH24:MI')) " & vbCrLf & " FROM PAY_SHIFT_MST " & vbCrLf & " WHERE COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND TO_CHAR(FROM_TIME,'HH24:MI')<='" & VB6.Format(pINTime, "HH:mm") & "')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mDate2 = IIf(IsDBNull(RsTemp.Fields("FROM_TIME").Value), "", RsTemp.Fields("FROM_TIME").Value)
            xDate = VB6.Format(pINTime, "DD/MM/YYYY") & " " & VB6.Format(mDate2, "HH:mm")
            mDateDiff2 = DateDiff(Microsoft.VisualBasic.DateInterval.Minute, CDate(xDate), CDate(pINTime)) ''mDate1 - pInTime
            If mDate1 = "" Then
                GetNearestShiftTime = xDate
            ElseIf mDateDiff2 < mDateDiff1 Then
                GetNearestShiftTime = xDate
            End If
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetOTRateFromSlab(ByRef xCode As String, ByRef xRunDate As String, ByRef mESIApp As Boolean, ByRef mBasicSalary As Double, ByRef mESIRound As Double, ByRef IsArrear As Boolean) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsOTRate As ADODB.Recordset = Nothing
        Dim mRound As String
        Dim mGrossSalary As Double
        Dim mDesgCode As String
        Dim RsOTTRN As ADODB.Recordset = Nothing
        Dim mOTDate As String
        Dim mOTHours As Double
        GetOTRateFromSlab = 0
        mBasicSalary = 0
        mESIApp = False
        If IsArrear = True Then
            Exit Function
        End If
        ''Manager or Director then exit function dt. 15-09-2006.............
        If MainClass.ValidateWithMasterTable(xCode, "EMP_CODE", "EMP_DESG_CODE", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mDesgCode = Trim(MasterNo)
            If MainClass.ValidateWithMasterTable(mDesgCode, "DESG_CODE", "DESG_CAT", "PAY_DESG_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND DESG_CAT IN ('D','M')") = True Then
                Exit Function
            End If
        End If
        SqlStr = " SELECT OT_DATE, " & vbCrLf & " SUM(OT.OTHOUR) AS OTHOUR, SUM(OT.PREV_OTHOUR) AS PREV_OTHOUR , SUM(OT.OTMIN) AS OTMIN, SUM(OT.PREV_OTMIN)AS PREV_OTMIN " & vbCrLf & " FROM PAY_OVERTIME_MST OT " & vbCrLf & " WHERE " & vbCrLf & " OT.COMPANY_CODE =" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND OT.EMP_CODE = '" & MainClass.AllowSingleQuote(xCode) & "'" & vbCrLf & " AND TO_CHAR(OT.OT_DATE,'MON-YYYY')='" & UCase(VB6.Format(xRunDate, "MMM-YYYY")) & "'" & vbCrLf & " GROUP BY OT_DATE"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOTTRN, ADODB.LockTypeEnum.adLockOptimistic)
        If RsOTTRN.EOF = False Then
            Do While RsOTTRN.EOF = False
                mOTDate = VB6.Format(IIf(IsDBNull(RsOTTRN.Fields("OT_DATE").Value), "", RsOTTRN.Fields("OT_DATE").Value), "DD/MM/YYYY")
                mOTHours = IIf(IsDBNull(RsOTTRN.Fields("OTHOUR").Value), 0, RsOTTRN.Fields("OTHOUR").Value) + (IIf(IsDBNull(RsOTTRN.Fields("OTMIN").Value), 0, RsOTTRN.Fields("OTMIN").Value)) / 60
                'mOTHours = mOTHours * 2
                SqlStr = " SELECT SNACKS_AMT AS AMOUNT " & vbCrLf & " FROM PAY_OTSNACKS_MST" & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF=(SELECT MAX(WEF) From PAY_OTSNACKS_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF<= TO_DATE('" & VB6.Format(mOTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')) "
                SqlStr = SqlStr & vbCrLf & " AND MINLIMIT <=" & mOTHours & "" & vbCrLf & " AND MAXLIMIT >=" & mOTHours & ""
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsOTRate, ADODB.LockTypeEnum.adLockOptimistic)
                If RsOTRate.EOF = False Then
                    GetOTRateFromSlab = GetOTRateFromSlab + IIf(IsDBNull(RsOTRate.Fields("Amount").Value), 0, RsOTRate.Fields("Amount").Value)
                End If
                RsOTTRN.MoveNext()
            Loop
        End If
        Exit Function
ErrPart:
        GetOTRateFromSlab = 0
        mBasicSalary = 0
        mESIApp = False
    End Function
    Public Function GetMaxRebate(ByRef pCalcField As Object) As Double
        On Error GoTo ErrPart1
        Dim SqlStr As String = ""
        Dim RSTempDetail As ADODB.Recordset = Nothing
        GetMaxRebate = 0
        SqlStr = " Select " & pCalcField & " AS TOTALAMOUNT " & vbCrLf & " FROM PAY_VIA_SLAB_MST " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF_DATE=(" & vbCrLf & " SELECT MAX(WEF_DATE) " & vbCrLf & " FROM PAY_VIA_SLAB_MST " & vbCrLf & " WHERE " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND WEF_DATE<=TO_DATE('" & VB6.Format(RsCompany.Fields("Start_Date").Value, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RSTempDetail, ADODB.LockTypeEnum.adLockReadOnly)
        If RSTempDetail.EOF = False Then
            GetMaxRebate = CDbl(VB6.Format(IIf(IsDBNull(RSTempDetail.Fields("TOTALAMOUNT").Value), 0, RSTempDetail.Fields("TOTALAMOUNT").Value), "0.00"))
        End If
        Exit Function
ErrPart1:
        GetMaxRebate = 0
    End Function
    Public Function GetWIPMaxQty(ByRef pProdCode As String, ByRef pDeptCode As String, ByRef pDate As String) As Double
        On Error GoTo ERR1
        Dim I As Integer
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTempRate As ADODB.Recordset
        GetWIPMaxQty = 0
        If Trim(pProdCode) = "" Then
            Exit Function
        End If
        If Trim(pDeptCode) = "" Then
            Exit Function
        End If
        SqlStr = ""
        SqlStr = " SELECT IH.MIN_QTY, IH.MAX_QTY " & vbCrLf & " FROM PRD_PRODSEQUENCE_DET IH " & vbCrLf & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & vbCrLf & " AND IH.PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProdCode) & "' AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "' "
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF= ( " & vbCrLf & " SELECT MAX(WEF) FROM PRD_PRODSEQUENCE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & vbCrLf & " AND PRODUCT_CODE='" & MainClass.AllowSingleQuote(pProdCode) & "' AND DEPT_CODE='" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        If Trim(pDate) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND WEF<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If
        SqlStr = SqlStr & vbCrLf & ")"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetWIPMaxQty = IIf(IsDBNull(RsTemp.Fields("MAX_QTY").Value), 0, RsTemp.Fields("MAX_QTY").Value)
        End If
        Exit Function
ERR1:
        MsgBox(Err.Description)
    End Function
    Public Function AutoGenSeqSaleBillNo(ByRef pPurchaseType As String) As String
        On Error GoTo AutoGenSeqBillNoErr
        Dim RsSaleMainGen As ADODB.Recordset = Nothing
        Dim mNewSeqBillNo As Integer
        Dim mStartingSNo As Double
        Dim mSeparateSeries As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mInvoiceSeq As Integer
        Dim SqlStr As String = ""
        Dim pStartingSNo As Double
        SqlStr = ""
        If pPurchaseType = "G" Then
            mInvoiceSeq = 7
        ElseIf pPurchaseType = "J" Then
            mInvoiceSeq = 8
        ElseIf pPurchaseType = "S" Then
            mInvoiceSeq = 9
        End If
        pStartingSNo = 1
        mStartingSNo = CDbl(VB6.Format(IIf(IsDBNull(RsCompany.Fields("INVOICE_PREFIX").Value), "", RsCompany.Fields("INVOICE_PREFIX").Value), "00") & Val(CStr(mInvoiceSeq)) & VB6.Format(pStartingSNo, "00000"))
        SqlStr = ""
        SqlStr = "SELECT Max(SALEBILLNOSEQ) FROM FIN_PURCHASE_HDR " & vbCrLf & " WHERE Company_Code=" & RsCompany.Fields("Company_Code").Value & " " & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " "
        SqlStr = SqlStr & vbCrLf & " AND PURCHASE_TYPE='" & pPurchaseType & "'"
        SqlStr = SqlStr & vbCrLf & " AND SALEBILLDATE>=TO_DATE('" & VB6.Format(PubGSTApplicableDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsSaleMainGen, ADODB.LockTypeEnum.adLockReadOnly)
        With RsSaleMainGen
            If .EOF = False Then
                If Not IsDBNull(.Fields(0).Value) Then
                    mNewSeqBillNo = .Fields(0).Value + 1
                Else
                    mNewSeqBillNo = mStartingSNo
                End If
            Else
                mNewSeqBillNo = mStartingSNo
            End If
        End With
        AutoGenSeqSaleBillNo = CStr(mNewSeqBillNo)
        Exit Function
AutoGenSeqBillNoErr:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetSBData(ByRef pSBNo As Double, ByRef pProductCode As String, ByRef mItemRate As Double) As Boolean
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        GetSBData = False
        mItemRate = 0
        SqlStr = "SELECT ITEM_RATE" & vbCrLf & " FROM PRD_REWORK_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND AUTO_KEY_SBRWK=" & pSBNo & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pProductCode) & "'" & vbCrLf & " AND REF_TYPE = '" & ConStockRefType_RWK & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mItemRate = CDbl(VB6.Format(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), 0, RsTemp.Fields("ITEM_RATE").Value), "0.00"))
        End If
        GetSBData = True
        Exit Function
ERR1:
        GetSBData = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    'Public Function EncodeBase64(ByRef arrData() As Byte) As String
    '
    '
    '
    'Dim objXML As MSXML2.DOMDocument60''DOMDocument
    'Dim objNode As MSXML2.IXMLDOMElement
    '
    '' help from MSXML
    'Set objXML = New MSXML2.DOMDocument60 ''IXMLDOMElement
    '
    '' byte array to base64
    'Set objNode = objXML.createElement("b64")
    'objNode.DataType = "bin.base64"
    'objNode.nodeTypedValue = arrData
    'EncodeBase64 = objNode.Text
    '
    '
    '
    '' thanks, bye
    'Set objNode = Nothing
    'Set objXML = Nothing
    '
    '
    '
    'End Function
    '
    '
    '
    'Public Function DecodeBase64(ByVal strData As String) As Byte()
    '
    '
    '
    'Dim objXML As MSXML2.DOMDocument60''DOMDocument
    'Dim objNode As MSXML2.IXMLDOMElement
    '
    '' help from MSXML
    'Set objXML = New MSXML2.DOMDocument60''DOMDocument
    'Set objNode = objXML.createElement("b64")
    'objNode.DataType = "bin.base64"
    'objNode.Text = strData
    'DecodeBase64 = objNode.nodeTypedValue
    '
    '' thanks, bye
    'Set objNode = Nothing
    'Set objXML = Nothing
    '
    '
    '
    'End Function
    '    Public Function EncodePdf417(ByRef Chaine As String, Optional ByRef scu As Short = 0, Optional ByRef nbcol As Short = 0, Optional ByRef CodeErr As Short = 0) As Object
    '        'V 1.5.0
    '        'Paramtres : Une chaine  encoder
    '        ' Le niveau de correction souhait, -1 = automatique.
    '        ' Le nombre de colonnes de MC de donnes souhait, -1 = automatique
    '        ' Une variable qui pourra rcuprer un numro d'erreur
    '        'Retour : * une chaine qui, affiche avec la police PDF417.TTF, donne le code barre
    '        ' * une chaine vide si paramtre fourni incorrect
    '        ' * Scu% contient le niveau de correction effectif
    '        ' * NbCol% contient le nombre de colonnes de MC de donnes effectif
    '        ' * Codeerr% contient 0 si pas d'erreur, sinon :
    '        ' 0 : Pas d'erreur
    '        ' 1: Chaine$ est vide
    '        ' 2: Chaine$ contient trop de donnes, on dpasse le nombre de 928 MC.
    '        ' 3: Nombre de MC par ligne trop faible, on dpasse 90 lignes.
    '        ' 10 : Le niveau de scurit a t abaiss pour ne pas dpasser les 928 MC.
    '        'Parameters : The string to encode.
    '        ' The hoped scurity level, -1 = automatic.
    '        ' The hoped number of data MC columns, -1 = automatic.
    '        ' A variable which will can retrieve an error number.
    '        'Return : * a string which, printed with the PDF417.TTF font, gives the bar code.
    '        ' * an empty string if the given parameters aren't good.
    '        ' * scu% contain le really used scurity level.
    '        ' * NbCol% contain the really used number of data CW columns.
    '        ' * Codeerr% is 0 if no error occured, else :
    '        ' 0: No error
    '        ' 1: Chaine$ is empty
    '        ' 2: Chaine$ contain too many datas, we go beyong the 928 CWs.
    '        ' 3: Number of CWs per row too small, we go beyong 90 rows.
    '        ' 10 : The scurity level has being lowers not to exceed the 928 CWs. (It's not an error, only a warning.)
    '        'Variables gnrales / Global variables
    '        Dim k, I, j, IndexChaine As Object
    '        Dim Dummy As Object
    '        Dim flag As Boolean
    '        'Dcoupage en blocs / Splitting into blocks
    '        Dim Liste() As Object
    '        Dim IndexListe As Object
    '        'Compactage des donnes / Data compaction
    '        Dim Longueur As Object
    '        Dim ChaineMC As Object
    '        Dim Total As Object
    '        'Traitement du mode "texte" / "text" mode processing
    '        Dim ListeT() As Object
    '        Dim CurTable, IndexListeT, NewTable As Object
    '        Dim ChaineT As Object
    '        'Codes de Reed Solomon / Reed Solomon codes
    '        Dim MCcorrection() As Object
    '        'MC de cots gauche et droit / Left and right side CWs
    '        Dim C2, C1, C3 As Object
    '        'Sous programme QuelMode / Sub routine QuelMode
    '        Dim Mode, CodeASCII As Object
    '        'Sous programme Modulo / Sub routine Modulo
    '        Dim ChaineMod, ChaineMult As Object
    '        Dim Diviseur, Nombre As Object
    '        'Tables
    '        Dim ASCII As Object
    '        'Cette chaine dcrit le code ASCII pour le mode "texte".
    '        'ASCII$ contient 95 champs de 4 chiffres correspondant aux car. de valeur ASCII 32  126. Les champs sont :
    '        '2 chiffres indiquant la ou les tables o se trouvent ce car. (Tables numrotes 1, 2, 4 et 8)
    '        '2 chiffres indiquant le N du car. dans la table
    '        'Ex. 0726 en dbut de chaine : le car. de code 32 est dans les tables 1, 2 et 4  la ligne 26
    '        '
    '        'This string describe the ASCII code for the "text" mode.
    '        'ASCII$ contain 95 fields of 4 digits which correspond to char. ASCII values 32 to 126. These fields are :
    '        '2 digits indicating the table(s) (1 or several) where this char. is located. (Table numbers : 1, 2, 4 and 8)
    '        '2 digits indicating the char. number in the table
    '        'Sample : 0726 at the beginning of the string : The Char. having code 32 is in the tables 1, 2 and 4 at row 26
    '        ASCII = "07260810082004151218042104100828082308241222042012131216121712190400040104020403040404050406040704080409121408000801042308020825080301000101010201030104010501060107010801090110011101120113011401150116011701180119012001210122012301240125080408050806042408070808020002010202020302040205020602070208020902100211021202130214021502160217021802190220022102220223022402250826082108270809"
    '        Dim CoefRS(8) As String
    '        'CoefRS$ contient 8 chaines reprsentant les coefficients sur 3 chiffres des polynomes de calcul des codes de reed Solomon
    '        'CoefRS$ contain 8 strings describing the factors of the polynomial equations for the reed Solomon codes.
    '        CoefRS(0) = "027917"
    '        CoefRS(1) = "522568723809"
    '        CoefRS(2) = "237308436284646653428379"
    '        CoefRS(3) = "274562232755599524801132295116442428295042176065"
    '        CoefRS(4) = "361575922525176586640321536742677742687284193517273494263147593800571320803133231390685330063410"
    '        CoefRS(5) = "539422006093862771453106610287107505733877381612723476462172430609858822543376511400672762283184440035519031460594225535517352605158651201488502648733717083404097280771840629004381843623264543"
    '        CoefRS(6) = "521310864547858580296379053779897444400925749415822093217208928244583620246148447631292908490704516258457907594723674292272096684432686606860569193219129186236287192775278173040379712463646776171491297763156732095270447090507048228821808898784663627378382262380602754336089614087432670616157374242726600269375898845454354130814587804034211330539297827865037517834315550086801004108539"
    '        CoefRS(7) = "524894075766882857074204082586708250905786138720858194311913275190375850438733194280201280828757710814919089068569011204796605540913801700799137439418592668353859370694325240216257284549209884315070329793490274877162749812684461334376849521307291803712019358399908103511051008517225289470637731066255917269463830730433848585136538906090002290743199655903329049802580355588188462010134628320479130739071263318374601192605142673687234722384177752607640455193689707805641048060732621895544261852655309697755756060231773434421726528503118049795032144500238836394280566319009647550073914342126032681331792620060609441180791893754605383228749760213054297134054834299922191910532609829189020167029872449083402041656505579481173404251688095497555642543307159924558648055497010"
    '        CoefRS(8) = "352077373504035599428207409574118498285380350492197265920155914299229643294871306088087193352781846075327520435543203666249346781621640268794534539781408390644102476499290632545037858916552041542289122272383800485098752472761107784860658741290204681407855085099062482180020297451593913142808684287536561076653899729567744390513192516258240518794395768848051610384168190826328596786303570381415641156237151429531207676710089168304402040708575162864229065861841512164477221092358785288357850836827736707094008494114521002499851543152729771095248361578323856797289051684466533820669045902452167342244173035463651051699591452578037124298332552043427119662777475850764364578911283711472420245288594394511327589777699688043408842383721521560644714559062145873663713159672729"
    '        CoefRS(8) = CoefRS(8) & "624059193417158209563564343693109608563365181772677310248353708410579870617841632860289536035777618586424833077597346269757632695751331247184045787680018066407369054492228613830922437519644905789420305441207300892827141537381662513056252341242797838837720224307631061087560310756665397808851309473795378031647915459806590731425216548249321881699535673782210815905303843922281073469791660162498308155422907817187062016425535336286437375273610296183923116667751353062366691379687842037357720742330005039923311424242749321054669316342299534105667488640672576540316486721610046656447171616464190531297321762752533175134014381433717045111020596284736138646411877669141919045780407164332899165726600325498655357752768223849647063310863251366304282738675410389244031121303263"
    '        Dim CodageMC(2) As String
    '        'CodageMC$ contient les 3 jeux des 929 MC. Chaque MC est reprsent dans la police PDF417.TTF par 3 lettres composant 3 fois 5 bits. Le premier bit toujours  1
    '        ' et le dernier toujours  0 se trouvent dans le caractre sparateur.
    '        'CodageMC$ contain the 3 sets of the 929 MCs. Each MC is described in the PDF417.TTF font by 3 char. composing 3 time 5 bits. The first bit which is always 1
    '        ' and the last one which is always 0 are into the separator character.
    '        CodageMC(0) = "urAxfsypyunkxdwyozpDAulspBkeBApAseAkprAuvsxhypnkutwxgzfDAplsfBkfrApvsuxyfnkptwuwzflspsyfvspxyftwpwzfxyyrxufkxFwymzonAudsxEyolkucwdBAoksucidAkokgdAcovkuhwxazdnAotsugydlkoswugjdksosidvkoxwuizdtsowydswowjdxwoyzdwydwjofAuFsxCyodkuEwxCjclAocsuEickkocgckcckEcvAohsuayctkogwuajcssogicsgcsacxsoiycwwoijcwicyyoFkuCwxBjcdAoEsuCicckoEguCbcccoEaccEoEDchkoawuDjcgsoaicggoabcgacgDobjcibcFAoCsuBicEkoCguBbcEcoCacEEoCDcECcascagcaacCkuAroBaoBDcCBtfkwpwyezmnAtdswoymlktcwwojFBAmksFAkmvkthwwqzFnAmtstgyFlkmswFksFkgFvkmxwtizFtsmwyFswFsiFxwmyzFwyFyzvfAxpsyuyvdkxowyujqlAvcsxoiqkkvcgxobqkcvcamfAtFswmyqvAmdktEwwmjqtkvgwxqjhlAEkkmcgtEbhkkqsghkcEvAmhstayhvAEtkmgwtajhtkqwwvijhssEsghsgExsmiyhxsEwwmijhwwqyjhwiEyyhyyEyjhyjvFkxmwytjqdAvEsxmiqckvEgxmbqccvEaqcEqcCmFktCwwljqhkmEstCigtAEckvaitCbgskEccmEagscqgamEDEcCEhkmawtDjgxkEgsmaigwsqiimabgwgEgaEgDEiwmbjgywEiigyiEibgybgzjqFAvCsxliqEkvCgxlbqEcvCaqEEvCDqECqEBEFAmCstBighAEEkmCgtBbggkqagvDbggcEEEmCDggEqaDgg"
    '        CodageMC(0) = CodageMC(0) & "CEasmDigisEagmDbgigqbbgiaEaDgiDgjigjbqCkvBgxkrqCcvBaqCEvBDqCCqCBECkmBgtArgakECcmBagacqDamBDgaEECCgaCECBEDggbggbagbDvAqvAnqBBmAqEBEgDEgDCgDBlfAspsweyldksowClAlcssoiCkklcgCkcCkECvAlhssqyCtklgwsqjCsslgiCsgCsaCxsliyCwwlijCwiCyyCyjtpkwuwyhjndAtoswuincktogwubncctoancEtoDlFksmwwdjnhklEssmiatACcktqismbaskngglEaascCcEasEChklawsnjaxkCgstrjawsniilabawgCgaawaCiwlbjaywCiiayiCibCjjazjvpAxusyxivokxugyxbvocxuavoExuDvoCnFAtmswtirhAnEkxviwtbrgkvqgxvbrgcnEEtmDrgEvqDnEBCFAlCssliahACEklCgslbixAagknagtnbiwkrigvrblCDiwcagEnaDiwECEBCaslDiaisCaglDbiysaignbbiygrjbCaDaiDCbiajiCbbiziajbvmkxtgywrvmcxtavmExtDvmCvmBnCktlgwsrraknCcxtrracvnatlDraEnCCraCnCBraBCCklBgskraakCCclBaiikaacnDalBDiicrbaCCCiiEaaCCCBaaBCDglBrabgCDaijgabaCDDijaabDCDrijrvlcxsqvlExsnvlCvlBnBctkqrDcnBEtknrDEvlnrDCnBBrDBCBclAqaDcCBElAnibcaDEnBnibErDnCBBibCaDBibBaDqibqibnxsfvkltkfnAmnAlCAoaBoiDoCAlaBlkpkBdAkosBckkogsebBcckoaBcEkoDBhkkqwsfjBgskqiBggkqbBgaBgDBiwkrjBiiBibBjjlpAsuswhil"
    '        CodageMC(0) = CodageMC(0) & "oksuglocsualoEsuDloCBFAkmssdiDhABEksvisdbDgklqgsvbDgcBEEkmDDgElqDBEBBaskniDisBagknbDiglrbDiaBaDBbiDjiBbbDjbtukwxgyirtucwxatuEwxDtuCtuBlmkstgnqklmcstanqctvastDnqElmCnqClmBnqBBCkklgDakBCcstrbikDaclnaklDbicnraBCCbiEDaCBCBDaBBDgklrDbgBDabjgDbaBDDbjaDbDBDrDbrbjrxxcyyqxxEyynxxCxxBttcwwqvvcxxqwwnvvExxnvvCttBvvBllcssqnncllEssnrrcnnEttnrrEvvnllBrrCnnBrrBBBckkqDDcBBEkknbbcDDEllnjjcbbEnnnBBBjjErrnDDBjjCBBqDDqBBnbbqDDnjjqbbnjjnxwoyyfxwmxwltsowwfvtoxwvvtmtslvtllkossfnlolkmrnonlmlklrnmnllrnlBAokkfDBolkvbDoDBmBAljbobDmDBljbmbDljblDBvjbvxwdvsuvstnkurlurltDAubBujDujDtApAAokkegAocAoEAoCAqsAqgAqaAqDAriArbkukkucshakuEshDkuCkuBAmkkdgBqkkvgkdaBqckvaBqEkvDBqCAmBBqBAngkdrBrgkvrBraAnDBrDAnrBrrsxcsxEsxCsxBktclvcsxqsgnlvEsxnlvCktBlvBAlcBncAlEkcnDrcBnEAlCDrEBnCAlBDrCBnBAlqBnqAlnDrqBnnDrnwyowymwylswotxowyvtxmswltxlksosgfltoswvnvoltmkslnvmltlnvlAkokcfBloksvDnoBlmAklbroDnmBllbrmDnlAkvBlvDnvbrvyzeyzdwyexyuwydxytswetwuswdvxutwtvxtkselsuksdntulstrvu"
    '        CodageMC(1) = "ypkzewxdAyoszeixckyogzebxccyoaxcEyoDxcCxhkyqwzfjutAxgsyqiuskxggyqbuscxgausExgDusCuxkxiwyrjptAuwsxiipskuwgxibpscuwapsEuwDpsCpxkuywxjjftApwsuyifskpwguybfscpwafsEpwDfxkpywuzjfwspyifwgpybfwafywpzjfyifybxFAymszdixEkymgzdbxEcymaxEEymDxECxEBuhAxasyniugkxagynbugcxaaugExaDugCugBoxAuisxbiowkuigxbbowcuiaowEuiDowCowBdxAoysujidwkoygujbdwcoyadwEoyDdwCdysozidygozbdyadyDdzidzbxCkylgzcrxCcylaxCEylDxCCxCBuakxDgylruacxDauaExDDuaCuaBoikubgxDroicubaoiEubDoiCoiBcykojgubrcycojacyEojDcyCcyBczgojrczaczDczrxBcykqxBEyknxBCxBBuDcxBquDExBnuDCuDBobcuDqobEuDnobCobBcjcobqcjEobncjCcjBcjqcjnxAoykfxAmxAluBoxAvuBmuBloDouBvoDmoDlcbooDvcbmcblxAexAduAuuAtoBuoBtwpAyeszFiwokyegzFbwocyeawoEyeDwoCwoBthAwqsyfitgkwqgyfbtgcwqatgEwqDtgCtgBmxAtiswrimwktigwrbmwctiamwEtiDmwCmwBFxAmystjiFwkmygtjbFwcmyaFwEmyDFwCFysmziFygmzbFyaFyDFziFzbyukzhghjsyuczhahbwyuEzhDhDyyuCyuBwmkydgzErxqkwmczhrxqcyvaydDxqEwmCxqCwmBxqBtakwngydrviktacwnavicxrawnDviEtaCviCtaBviBmiktbgwnrqykmictb"
    '        CodageMC(1) = CodageMC(1) & "aqycvjatbDqyEmiCqyCmiBqyBEykmjgtbrhykEycmjahycqzamjDhyEEyChyCEyBEzgmjrhzgEzahzaEzDhzDEzrytczgqgrwytEzgngnyytCglzytBwlcycqxncwlEycnxnEytnxnCwlBxnBtDcwlqvbctDEwlnvbExnnvbCtDBvbBmbctDqqjcmbEtDnqjEvbnqjCmbBqjBEjcmbqgzcEjEmbngzEqjngzCEjBgzBEjqgzqEjngznysozgfgfyysmgdzyslwkoycfxloysvxlmwklxlltBowkvvDotBmvDmtBlvDlmDotBvqbovDvqbmmDlqblEbomDvgjoEbmgjmEblgjlEbvgjvysegFzysdwkexkuwkdxkttAuvButAtvBtmBuqDumBtqDtEDugbuEDtgbtysFwkFxkhtAhvAxmAxqBxwekyFgzCrwecyFaweEyFDweCweBsqkwfgyFrsqcwfasqEwfDsqCsqBliksrgwfrlicsraliEsrDliCliBCykljgsrrCycljaCyEljDCyCCyBCzgljrCzaCzDCzryhczaqarwyhEzananyyhCalzyhBwdcyEqwvcwdEyEnwvEyhnwvCwdBwvBsncwdqtrcsnEwdntrEwvntrCsnBtrBlbcsnqnjclbEsnnnjEtrnnjClbBnjBCjclbqazcCjElbnazEnjnazCCjBazBCjqazqCjnaznzioirsrfyziminwrdzzililyikzygozafafyyxozivivyadzyxmyglitzyxlwcoyEfwtowcmxvoyxvwclxvmwtlxvlslowcvtnoslmvrotnmsllvrmtnlvrllDoslvnbolDmrjonbmlDlrjmnblrjlCbolDvajoCbmizoajmCblizmajlizlCbvajvzieifwrFzzididyiczygeaFzywuy"
    '        CodageMC(1) = CodageMC(1) & "gdihzywtwcewsuwcdxtuwstxttskutlusktvnutltvntlBunDulBtrbunDtrbtCDuabuCDtijuabtijtziFiFyiEzygFywhwcFwshxsxskhtkxvlxlAxnBxrDxCBxaDxibxiCzwFcyCqwFEyCnwFCwFBsfcwFqsfEwFnsfCsfBkrcsfqkrEsfnkrCkrBBjckrqBjEkrnBjCBjBBjqBjnyaozDfDfyyamDdzyalwEoyCfwhowEmwhmwElwhlsdowEvsvosdmsvmsdlsvlknosdvlroknmlrmknllrlBboknvDjoBbmDjmBblDjlBbvDjvzbebfwnpzzbdbdybczyaeDFzyiuyadbhzyitwEewguwEdwxuwgtwxtscustuscttvustttvtklulnukltnrulntnrtBDuDbuBDtbjuDbtbjtjfsrpyjdwrozjcyjcjzbFbFyzjhjhybEzjgzyaFyihyyxwEFwghwwxxxxschssxttxvvxkkxllxnnxrrxBBxDDxbbxjFwrmzjEyjEjbCzjazjCyjCjjBjwCowCmwClsFowCvsFmsFlkfosFvkfmkflArokfvArmArlArvyDeBpzyDdwCewauwCdwatsEushusEtshtkdukvukdtkvtAnuBruAntBrtzDpDpyDozyDFybhwCFwahwixsEhsgxsxxkcxktxlvxAlxBnxDrxbpwnuzboybojDmzbqzjpsruyjowrujjoijobbmyjqybmjjqjjmwrtjjmijmbbljjnjjlijlbjkrsCusCtkFukFtAfuAftwDhsChsaxkExkhxAdxAvxBuzDuyDujbuwnxjbuibubDtjbvjjusrxijugrxbjuajuDbtijvibtbjvbjtgrwrjtajtDbsrjtrjsqjsnBxjDxiDxbbxgnyrbxabxDDwrbxrbwqbwn"
    '        CodageMC(2) = "pjkurwejApbsunyebkpDwulzeDspByeBwzfcfjkprwzfEfbspnyzfCfDwplzzfBfByyrczfqfrwyrEzfnfnyyrCflzyrBxjcyrqxjEyrnxjCxjBuzcxjquzExjnuzCuzBpzcuzqpzEuznpzCdjAorsufydbkonwudzdDsolydBwokzdAyzdodrsovyzdmdnwotzzdldlydkzynozdvdvyynmdtzynlxboynvxbmxblujoxbvujmujlozoujvozmozlcrkofwuFzcnsodyclwoczckyckjzcucvwohzzctctycszylucxzyltxDuxDtubuubtojuojtcfsoFycdwoEzccyccjzchchycgzykxxBxuDxcFwoCzcEycEjcazcCycCjFjAmrstfyFbkmnwtdzFDsmlyFBwmkzFAyzFoFrsmvyzFmFnwmtzzFlFlyFkzyfozFvFvyyfmFtzyflwroyfvwrmwrltjowrvtjmtjlmzotjvmzmmzlqrkvfwxpzhbAqnsvdyhDkqlwvczhBsqkyhAwqkjhAiErkmfwtFzhrkEnsmdyhnsqtymczhlwEkyhkyEkjhkjzEuEvwmhzzhuzEthvwEtyzhthtyEszhszyduExzyvuydthxzyvtwnuxruwntxrttbuvjutbtvjtmjumjtgrAqfsvFygnkqdwvEzglsqcygkwqcjgkigkbEfsmFygvsEdwmEzgtwqgzgsyEcjgsjzEhEhyzgxgxyEgzgwzycxytxwlxxnxtDxvbxmbxgfkqFwvCzgdsqEygcwqEjgcigcbEFwmCzghwEEyggyEEjggjEazgizgFsqCygEwqCjgEigEbECygayECjgajgCwqBjgCigCbEBjgDjgBigBbCrklfwspzCnsldyClwlczCkyCkjzCuCvwlhzzCtCtyCszyFuCx"
    '        CodageMC(2) = CodageMC(2) & "zyFtwfuwftsrusrtljuljtarAnfstpyankndwtozalsncyakwncjakiakbCfslFyavsCdwlEzatwngzasyCcjasjzChChyzaxaxyCgzawzyExyhxwdxwvxsnxtrxlbxrfkvpwxuzinArdsvoyilkrcwvojiksrciikgrcbikaafknFwtmzivkadsnEyitsrgynEjiswaciisiacbisbCFwlCzahwCEyixwagyCEjiwyagjiwjCazaiziyzifArFsvmyidkrEwvmjicsrEiicgrEbicaicDaFsnCyihsaEwnCjigwrajigiaEbigbCCyaayCCjiiyaajiijiFkrCwvljiEsrCiiEgrCbiEaiEDaCwnBjiawaCiiaiaCbiabCBjaDjibjiCsrBiiCgrBbiCaiCDaBiiDiaBbiDbiBgrAriBaiBDaAriBriAqiAnBfskpyBdwkozBcyBcjBhyBgzyCxwFxsfxkrxDfklpwsuzDdsloyDcwlojDciDcbBFwkmzDhwBEyDgyBEjDgjBazDizbfAnpstuybdknowtujbcsnoibcgnobbcabcDDFslmybhsDEwlmjbgwDEibgiDEbbgbBCyDayBCjbiyDajbijrpkvuwxxjjdArosvuijckrogvubjccroajcEroDjcCbFknmwttjjhkbEsnmijgsrqinmbjggbEajgabEDjgDDCwlljbawDCijiwbaiDCbjiibabjibBBjDDjbbjjjjjFArmsvtijEkrmgvtbjEcrmajEErmDjECjEBbCsnlijasbCgnlbjagrnbjaabCDjaDDBibDiDBbjbibDbjbbjCkrlgvsrjCcrlajCErlDjCCjCBbBgnkrjDgbBajDabBDjDDDArbBrjDrjBcrkqjBErknjBCjBBbAqjBqbAnjBnjAorkfjAmjAlb"
    '        CodageMC(2) = CodageMC(2) & "AfjAvApwkezAoyAojAqzBpskuyBowkujBoiBobAmyBqyAmjBqjDpkluwsxjDosluiDoglubDoaDoDBmwktjDqwBmiDqiBmbDqbAljBnjDrjbpAnustxiboknugtxbbocnuaboEnuDboCboBDmsltibqsDmgltbbqgnvbbqaDmDbqDBliDniBlbbriDnbbrbrukvxgxyrrucvxaruEvxDruCruBbmkntgtwrjqkbmcntajqcrvantDjqEbmCjqCbmBjqBDlglsrbngDlajrgbnaDlDjrabnDjrDBkrDlrbnrjrrrtcvwqrtEvwnrtCrtBblcnsqjncblEnsnjnErtnjnCblBjnBDkqblqDknjnqblnjnnrsovwfrsmrslbkonsfjlobkmjlmbkljllDkfbkvjlvrsersdbkejkubkdjktAeyAejAuwkhjAuiAubAdjAvjBuskxiBugkxbBuaBuDAtiBviAtbBvbDuklxgsyrDuclxaDuElxDDuCDuBBtgkwrDvglxrDvaBtDDvDAsrBtrDvrnxctyqnxEtynnxCnxBDtclwqbvcnxqlwnbvEDtCbvCDtBbvBBsqDtqBsnbvqDtnbvnvyoxzfvymvylnwotyfrxonwmrxmnwlrxlDsolwfbtoDsmjvobtmDsljvmbtljvlBsfDsvbtvjvvvyevydnwerwunwdrwtDsebsuDsdjtubstjttvyFnwFrwhDsFbshjsxAhiAhbAxgkirAxaAxDAgrAxrBxckyqBxEkynBxCBxBAwqBxqAwnBxnlyoszflymlylBwokyfDxolyvDxmBwlDxlAwfBwvDxvtzetzdlyenyulydnytBweDwuBwdbxuDwtbxttzFlyFnyhBwFDwhbwxAiqAinAyokjfAymAylAifAyvkzekzdAyeByuAydBytszp"
    '        CodeErr = 0
    '        If Chaine = "" Then CodeErr = 1 : Exit Function
    '        'Dcouper la chaine en blocs de caractre de mme type : numrique , texte, octet
    '        'La 1re colonne du tableau Liste% contient le nombre de caractres, la 2me le commutateur de mode
    '        'Split the string in character blocks of the same type : numeric , text, byte
    '        'The first column of the array Liste% contain the char. number, the second one contain the mode switch
    '        IndexChaine = 1
    '    GoSub QuelMode
    '            Do
    '            ReDim Preserve Liste(1, IndexListe)
    '            Liste(1, IndexListe) = Mode
    '            Do While Liste(1, IndexListe) = Mode
    '                Liste(0, IndexListe) = Liste(0, IndexListe) + 1
    '                IndexChaine = IndexChaine + 1
    '                If IndexChaine > Len(Chaine) Then Exit Do
    '    GoSub QuelMode
    '                Loop
    '            IndexListe = IndexListe + 1
    '        Loop Until IndexChaine > Len(Chaine)
    '        'Ne garder le mode numrique que si c'est "rentable", sinon mode "texte" voire "octet"
    '        'Les seuils de rentabilit ont ts pr-dtermins selon le mode prcdent et/ou le mode suivant
    '        'We retain "numeric" mode only if it's earning, else "text" mode or even "byte" mode
    '        'The efficiency limits have been pre-defined according to the previous mode and/or the next mode.
    '        For I = 0 To IndexListe - 1
    '            If Liste(1, I) = 902 Then
    '                If I = 0 Then 'C'est le premier bloc / It's the first block
    '                    If IndexListe > 1 Then 'et il y en a d'autres derrire / And there is other blocks behind
    '                        If Liste(1, I + 1) = 900 Then
    '                            'Premier bloc et suivi par un bloc de type "texte" / First block and followed by a "text" type block
    '                            If Liste(0, I) < 8 Then Liste(1, I) = 900
    '                        ElseIf Liste(1, I + 1) = 901 Then
    '                            'Premier bloc et suivi par un bloc de type "octet" / First block and followed by a "byte" type block
    '                            If Liste(0, I) = 1 Then Liste(1, I) = 901
    '                        End If
    '                    End If
    '                Else
    '                    'C'est pas le premier bloc / It's not the first block
    '                    If I = IndexListe - 1 Then
    '                        'C'est le dernier / It's the last one
    '                        If Liste(1, I - 1) = 900 Then
    '                            'Il est prcd par un bloc de type "texte" / It'spreceded by a "text" type block
    '                            If Liste(0, I) < 7 Then Liste(1, I) = 900
    '                        ElseIf Liste(1, I - 1) = 901 Then
    '                            'Il est prcd par un bloc de type "octet" / It'spreceded by a "byte" type block
    '                            If Liste(0, I) = 1 Then Liste(1, I) = 901
    '                        End If
    '                    Else
    '                        'C'est pas le dernier / It's not the last block
    '                        If Liste(1, I - 1) = 901 And Liste(1, I + 1) = 901 Then
    '                            'Encadr par des blocs de type "octet" / Framed by "byte" type blocks
    '                            If Liste(0, I) < 4 Then Liste(1, I) = 901
    '                        ElseIf Liste(1, I - 1) = 900 And Liste(1, I + 1) = 901 Then
    '                            'Prcd par "texte" et suivi par "octet" (Si l'inverse jamais intressant de changer)
    '                            'Preceded by "text" and followed by "byte" (If the reverse it's never interesting to change)
    '                            If Liste(0, I) < 5 Then Liste(1, I) = 900
    '                        ElseIf Liste(1, I - 1) = 900 And Liste(1, I + 1) = 900 Then
    '                            'Encadr par des blocs de type "texte" / Framed by "text" type blocks
    '                            If Liste(0, I) < 8 Then Liste(1, I) = 900
    '                        End If
    '                    End If
    '                End If
    '            End If
    '        Next
    '    GoSub Regroupe
    '            'Ne garder le mode "texte" que si c'est rentable / Maintain "text" mode only if it's earning
    '            For I = 0 To IndexListe - 1
    '            If Liste(1, I) = 900 And I > 0 Then
    '                'C'est pas le premier (Si 1er jamais intressant de changer) / It's not the first (If first, never interesting to change)
    '                If I = IndexListe - 1 Then 'C'est le dernier / It's the last one
    '                    If Liste(1, I - 1) = 901 Then
    '                        'Prcd par un bloc de type "octet" / It'spreceded by a "byte" type block
    '                        If Liste(0, I) = 1 Then Liste(1, I) = 901
    '                    End If
    '                Else
    '                    'C'est pas le dernier / It's not the last one
    '                    If Liste(1, I - 1) = 901 And Liste(1, I + 1) = 901 Then
    '                        'Encadr par des blocs de type "octet" / Framed by "byte" type blocks
    '                        If Liste(0, I) < 5 Then Liste(1, I) = 901
    '                    ElseIf (Liste(1, I - 1) = 901 And Liste(1, I + 1) <> 901) Or (Liste(1, I - 1) <> 901 And Liste(1, I + 1) = 901) Then
    '                        'Un bloc "octet" devant ou derrire / A "byte" block ahead or behind
    '                        If Liste(0, I) < 3 Then Liste(1, I) = 901
    '                    End If
    '                End If
    '            End If
    '        Next
    '    GoSub Regroupe
    '            'Maintenant on compacte les donnes dans les MC, les MC sont stockes sur 3 car. dans une grande chaine : ChaineMC$
    '            'Now we compress datas into the MCs, the MCs are stored in 3 char. in a large string : ChaineMC$
    '            IndexChaine = 1
    '        For I = 0 To IndexListe - 1
    '            'Donc 3 modes de compactage / Thus 3 compaction modes
    '            Select Case Liste(1, I)
    '                Case 900 'Texte
    '                    ReDim ListeT(1, Liste(0, I))
    '                    'ListeT% contiendra le numro de table(s) et la valeur de chaque caractre
    '                    'Numros de table cods sur les 4 bits de poids faibles, soit en dcimal 1, 2, 4, 8
    '                    'ListeT% will contain the table number(s) (1 ou several) and the value of each char.
    '                    'Table number encoded in the 4 less weight bits, that is in decimal 1, 2, 4, 8
    '                    For IndexListeT = 0 To Liste(0, I) - 1
    '                        CodeASCII = Asc(Mid(Chaine, IndexChaine + IndexListeT, 1))
    '                        Select Case CodeASCII
    '                            Case 9 'HT
    '                                ListeT(0, IndexListeT) = 12
    '                                ListeT(1, IndexListeT) = 12
    '                            Case 10 'LF
    '                                ListeT(0, IndexListeT) = 8
    '                                ListeT(1, IndexListeT) = 15
    '                            Case 13 'CR
    '                                ListeT(0, IndexListeT) = 12
    '                                ListeT(1, IndexListeT) = 11
    '                            Case Else
    '                                ListeT(0, IndexListeT) = CShort(Mid(ASCII, CodeASCII * 4 - 127, 2))
    '                                ListeT(1, IndexListeT) = CShort(Mid(ASCII, CodeASCII * 4 - 125, 2))
    '                        End Select
    '                    Next
    '                    CurTable = 1 'Table par dfaut / Default table
    '                    ChaineT = ""
    '                    'Les donnes sont stockes sur 2 car. dans la chaine TableT$ / Datas are stored in 2 char. in the string TableT$
    '                    For j = 0 To Liste(0, I) - 1
    '                        If (ListeT(0, j) And CurTable) > 0 Then
    '                            'Le car. est dans la table courante / The char. is in the current table
    '                            ChaineT = ChaineT & VB6.Format(ListeT(1, j), "00")
    '                        Else
    '                            'Faut changer de table / Obliged to change the table
    '                            flag = False 'True si on change de table pour un seul car. / True if we change the table only for 1 char.
    '                            If j = Liste(0, I) - 1 Then
    '                                flag = True
    '                            Else
    '                                If (ListeT(0, j) And ListeT(0, j + 1)) = 0 Then flag = True 'Pas de table commune avec le car. suivant / No common table with the next char.
    '                            End If
    '                            If flag Then
    '                                'On change de table pour 1 seul car., Chercher un commutateur fugitif
    '                                'We change only for 1 char., Look for a temporary switch
    '                                If (ListeT(0, j) And 1) > 0 And CurTable = 2 Then
    '                                    'Table 2 vers 1 pour 1 car. --> T_MAJ / Table 2 to 1 for 1 char. --> T_UPP
    '                                    ChaineT = ChaineT & "27" & VB6.Format(ListeT(1, j), "00")
    '                                ElseIf (ListeT(0, j) And 8) > 0 Then
    '                                    'Table 1 ou 2 ou 4 vers table 8 pour 1 car. --> T_PON / Table 1 or 2 or 4 to table 8 for 1 char. --> T_PUN
    '                                    ChaineT = ChaineT & "29" & VB6.Format(ListeT(1, j), "00")
    '                                Else
    '                                    'Pas de commutateur fugitif / No temporary switch available
    '                                    flag = False
    '                                End If
    '                            End If
    '                            If Not flag Then 'On re-teste flag qui a peut-tre chang ci-dessus ! donc ELSE pas possible / We test again flag which is perhaps changed ! Impossible tio use ELSE statement
    '                                '
    '                                'On doit utiliser un commutateur  basculement
    '                                'Dterminer la nouvelle table  utiliser
    '                                'We must use a bi-state switch
    '                                'Looking for the new table to use
    '                                If j = Liste(0, I) - 1 Then
    '                                    NewTable = ListeT(0, j)
    '                                Else
    '                                    NewTable = IIf((ListeT(0, j) And ListeT(0, j + 1)) = 0, ListeT(0, j), ListeT(0, j) And ListeT(0, j + 1))
    '                                End If
    '                                'Ne garder que la premire s'il y en a plusieurs de possible / Maintain the first if several tables are possible
    '                                Select Case NewTable
    '                                    Case 3, 5, 7, 9, 11, 13, 15
    '                                        NewTable = 1
    '                                    Case 6, 10, 14
    '                                        NewTable = 2
    '                                    Case 12
    '                                        NewTable = 4
    '                                End Select
    '                                'Choisir le commutateur, parfois il faut 2 commutateurs de suite / Select the switch, on occasion we must use 2 switchs consecutively
    '                                Select Case CurTable
    '                                    Case 1
    '                                        Select Case NewTable
    '                                            Case 2
    '                                                ChaineT = ChaineT & "27"
    '                                            Case 4
    '                                                ChaineT = ChaineT & "28"
    '                                            Case 8
    '                                                ChaineT = ChaineT & "2825"
    '                                        End Select
    '                                    Case 2
    '                                        Select Case NewTable
    '                                            Case 1
    '                                                ChaineT = ChaineT & "2828"
    '                                            Case 4
    '                                                ChaineT = ChaineT & "28"
    '                                            Case 8
    '                                                ChaineT = ChaineT & "2825"
    '                                        End Select
    '                                    Case 4
    '                                        Select Case NewTable
    '                                            Case 1
    '                                                ChaineT = ChaineT & "28"
    '                                            Case 2
    '                                                ChaineT = ChaineT & "27"
    '                                            Case 8
    '                                                ChaineT = ChaineT & "25"
    '                                        End Select
    '                                    Case 8
    '                                        Select Case NewTable
    '                                            Case 1
    '                                                ChaineT = ChaineT & "29"
    '                                            Case 2
    '                                                ChaineT = ChaineT & "2927"
    '                                            Case 4
    '                                                ChaineT = ChaineT & "2928"
    '                                        End Select
    '                                End Select
    '                                CurTable = NewTable
    '                                ChaineT = ChaineT & VB6.Format(ListeT(1, j), "00") 'On ajoute enfin le car. / At last we add the char.
    '                            End If
    '                        End If
    '                    Next
    '                    If Len(ChaineT) Mod 4 > 0 Then ChaineT = ChaineT & "29" 'Bourrage si nb de car. impair / Padding if number of char. is odd
    '                    'Maintenant traduire la chaine ChaineT$ en MCs
    '                    'Now translate the string ChaineT$ into CWs
    '                    If I > 0 Then ChaineMC = ChaineMC & "900" 'Mettre en place le commutateur sauf si premier bloc car mode "texte" par dfaut / Set up the switch exept for the first block because "text" is the default
    '                    For j = 1 To Len(ChaineT) Step 4
    '                        ChaineMC = ChaineMC & VB6.Format(CDbl(Mid(ChaineT, j, 2)) * 30 + CDbl(Mid(ChaineT, j + 2, 2)), "000")
    '                    Next
    '                Case 901 'Octet
    '                    'Choisir le commutateur parmi les 3 possibles / Select the switch between the 3 possible
    '                    If Liste(0, I) = 1 Then
    '                        '1 seul octet, c'est immdiat
    '                        ChaineMC = ChaineMC & "913" & VB6.Format(Asc(Mid(Chaine, IndexChaine, 1)), "000")
    '                    Else
    '                        'Choisir le commutateur selon qu'on a un multiple de 6 octets ou non
    '                        'Select the switch for perfect multiple of 6 bytes or no
    '                        If Liste(0, I) Mod 6 = 0 Then
    '                            ChaineMC = ChaineMC & "924"
    '                        Else
    '                            ChaineMC = ChaineMC & "901"
    '                        End If
    '                        j = 0
    '                        Do While j < Liste(0, I)
    '                            Longueur = Liste(0, I) - j
    '                            If Longueur >= 6 Then
    '                                'prendre des paquets de 6 /Take groups of 6
    '                                Longueur = 6
    '                                Total = 0
    '                                For k = 0 To Longueur - 1
    '                                    Total = Total + (Asc(Mid(Chaine, IndexChaine + j + k, 1)) * 256 ^ (Longueur - 1 - k))
    '                                Next
    '                                ChaineMod = VB6.Format(Total, "general number")
    '                                Dummy = ""
    '                                Do
    '                                    Diviseur = 900
    '    GoSub Modulo
    '                                        Dummy = VB6.Format(Diviseur, "000") & Dummy
    '                                    ChaineMod = ChaineMult
    '                                    If ChaineMult = "" Then Exit Do
    '                                Loop
    '                                ChaineMC = ChaineMC & Dummy
    '                            Else
    '                                'S'il reste un paquet de moins de 6 octets / If it remain a group of less than 6 bytes
    '                                For k = 0 To Longueur - 1
    '                                    ChaineMC = ChaineMC & VB6.Format(Asc(Mid(Chaine, IndexChaine + j + k, 1)), "000")
    '                                Next
    '                            End If
    '                            j = j + Longueur
    '                        Loop
    '                    End If
    '                Case 902 'Numrique / Numeric
    '                    ChaineMC = ChaineMC & "902"
    '                    j = 0
    '                    Do While j < Liste(0, I)
    '                        Longueur = Liste(0, I) - j
    '                        If Longueur > 44 Then Longueur = 44
    '                        ChaineMod = "1" & Mid(Chaine, IndexChaine + j, Longueur)
    '                        Dummy = ""
    '                        Do
    '                            Diviseur = 900
    '    GoSub Modulo
    '                                Dummy = VB6.Format(Diviseur, "000") & Dummy
    '                            ChaineMod = ChaineMult
    '                            If ChaineMult = "" Then Exit Do
    '                        Loop
    '                        ChaineMC = ChaineMC & Dummy
    '                        j = j + Longueur
    '                    Loop
    '                    'Debug.Print ChaineMC
    '            End Select
    '            IndexChaine = IndexChaine + Liste(0, I)
    '        Next
    '        'ChaineMC$ contient la liste des MC (sur 3 chiffres) reprsentant les donnes
    '        'On s'occupe maintenant du niveau de correction
    '        'ChaineMC$ contain the MC list (on 3 digits) depicting the datas
    '        'Now we take care of the correction level
    '        Longueur = Len(ChaineMC) / 3
    '        If scu < 0 Then
    '            'Dtermination auto. du niveau de correction en fonction des recommandations de la norme
    '            'Fixing auto. the correction level according to the standard recommendations
    '            If Longueur < 41 Then
    '                scu = 2
    '            ElseIf Longueur < 161 Then
    '                scu = 3
    '            ElseIf Longueur < 321 Then
    '                scu = 4
    '            Else
    '                scu = 5
    '            End If
    '        End If
    '        'On s'occupe maintenant du nombre de MC par ligne / Now we take care of the number of CW per row
    '        Longueur = Longueur + 1 + (2 ^ (scu + 1))
    '        If nbcol > 30 Then nbcol = 30
    '        If nbcol < 1 Then
    '            'Avec une police haute de 3 modules, pour obtenir un code-barre "carr"
    '            'x = nb. de col. | Largeur en module = 69 + 17x | Hauteur en module = 3t / x (t tant le nb total de MC)
    '            'On a donc 69 + 17x = 3t/x <=> 17x+69x-3t=0 - Le discriminant est 69-4*17*-3t = 4761+204t donc x=SQR(discr.)-69/2*17
    '            '
    '            'With a 3 modules high font, for getting a "square" bar code
    '            'x = nb. of col. | Width by module = 69 + 17x | Height by module = 3t / x (t is the total number of MCs)
    '            'Thus we have 69 + 17x = 3t/x <=> 17x+69x-3t=0 - Discriminant is 69-4*17*-3t = 4761+204t thus x=SQR(discr.)-69/2*17
    '            nbcol = (System.Math.Sqrt(204.0# * Longueur + 4761) - 69) / (34 / 1.3) '1.3 = coeff. de pondration dtermin au pif aprs essais / 1.3 = balancing factor determined at a guess after tests
    '            If nbcol = 0 Then nbcol = 1
    '        End If
    '        'Si on dpasse 928 MC on essaye de rduire le niveau de correction
    '        'If we go beyong 928 CWs we try to reduce the correction level
    '        Do While scu > 0
    '            'Calcul du nombre total de MC en tenant compte du rembourrage pour complter les lignes
    '            'Calculation of the total number of CW with the padding
    '            Longueur = Len(ChaineMC) / 3 + 1 + (2 ^ (scu + 1))
    '            Longueur = (Longueur \ nbcol + IIf(Longueur Mod nbcol > 0, 1, 0)) * nbcol
    '            If Longueur < 929 Then Exit Do
    '            'On doit rduire le niveau de scurit pour tout faire rentrer
    '            'We must reduce security level
    '            scu = scu - 1
    '            CodeErr = 10
    '        Loop
    '        If Longueur > 928 Then CodeErr = 2 : Exit Function
    '        If Longueur / nbcol > 90 Then CodeErr = 3 : Exit Function
    '        'Calcul du rembourrage / Padding calculation
    '        Longueur = Len(ChaineMC) / 3 + 1 + (2 ^ (scu + 1))
    '        I = 0
    '        If Longueur \ nbcol < 3 Then
    '            I = nbcol * 3 - Longueur 'Il faut au moins 3 lignes dans le code / A bar code must have at least 3 row
    '        Else
    '            If Longueur Mod nbcol > 0 Then I = nbcol - (Longueur Mod nbcol)
    '        End If
    '        'On ajoute le rembourrage / We add the padding
    '        Do While I > 0
    '            ChaineMC = ChaineMC & "900"
    '            I = I - 1
    '        Loop
    '        'On ajoute le descripteur de longueur / We add the length descriptor
    '        ChaineMC = VB6.Format(Len(ChaineMC) / 3 + 1, "000") & ChaineMC
    '        'On s'occupe maintenant des codes de Reed Solomon / Now we take care of the Reed Solomon codes
    '        Longueur = Len(ChaineMC) / 3
    '        k = 2 ^ (scu + 1)
    '        ReDim MCcorrection(k - 1)
    '        Total = 0
    '        For I = 0 To Longueur - 1
    '            Total = (CDbl(Mid(ChaineMC, I * 3 + 1, 3)) + MCcorrection(k - 1)) Mod 929
    '            For j = k - 1 To 0 Step -1
    '                If j = 0 Then
    '                    MCcorrection(j) = (929 - (Total * CDbl(Mid(CoefRS(scu), j * 3 + 1, 3))) Mod 929) Mod 929
    '                Else
    '                    MCcorrection(j) = (MCcorrection(j - 1) + 929 - (Total * CDbl(Mid(CoefRS(scu), j * 3 + 1, 3))) Mod 929) Mod 929
    '                End If
    '            Next
    '        Next
    '        For j = 0 To k - 1
    '            If MCcorrection(j) <> 0 Then MCcorrection(j) = 929 - MCcorrection(j)
    '        Next
    '        'On va ajouter les codes de correction  la chaine / We add theses codes to the string
    '        For I = k - 1 To 0 Step -1
    '            ChaineMC = ChaineMC & VB6.Format(MCcorrection(I), "000")
    '        Next
    '        'La chaine des MC est termine
    '        'Calcul des paramtres pour les MC de cots gauche et droit
    '        'The CW string is finished
    '        'Calculation of parameters for the left and right side CWs
    '        C1 = (Len(ChaineMC) / 3 / nbcol - 1) \ 3
    '        C2 = scu * 3 + (Len(ChaineMC) / 3 / nbcol - 1) Mod 3
    '        C3 = nbcol - 1
    '        'On encode chaque ligne / We encode each row
    '        For I = 0 To Len(ChaineMC) / 3 / nbcol - 1
    '            Dummy = Mid(ChaineMC, I * nbcol * 3 + 1, nbcol * 3)
    '            k = (I \ 3) * 30
    '            Select Case I Mod 3
    '                Case 0
    '                    Dummy = VB6.Format(k + C1, "000") & Dummy & VB6.Format(k + C3, "000")
    '                Case 1
    '                    Dummy = VB6.Format(k + C2, "000") & Dummy & VB6.Format(k + C1, "000")
    '                Case 2
    '                    Dummy = VB6.Format(k + C3, "000") & Dummy & VB6.Format(k + C2, "000")
    '            End Select
    '            EncodePdf417 = EncodePdf417 & "+*" 'Commencer par car. de start et sparateur / Start with a start char. and a separator
    '            For j = 0 To Len(Dummy) / 3 - 1
    '                EncodePdf417 = EncodePdf417 & Mid(CodageMC(I Mod 3), CDbl(Mid(Dummy, j * 3 + 1, 3)) * 3 + 1, 3) & "*"
    '            Next
    '            EncodePdf417 = EncodePdf417 & "-" & Chr(13) & Chr(10) 'Ajouter car. de stop et CRLF / Add a stop char. and a CRLF
    '        Next
    '        Exit Function
    'Regroupe:
    '        'Regrouper les blocs de mme type / Bring together same type blocks
    '        If IndexListe > 1 Then
    '            I = 1
    '            Do While I < IndexListe
    '                If Liste(1, I - 1) = Liste(1, I) Then
    '                    'Regroupement / Bringing together
    '                    Liste(0, I - 1) = Liste(0, I - 1) + Liste(0, I)
    '                    j = I + 1
    '                    'Rduction de la liste / Decrease the list
    '                    Do While j < IndexListe
    '                        Liste(0, j - 1) = Liste(0, j)
    '                        Liste(1, j - 1) = Liste(1, j)
    '                        j = j + 1
    '                    Loop
    '                    IndexListe = IndexListe - 1
    '                    I = I - 1
    '                End If
    '                I = I + 1
    '            Loop
    '        End If
    '        Return
    'QuelMode:
    '        CodeASCII = Asc(Mid(Chaine, IndexChaine, 1))
    '        Select Case CodeASCII
    '            Case 48 To 57
    '                Mode = 902
    '            Case 9, 10, 13, 32 To 126
    '                Mode = 900
    '            Case Else
    '                Mode = 901
    '        End Select
    '        Return
    'Modulo:
    '        'ChaineMod$ reprsente un trs grand nombre sur plus de 9 chiffres
    '        'Diviseur& est le diviseur, contient le rsultat au retour
    '        'ChaineMult$ contient au retour le rsultat de la division entire
    '        '
    '        'ChaineMod$ depict a very large number having more than 9 digits
    '        'Diviseur& is the divisor, contain the result after return
    '        'ChaineMult$ contain after return the result of the integer division
    '        ChaineMult = ""
    '        Nombre = 0
    '        Do While ChaineMod <> ""
    '            Nombre = Nombre * 10 + CDbl(Left(ChaineMod, 1)) 'Abaisse un chiffre / Put down a digit
    '            ChaineMod = Mid(ChaineMod, 2)
    '            If Nombre < Diviseur Then
    '                If ChaineMult <> "" Then ChaineMult = ChaineMult & "0"
    '            Else
    '                ChaineMult = ChaineMult & Nombre \ Diviseur
    '            End If
    '            Nombre = Nombre Mod Diviseur 'Rcupre le reste / get the remainder
    '        Loop
    '        Diviseur = Nombre
    '        Return
    '    End Function
    Public Function GetBalancePaymentAmount(ByRef pSupplierCode As String, ByRef pBillDate As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pDivision As Double, ByRef pBookType As String, ByRef mBalCGST As Double, ByRef mBalSGST As Double, ByRef mBalIGST As Double) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mAdvanceAmount As Double
        Dim mBillReceiptAmt As Double
        mAdvanceAmount = 0
        mBillReceiptAmt = 0
        mBalCGST = 0
        mBalSGST = 0
        mBalIGST = 0
        GetBalancePaymentAmount = 0
        SqlStr = " SELECT SUM(ITEMVALUE) AS NETVALUE, " & vbCrLf & " SUM(TOTCGST_AMOUNT) As TOTCGST_AMOUNT, " & vbCrLf & " SUM(TOTSGST_AMOUNT) As TOTSGST_AMOUNT, " & vbCrLf & " SUM(TOTIGST_AMOUNT) As TOTIGST_AMOUNT " & vbCrLf & " FROM FIN_ADVANCE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & pSupplierCode & "' AND BOOKTYPE='" & pBookType & "'"
        If pBookType = "AP" Then
            SqlStr = SqlStr & vbCrLf & " AND DIV_CODE = " & pDivision & ""
        End If
        SqlStr = SqlStr & vbCrLf & " AND VDATE <= TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mAdvanceAmount = Val(IIf(IsDBNull(RsTemp.Fields("NETVALUE").Value), 0, RsTemp.Fields("NETVALUE").Value))
            mBalCGST = Val(IIf(IsDBNull(RsTemp.Fields("TOTCGST_AMOUNT").Value), 0, RsTemp.Fields("TOTCGST_AMOUNT").Value))
            mBalSGST = Val(IIf(IsDBNull(RsTemp.Fields("TOTSGST_AMOUNT").Value), 0, RsTemp.Fields("TOTSGST_AMOUNT").Value))
            mBalIGST = Val(IIf(IsDBNull(RsTemp.Fields("TOTIGST_AMOUNT").Value), 0, RsTemp.Fields("TOTIGST_AMOUNT").Value))
        End If
        If pBookType = "AP" Then
            SqlStr = " SELECT SUM(ADV_ADJUSTED_AMT) AS ADV_ADJUSTED_AMT, " & vbCrLf & " SUM(ADV_CGST_AMT) As TOTCGST_AMOUNT, " & vbCrLf & " SUM(ADV_SGST_AMT) As TOTSGST_AMOUNT, " & vbCrLf & " SUM(ADV_IGST_AMT) As TOTIGST_AMOUNT " & vbCrLf & " FROM FIN_PURCHASE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & pSupplierCode & "'" & vbCrLf & " AND DIV_CODE = " & pDivision & "" & vbCrLf & " AND VDATE <= TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            If pVNo <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND FYEAR || VNO <> " & RsCompany.Fields("FYEAR").Value & " || '" & pVNo & "'"
            End If
        Else
            SqlStr = " SELECT SUM(ADV_ADJUSTED_AMT) AS ADV_ADJUSTED_AMT, " & vbCrLf & " SUM(ADV_CGST_AMT) As TOTCGST_AMOUNT, " & vbCrLf & " SUM(ADV_SGST_AMT) As TOTSGST_AMOUNT, " & vbCrLf & " SUM(ADV_IGST_AMT) As TOTIGST_AMOUNT " & vbCrLf & " FROM FIN_INVOICE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SUPP_CUST_CODE='" & pSupplierCode & "'" & vbCrLf & " AND INVOICE_DATE <= TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND ADV_ADJUSTED_AMT>0"
            If pVNo <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND FYEAR || BILLNO <> " & RsCompany.Fields("FYEAR").Value & " || '" & pVNo & "'"
            End If
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            mBillReceiptAmt = Val(IIf(IsDBNull(RsTemp.Fields("ADV_ADJUSTED_AMT").Value), 0, RsTemp.Fields("ADV_ADJUSTED_AMT").Value))
            mBalCGST = mBalCGST - Val(IIf(IsDBNull(RsTemp.Fields("TOTCGST_AMOUNT").Value), 0, RsTemp.Fields("TOTCGST_AMOUNT").Value))
            mBalSGST = mBalSGST - Val(IIf(IsDBNull(RsTemp.Fields("TOTSGST_AMOUNT").Value), 0, RsTemp.Fields("TOTSGST_AMOUNT").Value))
            mBalIGST = mBalIGST - Val(IIf(IsDBNull(RsTemp.Fields("TOTIGST_AMOUNT").Value), 0, RsTemp.Fields("TOTIGST_AMOUNT").Value))
        End If
        GetBalancePaymentAmount = CDbl(VB6.Format(mAdvanceAmount - mBillReceiptAmt, "0.00"))
        Exit Function
ErrPart:
        GetBalancePaymentAmount = 0
    End Function
    Public Function DNCNPostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String,
                                   ByRef pBookSubType As String, ByRef pVType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String,
                                   ByRef pBillDate As String, ByRef pPartyCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double,
                                   ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pReason As String, ByRef pExpAmount As Double,
                                   ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef xIsGST As String,
                                   ByRef xCGSTAMT As Double, ByRef xSGSTAMT As Double, ByRef xIGSTAMT As Double, ByRef pDCType As String, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mGSTAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        Dim mTRNType As String = ""
        Dim xExpAmount As String
        Dim pDNBillNo As String
        Dim pDNBillDate As String
        Dim xNarration As String
        Dim mBillWiseExpAmt As Double
        Dim mBalBillWiseExpAmt As Double
        Dim mItemValue As Double
        SqlStr = ""
        mSubRowNo = 1
        '    pISMODVATE = IIf(RsCompany.fields("FYEAR").value < 2008, pISMODVATE, "N")        ''JUNE-2010
        If CDbl(pBookCode) = ConDebitNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( D/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "D"
        ElseIf CDbl(pBookCode) = ConCreditNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( C/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "C"
        End If
        If Trim(pBillNo) = "" Then
            pBillNo = pVNo
            pBillDate = pVDate
        End If
        If pCancel = True Then
            pNarration = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D/N No : ", "C/N No : ") & pVNo & " (Cancelled)"
            '    Else
            '        pNarration = "Bill No : " & pBillNo & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookSubType='" & UCase(pBookSubType) & "'")
        If pCancel = True Then
            DNCNPostTRNGST = True
            Exit Function
        End If
        '************* Account Posting *************************************'
        SqlStr = "SELECT DISTINCT SUPP_REF_NO, " & vbCrLf _
            & " '[Account Posting]' AS ErrField " & vbCrLf _
            & " FROM FIN_DNCN_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        xNarration = ""
        If RsPostTrn.EOF = False Then
            mErrField = RsPostTrn.Fields("ErrField").Value
            Do While RsPostTrn.EOF = False
                If Trim(xNarration) = "" Then
                    xNarration = IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                Else
                    xNarration = xNarration & ", " & IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                End If
                RsPostTrn.MoveNext()
            Loop
        End If
        xNarration = "Bill No : " & xNarration & pNarration
        mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pAccountCode, pPartyCode)
        If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        ''mAmount = mAmount - pMODVATAmount - pSTRefundAmount
        If xIsGST = "Y" Then
            mAmount = mAmount - xCGSTAMT - xSGSTAMT - xIGSTAMT
        End If
        mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        If xIsGST = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "CGST Expenses Error"
            If RsCompany.Fields("FYEAR").Value >= 2018 Then
                If pDCType = "R" Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_REJDR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
                End If
            Else
                If CDbl(pBookCode) = ConDebitNoteBookCode Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_DR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_CR_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_CR_RETURNCODE").Value)
                End If
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = xCGSTAMT
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            mErrField = "SGST Expenses Error"
            If RsCompany.Fields("FYEAR").Value >= 2018 Then
                If pDCType = "R" Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_REJDR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
                End If
            Else
                If CDbl(pBookCode) = ConDebitNoteBookCode Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_DR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_CR_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_CR_RETURNCODE").Value)
                End If
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = xSGSTAMT
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mSubRowNo = mSubRowNo + 1
            mErrField = "IGST Expenses Error"
            If RsCompany.Fields("FYEAR").Value >= 2018 Then
                If pDCType = "R" Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REJDR_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_REJDR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
                End If
            Else
                If CDbl(pBookCode) = ConDebitNoteBookCode Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_DR_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_DR_RETURNCODE").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_CR_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_CR_RETURNCODE").Value)
                End If
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = xIGSTAMT
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '************* Party Account Posting *************************************'
        SqlStr = "SELECT SUPP_REF_NO, SUPP_REF_DATE, " & vbCrLf _
            & " SUM(ITEM_AMT) AS Amount, SUM(CGST_AMOUNT) AS CGST_AMOUNT, SUM(SGST_AMOUNT) AS SGST_AMOUNT, SUM(IGST_AMOUNT) AS IGST_AMOUNT, " & vbCrLf _
            & " '[Party Account Posting]' AS ErrField " & vbCrLf _
            & " FROM FIN_DNCN_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "' GROUP BY SUPP_REF_NO, SUPP_REF_DATE"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        mBillWiseExpAmt = 0
        mBalBillWiseExpAmt = pExpAmount
        mItemValue = System.Math.Abs(pNetBillValue - pExpAmount)
        If RsPostTrn.EOF = False Then
            Do While RsPostTrn.EOF = False
                mErrField = RsPostTrn.Fields("ErrField").Value
                mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pPartyCode, pAccountCode)
                If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                If xIsGST = "Y" Or xIsGST = "I" Then
                    mGSTAmount = IIf(IsDBNull(RsPostTrn.Fields("CGST_AMOUNT").Value), 0, RsPostTrn.Fields("CGST_AMOUNT").Value)
                    mGSTAmount = mGSTAmount + IIf(IsDBNull(RsPostTrn.Fields("SGST_AMOUNT").Value), 0, RsPostTrn.Fields("SGST_AMOUNT").Value)
                    mGSTAmount = mGSTAmount + IIf(IsDBNull(RsPostTrn.Fields("IGST_AMOUNT").Value), 0, RsPostTrn.Fields("IGST_AMOUNT").Value)
                End If
                If mItemValue = 0 Then
                    mBillWiseExpAmt = 0
                Else
                    mBillWiseExpAmt = CDbl(VB6.Format(mAmount * pExpAmount / mItemValue, "0.00"))
                End If
                mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D", "C")
                pDNBillNo = IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                pDNBillDate = VB6.Format(IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_DATE").Value), "", RsPostTrn.Fields("SUPP_REF_DATE").Value), "DD-MMM-YYYY")
                If Trim(pDNBillNo) = "" Then
                    pDNBillNo = pBillNo
                    pDNBillDate = pBillDate
                End If
                xNarration = "Bill No : " & pDNBillNo & pNarration
                If pCancel = True Then
                    mAmount = 0
                End If
                RsPostTrn.MoveNext()
                If RsPostTrn.EOF = True Then
                    mBillWiseExpAmt = mBalBillWiseExpAmt
                Else
                    mBalBillWiseExpAmt = mBalBillWiseExpAmt - mBillWiseExpAmt
                    '                If mBalBillWiseExpAmt < 0 Then
                    '                    mBillWiseExpAmt = mBillWiseExpAmt + mBalBillWiseExpAmt
                    '                    mBalBillWiseExpAmt = 0
                    '                End If
                End If
                mAmount = mAmount + mGSTAmount + mBillWiseExpAmt
                If mAmount <> 0 Then
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pDNBillNo, pDNBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            Loop
        Else
            mErrField = "[Party Account Posting]"
            mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pPartyCode, pAccountCode)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            mAmount = System.Math.Abs(pExpAmount)
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D", "C")
            xNarration = "Bill No : " & pBillNo & pNarration
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**********************************************************************'
        DNCNPostTRNGST = True
        Exit Function
SalePostTrnErr:
        DNCNPostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        '    Resume
    End Function
    '    Public Function FinancePurchaseTRN(ByRef pMKey As String, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pMRRNo As Double, ByRef pMRRDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBookCode As Integer, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pSubRowNo As Integer, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pApprovedQty As Double, ByRef pItemRate As Double, ByRef pEDAmount As Double, ByRef pCESSAmount As Double, ByRef pSHECAmount As Double, ByRef pSTAmount As Double, ByRef pOTHAmount As Double) As Boolean
    '        On Error GoTo SalePostTrnErr
    '        Dim SqlStr As String=""
    '        If pCancel = True Or pFOC = True Then
    '            FinancePurchaseTRN = True
    '            Exit Function
    '        End If
    '        If pISCSTRefund = "Y" Then
    '            pISSTRefund = "Y"
    '        End If
    '        SqlStr = "INSERT INTO FIN_PURCHASE_TRN (" & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " AUTO_KEY_MRR, MRRDATE, " & vbCrLf & " VNO, VDATE, " & vbCrLf & " BILLNO, BILLDATE, " & vbCrLf & " ISMODVAT, ISSTREFUND, SUBROWNO, " & vbCrLf & " ITEM_CODE, ITEM_UOM, APPROVED_QTY, ITEM_RATE, " & vbCrLf & " ITEM_ED, ITEM_ST, ITEM_CESS, ITEM_SHEC, ITEM_OTH,BOOKCODE " & vbCrLf & " ) VALUES (" & vbCrLf & " '" & pMKey & "', " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & pMRRNo & ", '" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "'," & vbCrLf & " '" & pVNo & "', '" & VB6.Format(pVDate, "DD-MMM-YYYY") & "'," & vbCrLf & " '" & pBillNo & "', '" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "'," & vbCrLf & " '" & pISMODVATE & "', '" & pISSTRefund & "', " & vbCrLf & " " & pSubRowNo & ", '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " '" & pItemUOM & "', " & pApprovedQty & ", " & pItemRate & ", " & vbCrLf & " " & pEDAmount & ", " & pSTAmount & ", " & pCESSAmount & ", " & pSHECAmount & ", " & vbCrLf & " " & pOTHAmount & "," & pBookCode & ")"
    '        PubDBCn.Execute(SqlStr)
    '        FinancePurchaseTRN = True
    '        Exit Function
    'SalePostTrnErr:
    '        FinancePurchaseTRN = False
    '        If Err.Description <> "" Then
    '            MsgInformation(Err.Description)
    '        End If
    '        '    Resume
    '    End Function
    Public Function FinancePurchaseTRN(ByRef pMKey As String, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pMRRNo As Double, ByRef pMRRDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBookCode As Integer, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pSubRowNo As Integer, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pApprovedQty As Double, ByRef pItemRate As Double, ByRef pEDAmount As Double, ByRef pCESSAmount As Double, ByRef pSHECAmount As Double, ByRef pSTAmount As Double, ByRef pOTHAmount As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        If pCancel = True Or pFOC = True Then
            FinancePurchaseTRN = True
            Exit Function
        End If
        If pISCSTRefund = "Y" Then
            pISSTRefund = "Y"
        End If
        SqlStr = "INSERT INTO FIN_PURCHASE_TRN (" & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " AUTO_KEY_MRR, MRRDATE, " & vbCrLf & " VNO, VDATE, " & vbCrLf & " BILLNO, BILLDATE, " & vbCrLf & " ISMODVAT, ISSTREFUND, SUBROWNO, " & vbCrLf & " ITEM_CODE, ITEM_UOM, APPROVED_QTY, ITEM_RATE, " & vbCrLf & " ITEM_ED, ITEM_ST, ITEM_CESS, ITEM_SHEC, ITEM_OTH,BOOKCODE " & vbCrLf & " ) VALUES (" & vbCrLf & " '" & pMKey & "', " & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & pMRRNo & ", TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pVNo & "', TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pBillNo & "', TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pISMODVATE & "', '" & pISSTRefund & "', " & vbCrLf & " " & pSubRowNo & ", '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " '" & pItemUOM & "', " & pApprovedQty & ", " & pItemRate & ", " & vbCrLf & " " & pEDAmount & ", " & pSTAmount & ", " & pCESSAmount & ", " & pSHECAmount & ", " & vbCrLf & " " & pOTHAmount & "," & pBookCode & ")"
        PubDBCn.Execute(SqlStr)
        FinancePurchaseTRN = True
        Exit Function
SalePostTrnErr:
        FinancePurchaseTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        '    Resume
    End Function
    Public Function UpdateAssetTRN(ByRef pMKey As String, ByRef pFyear As Short, ByRef pTRNType As String, ByRef pCancel As String, ByRef pFOC As String, ByRef pMRRNo As Double, ByRef pMRRDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBookType As String, ByRef pSupplierName As String, ByRef pItemDesc As String, ByRef pItemValue As Double, ByRef pInvoiceValue As Double, ByRef pMODVATAmount As Double, ByRef pModvatPer As Double, ByRef pSTRefundAmount As Double, ByRef mIsFixedAssets As String, ByRef mItemType As String, ByRef mCGSTClaimAmount As Double, ByRef mSGSTClaimAmount As Double, ByRef mIGSTClaimAmount As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim xAddMode As Boolean
        Dim mAssetsNo As Double

        If pCancel = "Y" Or pFOC = "Y" Or mIsFixedAssets = "N" Then
            SqlStr = " DELETE FROM AST_ASSET_TRN " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "' " & vbCrLf _
                & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "' AND GROUP_CODE='" & pTRNType & "'" '& vbCrLf |                & " AND BILL_NO='" & MainClass.AllowSingleQuote(pBillNo) & "'"
            PubDBCn.Execute(SqlStr)
            UpdateAssetTRN = True
            Exit Function
        End If

        ''temp..........
        SqlStr = " SELECT AUTO_KEY_ASSET FROM AST_ASSET_TRN " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ""

        If pBookType = "E" Or pBookType = "R" Then
            SqlStr = SqlStr & vbCrLf _
                & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "' " & vbCrLf _
                & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "' " & vbCrLf _
                & " AND BILL_NO='" & MainClass.AllowSingleQuote(pBillNo) & "'"
        ElseIf pBookType = "J" Then
            SqlStr = SqlStr & vbCrLf _
                & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "' " & vbCrLf _
                & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "' " & vbCrLf _
                & " AND BILL_NO='" & MainClass.AllowSingleQuote(pBillNo) & "'" & vbCrLf _
                & " AND GROUP_CODE='" & MainClass.AllowSingleQuote(pTRNType) & "'"
        ElseIf pBookType = "P" Then
            If Val(CStr(pMRRNo)) <= 0 Then ''pPurchaseType = "W" Or pPurchaseType = "S" Then
                SqlStr = SqlStr & vbCrLf _
                    & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "'"
                If CDbl(pTRNType) > 0 Then
                    SqlStr = SqlStr & vbCrLf _
                        & " AND GROUP_CODE='" & pTRNType & "'"
                End If
            Else
                SqlStr = SqlStr & vbCrLf _
                    & " AND MRR_NO=" & Val(CStr(pMRRNo)) & " AND GROUP_CODE='" & pTRNType & "' AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "'"
            End If
        Else
            SqlStr = SqlStr & vbCrLf _
                & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "' AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = True Then
            mAssetsNo = CDbl(AutoGenAssetNo())
            xAddMode = True
        Else
            mAssetsNo = IIf(IsDBNull(RsTemp.Fields("AUTO_KEY_ASSET").Value), -1, RsTemp.Fields("AUTO_KEY_ASSET").Value)
            xAddMode = False
        End If
        If xAddMode = True Then
            SqlStr = " INSERT INTO AST_ASSET_TRN (" & vbCrLf _
                & " AUTO_KEY_ASSET, COMPANY_CODE, FYEAR, " & vbCrLf _
                & " GROUP_CODE, MRR_NO, MRR_DATE, " & vbCrLf _
                & " PV_NO, PV_DATE, BILL_NO, " & vbCrLf _
                & " BILL_DATE, SUPP_CUST_NAME, ITEM_DESC, " & vbCrLf _
                & " INSTALL_DATE, PUT_DATE, ITEM_VALUE, " & vbCrLf _
                & " CD_AMOUNT, OTH_AMOUNT, TOTAL_COST, " & vbCrLf _
                & " MODVAT_AMOUNT, CESS_AMOUNT, SHEC_AMOUNT, " & vbCrLf _
                & " AED_AMOUNT, MODVAT_DUR_YEAR_PER, STATUS, " & vbCrLf _
                & " SALE_BILL_NO, SALE_BILL_DATE, SALE_PARTY_NAME, " & vbCrLf _
                & " SALE_AMOUNT, PHY_VARIFICATION, LOCATION, " & vbCrLf _
                & " REMARKS, SALVAGE_AMT, VMKEY, BOOKTYPE," & vbCrLf _
                & " ADDUSER, ADDDATE, " & vbCrLf _
                & " MODUSER, MODDATE,ITEM_TYPE,SALETAX_REFUND," & vbCrLf _
                & " CGST_CLAIMAMOUNT, SGST_CLAIMAMOUNT, IGST_CLAIMAMOUNT)" & vbCrLf _
                & " VALUES ( "
            SqlStr = SqlStr & vbCrLf _
                & " " & mAssetsNo & ", " & RsCompany.Fields("COMPANY_CODE").Value & ", " & pFyear & ", " & vbCrLf _
                & " " & pTRNType & ", " & Val(CStr(pMRRNo)) & ",TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
                & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pBillNo & "', " & vbCrLf _
                & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pSupplierName) & "', '" & MainClass.AllowSingleQuote(pItemDesc) & "'," & vbCrLf _
                & " '', '', " & Val(CStr(pItemValue)) & "," & vbCrLf _
                & " 0, 0, " & Val(CStr(pInvoiceValue)) & "," & vbCrLf _
                & " " & Val(CStr(pMODVATAmount)) & ",0,0," & vbCrLf _
                & " 0," & Val(CStr(pModvatPer)) & ", 'O', " & vbCrLf _
                & " '','', ''," & vbCrLf & " 0,'','FACTORY'," & vbCrLf _
                & " '', 1, " & vbCrLf _
                & " '" & MainClass.AllowSingleQuote(pMKey) & "', '" & MainClass.AllowSingleQuote(pBookType) & "', " & vbCrLf _
                & " '" & MainClass.AllowSingleQuote(PubUserID) & "',TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY'),'',''," & vbCrLf _
                & " '" & MainClass.AllowSingleQuote(mItemType) & "'," & Val(CStr(pSTRefundAmount)) & "," & vbCrLf _
                & " " & Val(CStr(mCGSTClaimAmount)) & ", " & Val(CStr(mSGSTClaimAmount)) & ", " & Val(CStr(mIGSTClaimAmount)) & ")"
        Else
            SqlStr = " UPDATE AST_ASSET_TRN SET " & vbCrLf & " AUTO_KEY_ASSET=" & Val(CStr(mAssetsNo)) & ", " & vbCrLf & " COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & ", " & vbCrLf & " FYEAR=" & pFyear & ", " & vbCrLf & " GROUP_CODE=" & pTRNType & ", " & vbCrLf & " MRR_NO=" & Val(CStr(pMRRNo)) & ", " & vbCrLf & " MRR_DATE=TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " PV_NO='" & pVNo & "', " & vbCrLf & " PV_DATE=TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " BILL_NO='" & pBillNo & "', " & vbCrLf & " BILL_DATE=TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " SUPP_CUST_NAME='" & MainClass.AllowSingleQuote(pSupplierName) & "', " & vbCrLf & " ITEM_DESC='" & MainClass.AllowSingleQuote(pItemDesc) & "', " & vbCrLf & " ITEM_VALUE=" & Val(CStr(pItemValue)) & ", "
            SqlStr = SqlStr & vbCrLf & " TOTAL_COST=" & Val(CStr(pInvoiceValue)) & " , " & vbCrLf & " MODVAT_AMOUNT=" & Val(CStr(pMODVATAmount)) & ", " & vbCrLf & " MODVAT_DUR_YEAR_PER=" & Val(CStr(pModvatPer)) & "," & vbCrLf & " ITEM_TYPE='" & MainClass.AllowSingleQuote(mItemType) & "'," & vbCrLf & " SALETAX_REFUND=" & Val(CStr(pSTRefundAmount)) & "," & vbCrLf & " CGST_CLAIMAMOUNT=" & Val(CStr(mCGSTClaimAmount)) & ", " & vbCrLf & " SGST_CLAIMAMOUNT=" & Val(CStr(mSGSTClaimAmount)) & ", " & vbCrLf & " IGST_CLAIMAMOUNT=" & Val(CStr(mIGSTClaimAmount)) & "," & vbCrLf
            SqlStr = SqlStr & vbCrLf & " MODUSER='" & MainClass.AllowSingleQuote(PubUserID) & "', " & vbCrLf & " MODDATE=TO_DATE('" & VB6.Format(PubCurrDate, "dd-MMM-yyyy") & "','DD-MON-YYYY')" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND VMKEY='" & MainClass.AllowSingleQuote(pMKey) & "' AND GROUP_CODE='" & pTRNType & "'" & vbCrLf & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "' "
        End If
        PubDBCn.Execute(SqlStr)
        UpdateAssetTRN = True
        Exit Function
SalePostTrnErr:
        UpdateAssetTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        '    Resume
    End Function
    Public Sub SearchList(ByRef SqlStr As String, Optional ByRef ListField As String = "")
        On Error GoTo ERR1
        Static mListField As String
        If ListField = "" Then
            mListField = "Name"
        Else
            mListField = ListField
        End If
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.WaitCursor
        'MainClass.AssignDataInDataCbo SqlStr, frmSearch.AdataSearch, frmSearch.ADATACboSearch, mListField, StrConn
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default
        'frmSearch.Show 1
        Exit Sub
ERR1:
        System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Sub
    Public Function GetDummyExpAmount(ByVal pSuppCustCode As String, ByVal pAccountCode As String, ByVal pExpCode As String, ByVal pMKey As String, ByVal pVType As String, ByVal xDummyAmount As Double, ByVal xDC As String, Optional ByVal pFromDate As String = "", Optional ByVal pToDate As String = "") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        xDummyAmount = 0
        xDC = ""
        If PubUserID <> "A00001" Then Exit Function
        If pSuppCustCode = "" And pAccountCode = "" Then Exit Function
        If Trim(pMKey) <> "" Then
            SqlStr = "SELECT AMOUNT, DC FROM " & vbCrLf & " FIN_AUDIT_VOUCHER_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND VTYPE='" & pVType & "'" & vbCrLf & " AND MKEY='" & MainClass.AllowSingleQuote(pMKey) & "'"
            If pSuppCustCode <> "" Then
                SqlStr = SqlStr & vbCrLf & "AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCustCode) & "'"
            ElseIf pAccountCode <> "" Then
                SqlStr = SqlStr & vbCrLf & "AND ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'"
            ElseIf pExpCode <> "" Then
                SqlStr = SqlStr & vbCrLf & "AND EXP_CODE=" & Val(pExpCode) & ""
            End If
        Else
            SqlStr = "SELECT SUM(AMOUNT) AS AMOUNT, 'C' AS DC FROM " & vbCrLf & " FIN_AUDIT_VOUCHER_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
            If pSuppCustCode <> "" Then
                SqlStr = SqlStr & vbCrLf & "AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCustCode) & "'"
            ElseIf pAccountCode <> "" Then
                SqlStr = SqlStr & vbCrLf & "AND ACCOUNTCODE='" & MainClass.AllowSingleQuote(pAccountCode) & "'"
            End If
            SqlStr = SqlStr & vbCrLf & "AND VDATE>=TO_DATE('" & VB6.Format(pFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND VDATE<=TO_DATE('" & VB6.Format(pToDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & "HAVING SUM(AMOUNT)<>0"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp)
        If RsTemp.EOF = False Then
            xDummyAmount = IIf(IsDBNull(RsTemp.Fields("AMOUNT").Value), "", RsTemp.Fields("AMOUNT").Value) * -1
            xDC = IIf(IsDBNull(RsTemp.Fields("DC").Value), "", RsTemp.Fields("DC").Value)
        End If
        If xDummyAmount <> 0 Then
            GetDummyExpAmount = True
        Else
            GetDummyExpAmount = False
        End If
        Exit Function
ErrPart:
        GetDummyExpAmount = False
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        ''Resume
    End Function
    Public Function CheckCT3StockQty(ByRef pSprd As AxFPSpreadADO.AxfpSpread, ByRef ItemCodeCol As Integer, ByRef CheckQtyCol As Integer, ByRef pBookType As String, ByRef pMKey As String, ByRef pCTNO As Double, ByRef pSuppCustCode As String, Optional ByRef CheckStock As Boolean = False) As Boolean
        On Error GoTo ErrPart
        Dim cntRow As Integer
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCheckQty As Double
        Dim mItemCode As String
        Dim mStockQty As Double
        CheckCT3StockQty = True
        mStockQty = 0
        If CheckStock = False Then Exit Function
        With pSprd
            For cntRow = 1 To .MaxRows - 1
                .Row = cntRow
                .Col = ItemCodeCol
                mItemCode = Trim(.Text)
                .Col = CheckQtyCol
                mCheckQty = Val(.Text)
                mSqlStr = " SELECT SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY) AS QTY" & vbCrLf & " FROM FIN_CT_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCustCode) & "'" & vbCrLf & " AND CT_NO=" & pCTNO & ""
                If pMKey <> "" Then
                    mSqlStr = mSqlStr & vbCrLf & "AND MKEY<>'" & pMKey & "'"
                End If
                MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mStockQty = IIf(IsDBNull(RsTemp.Fields("QTY").Value), 0, RsTemp.Fields("QTY").Value)
                End If
                If mStockQty < mCheckQty Then
                    MsgInformation("You Have Not Enough C.T.3 Stock")
                    CheckCT3StockQty = False
                    Exit Function
                End If
NextRow:
            Next
        End With
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        CheckCT3StockQty = False
    End Function
    Public Function CheckCT1StockQty(ByRef pSprd As AxFPSpreadADO.AxfpSpread, ByRef ItemCodeCol As Integer, ByRef CheckQtyCol As Integer, ByRef pBookType As String, ByRef pMKey As String, ByRef pCTNO As Double, ByRef pSuppCustCode As String, Optional ByRef CheckStock As Boolean = False) As Boolean
        On Error GoTo ErrPart
        Dim cntRow As Integer
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mCheckQty As Double
        Dim mItemCode As String
        Dim mStockQty As Double
        CheckCT1StockQty = True
        mStockQty = 0
        If CheckStock = False Then Exit Function
        With pSprd
            For cntRow = 1 To .MaxRows - 1
                .Row = cntRow
                .Col = ItemCodeCol
                mItemCode = Trim(.Text)
                .Col = CheckQtyCol
                mCheckQty = Val(.Text)
                mSqlStr = " SELECT SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY) AS QTY" & vbCrLf & " FROM FIN_CT1_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & MainClass.AllowSingleQuote(pBookType) & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pSuppCustCode) & "'" & vbCrLf & " AND CT_NO=" & pCTNO & ""
                If pMKey <> "" Then
                    mSqlStr = mSqlStr & vbCrLf & "AND MKEY<>'" & pMKey & "'"
                End If
                MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mStockQty = IIf(IsDBNull(RsTemp.Fields("QTY").Value), 0, RsTemp.Fields("QTY").Value)
                End If
                If mStockQty < mCheckQty Then
                    MsgInformation("You Have Not Enough C.T.1 Stock")
                    CheckCT1StockQty = False
                    Exit Function
                End If
NextRow:
            Next
        End With
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        CheckCT1StockQty = False
    End Function
    Public Function UpdateCT1TRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pCT1NO As Double, ByRef pCT1Date As String, ByRef pRefNo As String, ByRef pRefDate As String, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pItemQty As Double, ByRef pItemValue As Double) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim mCTStockCheck As Boolean
        Dim mSqlStr As String
        Dim RsTempUOM As ADODB.Recordset = Nothing
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Integer
        Dim mBalCTQty As Double
        If pBookType = "S" And pBookSubType = "O" Then
            mCTStockCheck = True
        ElseIf pBookType = "P" And pBookSubType = "I" Then
            mCTStockCheck = True
        Else
            mCTStockCheck = False
        End If
        If mCTStockCheck = True Then
            If pCT1Date = "" Then
                pCT1Date = GetCT1Date(pDBCn, pCT1NO, pItemCode, pBookType, pAccountCode)
            End If
            SqlStr = " SELECT ABS(SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)) AS ITEM_QTY " & vbCrLf & " FROM FIN_CT1_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND BOOKTYPE='" & pBookType & "'" & vbCrLf & " AND SUPP_CUST_CODE='" & pAccountCode & "'" & vbCrLf & " AND CT_NO=" & Val(CStr(pCT1NO)) & "" & vbCrLf & " AND CT_DATE=TO_DATE('" & VB6.Format(pCT1Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND ITEM_CODE ='" & pItemCode & "'"
            If pBookType = "S" Then
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',1,-1)*ITEM_QTY)>0"
            Else
                SqlStr = SqlStr & vbCrLf & " HAVING SUM(DECODE(BOOKSUBTYPE,'I',-1,1)*ITEM_QTY)>0"
            End If
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mBalCTQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
                If pItemQty > mBalCTQty Then
                    MsgBox("No Enough C.T. 1 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                    UpdateCT1TRN = False
                    Exit Function
                End If
            Else
                MsgBox("No Enough C.T. 1 Stock at Item Code " & pItemCode, MsgBoxStyle.Critical)
                UpdateCT1TRN = False
                Exit Function
            End If
        End If
        If (pBookType = "S" And pBookSubType = "I") Or (pBookType = "P" And pBookSubType = "O") Then
            mSqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempUOM, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTempUOM.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTempUOM.Fields("ISSUE_UOM").Value), "", RsTempUOM.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTempUOM.Fields("PURCHASE_UOM").Value), "", RsTempUOM.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTempUOM.Fields("UOM_FACTOR").Value) Or RsTempUOM.Fields("UOM_FACTOR").Value = 0, 1, RsTempUOM.Fields("UOM_FACTOR").Value)
            End If
            If mIssueUOM <> mPurchaseUOM Then
                pItemQty = pItemQty * mFactor
            End If
        End If
        If pCT1NO <> 0 And pItemQty > 0 Then
            SqlStr = "INSERT INTO FIN_CT1_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " REF_NO, REF_DATE, " & vbCrLf & " CT_NO, CT_DATE, " & vbCrLf & " SUPP_CUST_CODE, " & vbCrLf & " ITEM_CODE, ITEM_UOM, " & vbCrLf & " ITEM_QTY, ITEM_VALUE " & vbCrLf & " ) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', " & vbCrLf & " '" & pRefNo & "', TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " " & Val(CStr(pCT1NO)) & ", TO_DATE('" & VB6.Format(pCT1Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & pAccountCode & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "', '" & MainClass.AllowSingleQuote(pItemUOM) & "'," & vbCrLf & " " & pItemQty & ", " & pItemValue & ")"
            pDBCn.Execute(SqlStr)
        End If
        UpdateCT1TRN = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateCT1TRN = False
        ''Resume
    End Function
    Public Function UpdateOutwardDetail(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pAccountCode As String, ByRef pF4No As String, ByRef pF4Date As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pOutItemCode As String, ByRef pInItemCode As String, ByRef pItemQty As Double, ByRef pIO As String, ByRef pSubRowNo As Integer) As Boolean
        On Error GoTo ErrDetail
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pSubItemCode As String
        Dim mItemConsQty As Double
        Dim mItemF4ConsQty As Double
        Dim pConsUnit As Double
        'SqlStr = " DELETE FROM DSP_OUTWARD57F4_TRN " & vbCrLf _
        ''& " WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "" & vbCrLf _
        ''& " AND FYEAR=" & RsCompany.fields("FYEAR").value & "" & vbCrLf _
        ''& " AND MKEY=" & Val(pMKey) & "" & vbCrLf _
        ''& " AND ITEM_IO='" & pIO & "'"
        '
        'pDBCn.Execute SqlStr
        If pIO = "O" Then
            If pF4No <> "" And pItemQty > 0 Then
                SqlStr = "INSERT INTO DSP_OUTWARD57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " OUTWARD_F4NO, OUTWARD_F4DATE, " & vbCrLf & " SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, " & vbCrLf & " OUTWARD_ITEM_CODE," & vbCrLf & " INWARD_ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUBROWNO) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pOutItemCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf & " " & pItemQty & ", '" & pIO & "', " & vbCrLf & " " & pSubRowNo & " )" & vbCrLf
                pDBCn.Execute(SqlStr)
            End If
        Else
            SqlStr = "SELECT CONSUMPTION_UNIT,IH.ITEM_CODE,CONSUMPTION_UNIT, " & vbCrLf & " ID.CON_ITEM_CODE, ID.CONSUMPTION_QTY " & vbCrLf & " FROM DSP_CONSUMPTION_HDR IH,DSP_CONSUMPTION_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.COMPANY_CODE=ID.COMPANY_CODE " & vbCrLf & " AND IH.BOOKTYPE='G' " & vbCrLf & " AND IH.ITEM_CODE=ID.ITEM_CODE " & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.ITEM_CODE='" & pInItemCode & "'"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                Do While Not RsTemp.EOF
                    pOutItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("CON_ITEM_CODE").Value), "", RsTemp.Fields("CON_ITEM_CODE").Value))
                    pConsUnit = IIf(IsDBNull(RsTemp.Fields("CONSUMPTION_UNIT").Value), 0, RsTemp.Fields("CONSUMPTION_UNIT").Value)
                    If pConsUnit = 0 Then
                        mItemConsQty = 0
                    Else
                        mItemConsQty = IIf(IsDBNull(RsTemp.Fields("CONSUMPTION_QTY").Value), 0, RsTemp.Fields("CONSUMPTION_QTY").Value) * pItemQty / pConsUnit
                    End If
                    SqlStr = "INSERT INTO DSP_OUTWARD57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " OUTWARD_F4NO, OUTWARD_F4DATE, " & vbCrLf & " SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, " & vbCrLf & " OUTWARD_ITEM_CODE," & vbCrLf & " INWARD_ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUBROWNO) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pOutItemCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf & " " & mItemConsQty & ", '" & pIO & "', " & vbCrLf & " " & pSubRowNo & " )" & vbCrLf
                    pDBCn.Execute(SqlStr)
                    RsTemp.MoveNext()
                Loop
            Else
                pOutItemCode = pInItemCode
                SqlStr = "INSERT INTO DSP_OUTWARD57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " OUTWARD_F4NO, OUTWARD_F4DATE, " & vbCrLf & " SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, " & vbCrLf & " OUTWARD_ITEM_CODE," & vbCrLf & " INWARD_ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUBROWNO) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pOutItemCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pInItemCode) & "', " & vbCrLf & " " & pItemQty & ", '" & pIO & "', " & vbCrLf & " " & pSubRowNo & " )" & vbCrLf
                pDBCn.Execute(SqlStr)
            End If
        End If
        UpdateOutwardDetail = True
        Exit Function
ErrDetail:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateOutwardDetail = False
        ''Resume
    End Function
    Public Function SalePostTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pSaleBookType As String, ByRef pSaleBookSubType As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pCustomerCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pRemarks As String, ByRef pFOC As Boolean, ByRef pConsignee As String, ByRef pServiceTaxAmount As Double, ByRef pFOB As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mItemValue As Double,
                                ByRef mDivisionCode As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String = ""
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mNarration As String
        Dim mErrField As String = ""
        Dim mAlias As String
        Dim mDNmKey As String
        Dim mMRRNo As Double
        Dim mISMODVAT As String
        SqlStr = ""
        mSubRowNo = 1
        MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
        mAlias = MasterNo
        If pCancel = True Then
            mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
        Else
            If Trim(pConsignee) <> "" Then
                mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (" & pConsignee & ")"
            Else
                mNarration = "Bill No : " & mAlias & "-" & pBillNo
            End If
        End If
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pSaleBookType) & "' AND BOOKCODE='" & pBookCode & "'")
        If pCancel = True Or pFOC Then
            SalePostTRN = True
            Exit Function
        End If
        If pRejection = True Then
            If RsCompany.Fields("FYEAR").Value > 2014 Then
                SqlStr = "SELECT OUR_AUTO_KEY_SO FROM FIN_INVOICE_HDR WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & " AND MKey='" & UCase(pMKey) & "'"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                mISMODVAT = "N"
                If RsTemp.EOF = False Then
                    mDNmKey = IIf(IsDBNull(RsTemp.Fields("OUR_AUTO_KEY_SO").Value), "", RsTemp.Fields("OUR_AUTO_KEY_SO").Value)
                    If mDNmKey <> "" Then
                        SqlStr = "SELECT MRR_REF_NO FROM FIN_DNCN_DET WHERE MKey='" & mDNmKey & "'"
                        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTemp.EOF = False Then
                            mMRRNo = IIf(IsDBNull(RsTemp.Fields("MRR_REF_NO").Value), -1, RsTemp.Fields("MRR_REF_NO").Value)
                            If mMRRNo <> -1 Then
                                SqlStr = "SELECT ISMODVAT FROM FIN_PURCHASE_HDR WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " ANDAUTO_KEY_MRR=" & mMRRNo & "" ''FYEAR=" & RsCompany.fields("FYEAR").value & " AND
                                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                                If RsTemp.EOF = False Then
                                    mISMODVAT = IIf(IsDBNull(RsTemp.Fields("ISMODVAT").Value), "N", RsTemp.Fields("ISMODVAT").Value)
                                End If
                            End If
                        End If
                    End If
                End If
                If PurchaseRejBEDPostTRN(PubDBCn, pMKey, pCurrRowNo, pBookCode, pSaleBookType, pSaleBookSubType, "S", pBillNo, pBillDate, pBillNo, pBillDate, "O", pCustomerCode, pAccountCode, pCancel, pDueDate, "", mNarration, mISMODVAT, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            SalePostTRN = True
            Exit Function
        End If
        '************* (Invoice) Sale Item Value Posting *************************************'
        SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount," & vbCrLf & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf & " FROM FIN_INVOICE_DET " & vbCrLf & " WHERE FIN_INVOICE_DET.MKey='" & UCase(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsPostTrn.EOF = False Then
            mErrField = RsPostTrn.Fields("ErrField").Value
            mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
            If mAmount = 0 Then
                mAmount = mItemValue
            End If
            mAmount = mAmount + pFOB '' IIf(pNetBillValue = 0, 0, pFOB)
        Else
            mErrField = "[Sales Item Value (Invoice) Posting]"
            mAmount = mItemValue + pFOB
        End If
        mAmount = mAmount + GetSaleValue_IncludingED(pDBCn, pMKey, pCancel, pServiceTaxAmount) ''JUNE-2010
        mAccountCode = pAccountCode
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, pAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, "C", "O", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '************* (Invoice) Sale Expenses Posting *************************************'
        SqlStr = ""
        mAmount = 0
        RsPostTrn = Nothing
        SqlStr = "SELECT B.SalePostCode AS AccountCode, IDENTIFICATION, B.SALEEXPPOSTCODE, ISINCLUDING_SALES, " & vbCrLf & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N'"
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        SqlStr = SqlStr & vbCrLf & " GROUP BY B.SalePostCode,IDENTIFICATION,B.SALEEXPPOSTCODE, ISINCLUDING_SALES"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        If RsPostTrn.EOF = False Then
            Do While Not RsPostTrn.EOF
                mSubRowNo = mSubRowNo + 1
                mErrField = RsPostTrn.Fields("ErrField").Value
                ''JUNE-2010
                'If pServiceTaxAmount = 0 And RsCompany.fields("FYEAR").value > 2008 Then
                'If RsPostTrn!Identification = "ED" Or RsPostTrn!Identification = "EDU" Or RsPostTrn!Identification = "SHC" Or RsPostTrn!Identification = "ADE" Or RsPostTrn!Identification = "BCD" Or RsPostTrn!Identification = "CED" Or RsPostTrn!Identification = "HCC" Or RsPostTrn!Identification = "AEC" Or RsPostTrn!Identification = "AHC" Or RsPostTrn!Identification = "BCE" Then
                'GoTo NextRecd
                'End If
                'End If
                mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNTCODE").Value), "-1", RsPostTrn.Fields("ACCOUNTCODE").Value)

                If RsPostTrn.Fields("IDENTIFICATION").Value = "EDU" Then
                    If pServiceTaxAmount > 0 Then
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_CESS_SALE").Value), "-1", RsCompany.Fields("SRVTAX_CESS_SALE").Value)
                    End If
                ElseIf RsPostTrn.Fields("IDENTIFICATION").Value = "SHC" Then
                    If pServiceTaxAmount > 0 Then
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_SHCESS_SALE").Value), "-1", RsCompany.Fields("SRVTAX_SHCESS_SALE").Value)
                    End If
                End If
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If RsPostTrn.Fields("IDENTIFICATION").Value = "EE" Then
                    If RsPostTrn.Fields("Amount").Value > 0 Then
                        mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                        mDrCr = "D"
                    Else
                        mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                        mDrCr = "C"
                    End If
                Else
                    If RsPostTrn.Fields("Amount").Value > 0 Then
                        mAmount = RsPostTrn.Fields("Amount").Value
                        mDrCr = "C"
                    Else
                        mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                        mDrCr = "D"
                    End If
                End If
                If pNetBillValue = 0 And pFOB <> 0 And RsPostTrn.Fields("IDENTIFICATION").Value = "RO" Then
                    mAmount = System.Math.Abs(mAmount + IIf(mDrCr = "D", System.Math.Abs(pFOB), mDrCr))
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                If mAmount <> 0 Then
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "O", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    ''JUNE-2010
                    If RsPostTrn.Fields("ISINCLUDING_SALES").Value = "Y" And pServiceTaxAmount = 0 Then
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("SALEEXPPOSTCODE").Value), "-1", RsPostTrn.Fields("SALEEXPPOSTCODE").Value)
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "O", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                End If
NextRecd:
                RsPostTrn.MoveNext()
            Loop
        End If
        '************* Customer Posting *************************************'
        mErrField = "[Customer Posting]"
        mAccountCode = IIf(IsDBNull(pCustomerCode), -1, pCustomerCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue - IIf(pNetBillValue = 0, 0, pFOB)))
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, "D", "O", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '**********************************************************************'
        SalePostTRN = True
        Exit Function
SalePostTrnErr:
        SalePostTRN = False
        If mAccountCode = "-1" Then
            MsgBox("Sales Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SalePostTRN_GST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef _
            pSaleBookType As String, ByRef pSaleBookSubType As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pCustomerCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef _
            pCancel As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pRemarks As String, ByRef pFOC As Boolean,
            ByRef pConsignee As String, ByRef pServiceTaxAmount As Double, ByRef pFOB As Double, ByRef pCGSTAmount As Double,
            ByRef pIGSTAmount As Double, ByRef pSGSTAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mItemValue As Double, ByRef mDivisionCode As Double, ByRef pExportInvoice As String,
            ByRef pAdvCGST As Double, ByRef pAdvSGST As Double, ByRef pAdvIGST As Double, pBillToLocation As String, Optional ByRef pCustBillNo As String = "", Optional ByRef pCustBillDate As String = "",
                                    Optional ByRef mFirstRow As Boolean = True, Optional ByRef mServiceBill As Boolean = False, Optional ByRef pTotExp As Double = 0, Optional ByRef pNarration As String = "") As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mNarration As String
        Dim mErrField As String
        Dim mAlias As String
        Dim mDNmKey As String
        Dim mMRRNo As Double
        Dim mISMODVAT As String
        Dim mIncludeInSale As String
        Dim mScrapSale As String
        Dim mGSTRecoverable As String
        Dim mInvTypeCode As Long
        Dim pBillTRNType As String

        SqlStr = ""
        mSubRowNo = 1

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value = 101 Then
            pBillTRNType = IIf(pSaleBookType = "S", "B", "O")
        Else
            pBillTRNType = "B"
        End If


        MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
        mAlias = MasterNo
        If MainClass.ValidateWithMasterTable(pTRNType, "Code", "ISSCRAPSALE", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mScrapSale = MasterNo
        Else
            mScrapSale = "N"
        End If
        ''
        If pCustBillNo = "" Then
            pCustBillNo = pBillNo
            pCustBillDate = pBillDate
        End If
        If pCancel = True Then
            mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
        Else
            If pBookCode = ConSaleCreditBookCode Or pBookCode = ConSaleDebitBookCode Then
                mNarration = pNarration
            Else
                If Trim(pCustBillNo) = "" Then
                    If Trim(pConsignee) <> "" Then
                        mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (" & pConsignee & ")"
                    Else
                        mNarration = "Bill No : " & mAlias & "-" & pBillNo
                    End If
                Else
                    If Trim(pConsignee) <> "" Then
                        mNarration = "Bill No : " & mAlias & "-" & pCustBillNo & " (" & pConsignee & ")"
                    Else
                        mNarration = "Bill No : " & mAlias & "-" & pCustBillNo
                    End If
                End If
            End If

        End If

        If mFirstRow = True Then
            pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pSaleBookType) & "' AND BOOKCODE='" & pBookCode & "'")
        End If

        If pCancel = True Or pFOC Then
            SalePostTRN_GST = True
            Exit Function
        End If

        'If pRejection = True Then
        'If RsCompany.fields("FYEAR").value > 2014 Then
        'SqlStr = "SELECT OUR_AUTO_KEY_SO FROM FIN_INVOICE_HDR WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " AND FYEAR=" & RsCompany.fields("FYEAR").value & " AND MKey='" & UCase(pMkey) & "'"
        'MainClass.UOpenRecordSet SqlStr, pDBCn, adOpenStatic, RsTemp, adLockReadOnly
        '
        'mISMODVAT = "N"
        'If RsTemp.EOF = False Then
        'mDNmKey = IIf(IsNull(RsTemp!OUR_AUTO_KEY_SO), "", RsTemp!OUR_AUTO_KEY_SO)
        'If mDNmKey <> "" Then
        'SqlStr = "SELECT MRR_REF_NO FROM FIN_DNCN_DET WHERE MKey='" & mDNmKey & "'"
        'MainClass.UOpenRecordSet SqlStr, pDBCn, adOpenStatic, RsTemp, adLockReadOnly
        'If RsTemp.EOF = False Then
        'mMRRNo = IIf(IsNull(RsTemp!MRR_REF_NO), -1, RsTemp!MRR_REF_NO)
        'If mMRRNo <> -1 Then
        'SqlStr = "SELECT ISMODVAT FROM FIN_PURCHASE_HDR WHERE COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & " ANDAUTO_KEY_MRR=" & mMRRNo & "" ''FYEAR=" & RsCompany.fields("FYEAR").value & " AND
        'MainClass.UOpenRecordSet SqlStr, pDBCn, adOpenStatic, RsTemp, adLockReadOnly
        'If RsTemp.EOF = False Then
        'mISMODVAT = IIf(IsNull(RsTemp!ISMODVAT), "N", RsTemp!ISMODVAT)
        'End If
        'End If
        'End If
        'End If
        'End If
        '
        'If PurchaseRejBEDPostTRN(PubDBCn, pMkey, pCurrRowNo, _
        ''pBookCode, pSaleBookType, pSaleBookSubType, "S", pBillNo, pBillDate, pBillNo, pBillDate, "O", _
        ''pCustomerCode, pAccountCode, pCancel, _
        ''pDueDate, "", mNarration, _
        ''mISMODVAT, pADDMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr
        ' End If
        'SalePostTRN_GST = True
        'Exit Function
        'End If
        '************* (Invoice) Sale Item Value Posting *************************************'
        '' ConSalesBookCode = -2
        '' ConSaleSuppBookCode = -13
        '' ConSaleMiscBookCode = -17
        '' ConSaleDebitBookCode = -21
        If mFirstRow = True Then
            If CDbl(pBookCode) = ConSalesBookCode Or CDbl(pBookCode) = ConSaleSuppBookCode Or CDbl(pBookCode) = ConSaleMiscBookCode Then
                SqlStr = "SELECT" & vbCrLf _
                & " SUM(ITEM_AMT) AS Amount, ACCOUNT_POSTING_CODE," & vbCrLf _
                & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf _
                & " FROM FIN_INVOICE_DET " & vbCrLf _
                & " WHERE FIN_INVOICE_DET.MKey='" & UCase(pMKey) & "' GROUP BY ACCOUNT_POSTING_CODE" '' HAVING SUM(ITEM_AMT)<>NULL"
            ElseIf CDbl(pBookCode) = ConSaleDebitBookCode Or CDbl(pBookCode) = ConSaleCreditBookCode Then
                If mServiceBill = False Then
                    SqlStr = "SELECT" & vbCrLf _
                        & " SUM(AMOUNT) AS Amount, -1 AS ACCOUNT_POSTING_CODE," & vbCrLf _
                        & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf _
                        & " FROM FIN_SUPP_SALE_DET " & vbCrLf _
                        & " WHERE MKey='" & UCase(pMKey) & "'" '' HAVING SUM(AMOUNT)<>NULL"
                Else
                    SqlStr = "SELECT" & vbCrLf _
                        & " SUM(ITEMVALUE) AS Amount, -1 AS ACCOUNT_POSTING_CODE," & vbCrLf _
                        & " '[Sales Value (Invoice) Posting]' AS ErrField " & vbCrLf _
                        & " FROM FIN_SUPP_SALE_HDR " & vbCrLf _
                        & " WHERE MKey='" & UCase(pMKey) & "'" '' HAVING SUM(AMOUNT)<>NULL"
                End If

            Else
                SalePostTRN_GST = False
                MsgInformation("Please check the Sale Code.")
                Exit Function
            End If
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)

            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    'mAmount = mAmount + pTotExp
                    mInvTypeCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_POSTING_CODE").Value), -1, RsPostTrn.Fields("ACCOUNT_POSTING_CODE").Value)
                    'If mAmount = 0 Then
                    '    mAmount = mItemValue
                    'End If
                    'mAmount = mAmount + pFOB '' IIf(pNetBillValue = 0, 0, pFOB)

                    If pCGSTAmount + pSGSTAmount + pIGSTAmount = 0 Then
                        mAmount = mAmount
                    Else
                        mAmount = mAmount + GetSaleValue_IncludingGST(pDBCn, pBookCode, pMKey, pCancel, pServiceTaxAmount)
                    End If

                    ''
                    If MainClass.ValidateWithMasterTable(mInvTypeCode, "CODE", "ACCOUNTPOSTCODE", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then    '' AND CATEGORY='S'
                        mAccountCode = IIf(MasterNo = "", "-1", MasterNo)
                    Else
                        mAccountCode = "-1"
                    End If

                    If mAccountCode = "-1" Or mAccountCode = "0" Or mAccountCode = "" Then
                        mAccountCode = pAccountCode
                    End If

                    If mAccountCode = "-1" Or mAccountCode = "0" Or mAccountCode = "" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C"), pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                    End If

                    RsPostTrn.MoveNext()
                Loop
            Else
                mErrField = "[Sales Item Value (Invoice) Posting]"
                mAmount = mItemValue + pFOB

                If pCGSTAmount + pSGSTAmount + pIGSTAmount = 0 Then
                    mAmount = mAmount
                Else
                    mAmount = mAmount + GetSaleValue_IncludingGST(pDBCn, pBookCode, pMKey, pCancel, pServiceTaxAmount)
                End If

                mAccountCode = pAccountCode
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If pCancel = True Then
                    mAmount = 0
                End If
                If mAmount <> 0 Then
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, pAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C"), pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                End If
            End If
        End If


        '************* (Invoice) GST Posting*************************************'
        If mFirstRow = True Then
            ''CGST Posting...
            mAmount = pCGSTAmount - pAdvCGST
            mSubRowNo = mSubRowNo + 1
            mErrField = "CGST Account Posting Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_SALECODE").Value), "-1", RsCompany.Fields("CGST_SALECODE").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                If MainClass.ValidateWithMasterTable("CGS", "IDENTIFICATION", "ISINCLUDING_SALES", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                    mIncludeInSale = MasterNo
                Else
                    mIncludeInSale = "N"
                End If
                If mIncludeInSale = "Y" Then
                    If MainClass.ValidateWithMasterTable("CGS", "IDENTIFICATION", "SALEEXPPOSTCODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mAccountCode = MasterNo
                    Else
                        mAccountCode = "-1"
                    End If
                    mDrCr = IIf(mDrCr = "D", "C", "D")
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                End If
                If pExportInvoice = "Y" Then
                    If MainClass.ValidateWithMasterTable("CGS", "IDENTIFICATION", "IS_GSTRECOVERABLE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mGSTRecoverable = MasterNo
                    Else
                        mGSTRecoverable = "N"
                    End If
                    If mGSTRecoverable = "Y" Then
                        If MainClass.ValidateWithMasterTable("CGS", "IDENTIFICATION", "GSTRECOVERABLECODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                            mAccountCode = MasterNo
                        Else
                            mAccountCode = "-1"
                        End If
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                    End If
                End If
            End If
            ''IGST Posting...
            mAmount = pIGSTAmount - pAdvIGST
            mSubRowNo = mSubRowNo + 1
            mErrField = "IGST Account Posting Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_SALECODE").Value), "-1", RsCompany.Fields("IGST_SALECODE").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                If MainClass.ValidateWithMasterTable("IGS", "IDENTIFICATION", "ISINCLUDING_SALES", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                    mIncludeInSale = MasterNo
                Else
                    mIncludeInSale = "N"
                End If
                If mIncludeInSale = "Y" Then
                    If MainClass.ValidateWithMasterTable("IGS", "IDENTIFICATION", "SALEEXPPOSTCODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mAccountCode = MasterNo
                    Else
                        mAccountCode = "-1"
                    End If
                    mDrCr = IIf(mDrCr = "D", "C", "D")
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                End If
                If pExportInvoice = "Y" Then
                    If MainClass.ValidateWithMasterTable("IGS", "IDENTIFICATION", "IS_GSTRECOVERABLE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mGSTRecoverable = MasterNo
                    Else
                        mGSTRecoverable = "N"
                    End If
                    If mGSTRecoverable = "Y" Then
                        If MainClass.ValidateWithMasterTable("IGS", "IDENTIFICATION", "GSTRECOVERABLECODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                            mAccountCode = MasterNo
                        Else
                            mAccountCode = "-1"
                        End If
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                    End If
                End If
            End If
            ''SGST Posting...
            mAmount = pSGSTAmount - pAdvSGST
            mSubRowNo = mSubRowNo + 1
            mErrField = "SGST Account Posting Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_SALECODE").Value), "-1", RsCompany.Fields("SGST_SALECODE").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                If MainClass.ValidateWithMasterTable("SGS", "IDENTIFICATION", "ISINCLUDING_SALES", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                    mIncludeInSale = MasterNo
                Else
                    mIncludeInSale = "N"
                End If
                If mIncludeInSale = "Y" Then
                    If MainClass.ValidateWithMasterTable("SGS", "IDENTIFICATION", "SALEEXPPOSTCODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mAccountCode = MasterNo
                    Else
                        mAccountCode = "-1"
                    End If
                    mDrCr = IIf(mDrCr = "D", "C", "D")
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                End If
                If pExportInvoice = "Y" Then
                    If MainClass.ValidateWithMasterTable("SGS", "IDENTIFICATION", "IS_GSTRECOVERABLE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                        mGSTRecoverable = MasterNo
                    Else
                        mGSTRecoverable = "N"
                    End If
                    If mGSTRecoverable = "Y" Then
                        If MainClass.ValidateWithMasterTable("SGS", "IDENTIFICATION", "GSTRECOVERABLECODE", "FIN_INTERFACE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "AND GST_ENABLED='Y'") = True Then
                            mAccountCode = MasterNo
                        Else
                            mAccountCode = "-1"
                        End If
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                    End If
                End If
            End If

            ''************* (Invoice) Sale Expenses Posting *************************************'
            SqlStr = ""
            mAmount = 0
            RsPostTrn = Nothing
            If CDbl(pBookCode) = ConSalesBookCode Or CDbl(pBookCode) = ConSaleSuppBookCode Or CDbl(pBookCode) = ConSaleMiscBookCode Then
                SqlStr = "SELECT B.SalePostCode AS AccountCode, IDENTIFICATION, B.SALEEXPPOSTCODE, ISINCLUDING_SALES, SCRAPPOSTCODE, " & vbCrLf & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "'AND IDENTIFICATION NOT IN ('CGS','SGS','IGS') "
                SqlStr = SqlStr & vbCrLf & " AND DUTYFORGONE='N'"
            ElseIf CDbl(pBookCode) = ConSaleDebitBookCode Or CDbl(pBookCode) = ConSaleCreditBookCode Then
                SqlStr = "SELECT B.SalePostCode AS AccountCode, IDENTIFICATION, B.SALEEXPPOSTCODE, ISINCLUDING_SALES,SCRAPPOSTCODE, " & vbCrLf _
                    & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf _
                    & " FROM FIN_SUPP_SALE_EXP A,FIN_INTERFACE_MST B " & vbCrLf _
                    & " WHERE A.ExpCode=B.Code " & vbCrLf _
                    & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
                    & " AND A.MKey='" & UCase(pMKey) & "'AND IDENTIFICATION NOT IN ('CGS','SGS','IGS') "
            Else
            End If
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            SqlStr = SqlStr & vbCrLf & " GROUP BY B.SalePostCode,IDENTIFICATION,B.SALEEXPPOSTCODE, ISINCLUDING_SALES, SCRAPPOSTCODE"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While Not RsPostTrn.EOF
                    mSubRowNo = mSubRowNo + 1
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    If mScrapSale = "Y" And RsPostTrn.Fields("IDENTIFICATION").Value = "TCS" Then '
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("SCRAPPOSTCODE").Value), "-1", RsPostTrn.Fields("SCRAPPOSTCODE").Value)
                    Else
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNTCODE").Value), "-1", RsPostTrn.Fields("ACCOUNTCODE").Value)
                    End If
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    If RsPostTrn.Fields("IDENTIFICATION").Value = "EE" Then
                        If RsPostTrn.Fields("Amount").Value > 0 Then
                            mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                            mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
                        Else
                            mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                            mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
                        End If
                    Else
                        If RsPostTrn.Fields("Amount").Value > 0 Then
                            mAmount = RsPostTrn.Fields("Amount").Value
                            mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
                        Else
                            mAmount = System.Math.Abs(RsPostTrn.Fields("Amount").Value)
                            mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
                        End If
                    End If
                    If pNetBillValue = 0 And pFOB <> 0 And RsPostTrn.Fields("IDENTIFICATION").Value = "RO" Then
                        mAmount = System.Math.Abs(mAmount + IIf(mDrCr = "D", System.Math.Abs(pFOB), mDrCr))
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                        ''NOt Required
                        If RsPostTrn.Fields("ISINCLUDING_SALES").Value = "Y" Then
                            mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("SALEEXPPOSTCODE").Value), "-1", RsPostTrn.Fields("SALEEXPPOSTCODE").Value)
                            mDrCr = IIf(mDrCr = "D", "C", "D")
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            mSubRowNo = mSubRowNo + 1
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
                        End If
                    End If
NextRecd:
                    RsPostTrn.MoveNext()
                Loop
            End If
        End If

        '************* Customer Posting *************************************'
        mErrField = "[Customer Posting]"
        mAccountCode = IIf(IsDBNull(pCustomerCode), -1, pCustomerCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue - IIf(pNetBillValue = 0, 0, pFOB)))
        If pExportInvoice = "Y" Then
            mAmount = mAmount - GetGSTRecoveable_Export(pDBCn, pBookCode, pMKey, pCancel)
        End If
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D"), pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
        End If

        If mFirstRow = True Then
            '************* Advance PAyment Posting *************************************'
            ''pAdvCGST As Double, pAdvSGST As Double, pAdvIGST As Double
            ''CGST Advance Posting...
            mAmount = pAdvCGST
            mSubRowNo = mSubRowNo + 1

            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                mErrField = "CGST Advance Account Posting Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_ADV_RECEIPTCODE").Value), "-1", RsCompany.Fields("CGST_ADV_RECEIPTCODE").Value)
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
            End If
            ''IGST Posting...
            mAmount = pAdvIGST
            mSubRowNo = mSubRowNo + 1

            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                mErrField = "IGST Advance Account Posting Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_ADV_RECEIPTCODE").Value), "-1", RsCompany.Fields("IGST_ADV_RECEIPTCODE").Value)
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
            End If
            ''SGST Advance Posting...
            mAmount = pAdvSGST
            mSubRowNo = mSubRowNo + 1

            If mAmount > 0 Then
                mAmount = mAmount
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "D", "C")
            Else
                mAmount = System.Math.Abs(mAmount)
                mDrCr = IIf(CDbl(pBookCode) = ConSaleDebitBookCode, "C", "D")
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                mErrField = "SGST Advance Account Posting Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_ADV_RECEIPTCODE").Value), "-1", RsCompany.Fields("SGST_ADV_RECEIPTCODE").Value)
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pCustBillNo, pCustBillDate, mAmount, mDrCr, pBillTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pBillToLocation) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**********************************************************************'
        SalePostTRN_GST = True
        Exit Function
SalePostTrnErr:
        SalePostTRN_GST = False
        If mAccountCode = "-1" Then
            MsgBox("Sales Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SalePostTRN_RC_GST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pSaleBookType As String, ByRef pSaleBookSubType As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pCustomerCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pRemarks As String,
                                       ByRef pFOC As Boolean, ByRef pConsignee As String, ByRef pServiceTaxAmount As Double, ByRef pFOB As Double,
                                       ByRef pCGSTAmount As Double, ByRef pIGSTAmount As Double, ByRef pSGSTAmount As Double, ByRef pCGSTClaimAmount As Double, ByRef pIGSTClaimAmount As Double, ByRef pSGSTClaimAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mItemValue As Double, ByRef mDivisionCode As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsPostTrn As ADODB.Recordset
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mNarration As String
        Dim mErrField As String
        Dim mAlias As String
        Dim mDNmKey As String
        Dim mMRRNo As Double
        Dim mISMODVAT As String
        Dim RsAccPosting As ADODB.Recordset = Nothing
        Dim mHSNCode As String
        Dim mPurKey As String
        SqlStr = ""
        mSubRowNo = 1
        MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
        mAlias = MasterNo
        If pCancel = True Then
            mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
        Else
            If Trim(pConsignee) <> "" Then
                mNarration = "Bill No : " & mAlias & "-" & pBillNo & " (" & pConsignee & ")"
            Else
                mNarration = "Bill No : " & mAlias & "-" & pBillNo
            End If
        End If
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pSaleBookType) & "' AND BOOKCODE='" & pBookCode & "'")
        If pCancel = True Or pFOC Then
            SalePostTRN_RC_GST = True
            Exit Function
        End If
        '************* (Invoice) GST PostingCredit Entry *************************************'
        ''CGST Posting...
        mAmount = pCGSTAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "CGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_RC_SALECODE").Value), "-1", RsCompany.Fields("CGST_RC_SALECODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''IGST Posting...
        mAmount = pIGSTAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "IGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_RC_SALECODE").Value), "-1", RsCompany.Fields("IGST_RC_SALECODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''SGST Posting...
        mAmount = pSGSTAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "SGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_RC_SALECODE").Value), "-1", RsCompany.Fields("SGST_RC_SALECODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '************* (Invoice) GST PostingDebit Entry *************************************'
        ''CGST Posting...
        mAmount = pCGSTClaimAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "CGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_RC_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''IGST Posting...
        mAmount = pIGSTClaimAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "IGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_RC_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''SGST Posting...
        mAmount = pSGSTClaimAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "SGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_RC_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''Expense Account Posting
        If System.Math.Round((pCGSTAmount + pSGSTAmount + pIGSTAmount) - (pCGSTClaimAmount + pSGSTClaimAmount + pIGSTClaimAmount), 0) <> 0 Then
            mAmount = (pCGSTAmount + pSGSTAmount + pIGSTAmount) - (pCGSTClaimAmount + pSGSTClaimAmount + pIGSTClaimAmount)
            SqlStr = "SELECT DISTINCT A.HSNCODE, A.O_MKEY, A.RCTYPE, B.GST_APP " & vbCrLf & " FROM FIN_INVOICE_DET A, GEN_HSN_MST B " & vbCrLf & " WHERE A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf & " AND A.HSNCODE=B.HSN_CODE " & vbCrLf & " AND A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKEY='" & pMKey & "' " 'AND B.GST_APP='N'
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsAccPosting, ADODB.LockTypeEnum.adLockReadOnly)
            If RsAccPosting.EOF = False Then
                Do While RsAccPosting.EOF = False
                    mHSNCode = IIf(IsDBNull(RsAccPosting.Fields("HSNCODE").Value), "", RsAccPosting.Fields("HSNCODE").Value)
                    mPurKey = IIf(IsDBNull(RsAccPosting.Fields("O_MKEY").Value), "", RsAccPosting.Fields("O_MKEY").Value)
                    mAmount = 0
                    If RsAccPosting.Fields("RCTYPE").Value = "M" Then
                        SqlStr = " SELECT SUM(CGST_AMOUNT + SGST_AMOUNT + IGST_AMOUNT) AS AMOUNT, PUR_ACCOUNT_CODE " & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND MKEY='" & mPurKey & "' AND HSNCODE='" & mHSNCode & "' GROUP BY PUR_ACCOUNT_CODE"
                        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTemp.EOF = False Then
                            Do While RsTemp.EOF = False
                                mSubRowNo = mSubRowNo + 1
                                mErrField = "Expense Account Posting Error"
                                mAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 0, RsTemp.Fields("Amount").Value)
                                mAccountCode = IIf(IsDBNull(RsTemp.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsTemp.Fields("PUR_ACCOUNT_CODE").Value)
                                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                                If mAmount > 0 Then
                                    mAmount = mAmount
                                    mDrCr = "D"
                                Else
                                    mAmount = System.Math.Abs(mAmount)
                                    mDrCr = "C"
                                End If
                                If pCancel = True Then
                                    mAmount = 0
                                End If
                                If mAmount <> 0 Then
                                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                                End If
                                RsTemp.MoveNext()
                            Loop
                        End If
                    Else
                        SqlStr = " SELECT SUM(CGST_AMOUNT + SGST_AMOUNT + IGST_AMOUNT) AS AMOUNT, ACCOUNTCODE " & vbCrLf & " FROM FIN_VOUCHER_DET " & vbCrLf & " WHERE COMPANYCODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND MKEY='" & mPurKey & "' AND SAC='" & mHSNCode & "' GROUP BY ACCOUNTCODE"
                        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                        If RsTemp.EOF = False Then
                            Do While RsTemp.EOF = False
                                mSubRowNo = mSubRowNo + 1
                                mErrField = "Expense Account Posting Error"
                                mAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 0, RsTemp.Fields("Amount").Value)
                                mAccountCode = IIf(IsDBNull(RsTemp.Fields("ACCOUNTCODE").Value), "-1", RsTemp.Fields("ACCOUNTCODE").Value)
                                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                                If mAmount > 0 Then
                                    mAmount = mAmount
                                    mDrCr = "D"
                                Else
                                    mAmount = System.Math.Abs(mAmount)
                                    mDrCr = "C"
                                End If
                                If pCancel = True Then
                                    mAmount = 0
                                End If
                                If mAmount <> 0 Then
                                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "S", pSaleBookType, pSaleBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", mNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                                End If
                                RsTemp.MoveNext()
                            Loop
                        End If
                    End If
                    RsAccPosting.MoveNext()
                Loop
            End If
        End If
        SalePostTRN_RC_GST = True
        Exit Function
SalePostTrnErr:
        'Resume
        SalePostTRN_RC_GST = False
        If mAccountCode = "-1" Then
            MsgBox("Sales Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function UpdateReworkTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefNo As Double, ByRef pRefDate As String, ByRef pRefType As String, ByRef pSBNo As String, ByRef pSBDate As String, ByRef pItemCode As String, ByRef pItemQty As Double, ByRef pItemUOM As String, ByRef pItemRate As Double, ByRef pStockType As String, ByRef pIO As String, ByRef pCompletionDate As String, ByRef pDivCode As Integer, ByRef pDeptCode As String, ByRef xFGBatchNo As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If pItemQty > 0 Then
            If Trim(xFGBatchNo) = "0" Or Trim(xFGBatchNo) = "" Then
                xFGBatchNo = ""
            Else
                xFGBatchNo = xFGBatchNo
            End If
            SqlStr = "INSERT INTO PRD_REWORK_TRN ( " & vbCrLf & " COMPANY_CODE, FYEAR, AUTO_KEY_REF, REF_DATE, " & vbCrLf & " REF_TYPE, " & vbCrLf & " AUTO_KEY_SBRWK, SB_DATE, " & vbCrLf & " ITEM_CODE, ITEM_QTY, ITEM_UOM, " & vbCrLf & " ITEM_RATE , STOCK_TYPE, ITEM_IO, COMPLETION_DATE,DIV_CODE,DEPT_CODE,BATCH_NO " & vbCrLf & " ) VALUES ( " & vbCrLf & " " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & Val(CStr(pRefNo)) & ", TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pRefType & "', " & vbCrLf & " " & Val(pSBNo) & ", TO_DATE('" & VB6.Format(pSBDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "', " & Val(CStr(pItemQty)) & ", '" & MainClass.AllowSingleQuote(pItemUOM) & "'," & vbCrLf & " " & Val(CStr(pItemRate)) & ", '" & MainClass.AllowSingleQuote(pStockType) & "', '" & pIO & "'," & vbCrLf & " TO_DATE('" & VB6.Format(pCompletionDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & pDivCode & ",'" & pDeptCode & "', '" & xFGBatchNo & "'" & vbCrLf & " )"
            pDBCn.Execute(SqlStr)
        End If
        UpdateReworkTRN = True
        Exit Function
UpdateStockTRNErr:
        'Resume Next
        UpdateReworkTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function UpdateBondedStockTRN(ByRef pDBCn As ADODB.Connection, ByRef pRefType As String, ByRef pRefNo As String, ByRef pSerailNo As Integer, ByRef pRefDate As String, ByRef pQCDate As String, ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pItemMark As String, ByRef pItemQty As Double, ByRef pRejQty As Double, ByRef pIO As String, ByRef pCancelled As String, ByRef pDescription As String, ByRef pPartyCode As String, ByRef pStockID As String) As Boolean
        On Error GoTo UpdateStockTRNErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim mItemCost As Double
        If pCancelled = "Y" Then
            UpdateBondedStockTRN = True
            Exit Function
        End If
        If pItemQty > 0 Then
            SqlStr = "INSERT INTO EXP_STOCK_REC_TRN ( " & vbCrLf & " COMPANY_CODE, FYEAR, SERIAL_NO, " & vbCrLf & " REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf & " REF_DATE, ITEM_CODE, " & vbCrLf & " ITEM_UOM, ITEM_MARK, STOCK_TYPE, ITEM_QTY, " & vbCrLf & " ITEM_IO, REMARKS, PARTYCODE ) VALUES ( " & vbCrLf & " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf & " TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', " & Val(pItemMark) & ", " & vbCrLf & " 'ST', " & Val(CStr(pItemQty)) & ",'" & pIO & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pDescription) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pPartyCode) & "')"
            pDBCn.Execute(SqlStr)
        End If
        If pRejQty > 0 Then
            SqlStr = "INSERT INTO EXP_STOCK_REC_TRN ( " & vbCrLf & " COMPANY_CODE, FYEAR, SERIAL_NO, " & vbCrLf & " REF_TYPE, STOCK_ID, REF_NO, " & vbCrLf & " REF_DATE, ITEM_CODE, " & vbCrLf & " ITEM_UOM, ITEM_MARK, STOCK_TYPE, ITEM_QTY, " & vbCrLf & " ITEM_IO, REMARKS, PARTYCODE ) VALUES ( " & vbCrLf & " " & RsCompany.Fields("Company_Code").Value & "," & RsCompany.Fields("FYEAR").Value & ", " & vbCrLf & " " & pSerailNo & ",'" & pRefType & "', '" & pStockID & "', " & Val(pRefNo) & ", " & vbCrLf & " TO_DATE('" & VB6.Format(pRefDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " '" & MainClass.AllowSingleQuote(pItemUOM) & "', " & Val(pItemMark) & ", " & vbCrLf & " 'RJ', " & Val(CStr(pRejQty)) & ",'" & pIO & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pDescription) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pPartyCode) & "')"
            pDBCn.Execute(SqlStr)
        End If
        UpdateBondedStockTRN = True
        Exit Function
UpdateStockTRNErr:
        'Resume Next
        UpdateBondedStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function PurchasePostTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String,
                                    ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String,
                                    ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pItemValue As Double, ByRef pNetBillValue As Double,
                                    ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pRemarks As String,
                                    ByRef pExpAmount As Double, ByRef pEDAmount As Double, ByRef pSTAmount As Double, ByRef pMODVATAmount As Double, ByRef pCESSAmount As Double,
                                    ByRef pSTRefundAmount As Double, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pISServClaim As Object, ByRef pServiceAmtModvat As Object, ByRef pItemType As String,
                                    ByRef pTDSDeduct As String, ByRef pTDSAmount As Double, ByRef pISCapital As String, ByRef pMRRDate As String, ByRef pADEAmt As Double, ByRef pSHECAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef pAddDutyPer As Double, ByRef pSUROnSTRefundAmount As Double, ByRef mDivisionCode As Double,
                                    ByRef pKKCESSAmount As Double, ByRef pLoactionID As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        Dim mAlias As String
        Dim RSExp As ADODB.Recordset
        Dim mServicePostAmt As Double
        Dim mLeasePO As String
        Dim pLeaseSuppAmount As Double
        Dim RsPO As ADODB.Recordset = Nothing
        Dim mPONo As Double
        Dim pLeasePosting As Double
        SqlStr = ""
        mSubRowNo = 1
        'pISMODVATE = IIf(RsCompany.fields("FYEAR").value < 2008, pISMODVATE, "N") ''JUNE-2010
        mLeasePO = "N"
        pLeaseSuppAmount = 0
        mPONo = -1
        pLeasePosting = 0
        SqlStr = "SELECTCUST_REF_NO" & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPO, ADODB.LockTypeEnum.adLockReadOnly)
        If RsPO.EOF = False Then
            mPONo = IIf(IsDBNull(RsPO.Fields("CUST_REF_NO").Value), -1, IIf(Left(RsPO.Fields("CUST_REF_NO").Value, 1) = "S", -1, RsPO.Fields("CUST_REF_NO").Value))
        End If
        If mPONo <> -1 Then
            SqlStr = "SELECT PUR_TYPE, ORDER_TYPE, ACCTPOST_DETAIL" & vbCrLf & " FROM PUR_PURCHASE_HDR " & vbCrLf & " WHERE AUTO_KEY_PO=" & Val(CStr(mPONo)) & "" & vbCrLf & " AND PUR_TYPE='L'"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPO, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPO.EOF = False Then
                pLeasePosting = IIf(IsDBNull(RsPO.Fields("ACCTPOST_DETAIL").Value), 0, RsPO.Fields("ACCTPOST_DETAIL").Value)
                mLeasePO = "Y"
            End If
        End If
        If pISMODVATE = "Y" Then
            pExpAmount = pExpAmount - pMODVATAmount
            pExpAmount = pExpAmount - pCESSAmount
            pExpAmount = pExpAmount - pSHECAmount
            pExpAmount = pExpAmount - pADEAmt
        End If
        If pISServClaim = "Y" Then
            pExpAmount = pExpAmount - pServiceAmtModvat
            If pISMODVATE = "N" Then
                pExpAmount = pExpAmount - pCESSAmount 'DD***********
                pExpAmount = pExpAmount - pSHECAmount
            End If
            pExpAmount = pExpAmount - pKKCESSAmount
        End If
        If pISSTRefund = "Y" Then
            pExpAmount = pExpAmount - pSTRefundAmount
            pExpAmount = pExpAmount - pSUROnSTRefundAmount
        End If
        If pISCSTRefund = "Y" Then
            pExpAmount = pExpAmount - pSTRefundAmount
        End If
        If pISCapital = "Y" Then
            pExpAmount = pExpAmount - pMODVATAmount
            pExpAmount = pExpAmount - pCESSAmount 'DD ***********
            pExpAmount = pExpAmount - pSHECAmount
            pExpAmount = pExpAmount - IIf(pAddDutyPer = 50, pADEAmt, 0)
        End If
        pNarration = IIf(pNarration = "", "", IIf(pBookSubType = "J", " ( JobWork of :", " ( Cost of :")) & pNarration & IIf(pNarration = "", "", " )")
        MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
        mAlias = MasterNo
        If pCancel = True Then
            pNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
        Else
            pNarration = "Bill No : " & mAlias & "-" & pBillNo & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookCode='" & UCase(pBookCode) & "'")
        If pCancel = True Or pFOC = True Then
            PurchasePostTRN = True
            Exit Function
        End If
        If mLeasePO = "N" Then
            SqlStr = "SELECT B.PurchasePostCode AS AccountCode, " & vbCrLf & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND SERVTAXABLE='Y'"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
            'If PubGSTApplicable = True Then
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            'Else
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
            'End If
            SqlStr = SqlStr & vbCrLf & " GROUP BY B.PurchasePostCode"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("AccountCode").Value), 0, RsPostTrn.Fields("AccountCode").Value)
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    pExpAmount = pExpAmount - mAmount
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
            '************* (Invoice) PURCHASE Item Value Posting *************************************'
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' GROUP BY PUR_ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While RsPostTrn.EOF = False
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        'mAmount = mAmount + pExpAmount
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_CODE").Value)
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                Else
                    mAccountCode = "-1"
                    GoTo SalePostTrnErr
                End If
            End If
        End If
        If pISMODVATE = "Y" Then
            mErrField = "Modvat Expenses Error"
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                mSubRowNo = mSubRowNo + 1
                mErrField = "Modvat Expenses Error"
                If pItemType = "R" Then
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATRAWACCOUNT").Value), "-1", RsCompany.Fields("MODVATRAWACCOUNT").Value)
                Else
                    mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATOTHACCOUNT").Value), "-1", RsCompany.Fields("MODVATOTHACCOUNT").Value)
                End If
                If pMODVATAmount > 0 Then
                    mAmount = pMODVATAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pMODVATAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, IS_RM," & vbCrLf & " '[Modvat Expenses Error]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.IS_RM"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mSubRowNo = mSubRowNo + 1
                        pItemType = IIf(IsDBNull(RsPostTrn.Fields("IS_RM").Value), "Y", RsPostTrn.Fields("IS_RM").Value)
                        pItemType = IIf(pItemType = "Y", "R", "O'")
                        If pItemType = "R" Then
                            mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATRAWACCOUNT").Value), "-1", RsCompany.Fields("MODVATRAWACCOUNT").Value)
                        Else
                            mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATOTHACCOUNT").Value), "-1", RsCompany.Fields("MODVATOTHACCOUNT").Value)
                        End If
                        If pMODVATAmount > 0 Then
                            mAmount = pMODVATAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pMODVATAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            End If
            'Adddition Duty of Excise Posting ..............
            mSubRowNo = mSubRowNo + 1
            mErrField = "A.D.E. Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("ADE_PUR_ACCOUNT").Value), "-1", RsCompany.Fields("ADE_PUR_ACCOUNT").Value)
            If pADEAmt > 0 Then
                mAmount = pADEAmt
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pADEAmt)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISServClaim = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Service Claim Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAXACCOUNT").Value), "-1", RsCompany.Fields("SRVTAXACCOUNT").Value)
            If pServiceAmtModvat > 0 Then
                mAmount = pServiceAmtModvat
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pServiceAmtModvat)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**************************12/07/2004 FROM CESS AMOUNT****************************************************
        If pISMODVATE = "Y" Or pISServClaim = "Y" Then 'DD***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "CESS Expenses Error"
            If pISMODVATE = "Y" Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CESSACCOUNT").Value), "-1", RsCompany.Fields("CESSACCOUNT").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_CESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_CESSACCOUNT").Value)
            End If
            If pCESSAmount > 0 Then
                mAmount = pCESSAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pCESSAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**************************102-03-2007 FROM S.H.E.CESS AMOUNT****************************************************
        If pISMODVATE = "Y" Or pISServClaim = "Y" Then 'DD***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "CESS Expenses Error"
            If pISMODVATE = "Y" Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SHCESSACCOUNT").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value)
            End If
            If pSHECAmount > 0 Then
                mAmount = pSHECAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pSHECAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**************************29/06/2016 FROM KK CESS AMOUNT****************************************************
        If pISServClaim = "Y" Then 'DD***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "KK CESS Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_KKCESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_KKCESSACCOUNT").Value)
            If pKKCESSAmount > 0 Then
                mAmount = pKKCESSAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pKKCESSAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '******************************************************************************
        If pISSTRefund = "Y" Then
            mSubRowNo = mSubRowNo + 1
            If RsCompany.Fields("IS_STRECEIVABLE").Value = "Y" And RsCompany.Fields("FYEAR").Value >= 2012 And pISCapital = "Y" Then
                mErrField = "ST Receivable Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("STRECEIVABLEACCOUNT").Value), "-1", RsCompany.Fields("STRECEIVABLEACCOUNT").Value)
            Else
                mErrField = "ST Refund Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("STREFUNDACCOUNT").Value), "-1", RsCompany.Fields("STREFUNDACCOUNT").Value)
            End If
            If pSTRefundAmount > 0 Then
                mAmount = pSTRefundAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pSTRefundAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            '' SurCharge on Vat
            mSubRowNo = mSubRowNo + 1
            mErrField = "Surcharge On Vat Refund Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SUR_VAT_PUR_ACCOUNT").Value), "-1", RsCompany.Fields("SUR_VAT_PUR_ACCOUNT").Value)
            If pSUROnSTRefundAmount > 0 Then
                mAmount = pSUROnSTRefundAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pSUROnSTRefundAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISCSTRefund = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "CST Refund Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CSTREFUNDACCOUNT").Value), "-1", RsCompany.Fields("CSTREFUNDACCOUNT").Value)
            If pSTRefundAmount > 0 Then
                mAmount = pSTRefundAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pSTRefundAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISCapital = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Modvat Receivable Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATRECDACCOUNT").Value), "-1", RsCompany.Fields("MODVATRECDACCOUNT").Value)
            If pMODVATAmount > 0 Then
                mAmount = pMODVATAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pMODVATAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '**************************12/07/2004 FROM CESS AMOUNT****************************************************
        If pISCapital = "Y" Then 'DD***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "CESS Receivable Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CESSRECDACCOUNT").Value), "-1", RsCompany.Fields("CESSRECDACCOUNT").Value)
            If pCESSAmount > 0 Then
                mAmount = pCESSAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pCESSAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        ''03-03-2007
        If pISCapital = "Y" Then 'DD***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "Sec. Higher Edu. CESS Receivable Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHCESSRECDACCOUNT").Value), "-1", RsCompany.Fields("SHCESSRECDACCOUNT").Value)
            If pSHECAmount > 0 Then
                mAmount = pSHECAmount
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pSHECAmount)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        ''20-12-2007
        If pISCapital = "Y" And pAddDutyPer = 50 Then 'sandeep***************
            mSubRowNo = mSubRowNo + 1
            mErrField = "A. E. D. Receivable Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("ADE_PUR_RECD_ACCOUNT").Value), "-1", RsCompany.Fields("ADE_PUR_RECD_ACCOUNT").Value)
            If pADEAmt > 0 Then
                mAmount = pADEAmt
                mDrCr = "D"
            Else
                mAmount = System.Math.Abs(pADEAmt)
                mDrCr = "C"
            End If
            If pCancel = True Then
                mAmount = 0
            End If
            pLeaseSuppAmount = pLeaseSuppAmount + mAmount
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '*******************************************************************************************************
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        mSubRowNo = mSubRowNo + 1
        If mLeasePO = "N" Then
            mAmount = Val(CStr(pNetBillValue))
        Else
            mAmount = Val(CStr(pLeaseSuppAmount))
        End If
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '************* TDS ACCOUNT Posting *************************************'
        ''If pTDSDeduct = "Y" Then
        ''mErrField = "[Supplier Posting (TDS)]"
        ''mAccountCode = IIf(IsNull(pSupplierCode), -1, pSupplierCode)
        ''
        ''
        ''If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        ''mSubRowNo = mSubRowNo + 1
        ''mAmount = Val(pTDSAmount)
        ''If pCancel = True Then
        ''mAmount = 0
        ''pNetBillValue = 0
        ''End If
        ''
        ''If mAmount <> 0 Then
        ''If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ' pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, _
        ' mAmount, "D", "B", "", "", -1, -1, -1, pDueDate, _
        ' "", "B", "", "", pNarration, pRemarks) = False Then GoTo SalePostTrnErr:
        ''End If
        ''
        ''mErrField = "[TDS ACCOUNT POSTING]"
        ''mAccountCode = IIf(IsNull(RsCompany!TDSCREDITACCOUNT), "-1", RsCompany!TDSCREDITACCOUNT)
        ''
        ''
        ''If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        ''mSubRowNo = mSubRowNo + 1
        ''mAmount = Val(pTDSAmount)
        ''If pCancel = True Then
        ''mAmount = 0
        ''pNetBillValue = 0
        ''End If
        ''
        ''If mAmount <> 0 Then
        ''If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ' pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, _
        ' mAmount, "C", "P", "", "", -1, -1, -1, pDueDate, _
        ' "", "P", "", "", pNarration, pRemarks) = False Then GoTo SalePostTrnErr:
        ''End If
        ''
        ''End If
        '**********************************************************************'
        PurchasePostTRN = True
        Exit Function
SalePostTrnErr:
        PurchasePostTRN = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function PurchasePostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pItemValue As Double, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pISGSTRefund As String, ByRef pCGSTRefundAmount As Double, ByRef pSGSTRefundAmount As Double, ByRef pIGSTRefundAmount As Double, ByRef pMRRDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pReverseCharge As String, ByRef pReverseTaxAmount As Double, ByRef pReverseCGST As Double, ByRef pReverseSGST As Double, ByRef pReverseIGST As Double, ByRef pSaleBillNo As String,
                                       ByRef pSaleBillDate As String, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        Dim mAlias As String
        Dim RSExp As ADODB.Recordset
        Dim mServicePostAmt As Double
        Dim mLeasePO As String
        Dim pLeaseSuppAmount As Double
        Dim RsPO As ADODB.Recordset = Nothing
        Dim mPONo As Double
        Dim pLeasePosting As Double
        Dim mPORefType As String
        SqlStr = ""
        mSubRowNo = 1
        mLeasePO = "N"
        pLeaseSuppAmount = 0
        mPONo = -1
        pLeasePosting = 0
        SqlStr = "SELECT CUST_REF_NO" & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPO, ADODB.LockTypeEnum.adLockReadOnly)
        If RsPO.EOF = False Then
            mPORefType = IIf(IsDBNull(RsPO.Fields("CUST_REF_NO").Value), "", RsPO.Fields("CUST_REF_NO").Value)
            If mPORefType = "S" Or mPORefType = "" Then
                mPONo = -1
            Else
                mPONo = IIf(IsDBNull(RsPO.Fields("CUST_REF_NO").Value), -1, RsPO.Fields("CUST_REF_NO").Value)
            End If

            'mPONo = IIf(IsDBNull(RsPO.Fields("CUST_REF_NO").Value), -1, IIf(Left(RsPO.Fields("CUST_REF_NO").Value, 1) = "S", -1, RsPO.Fields("CUST_REF_NO").Value))
        End If
        If mPONo <> -1 Then
            SqlStr = "SELECT PUR_TYPE, ORDER_TYPE, ACCTPOST_DETAIL" & vbCrLf & " FROM PUR_PURCHASE_HDR " & vbCrLf & " WHERE AUTO_KEY_PO=" & Val(CStr(mPONo)) & "" & vbCrLf & " AND PUR_TYPE='L'"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPO, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPO.EOF = False Then
                pLeasePosting = IIf(IsDBNull(RsPO.Fields("ACCTPOST_DETAIL").Value), 0, RsPO.Fields("ACCTPOST_DETAIL").Value)
                mLeasePO = "Y"
            End If
        End If
        If pISGSTRefund = "Y" Then
            pExpAmount = pExpAmount - pCGSTRefundAmount
            pExpAmount = pExpAmount - pSGSTRefundAmount
            pExpAmount = pExpAmount - pIGSTRefundAmount
        End If
        pNarration = IIf(pNarration = "", "", IIf(pBookSubType = "J", " ( JobWork of :", " ( Cost of :")) & pNarration & IIf(pNarration = "", "", " )")
        If MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mAlias = MasterNo & "-"
        Else
            mAlias = ""
        End If
        If pBookSubType = "W" Then
            If pCancel = True Then
                pNarration = "Bill No : " & pBillNo & " (Cancelled)"
            Else
                pNarration = "Bill No : " & pBillNo & pNarration
            End If
        Else
            If pCancel = True Then
                pNarration = "Bill No : " & mAlias & pBillNo & " (Cancelled)"
            Else
                pNarration = "Bill No : " & mAlias & pBillNo & pNarration
            End If
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookCode='" & UCase(pBookCode) & "'")
        If pCancel = True Or pFOC = True Then
            PurchasePostTRNGST = True
            Exit Function
        End If
        If mLeasePO = "N" Then
            SqlStr = "SELECT B.PurchasePostCode AS AccountCode, " & vbCrLf & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND IDENTIFICATION NOT IN ('CGS','SGS','IGS')"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            'If PubGSTApplicable = True Then
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            'Else
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
            'End If
            SqlStr = SqlStr & vbCrLf & " GROUP BY B.PurchasePostCode"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("AccountCode").Value), "-1", RsPostTrn.Fields("AccountCode").Value)
                    If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                        mAccountCode = pAccountCode
                        'GoTo SalePostTrnErr
                    End If
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    pExpAmount = pExpAmount - mAmount
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
            '************* (Invoice) PURCHASE Item Value Posting *************************************'
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' GROUP BY PUR_ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While RsPostTrn.EOF = False
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                            GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        'mAmount = mAmount + pExpAmount
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_CODE").Value)
                        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                            GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                Else
                    mAccountCode = "-1"
                    GoTo SalePostTrnErr
                End If
            End If
        End If
        If pISGSTRefund = "Y" Then
            mErrField = "GST Expenses Error"
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                mSubRowNo = mSubRowNo + 1
                mErrField = "CGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
                If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                    GoTo SalePostTrnErr
                End If
                If pCGSTRefundAmount > 0 Then
                    mAmount = pCGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pCGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
                mSubRowNo = mSubRowNo + 1
                mErrField = "SGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
                If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                    GoTo SalePostTrnErr
                End If
                If pSGSTRefundAmount > 0 Then
                    mAmount = pSGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pSGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
                mSubRowNo = mSubRowNo + 1
                mErrField = "IGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
                If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                    GoTo SalePostTrnErr
                End If
                If pIGSTRefundAmount > 0 Then
                    mAmount = pIGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pIGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, " & vbCrLf & " '[GST Expenses Error]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.IS_RM"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
                        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                            GoTo SalePostTrnErr
                        End If
                        If pCGSTRefundAmount > 0 Then
                            mAmount = pCGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pCGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
                        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                            GoTo SalePostTrnErr
                        End If
                        If pSGSTRefundAmount > 0 Then
                            mAmount = pSGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pSGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
                        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                            GoTo SalePostTrnErr
                        End If
                        If pIGSTRefundAmount > 0 Then
                            mAmount = pIGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pIGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            End If
        End If
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), "-1", pSupplierCode)
        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
            GoTo SalePostTrnErr
        End If
        mSubRowNo = mSubRowNo + 1
        If mLeasePO = "N" Then
            mAmount = Val(CStr(pNetBillValue))
        Else
            mAmount = Val(CStr(pLeaseSuppAmount))
        End If
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID, "N", pReverseCharge) = False Then GoTo SalePostTrnErr
        End If
        ''Reverse Charge Posting'
        'If pReverseCharge = "Y" Then
        'mErrField = "[Self Invoicing Posting]"
        'mAccountCode = IIf(IsNull(RsCompany!COMPANY_ACCTCODE), -1, RsCompany!COMPANY_ACCTCODE)
        'If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "") = False Then
        'GoTo SalePostTrnErr
        'End If
        '
        '
        'mSubRowNo = mSubRowNo + 1
        'mAmount = Val(pReverseTaxAmount)
        '
        'If pCancel = True Then
        'mAmount = 0
        'pNetBillValue = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        '
        'If UpdateTRN(pDBCn, pMkey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        '' pBookSubType, mAccountCode, pVNo, pVDate, pSaleBillNo, pSaleBillDate, _
        '' mAmount, "C", "B", "", "", -1, -1, -1, -1, pDueDate, _
        '' "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'mSubRowNo = mSubRowNo + 1
        '
        'mErrField = "CGST Expenses Error"
        'mAccountCode = IIf(IsNull(RsCompany.Fields("CGST_RC_SALECODE").Value), "-1", RsCompany.Fields("CGST_RC_SALECODE").Value)
        'If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "") = False Then
        'GoTo SalePostTrnErr
        'End If
        '
        'If pReverseCGST > 0 Then
        'mAmount = pReverseCGST
        'mDrCr = "D"
        'Else
        'mAmount = Abs(pReverseCGST)
        'mDrCr = "C"
        'End If
        'If pCancel = True Then
        'mAmount = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        '
        'If UpdateTRN(pDBCn, pMkey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ''pBookSubType, mAccountCode, pVNo, pVDate, pSaleBillNo, pSaleBillDate, _
        ''mAmount, mDrCr, "B", "", "", -1, -1, -1, -1, pDueDate, _
        ''"", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'mSubRowNo = mSubRowNo + 1
        '
        'mErrField = "SGST Expenses Error"
        'mAccountCode = IIf(IsNull(RsCompany.Fields("SGST_RC_SALECODE").Value), "-1", RsCompany.Fields("SGST_RC_SALECODE").Value)
        'If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "") = False Then
        'GoTo SalePostTrnErr
        'End If
        '
        'If pReverseSGST > 0 Then
        'mAmount = pReverseSGST
        'mDrCr = "D"
        'Else
        'mAmount = Abs(pReverseSGST)
        'mDrCr = "C"
        'End If
        'If pCancel = True Then
        'mAmount = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        '
        'If UpdateTRN(pDBCn, pMkey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ''pBookSubType, mAccountCode, pVNo, pVDate, pSaleBillNo, pSaleBillDate, _
        ''mAmount, mDrCr, "B", "", "", -1, -1, -1, -1, pDueDate, _
        ''"", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'mSubRowNo = mSubRowNo + 1
        '
        'mErrField = "IGST Expenses Error"
        'mAccountCode = IIf(IsNull(RsCompany.Fields("IGST_RC_SALECODE").Value), "-1", RsCompany.Fields("IGST_RC_SALECODE").Value)
        'If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "") = False Then
        'GoTo SalePostTrnErr
        'End If
        '
        'If pReverseIGST > 0 Then
        'mAmount = pReverseIGST
        'mDrCr = "D"
        'Else
        'mAmount = Abs(pReverseIGST)
        'mDrCr = "C"
        'End If
        'If pCancel = True Then
        'mAmount = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        '
        'If UpdateTRN(pDBCn, pMkey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ''pBookSubType, mAccountCode, pVNo, pVDate, pSaleBillNo, pSaleBillDate, _
        ''mAmount, mDrCr, "B", "", "", -1, -1, -1, -1, pDueDate, _
        ''"", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'End If
        '**********************************************************************'
        PurchasePostTRNGST = True
        Exit Function
SalePostTrnErr:
        'Resume
        PurchasePostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function RCPurchasePostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String,
                                         ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pSupplierCode As String, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pISGSTRefund As String,
                                         ByRef pCGSTRefundAmount As Double, ByRef pSGSTRefundAmount As Double, ByRef pIGSTRefundAmount As Double, ByRef pMRRDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String
        Dim mAlias As String
        Dim RSExp As ADODB.Recordset
        Dim mServicePostAmt As Double
        Dim mLeasePO As String
        Dim pLeaseSuppAmount As Double
        Dim RsPO As ADODB.Recordset
        Dim mPONo As Double
        Dim pLeasePosting As Double
        SqlStr = ""
        mSubRowNo = 10000
        pNarration = IIf(pNarration = "", "", IIf(pBookSubType = "J", " ( JobWork of :", " ( Cost of :")) & pNarration & IIf(pNarration = "", "", " )")
        mAlias = "RC"
        If pBookSubType = "W" Then
            If pCancel = True Then
                pNarration = "Bill No : " & pBillNo & " (Cancelled)"
            Else
                pNarration = "Bill No : " & pBillNo & pNarration
            End If
        Else
            If pCancel = True Then
                pNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
            Else
                pNarration = "Bill No : " & mAlias & "-" & pBillNo & pNarration
            End If
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookCode='" & UCase(pBookCode) & "'")
        If pCancel = True Then
            RCPurchasePostTRNGST = True
            Exit Function
        End If
        ''Reverse Charge Posting'
        'mErrField = "[Self Invoicing Posting]"
        'mAccountCode = IIf(IsNull(RsCompany!COMPANY_ACCTCODE), -1, RsCompany!COMPANY_ACCTCODE)
        'If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.fields("COMPANY_CODE").value & "") = False Then
        'GoTo SalePostTrnErr
        'End If
        '
        '
        'mSubRowNo = mSubRowNo + 1
        'mAmount = Val(pCGSTRefundAmount + pSGSTRefundAmount + pIGSTRefundAmount)
        '
        'If pCancel = True Then
        'mAmount = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr:
        '
        'If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        '' pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, _
        '' mAmount, "D", "B", "", "", -1, -1, -1, -1, pDueDate, _
        '' "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'mSubRowNo = mSubRowNo + 1
        '************* (Invoice) GST PostingDebit Entry *************************************'
        ''CGST Posting...
        mAmount = pCGSTRefundAmount
        mSubRowNo = mSubRowNo + 1
        mErrField = "CGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''IGST Posting...
        mAmount = pIGSTRefundAmount
        mErrField = "IGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        ''SGST Posting...
        mAmount = pSGSTRefundAmount
        mErrField = "SGST Account Posting Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        If mAmount > 0 Then
            mAmount = mAmount
            mDrCr = "D"
        Else
            mAmount = System.Math.Abs(mAmount)
            mDrCr = "C"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pBillNo, pBillDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '************* (Invoice) GST PostingCredit Entry *************************************'
        mErrField = "CGST Expenses Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_RC_REFUNDCODE").Value)
        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
            GoTo SalePostTrnErr
        End If
        If pCGSTRefundAmount > 0 Then
            mAmount = pCGSTRefundAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(pCGSTRefundAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        mErrField = "SGST Expenses Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_RC_REFUNDCODE").Value)
        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
            GoTo SalePostTrnErr
        End If
        If pSGSTRefundAmount > 0 Then
            mAmount = pSGSTRefundAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(pSGSTRefundAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        mErrField = "IGST Expenses Error"
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_RC_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_RC_REFUNDCODE").Value)
        If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
            GoTo SalePostTrnErr
        End If
        If pIGSTRefundAmount > 0 Then
            mAmount = pIGSTRefundAmount
            mDrCr = "C"
        Else
            mAmount = System.Math.Abs(pIGSTRefundAmount)
            mDrCr = "D"
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '**********************************************************************'
        RCPurchasePostTRNGST = True
        Exit Function
SalePostTrnErr:
        'Resume
        RCPurchasePostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function PurchaseSuppPostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pItemValue As Double, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pISGSTRefund As String, ByRef pCGSTRefundAmount As Double, ByRef pSGSTRefundAmount As Double, ByRef pIGSTRefundAmount As Double, ByRef pMRRDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pPONO As String, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        Dim mAlias As String
        Dim RSExp As ADODB.Recordset
        Dim mServicePostAmt As Double
        Dim mLeasePO As String
        Dim pLeaseSuppAmount As Double
        Dim RsPO As ADODB.Recordset = Nothing
        Dim mPONo As Double
        Dim pLeasePosting As Double
        SqlStr = ""
        mSubRowNo = 1
        mLeasePO = "N"
        pLeaseSuppAmount = 0
        mPONo = -1
        pLeasePosting = 0
        mPONo = IIf(pPONO = "", -1, Val(pPONO))
        If mPONo <> -1 Then
            SqlStr = "SELECT PUR_TYPE, ORDER_TYPE, ACCTPOST_DETAIL" & vbCrLf & " FROM PUR_PURCHASE_HDR " & vbCrLf & " WHERE AUTO_KEY_PO=" & Val(CStr(mPONo)) & "" & vbCrLf & " AND PUR_TYPE='L'"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPO, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPO.EOF = False Then
                pLeasePosting = IIf(IsDBNull(RsPO.Fields("ACCTPOST_DETAIL").Value), 0, RsPO.Fields("ACCTPOST_DETAIL").Value)
                mLeasePO = "Y"
            End If
        End If
        'If pISGSTRefund = "Y" Then
        'pExpAmount = pExpAmount - pCGSTRefundAmount
        'pExpAmount = pExpAmount - pSGSTRefundAmount
        'pExpAmount = pExpAmount - pIGSTRefundAmount
        'End If
        pNarration = IIf(pNarration = "", "", IIf(pBookSubType = "J", " ( JobWork of :", " ( Cost of :")) & pNarration & IIf(pNarration = "", "", " )")
        MainClass.ValidateWithMasterTable(pTRNType, "Code", "Alias", "FIN_INVTYPE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "")
        mAlias = MasterNo
        If pCancel = True Then
            pNarration = "Bill No : " & mAlias & "-" & pBillNo & " (Cancelled)"
        Else
            pNarration = "Bill No : " & mAlias & "-" & pBillNo & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookCode='" & UCase(pBookCode) & "'")
        If pCancel = True Or pFOC = True Then
            PurchaseSuppPostTRNGST = True
            Exit Function
        End If
        If mLeasePO = "N" Then
            SqlStr = "SELECT B.PurchasePostCode AS AccountCode, " & vbCrLf & " SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_SUPP_PURCHASE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND IDENTIFICATION NOT IN ('CGS','SGS','IGS')"
            SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            'If PubGSTApplicable = True Then
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
            'Else
            'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
            'End If
            SqlStr = SqlStr & vbCrLf & " GROUP BY B.PurchasePostCode"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("AccountCode").Value), 0, RsPostTrn.Fields("AccountCode").Value)
                    If MainClass.ValidateWithMasterTable(mAccountCode, "SUPP_CUST_CODE", "SUPP_CUST_NAME", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = False Then
                        mAccountCode = pAccountCode
                        'GoTo SalePostTrnErr
                    End If
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    pExpAmount = pExpAmount - mAmount
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If pBookType = Left(ConPurchaseSupp, 1) Then
                            mDrCr = "D"
                        Else
                            mDrCr = "C"
                        End If
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
            '************* (Invoice) PURCHASE Item Value Posting *************************************'
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                SqlStr = "SELECT" & vbCrLf & " SUM(AMOUNT) AS Amount, PUR_ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_SUPP_PURCHASE_DET " & vbCrLf & " WHERE FIN_SUPP_PURCHASE_DET.MKey='" & UCase(pMKey) & "' GROUP BY PUR_ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While RsPostTrn.EOF = False
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        'mAmount = mAmount + pExpAmount
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If pBookType = Left(ConPurchaseSupp, 1) Then
                                mDrCr = "D"
                            Else
                                mDrCr = "C"
                            End If
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_SUPP_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_CODE").Value)
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If pBookType = Left(ConPurchaseSupp, 1) Then
                                mDrCr = "D"
                            Else
                                mDrCr = "C"
                            End If
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                Else
                    mAccountCode = "-1"
                    GoTo SalePostTrnErr
                End If
            End If
        End If
        If pISGSTRefund = "Y" Then
            mErrField = "GST Expenses Error"
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                mSubRowNo = mSubRowNo + 1
                mErrField = "CGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
                If pCGSTRefundAmount > 0 Then
                    mAmount = pCGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pCGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If pBookType = Left(ConPurchaseSupp, 1) Then
                        mDrCr = mDrCr
                    Else
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                    End If
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
                mSubRowNo = mSubRowNo + 1
                mErrField = "SGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
                If pSGSTRefundAmount > 0 Then
                    mAmount = pSGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pSGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If pBookType = Left(ConPurchaseSupp, 1) Then
                        mDrCr = mDrCr
                    Else
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                    End If
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
                mSubRowNo = mSubRowNo + 1
                mErrField = "IGST Expenses Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
                If pIGSTRefundAmount > 0 Then
                    mAmount = pIGSTRefundAmount
                    mDrCr = "D"
                Else
                    mAmount = System.Math.Abs(pIGSTRefundAmount)
                    mDrCr = "C"
                End If
                If pCancel = True Then
                    mAmount = 0
                End If
                pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                If mAmount <> 0 Then
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    If pBookType = Left(ConPurchaseSupp, 1) Then
                        mDrCr = mDrCr
                    Else
                        mDrCr = IIf(mDrCr = "D", "C", "D")
                    End If
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, " & vbCrLf & " '[GST Expenses Error]' AS ErrField " & vbCrLf & " FROM FIN_SUPP_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.IS_RM"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
                        If pCGSTRefundAmount > 0 Then
                            mAmount = pCGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pCGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If pBookType = Left(ConPurchaseSupp, 1) Then
                                mDrCr = mDrCr
                            Else
                                mDrCr = IIf(mDrCr = "D", "C", "D")
                            End If
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
                        If pSGSTRefundAmount > 0 Then
                            mAmount = pSGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pSGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If pBookType = Left(ConPurchaseSupp, 1) Then
                                mDrCr = mDrCr
                            Else
                                mDrCr = IIf(mDrCr = "D", "C", "D")
                            End If
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        mSubRowNo = mSubRowNo + 1
                        mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
                        If pIGSTRefundAmount > 0 Then
                            mAmount = pIGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue
                            mDrCr = "D"
                        Else
                            mAmount = System.Math.Abs(pIGSTRefundAmount * IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), "Y", RsPostTrn.Fields("Amount").Value) / pItemValue) ''Abs(pMODVATAmount)
                            mDrCr = "C"
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        pLeaseSuppAmount = pLeaseSuppAmount + mAmount
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If pBookType = Left(ConPurchaseSupp, 1) Then
                                mDrCr = mDrCr
                            Else
                                mDrCr = IIf(mDrCr = "D", "C", "D")
                            End If
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            End If
        End If
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        mSubRowNo = mSubRowNo + 1
        If mLeasePO = "N" Then
            mAmount = Val(CStr(pNetBillValue))
        Else
            mAmount = Val(CStr(pLeaseSuppAmount))
        End If
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If pBookType = Left(ConPurchaseSupp, 1) Then
                mDrCr = "C"
            Else
                mDrCr = "D"
            End If
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, pMRRDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '**********************************************************************'
        PurchaseSuppPostTRNGST = True
        Exit Function
SalePostTrnErr:
        'Resume
        PurchaseSuppPostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SaleReturnPostTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pEDAmount As Double, ByRef pSTAmount As Double, ByRef pMODVATAmount As Double, ByRef pCESSAmount As Double, ByRef pSTRefundAmount As Double, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pISServClaim As String, ByRef pServiceAmtModvat As Double, ByRef pItemType As String, ByRef pTDSDeduct As String, ByRef pTDSAmount As Double, ByRef pBillNo1 As String, ByRef pBillDate1 As String, ByRef xExpDate As String, ByRef pSHEC As Double, ByRef pItemValue As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef pSUROnSTRefundAmount As Double, ByRef pSUROnSalesTax As Double, ByRef mLocalSale As String, ByRef mDivisionCode As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        SqlStr = ""
        mSubRowNo = 1
        'pISMODVATE = IIf(RsCompany.fields("FYEAR").value < 2008, pISMODVATE, "N")'JUNE-2010
        ''
        pNarration = IIf(pNarration = "", "", " ( Sale Return of :") & pNarration & IIf(pNarration = "", "", " )")
        If pCancel = True Then
            pNarration = "Bill No : " & pBillNo1 & " (Cancelled)"
        Else
            pNarration = "Bill No : " & pBillNo1 & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "'AND BookCode='" & UCase(pBookCode) & "' ")
        If pCancel = True Or pFOC = True Then
            SaleReturnPostTRN = True
            Exit Function
        End If
        mDrCr = "D"
        If pISMODVATE = "Y" Then
            pExpAmount = pExpAmount - pMODVATAmount
            pExpAmount = pExpAmount - pCESSAmount 'DD**************
            pExpAmount = pExpAmount - pSHEC
            mAmount = pMODVATAmount
            If pCancel = True Then
                mAmount = 0
            End If
            If pItemType = "R" Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATRAWACCOUNT").Value), "-1", RsCompany.Fields("MODVATRAWACCOUNT").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATOTHACCOUNT").Value), "-1", RsCompany.Fields("MODVATOTHACCOUNT").Value)
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pCESSAmount
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CESSACCOUNT").Value), "-1", RsCompany.Fields("CESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSHEC
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SHCESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISServClaim = "Y" Then
            pExpAmount = pExpAmount - pServiceAmtModvat
            pExpAmount = pExpAmount - pCESSAmount
            pExpAmount = pExpAmount - pSHEC
            mAmount = pServiceAmtModvat
            If pCancel = True Then
                mAmount = 0
            End If
            mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("SRVTAXACCOUNT").Value), "-1", RsPostTrn.Fields("SRVTAXACCOUNT").Value)
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pCESSAmount
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_CESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_CESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSHEC
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        'If pISSTRefund = "Y" Then
        pExpAmount = pExpAmount - pSTAmount ''pExpAmount - pSTRefundAmount
        pExpAmount = pExpAmount - pSUROnSalesTax
        mAmount = pSTAmount ''pSTRefundAmount
        If mLocalSale = "Y" Then
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SR_ST_ACCOUNT").Value), "-1", RsCompany.Fields("SR_ST_ACCOUNT").Value)
        Else
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SR_CST_ACCOUNT").Value), "-1", RsCompany.Fields("SR_CST_ACCOUNT").Value)
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        mAmount = pSUROnSalesTax
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SUR_VAT_SR_ACCOUNT").Value), "-1", RsCompany.Fields("SUR_VAT_SR_ACCOUNT").Value)
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        'End If
        'If pISCSTRefund = "Y" Then
        'pExpAmount = pExpAmount - pSTRefundAmount
        'mAmount = pSTRefundAmount
        'mAccountCode = IIf(IsNull(RsCompany.Fields("CSTREFUNDACCOUNT").Value), "-1", RsCompany.Fields("CSTREFUNDACCOUNT").Value)
        'If pCancel = True Then
        'mAmount = 0
        'End If
        'If mAmount <> 0 Then
        'mSubRowNo = mSubRowNo + 1
        'If UpdateTRN(pDBCn, pMkey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, _
        ''pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, _
        ''mAmount, mDrCr, "B", "", "", -1, -1, -1, -1, pDueDate, _
        ''"", "B", "", "", pNarration, pRemarks, xExpDate, pADDMode, pAddUser, pAddDate) = False Then GoTo SalePostTrnErr:
        'End If
        'End If
        '************* (Invoice) PURCHASE Item Value Posting *************************************'
        If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
            SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE, " & vbCrLf & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' GROUP BY PUR_ACCOUNT_CODE"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    'mAmount = mAmount + pExpAmount
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    'mAmount = mAmount + GetSaleRTNValue_IncludingED(pDBCn, pMkey, pCancel, pServiceAmtModvat)''JUNE-2010
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
        Else
            SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_SR_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
            SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_SR_CODE"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While Not RsPostTrn.EOF
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_SR_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_SR_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            Else
                mAccountCode = "-1"
                GoTo SalePostTrnErr
            End If
        End If
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '**********************************************************************'
        SaleReturnPostTRN = True
        Exit Function
SalePostTrnErr:
        SaleReturnPostTRN = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SaleReturnPostTRNNew(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef mSubRowNo As Integer, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pEDAmount As Double, ByRef pSTAmount As Double, ByRef pMODVATAmount As Double, ByRef pCESSAmount As Double, ByRef pSTRefundAmount As Double, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pISServClaim As String, ByRef pServiceAmtModvat As Double, ByRef pItemType As String, ByRef pTDSDeduct As String, ByRef pTDSAmount As Double, ByRef pBillNo1 As String, ByRef pBillDate1 As String, ByRef xExpDate As String, ByRef pSHEC As Double, ByRef pItemValue As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef pSUROnSTRefundAmount As Double, ByRef pSUROnSalesTax As Double, ByRef mLocalSale As String, ByRef mDivisionCode As Double, ByRef mFirstRow As Boolean, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        'Dim mSubRowNo As Long
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        SqlStr = ""
        'mSubRowNo = 1
        pNarration = IIf(pNarration = "", "", " ( Sale Return of :") & pNarration & IIf(pNarration = "", "", " )")
        If pCancel = True Then
            pNarration = "Bill No : " & pBillNo1 & " (Cancelled)"
        Else
            pNarration = "Bill No : " & pBillNo1 & pNarration
        End If
        pNarration = Left(pNarration, 254)
        If mFirstRow = True Then
            pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "'AND BookCode='" & UCase(pBookCode) & "' ")
        End If
        If pCancel = True Or pFOC = True Then
            SaleReturnPostTRNNew = True
            Exit Function
        End If
        mDrCr = "D"
        If pISMODVATE = "Y" Then
            pExpAmount = pExpAmount - pMODVATAmount
            pExpAmount = pExpAmount - pCESSAmount 'DD**************
            pExpAmount = pExpAmount - pSHEC
            mAmount = pMODVATAmount
            If pCancel = True Then
                mAmount = 0
            End If
            If pItemType = "R" Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATRAWACCOUNT").Value), "-1", RsCompany.Fields("MODVATRAWACCOUNT").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("MODVATOTHACCOUNT").Value), "-1", RsCompany.Fields("MODVATOTHACCOUNT").Value)
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pCESSAmount
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("CESSACCOUNT").Value), "-1", RsCompany.Fields("CESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSHEC
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SHCESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISServClaim = "Y" Then
            pExpAmount = pExpAmount - pServiceAmtModvat
            pExpAmount = pExpAmount - pCESSAmount
            pExpAmount = pExpAmount - pSHEC
            mAmount = pServiceAmtModvat
            If pCancel = True Then
                mAmount = 0
            End If
            mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("SRVTAXACCOUNT").Value), "-1", RsPostTrn.Fields("SRVTAXACCOUNT").Value)
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pCESSAmount
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_CESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_CESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSHEC
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value), "-1", RsCompany.Fields("SRVTAX_SHCESSACCOUNT").Value)
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        'If pISSTRefund = "Y" Then
        pExpAmount = pExpAmount - pSTAmount ''pExpAmount - pSTRefundAmount
        pExpAmount = pExpAmount - pSUROnSalesTax
        mAmount = pSTAmount ''pSTRefundAmount
        If mLocalSale = "Y" Then
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SR_ST_ACCOUNT").Value), "-1", RsCompany.Fields("SR_ST_ACCOUNT").Value)
        Else
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SR_CST_ACCOUNT").Value), "-1", RsCompany.Fields("SR_CST_ACCOUNT").Value)
        End If
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        mAmount = pSUROnSalesTax
        mAccountCode = IIf(IsDBNull(RsCompany.Fields("SUR_VAT_SR_ACCOUNT").Value), "-1", RsCompany.Fields("SUR_VAT_SR_ACCOUNT").Value)
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        'End If
        '************* (Invoice) PURCHASE Item Value Posting *************************************'
        If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
            SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE, " & vbCrLf & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' "
            SqlStr = SqlStr & vbCrLf & " AND CUST_REF_NO='" & pBillNo & "' AND CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    'mAmount = mAmount + pExpAmount
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    'mAmount = mAmount + GetSaleRTNValue_IncludingED(pDBCn, pMkey, pCancel, pServiceAmtModvat)''JUNE-2010
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
        Else
            SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_SR_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
            SqlStr = SqlStr & vbCrLf & " AND ID.CUST_REF_NO='" & pBillNo & "' AND ID.CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
            SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_SR_CODE"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While Not RsPostTrn.EOF
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_SR_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_SR_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            Else
                mAccountCode = "-1"
                GoTo SalePostTrnErr
            End If
        End If
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        SaleReturnPostTRNNew = True
        Exit Function
SalePostTrnErr:
        SaleReturnPostTRNNew = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SaleReturnPostTRNGST(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef mSubRowNo As Integer, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pCGSTAmount As Double, ByRef pSGSTAmount As Double, ByRef pIGSTAmount As Double, ByRef pISGSTRefund As String, ByRef pBillNo1 As String, ByRef pBillDate1 As String, ByRef xExpDate As String, ByRef pItemValue As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mLocalSale As String, ByRef mDivisionCode As Double, ByRef mFirstRow As Boolean, ByRef pLoactionID As String, ByRef pPurchaseSeq As Long) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        'Dim mSubRowNo As Long
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        SqlStr = ""
        'mSubRowNo = 1
        pNarration = IIf(pNarration = "", "", " ( Sale Return of :") & pNarration & IIf(pNarration = "", "", " )")
        If pCancel = True Then
            pNarration = "Bill No : " & pBillNo1 & " (Cancelled)"
        Else
            pNarration = "Bill No : " & pBillNo1 & pNarration
        End If
        pNarration = Left(pNarration, 254)
        If mFirstRow = True Then
            pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "'AND BookCode='" & UCase(pBookCode) & "' ")
        End If
        If pCancel = True Or pFOC = True Then
            SaleReturnPostTRNGST = True
            Exit Function
        End If
        mDrCr = "D"
        If pISGSTRefund = "Y" Then
            pExpAmount = pExpAmount ''- pCGSTAmount
            pExpAmount = pExpAmount ''- pSGSTAmount
            pExpAmount = pExpAmount ''- pIGSTAmount
            mAmount = pCGSTAmount
            If pCancel = True Then
                mAmount = 0
            End If
            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_SALE_RETURNCODE").Value)
            End If

            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSGSTAmount

            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_SALE_RETURNCODE").Value)
            End If

            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If

            mAmount = pIGSTAmount

            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_SALE_RETURNCODE").Value)
            End If


            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '************* (Invoice) PURCHASE Item Value Posting *************************************'
        If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
            SqlStr = "SELECT" & vbCrLf & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE, " & vbCrLf & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf _
                & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' "
            SqlStr = SqlStr & vbCrLf & " AND CUST_REF_NO='" & pBillNo & "' AND CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While RsPostTrn.EOF = False
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    'mAmount = mAmount + pExpAmount
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            End If
        Else
            SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_SR_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf _
                & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf _
                & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf _
                & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf _
                & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf _
                & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf _
                & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"
            SqlStr = SqlStr & vbCrLf & " AND ID.CUST_REF_NO='" & pBillNo & "' AND ID.CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
            SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
            SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_SR_CODE"
            MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
            If RsPostTrn.EOF = False Then
                Do While Not RsPostTrn.EOF
                    mErrField = RsPostTrn.Fields("ErrField").Value
                    mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_SR_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_SR_CODE").Value)
                    If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                    mSubRowNo = mSubRowNo + 1
                    mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                    If pItemValue = 0 Then
                        mAmount = mAmount + pExpAmount
                    Else
                        mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                    End If
                    If pCancel = True Then
                        mAmount = 0
                    End If
                    If mAmount <> 0 Then
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                    End If
                    RsPostTrn.MoveNext()
                Loop
            Else
                mAccountCode = "-1"
                GoTo SalePostTrnErr
            End If
        End If
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        SaleReturnPostTRNGST = True
        Exit Function
SalePostTrnErr:
        SaleReturnPostTRNGST = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function SaleReturnPostTRNGSTNew(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer,
                                            ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef mSubRowNo As Integer,
                                            ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String,
                                            ByRef pSupplierCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean,
                                            ByRef pFOC As Boolean, ByRef pDueDate As String, ByRef pRejection As Boolean, ByRef pNarration As String,
                                            ByRef pRemarks As String, ByRef pExpAmount As Double, ByRef pCGSTAmount As Double, ByRef pSGSTAmount As Double,
                                            ByRef pIGSTAmount As Double, ByRef pISGSTRefund As String, ByRef pBillNo1 As String, ByRef pBillDate1 As String,
                                            ByRef xExpDate As String, ByRef pItemValue As Double, ByRef pAddMode As Boolean,
                                            ByRef pAddUser As String, ByRef pAddDate As String, ByRef mLocalSale As String,
                                            ByRef mDivisionCode As Double, ByRef mFirstRow As Boolean, ByRef pLoactionID As String, ByRef pPurchaseSeq As Long) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        'Dim mSubRowNo As Long
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        SqlStr = ""
        'mSubRowNo = 1
        pNarration = IIf(pNarration = "", "", " ( Sale Return of :") & pNarration & IIf(pNarration = "", "", " )")
        If pCancel = True Then
            pNarration = "Bill No : " & pBillNo1 & " (Cancelled)"
        Else
            pNarration = "Bill No : " & pBillNo1 & pNarration
        End If

        pNarration = Left(pNarration, 254)
        If mFirstRow = True Then
            pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "'AND BookCode='" & UCase(pBookCode) & "' ")
        End If

        If pCancel = True Or pFOC = True Then
            SaleReturnPostTRNGSTNew = True
            Exit Function
        End If

        mDrCr = "D"
        If pISGSTRefund = "Y" And mFirstRow = True Then
            pExpAmount = pExpAmount ''- pCGSTAmount
            pExpAmount = pExpAmount ''- pSGSTAmount
            pExpAmount = pExpAmount ''- pIGSTAmount
            mAmount = pCGSTAmount
            If pCancel = True Then
                mAmount = 0
            End If
            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_REFUNDCODE").Value), "-1", RsCompany.Fields("CGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("CGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("CGST_SALE_RETURNCODE").Value)
            End If

            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pSGSTAmount

            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_REFUNDCODE").Value), "-1", RsCompany.Fields("SGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("SGST_SALE_RETURNCODE").Value)
            End If


            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            mAmount = pIGSTAmount

            If pPurchaseSeq = 8 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_REFUNDCODE").Value), "-1", RsCompany.Fields("IGST_REFUNDCODE").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("IGST_SALE_RETURNCODE").Value), "-1", RsCompany.Fields("IGST_SALE_RETURNCODE").Value)
            End If

            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '************* (Invoice) PURCHASE Item Value Posting *************************************'
        If mFirstRow = True Then
            If RsCompany.Fields("PURCHASE_POSTINGTYPE").Value = "B" Then
                SqlStr = "SELECT" & vbCrLf _
                    & " SUM(ITEM_AMT) AS Amount, PUR_ACCOUNT_CODE, " & vbCrLf & " '[Sales Item Value (Invoice) Posting]' AS ErrField " & vbCrLf _
                    & " FROM FIN_PURCHASE_DET " & vbCrLf & " WHERE FIN_PURCHASE_DET.MKey='" & UCase(pMKey) & "' "

                'SqlStr = SqlStr & vbCrLf & " AND CUST_REF_NO='" & pBillNo & "' AND CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
                SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While RsPostTrn.EOF = False
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value), "-1", RsPostTrn.Fields("PUR_ACCOUNT_CODE").Value)
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        'mAmount = mAmount + pExpAmount
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                End If
            Else
                SqlStr = "SELECT" & vbCrLf & " SUM(ID.ITEM_AMT) AS Amount, TRN.ACCOUNT_SR_CODE," & vbCrLf & " '[Item Purchase Posting]' AS ErrField " & vbCrLf _
                    & " FROM FIN_PURCHASE_DET ID, INV_ITEM_MST ITEM, FIN_PUR_POSTING_MST TRN " & vbCrLf _
                    & " WHERE ID.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " AND ID.MKey='" & UCase(pMKey) & "'" & vbCrLf _
                    & " AND ID.COMPANY_CODE=ITEM.COMPANY_CODE" & vbCrLf _
                    & " AND ID.ITEM_CODE=ITEM.ITEM_CODE" & vbCrLf _
                    & " AND ITEM.COMPANY_CODE=TRN.COMPANY_CODE(+)" & vbCrLf _
                    & " AND ITEM.CATEGORY_CODE=TRN.CATEGORY_CODE(+)"

                'SqlStr = SqlStr & vbCrLf & " AND ID.CUST_REF_NO='" & pBillNo & "' AND ID.CUST_REF_DATE =TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

                SqlStr = SqlStr & vbCrLf & " GROUP BY PUR_ACCOUNT_CODE "
                SqlStr = SqlStr & vbCrLf & " GROUP BY TRN.ACCOUNT_SR_CODE"
                MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsPostTrn.EOF = False Then
                    Do While Not RsPostTrn.EOF
                        mErrField = RsPostTrn.Fields("ErrField").Value
                        mAccountCode = IIf(IsDBNull(RsPostTrn.Fields("ACCOUNT_SR_CODE").Value), "-1", RsPostTrn.Fields("ACCOUNT_SR_CODE").Value)
                        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                        mSubRowNo = mSubRowNo + 1
                        mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                        If pItemValue = 0 Then
                            mAmount = mAmount + pExpAmount
                        Else
                            mAmount = mAmount + (pExpAmount * mAmount / pItemValue)
                        End If
                        If pCancel = True Then
                            mAmount = 0
                        End If
                        If mAmount <> 0 Then
                            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
                            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                        End If
                        RsPostTrn.MoveNext()
                    Loop
                Else
                    mAccountCode = "-1"
                    GoTo SalePostTrnErr
                End If
            End If
        End If

        'If mFirstRow = True Then
        '************* Supplier Posting *************************************'
        mErrField = "[Supplier Posting]"
        mAccountCode = IIf(IsDBNull(pSupplierCode), -1, pSupplierCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, "P", pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", "B", "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", "B", "", "", pNarration, pRemarks, xExpDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        'End If

        SaleReturnPostTRNGSTNew = True
        Exit Function
SalePostTrnErr:
        SaleReturnPostTRNGSTNew = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function DNCNPostTRNOld(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pPartyCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pReason As String, ByRef pExpAmount As Double, ByRef pEDAmount As Double, ByRef pSTAmount As Double, ByRef pMODVATAmount As Double, ByRef pSTRefundAmount As Double, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pItemType As String, ByRef pEDUAmount As Double, ByRef pSERVICEAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pLoactionID As String) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String
        Dim mTRNType As String = ""
        Dim xExpAmount As String
        SqlStr = ""
        mSubRowNo = 1
        'If pISMODVATE = "Y" Then
        'xExpAmount = pMODVATAmount
        'End If
        '
        'If pISSTRefund = "Y" Then
        'pExpAmount = pExpAmount - pSTRefundAmount
        'End If
        If CDbl(pBookCode) = ConDebitNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( D/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "D"
        ElseIf CDbl(pBookCode) = ConCreditNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( C/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "C"
        End If
        If pCancel = True Then
            pNarration = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D/N No : ", "C/N No : ") & pVNo & " (Cancelled)"
        Else
            pNarration = "Bill No : " & pBillNo & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookSubType='" & UCase(pBookSubType) & "'")
        If pCancel = True Then
            DNCNPostTRNOld = True
            Exit Function
        End If
        '************* Account Posting *************************************'
        mErrField = "Account Posting"
        mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pAccountCode, pPartyCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        ''mAmount = mAmount - pMODVATAmount - pSTRefundAmount
        If pISMODVATE = "Y" Then
            mAmount = mAmount - pEDAmount - pSTRefundAmount - pEDUAmount - pSERVICEAmount
        Else
            mAmount = mAmount - pSTRefundAmount
        End If
        mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        If Val(CStr(pEDAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "BED Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("BED_PURCHASE_RTN").Value), "-1", RsCompany.Fields("BED_PURCHASE_RTN").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mAmount = pEDAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pEDUAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("ECT_PURCHASE_RTN").Value), "-1", RsCompany.Fields("ECT_PURCHASE_RTN").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mAmount = pEDUAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pSERVICEAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value), "-1", RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mAmount = pSERVICEAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If pISSTRefund = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "ST Refund Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("STREFUNDACCOUNT").Value), "-1", RsCompany.Fields("STREFUNDACCOUNT").Value)
            If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
            mAmount = pSTRefundAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '************* Party Account Posting *************************************'
        mErrField = "[Party Account Posting]"
        mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pPartyCode, pAccountCode)
        If mAccountCode = "-1" Or mAccountCode = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D", "C")
        If pCancel = True Then
            mAmount = 0
            pNetBillValue = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", pNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        '**********************************************************************'
        DNCNPostTRNOld = True
        Exit Function
SalePostTrnErr:
        DNCNPostTRNOld = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function DNCNPostTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pPartyCode As String, ByRef pAccountCode As String, ByRef pNetBillValue As Double, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pReason As String, ByRef pExpAmount As Double, ByRef pEDAmount As Double, ByRef pSTAmount As Double, ByRef pMODVATAmount As Double, ByRef pSTRefundAmount As Double, ByRef pISMODVATE As String, ByRef pISSTRefund As String, ByRef pISCSTRefund As String, ByRef pItemType As String, ByRef pEDUAmount As Double, ByRef pSERVICEAmount As Double, ByRef pSHECESSAmount As Double, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef pSTSurchargeAmount As Double, ByRef mDivisionCode As Double, ByRef pLoactionID As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsPostTrn As ADODB.Recordset = Nothing
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAmount As Double
        Dim mDrCr As String
        Dim mErrField As String = ""
        Dim mTRNType As String = ""
        Dim xExpAmount As String
        Dim pDNBillNo As String
        Dim pDNBillDate As String
        Dim xNarration As String
        Dim mBillWiseExpAmt As Double
        Dim mBalBillWiseExpAmt As Double
        Dim mItemValue As Double
        SqlStr = ""
        mSubRowNo = 1
        'pISMODVATE = IIf(RsCompany.fields("FYEAR").value < 2008, pISMODVATE, "N")''JUNE-2010
        If CDbl(pBookCode) = ConDebitNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( D/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "D"
        ElseIf CDbl(pBookCode) = ConCreditNoteBookCode Then
            pNarration = IIf(pNarration = "", "", " ( C/N of :") & pNarration & IIf(pNarration = "", "", " )")
            mTRNType = "C"
        End If
        If Trim(pBillNo) = "" Then
            pBillNo = pVNo
            pBillDate = pVDate
        End If
        If pCancel = True Then
            pNarration = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D/N No : ", "C/N No : ") & pVNo & " (Cancelled)"
            'Else
            'pNarration = "Bill No : " & pBillNo & pNarration
        End If
        pNarration = Left(pNarration, 254)
        pDBCn.Execute("DELETE FROM FIN_POSTED_TRN WHERE MKey='" & UCase(pMKey) & "' AND BookType='" & UCase(pBookType) & "' AND BookSubType='" & UCase(pBookSubType) & "'")
        If pCancel = True Then
            DNCNPostTRN = True
            Exit Function
        End If
        '************* Account Posting *************************************'
        SqlStr = "SELECT DISTINCT SUPP_REF_NO, " & vbCrLf & " '[Account Posting]' AS ErrField " & vbCrLf & " FROM FIN_DNCN_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        xNarration = ""
        If RsPostTrn.EOF = False Then
            mErrField = RsPostTrn.Fields("ErrField").Value
            Do While RsPostTrn.EOF = False
                If Trim(xNarration) = "" Then
                    xNarration = IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                Else
                    xNarration = xNarration & ", " & IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                End If
                RsPostTrn.MoveNext()
            Loop
        End If
        xNarration = "Bill No : " & xNarration & pNarration
        mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pAccountCode, pPartyCode)
        If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
        mSubRowNo = mSubRowNo + 1
        mAmount = Val(CStr(pNetBillValue))
        ''mAmount = mAmount - pMODVATAmount - pSTRefundAmount
        If pISMODVATE = "Y" Then
            mAmount = mAmount - pEDAmount - pEDUAmount - pSHECESSAmount
        End If
        If Val(CStr(pSERVICEAmount)) <> 0 And pISMODVATE = "Y" Then
            mAmount = mAmount - pSERVICEAmount
        End If
        If pISSTRefund = "Y" Or pISCSTRefund = "Y" Then
            mAmount = mAmount - pSTRefundAmount
            mAmount = mAmount - pSTSurchargeAmount
        End If
        mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
        If pCancel = True Then
            mAmount = 0
        End If
        If mAmount <> 0 Then
            If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
        End If
        If Val(CStr(pEDAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "BED Expenses Error"
            If RsCompany.Fields("FYEAR").Value <= 2014 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("BED_PURCHASE_RTN").Value), "-1", RsCompany.Fields("BED_PURCHASE_RTN").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("BED_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("BED_PURCHASE_RTN_INV").Value)
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = pEDAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pEDUAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            If RsCompany.Fields("FYEAR").Value <= 2014 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("ECT_PURCHASE_RTN").Value), "-1", RsCompany.Fields("ECT_PURCHASE_RTN").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("ECT_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("ECT_PURCHASE_RTN_INV").Value)
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = pEDUAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pSHECESSAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            If RsCompany.Fields("FYEAR").Value <= 2014 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHECT_PURCHASE_RTN").Value), "-1", RsCompany.Fields("SHECT_PURCHASE_RTN").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHECT_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("SHECT_PURCHASE_RTN_INV").Value)
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = pSHECESSAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pSERVICEAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            If RsCompany.Fields("FYEAR").Value <= 2014 Then
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value), "-1", RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value)
            Else
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("SRVTAX_PURCHASE_RTN_INV").Value)
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = pSERVICEAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If (pISSTRefund = "Y" Or pISCSTRefund = "Y") And pSTRefundAmount <> 0 Then
            mSubRowNo = mSubRowNo + 1
            If pISSTRefund = "Y" Then
                mErrField = "ST Refund Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("STREFUNDACCOUNT").Value), "-1", RsCompany.Fields("STREFUNDACCOUNT").Value)
            Else
                mErrField = "CST Refund Error"
                mAccountCode = Trim(IIf(IsDBNull(RsCompany.Fields("CSTREFUNDACCOUNT").Value), "-1", RsCompany.Fields("CSTREFUNDACCOUNT").Value))
            End If
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mAmount = pSTRefundAmount
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
            ''Surcharge ..
            mSubRowNo = mSubRowNo + 1
            If pISSTRefund = "Y" And pSTSurchargeAmount <> 0 Then
                mErrField = "Surchare on Vat Refund Error"
                mAccountCode = IIf(IsDBNull(RsCompany.Fields("SUR_VAT_PUR_ACCOUNT").Value), "-1", RsCompany.Fields("SUR_VAT_PUR_ACCOUNT").Value)
                If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
                mAmount = pSTSurchargeAmount
                mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "C", "D")
                If pCancel = True Then
                    mAmount = 0
                End If
                If mAmount <> 0 Then
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            End If
        End If
        '************* Party Account Posting *************************************'
        SqlStr = "SELECT SUPP_REF_NO, SUPP_REF_DATE, " & vbCrLf & " SUM(ITEM_AMT) AS Amount," & vbCrLf & " '[Party Account Posting]' AS ErrField " & vbCrLf & " FROM FIN_DNCN_DET " & vbCrLf & " WHERE MKey='" & UCase(pMKey) & "' GROUP BY SUPP_REF_NO, SUPP_REF_DATE"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsPostTrn, ADODB.LockTypeEnum.adLockReadOnly)
        mBillWiseExpAmt = 0
        mBalBillWiseExpAmt = pExpAmount
        mItemValue = System.Math.Abs(pNetBillValue - pExpAmount)
        If RsPostTrn.EOF = False Then
            Do While RsPostTrn.EOF = False
                mErrField = RsPostTrn.Fields("ErrField").Value
                mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pPartyCode, pAccountCode)
                If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                mAmount = IIf(IsDBNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
                If mItemValue = 0 Then
                    mBillWiseExpAmt = 0
                Else
                    mBillWiseExpAmt = CDbl(VB6.Format(mAmount * pExpAmount / mItemValue, "0.00"))
                End If
                mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D", "C")
                pDNBillNo = IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_NO").Value), "", RsPostTrn.Fields("SUPP_REF_NO").Value)
                pDNBillDate = VB6.Format(IIf(IsDBNull(RsPostTrn.Fields("SUPP_REF_DATE").Value), "", RsPostTrn.Fields("SUPP_REF_DATE").Value), "DD-MMM-YYYY")
                If Trim(pDNBillNo) = "" Then
                    pDNBillNo = pBillNo
                    pDNBillDate = pBillDate
                End If
                xNarration = "Bill No : " & pDNBillNo & pNarration
                If pCancel = True Then
                    mAmount = 0
                End If
                RsPostTrn.MoveNext()
                If RsPostTrn.EOF = True Then
                    mBillWiseExpAmt = mBalBillWiseExpAmt
                Else
                    mBalBillWiseExpAmt = mBalBillWiseExpAmt - mBillWiseExpAmt
                    'If mBalBillWiseExpAmt < 0 Then
                    'mBillWiseExpAmt = mBillWiseExpAmt + mBalBillWiseExpAmt
                    'mBalBillWiseExpAmt = 0
                    'End If
                End If
                mAmount = mAmount + mBillWiseExpAmt
                If mAmount <> 0 Then
                    If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pDNBillNo, pDNBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                End If
            Loop
        Else
            mErrField = "[Party Account Posting]"
            mAccountCode = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, pPartyCode, pAccountCode)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Then GoTo SalePostTrnErr
            mSubRowNo = mSubRowNo + 1
            mAmount = System.Math.Abs(pExpAmount)
            mDrCr = IIf(CDbl(pBookCode) = ConDebitNoteBookCode, "D", "C")
            xNarration = "Bill No : " & pBillNo & pNarration
            If pCancel = True Then
                mAmount = 0
            End If
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, mDrCr, mTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", mTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        '************* Exp Account Posting *************************************'
        'SqlStr = "SELECT " & vbCrLf _
        ''& " SUM(AMOUNT) AS Amount," & vbCrLf _
        ''& " '[Party Account Posting]' AS ErrField " & vbCrLf _
        ''& " FROM FIN_DNCN_EXP " & vbCrLf _
        ''& " WHERE MKey='" & UCase(pMKey) & "'"
        '
        'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsPostTrn, adLockReadOnly
        '
        'If RsPostTrn.EOF = False Then
        'Do While RsPostTrn.EOF = False
        'mErrField = RsPostTrn.Fields("ErrField").Value
        '
        'mAccountCode = IIf(pBookCode = ConDebitNoteBookCode, pPartyCode, pAccountCode)
        'If trim(mAccountCode) = "-1" Or trim(mAccountCode) = "0" Then GoTo SalePostTrnErr:
        'mSubRowNo = mSubRowNo + 1
        '
        'mAmount = IIf(IsNull(RsPostTrn.Fields("Amount").Value), 0, RsPostTrn.Fields("Amount").Value)
        'mDrCr = IIf(pBookCode = ConDebitNoteBookCode, "D", "C")
        '
        'pNarration = "Bill No : " & pBillNo & pNarration
        '
        'If pCancel = True Then
        'mAmount = 0
        'End If
        '
        'If mAmount <> 0 Then
        'If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, _
        '' pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, _
        '' mAmount, mDrCr, mTRNType, "", "", -1, -1, -1, pDueDate, _
        '' "", mTRNType, "", "", pNarration, pReason, pBillDate) = False Then GoTo SalePostTrnErr:
        'End If
        '
        'RsPostTrn.MoveNext
        'Loop
        'End If
        '**********************************************************************'
        DNCNPostTRN = True
        Exit Function
SalePostTrnErr:
        DNCNPostTRN = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function PurchaseRejBEDPostTRN(ByRef pDBCn As ADODB.Connection, ByRef pMKey As String, ByRef pCurrRowNo As Integer, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pTRNType As String, ByRef pPartyCode As String, ByRef pAccountCode As String, ByRef pCancel As Boolean, ByRef pDueDate As String, ByRef pNarration As String, ByRef pReason As String, ByRef pISMODVATE As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, ByRef mDivisionCode As Double, ByRef pLoactionID As Double) As Boolean
        On Error GoTo SalePostTrnErr
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsPostTrn As ADODB.Recordset
        Dim mSubRowNo As Integer
        Dim mAccountCode As String
        Dim mAccountCodeDR As String
        Dim mAmount As Double
        Dim mErrField As String
        Dim xNarration As String
        Dim pEDAmount As Double
        Dim pEDUAmount As Double
        Dim pSHECESSAmount As Double
        Dim pSERVICEAmount As Double
        Dim pADEAmount As Double
        SqlStr = ""
        mSubRowNo = 1
        xNarration = pNarration
        SqlStr = "SELECTIDENTIFICATION, SUM(A.Amount) AS Amount,'INTERFACE MASTER' AS ErrField " & vbCrLf & " FROM FIN_INVOICE_EXP A,FIN_INTERFACE_MST B " & vbCrLf & " WHERE A.ExpCode=B.Code " & vbCrLf & " AND B.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf & " AND A.MKey='" & UCase(pMKey) & "' AND DUTYFORGONE='N'"
        SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'If PubGSTApplicable = True Then
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='Y'"
        'Else
        'SqlStr = SqlStr & vbCrLf & " AND GST_ENABLED='N'"
        'End If
        SqlStr = SqlStr & vbCrLf & " GROUP BY IDENTIFICATION"
        MainClass.UOpenRecordSet(SqlStr, pDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While Not RsTemp.EOF
                If RsTemp.Fields("IDENTIFICATION").Value = "ED" Then
                    pEDAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 1, RsTemp.Fields("Amount").Value)
                ElseIf RsTemp.Fields("IDENTIFICATION").Value = "EDU" Then
                    pEDUAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 1, RsTemp.Fields("Amount").Value)
                ElseIf RsTemp.Fields("IDENTIFICATION").Value = "SHC" Then
                    pSHECESSAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 1, RsTemp.Fields("Amount").Value)
                ElseIf RsTemp.Fields("IDENTIFICATION").Value = "SER" Then
                    pSERVICEAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 1, RsTemp.Fields("Amount").Value)
                ElseIf RsTemp.Fields("IDENTIFICATION").Value = "ADE" Then
                    pADEAmount = IIf(IsDBNull(RsTemp.Fields("Amount").Value), 1, RsTemp.Fields("Amount").Value)
                End If
                RsTemp.MoveNext()
            Loop
        End If
        If Val(CStr(pEDAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            'mDrCr = IIf(pBookCode = ConDebitNoteBookCode, "C", "D")
            mErrField = "BED Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("BED_PURCHASE_RTN").Value), "-1", RsCompany.Fields("BED_PURCHASE_RTN").Value)
            mAccountCodeDR = IIf(IsDBNull(RsCompany.Fields("BED_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("BED_PURCHASE_RTN_INV").Value)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Or Trim(mAccountCodeDR) = "-1" Or Trim(mAccountCodeDR) = "0" Then GoTo SalePostTrnErr
            mAmount = pEDAmount
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCodeDR, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pADEAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            'mDrCr = IIf(pBookCode = ConDebitNoteBookCode, "C", "D")
            mErrField = "BED Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("ADE_PUR_RTN_ACCOUNT").Value), "-1", RsCompany.Fields("ADE_PUR_RTN_ACCOUNT").Value)
            mAccountCodeDR = IIf(IsDBNull(RsCompany.Fields("ADE_PUR_RTN_ACCOUNT_INV").Value), "-1", RsCompany.Fields("ADE_PUR_RTN_ACCOUNT_INV").Value)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Or Trim(mAccountCodeDR) = "-1" Or Trim(mAccountCodeDR) = "0" Then GoTo SalePostTrnErr
            mAmount = pEDAmount
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCodeDR, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pEDUAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("ECT_PURCHASE_RTN").Value), "-1", RsCompany.Fields("ECT_PURCHASE_RTN").Value)
            mAccountCodeDR = IIf(IsDBNull(RsCompany.Fields("ECT_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("ECT_PURCHASE_RTN_INV").Value)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Or Trim(mAccountCodeDR) = "-1" Or Trim(mAccountCodeDR) = "0" Then GoTo SalePostTrnErr
            mAmount = pEDUAmount
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCodeDR, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pSHECESSAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SHECT_PURCHASE_RTN").Value), "-1", RsCompany.Fields("SHECT_PURCHASE_RTN").Value)
            mAccountCodeDR = IIf(IsDBNull(RsCompany.Fields("SHECT_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("SHECT_PURCHASE_RTN_INV").Value)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Or Trim(mAccountCodeDR) = "-1" Or Trim(mAccountCodeDR) = "0" Then GoTo SalePostTrnErr
            mAmount = pSHECESSAmount
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCodeDR, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        If Val(CStr(pSERVICEAmount)) <> 0 And pISMODVATE = "Y" Then
            mSubRowNo = mSubRowNo + 1
            mErrField = "Education Cess Expenses Error"
            mAccountCode = IIf(IsDBNull(RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value), "-1", RsCompany.Fields("SRVTAX_PURCHASE_RTN").Value)
            mAccountCodeDR = IIf(IsDBNull(RsCompany.Fields("SRVTAX_PURCHASE_RTN_INV").Value), "-1", RsCompany.Fields("SRVTAX_PURCHASE_RTN_INV").Value)
            If Trim(mAccountCode) = "-1" Or Trim(mAccountCode) = "0" Or Trim(mAccountCodeDR) = "-1" Or Trim(mAccountCodeDR) = "0" Then GoTo SalePostTrnErr
            mAmount = pSERVICEAmount
            If mAmount <> 0 Then
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCode, pVNo, pVDate, pBillNo, pBillDate, mAmount, "C", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
                mSubRowNo = mSubRowNo + 1
                If UpdateTRN(pDBCn, pMKey, pCurrRowNo, mSubRowNo, pBookCode, pVType, pBookType, pBookSubType, mAccountCodeDR, pVNo, pVDate, pBillNo, pBillDate, mAmount, "D", pTRNType, "", "", CStr(-1), CStr(-1), CStr(-1), CStr(-1), pDueDate, "", pTRNType, "", "", xNarration, pReason, pBillDate, pAddMode, pAddUser, pAddDate, mDivisionCode, pLoactionID) = False Then GoTo SalePostTrnErr
            End If
        End If
        PurchaseRejBEDPostTRN = True
        Exit Function
SalePostTrnErr:
        PurchaseRejBEDPostTRN = False
        If mAccountCode = "-1" Then
            MsgBox("Purchase Post Code Not Defined In " & mErrField)
        End If
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Sub ShellAndContinue(ByVal AppToRun As String, Optional ByRef LabelName As System.Windows.Forms.Label = Nothing, Optional ByRef PBar As System.Windows.Forms.ProgressBar = Nothing)
        On Error GoTo ErrorRoutineErr
        Dim hProcess As Integer
        Dim retval As Integer
        'The next line launches AppToRun,
        'captures process ID
        hProcess = OpenProcess(PROCESS_QUERY_INFORMATION, 1, Shell(AppToRun, AppWinStyle.NormalFocus))
        System.Windows.Forms.Application.DoEvents()
        Do
            'Get the status of the process
            GetExitCodeProcess(hProcess, retval)
            System.Windows.Forms.Application.DoEvents()
            'Loop while the process is active
        Loop While retval = STILL_ACTIVE
ErrorRoutineResume:
        Exit Sub
ErrorRoutineErr:
        MsgBox("AppShell.Form1.ShellAndContinue" & Err.Number & ErrorToString())
    End Sub
    Public Function GetPeriodStockQty(ByRef pItemCode As String, ByRef pDateFrom As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        ''COMPANY_CODE, FYEAR, STOCK_ID, STOCK_TYPE, ITEM_CODE,REF_DATE
        SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        Else
            If pStockType <> "" Then
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
            End If
            SqlStr = SqlStr & vbCrLf & " AND E_DATE>=TO_DATE('" & VB6.Format(pDateFrom, "dd-mmm-yyyy") & "','DD-MON-YYYY')" & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
        End If
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            ''02-08-2006
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If
        If pLotNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & MainClass.AllowSingleQuote(UCase(pLotNo)) & "'"
        End If
        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND REF_TYPE='" & pRefType & "'"
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        RsBalStock = Nothing
        If mBalQty <> 0 Then
            RsTemp = Nothing
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
                RsTemp = Nothing
                'RsTemp.Close
            End If
        End If
        GetPeriodStockQty = mBalQty
        Exit Function
ErrPart:
        GetPeriodStockQty = 0
    End Function
    Public Function GetWIPStockQty(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String, ByRef mDivisionCode As Object) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        'SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        SqlStr = "SELECT "

        SqlStr = SqlStr & vbCrLf & " --+ ORDERED INDEX (INV_STOCK_REC_TRN, IND_STK_REC_TRN_17)"
        'End If
        SqlStr = SqlStr & vbCrLf & "SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
        SqlStr = SqlStr & vbCrLf & " AND STOCK_ID='" & pStock_ID & "'"
        If mDivisionCode <> -1 Then
            SqlStr = SqlStr & vbCrLf & " AND DIV_CODE=" & mDivisionCode & ""
        End If
        If pLotNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & MainClass.AllowSingleQuote(UCase(pLotNo)) & "'"
        End If
        If pDeptCode <> "" And pStock_ID = ConPH Then
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        If mBalQty <> 0 Then
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
            End If
        End If
        GetWIPStockQty = mBalQty
        Exit Function
ErrPart:
        GetWIPStockQty = 0
    End Function
    Public Function GetReceiptStockQty(ByRef pItemCode As String, ByRef pDateFrom As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pLotNo As String, ByRef pStock_ID As String) As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        ''* CASE WHEN E_DATE<=TO_DATE('" & vb6.Format(pDateTo, "dd-mmm-yyyy") & "') THEN 1 ELSE 0 END
        SqlStr = "SELECT SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,0)) AS BALQTY"
        mTableName = ConInventoryTable

        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND REF_TYPE='MRR'" & vbCrLf & " AND REF_DATE>=TO_DATE('" & VB6.Format(pDateFrom, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        'SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        ElseIf pStockType = "ST" Or pStockType = "RJ" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        Else
            SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
        End If
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        If pLotNo <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & MainClass.AllowSingleQuote(UCase(pLotNo)) & "'"
        End If
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsBalStock, ADODB.LockTypeEnum.adLockReadOnly)
        If RsBalStock.EOF = False Then
            If IsDBNull(RsBalStock.Fields(0).Value) Then
                mBalQty = 0
            Else
                mBalQty = RsBalStock.Fields(0).Value
            End If
        Else
            mBalQty = 0
        End If
        If mBalQty <> 0 Then
            SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                mIssueUOM = IIf(IsDBNull(RsTemp.Fields("ISSUE_UOM").Value), "", RsTemp.Fields("ISSUE_UOM").Value)
                mPurchaseUOM = IIf(IsDBNull(RsTemp.Fields("PURCHASE_UOM").Value), "", RsTemp.Fields("PURCHASE_UOM").Value)
                mFactor = IIf(IsDBNull(RsTemp.Fields("UOM_FACTOR").Value) Or RsTemp.Fields("UOM_FACTOR").Value = 0, 1, RsTemp.Fields("UOM_FACTOR").Value)
                If pPackUnit = mPurchaseUOM Then
                    mBalQty = mBalQty / mFactor
                End If
            End If
        End If
        GetReceiptStockQty = mBalQty
        Exit Function
ErrPart:
        GetReceiptStockQty = 0
    End Function
    '******REQ IF WE TRACK EVERY OPR OF SINGLE SHOP *************
    Public Function UpdateProdStockTRN(ByRef pDBCn As ADODB.Connection, ByRef pMType As String, ByRef pProdCode As String, ByRef pSuppCode As String, ByRef pFromDeptCode As String, ByRef pToDeptCode As String, ByRef pSerialDate As String, ByRef pIType As String, ByRef pQty As Double) As Boolean
        On Error GoTo UpdateProdStockTRNErr
        Dim SqlStr As String = ""
        SqlStr = " INSERT INTO PRD_STOCK_TRN " & vbCrLf & " (COMPANY_CODE, M_TYPE, PRODUCT_CODE, " & vbCrLf & " SUPP_CUST_CODE, DEPT_CODE_FROM,DEPT_CODE_TO,EDATE, INPUT_TYPE,QTY) " & vbCrLf & " VALUES (" & RsCompany.Fields("COMPANY_CODE").Value & ", " & vbCrLf & " '" & MainClass.AllowSingleQuote(pMType) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pProdCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pSuppCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pFromDeptCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pToDeptCode) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pSerialDate, "DD/MMM/YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & MainClass.AllowSingleQuote(pIType) & "', " & vbCrLf & " " & pQty & " )"
        pDBCn.Execute(SqlStr)
        UpdateProdStockTRN = True
        Exit Function
UpdateProdStockTRNErr:
        UpdateProdStockTRN = False
        If Err.Description <> "" Then
            MsgInformation(Err.Description)
        End If
        'Resume
    End Function
    Public Function GetLatestItemCostFromMRR28072018(ByRef pItemCode As String, ByRef pItemUOM As String, ByRef pTotClosing As Double, ByRef pAsOnDate As String, ByRef pCostType As String, Optional ByRef pStockType As String = "", Optional ByRef pDeptCode As String = "", Optional ByRef mCheckInHouse As String = "") As Double
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTemp1 As ADODB.Recordset = Nothing
        Dim mRunningBal As Double
        Dim mApprovedQty As Double
        Dim mQtyValue As Double
        Dim mCalcQty As Double
        Dim pRefDate As String
        Dim mIssueUOM As String
        Dim mPurchaseUOM As String
        Dim mFactor As Double
        Dim xPurchaseCost As Double
        Dim xLandedCost As Double
        Dim xSaleCost As Double
        Dim mCategory As String
        Dim mStockType As String
        Dim mItemPurchaseCost As Double
        Dim mItemSalesCost As Double
        Dim mMKey As String
        Dim pINHouseRate As Double
        Dim mMainItemCode As String
        GetLatestItemCostFromMRR28072018 = 0
        If Trim(pItemCode) = "" Then '
            Exit Function
        End If
        If pTotClosing <= 0 Then
            GetLatestItemCostFromMRR28072018 = 0
            Exit Function
        End If
        mMainItemCode = GetMainItemCode(pItemCode)
        mFactor = 1
        SqlStr = " SELECT ISSUE_UOM, PURCHASE_UOM, UOM_FACTOR,PURCHASE_COST,ITEM_STD_COST,CATEGORY_CODE FROM INV_ITEM_MST " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(mMainItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp1, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp1.EOF = False Then
            mIssueUOM = IIf(IsDBNull(RsTemp1.Fields("ISSUE_UOM").Value), "", RsTemp1.Fields("ISSUE_UOM").Value)
            mPurchaseUOM = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_UOM").Value), "", RsTemp1.Fields("PURCHASE_UOM").Value)
            mFactor = IIf(IsDBNull(RsTemp1.Fields("UOM_FACTOR").Value) Or RsTemp1.Fields("UOM_FACTOR").Value = 0, 1, RsTemp1.Fields("UOM_FACTOR").Value)
            mCategory = IIf(IsDBNull(RsTemp1.Fields("CATEGORY_CODE").Value), "", RsTemp1.Fields("CATEGORY_CODE").Value)
            mItemPurchaseCost = IIf(IsDBNull(RsTemp1.Fields("PURCHASE_COST").Value), 0, RsTemp1.Fields("PURCHASE_COST").Value)
            mItemSalesCost = IIf(IsDBNull(RsTemp1.Fields("ITEM_STD_COST").Value), 0, RsTemp1.Fields("ITEM_STD_COST").Value)
            If mPurchaseUOM <> mIssueUOM Then
                If mFactor <> 0 Then
                    mItemPurchaseCost = mItemPurchaseCost / mFactor
                    mItemSalesCost = mItemSalesCost / mFactor
                End If
            End If
        End If
        mStockType = GetStockType(PubDBCn, mMainItemCode, 1)
        If mStockType = "CS" Then
            GetLatestItemCostFromMRR28072018 = CDbl(VB6.Format(pTotClosing * mItemSalesCost, "0.0000"))
        ElseIf CheckItemBom(mMainItemCode) = True Or pCostType = "S" Then ''IsProductionItem(mMainItemCode) = True Then'If CheckItemBom(mRMCode) = True Then
            'If mStockType = "FG" And pCostType = "S" Then
            If pStockType = "FG" Or pCostType = "S" Then
                SqlStr = "SELECT ITEM_PRICE " & vbCrLf & " FROM DSP_SALEORDER_HDR IH, DSP_SALEORDER_DET ID" & vbCrLf & " WHERE IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ID.ITEM_CODE='" & mMainItemCode & "' AND SO_APPROVED='Y'" & vbCrLf & " AND IH.AMEND_WEF_FROM= ( " & vbCrLf & " SELECT MAX(SH.AMEND_WEF_FROM) " & vbCrLf & " FROM DSP_SALEORDER_HDR SH, DSP_SALEORDER_DET SD" & vbCrLf & " WHERE SH.MKEY=SD.MKEY" & vbCrLf & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SD.ITEM_CODE='" & mMainItemCode & "' AND SO_APPROVED='Y'" & vbCrLf & " AND SH.AMEND_WEF_FROM<=TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
                SqlStr = SqlStr & vbCrLf & " ORDER BY SO_STATUS DESC"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    xSaleCost = IIf(IsDBNull(RsTemp.Fields("ITEM_PRICE").Value), "", RsTemp.Fields("ITEM_PRICE").Value)
                Else
                    xSaleCost = mItemSalesCost
                End If
            Else
                xSaleCost = GetMaterialCost(mMainItemCode, pStockType, pDeptCode, pAsOnDate, pCostType, pTotClosing)
            End If
            If xSaleCost = 0 Then GoTo NextRow
            GetLatestItemCostFromMRR28072018 = CDbl(VB6.Format(pTotClosing * xSaleCost, "0.0000"))
        Else
NextRow:
            If pCostType = "C" Then
                If GetLatestItemCostFromPO(mMainItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
                If xPurchaseCost = 0 Then
                    mQtyValue = (pTotClosing * mItemPurchaseCost)
                Else
                    mQtyValue = (pTotClosing * xPurchaseCost)
                End If
                GetLatestItemCostFromMRR28072018 = mQtyValue
            Else
                'If mCheckInHouse = "Y" Then
                'If CheckInHouseBOP(mMainItemCode, pAsOnDate, pTotClosing, pINHouseRate) = False Then GoTo ErrPart
                'End If
                SqlStr = "SELECT MKEY,AUTO_KEY_MRR, VNO,MRRDATE,ISMODVAT, ISSTREFUND, " & vbCrLf & " ITEM_UOM, " & vbCrLf & " APPROVED_QTY, " & vbCrLf & " ITEM_RATE, " & vbCrLf & " ITEM_ED, ITEM_ST, ITEM_CESS, ITEM_SHEC " & vbCrLf & " FROM FIN_PURCHASE_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & mMainItemCode & "'" & vbCrLf & " AND MRRDATE<=TO_DATE('" & VB6.Format(pAsOnDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
                SqlStr = SqlStr & vbCrLf & " ORDER BY MRRDATE DESC, TO_NUMBER(SUBSTR(AUTO_KEY_MRR,LENGTH(AUTO_KEY_MRR)-5,4)) DESC,TO_NUMBER(SUBSTR(AUTO_KEY_MRR,1,LENGTH(AUTO_KEY_MRR)-6)) DESC "
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mRunningBal = pTotClosing
                    Do While Not RsTemp.EOF
                        mApprovedQty = IIf(IsDBNull(RsTemp.Fields("APPROVED_QTY").Value), 0, RsTemp.Fields("APPROVED_QTY").Value)
                        mMKey = IIf(IsDBNull(RsTemp.Fields("mKey").Value), "-1", RsTemp.Fields("mKey").Value)
                        ''MsgBox RsTemp!VNO & " : " & mApprovedQty
                        If mApprovedQty <= 0 Then GoTo NextRec
                        'xPurchaseCost = IIf(IsNull(RsTemp!ITEM_RATE), 0, RsTemp!ITEM_RATE)
                        pRefDate = IIf(IsDBNull(RsTemp.Fields("MRRDATE").Value), "", RsTemp.Fields("MRRDATE").Value)
                        xPurchaseCost = GetPurchasePORate(mMKey, pRefDate, mMainItemCode) ''GetPurchasePORate(mMkey, pAsOnDate, mMainItemCode)
                        If xPurchaseCost = 0 Then GoTo NextRec ''xPurchaseCost = IIf(IsNull(RsTemp!ITEM_RATE), 0, RsTemp!ITEM_RATE)
                        If pItemUOM <> IIf(IsDBNull(RsTemp.Fields("ITEM_UOM").Value), "", RsTemp.Fields("ITEM_UOM").Value) Then
                            mApprovedQty = mApprovedQty * mFactor
                            xPurchaseCost = xPurchaseCost / mFactor
                        End If
                        If mRunningBal <= mApprovedQty Then
                            mCalcQty = mRunningBal
                            mRunningBal = 0
                        ElseIf mRunningBal > mApprovedQty Then
                            mCalcQty = mApprovedQty
                            mRunningBal = mRunningBal - mApprovedQty
                        End If
                        'If GetLatestItemCost(mMainItemCode, xPurchaseCost, xLandedCost, pRefDate, "ST", RsTemp!SUPP_CUST_CODE, pItemUOM, mFactor) = False Then GoTo ErrPart
                        If pCostType = "P" Then
                            mQtyValue = (mCalcQty * xPurchaseCost)
                        ElseIf pCostType = "L" Then
                            xLandedCost = xPurchaseCost
                            If RsTemp.Fields("ISMODVAT").Value = "N" Then
                                xLandedCost = xLandedCost + (IIf(IsDBNull(RsTemp.Fields("ITEM_ED").Value), 0, RsTemp.Fields("ITEM_ED").Value) / mApprovedQty)
                                xLandedCost = xLandedCost + (IIf(IsDBNull(RsTemp.Fields("ITEM_CESS").Value), 0, RsTemp.Fields("ITEM_CESS").Value) / mApprovedQty)
                                xLandedCost = xLandedCost + (IIf(IsDBNull(RsTemp.Fields("ITEM_SHEC").Value), 0, RsTemp.Fields("ITEM_SHEC").Value) / mApprovedQty)
                            End If
                            If RsTemp.Fields("ISSTREFUND").Value = "N" Then
                                xLandedCost = xLandedCost + (IIf(IsDBNull(RsTemp.Fields("ITEM_ST").Value), 0, RsTemp.Fields("ITEM_ST").Value) / mApprovedQty)
                            End If
                            mQtyValue = (mCalcQty * CDbl(VB6.Format(xLandedCost, "0.0000")))
                        End If
                        GetLatestItemCostFromMRR28072018 = GetLatestItemCostFromMRR28072018 + mQtyValue
                        If mRunningBal = 0 Then
                            Exit Do
                        End If
NextRec:
                        RsTemp.MoveNext()
                        If RsTemp.EOF = True Then
                            If mRunningBal > 0 Then
                                If pCostType = "P" Then
                                    mQtyValue = (mRunningBal * xPurchaseCost)
                                Else
                                    mQtyValue = (mRunningBal * xLandedCost)
                                End If
                                GetLatestItemCostFromMRR28072018 = GetLatestItemCostFromMRR28072018 + mQtyValue
                            End If
                        End If
                    Loop
                Else
                    If GetLatestItemCostFromPO(mMainItemCode, xPurchaseCost, xLandedCost, pAsOnDate, "ST", "", pItemUOM, mFactor) = False Then GoTo ErrPart
                    If pCostType = "P" Then
                        If xPurchaseCost = 0 Then
                            mQtyValue = (pTotClosing * mItemPurchaseCost)
                        Else
                            mQtyValue = (pTotClosing * xPurchaseCost)
                        End If
                    ElseIf pCostType = "L" Then
                        If xLandedCost = 0 Then
                            mQtyValue = (pTotClosing * mItemPurchaseCost)
                        Else
                            mQtyValue = (pTotClosing * CDbl(VB6.Format(xLandedCost, "0.0000")))
                        End If
                    End If
                    GetLatestItemCostFromMRR28072018 = mQtyValue
                End If
            End If
        End If
        GetLatestItemCostFromMRR28072018 = IIf(GetLatestItemCostFromMRR28072018 = 0, mItemPurchaseCost * pTotClosing, GetLatestItemCostFromMRR28072018)
        Exit Function
ErrPart:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function UpdateManyF4TRNold(ByRef pItemCode As String, ByRef pWEFDate As String, ByRef pMKey As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pItemQty As Double, ByRef pIO As String, ByRef pSubRowNo As Integer, ByRef pTRNType As String, ByRef pVDate As String, ByRef pIsScrap As String, ByRef pIsScrapMaterial As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim RsTrn As ADODB.Recordset = Nothing
        Dim mSubItemCode As String
        Dim pF4No As String
        Dim pF4Date As String
        Dim xAlterItemCode As String
        Dim mStdQty As Double
        Dim mReqdQty As Double
        Dim mItemF4ConsQty As Double
        UpdateManyF4TRNold = False
        SqlStr = "SELECT IH.MKEY, IH.PRODUCT_CODE, ID.RM_CODE,STD_QTY " & vbCrLf & " FROM PRD_NEWBOM_HDR IH, PRD_NEWBOM_DET ID " & vbCrLf & " WHERE " & vbCrLf & " IH.MKEY=ID.MKEY" & vbCrLf & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND IH.PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND ID.STOCK_TYPE='CS'"
        SqlStr = SqlStr & vbCrLf & " AND IH.WEF = (" & vbCrLf & " SELECT MAX(SH.WEF) " & vbCrLf & " FROM PRD_NEWBOM_HDR SH, PRD_NEWBOM_DET SD," & vbCrLf & " WHERE SH.MKEY=SD.MKEY" & vbCrLf & " AND SH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND SH.PRODUCT_CODE='" & pItemCode & "'" & vbCrLf & " AND SD.STOCK_TYPE='CS'" & vbCrLf & " AND SH.WEF<=TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            Do While RsTemp.EOF = False
                mSubItemCode = Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value))
                mStdQty = IIf(IsDBNull(RsTemp.Fields("STD_QTY").Value), 0, RsTemp.Fields("STD_QTY").Value)
                mReqdQty = mStdQty * pItemQty
                xAlterItemCode = GetAlterItemCode(Trim(IIf(IsDBNull(RsTemp.Fields("mKey").Value), "", RsTemp.Fields("mKey").Value)), Trim(IIf(IsDBNull(RsTemp.Fields("RM_CODE").Value), "", RsTemp.Fields("RM_CODE").Value)), 0)
                If xAlterItemCode = "" Then
                    mSubItemCode = "('" & mSubItemCode & "')"
                Else
                    'mSubItemCode = "('" & mSubItemCode & "', '" & MainClass.AllowSingleQuote(xAlterItemCode) & "')"
                    mSubItemCode = "('" & mSubItemCode & "', " & xAlterItemCode & ")"
                End If
                SqlStr = " SELECT SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY) AS ITEM_QTY,ITEM_CODE,PARTY_F4NO,PARTY_F4DATE " & vbCrLf & " FROM DSP_PAINT57F4_TRN " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE IN " & mSubItemCode & "" & vbCrLf & " AND ISSCRAP ='N'" & vbCrLf & " GROUP BY " & vbCrLf & " PARTY_F4NO,PARTY_F4DATE,ITEM_CODE " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1)*ITEM_QTY)>0"
                SqlStr = SqlStr & vbCrLf & " ORDER BY PARTY_F4DATE, PARTY_F4NO"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTrn, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTrn.EOF = False Then
                    Do While RsTrn.EOF = False
                        If RsTrn.EOF = False Then
                            mSubItemCode = IIf(IsDBNull(RsTrn.Fields("ITEM_CODE").Value), "", RsTrn.Fields("ITEM_CODE").Value)
                            pF4No = IIf(IsDBNull(RsTrn.Fields("PARTY_F4NO").Value), "", RsTrn.Fields("PARTY_F4NO").Value)
                            pF4Date = IIf(IsDBNull(RsTrn.Fields("PARTY_F4DATE").Value), "", RsTrn.Fields("PARTY_F4DATE").Value)
                            mItemF4ConsQty = IIf(IsDBNull(RsTrn.Fields("ITEM_QTY").Value), 0, RsTrn.Fields("ITEM_QTY").Value)
                            If mReqdQty <= mItemF4ConsQty Then
                                mItemF4ConsQty = mReqdQty
                                mReqdQty = 0
                            End If
                            If pF4No <> "" And pItemQty > 0 Then
                                SqlStr = "INSERT INTO DSP_PAINT57F4_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKTYPE, BOOKSUBTYPE, PARTY_F4NO, " & vbCrLf & " PARTY_F4DATE, SUPP_CUST_CODE, BILL_NO, " & vbCrLf & " BILL_DATE, ITEM_CODE," & vbCrLf & " ITEM_QTY, ITEM_IO, SUB_ITEM_CODE, " & vbCrLf & " SUBROWNO,BILL_QTY,TRNTYPE, VDATE, ISSCRAP,IS_SCRAP_MAT) VALUES ( " & vbCrLf & " '" & pMKey & "'," & RsCompany.Fields("COMPANY_CODE").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookType & "', '" & pBookSubType & "', '" & pF4No & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pF4Date, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pAccountCode & "', '" & MainClass.AllowSingleQuote(pBillNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(mSubItemCode) & "', " & vbCrLf & " " & mItemF4ConsQty & ", '" & pIO & "', '" & MainClass.AllowSingleQuote(pItemCode) & "'," & vbCrLf & " " & pSubRowNo & "," & pItemQty & ",'" & pTRNType & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsScrap & "', '" & pIsScrapMaterial & "' )"
                                PubDBCn.Execute(SqlStr)
                            End If
                            If mReqdQty <= 0 Then
                                Exit Do
                            Else
                                mReqdQty = mReqdQty - mItemF4ConsQty
                            End If
                            RsTrn.MoveNext()
                        End If
                    Loop
                End If
                RsTemp.MoveNext()
            Loop
        End If
        UpdateManyF4TRNold = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateManyF4TRNold = False
    End Function
    Public Function GetTotatHours(ByRef pInDateTime As Date, ByRef pOutDateTime As Date, ByRef pInDateTimeStr As Date, ByRef pOutDateTimeStr As Date, ByRef mTotDateTime As Date, ByRef mWorkHours As Date, ByRef mOTHours As Date, ByRef mSundayOTHours As Date, ByRef mShiftStart As Date, ByRef mShiftEnd As Date, ByRef xRunDate As String, ByRef xEmpCode As String) As Boolean
        On Error GoTo ERR1
        Dim mBalHours As Date
        Dim mOTFactor As Double
        Dim mHour As Short
        Dim mMin As Short
        Dim mWorkingHours As String
        Dim mOTStartHour As Double
        Dim mIsBreakApp As Boolean
        Dim mActualWorkingHour As Date
        Dim mISHoliday As Boolean
        Dim mAtcualInDateTime As String
        Dim mHolidayType As String = ""
        Dim mIsCashPayment As Boolean
        Dim mOTApp As Boolean
        Dim mInDateTime As Date
        Dim mOutDateTime As Date
        Dim mWHours As String
        Dim mActInShiftTime As String
        Dim mActOutShiftTime As String

        mInDateTime = pInDateTime
        mOutDateTime = pOutDateTime

        mIsBreakApp = GetIsBreakApp(CDate(GetShiftTime(xEmpCode, VB6.Format(xRunDate, "DD/MM/YYYY"), 0, "I", "E")), CDate(GetShiftTime(xEmpCode, VB6.Format(xRunDate, "DD/MM/YYYY"), 0, "O", "E")))

        If IsDate(pInDateTimeStr) And IsDate(pOutDateTimeStr) Then
            If CDate(VB6.Format(pOutDateTime, "HH:mm")) > "00:55" And VB6.Format(pInDateTimeStr, "DD/MM/YYYY") <> VB6.Format(pOutDateTimeStr, "DD/MM/YYYY") Then
                mIsBreakApp = False
            End If
        End If

        ''   & " CASE WHEN TO_CHAR(ATTN.OUT_TIME,'HH24:MI')>='00:55' AND TO_CHAR(ATTN.OUT_TIME,'DDMMYYYY')<>TO_CHAR(ATTN.IN_TIME,'DDMMYYYY') THEN 75 ELSE 0 END AS FOOD_ALLOW,"


        If CurrModuleName = mContPayrollModule Then
            If MainClass.ValidateWithMasterTable(xEmpCode, "EMP_CODE", "OT_APP", "PAY_CONT_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND OT_APP='Y'") = True Then
                mOTApp = True
            Else
                mOTApp = False
            End If
        Else
            If MainClass.ValidateWithMasterTable(xEmpCode, "EMP_CODE", "OVERTIME_APP", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND OVERTIME_APP='0'") = True Then
                mOTApp = False
            Else
                mOTApp = True
            End If
        End If

        mOTStartHour = IIf(IsDBNull(RsCompany.Fields("OT_START_MIN").Value), 0, RsCompany.Fields("OT_START_MIN").Value) / 60   ''IIf(RsCompany.Fields("ERP_CUSTOMER_ID").Value = 105, 1, 0)  

        If CurrModuleName = mContPayrollModule Then
            mOTFactor = IIf(IsDBNull(RsCompany.Fields("CONT_OTFACTOR").Value), 0, RsCompany.Fields("CONT_OTFACTOR").Value)
        Else
            mOTFactor = IIf(IsDBNull(RsCompany.Fields("OTFACTOR").Value), 0, RsCompany.Fields("OTFACTOR").Value)
        End If

        'mOTFactor = IIf(IsNull(RsCompany!CONT_OTFACTOR), 0, RsCompany!CONT_OTFACTOR)
        mInDateTime = CDate(VB6.Format(mInDateTime, "HH:mm"))
        mShiftStart = CDate(VB6.Format(mShiftStart, "HH:mm"))
        mAtcualInDateTime = CStr(TimeSerial(Hour(mInDateTime), Minute(mInDateTime), 0))

        If CurrModuleName = mContPayrollModule Then

            If Minute(mInDateTime) >= 0 And Minute(mInDateTime) <= 5 Then
                mInDateTime = TimeSerial(Hour(mInDateTime), 0, 0)
            ElseIf Minute(mInDateTime) > 5 And Minute(mInDateTime) <= 35 Then
                mInDateTime = TimeSerial(Hour(mInDateTime), 30, 0)
            Else
                mInDateTime = TimeSerial(Hour(mInDateTime) + 1, 0, 0)
            End If
            mInDateTime = CDate(VB6.Format(mInDateTime, "HH:mm"))
            mShiftStart = mInDateTime

        Else
            If mShiftStart > mInDateTime Then  '''Sandeep Kandwal 19-02
                mInDateTime = mShiftStart
                'mInDateTime = GetShiftTime(xEmpCode, VB6.Format(xRunDate, "DD-MMM-YYYY"), 0, "I", "E")
            End If
        End If

        mOutDateTime = CDate(VB6.Format(mOutDateTime, "HH:mm"))
        mTotDateTime = CDate(VB6.Format("00:00", "HH:mm"))
        mWorkHours = CDate(VB6.Format("00:00", "HH:mm"))
        mOTHours = CDate(VB6.Format("00:00", "HH:mm"))
        mSundayOTHours = CDate(VB6.Format("00:00", "HH:mm"))
        'mIsBreakApp = GetIsBreakApp(mShiftStart, mShiftEnd)

        mActualWorkingHour = CDate("8:00")
        If MainClass.ValidateWithMasterTable(xEmpCode, "EMP_CODE", "WORKING_HOURS", "PAY_EMPLOYEE_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            If MasterNo > "0" Then
                mWHours = VB6.Format(MasterNo, "00.00")
                mWHours = Replace(mWHours, ".", ":")
                mWHours = VB6.Format(VB6.Format(pInDateTime, "DD/MM/YYYY") & " " & mWHours, "DD/MM/YYYY HH:mm")
                mActualWorkingHour = CDate(VB6.Format(mWHours, "HH:mm"))
            End If
        End If

        If mIsBreakApp = True Then
            'mWorkingHours = (Minute(mTotDateTime) + (Hour(mTotDateTime) * 60)
            mWorkingHours = System.DateTime.FromOADate(CDate(VB6.Format(mActualWorkingHour, "HH:mm")).ToOADate + CDate(VB6.Format("00:30", "HH:mm")).ToOADate)
        Else
            mWorkingHours = mActualWorkingHour
        End If

        GetTotatHours = False

        If VB6.Format(mInDateTime, "HH:mm") = "" Or VB6.Format(mInDateTime, "HH:mm") = "00:00" Then GoTo ExitPart
        If VB6.Format(mOutDateTime, "HH:mm") = "" Or VB6.Format(mOutDateTime, "HH:mm") = "00:00" Then GoTo ExitPart

        If CDate(mAtcualInDateTime) <= CDate(mOutDateTime) Then ''CDate(mInDateTime) <= CDate(mOutDateTime) Then
            If CDate(mOutDateTime) <= CDate(mInDateTime) Then
                mTotDateTime = System.DateTime.FromOADate(0) ''mOutDateTime - mInDateTime
            Else
                mTotDateTime = System.DateTime.FromOADate(mOutDateTime.ToOADate - mInDateTime.ToOADate)
            End If
        Else
            mTotDateTime = System.DateTime.FromOADate(mInDateTime.ToOADate - System.DateTime.FromOADate(mOutDateTime.ToOADate + 12).ToOADate)
        End If

        If CDate(VB6.Format(mTotDateTime, "HH:mm")) >= CDate(VB6.Format(mWorkingHours, "HH:mm")) Then
            mWorkHours = mActualWorkingHour
            mBalHours = System.DateTime.FromOADate(CDate(VB6.Format(mTotDateTime, "HH:mm")).ToOADate - CDate(VB6.Format(mWorkingHours, "HH:mm")).ToOADate)
        Else
            ''Change Sandeep 16-07-2014''mActualWorkingHour
            If CDate(VB6.Format(mTotDateTime, "HH:mm")) <= CDate(VB6.Format(mWorkingHours, "HH:mm")) And CDate(VB6.Format(mTotDateTime, "HH:mm")) >= CDate(VB6.Format(mActualWorkingHour, "HH:mm")) Then
                mWorkHours = mActualWorkingHour ''"8:00"
                mBalHours = CDate(VB6.Format("0", "HH:mm"))
            ElseIf (Minute(mTotDateTime) + (Hour(mTotDateTime) * 60)) >= ((Minute(mActualWorkingHour) + (Hour(mActualWorkingHour) * 60)) / 2) + 30 Then
                mWorkHours = System.DateTime.FromOADate(CDate(VB6.Format(mTotDateTime, "HH:mm")).ToOADate - CDate(VB6.Format("00:30", "HH:mm")).ToOADate) '' mTotDateTime '
                mBalHours = CDate(VB6.Format("0", "HH:mm"))
            Else
                mWorkHours = mTotDateTime ''CDate(Format(mTotDateTime, "HH:mm")) - CDate(Format("00:30", "HH:mm")) '' mTotDateTime '
                mBalHours = CDate(VB6.Format("0", "HH:mm"))
            End If
        End If


        mISHoliday = GetIsHolidays(VB6.Format(xRunDate, "DD/MM/YYYY"), mHolidayType, xEmpCode, "", "Y")
        If mISHoliday = True Then
            mBalHours = CDate(VB6.Format(System.DateTime.FromOADate(mWorkHours.ToOADate + mBalHours.ToOADate), "HH:mm"))
            mWorkHours = CDate(VB6.Format("0", "HH:mm"))
        End If

        If CDate(VB6.Format(mBalHours, "HH:mm")) <= System.DateTime.FromOADate(0) Then
            mOTHours = CDate(VB6.Format("0:00", "HH:mm"))
        Else
            'mIsBreakApp = GetIsBreakApp(mShiftEnd, mOutDateTime)
            If mISHoliday = False Then
                If mIsBreakApp = True And Hour(mBalHours) > 8 Then
                    mBalHours = System.DateTime.FromOADate(CDate(VB6.Format(mBalHours, "HH:mm")).ToOADate - CDate(VB6.Format("0:30", "HH:mm")).ToOADate) '' mBalHours - "0:30"
                Else
                    mBalHours = mBalHours
                End If
            End If
            mHour = Hour(mBalHours)

            If (Hour(mBalHours) * 60) + Minute(mBalHours) >= mOTStartHour * 60 Then
                'mMin = Int((Minute(Format(mBalHours, "HH:mm")) - (mOTStartHour * 60)) / mOTFactor) * mOTFactor
                mMin = Int((Minute(mBalHours) + 5) / mOTFactor) * mOTFactor
                'If Minute(mBalHours) >= mOTFactor Then
                'mMin = mOTFactor
                'End If
            Else
                'If mOTStartHour <= 1 Or mHour < 1 Then
                '    mMin = 0
                'Else
                mMin = Int(Minute(mBalHours) / mOTFactor) * mOTFactor
                'End If
            End If
            'Else
            'If mHour >= mOTStartHour Then
            'mMin = Int(Minute(mBalHours + 5) / mOTFactor) * mOTFactor
            ''If Minute(mBalHours) >= 25 Then
            ''mMin = mMin + 30
            ''End If
            'Else
            'mMin = Int(Minute(mBalHours) / mOTFactor) * mOTFactor
            'End If
            'End If
            If mOTApp = False Then
                mBalHours = System.DateTime.FromOADate(0)
            Else
                mBalHours = TimeSerial(mHour, mMin, 0)
            End If
        End If
        mOTHours = CDate(VB6.Format(mBalHours, "HH:mm"))
        mSundayOTHours = CDate(VB6.Format("0", "HH:mm"))

ExitPart:
        GetTotatHours = True
        Exit Function
ERR1:
        'Resume
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        GetTotatHours = False
    End Function
    Public Function UpdateProvisionTRN(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pTRNDtlSubRowNo As Integer, ByRef pSubRowNo As Integer, ByRef pBookCode As String, ByRef pVType As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pAmount As Double, ByRef pDC As String, ByRef pTRNType As String, ByRef pChequeNo As String, ByRef pChqDate As String, ByRef pCostCCode As String, ByRef pDeptCode As String, ByRef pEmpCode As String, ByRef pExpCode As String, ByRef pDivCode As Double, ByRef pDueDate As String, ByRef pIBRNo As String, ByRef pBillType As String, ByRef pClearDate As String, ByRef pLocked As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, Optional ByRef pPLFlag As String = "") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim pDueDays As Double
        Dim pModUser As String
        Dim pModDate As String
        ''pDueDate = DateAdd("D", pDueDays, pBillDate)
        If IsDate(pDueDate) Then
            pDueDays = DateDiff(Microsoft.VisualBasic.DateInterval.Day, CDate(pBillDate), CDate(pDueDate))
        Else
            pDueDays = 0
        End If
        pNarration = Left(pNarration, 254)
        pRemarks = Left(pRemarks, 254)
        pPLFlag = IIf(pPLFlag = "", "N", pPLFlag)
        If pAddMode = True Then
            pAddUser = PubUserID
            pAddDate = CStr(PubCurrDate)
            pModUser = ""
            pModDate = ""
        Else
            pModUser = PubUserID
            pModDate = CStr(PubCurrDate)
        End If
        SqlStr = "Insert Into FIN_PROVISION_TRN ( " & vbCrLf _
            & " MKey, TRNDtlSubRowNo, SubRowNo, " & vbCrLf _
            & " Company_Code, FYEAR, BookCode, VType, " & vbCrLf _
            & " BookType, BookSubType, AccountCode, " & vbCrLf _
            & " Vno, VDate, BillNo, BillDate, " & vbCrLf _
            & " Amount, DC, " & vbCrLf _
            & " TrnType, ChequeNo, ChqDate, CostCCode, " & vbCrLf _
            & " DeptCode, EmpCode, EXP_CODE,DIV_CODE, DueDays, DueDate, " & vbCrLf _
            & " IBRNo, ClearDate, Locked, BILLTYPE, Narration, Remarks, " & vbCrLf _
            & " AddUser , AddDate, ModUser, ModDate,EXPDATE, PL_FLAG ) VALUES ( " & vbCrLf _
            & " '" & PKey & "' , " & pTRNDtlSubRowNo & ", " & pSubRowNo & ", " & vbCrLf _
            & " " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & ", '" & pBookCode & "', '" & pVType & "', " & vbCrLf _
            & " '" & pBookType & "','" & pBookSubType & "', '" & pAccountCode & "', " & vbCrLf _
            & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
            & " '" & pBillNo & "',TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
            & " " & pAmount & ", '" & pDC & "', '" & pTRNType & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pChequeNo) & "', TO_DATE('" & VB6.Format(pChqDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pCostCCode) & "', '" & MainClass.AllowSingleQuote(pDeptCode) & "', '" & MainClass.AllowSingleQuote(pEmpCode) & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pExpCode) & "'," & pDivCode & ", " & pDueDays & ", " & vbCrLf _
            & " TO_DATE('" & VB6.Format(pDueDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pIBRNo) & "', " & vbCrLf _
            & " TO_DATE('" & VB6.Format(pClearDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pLocked) & "', " & vbCrLf _
            & " '" & pBillType & "', '" & MainClass.AllowSingleQuote(pNarration) & "','" & MainClass.AllowSingleQuote(pRemarks) & "', " & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pAddUser) & "',TO_DATE('" & VB6.Format(pAddDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
            & " '" & MainClass.AllowSingleQuote(pModUser) & "',TO_DATE('" & VB6.Format(pModDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf _
            & " TO_DATE('" & VB6.Format(pExpDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pPLFlag & "')"

        pDBCn.Execute(SqlStr)
        UpdateProvisionTRN = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateProvisionTRN = False
        'Resume
    End Function
    Public Function UpdateProfitLossTRN(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pTRNDtlSubRowNo As Integer, ByRef pSubRowNo As Integer, ByRef pBookCode As String, ByRef pVType As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pAccountCode As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pAmount As Double, ByRef pDC As String, ByRef pTRNType As String, ByRef pChequeNo As String, ByRef pChqDate As String, ByRef pCostCCode As String, ByRef pDeptCode As String, ByRef pEmpCode As String, ByRef pExpCode As String, ByRef pDivCode As Double, ByRef pDueDate As String, ByRef pIBRNo As String, ByRef pBillType As String, ByRef pClearDate As String, ByRef pLocked As String, ByRef pNarration As String, ByRef pRemarks As String, ByRef pExpDate As String, ByRef pAddMode As Boolean, ByRef pAddUser As String, ByRef pAddDate As String, Optional ByRef pPLFlag As String = "") As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim pDueDays As Double
        Dim pModUser As String
        Dim pModDate As String
        ''pDueDate = DateAdd("D", pDueDays, pBillDate)
        If IsDate(pDueDate) Then
            pDueDays = DateDiff(Microsoft.VisualBasic.DateInterval.Day, CDate(pBillDate), CDate(pDueDate))
        Else
            pDueDays = 0
        End If
        pNarration = Left(pNarration, 254)
        pRemarks = Left(pRemarks, 254)
        pPLFlag = IIf(pPLFlag = "", "N", pPLFlag)
        If pAddMode = True Then
            pAddUser = PubUserID
            pAddDate = CStr(PubCurrDate)
            pModUser = ""
            pModDate = ""
        Else
            pModUser = PubUserID
            pModDate = CStr(PubCurrDate)
        End If
        SqlStr = "Insert Into FIN_PROFITLOSS_TRN ( " & vbCrLf & " MKey, TRNDtlSubRowNo, SubRowNo, " & vbCrLf & " Company_Code, FYEAR, BookCode, VType, " & vbCrLf & " BookType, BookSubType, AccountCode, " & vbCrLf & " Vno, VDate, BillNo, BillDate, " & vbCrLf & " Amount, DC, " & vbCrLf & " TrnType, ChequeNo, ChqDate, CostCCode, " & vbCrLf & " DeptCode, EmpCode, EXP_CODE,DIV_CODE, DueDays, DueDate, " & vbCrLf & " IBRNo, ClearDate, Locked, BILLTYPE, Narration, Remarks, " & vbCrLf & " AddUser , AddDate, ModUser, ModDate,EXPDATE, PL_FLAG ) VALUES ( " & vbCrLf & " '" & PKey & "' , " & pTRNDtlSubRowNo & ", " & pSubRowNo & ", " & vbCrLf & " " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & ", '" & pBookCode & "', '" & pVType & "', " & vbCrLf & " '" & pBookType & "','" & pBookSubType & "', '" & pAccountCode & "', " & vbCrLf & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & pBillNo & "',TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " " & pAmount & ", '" & pDC & "', '" & pTRNType & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pChequeNo) & "', TO_DATE('" & VB6.Format(pChqDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), " & vbCrLf & " '" & MainClass.AllowSingleQuote(pCostCCode) & "', '" & MainClass.AllowSingleQuote(pDeptCode) & "', '" & MainClass.AllowSingleQuote(pEmpCode) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pExpCode) & "'," & pDivCode & ", " & pDueDays & ", " & vbCrLf & " TO_DATE('" & VB6.Format(pDueDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pIBRNo) & "', " & vbCrLf & " TO_DATE('" & VB6.Format(pClearDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & MainClass.AllowSingleQuote(pLocked) & "', " & vbCrLf & " '" & pBillType & "', '" & MainClass.AllowSingleQuote(pNarration) & "','" & MainClass.AllowSingleQuote(pRemarks) & "', " & vbCrLf & " '" & MainClass.AllowSingleQuote(pAddUser) & "',TO_DATE('" & VB6.Format(pAddDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & MainClass.AllowSingleQuote(pModUser) & "',TO_DATE('" & VB6.Format(pModDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " TO_DATE('" & VB6.Format(pExpDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pPLFlag & "')"
        pDBCn.Execute(SqlStr)
        UpdateProfitLossTRN = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateProfitLossTRN = False
        'Resume
    End Function
    Public Function UpdateGSTTRN(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pVNo As String, ByRef pVDate As String, ByRef pBillNo As String, ByRef pBillDate As String, ByRef pOriginalBillNo As String, ByRef pOriginalBillDate As String, ByRef pSuppCustCode As String, ByRef pAccountCode As String, ByRef pShipToSameParty As String, ByRef pShipToSuppCustCode As String, ByRef pSubRowNo As Integer, ByRef pItemCode As String, ByRef pItemQty As Double, ByRef pItemUOM As String, ByRef pItemRate As Double, ByRef pItemAmount As Double, ByRef pTaxableAmount As Double, ByRef pItemMRP As Double, ByRef pCGSTPer As Double, ByRef pSGSTPer As Double, ByRef pIGSTPer As Double, ByRef pCGSTAmount As Double, ByRef pSGSTAmount As Double, ByRef pIGSTAmount As Double, ByRef pCGSTRefundAmount As Double, ByRef pSGSTRefundAmount As Double, ByRef pIGSTRefundAmount As Double, ByRef mDivisionCode As Double, ByRef mHSNCode As String, ByRef mItemDesc As String, ByRef pLocation As String, ByRef pProvAssessment As String, ByRef pRefType As String, ByRef pGoodsNService As String, ByRef pIsReverseCharge As String, ByRef pGSTDC As String, ByRef pGSTDate As String, ByRef pIsPLA As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mPartyGSTNo As String
        Dim mCompanyGSTNo As String
        mCompanyGSTNo = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
        mPartyGSTNo = ""
        If MainClass.ValidateWithMasterTable(pSuppCustCode, "SUPP_CUST_CODE", "GST_RGN_NO", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then
            mPartyGSTNo = MasterNo
        End If
        If Trim(UCase(mCompanyGSTNo)) = Trim(UCase(mPartyGSTNo)) Then
            UpdateGSTTRN = True
            Exit Function
        End If
        SqlStr = "Insert Into FIN_GST_POST_TRN ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKCODE, BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " VNO, VDATE, BILLNO, INVOICE_DATE, " & vbCrLf & " ORIGINAL_BILLNO, ORIGINAL_INVOICE_DATE, SUPP_CUST_CODE, " & vbCrLf & " ACCOUNTCODE, SHIPPED_TO_SAMEPARTY, SHIPPED_TO_PARTY_CODE, " & vbCrLf & " SUBROWNO, ITEM_CODE, ITEM_QTY, " & vbCrLf & " ITEM_UOM, ITEM_RATE, ITEM_AMT, GSTABLE_AMT, " & vbCrLf & " ITEM_MRP, CGST_PER, SGST_PER, " & vbCrLf & " IGST_PER, CGST_AMOUNT, SGST_AMOUNT," & vbCrLf & " IGST_AMOUNT, REFUNDABLE_CGST_AMOUNT, " & vbCrLf & " REFUNDABLE_SGST_AMOUNT, REFUNDABLE_IGST_AMOUNT, " & vbCrLf & " DIV_CODE,HSNCODE,ITEMDESC,LOCATION, PROVISIONAL_ASSESSMENT, " & vbCrLf & " REF_TYPE, GOOD_SERVICE, IS_REVERSE_CHARGE, GST_DC, GST_CLAIM_DATE, ISPLA "
        SqlStr = SqlStr & vbCrLf & " ) VALUES ( "
        SqlStr = SqlStr & vbCrLf & " '" & PKey & "', " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookCode & "', '" & pBookType & "','" & pBookSubType & "', " & vbCrLf & " '" & pVNo & "',TO_DATE('" & VB6.Format(pVDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pBillNo & "',TO_DATE('" & VB6.Format(pBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')," & vbCrLf & " '" & pOriginalBillNo & "',TO_DATE('" & VB6.Format(pOriginalBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pSuppCustCode & "'," & vbCrLf & " '" & pAccountCode & "', '" & pShipToSameParty & "', '" & pShipToSuppCustCode & "', " & vbCrLf & " " & pSubRowNo & ", '" & pItemCode & "', " & pItemQty & ", " & vbCrLf & " '" & pItemUOM & "', " & pItemRate & ", " & pItemAmount & ", " & pTaxableAmount & ", " & vbCrLf & " " & pItemMRP & ", " & pCGSTPer & ", " & pSGSTPer & ", " & pIGSTPer & "," & vbCrLf & " " & pCGSTAmount & ", " & pSGSTAmount & ", " & pIGSTAmount & "," & vbCrLf & " " & pCGSTRefundAmount & ", " & pSGSTRefundAmount & ", " & pIGSTRefundAmount & ", " & vbCrLf & " " & mDivisionCode & ", '" & mHSNCode & "','" & MainClass.AllowSingleQuote(mItemDesc) & "'," & vbCrLf & " '" & pLocation & "','" & pProvAssessment & "','" & pRefType & "','" & pGoodsNService & "', " & vbCrLf & " '" & pIsReverseCharge & "','" & pGSTDC & "',TO_DATE('" & VB6.Format(pGSTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & pIsPLA & "')"
        pDBCn.Execute(SqlStr)
        UpdateGSTTRN = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateGSTTRN = False
        ''Resume
    End Function
    Public Function UpdateGSTSeqMaster(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pGSTNo As Double, ByRef pGSTDate As String, ByRef pISCapital As String, ByRef pPLA As String, ByRef pGoodsNService As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM FIN_GST_SEQ_MST " & vbCrLf & " WHERE MKEY= '" & PKey & "'" & vbCrLf & " AND COMPANY_CODE = " & RsCompany.Fields("Company_Code").Value & "" & vbCrLf & " AND FYEAR = " & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BOOKCODE = '" & pBookCode & "'" & vbCrLf & " AND BOOKTYPE = '" & pBookType & "'"
        pDBCn.Execute(SqlStr)
        SqlStr = "Insert Into FIN_GST_SEQ_MST ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKCODE, BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " GST_CLAIM_NO, GST_CLAIM_DATE, " & vbCrLf & " IS_CAPITAL, IS_PLA, GOODS_SERVICE "
        SqlStr = SqlStr & vbCrLf & " ) VALUES ( "
        SqlStr = SqlStr & vbCrLf & " '" & PKey & "', " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookCode & "', '" & pBookType & "','" & pBookSubType & "', " & vbCrLf & " '" & pGSTNo & "',TO_DATE('" & VB6.Format(pGSTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'), '" & pISCapital & "'," & vbCrLf & " '" & pPLA & "', '" & pGoodsNService & "')"
        pDBCn.Execute(SqlStr)
        UpdateGSTSeqMaster = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateGSTSeqMaster = False
        ''Resume
    End Function
    Public Function UpdateGSTAppSeqMaster(ByRef pDBCn As ADODB.Connection, ByRef PKey As String, ByRef pBookCode As String, ByRef pBookType As String, ByRef pBookSubType As String, ByRef pGSTNo As Double, ByRef pGSTDate As String, ByRef mClaimValue As String, ByRef pInputReverse As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        SqlStr = "DELETE FROM FIN_GST_NEWSEQ_MST " & vbCrLf & " WHERE MKEY= '" & PKey & "'" & vbCrLf & " AND COMPANY_CODE = " & RsCompany.Fields("Company_Code").Value & "" & vbCrLf & " AND FYEAR = " & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BOOKCODE = '" & pBookCode & "'" & vbCrLf & " AND BOOKTYPE = '" & pBookType & "'"
        pDBCn.Execute(SqlStr)
        SqlStr = "Insert Into FIN_GST_NEWSEQ_MST ( " & vbCrLf & " MKEY, COMPANY_CODE, FYEAR, " & vbCrLf & " BOOKCODE, BOOKTYPE, BOOKSUBTYPE, " & vbCrLf & " GST_CLAIM_NO, GST_CLAIM_DATE, CLAIM_TYPE, INPUT_REVERSE"
        SqlStr = SqlStr & vbCrLf & " ) VALUES ( "
        SqlStr = SqlStr & vbCrLf & " '" & PKey & "', " & RsCompany.Fields("Company_Code").Value & ", " & RsCompany.Fields("FYEAR").Value & "," & vbCrLf & " '" & pBookCode & "', '" & pBookType & "','" & pBookSubType & "', " & vbCrLf & " '" & pGSTNo & "',TO_DATE('" & VB6.Format(pGSTDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'),'" & mClaimValue & "','" & pInputReverse & "')"
        pDBCn.Execute(SqlStr)
        UpdateGSTAppSeqMaster = True
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
        UpdateGSTAppSeqMaster = False
        ''Resume
    End Function
    Public Function GetReworkStockQty(ByRef pSBSlipNo As Double, ByRef pItemCode As String, ByRef pDeptCode As String, ByRef pDivCode As Integer, ByRef pStockType As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0, Optional ByRef pBatchNo As String = "", Optional ByRef pBatchNoRequired As String = "") As Double
        On Error GoTo ERR1
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        If Val(CStr(pSBSlipNo)) = 0 Then Exit Function
        If Trim(pItemCode) = "" Then Exit Function
        If Val(CStr(pDivCode)) = 0 Then Exit Function
        If pStockType <> "CR" Then
            If Trim(pDeptCode) = "" Then Exit Function
        End If
        GetReworkStockQty = 0
        SqlStr = "SELECT SUM(DECODE(ITEM_IO,'I',1,-1) * ITEM_QTY) As ITEM_QTY" & vbCrLf & " FROM PRD_REWORK_TRN" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'" & vbCrLf & " AND DIV_CODE=" & pDivCode & ""
        If Val(CStr(pSBSlipNo)) <> -1 Then
            SqlStr = SqlStr & vbCrLf & " AND AUTO_KEY_SBRWK=" & pSBSlipNo & ""
        End If
        If pBatchNoRequired = "Y" Then
            SqlStr = SqlStr & vbCrLf & " AND BATCH_NO='" & pBatchNo & "'"
        End If
        If Trim(pDeptCode) <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND DEPT_CODE='" & pDeptCode & "'"
        End If
        If Val(CStr(pRefNo)) > 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE||AUTO_KEY_REF<>'" & pRefType & Val(CStr(pRefNo)) & "'"
        End If
        SqlStr = SqlStr & vbCrLf & " GROUP BY AUTO_KEY_SBRWK, SB_DATE, ITEM_CODE,ITEM_UOM " & vbCrLf & " HAVING SUM(DECODE(ITEM_IO,'I',1,-1) * ITEM_QTY)>0"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetReworkStockQty = IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), 0, RsTemp.Fields("ITEM_QTY").Value)
        End If
        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Sub FormLoadSetting(ByRef pForm As System.Windows.Forms.Form)
        If pFormPic <> "" Then
            If UCase(Right(pFormPic, 3)) = UCase("ico") Then
                pForm.Icon = New System.Drawing.Icon(My.Application.Info.DirectoryPath & "\Picture\" & pFormPic)
            End If
        End If
    End Sub
    Public Sub ShowTrn(ByRef MymKey As String, ByRef MyDate As String, ByRef MyVType As String,
                       ByRef MyVnoStr As String, ByRef MyBookType As String, ByRef MyBookSubType As String, ByRef pForm As System.Windows.Forms.Form)

        Dim MyVnoPrefix As String
        Dim MyVno As String
        Dim FormLoaded As Boolean
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mBookCode As String
        Dim mBillSeq As String
        Dim mBillSeqType As Integer
        Dim mDnCnType As String
        Dim mVType As String
        Dim pSeparateGST As String
        If MyVnoStr = "" Then Exit Sub
        Dim mm As New frmAtrn
        Select Case MyBookType
            Case "S"
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Mid(MyVnoStr, 2)
                SqlStr = " SELECT BILLNOPREFIX, BILLNOSEQ, BOOKCODE, INVOICESEQTYPE FROM FIN_INVOICE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BILLNO='" & MyVnoStr & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mBookCode = IIf(IsDBNull(RsTemp.Fields("BOOKCODE").Value), "-2", RsTemp.Fields("BOOKCODE").Value)
                    MyVnoPrefix = IIf(IsDBNull(RsTemp.Fields("BILLNOPREFIX").Value), "", RsTemp.Fields("BILLNOPREFIX").Value)
                    If CDate(MyDate) < CDate(PubGSTApplicableDate) Then
                        MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("BILLNOSEQ").Value), "0", RsTemp.Fields("BILLNOSEQ").Value), "00000")
                    Else
                        MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("BILLNOSEQ").Value), "0", RsTemp.Fields("BILLNOSEQ").Value), "00000000")
                    End If
                    mBillSeq = IIf(IsDBNull(RsTemp.Fields("INVOICESEQTYPE").Value), "", RsTemp.Fields("INVOICESEQTYPE").Value)
                Else
                    mBookCode = "-2"
                End If
                If CDbl(mBillSeq) = 7 Or CDbl(mBillSeq) = 8 Then
                    FrmInvoiceRCGST.MdiParent = pForm.MdiParent
                    FrmInvoiceRCGST.LblBookCode.Text = mBookCode
                    FrmInvoiceRCGST.lblInvoiceSeq.Text = mBillSeq
                    FrmInvoiceRCGST.Show()
                    FrmInvoiceRCGST.FrmInvoiceRCGST_Activated(Nothing, New System.EventArgs())
                    FrmInvoiceRCGST.txtBillNoPrefix.Text = MyVnoPrefix
                    FrmInvoiceRCGST.txtBillNo.Text = MyVno
                    FrmInvoiceRCGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    FrmInvoiceRCGST.Activate()
                Else
                    If mBookCode = "-2" Or mBookCode = "-16" Then
                        FrmInvoiceGST.MdiParent = pForm.MdiParent
                        FrmInvoiceGST.LblBookCode.Text = mBookCode
                        FrmInvoiceGST.lblInvoiceSeq.Text = mBillSeq

                        FrmInvoiceGST.Show()
                        FrmInvoiceGST.FrmInvoiceGST_Activated(Nothing, New System.EventArgs())
                        FrmInvoiceGST.txtBillNoPrefix.Text = MyVnoPrefix
                        FrmInvoiceGST.txtBillNo.Text = MyVno
                        FrmInvoiceGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                        FrmInvoiceGST.Activate()
                    ElseIf mBookCode = "-17" Then
                        FrmInvoice_MiscGST.MdiParent = pForm.MdiParent
                        FrmInvoice_MiscGST.LblBookCode.Text = mBookCode
                        FrmInvoice_MiscGST.lblInvoiceSeq.Text = mBillSeq
                        FrmInvoice_MiscGST.Show()
                        FrmInvoice_MiscGST.FrmInvoice_MiscGST_Activated(Nothing, New System.EventArgs())
                        FrmInvoice_MiscGST.txtBillNoPrefix.Text = MyVnoPrefix
                        FrmInvoice_MiscGST.txtBillNo.Text = MyVno
                        FrmInvoice_MiscGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                        FrmInvoice_MiscGST.Activate()
                    Else
                        'FrmInvoice_Supp.LblBookCode.Text = mBookCode
                        'FrmInvoice_Supp.Show()
                        'FrmInvoice_Supp.FrmInvoice_Supp_Activated(Nothing, New System.EventArgs())
                        'FrmInvoice_Supp.txtBillNoPrefix.Text = MyVnoPrefix
                        'FrmInvoice_Supp.txtBillNo.Text = MyVno
                        'FrmInvoice_Supp.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    End If
                End If
            Case "P"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                SqlStr = " SELECT PURCHASE_TYPE,PURCHASESEQTYPE FROM FIN_PURCHASE_HDR WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & " AND VNO='" & MyVnoStr & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                mBillSeq = ""
                mBillSeqType = 0
                If RsTemp.EOF = False Then
                    mBillSeq = IIf(IsDBNull(RsTemp.Fields("PURCHASE_TYPE").Value), "", RsTemp.Fields("PURCHASE_TYPE").Value)
                    mBillSeqType = IIf(IsDBNull(RsTemp.Fields("PURCHASESEQTYPE").Value), 0, RsTemp.Fields("PURCHASESEQTYPE").Value)
                End If
                pSeparateGST = GetSeparateGSTRefund()
                If mBillSeq = "W" Or mBillSeq = "S" Then
                    FrmPurchaseWO.MdiParent = pForm.MdiParent
                    FrmPurchaseWO.txtVNo.Visible = True
                    FrmPurchaseWO.txtVDate.Visible = True
                    FrmPurchaseWO.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseWO.lblVNo.Text = "VNo :"
                    FrmPurchaseWO.Text = IIf(mBillSeq = "W", "Purchase Entry (GST Work Order)", "Contract / Service / Other Bill Entry - GST")
                    FrmPurchaseWO.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseWO.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseWO.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseWO.Show()
                    FrmPurchaseWO.FrmPurchaseWO_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseWO.txtVDate.Text = MyDate
                    FrmPurchaseWO.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseWO.txtVNoSuffix.Text = ""
                    FrmPurchaseWO.txtVNo.Text = MyVno
                    FrmPurchaseWO.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    FrmPurchaseWO.Activate()
                ElseIf mBillSeqType = 3 Then
                    FrmPurchaseShipGST.MdiParent = pForm.MdiParent
                    FrmPurchaseShipGST.txtVNo.Visible = True
                    FrmPurchaseShipGST.txtVDate.Visible = True
                    FrmPurchaseShipGST.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseShipGST.lblVNo.Text = "VNo :"
                    FrmPurchaseShipGST.Text = IIf(mBillSeq = "R", "Purchase Entry (Repair)", "GST") ''"Purchase Entry"
                    FrmPurchaseShipGST.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseShipGST.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseShipGST.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseShipGST.Show()
                    FrmPurchaseShipGST.FrmPurchaseShipGST_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseShipGST.txtVDate.Text = MyDate
                    FrmPurchaseShipGST.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseShipGST.txtVNoSuffix.Text = ""
                    FrmPurchaseShipGST.txtVNo.Text = MyVno
                    FrmPurchaseShipGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    FrmPurchaseShipGST.Activate()
                Else
                    FrmPurchaseGST.MdiParent = pForm.MdiParent
                    FrmPurchaseGST.txtVNo.Visible = True
                    FrmPurchaseGST.txtVDate.Visible = True
                    FrmPurchaseGST.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseGST.lblVNo.Text = "VNo :"
                    FrmPurchaseGST.Text = IIf(mBillSeq = "R", "Purchase Entry (Repair)", "GST") ''"Purchase Entry"
                    FrmPurchaseGST.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseGST.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseGST.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseGST.Show()
                    FrmPurchaseGST.FrmPurchaseGST_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseGST.txtVDate.Text = MyDate
                    FrmPurchaseGST.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseGST.txtVNoSuffix.Text = ""
                    FrmPurchaseGST.txtVNo.Text = MyVno
                    FrmPurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    FrmPurchaseGST.Activate()
                End If
            Case "SUPP_PUR"
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = VB6.Format(MyVnoStr, "00000")
                FrmSupp_PurchaseGST.MdiParent = pForm.MdiParent
                FrmSupp_PurchaseGST.lblBookType.Text = "J"
                FrmSupp_PurchaseGST.Show()
                FrmSupp_PurchaseGST.FrmSupp_PurchaseGST_Activated(Nothing, New System.EventArgs())
                FrmSupp_PurchaseGST.txtVDate.Text = MyDate
                FrmSupp_PurchaseGST.txtVNo.Text = MyVno
                FrmSupp_PurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                FrmSupp_PurchaseGST.Activate()
            Case "U"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmSupp_PurchaseGST.MdiParent = pForm.MdiParent
                FrmSupp_PurchaseGST.lblBookType.Text = "U"
                FrmSupp_PurchaseGST.LblBookCode.Text = CStr(ConPurchaseSuppBookCode)
                FrmSupp_PurchaseGST.Show()
                FrmSupp_PurchaseGST.FrmSupp_PurchaseGST_Activated(Nothing, New System.EventArgs())
                FrmSupp_PurchaseGST.txtVDate.Text = MyDate
                FrmSupp_PurchaseGST.txtVNo.Text = MyVno
                FrmSupp_PurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                FrmSupp_PurchaseGST.Activate()
            Case "L"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmCust_SaleGST.MdiParent = pForm.MdiParent
                FrmCust_SaleGST.LblBookCode.Text = CStr(ConSaleDebitBookCode)
                FrmCust_SaleGST.lblBookType.Text = "LS"
                FrmCust_SaleGST.lblGoodService.Text = "G"
                FrmCust_SaleGST.Show()
                FrmCust_SaleGST.FrmCust_SaleGST_Activated(Nothing, New System.EventArgs())
                FrmCust_SaleGST.txtVDate.Text = MyDate
                FrmCust_SaleGST.txtVNo.Text = MyVno
                FrmCust_SaleGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                FrmCust_SaleGST.Activate()
            Case "M"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmCust_SaleGST.MdiParent = pForm.MdiParent
                FrmCust_SaleGST.LblBookCode.Text = CStr(ConSaleCreditBookCode)
                FrmCust_SaleGST.lblBookType.Text = "MS"
                FrmCust_SaleGST.lblGoodService.Text = "G"
                FrmCust_SaleGST.Show()
                FrmCust_SaleGST.FrmCust_SaleGST_Activated(Nothing, New System.EventArgs())
                FrmCust_SaleGST.txtVDate.Text = MyDate
                FrmCust_SaleGST.txtVNo.Text = MyVno
                FrmCust_SaleGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                FrmCust_SaleGST.Activate()
            Case "E", "R"
                If RsCompany.Fields("FYEAR").Value >= 2020 Then
                    MyVnoPrefix = Left(MyVnoStr, Len(MyVnoStr) - 8)
                    MyVno = Right(MyVnoStr, 8)
                Else
                    MyVnoPrefix = Left(MyVnoStr, Len(MyVnoStr) - 5)
                    MyVno = Right(MyVnoStr, 5)
                End If
                SqlStr = " SELECT DNCNTYPE, VNOPREFIX, VNOSEQ, VNOSUFFIX, VNO, VTYPE,DNCNSEQTYPE FROM FIN_DNCN_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND MKEY='" & MymKey & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    MyVnoPrefix = IIf(IsDBNull(RsTemp.Fields("VNOPREFIX").Value), "", RsTemp.Fields("VNOPREFIX").Value)
                    MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VNOSEQ").Value), "0", RsTemp.Fields("VNOSEQ").Value), "00000")
                    mVType = IIf(IsDBNull(RsTemp.Fields("VTYPE").Value), "", RsTemp.Fields("VTYPE").Value)
                    mDnCnType = IIf(IsDBNull(RsTemp.Fields("DNCNTYPE").Value), "", RsTemp.Fields("DNCNTYPE").Value)
                    mBillSeqType = IIf(IsDBNull(RsTemp.Fields("DNCNSEQTYPE").Value), 0, RsTemp.Fields("DNCNSEQTYPE").Value)
                End If
                FrmDrCrNoteGST.MdiParent = pForm.MdiParent
                If mDnCnType = "S" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Shortage)"
                ElseIf mDnCnType = "D" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Discount)"
                ElseIf mDnCnType = "O" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Others)"
                ElseIf mDnCnType = "P" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (PO Rate Diff)"
                ElseIf mDnCnType = "A" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Amend PO Rate Diff)"
                ElseIf mDnCnType = "R" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Rejection)"
                ElseIf mDnCnType = "V" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Volume Discount)"
                End If
                FrmDrCrNoteGST.LblBookCode.Text = IIf(MyBookType = "E", ConDebitNoteBookCode, ConCreditNoteBookCode)
                FrmDrCrNoteGST.lblDCType.Text = mDnCnType
                FrmDrCrNoteGST.Show()
                FrmDrCrNoteGST.FrmDrCrNoteGST_Activated(Nothing, New System.EventArgs())
                FrmDrCrNoteGST.txtVDate.Text = MyDate
                FrmDrCrNoteGST.txtVType.Text = mVType
                FrmDrCrNoteGST.txtVNoPrefix.Text = MyVnoPrefix
                FrmDrCrNoteGST.txtVNo.Text = MyVno
                FrmDrCrNoteGST.txtVNoSuffix.Text = ""
                FrmDrCrNoteGST.lblDNCNSeqType.Text = CStr(mBillSeqType)
                FrmDrCrNoteGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                FrmDrCrNoteGST.Activate()
            Case "B", "F", "C", "J"
                MyVno = MyVType & MyVnoStr
                SqlStr = " SELECT VDATE,VTYPE,VNOPREFIX,VNOSEQ,VNOSUFFIX FROM FIN_VOUCHER_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BOOKTYPE='" & MyBookType & "'" & vbCrLf & " AND BOOKSUBTYPE='" & MyBookSubType & "'" & vbCrLf & " AND VNO='" & MyVno & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    MyDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VDATE").Value), "", RsTemp.Fields("VDATE").Value), "DD/MM/YYYY")
                    MyVType = IIf(IsDBNull(RsTemp.Fields("VTYPE").Value), "", RsTemp.Fields("VTYPE").Value)
                    MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VNOSEQ").Value), "", RsTemp.Fields("VNOSEQ").Value), "00000")
                    mm.MdiParent = pForm.MdiParent
                    mm.lblBookType.Text = MyBookType & MyBookSubType
                    mm.Show()
                    mm.frmAtrn_Activated(Nothing, New System.EventArgs())
                    mm.TxtVDate.Text = VB6.Format(MyDate, "dd/mm/yyyy")
                    mm.txtVType.Text = MyVType
                    mm.txtVno.Text = MyVno
                    mm.txtVNo1.Text = IIf(IsDBNull(RsTemp.Fields("VNOPREFIX").Value), "", RsTemp.Fields("VNOPREFIX").Value)
                    mm.txtVNoSuffix.Text = IIf(IsDBNull(RsTemp.Fields("VNOSUFFIX").Value), "", RsTemp.Fields("VNOSUFFIX").Value)
                    mm.CheckVouchExistance()
                    mm.Activate()
                End If
        End Select
        FormLoaded = True
    End Sub
    Public Sub ShowTrnOtherUnit(ByRef MyCompanyCode As Long, ByRef MymKey As String, ByRef MyDate As String, ByRef MyVType As String,
                       ByRef MyVnoStr As String, ByRef MyBookType As String, ByRef MyBookSubType As String, ByRef pForm As System.Windows.Forms.Form)

        'Dim MyVnoPrefix As String
        Dim MyVnoPrefix As String
        Dim MyVno As String
        Dim FormLoaded As Boolean
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mBookCode As String
        Dim mBillSeq As String
        Dim mBillSeqType As Integer
        Dim mDnCnType As String
        Dim mVType As String
        Dim pSeparateGST As String
        If MyVnoStr = "" Then Exit Sub
        Dim mm As New frmAtrnOtherUnit
        Select Case MyBookType
            Case "S"
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Mid(MyVnoStr, 2)
                SqlStr = " SELECT BILLNOPREFIX, BILLNOSEQ, BOOKCODE, INVOICESEQTYPE FROM FIN_INVOICE_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & MyCompanyCode & "" & vbCrLf & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND BILLNO='" & MyVnoStr & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    mBookCode = IIf(IsDBNull(RsTemp.Fields("BOOKCODE").Value), "-2", RsTemp.Fields("BOOKCODE").Value)
                    MyVnoPrefix = IIf(IsDBNull(RsTemp.Fields("BILLNOPREFIX").Value), "", RsTemp.Fields("BILLNOPREFIX").Value)
                    If CDate(MyDate) < CDate(PubGSTApplicableDate) Then
                        MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("BILLNOSEQ").Value), "0", RsTemp.Fields("BILLNOSEQ").Value), "00000")
                    Else
                        MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("BILLNOSEQ").Value), "0", RsTemp.Fields("BILLNOSEQ").Value), "00000000")
                    End If
                    mBillSeq = IIf(IsDBNull(RsTemp.Fields("INVOICESEQTYPE").Value), "", RsTemp.Fields("INVOICESEQTYPE").Value)
                Else
                    mBookCode = "-2"
                End If
                If CDbl(mBillSeq) = 7 Or CDbl(mBillSeq) = 8 Then
                    FrmInvoiceRCGST.MdiParent = pForm.MdiParent
                    FrmInvoiceRCGST.LblBookCode.Text = mBookCode
                    FrmInvoiceRCGST.lblInvoiceSeq.Text = mBillSeq
                    FrmInvoiceRCGST.Show()
                    FrmInvoiceRCGST.FrmInvoiceRCGST_Activated(Nothing, New System.EventArgs())
                    FrmInvoiceRCGST.txtBillNoPrefix.Text = MyVnoPrefix
                    FrmInvoiceRCGST.txtBillNo.Text = MyVno
                    FrmInvoiceRCGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                Else
                    If mBookCode = "-2" Or mBookCode = "-16" Then
                        FrmInvoiceGST.MdiParent = pForm.MdiParent
                        FrmInvoiceGST.LblBookCode.Text = mBookCode
                        FrmInvoiceGST.lblInvoiceSeq.Text = mBillSeq
                        FrmInvoiceGST.lblCompanyCode.Text = MyCompanyCode
                        FrmInvoiceGST.Show()
                        FrmInvoiceGST.FrmInvoiceGST_Activated(Nothing, New System.EventArgs())
                        FrmInvoiceGST.txtBillNoPrefix.Text = MyVnoPrefix
                        FrmInvoiceGST.txtBillNo.Text = MyVno
                        FrmInvoiceGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    ElseIf mBookCode = "-17" Then
                        FrmInvoice_MiscGST.MdiParent = pForm.MdiParent
                        FrmInvoice_MiscGST.LblBookCode.Text = mBookCode
                        FrmInvoice_MiscGST.lblInvoiceSeq.Text = mBillSeq
                        FrmInvoice_MiscGST.Show()
                        FrmInvoice_MiscGST.FrmInvoice_MiscGST_Activated(Nothing, New System.EventArgs())
                        FrmInvoice_MiscGST.txtBillNoPrefix.Text = MyVnoPrefix
                        FrmInvoice_MiscGST.txtBillNo.Text = MyVno
                        FrmInvoice_MiscGST.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    Else
                        'FrmInvoice_Supp.LblBookCode.Text = mBookCode
                        'FrmInvoice_Supp.Show()
                        'FrmInvoice_Supp.FrmInvoice_Supp_Activated(Nothing, New System.EventArgs())
                        'FrmInvoice_Supp.txtBillNoPrefix.Text = MyVnoPrefix
                        'FrmInvoice_Supp.txtBillNo.Text = MyVno
                        'FrmInvoice_Supp.txtBillNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                    End If
                End If
            Case "P"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                SqlStr = " SELECT PURCHASE_TYPE,PURCHASESEQTYPE FROM FIN_PURCHASE_HDR WHERE COMPANY_CODE=" & MyCompanyCode & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & " AND VNO='" & MyVnoStr & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                mBillSeq = ""
                mBillSeqType = 0
                If RsTemp.EOF = False Then
                    mBillSeq = IIf(IsDBNull(RsTemp.Fields("PURCHASE_TYPE").Value), "", RsTemp.Fields("PURCHASE_TYPE").Value)
                    mBillSeqType = IIf(IsDBNull(RsTemp.Fields("PURCHASESEQTYPE").Value), 0, RsTemp.Fields("PURCHASESEQTYPE").Value)
                End If
                pSeparateGST = GetSeparateGSTRefund()
                If mBillSeq = "W" Or mBillSeq = "S" Then
                    FrmPurchaseWO.MdiParent = pForm.MdiParent
                    FrmPurchaseWO.txtVNo.Visible = True
                    FrmPurchaseWO.txtVDate.Visible = True
                    FrmPurchaseWO.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseWO.lblVNo.Text = "VNo :"
                    FrmPurchaseWO.Text = IIf(mBillSeq = "W", "Purchase Entry (GST Work Order)", "Contract / Service / Other Bill Entry - GST")
                    FrmPurchaseWO.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseWO.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseWO.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseWO.Show()
                    FrmPurchaseWO.FrmPurchaseWO_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseWO.txtVDate.Text = MyDate
                    FrmPurchaseWO.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseWO.txtVNoSuffix.Text = ""
                    FrmPurchaseWO.txtVNo.Text = MyVno
                    FrmPurchaseWO.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                ElseIf mBillSeqType = 3 Then
                    FrmPurchaseShipGST.MdiParent = pForm.MdiParent
                    FrmPurchaseShipGST.txtVNo.Visible = True
                    FrmPurchaseShipGST.txtVDate.Visible = True
                    FrmPurchaseShipGST.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseShipGST.lblVNo.Text = "VNo :"
                    FrmPurchaseShipGST.Text = IIf(mBillSeq = "R", "Purchase Entry (Repair)", "GST") ''"Purchase Entry"
                    FrmPurchaseShipGST.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseShipGST.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseShipGST.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseShipGST.Show()
                    FrmPurchaseShipGST.FrmPurchaseShipGST_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseShipGST.txtVDate.Text = MyDate
                    FrmPurchaseShipGST.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseShipGST.txtVNoSuffix.Text = ""
                    FrmPurchaseShipGST.txtVNo.Text = MyVno
                    FrmPurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                Else
                    FrmPurchaseGST.MdiParent = pForm.MdiParent
                    FrmPurchaseGST.txtVNo.Visible = True
                    FrmPurchaseGST.txtVDate.Visible = True
                    FrmPurchaseGST.lblSeprateGST.Text = pSeparateGST
                    FrmPurchaseGST.lblVNo.Text = "VNo :"
                    FrmPurchaseGST.Text = IIf(mBillSeq = "R", "Purchase Entry (Repair)", "GST") ''"Purchase Entry"
                    FrmPurchaseGST.lblPurchaseType.Text = mBillSeq
                    FrmPurchaseGST.lblPurchaseSeqType.Text = CStr(mBillSeqType)
                    FrmPurchaseGST.LblBookCode.Text = CStr(ConPurchaseBookCode)
                    FrmPurchaseGST.Show()
                    FrmPurchaseGST.FrmPurchaseGST_Activated(Nothing, New System.EventArgs())
                    FrmPurchaseGST.txtVDate.Text = MyDate
                    FrmPurchaseGST.txtVNoPrefix.Text = MyVnoPrefix
                    FrmPurchaseGST.txtVNoSuffix.Text = ""
                    FrmPurchaseGST.txtVNo.Text = MyVno
                    FrmPurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
                End If
            Case "SUPP_PUR"
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = VB6.Format(MyVnoStr, "00000")
                FrmSupp_PurchaseGST.MdiParent = pForm.MdiParent
                FrmSupp_PurchaseGST.lblBookType.Text = "J"
                FrmSupp_PurchaseGST.Show()
                FrmSupp_PurchaseGST.FrmSupp_PurchaseGST_Activated(Nothing, New System.EventArgs())
                FrmSupp_PurchaseGST.txtVDate.Text = MyDate
                FrmSupp_PurchaseGST.txtVNo.Text = MyVno
                FrmSupp_PurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
            Case "U"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmSupp_PurchaseGST.MdiParent = pForm.MdiParent
                FrmSupp_PurchaseGST.lblBookType.Text = "U"
                FrmSupp_PurchaseGST.LblBookCode.Text = CStr(ConPurchaseSuppBookCode)
                FrmSupp_PurchaseGST.Show()
                FrmSupp_PurchaseGST.FrmSupp_PurchaseGST_Activated(Nothing, New System.EventArgs())
                FrmSupp_PurchaseGST.txtVDate.Text = MyDate
                FrmSupp_PurchaseGST.txtVNo.Text = MyVno
                FrmSupp_PurchaseGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
            Case "L"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmCust_SaleGST.MdiParent = pForm.MdiParent
                FrmCust_SaleGST.LblBookCode.Text = CStr(ConSaleDebitBookCode)
                FrmCust_SaleGST.lblBookType.Text = "LS"
                FrmCust_SaleGST.lblGoodService.Text = "G"
                FrmCust_SaleGST.Show()
                FrmCust_SaleGST.FrmCust_SaleGST_Activated(Nothing, New System.EventArgs())
                FrmCust_SaleGST.txtVDate.Text = MyDate
                FrmCust_SaleGST.txtVNo.Text = MyVno
                FrmCust_SaleGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
            Case "M"
                MyVnoPrefix = Left(MyVnoStr, 1)
                MyVno = Mid(MyVnoStr, 2)
                '            MyVnoPrefix = Left(MyVnoStr, 1)
                '            MyVno = Format(MyVnoStr, "00000")
                FrmCust_SaleGST.MdiParent = pForm.MdiParent
                FrmCust_SaleGST.LblBookCode.Text = CStr(ConSaleCreditBookCode)
                FrmCust_SaleGST.lblBookType.Text = "LS"
                FrmCust_SaleGST.lblGoodService.Text = "G"
                FrmCust_SaleGST.Show()
                FrmCust_SaleGST.FrmCust_SaleGST_Activated(Nothing, New System.EventArgs())
                FrmCust_SaleGST.txtVDate.Text = MyDate
                FrmCust_SaleGST.txtVNo.Text = MyVno
                FrmCust_SaleGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
            Case "E", "R"
                If RsCompany.Fields("FYEAR").Value >= 2020 Then
                    MyVnoPrefix = Left(MyVnoStr, Len(MyVnoStr) - 8)
                    MyVno = Right(MyVnoStr, 8)
                Else
                    MyVnoPrefix = Left(MyVnoStr, Len(MyVnoStr) - 5)
                    MyVno = Right(MyVnoStr, 5)
                End If
                SqlStr = " SELECT DNCNTYPE, VNOPREFIX, VNOSEQ, VNOSUFFIX, VNO, VTYPE,DNCNSEQTYPE FROM FIN_DNCN_HDR" & vbCrLf & " WHERE COMPANY_CODE=" & MyCompanyCode & "" & vbCrLf & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf & " AND MKEY='" & MymKey & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
                If RsTemp.EOF = False Then
                    MyVnoPrefix = IIf(IsDBNull(RsTemp.Fields("VNOPREFIX").Value), "", RsTemp.Fields("VNOPREFIX").Value)
                    MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VNOSEQ").Value), "0", RsTemp.Fields("VNOSEQ").Value), "00000")
                    mVType = IIf(IsDBNull(RsTemp.Fields("VTYPE").Value), "", RsTemp.Fields("VTYPE").Value)
                    mDnCnType = IIf(IsDBNull(RsTemp.Fields("DNCNTYPE").Value), "", RsTemp.Fields("DNCNTYPE").Value)
                    mBillSeqType = IIf(IsDBNull(RsTemp.Fields("DNCNSEQTYPE").Value), 0, RsTemp.Fields("DNCNSEQTYPE").Value)
                End If
                FrmDrCrNoteGST.MdiParent = pForm.MdiParent
                If mDnCnType = "S" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Shortage)"
                ElseIf mDnCnType = "D" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Discount)"
                ElseIf mDnCnType = "O" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Others)"
                ElseIf mDnCnType = "P" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (PO Rate Diff)"
                ElseIf mDnCnType = "A" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Amend PO Rate Diff)"
                ElseIf mDnCnType = "R" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Rejection)"
                ElseIf mDnCnType = "V" Then
                    FrmDrCrNoteGST.Text = IIf(MyBookType = "E", "Debit Note Entry", "Credit Note Entry") & " (Volume Discount)"
                End If
                FrmDrCrNoteGST.LblBookCode.Text = IIf(MyBookType = "E", ConDebitNoteBookCode, ConCreditNoteBookCode)
                FrmDrCrNoteGST.lblDCType.Text = mDnCnType
                FrmDrCrNoteGST.Show()
                FrmDrCrNoteGST.FrmDrCrNoteGST_Activated(Nothing, New System.EventArgs())
                FrmDrCrNoteGST.txtVDate.Text = MyDate
                FrmDrCrNoteGST.txtVType.Text = mVType
                FrmDrCrNoteGST.txtVNoPrefix.Text = MyVnoPrefix
                FrmDrCrNoteGST.txtVNo.Text = MyVno
                FrmDrCrNoteGST.txtVNoSuffix.Text = ""
                FrmDrCrNoteGST.lblDNCNSeqType.Text = CStr(mBillSeqType)
                FrmDrCrNoteGST.txtVNo_Validating(Nothing, New System.ComponentModel.CancelEventArgs(False))
            Case "B", "F", "C", "J"
                MyVno = MyVType & MyVnoStr
                SqlStr = " SELECT VDATE,VTYPE,VNOPREFIX,VNOSEQ,VNOSUFFIX FROM FIN_VOUCHER_HDR" & vbCrLf _
                    & " WHERE COMPANY_CODE=" & MyCompanyCode & "" & vbCrLf _
                    & " AND FYEAR =" & RsCompany.Fields("FYEAR").Value & "" & vbCrLf _
                    & " AND BOOKTYPE='" & MyBookType & "'" & vbCrLf _
                    & " AND BOOKSUBTYPE='" & MyBookSubType & "'" & vbCrLf _
                    & " AND VNO='" & MyVno & "'"
                MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

                If RsTemp.EOF = False Then
                    MyDate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VDATE").Value), "", RsTemp.Fields("VDATE").Value), "DD/MM/YYYY")
                    MyVType = IIf(IsDBNull(RsTemp.Fields("VTYPE").Value), "", RsTemp.Fields("VTYPE").Value)
                    MyVno = VB6.Format(IIf(IsDBNull(RsTemp.Fields("VNOSEQ").Value), "", RsTemp.Fields("VNOSEQ").Value), "00000")
                    mm.MdiParent = pForm.MdiParent
                    mm.lblBookType.Text = MyBookType & MyBookSubType
                    mm.lblCompanyCode.Text = MyCompanyCode
                    mm.Show()
                    mm.frmAtrnOtherUnit_Activated(Nothing, New System.EventArgs())
                    mm.TxtVDate.Text = VB6.Format(MyDate, "dd/mm/yyyy")
                    mm.txtVType.Text = MyVType
                    mm.txtVno.Text = MyVno
                    mm.txtVNo1.Text = IIf(IsDBNull(RsTemp.Fields("VNOPREFIX").Value), "", RsTemp.Fields("VNOPREFIX").Value)
                    mm.txtVNoSuffix.Text = IIf(IsDBNull(RsTemp.Fields("VNOSUFFIX").Value), "", RsTemp.Fields("VNOSUFFIX").Value)
                    mm.CheckVouchExistance()
                End If
        End Select
        FormLoaded = True
    End Sub
    Public Function CheckMachinePMSchd(ByRef pMachineNo As String, ByRef pCheckType As String, ByRef pDate As Date) As Object
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim mRsTemp As ADODB.Recordset = Nothing
        Dim mPMDone As String
        Dim mNextDue As String

        'Dim PvtDBCn As ADODB.Connection
        'Set PvtDBCn = New ADODB.Connection
        'PvtDBCn.Open StrConn
        SqlStr = " Select PM_DONE,NEXT_DUE FROM MAN_MACHINE_SCHD_DET " & vbCrLf _
            & " WHERE MACHINE_NO ='" & MainClass.AllowSingleQuote(pMachineNo) & "' " & vbCrLf _
            & " AND CHECK_TYPE ='" & MainClass.AllowSingleQuote(pCheckType) & "' " & vbCrLf _
            & " AND AUTO_KEY_SCHD=" & vbCrLf _
            & " (SELECT AUTO_KEY_SCHD FROM MAN_MACHINE_SCHD_HDR " & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND SCHD_MONTH=" & Val(VB6.Format(pDate, "MM")) & " " & vbCrLf _
            & " AND SCHD_YEAR=" & Val(VB6.Format(pDate, "YYYY")) & " ) "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, mRsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If Not mRsTemp.EOF Then
            mPMDone = IIf(IsDBNull(mRsTemp.Fields("PM_DONE").Value), "", mRsTemp.Fields("PM_DONE").Value)
            mNextDue = IIf(IsDBNull(mRsTemp.Fields("NEXT_DUE").Value), "", mRsTemp.Fields("NEXT_DUE").Value)

            If mPMDone = "" Then
                If mNextDue = "" Then
                    CheckMachinePMSchd = True
                Else
                    MsgBox("PM Schedule has been skipped for this machine in this month")
                    CheckMachinePMSchd = False
                End If
            Else
                MsgBox("PM already done for this machine in this month on " & VB6.Format(mRsTemp.Fields("PM_DONE").Value, "DD/MM/YYYY"))
                CheckMachinePMSchd = False
            End If
        Else
            MsgBox("PM Schedule not available for this machine in this month.")
            CheckMachinePMSchd = False
        End If
        mRsTemp.Close()
        mRsTemp = Nothing
        'PvtDBCn.Close
        'Set PvtDBCn = Nothing
        Exit Function
ErrPart:
    End Function
    Public Function CheckGauge_IMTEPMSchd(ByRef pDocNo As String, ByRef pDate As Date, ByRef pDocType As String, ByRef pCheckType As String) As Boolean

        Dim SqlStr As String = ""
        Dim mRsTemp As ADODB.Recordset = Nothing
        'Dim PvtDBCn As ADODB.Connection
        'Set PvtDBCn = New ADODB.Connection
        'PvtDBCn.Open StrConn
        SqlStr = " Select PM_DONE,NEXT_DUE FROM QAL_IMTE_SCHD_DET " & vbCrLf & " WHERE DOCNO ='" & MainClass.AllowSingleQuote(pDocNo) & "' " & vbCrLf & " AND CHECK_TYPE ='" & MainClass.AllowSingleQuote(pCheckType) & "' " & vbCrLf & " AND AUTO_KEY_SCHD=" & vbCrLf & " (SELECT AUTO_KEY_SCHD FROM QAL_IMTE_SCHD_HDR " & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND DOC_TYPE='" & pDocType & "'" & vbCrLf & " AND SCHD_MONTH=" & Val(VB6.Format(pDate, "MM")) & " " & vbCrLf & " AND SCHD_YEAR=" & Val(VB6.Format(pDate, "YYYY")) & " ) "
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, mRsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If Not mRsTemp.EOF Then
            If IsDBNull(mRsTemp.Fields("PM_DONE").Value) Or mRsTemp.Fields("PM_DONE").Value = "" Then
                If IsDBNull(mRsTemp.Fields("NEXT_DUE").Value) Or mRsTemp.Fields("NEXT_DUE").Value = "" Then
                    CheckGauge_IMTEPMSchd = True
                Else
                    MsgBox("PM Schedule has been skipped for this Doc in this month")
                    CheckGauge_IMTEPMSchd = False
                End If
            Else
                MsgBox("PM already done for this Doc in this month on " & VB6.Format(mRsTemp.Fields("PM_DONE").Value, "DD/MM/YYYY"))
                CheckGauge_IMTEPMSchd = False
            End If
        Else
            MsgBox("PM Schedule not available for this Doc in this month.")
            CheckGauge_IMTEPMSchd = False
        End If
        mRsTemp.Close()
        mRsTemp = Nothing
        'PvtDBCn.Close
        'Set PvtDBCn = Nothing
    End Function
    Public Function GetLineCapacityQty(ByVal pProductCode As String, ByVal pDeptCode As String, ByVal pDate As String) As Double

        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mQty As Double
        Dim mCheckDate As String
        Dim mCheckWorkingDays As Integer

        GetLineCapacityQty = 0
        SqlStr = ""

        SqlStr = " SELECT " & vbCrLf _
            & " SUM(CAPACITY_DAY) AS CAPACITY_DAY" & vbCrLf _
            & " FROM INV_ITEMWISE_CAPACITY_HDR IH, INV_ITEMWISE_CAPACITY_DET ID" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " " & vbCrLf _
            & " AND IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.PRODUCT_CODE = '" & MainClass.AllowSingleQuote(pProductCode) & "'"
        If pDeptCode <> "" Then
            SqlStr = SqlStr & vbCrLf & " AND ID.DEPT_CODE = '" & MainClass.AllowSingleQuote(pDeptCode) & "'"
        End If

        SqlStr = SqlStr & vbCrLf _
            & " AND IH.WEF= (" & vbCrLf & " SELECT MAX(WEF) FROM INV_ITEMWISE_CAPACITY_HDR" & vbCrLf _
            & " WHERE COMPANY_CODE=IH.COMPANY_CODE" & vbCrLf _
            & " AND PRODUCT_CODE=IH.PRODUCT_CODE" & vbCrLf _
            & " AND WEF<=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetLineCapacityQty = GetLineCapacityQty + IIf(IsDBNull(RsTemp.Fields("CAPACITY_DAY").Value), 0, RsTemp.Fields("CAPACITY_DAY").Value)
        End If

        Exit Function
ErrPart:
        GetLineCapacityQty = 0
    End Function
    Public Function GererateQRCodeImage(ByVal mBMPFileName As String, ByRef pSignedQRCode As String) As Boolean

        On Error GoTo ErrPart

        Dim qrGenerator As New QRCodeGenerator()

        Dim QRCodeData As QRCodeData = qrGenerator.CreateQrCode(pSignedQRCode, QRCodeGenerator.ECCLevel.Q)

        Dim qrCode As New QRCode(QRCodeData)

        'Dim imgBarCode As New System.Web.UI.WebControls.Image()
        'imgBarCode.Height = 50   '' 150
        'imgBarCode.Width = 50   '' 150
        'Dim mBMPFileName As String = Application.ExecutablePath

        'mBMPFileName = mPubBarCodePath & "\" & Trim(txtBillNoPrefix.Text) & Trim(txtBillNo.Text) & ".Bmp"   ''file_name.Substring(0, file_name.LastIndexOf("\bin")) & "\test."

        If FILEExists(mBMPFileName) Then
            DeleteFile(mBMPFileName)
        End If


        'Using Ms As MemoryStream = New MemoryStream()
        Using bitMap As Bitmap = qrCode.GetGraphic(20)    ''qrCode.GetGraphic(20)           ''6 to be test
            bitMap.Save(mBMPFileName, System.Drawing.Imaging.ImageFormat.Png)  ''Jpeg     ''bitMap.Save(mBMPFileName, System.Drawing.Imaging.ImageFormat.Bmp)
            'Dim mPath As String = Path.GetTempFileName()
        End Using
        'End Using


        Do While Not FILEExists(mBMPFileName)
        Loop

        qrGenerator.Dispose()
        QRCodeData.Dispose()
        qrCode.Dispose()
        'bitMap.Dispose()
        GererateQRCodeImage = True
        Exit Function
ErrPart:
        'Resume		
        qrGenerator.Dispose()
        QRCodeData.Dispose()
        qrCode.Dispose()
        'bitMap.Dispose()
        GererateQRCodeImage = False
        MsgInformation(Err.Description)
    End Function
    Public Function GetItemHeatWiseQry(ByRef pItemCode As String, ByRef pDateTo As String, ByRef pPackUnit As String, ByRef pDeptCode As String, ByRef pStockType As String, ByRef pHeatNo As String, ByRef pStock_ID As String, Optional ByRef pRefType As String = "", Optional ByRef pRefNo As Double = 0) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsBalStock As ADODB.Recordset = Nothing
        Dim mBalQty As Double
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mIssueUOM As String = ""
        Dim mPurchaseUOM As String = ""
        Dim mFactor As Double
        Dim mTableName As String
        SqlStr = ""
        SqlStr = "SELECT ITEM_CODE, CASE WHEN HEAT_NO<='0' OR HEAT_NO=NULL OR HEAT_NO='' THEN '-1' ELSE HEAT_NO END HEAT_NO, SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1)) AS BALQTY"
        mTableName = ConInventoryTable
        SqlStr = SqlStr & vbCrLf & " FROM " & mTableName & " "
        SqlStr = SqlStr & vbCrLf & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf & " AND FYEAR=" & RsCompany.Fields("FYEAR").Value & ""
        SqlStr = SqlStr & vbCrLf & "AND STOCK_ID='" & pStock_ID & "'"
        SqlStr = SqlStr & vbCrLf & " AND STATUS='O'"
        SqlStr = SqlStr & vbCrLf & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        If pDeptCode <> "" And pStock_ID = ConPH Then
            SqlStr = SqlStr & vbCrLf & "AND DEPT_CODE_FROM='" & pDeptCode & "'"
        ElseIf pDeptCode = "PAD" And pStock_ID = ConWH And pStockType = "FG" Then
            ''02-08-2006
            'SqlStr = SqlStr & vbCrLf & "AND (DEPT_CODE_FROM='" & pDeptCode & "' OR DEPT_CODE_TO='" & pDeptCode & "')"
        End If
        If pRefType <> "" And Val(CStr(pRefNo)) <> 0 Then
            SqlStr = SqlStr & vbCrLf & " AND REF_TYPE || REF_NO <> '" & pRefType & pRefNo & "'"
        End If
        If pStockType = "QC" Then
            SqlStr = SqlStr & vbCrLf & " AND (STOCK_TYPE='" & pStockType & "' OR E_DATE>TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY'))"
        Else
            If pStockType = "" Then
                SqlStr = SqlStr & vbCrLf & " AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
            Else
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "'"
                SqlStr = SqlStr & vbCrLf & " AND STOCK_TYPE='" & pStockType & "' AND E_DATE<=TO_DATE('" & VB6.Format(pDateTo, "dd-mmm-yyyy") & "','DD-MON-YYYY')"
            End If
        End If
        SqlStr = SqlStr & vbCrLf & " AND REF_DATE<=TO_DATE('" & VB6.Format(pDateTo, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        SqlStr = SqlStr & vbCrLf & " HAVING SUM(ITEM_QTY*DECODE(ITEM_IO,'I',1,-1))<>0"
        SqlStr = SqlStr & vbCrLf & " GROUP BY ITEM_CODE,CASE WHEN HEAT_NO<='0' OR HEAT_NO=NULL OR HEAT_NO='' THEN '-1' ELSE HEAT_NO END"
        GetItemHeatWiseQry = SqlStr
        Exit Function
ErrPart:
        GetItemHeatWiseQry = ""
    End Function
    Public Function CheckConsolidatedMaster(ByVal pMasterName As String) As Boolean

        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mConsolidate As String = "N"


        SqlStr = ""

        SqlStr = " SELECT MASTERCONSILIDATED" & vbCrLf _
            & " FROM FIN_MASTER_SETUP" & vbCrLf _
            & " WHERE MASTER_NAME = '" & MainClass.AllowSingleQuote(pMasterName) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mConsolidate = IIf(IsDBNull(RsTemp.Fields("MASTERCONSILIDATED").Value), "N", RsTemp.Fields("MASTERCONSILIDATED").Value)
        End If

        CheckConsolidatedMaster = IIf(mConsolidate = "N", False, True)

        Exit Function
ErrPart:
        CheckConsolidatedMaster = False
    End Function
    Public Function GetHSNFromPurchaseOrder(ByRef pItemCode As String, ByRef pPONO As Double) As String
        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mItemCode As String
        GetHSNFromPurchaseOrder = ""
        SqlStr = " SELECT HSN_CODE " & vbCrLf _
            & " FROM  PUR_PURCHASE_HDR IH, PUR_PURCHASE_DET ID" & vbCrLf _
            & " WHERE IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.PO_STATUS='Y' AND IH.PO_CLOSED='N'" & vbCrLf & " AND AUTO_KEY_PO=" & Val(CStr(pPONO)) & "" & vbCrLf _
            & " AND ID.ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        If RsTemp.EOF = False Then
            GetHSNFromPurchaseOrder = Trim(IIf(IsDBNull(RsTemp.Fields("HSN_CODE").Value), "", RsTemp.Fields("HSN_CODE").Value))
        End If
        Exit Function
ErrPart:
        GetHSNFromPurchaseOrder = ""
    End Function
    Public Function GetHRHODCode(ByRef pDate As String) As String
        On Error GoTo ErrPart
        Dim SqlStr As String
        Dim mHODCode As String = ""
        Dim mHRHODCode As String
        Dim mDeptHOD As String = "N"
        Dim RsTemp As ADODB.Recordset = Nothing


        SqlStr = "SELECT EMP_CODE FROM " & vbCrLf _
                & " PAY_EMPLOYEE_MST" & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND IS_HR_HOD='Y'"

        SqlStr = SqlStr & vbCrLf _
            & " AND (EMP_LEAVE_DATE IS NULL OR EMP_LEAVE_DATE='' OR EMP_LEAVE_DATE>=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY'))"


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetHRHODCode = IIf(IsDBNull(RsTemp.Fields("EMP_CODE").Value), "", RsTemp.Fields("EMP_CODE").Value)
        End If



        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetAutoQC(ByRef mItemCode As String) As Boolean
        On Error GoTo ErrPart
        Dim SqlStr As String
        Dim RsTemp As ADODB.Recordset
        Dim pAutoQC As String

        pAutoQC = "N"
        If Trim(mItemCode) = "" Then Exit Function

        If RsCompany.Fields("IS_WAREHOUSE").Value = "Y" Then
            GetAutoQC = True
            Exit Function
        End If
        SqlStr = "SELECT AUTO_QC FROM " & vbCrLf _
                & " INV_ITEM_MST" & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & mItemCode & "'"
        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            pAutoQC = IIf(IsDBNull(RsTemp.Fields("AUTO_QC").Value), "N", RsTemp.Fields("AUTO_QC").Value)
        End If
        GetAutoQC = IIf(pAutoQC = "Y", True, False)
        Exit Function
ErrPart:
        GetAutoQC = False
        ErrorMsg(Err.Description, Err.Number, vbCritical)
        ''Resume
    End Function
    Public Function GetDistance(ByRef mSuppCustCode As String) As Long        '', pLocationId As String
        On Error GoTo ErrPart
        Dim url As String

        Dim mGSTIN As String


        Dim pCDKey As String = ""
        Dim pEFUserName As String = ""
        Dim pEFPassword As String = ""
        Dim pEWBUserName As String = ""
        Dim pEWBPassword As String = ""


        Dim mBody As String
        Dim mResponseId As String
        Dim mResponseIdStr As String
        Dim url1 As String
        Dim WebRequestGen As String
        Dim pStaus As String

        Dim pError As String

        Dim pResponseText As String
        Dim RsTemp As ADODB.Recordset
        Dim pIsTesting As String = "Y"
        Dim SqlStr As String
        Dim pFromPincode As String
        Dim pTransDistance As Long = 0
        Dim pToPincode As String

        If Trim(mSuppCustCode) = "" Then Exit Function

        If GetWebTeleWaySetupContents(url, "D", pCDKey, pEFUserName, pEFPassword, pEWBUserName, pEWBPassword, "N") = False Then GoTo ErrPart


        mGSTIN = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
        pFromPincode = IIf(IsDBNull(RsCompany.Fields("COMPANY_PIN").Value), "", RsCompany.Fields("COMPANY_PIN").Value)

        If MainClass.ValidateWithMasterTable(Trim(mSuppCustCode), "SUPP_CUST_CODE", "SUPP_CUST_PIN", "FIN_SUPP_CUST_BUSINESS_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "") = True Then      '' AND LOCATION_ID='" & pLocationId & "'
            pToPincode = MasterNo
        End If


        Dim http As Object ''MSXML2.XMLHTTP60   '' MSXML.xmlhttp
        http = CreateObject("MSXML2.ServerXMLHTTP")

        http.Open("POST", url, False)

        http.setRequestHeader("Content-Type", "application/json")

        mBody = "{""Push_Data_List"":["
        'mBody = mBody & """Data"": ["
        mBody = mBody & "{"

        mBody = mBody & """GSTIN"":""" & mGSTIN & ""","
        mBody = mBody & """SourcePincode"":""" & pFromPincode & ""","
        mBody = mBody & """DestinationPincode"":""" & pToPincode & ""","
        mBody = mBody & """EWBUserName"":""" & pEWBUserName & ""","
        mBody = mBody & """EWBPassword"":""" & pEWBPassword & """"

        mBody = mBody & "}"
        mBody = mBody & "],"

        mBody = mBody & """EFUserName"":""" & pEFUserName & ""","
        mBody = mBody & """EFPassword"":""" & pEFPassword & ""","
        mBody = mBody & """CDKey"":""" & pCDKey & """"

        mBody = mBody & "}"
        'mBody = mBody & "]"
        'mBody = mBody & "}"
        'mBody = mBody & "}"

        http.Send(mBody)

        pResponseText = http.responseText
        'pResponseText = Replace(pResponseText, "[", "")
        'pResponseText = Replace(pResponseText, "]", "")
        'pResponseText = Replace(pResponseText, "/", "")
        'pResponseText = Replace(pResponseText, "\", "")
        'pResponseText = Replace(pResponseText, """", "'")

        pResponseText = Replace(pResponseText, "\", "")
        pResponseText = Replace(pResponseText, "[", "")
        pResponseText = Replace(pResponseText, "]", "")
        pResponseText = Mid(pResponseText, 2, Len(pResponseText) - 2)

        Dim post As Object
        pStaus = (JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .IsSuccess = ""})).IsSuccess


        If UCase(pStaus) = UCase("True") Then
            pTransDistance = Val((JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .Distance = ""})).Distance)
        End If

        GetDistance = pTransDistance
        http = Nothing

        Exit Function
ErrPart:

        pTransDistance = 0
        GetDistance = pTransDistance
        MsgBox(Err.Description)

    End Function
    Public Function RefreshQRCode(ByRef mMKey As String, mBillNo As String, mIRNNo As String) As String
        On Error GoTo ErrPart
        Dim url As String

        Dim mGSTIN As String
        Dim mIrn As String

        Dim mGetQRImg As String
        Dim mGetSignedInvoice As String
        Dim mCDKey As String = ""
        Dim mEInvUserName As String = ""
        Dim mEInvPassword As String = ""
        Dim mEFUserName As String = ""
        Dim mEFPassword As String = ""

        Dim mBody As String
        Dim mResponseId As String
        Dim mResponseIdStr As String
        Dim url1 As String
        Dim WebRequestGen As String
        Dim pStaus As String

        Dim mSignedInvoice As String
        Dim mSignedQRCode As String

        Dim pError As String
        'Dim pBranchId As String
        'Dim pTokenId As String
        'Dim pUserId As String
        'Dim mBMPFileName As String = " "

        Dim pResponseText As String
        Dim RsTemp As ADODB.Recordset
        Dim pIsTesting As String = "Y"
        Dim SqlStr As String
        If Trim(mIRNNo) = "" Then Exit Function

        'RefreshQRCode = " "
        RefreshQRCode = mPubBarCodePath & "\" & mBillNo & ".Png"

        SqlStr = "SELECT SIGNQRCODE FROM FIN_INVOICE_QRCODE " & vbCrLf _
                & " WHERE MKEY = '" & mMKey & "'" & vbCrLf _
                & " AND COMPANY_CODE = " & RsCompany.Fields("COMPANY_CODE").Value & " "

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
        'MainClass.UOpenRecordSet SqlStr, PubDBCn, adOpenStatic, RsTemp, adLockReadOnly

        If RsTemp.EOF = False Then
            mSignedQRCode = IIf(IsDBNull(RsTemp.Fields("SIGNQRCODE").Value), "", RsTemp.Fields("SIGNQRCODE").Value)
            If GererateQRCodeImage(RefreshQRCode, mSignedQRCode) = False Then GoTo ErrPart
        Else
            If GeteInvoiceSetupContents(url, "I", mCDKey, mEFUserName, mEFPassword, mEInvUserName, mEInvPassword, pIsTesting) = False Then GoTo ErrPart

            If pIsTesting = "Y" Then
                url = "http://einvsandbox.webtel.in/v1.03/GenIRN"
                mCDKey = "1000687"
                mEInvUserName = "03AAACW3775F010"       ''"06AAACW3775F013"		 "29AAACW3775F000" '' 					
                mEInvPassword = "Admin!23"  ''"Admin!23.."    ''
                mEFUserName = "29AAACW3775F000"  '' "29AAACW3775F000"
                mEFPassword = "Admin!23.."
                mGSTIN = "03AAACW3775F010" ''IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
            Else
                mGSTIN = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), "", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)
            End If


            Dim http As Object ''MSXML2.XMLHTTP60   '' MSXML.xmlhttp
            http = CreateObject("MSXML2.ServerXMLHTTP")

            mGetQRImg = "0"      ''0 for text , 1 for Image
            mGetSignedInvoice = "0"  ''1 - Signed Json of Invoice will be return, 0 - will not return signed Invoice.

            http.Open("POST", url, False)

            http.setRequestHeader("Content-Type", "application/json")

            mBody = "{""Push_Data_List"":{"
            mBody = mBody & """Data"": ["
            mBody = mBody & "{"

            mBody = mBody & """Irn"":""" & mIRNNo & ""","
            mBody = mBody & """GSTIN"":""" & mGSTIN & ""","
            mBody = mBody & """CDKey"":""" & mCDKey & ""","
            mBody = mBody & """EInvUserName"":""" & mEInvUserName & ""","
            mBody = mBody & """EInvPassword"":""" & mEInvPassword & ""","
            mBody = mBody & """EFUserName"":""" & mEFUserName & ""","
            mBody = mBody & """EFPassword"":""" & mEFPassword & """"

            mBody = mBody & "}"


            mBody = mBody & "]"
            mBody = mBody & "}"
            mBody = mBody & "}"

            http.Send(mBody)

            pResponseText = http.responseText
            pResponseText = Replace(pResponseText, "[", "")
            pResponseText = Replace(pResponseText, "]", "")
            pResponseText = Replace(pResponseText, """", "'")

            Dim post As Object
            pStaus = (JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .Status = ""})).Status


            If pStaus = "1" Then
                mSignedQRCode = (JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .SignedQRCode = ""})).SignedQRCode ' JsonTest.item("SignedQRCode")
                mSignedInvoice = (JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .SignedInvoice = ""})).SignedInvoice ' JsonTest.item("SignedInvoice")

                PubDBCn.Errors.Clear()
                PubDBCn.BeginTrans()

                SqlStr = "INSERT INTO FIN_INVOICE_QRCODE " & vbCrLf _
                    & " ( MKEY, COMPANY_CODE, SIGNQRCODE ) VALUES (" & vbCrLf _
                    & " '" & mMKey & "', " & RsCompany.Fields("COMPANY_CODE").Value & ", " & vbCrLf _
                    & " '" & mSignedQRCode & "')"

                PubDBCn.Execute(SqlStr)

                PubDBCn.CommitTrans()
                If GererateQRCodeImage(RefreshQRCode, mSignedQRCode) = False Then GoTo ErrPart
            End If

            If pStaus = "0" Then
                pError = (JsonConvert.DeserializeAnonymousType(pResponseText, New With {Key .ErrorMessage = ""})).ErrorMessage 'JsonTest.item("ErrorMessage")  ''JsonTest.Item("errors").Item(1).Item("description") & "," & JsonTest.Item("errors").Item(1).Item("message")    ''Item("items").Item(1).Item("url")
                MsgInformation(pError)
                http = Nothing
                RefreshQRCode = " "
                Exit Function
            End If

            http = Nothing
        End If
        '    Set httpGen = Nothing
        Exit Function
ErrPart:
        '    Resume
        'http = Nothing
        RefreshQRCode = " "
        MsgBox(Err.Description)

    End Function
    Public Sub PrintBarcode1(ByRef pString As String, ByRef pMKey As String, ByRef pGroupWise As String, ByRef GetStrOnly As Boolean)

        On Error GoTo ErrPart
        Dim cntRow As Integer

        Dim mVendorCode As String
        Dim mPONo As String
        Dim mBillNo As String
        Dim mBillDate As String
        Dim mGSTNo As String
        Dim mTotalInvoiceAmt As String
        Dim mTotalAssAmt As String
        Dim mVehicle As String
        Dim mSGSTAmount As String
        Dim mIGSTAmount As String
        Dim mCGSTAmount As String
        Dim mPartNo As String
        Dim mHSNCode As String
        Dim mQty As String
        Dim mItemRate As String
        Dim mItemSNo As String
        Dim mItemCode As String
        Dim mString As String
        Dim mSeparator As String
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing
        'Dim pdf As New IDLSPDFGenerator.IDLSPDF							
        Dim CodeBarre As String = ""
        Dim nbcol, secu, CodeErr As Short
        Dim mTCS As String
        Dim mCustomerCode As String
        Dim pPONo As String
        Dim mNetAmount As String
        Dim mItemAmount As String
        Dim mTCSAmount As String

        pString = ""

        ''HERO HONDA BARCODE.........							

        mSeparator = vbTab

        SqlStr = "SELECT SUPP_CUST_CODE,BILLNO,INVOICE_DATE,CUST_PO_NO,CUST_PO_DATE,VEHICLENO, " & vbCrLf _
            & " ITEMVALUE,NETVALUE,TOTTAXABLEAMOUNT,NETCGST_AMOUNT,NETSGST_AMOUNT,NETIGST_AMOUNT,TCSAMOUNT,VENDOR_CODE" & vbCrLf _
            & " FROM FIN_INVOICE_HDR WHERE MKEY='" & pMKey & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            mVendorCode = Trim(IIf(IsDBNull(RsTemp.Fields("VENDOR_CODE").Value), "", RsTemp.Fields("VENDOR_CODE").Value))
            mCustomerCode = Trim(IIf(IsDBNull(RsTemp.Fields("SUPP_CUST_CODE").Value), "", RsTemp.Fields("SUPP_CUST_CODE").Value))
            mPONo = IIf(IsDBNull(RsTemp.Fields("CUST_PO_NO").Value), "", RsTemp.Fields("CUST_PO_NO").Value)
            mBillNo = IIf(IsDBNull(RsTemp.Fields("BILLNO").Value), "", RsTemp.Fields("BILLNO").Value)
            mBillDate = IIf(IsDBNull(RsTemp.Fields("INVOICE_DATE").Value), "", RsTemp.Fields("INVOICE_DATE").Value)
            mTotalInvoiceAmt = VB6.Format(IIf(IsDBNull(RsTemp.Fields("NETVALUE").Value), "", RsTemp.Fields("NETVALUE").Value), "0.00")
            mTotalAssAmt = VB6.Format(IIf(IsDBNull(RsTemp.Fields("TOTTAXABLEAMOUNT").Value), "", RsTemp.Fields("TOTTAXABLEAMOUNT").Value), "0.00")

            mVehicle = IIf(IsDBNull(RsTemp.Fields("VEHICLENO").Value), " ", RsTemp.Fields("VEHICLENO").Value)
            mCGSTAmount = VB6.Format(IIf(IsDBNull(RsTemp.Fields("NETCGST_AMOUNT").Value), "0", RsTemp.Fields("NETCGST_AMOUNT").Value), "0.00")
            mSGSTAmount = VB6.Format(IIf(IsDBNull(RsTemp.Fields("NETSGST_AMOUNT").Value), "0", RsTemp.Fields("NETSGST_AMOUNT").Value), "0.00")
            mIGSTAmount = VB6.Format(IIf(IsDBNull(RsTemp.Fields("NETIGST_AMOUNT").Value), "0", RsTemp.Fields("NETIGST_AMOUNT").Value), "0.00")
            mTCSAmount = VB6.Format(IIf(IsDBNull(RsTemp.Fields("TCSAMOUNT").Value), "0", RsTemp.Fields("TCSAMOUNT").Value), "0.00")

        End If


        If Trim(mPONo) = "" Then
            mPONo = ""
        End If

        If Trim(mBillNo) = "" Then
            mBillNo = ""
        End If


        If IsDate(mBillDate) Then
            mBillDate = VB6.Format(mBillDate, "dd.mm.yyyy")
        Else
            mBillDate = ""
        End If


        mGSTNo = IIf(IsDBNull(RsCompany.Fields("COMPANY_GST_RGN_NO").Value), " ", RsCompany.Fields("COMPANY_GST_RGN_NO").Value)

        If Val(mTotalInvoiceAmt) = 0 Then
            mTotalInvoiceAmt = ".00"
        End If

        If Val(mTotalAssAmt) = 0 Then
            mTotalAssAmt = ".00"
        End If

        If Trim(mVehicle) = "" Then
            mVehicle = ""
        End If

        If Val(mSGSTAmount) = 0 Then
            mSGSTAmount = ".00"
        End If

        If Val(mIGSTAmount) = 0 Then
            mIGSTAmount = ".00"
        End If

        If Val(mCGSTAmount) = 0 Then
            mCGSTAmount = ".00"
        End If

        If Val(mTCSAmount) = 0 Then
            mTCS = ".00"
        End If


        mString = mVendorCode & mSeparator & mPONo & mSeparator & mBillNo & mSeparator & mBillDate & mSeparator & mGSTNo & mSeparator & mTotalInvoiceAmt & mSeparator & mTotalAssAmt & mSeparator & mVehicle & mSeparator & mSGSTAmount & mSeparator & mIGSTAmount & mSeparator & mCGSTAmount

        'If RsCompany.Fields("TCS_APPLICABLE").Value = "Y" Then
        mString = mString & mSeparator & mTCS
        'End If

        If pGroupWise = "Y" Then
            SqlStr = "Select ITEM_CODE, CUSTOMER_PART_NO, ITEM_SNO, HSNCODE, SUM(ITEM_QTY) As ITEM_QTY, ITEM_RATE " & vbCrLf & " FROM FIN_INVOICE_DET WHERE MKEY='" & pMKey & "'" & vbCrLf & " GROUP BY ITEM_CODE, CUSTOMER_PART_NO, ITEM_SNO, HSNCODE, ITEM_RATE"
        Else
            SqlStr = "SELECT SUBROWNO, ITEM_CODE, CUSTOMER_PART_NO, ITEM_SNO, HSNCODE, ITEM_QTY, ITEM_RATE " & vbCrLf & " FROM FIN_INVOICE_DET WHERE MKEY='" & pMKey & "'" & vbCrLf & " ORDER BY SUBROWNO" ''GROUP BY CUSTOMER_PART_NO, HSNCODE, ITEM_RATE						
        End If

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            Do While Not RsTemp.EOF
                mPartNo = IIf(IsDBNull(RsTemp.Fields("CUSTOMER_PART_NO").Value), "", RsTemp.Fields("CUSTOMER_PART_NO").Value)
                mHSNCode = IIf(IsDBNull(RsTemp.Fields("HSNCODE").Value), "", RsTemp.Fields("HSNCODE").Value)
                mQty = VB6.Format(IIf(IsDBNull(RsTemp.Fields("ITEM_QTY").Value), "0", RsTemp.Fields("ITEM_QTY").Value), "0.00")
                mItemRate = VB6.Format(IIf(IsDBNull(RsTemp.Fields("ITEM_RATE").Value), "0", RsTemp.Fields("ITEM_RATE").Value), "0.00")
                mItemCode = IIf(IsDBNull(RsTemp.Fields("ITEM_CODE").Value), "", RsTemp.Fields("ITEM_CODE").Value)
                mItemSNo = IIf(IsDBNull(RsTemp.Fields("ITEM_SNO").Value), "", RsTemp.Fields("ITEM_SNO").Value)

                '                If Trim(mItemSNo) <> "" Then				
                '                    mString = mString & mSeparator & mItemSNo				
                '                Else				
                '                    mString = mString & mSeparator & " "				
                '                End If				

                If Trim(mPartNo) <> "" Then
                    mString = mString & mSeparator & mPartNo
                Else
                    mString = mString & mSeparator & ""
                End If

                If Trim(mHSNCode) <> "" Then
                    mString = mString & mSeparator & mHSNCode
                Else
                    mString = mString & mSeparator & ""
                End If

                If Trim(mQty) <> "" Then
                    mString = mString & mSeparator & mQty
                Else
                    mString = mString & mSeparator & "0"
                End If

                If Trim(mItemRate) <> "" Then
                    mString = mString & mSeparator & mItemRate
                Else
                    mString = mString & mSeparator & "0"
                End If

                RsTemp.MoveNext()
            Loop
        End If

        pString = mString

        'Dim mFP As Boolean
        'If GetStrOnly = False Then
        '    'If pBARCODEPRINTER = "Y" Then						
        '    '	Call Print2DBarcode(mString, "Bill No : " & Trim(mBillNo), MSComm1)					
        '    'Else						
        '    '	If CreateOutPutFile(mString, "PDF.DAT") = False Then GoTo ErrPart					

        '    '	mString = vbTab & vbTab & vbTab & "Bill No : " & Trim(mBillNo) & vbNewLine & vbNewLine & " "					
        '    '	If CreateOutPutFile(mString, "Inv.Prn") = False Then GoTo ErrPart					
        '    '	'    Shell mLocalPath & "\PDF.bat",vbNormalFocus					
        '    '	'    mFP = Shell(App.path & "\PDF.bat", vbNormalFocus)					
        '    '	mFP = Shell(mLocalPath & "\PDF.bat", AppWinStyle.NormalFocus)					
        '    'End If						
        'Else
        '    secu = -1
        '    nbcol = 8
        '    '        CodeBarre = pdf.encodePdf417Data(mString, secu, nbcol, CodeErr)						
        '    'CodeBarre = EncodePdf417(mString, secu, nbcol, CodeErr)
        '    'CodeBarre = EncodePdf417.clsEncodePdf417(mString, secu, nbcol, CodeErr)

        '    If CodeErr > 1 And CodeBarre = "" Then
        '        pString = ""
        '    Else
        '        pString = CodeBarre
        '    End If

        'End If
        Exit Sub
ErrPart:
        MsgBox(Err.Description, MsgBoxStyle.Critical)
    End Sub
    Public Sub ClearGroupFromUltraGrid(ByRef ultGrid As UltraGrid)
        '----------------------------------------------------------------------------
        'Argument           : ultra grid
        'Return Value       : 
        'Function           : to clear the filtering applied in the grid
        'Comments           :Created by PV on 2009-Feb-18 as per item in the backlog 8.4
        '----------------------------------------------------------------------------
        Try
            ultGrid.DisplayLayout.ClearGroupByColumns()
        Catch ex As Exception
            ErrorMsg(Err.Description)
        End Try
    End Sub
    Public Sub ClearFilterFromUltraGrid(ByRef ultGrid As UltraGrid)
        '----------------------------------------------------------------------------
        'Argument           : ultra grid
        'Return Value       : 
        'Function           : to clear the filtering applied in the grid
        'Comments           :Created by PV on 2009-Feb-18 as per item in the backlog 8.4
        '----------------------------------------------------------------------------
        Dim band As Infragistics.Win.UltraWinGrid.UltraGridBand
        Try
            For Each band In ultGrid.DisplayLayout.Bands
                band.ColumnFilters.ClearAllFilters()
            Next
        Catch ex As Exception
            ErrorMsg(Err.Description)
        End Try
    End Sub
    Public Function GetBoxesStd(ByRef xICode As String, ByRef pCustomerCode As String, ByRef pType As String, ByRef pBoxCode As String, pLocationId As String) As Double

        On Error GoTo ERR1
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim SqlStr As String = ""

        GetBoxesStd = 0
        If xICode = "" Then Exit Function

        SqlStr = "SELECT * " & vbCrLf _
                & " FROM INV_CUSTOMER_PACKING_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(xICode) & "' " & vbCrLf _
                & " AND SUPP_CUST_CODE='" & MainClass.AllowSingleQuote(pCustomerCode) & "'" & vbCrLf _
                & " AND LOC_ID='" & MainClass.AllowSingleQuote(pLocationId) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            If pType = "I" Then
                GetBoxesStd = IIf(IsDBNull(RsTemp.Fields("INNER_PACK_STD").Value), 0, RsTemp.Fields("INNER_PACK_STD").Value)
                GetBoxesStd = IIf(GetBoxesStd = 0, 1, GetBoxesStd)
                pBoxCode = IIf(IsDBNull(RsTemp.Fields("INNER_PACK_ITEM_CODE").Value), "", RsTemp.Fields("INNER_PACK_ITEM_CODE").Value)
            Else
                GetBoxesStd = IIf(IsDBNull(RsTemp.Fields("OUTER_PACK_STD_PER_INNER").Value), 0, RsTemp.Fields("OUTER_PACK_STD_PER_INNER").Value)
                GetBoxesStd = GetBoxesStd * IIf(IsDBNull(RsTemp.Fields("INNER_PACK_STD").Value), 0, RsTemp.Fields("INNER_PACK_STD").Value)
                GetBoxesStd = IIf(GetBoxesStd = 0, 1, GetBoxesStd)
                pBoxCode = IIf(IsDBNull(RsTemp.Fields("OUTER_PACK_ITEM_CODE").Value), "", RsTemp.Fields("OUTER_PACK_ITEM_CODE").Value)
            End If
        Else
            SqlStr = "SELECT * " & vbCrLf _
                & " FROM INV_ITEM_MST WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(xICode) & "' "

            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

            If RsTemp.EOF = False Then
                If pType = "I" Then
                    GetBoxesStd = IIf(IsDBNull(RsTemp.Fields("PACK_STD").Value), 0, RsTemp.Fields("PACK_STD").Value)
                    GetBoxesStd = IIf(GetBoxesStd = 0, 1, GetBoxesStd)

                    pBoxCode = IIf(IsDBNull(RsTemp.Fields("PACK_ITEM_CODE").Value), "", RsTemp.Fields("PACK_ITEM_CODE").Value)
                Else
                    GetBoxesStd = IIf(IsDBNull(RsTemp.Fields("OUTER_PACK_STD_PER_INNER").Value), 0, RsTemp.Fields("OUTER_PACK_STD_PER_INNER").Value)
                    GetBoxesStd = GetBoxesStd * IIf(IsDBNull(RsTemp.Fields("PACK_STD").Value), 0, RsTemp.Fields("PACK_STD").Value)
                    GetBoxesStd = IIf(GetBoxesStd = 0, 1, GetBoxesStd)
                    pBoxCode = IIf(IsDBNull(RsTemp.Fields("OUTER_PACK_ITEM_CODE").Value), "", RsTemp.Fields("OUTER_PACK_ITEM_CODE").Value)
                End If
            End If

        End If


        Exit Function
ERR1:
        GetBoxesStd = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetPOHSNCode(ByVal mItemCode As String, ByVal mSupplierCode As String, ByVal mRefNo As String, ByVal mDivisionCode As Double, ByVal pMRRDate As String) As String

        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        GetPOHSNCode = ""



        'If Val(mRefNo) > 0 Then
        '    If MainClass.ValidateWithMasterTable(mRefNo, "AUTO_KEY_PO", "PUR_TYPE", "PUR_PURCHASE_HDR", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND PUR_TYPE IN ('P','R','L')") = True Then
        '        If MasterNo = "R" Then
        '            mIsProjectPO = True
        '            ValidateRefNo = True
        '            Exit Function
        '        End If
        '    End If
        'End If

        SqlStr = "SELECT DISTINCT PODetail.HSN_CODE " & vbCrLf _
            & " FROM PUR_PURCHASE_HDR POMain,PUR_PURCHASE_DET PODetail" & vbCrLf _
            & " WHERE POMain.MKEY=PODetail.MKEY" & vbCrLf _
            & " AND POMain.Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " AND PUR_TYPE IN ('P','R','L')" & vbCrLf _
            & " AND SUPP_CUST_CODE='" & mSupplierCode & "'" & vbCrLf _
            & " AND DIV_CODE=" & mDivisionCode & ""


        If IsDate(pMRRDate) Then
            SqlStr = SqlStr & vbCrLf & " AND PODetail.PO_WEF_DATE<=TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If


        SqlStr = SqlStr & vbCrLf & " AND POMain.PO_STATUS='Y'" & vbCrLf _
            & " AND PODetail.ITEM_CODE='" & mItemCode & "'" & vbCrLf _
            & " AND PO_ITEM_STATUS='N' " & vbCrLf _
            & " AND POMain.AUTO_KEY_PO = '" & mRefNo & "'" & vbCrLf _
            & " AND POMain.MKEY =( SELECT MAX(A.MKEY) FROM PUR_PURCHASE_HDR A, PUR_PURCHASE_DET B" & vbCrLf _
            & " WHERE A.MKEY=B.MKEY" & vbCrLf _
            & " AND A.Company_Code=" & RsCompany.Fields("COMPANY_CODE").Value & " AND PUR_TYPE IN ('P','R','L')" & vbCrLf _
            & " AND A.SUPP_CUST_CODE='" & mSupplierCode & "'" & vbCrLf _
            & " AND A.DIV_CODE=" & mDivisionCode & ""

        If IsDate(pMRRDate) Then
            SqlStr = SqlStr & vbCrLf & " AND B.PO_WEF_DATE<=TO_DATE('" & VB6.Format(pMRRDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"
        End If


        SqlStr = SqlStr & vbCrLf & " AND A.PO_STATUS='Y'" & vbCrLf _
            & " AND B.ITEM_CODE='" & mItemCode & "'" & vbCrLf _
            & " AND PO_ITEM_STATUS='N' " & vbCrLf _
            & " AND A.AUTO_KEY_PO = '" & mRefNo & "')"


        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetPOHSNCode = IIf(IsDBNull(RsTemp.Fields("HSN_CODE").Value), "", RsTemp.Fields("HSN_CODE").Value)
            Exit Function
        End If
        Exit Function
ErrPart:

    End Function
    Public Function CheckInvoiceReceiptPending(ByRef mSuppCustCode As String, ByRef mItemCode As String, ByRef mStoreLoc As String) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pAppDate As String
        Dim mFromDate As String
        Dim mStateName As String
        Dim mInterUnit As String
        Dim xDeliveryTime As Long

        CheckInvoiceReceiptPending = False

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value <> 102 Then
            CheckInvoiceReceiptPending = False
            Exit Function
        End If

        mInterUnit = "N"
        If MainClass.ValidateWithMasterTable(mSuppCustCode, "SUPP_CUST_CODE", "SUPP_CUST_STATE", "FIN_SUPP_CUST_MST", PubDBCn, MasterNo, , "COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND INTER_UNIT='Y'") = True Then
            mInterUnit = "Y"
            If RsCompany.Fields("COMPANY_CODE").Value = 2 Then
                mStateName = MasterNo
                If mStateName = "KARNATAKA" Then
                    xDeliveryTime = 8 * 24  ''8 days
                ElseIf mStateName = "GUJARAT" Then
                    xDeliveryTime = 4 * 24  ''4 days
                Else
                    CheckInvoiceReceiptPending = False
                    Exit Function
                End If
            Else
                CheckInvoiceReceiptPending = False
                Exit Function
            End If

        End If

        pAppDate = DateAdd(DateInterval.Day, -1, GetServerDate())
        mFromDate = "01/06/2023"

        mSqlStr = " SELECT DISTINCT BILLNo, TO_CHAR(INVOICE_DATE,'DD-MON-YYYY') || ' ' || TO_CHAR(INV_PREP_TIME,'HH24:MI') BILLDATE " & vbCrLf _
                & " FROM FIN_INVOICE_HDR IH, FIN_INVOICE_DET ID, DSP_DESPATCH_DET DD" & vbCrLf _
                & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
                & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " And IH.FYEAR>=2023 AND INVOICESEQTYPE NOT IN (3,5,4,7,8,9)" & vbCrLf _
                & " And IH.CANCELLED='N' AND IH.BOOKCODE=" & ConSalesBookCode & " AND (GRNNO IS NULL OR GRNNO='')" & vbCrLf _
                & " AND IH.SUPP_CUST_CODE='" & mSuppCustCode & "' AND ID.ITEM_CODE='" & mItemCode & "' " & vbCrLf _
                & " AND IH.INVOICE_DATE>=TO_DATE('" & VB6.Format(mFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf _
                & " AND IH.INVOICE_DATE<=TO_DATE('" & VB6.Format(pAppDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        mSqlStr = mSqlStr & vbCrLf _
                & " AND IH.COMPANY_CODE=DD.COMPANY_CODE" & vbCrLf _
                & " AND IH.AUTO_KEY_DESP=DD.AUTO_KEY_DESP" & vbCrLf _
                & " AND ID.SUBROWNO = DD.SERIAL_NO" & vbCrLf _
                & " AND ID.ITEM_CODE = DD.ITEM_CODE"

        If mStoreLoc <> "" Then
            mSqlStr = mSqlStr & vbCrLf & " And DD.LOC_CODE='" & mStoreLoc & "'"
        End If

        'mSqlStr = mSqlStr & vbCrLf _
        '        & " AND IH.AUTO_KEY_DESP IN (SELECT DISTINCT AUTO_KEY_DESP FROM DSP_DESPATCH_DET DD" & vbCrLf _
        '        & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND LOC_CODE='" & mStoreLoc & "')"

        mSqlStr = mSqlStr & vbCrLf _
                & " AND BILLNo NOT IN (SELECT BILLNO FROM FIN_supp_sale_HDR WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & " AND CANCELLED='N' and ISFINALPOST='Y')"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        Dim mBillNo As String
        Dim mBillDate As String
        Dim mCurrentDate As String
        Dim mTotalHr As String
        Dim pTimelineFinished As Boolean
        Dim mTotalHours As Long = 48
        Dim mDistanct As Long
        Dim mHoliday As Boolean
        Dim mCheckDate As String

        If RsTemp.EOF = True Then
            CheckInvoiceReceiptPending = False
            Exit Function
        Else
            Do While RsTemp.EOF = False
                mDistanct = GetDistance(mSuppCustCode)

                If mInterUnit = "Y" Then
                    mTotalHours = xDeliveryTime
                Else
                    If mDistanct <= 100 Then
                        mTotalHours = 48
                    Else
                        mTotalHours = Int(mDistanct / 100) * 48
                    End If
                End If



                mBillNo = IIf(IsDBNull(RsTemp.Fields("BILLNO").Value), "", RsTemp.Fields("BILLNO").Value)
                ''mBillDate = VB6.Format(RsTemp.Fields("INVOICE_DATE").Value & " " & VB6.Format(RsTemp.Fields("INV_PREP_TIME").Value, "HH:MM"), "DD-MM-YYYY HH:MM")

                mBillDate = VB6.Format(RsTemp.Fields("BILLDATE").Value, "DD-MM-YYYY HH:MM")


                mCurrentDate = VB6.Format(GetServerDate() & " " & GetServerTime(), "DD-MM-YYYY HH:MM")
                mCheckDate = DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, GetServerDate()) ''VB6.Format(GetServerDate(), "DD-MM-YYYY")

                mHoliday = CheckIsHoliday(mCheckDate)
                If mHoliday = True Then
                    mTotalHours = mTotalHours + 24

                    Do While mHoliday = True
                        mCheckDate = DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, CDate(mCheckDate))
                        mHoliday = CheckIsHoliday(mCheckDate)
                        If mHoliday = True Then
                            mTotalHours = mTotalHours + 24
                        End If
                    Loop
                End If



                mTotalHr = DateDiff(Microsoft.VisualBasic.DateInterval.Hour, CDate(mBillDate), CDate(mCurrentDate)) ''CDate(mCurrentDate) - CDate(mDNDate)

                pTimelineFinished = False
                If CheckApproval(mBillNo, mBillDate, mCurrentDate, pTimelineFinished) = True Then

                Else
                    If pTimelineFinished = True Then
                        MsgInformation("There is a already Approved pending of Bill (" & mBillNo & "), which time line is finished.")
                        CheckInvoiceReceiptPending = True
                        Exit Function
                    Else
                        If mTotalHr >= (mTotalHours - 12) And mTotalHr < mTotalHours Then
                            MsgInformation("There is a pending Invoice (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt other wise Sale Invoice will be Stop after 48 Hours.")
                            CheckInvoiceReceiptPending = False
                            Exit Function
                        ElseIf mTotalHr > mTotalHours Then
                            'MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")
                            MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")

                            CheckInvoiceReceiptPending = True

                            'mSqlStr = " SELECT MAX(TO_CHAR(CLEAR_DATE,'DD-MON-YYYY HH24:MI')) CLEAR_DATE " & vbCrLf _
                            '       & " FROM FIN_LOADING_SLIP_UNLOCK A, FIN_INVOICE_HDR B" & vbCrLf _
                            '       & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                            '       & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
                            '       & " AND A.BILL_NO=B.BILLNO AND B.SUPP_CUST_CODE='" & mSuppCustCode & "' AND A.BILL_NO='" & mBillNo & "' AND A.BOOKTYPE='R' HAVING COUNT(1)>0"

                            ''mSqlStr = " SELECT MAX(TO_CHAR(CLEAR_DATE,'DD-MON-YYYY HH24:MI')) CLEAR_DATE " & vbCrLf _
                            ''    & " FROM FIN_LOADING_SLIP_UNLOCK A" & vbCrLf _
                            ''    & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                            ''    & " AND A.SUPP_CUST_CODE='" & mSuppCustCode & "'  AND A.BILL_NO='" & mBillNo & "' AND A.BOOKTYPE='R'"

                            'MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

                            'If RsTemp.EOF = False Then
                            '    mBillDate = VB6.Format(RsTemp.Fields("CLEAR_DATE").Value, "DD-MM-YYYY HH:MM")
                            '    mCurrentDate = VB6.Format(GetServerDate() & " " & GetServerTime(), "DD-MM-YYYY HH:MM")

                            '    If mBillDate < mCurrentDate Then
                            '        MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")
                            '        CheckInvoiceReceiptPending = True
                            '        Exit Function
                            '    Else
                            '        CheckInvoiceReceiptPending = False
                            '        Exit Function
                            '    End If
                            'Else
                            '    If CheckInvoiceReceiptPending = True Then
                            '        MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")
                            '        Exit Function
                            '    End If
                            'End If
                            'GoTo CheckCustomerUnlock
                        End If
                    End If
                End If
                '            End If
                RsTemp.MoveNext()
            Loop
        End If

        Exit Function
CheckCustomerUnlock:

        'mSqlStr = " SELECT MAX(TO_CHAR(CLEAR_DATE,'DD-MON-YYYY HH24:MI')) CLEAR_DATE " & vbCrLf _
        '    & " FROM FIN_LOADING_SLIP_UNLOCK A, FIN_INVOICE_HDR B" & vbCrLf _
        '    & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        '    & " AND A.COMPANY_CODE=B.COMPANY_CODE" & vbCrLf _
        '    & " AND A.BILL_NO=B.BILLNO AND B.SUPP_CUST_CODE='" & mSuppCustCode & "' AND A.BILL_NO='" & mBillNo & "' AND A.BOOKTYPE='R' HAVING COUNT(1)>0"

        ''mSqlStr = " SELECT MAX(TO_CHAR(CLEAR_DATE,'DD-MON-YYYY HH24:MI')) CLEAR_DATE " & vbCrLf _
        ''    & " FROM FIN_LOADING_SLIP_UNLOCK A" & vbCrLf _
        ''    & " WHERE A.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
        ''    & " AND A.SUPP_CUST_CODE='" & mSuppCustCode & "'  AND A.BILL_NO='" & mBillNo & "' AND A.BOOKTYPE='R'"

        'MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        'If RsTemp.EOF = False Then
        '    mBillDate = VB6.Format(RsTemp.Fields("CLEAR_DATE").Value, "DD-MM-YYYY HH:MM")
        '    mCurrentDate = VB6.Format(GetServerDate() & " " & GetServerTime(), "DD-MM-YYYY HH:MM")

        '    If mBillDate < mCurrentDate Then
        '        MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")
        '        CheckInvoiceReceiptPending = True
        '        Exit Function
        '    Else
        '        CheckInvoiceReceiptPending = False
        '        Exit Function
        '    End If
        'Else
        '    If CheckInvoiceReceiptPending = True Then
        '        MsgInformation("There is a pending Invoice Receipt of (" & mBillNo & ") is more than " & mTotalHr & " Hours, Please enter Receipt Slip First or take Approval for pending.")
        '        Exit Function
        '    End If
        'End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckApproval(ByRef mBillNo As String, ByRef mDNDate As String, ByRef mCurrentDate As String, ByRef pTimelineFinished As Boolean) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mClearDate As String
        Dim mTotalHr As Double

        CheckApproval = False

        mSqlStr = " SELECT MAX(TO_CHAR(CLEAR_DATE,'DD-MON-YYYY HH24:MI')) CLEAR_DATE " & vbCrLf _
            & " FROM FIN_LOADING_SLIP_UNLOCK" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND BILL_NO='" & MainClass.AllowSingleQuote(mBillNo) & "'" & vbCrLf _
            & " AND BILL_DATE=TO_DATE('" & VB6.Format(mDNDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND BOOKTYPE='R' HAVING COUNT(1)>0"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = True Then
            pTimelineFinished = False
            CheckApproval = False
            Exit Function
        Else
            mClearDate = VB6.Format(RsTemp.Fields("CLEAR_DATE").Value, "DD-MM-YYYY HH:MM")
            mCurrentDate = VB6.Format(GetServerDate() & " " & GetServerTime(), "DD-MM-YYYY HH:MM")

            mTotalHr = DateDiff(Microsoft.VisualBasic.DateInterval.Hour, CDate(mClearDate), CDate(mCurrentDate))

            If mTotalHr <= 0 Then
                'If mTotalHr >= -6 And mTotalHr <= 0 Then
                '    MsgInformation("There is a already approved pending Loading Slip (" & mBillNo & "), which time line is finished after " & mTotalHr & " Hours.")
                'End If
                pTimelineFinished = False
                CheckApproval = True
                Exit Function
            Else
                '            MsgInformation "There is a already approved pending Loading Slip (" & mBillNo & "), which time line is finished."
                pTimelineFinished = True
                CheckApproval = False
                Exit Function
            End If
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckRTVPending(ByRef mSuppCustCode As String, ByRef mItemCode As String, ByRef mDate As String, ByRef mStoreLoc As String) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pAppDate As String

        CheckRTVPending = False

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value <> 102 Then
            CheckRTVPending = False
            Exit Function
        End If

        mSqlStr = " SELECT DISTINCT BILL_No BILLNo, BILL_DATE BILLDATE " & vbCrLf _
            & " FROM INV_MISC_GATE_HDR IH, INV_MISC_GATE_DET ID" & vbCrLf _
            & " WHERE IH.AUTO_KEY_NO=ID.AUTO_KEY_NO" & vbCrLf _
            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " And SUBSTR(IH.AUTO_KEY_NO,LENGTH(IH.AUTO_KEY_NO)-5,4)>=2023 AND IS_OUT='N' AND IS_REVERSED='N'" & vbCrLf _
            & " AND IH.SUPP_CUST_CODE='" & mSuppCustCode & "' AND ID.ITEM_CODE='" & mItemCode & "' AND ID.LOC_CODE='" & mStoreLoc & "'" & vbCrLf _
            & " AND IH.REF_DATE<=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

        ''" & RsCompany.Fields("FYEAR").Value & "

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)


        If RsTemp.EOF = True Then
            CheckRTVPending = False
            Exit Function
        Else
            CheckRTVPending = True
            Exit Function
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckDDR(ByRef mSuppCustCode As String, ByRef mItemCode As String, ByRef mDate As String, ByRef mStoreLoc As String) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim pAppDate As String
        Dim mFromDate As String

        CheckDDR = False

        mFromdate = VB6.Format("01/" & VB6.Format(mDate, "MM/YYYY"), "DD/MM/YYYY")

        If RsCompany.Fields("ERP_CUSTOMER_ID").Value <> 102 Then
            CheckDDR = False
            Exit Function
        End If

        mSqlStr = " SELECT BILLNO, INVOICE_DATE " & vbCrLf _
            & " FROM FIN_INVOICE_HDR IH, FIN_INVOICE_DET ID" & vbCrLf _
            & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
            & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " And IH.FYEAR =" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf _
            & " AND IH.SUPP_CUST_CODE='" & mSuppCustCode & "' AND ID.ITEM_CODE='" & mItemCode & "'  AND ITEM_SHORT_RECD_QTY>0" & vbCrLf _
            & " AND IH.GRNDATE>=TO_DATE('" & VB6.Format(mFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf _
            & " AND IH.GRNDATE<=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') ORDER BY INVOICE_DATE"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)


        If RsTemp.EOF = True Then
            CheckDDR = False
            Exit Function
        Else
            Dim RsTempCnt As ADODB.Recordset = Nothing

            mSqlStr = " SELECT COUNT(1) CNT_COUNT " & vbCrLf _
                    & " FROM FIN_INVOICE_HDR IH, FIN_INVOICE_DET ID" & vbCrLf _
                    & " WHERE IH.MKEY=ID.MKEY" & vbCrLf _
                    & " AND IH.COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                    & " And IH.FYEAR =" & RsCompany.Fields("FYEAR").Value & " " & vbCrLf _
                    & " AND IH.SUPP_CUST_CODE='" & mSuppCustCode & "' AND ID.ITEM_CODE='" & mItemCode & "'  AND ITEM_SHORT_RECD_QTY>0" & vbCrLf _
                    & " AND IH.GRNDATE>=TO_DATE('" & VB6.Format(mFromDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')" & vbCrLf _
                    & " AND IH.GRNDATE<=TO_DATE('" & VB6.Format(mDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') ORDER BY INVOICE_DATE"

            MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTempCnt, ADODB.LockTypeEnum.adLockReadOnly)

            Dim mBillNo As String
            Dim mBillDate As String
            Dim mCNTCount As Long

            mCNTCount = 0
            If RsTempCnt.EOF = False Then
                mCNTCount = IIf(IsDBNull(RsTempCnt.Fields("CNT_COUNT").Value), 0, RsTempCnt.Fields("CNT_COUNT").Value)
            End If

            Do While RsTemp.EOF = False
                mBillNo = IIf(IsDBNull(RsTemp.Fields("BILLNO").Value), "", RsTemp.Fields("BILLNO").Value)
                mBillDate = IIf(IsDBNull(RsTemp.Fields("INVOICE_DATE").Value), "", RsTemp.Fields("INVOICE_DATE").Value)

                If CheckDDRApproval(mBillNo, mBillDate, mCNTCount) = True Then
                    CheckDDR = False
                Else
                    CheckDDR = True
                    Exit Function
                End If

                RsTemp.MoveNext()
            Loop

            Exit Function
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckDDRApproval(ByRef mBillNo As String, ByRef mBillDate As String, ByRef mCount As Long) As Boolean

        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim RsTemp As ADODB.Recordset = Nothing
        Dim mClearDate As String
        Dim mFieldName As String

        CheckDDRApproval = False

        If mCount = 1 Then
            mFieldName = "FIRST_APP"
        Else
            mFieldName = "SECOND_APP"
        End If
        mSqlStr = " SELECT " & mFieldName & " " & vbCrLf _
            & " FROM FIN_DDR_APPROVAL_MST" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND BILL_NO='" & MainClass.AllowSingleQuote(mBillNo) & "'" & vbCrLf _
            & " AND BILL_DATE=TO_DATE('" & VB6.Format(mBillDate, "DD-MMM-YYYY") & "','DD-MON-YYYY') AND " & mFieldName & "='Y'"

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            CheckDDRApproval = True
        End If
        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function GetCustomerStoreLoc(ByRef mSNo As Double, ByRef mDespNo As Double, ByRef pItemCode As String) As String


        On Error GoTo ErrPart
        Dim mSqlStr As String
        Dim xSuppCode As String
        Dim RsTemp As ADODB.Recordset = Nothing

        mSqlStr = " SELECT LOC_CODE FROM DSP_DESPATCH_DET" & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND AUTO_KEY_DESP=" & Val(mDespNo) & "" & vbCrLf _
                & " AND ITEM_CODE='" & MainClass.AllowSingleQuote(pItemCode) & "'" & vbCrLf _
                & " AND SERIAL_NO=" & Val(mSNo) & ""

        MainClass.UOpenRecordSet(mSqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetCustomerStoreLoc = Trim(IIf(IsDBNull(RsTemp.Fields("LOC_CODE").Value), "", RsTemp.Fields("LOC_CODE").Value))
        Else
            GetCustomerStoreLoc = ""
        End If



        Exit Function
ErrPart:
        GetCustomerStoreLoc = ""
    End Function
    Public Function GetEmpSalaryAcctCode(ByRef pEmpCode As String) As String
        On Error GoTo ERR1
        Dim SqlStr As String
        Dim RS As ADODB.Recordset
        GetEmpSalaryAcctCode = "-1"

        SqlStr = "SELECT SUPP_CUST_CODE FROM FIN_SUPP_CUST_MST" & vbCrLf _
            & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
            & " AND HEADTYPE='5'" & vbCrLf _
            & " AND EMP_CODE='" & MainClass.AllowSingleQuote(pEmpCode) & "'"

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RS, ADODB.LockTypeEnum.adLockReadOnly)


        If RS.EOF = False Then
            GetEmpSalaryAcctCode = IIf(IsDBNull(RS.Fields("SUPP_CUST_CODE").Value), "-1", RS.Fields("SUPP_CUST_CODE").Value)
        End If

        Exit Function
ERR1:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
    Public Function CheckIsHoliday(ByVal pDate As String) As Boolean

        On Error GoTo ErrPart
        Dim SqlStr As String = ""
        Dim RsTemp As ADODB.Recordset = Nothing

        CheckIsHoliday = True
        If IsDate(pDate) Then
            SqlStr = " SELECT HOLIDAY_DATE FROM PAY_HOLIDAY_MST " & vbCrLf _
                & " WHERE COMPANY_CODE=" & RsCompany.Fields("COMPANY_CODE").Value & "" & vbCrLf _
                & " AND HOLIDAY_DATE=TO_DATE('" & VB6.Format(pDate, "DD-MMM-YYYY") & "','DD-MON-YYYY')"

            MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)
            If RsTemp.EOF = False Then
                CheckIsHoliday = True
            Else
                CheckIsHoliday = False
            End If
        End If

        Exit Function
ErrPart:
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function

    Public Function GetOpeningAssets(ByRef mFYear As Long, ByRef pCompanyCode As Long, ByRef mRefNo As Double, ByRef mFieldName As String) As Double
        On Error GoTo LedgError
        'GetPreviousComulativeDesp(mFYear, mCompanyCode, mRefNo)

        Dim SqlStr As String
        Dim RsTemp As ADODB.Recordset
        Dim mTable As String

        GetOpeningAssets = 0


        mTable = "AST_DESP_TRN_TILL" & mFYear - 1

        SqlStr = "SELECT " & mFieldName & " AS FIELD_NAME" & vbCrLf _
            & " FROM " & mTable & " " & vbCrLf _
            & " WHERE COMPANY_CODE=" & pCompanyCode & "" & vbCrLf _
            & " AND AUTO_KEY_ASSET=" & mRefNo & ""

        MainClass.UOpenRecordSet(SqlStr, PubDBCn, ADODB.CursorTypeEnum.adOpenStatic, RsTemp, ADODB.LockTypeEnum.adLockReadOnly)

        If RsTemp.EOF = False Then
            GetOpeningAssets = IIf(IsDBNull(RsTemp.Fields("FIELD_NAME").Value), 0, RsTemp.Fields("FIELD_NAME").Value)
        End If


        Exit Function
LedgError:
        GetOpeningAssets = 0
        ErrorMsg(Err.Description, CStr(Err.Number), MsgBoxStyle.Critical)
    End Function
End Module
